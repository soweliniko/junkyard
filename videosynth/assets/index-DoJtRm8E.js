var jh=Object.defineProperty;var Yh=(e,t,n)=>t in e?jh(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var pe=(e,t,n)=>(Yh(e,typeof t!="symbol"?t+"":t,n),n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const h of o.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&r(h)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();var Output=function({regl:e,precision:t,label:n="",width:r,height:s}){this.regl=e,this.precision=t,this.label=n,this.positionBuffer=this.regl.buffer([[-2,0],[0,-2],[2,2]]),this.draw=()=>{},this.init(),this.pingPongIndex=0,this.fbos=Array(2).fill().map(()=>this.regl.framebuffer({color:this.regl.texture({mag:"nearest",width:r,height:s,format:"rgba"}),depthStencil:!1}))};Output.prototype.resize=function(e,t){this.fbos.forEach(n=>{n.resize(e,t)})};Output.prototype.getCurrent=function(){return this.fbos[this.pingPongIndex]};Output.prototype.getTexture=function(){var e=this.pingPongIndex?0:1;return this.fbos[e]};Output.prototype.init=function(){return this.transformIndex=0,this.fragHeader=`
  precision ${this.precision} float;

  uniform float time;
  varying vec2 uv;
  `,this.fragBody="",this.vert=`
  precision ${this.precision} float;
  attribute vec2 position;
  varying vec2 uv;

  void main () {
    uv = position;
    gl_Position = vec4(2.0 * position - 1.0, 0, 1);
  }`,this.attributes={position:this.positionBuffer},this.uniforms={time:this.regl.prop("time"),resolution:this.regl.prop("resolution")},this.frag=`
       ${this.fragHeader}

      void main () {
        vec4 c = vec4(0, 0, 0, 0);
        vec2 st = uv;
        ${this.fragBody}
        gl_FragColor = c;
      }
  `,this};Output.prototype.render=function(e){let t=e[0];var n=this,r=Object.assign(t.uniforms,{prevBuffer:()=>n.fbos[n.pingPongIndex]});n.draw=n.regl({frag:t.frag,vert:n.vert,attributes:n.attributes,uniforms:r,count:3,framebuffer:()=>(n.pingPongIndex=n.pingPongIndex?0:1,n.fbos[n.pingPongIndex])})};Output.prototype.tick=function(e){this.draw(e)};var define_global_default$2={},commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof define_global_default$2<"u"?define_global_default$2:typeof self<"u"?self:{};function getDefaultExportFromCjs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var inherits_browser={exports:{}};typeof Object.create=="function"?inherits_browser.exports=function(t,n){n&&(t.super_=n,t.prototype=Object.create(n.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}))}:inherits_browser.exports=function(t,n){if(n){t.super_=n;var r=function(){};r.prototype=n.prototype,t.prototype=new r,t.prototype.constructor=t}};var inherits_browserExports=inherits_browser.exports;function EventEmitter$1(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}var events=EventEmitter$1;EventEmitter$1.EventEmitter=EventEmitter$1;EventEmitter$1.prototype._events=void 0;EventEmitter$1.prototype._maxListeners=void 0;EventEmitter$1.defaultMaxListeners=10;EventEmitter$1.prototype.setMaxListeners=function(e){if(!isNumber(e)||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this};EventEmitter$1.prototype.emit=function(e){var t,n,r,s,o,h;if(this._events||(this._events={}),e==="error"&&(!this._events.error||isObject(this._events.error)&&!this._events.error.length)){if(t=arguments[1],t instanceof Error)throw t;var u=new Error('Uncaught, unspecified "error" event. ('+t+")");throw u.context=t,u}if(n=this._events[e],isUndefined(n))return!1;if(isFunction(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:s=Array.prototype.slice.call(arguments,1),n.apply(this,s)}else if(isObject(n))for(s=Array.prototype.slice.call(arguments,1),h=n.slice(),r=h.length,o=0;o<r;o++)h[o].apply(this,s);return!0};EventEmitter$1.prototype.addListener=function(e,t){var n;if(!isFunction(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,isFunction(t.listener)?t.listener:t),this._events[e]?isObject(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,isObject(this._events[e])&&!this._events[e].warned&&(isUndefined(this._maxListeners)?n=EventEmitter$1.defaultMaxListeners:n=this._maxListeners,n&&n>0&&this._events[e].length>n&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),typeof console.trace=="function"&&console.trace())),this};EventEmitter$1.prototype.on=EventEmitter$1.prototype.addListener;EventEmitter$1.prototype.once=function(e,t){if(!isFunction(t))throw TypeError("listener must be a function");var n=!1;function r(){this.removeListener(e,r),n||(n=!0,t.apply(this,arguments))}return r.listener=t,this.on(e,r),this};EventEmitter$1.prototype.removeListener=function(e,t){var n,r,s,o;if(!isFunction(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(n=this._events[e],s=n.length,r=-1,n===t||isFunction(n.listener)&&n.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(isObject(n)){for(o=s;o-- >0;)if(n[o]===t||n[o].listener&&n[o].listener===t){r=o;break}if(r<0)return this;n.length===1?(n.length=0,delete this._events[e]):n.splice(r,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this};EventEmitter$1.prototype.removeAllListeners=function(e){var t,n;if(!this._events)return this;if(!this._events.removeListener)return arguments.length===0?this._events={}:this._events[e]&&delete this._events[e],this;if(arguments.length===0){for(t in this._events)t!=="removeListener"&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(n=this._events[e],isFunction(n))this.removeListener(e,n);else if(n)for(;n.length;)this.removeListener(e,n[n.length-1]);return delete this._events[e],this};EventEmitter$1.prototype.listeners=function(e){var t;return!this._events||!this._events[e]?t=[]:isFunction(this._events[e])?t=[this._events[e]]:t=this._events[e].slice(),t};EventEmitter$1.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(isFunction(t))return 1;if(t)return t.length}return 0};EventEmitter$1.listenerCount=function(e,t){return e.listenerCount(t)};function isFunction(e){return typeof e=="function"}function isNumber(e){return typeof e=="number"}function isObject(e){return typeof e=="object"&&e!==null}function isUndefined(e){return e===void 0}var define_global_default$1={},browser=define_global_default$1.performance&&define_global_default$1.performance.now?function(){return performance.now()}:Date.now||function(){return+new Date},raf$2={exports:{}},performanceNow={exports:{}};(function(){var e,t,n,r,s,o;typeof performance<"u"&&performance!==null&&performance.now?performanceNow.exports=function(){return performance.now()}:typeof process<"u"&&process!==null&&process.hrtime?(performanceNow.exports=function(){return(e()-s)/1e6},t=process.hrtime,e=function(){var h;return h=t(),h[0]*1e9+h[1]},r=e(),o=process.uptime()*1e9,s=r-o):Date.now?(performanceNow.exports=function(){return Date.now()-n},n=Date.now()):(performanceNow.exports=function(){return new Date().getTime()-n},n=new Date().getTime())}).call(commonjsGlobal);var performanceNowExports=performanceNow.exports,define_global_default={},now$1=performanceNowExports,root=typeof window>"u"?define_global_default:window,vendors=["moz","webkit"],suffix="AnimationFrame",raf$1=root["request"+suffix],caf=root["cancel"+suffix]||root["cancelRequest"+suffix];for(var i$1=0;!raf$1&&i$1<vendors.length;i$1++)raf$1=root[vendors[i$1]+"Request"+suffix],caf=root[vendors[i$1]+"Cancel"+suffix]||root[vendors[i$1]+"CancelRequest"+suffix];if(!raf$1||!caf){var last=0,id=0,queue=[],frameDuration=1e3/60;raf$1=function(e){if(queue.length===0){var t=now$1(),n=Math.max(0,frameDuration-(t-last));last=n+t,setTimeout(function(){var r=queue.slice(0);queue.length=0;for(var s=0;s<r.length;s++)if(!r[s].cancelled)try{r[s].callback(last)}catch(o){setTimeout(function(){throw o},0)}},Math.round(n))}return queue.push({handle:++id,callback:e,cancelled:!1}),id},caf=function(e){for(var t=0;t<queue.length;t++)queue[t].handle===e&&(queue[t].cancelled=!0)}}raf$2.exports=function(e){return raf$1.call(root,e)};raf$2.exports.cancel=function(){caf.apply(root,arguments)};raf$2.exports.polyfill=function(e){e||(e=root),e.requestAnimationFrame=raf$1,e.cancelAnimationFrame=caf};var rafExports=raf$2.exports,inherits=inherits_browserExports,EventEmitter=events.EventEmitter,now=browser,raf=rafExports,rafLoop=Engine;function Engine(e){if(!(this instanceof Engine))return new Engine(e);this.running=!1,this.last=now(),this._frame=0,this._tick=this.tick.bind(this),e&&this.on("tick",e)}inherits(Engine,EventEmitter);Engine.prototype.start=function(){if(!this.running)return this.running=!0,this.last=now(),this._frame=raf(this._tick),this};Engine.prototype.stop=function(){return this.running=!1,this._frame!==0&&raf.cancel(this._frame),this._frame=0,this};Engine.prototype.tick=function(){this._frame=raf(this._tick);var e=now(),t=e-this.last;this.emit("tick",t),this.last=e};const loop=getDefaultExportFromCjs(rafLoop);function Webcam(e){return navigator.mediaDevices.enumerateDevices().then(t=>t.filter(n=>n.kind==="videoinput")).then(t=>{let n={audio:!1,video:!0};return t[e]&&(n.video={deviceId:{exact:t[e].deviceId}}),window.navigator.mediaDevices.getUserMedia(n)}).then(t=>{const n=document.createElement("video");return n.setAttribute("autoplay",""),n.setAttribute("muted",""),n.setAttribute("playsinline",""),n.srcObject=t,new Promise((r,s)=>{n.addEventListener("loadedmetadata",()=>{n.play().then(()=>r({video:n}))})})}).catch(console.log.bind(console))}function Screen(e){return new Promise(function(t,n){navigator.mediaDevices.getDisplayMedia(e).then(r=>{const s=document.createElement("video");s.srcObject=r,s.addEventListener("loadedmetadata",()=>{s.play(),t({video:s})})}).catch(r=>n(r))})}class HydraSource{constructor({regl:t,width:n,height:r,pb:s,label:o=""}){this.label=o,this.regl=t,this.src=null,this.dynamic=!0,this.width=n,this.height=r,this.tex=this.regl.texture({shape:[1,1]}),this.pb=s}init(t,n){"src"in t&&(this.src=t.src,this.tex=this.regl.texture({data:this.src,...n})),"dynamic"in t&&(this.dynamic=t.dynamic)}initCam(t,n){const r=this;Webcam(t).then(s=>{r.src=s.video,r.dynamic=!0,r.tex=r.regl.texture({data:r.src,...n})}).catch(s=>console.log("could not get camera",s))}initVideo(t="",n){const r=document.createElement("video");r.crossOrigin="anonymous",r.autoplay=!0,r.loop=!0,r.muted=!0,r.addEventListener("loadeddata",()=>{this.src=r,r.play(),this.tex=this.regl.texture({data:this.src,...n}),this.dynamic=!0}),r.src=t}initImage(t="",n){const r=document.createElement("img");r.crossOrigin="anonymous",r.src=t,r.onload=()=>{this.src=r,this.dynamic=!1,this.tex=this.regl.texture({data:this.src,...n})}}initStream(t,n){let r=this;t&&this.pb&&(this.pb.initSource(t),this.pb.on("got video",function(s,o){s===t&&(r.src=o,r.dynamic=!0,r.tex=r.regl.texture({data:r.src,...n}))}))}initScreen(t=0,n){const r=this;Screen().then(function(s){r.src=s.video,r.tex=r.regl.texture({data:r.src,...n}),r.dynamic=!0}).catch(s=>console.log("could not get screen",s))}resize(t,n){this.width=t,this.height=n}clear(){this.src&&this.src.srcObject&&this.src.srcObject.getTracks&&this.src.srcObject.getTracks().forEach(t=>t.stop()),this.src=null,this.tex=this.regl.texture({shape:[1,1]})}tick(t){this.src!==null&&this.dynamic===!0&&(this.src.videoWidth&&this.src.videoWidth!==this.tex.width&&(console.log(this.src.videoWidth,this.src.videoHeight,this.tex.width,this.tex.height),this.tex.resize(this.src.videoWidth,this.src.videoHeight)),this.src.width&&this.src.width!==this.tex.width&&this.tex.resize(this.src.width,this.src.height),this.tex.subimage(this.src))}getTexture(){return this.tex}}const mouse={};function mouseButtons(e){if(typeof e=="object"){if("buttons"in e)return e.buttons;if("which"in e){var t=e.which;if(t===2)return 4;if(t===3)return 2;if(t>0)return 1<<t-1}else if("button"in e){var t=e.button;if(t===1)return 4;if(t===2)return 2;if(t>=0)return 1<<t}}return 0}mouse.buttons=mouseButtons;function mouseElement(e){return e.target||e.srcElement||window}mouse.element=mouseElement;function mouseRelativeX(e){return typeof e=="object"&&"pageX"in e?e.pageX:0}mouse.x=mouseRelativeX;function mouseRelativeY(e){return typeof e=="object"&&"pageY"in e?e.pageY:0}mouse.y=mouseRelativeY;function mouseListen(e,t){t||(t=e,e=window);var n=0,r=0,s=0,o={shift:!1,alt:!1,control:!1,meta:!1},h=!1;function u(A){var l=!1;return"altKey"in A&&(l=l||A.altKey!==o.alt,o.alt=!!A.altKey),"shiftKey"in A&&(l=l||A.shiftKey!==o.shift,o.shift=!!A.shiftKey),"ctrlKey"in A&&(l=l||A.ctrlKey!==o.control,o.control=!!A.ctrlKey),"metaKey"in A&&(l=l||A.metaKey!==o.meta,o.meta=!!A.metaKey),l}function f(A,l){var I=mouse.x(l),T=mouse.y(l);"buttons"in l&&(A=l.buttons|0),(A!==n||I!==r||T!==s||u(l))&&(n=A|0,r=I||0,s=T||0,t&&t(n,r,s,o))}function c(A){f(0,A)}function _(){(n||r||s||o.shift||o.alt||o.meta||o.control)&&(r=s=0,n=0,o.shift=o.alt=o.control=o.meta=!1,t&&t(0,0,0,o))}function O(A){u(A)&&t&&t(n,r,s,o)}function d(A){mouse.buttons(A)===0?f(0,A):f(n,A)}function b(A){f(n|mouse.buttons(A),A)}function S(A){f(n&~mouse.buttons(A),A)}function G(){h||(h=!0,e.addEventListener("mousemove",d),e.addEventListener("mousedown",b),e.addEventListener("mouseup",S),e.addEventListener("mouseleave",c),e.addEventListener("mouseenter",c),e.addEventListener("mouseout",c),e.addEventListener("mouseover",c),e.addEventListener("blur",_),e.addEventListener("keyup",O),e.addEventListener("keydown",O),e.addEventListener("keypress",O),e!==window&&(window.addEventListener("blur",_),window.addEventListener("keyup",O),window.addEventListener("keydown",O),window.addEventListener("keypress",O)))}function z(){h&&(h=!1,e.removeEventListener("mousemove",d),e.removeEventListener("mousedown",b),e.removeEventListener("mouseup",S),e.removeEventListener("mouseleave",c),e.removeEventListener("mouseenter",c),e.removeEventListener("mouseout",c),e.removeEventListener("mouseover",c),e.removeEventListener("blur",_),e.removeEventListener("keyup",O),e.removeEventListener("keydown",O),e.removeEventListener("keypress",O),e!==window&&(window.removeEventListener("blur",_),window.removeEventListener("keyup",O),window.removeEventListener("keydown",O),window.removeEventListener("keypress",O)))}G();var $={element:e};return Object.defineProperties($,{enabled:{get:function(){return h},set:function(A){A?G():z()},enumerable:!0},buttons:{get:function(){return n},enumerable:!0},x:{get:function(){return r},enumerable:!0},y:{get:function(){return s},enumerable:!0},mods:{get:function(){return o},enumerable:!0}}),$}var meyda_min={exports:{}},dct_1,hasRequiredDct$1;function requireDct$1(){if(hasRequiredDct$1)return dct_1;hasRequiredDct$1=1;var e=null,t=function(r){e=e||{},e[r]=new Array(r*r);for(var s=Math.PI/r,o=0;o<r;o++)for(var h=0;h<r;h++)e[r][h+o*r]=Math.cos(s*(h+.5)*o)};function n(r,s){var o=r.length;s=s||2,(!e||!e[o])&&t(o);var h=r.map(function(){return 0});return h.map(function(u,f){return s*r.reduce(function(c,_,O,d){return c+_*e[o][O+f*o]},0)})}return dct_1=n,dct_1}var dct,hasRequiredDct;function requireDct(){return hasRequiredDct||(hasRequiredDct=1,dct=requireDct$1()),dct}var utils,hasRequiredUtils;function requireUtils(){if(hasRequiredUtils)return utils;hasRequiredUtils=1;function e(_){if(Array.isArray(_)){for(var O=0,d=Array(_.length);O<_.length;O++)d[O]=_[O];return d}else return Array.from(_)}var t={},n={},r=function(O){var d={};d.real=O.real===void 0?O.slice():O.real.slice();var b=d.real.length;return n[b]===void 0&&(n[b]=Array.apply(null,Array(b)).map(Number.prototype.valueOf,0)),d.imag=n[b].slice(),d},s=function(O){if(t[O]===void 0){for(var d=(O-1).toString(2).length,b="0".repeat(d),S={},G=0;G<O;G++){var z=G.toString(2);z=b.substr(z.length)+z,z=[].concat(e(z)).reverse().join(""),S[G]=parseInt(z,2)}t[O]=S}return t[O]},o=function(O,d){return{real:O.real*d.real-O.imag*d.imag,imag:O.real*d.imag+O.imag*d.real}},h=function(O,d){return{real:O.real+d.real,imag:O.imag+d.imag}},u=function(O,d){return{real:O.real-d.real,imag:O.imag-d.imag}},f=function(O,d){var b=-2*Math.PI*O/d;return{real:Math.cos(b),imag:Math.sin(b)}},c=function(O){return O.imag*=-1,O};return utils={bitReverseArray:s,multiply:o,add:h,subtract:u,euler:f,conj:c,constructComplexArray:r},utils}var fft_1,hasRequiredFft;function requireFft(){if(hasRequiredFft)return fft_1;hasRequiredFft=1;var e=requireUtils(),t=function(s){var o={};s.real===void 0||s.imag===void 0?o=e.constructComplexArray(s):(o.real=s.real.slice(),o.imag=s.imag.slice());var h=o.real.length,u=Math.log2(h);if(Math.round(u)!=u)throw new Error("Input size must be a power of 2.");if(o.real.length!=o.imag.length)throw new Error("Real and imaginary components must have the same length.");for(var f=e.bitReverseArray(h),c={real:[],imag:[]},_=0;_<h;_++)c.real[f[_]]=o.real[_],c.imag[f[_]]=o.imag[_];for(var O=0;O<h;O++)o.real[O]=c.real[O],o.imag[O]=c.imag[O];for(var d=1;d<=u;d++)for(var b=Math.pow(2,d),S=0;S<b/2;S++)for(var G=e.euler(S,b),z=0;z<h/b;z++){var $=b*z+S,A=b*z+S+b/2,l={real:o.real[$],imag:o.imag[$]},I={real:o.real[A],imag:o.imag[A]},T=e.multiply(G,I),L=e.subtract(l,T);o.real[A]=L.real,o.imag[A]=L.imag;var C=e.add(T,l);o.real[$]=C.real,o.imag[$]=C.imag}return o},n=function(s){if(s.real===void 0||s.imag===void 0)throw new Error("IFFT only accepts a complex input.");for(var o=s.real.length,h={real:[],imag:[]},u=0;u<o;u++){var f={real:s.real[u],imag:s.imag[u]},c=e.conj(f);h.real[u]=c.real,h.imag[u]=c.imag}var _=t(h);return h.real=_.real.map(function(O){return O/o}),h.imag=_.imag.map(function(O){return O/o}),h};return fft_1={fft:t,ifft:n},fft_1}(function(e,t){(function(n,r){e.exports=r(requireDct(),requireFft())})(commonjsGlobal,function(n,r){function s(L,C,N){if(N||arguments.length===2)for(var R,Y=0,ut=C.length;Y<ut;Y++)!R&&Y in C||(R||(R=Array.prototype.slice.call(C,0,Y)),R[Y]=C[Y]);return L.concat(R||Array.prototype.slice.call(C))}var o=Object.freeze({__proto__:null,blackman:function(L){for(var C=new Float32Array(L),N=2*Math.PI/(L-1),R=2*N,Y=0;Y<L/2;Y++)C[Y]=.42-.5*Math.cos(Y*N)+.08*Math.cos(Y*R);for(Y=Math.ceil(L/2);Y>0;Y--)C[L-Y]=C[Y-1];return C},hamming:function(L){for(var C=new Float32Array(L),N=0;N<L;N++)C[N]=.54-.46*Math.cos(2*Math.PI*(N/L-1));return C},hanning:function(L){for(var C=new Float32Array(L),N=0;N<L;N++)C[N]=.5-.5*Math.cos(2*Math.PI*N/(L-1));return C},sine:function(L){for(var C=Math.PI/(L-1),N=new Float32Array(L),R=0;R<L;R++)N[R]=Math.sin(C*R);return N}}),h={};function u(L){for(;L%2==0&&L>1;)L/=2;return L===1}function f(L,C){if(C!=="rect"){if(C!==""&&C||(C="hanning"),h[C]||(h[C]={}),!h[C][L.length])try{h[C][L.length]=o[C](L.length)}catch{throw new Error("Invalid windowing function")}L=function(N,R){for(var Y=[],ut=0;ut<Math.min(N.length,R.length);ut++)Y[ut]=N[ut]*R[ut];return Y}(L,h[C][L.length])}return L}function c(L,C,N){for(var R=new Float32Array(L),Y=0;Y<R.length;Y++)R[Y]=Y*C/N,R[Y]=13*Math.atan(R[Y]/1315.8)+3.5*Math.atan(Math.pow(R[Y]/7518,2));return R}function _(L){return Float32Array.from(L)}function O(L){return 1125*Math.log(1+L/700)}function d(L,C,N){for(var R,Y=new Float32Array(L+2),ut=new Float32Array(L+2),mt=C/2,yt=O(0),D=(O(mt)-yt)/(L+1),F=new Array(L+2),E=0;E<Y.length;E++)Y[E]=E*D,ut[E]=(R=Y[E],700*(Math.exp(R/1125)-1)),F[E]=Math.floor((N+1)*ut[E]/C);for(var Q=new Array(L),P=0;P<Q.length;P++){for(Q[P]=new Array(N/2+1).fill(0),E=F[P];E<F[P+1];E++)Q[P][E]=(E-F[P])/(F[P+1]-F[P]);for(E=F[P+1];E<F[P+2];E++)Q[P][E]=(F[P+2]-E)/(F[P+2]-F[P+1])}return Q}function b(L,C,N,R,Y,ut,mt){R===void 0&&(R=5),Y===void 0&&(Y=2),ut===void 0&&(ut=!0),mt===void 0&&(mt=440);var yt=Math.floor(N/2)+1,D=new Array(N).fill(0).map(function(kt,Yt){return L*function(te,re){return Math.log2(16*te/re)}(C*Yt/N,mt)});D[0]=D[1]-1.5*L;var F,E,Q,P=D.slice(1).map(function(kt,Yt){return Math.max(kt-D[Yt])},1).concat([1]),H=Math.round(L/2),q=new Array(L).fill(0).map(function(kt,Yt){return D.map(function(te){return(10*L+H+te-Yt)%L-H})}),st=q.map(function(kt,Yt){return kt.map(function(te,re){return Math.exp(-.5*Math.pow(2*q[Yt][re]/P[re],2))})});if(E=(F=st)[0].map(function(){return 0}),Q=F.reduce(function(kt,Yt){return Yt.forEach(function(te,re){kt[re]+=Math.pow(te,2)}),kt},E).map(Math.sqrt),st=F.map(function(kt,Yt){return kt.map(function(te,re){return te/(Q[re]||1)})}),Y){var vt=D.map(function(kt){return Math.exp(-.5*Math.pow((kt/L-R)/Y,2))});st=st.map(function(kt){return kt.map(function(Yt,te){return Yt*vt[te]})})}return ut&&(st=s(s([],st.slice(3),!0),st.slice(0,3),!0)),st.map(function(kt){return kt.slice(0,yt)})}function S(L,C){for(var N=0,R=0,Y=0;Y<C.length;Y++)N+=Math.pow(Y,L)*Math.abs(C[Y]),R+=C[Y];return N/R}function G(L){var C=L.ampSpectrum,N=L.barkScale,R=L.numberOfBarkBands,Y=R===void 0?24:R;if(typeof C!="object"||typeof N!="object")throw new TypeError;var ut=Y,mt=new Float32Array(ut),yt=0,D=C,F=new Int32Array(ut+1);F[0]=0;for(var E=N[D.length-1]/ut,Q=1,P=0;P<D.length;P++)for(;N[P]>E;)F[Q++]=P,E=Q*N[D.length-1]/ut;for(F[ut]=D.length-1,P=0;P<ut;P++){for(var H=0,q=F[P];q<F[P+1];q++)H+=D[q];mt[P]=Math.pow(H,.23)}for(P=0;P<mt.length;P++)yt+=mt[P];return{specific:mt,total:yt}}function z(L){var C=L.ampSpectrum;if(typeof C!="object")throw new TypeError;for(var N=new Float32Array(C.length),R=0;R<N.length;R++)N[R]=Math.pow(C[R],2);return N}function $(L){var C=L.ampSpectrum,N=L.melFilterBank,R=L.bufferSize;if(typeof C!="object")throw new TypeError("Valid ampSpectrum is required to generate melBands");if(typeof N!="object")throw new TypeError("Valid melFilterBank is required to generate melBands");for(var Y=z({ampSpectrum:C}),ut=N.length,mt=Array(ut),yt=new Float32Array(ut),D=0;D<yt.length;D++){mt[D]=new Float32Array(R/2),yt[D]=0;for(var F=0;F<R/2;F++)mt[D][F]=N[D][F]*Y[F],yt[D]+=mt[D][F];yt[D]=Math.log(yt[D]+1)}return Array.prototype.slice.call(yt)}var A=Object.freeze({__proto__:null,amplitudeSpectrum:function(L){return L.ampSpectrum},buffer:function(L){return L.signal},chroma:function(L){var C=L.ampSpectrum,N=L.chromaFilterBank;if(typeof C!="object")throw new TypeError("Valid ampSpectrum is required to generate chroma");if(typeof N!="object")throw new TypeError("Valid chromaFilterBank is required to generate chroma");var R=N.map(function(ut,mt){return C.reduce(function(yt,D,F){return yt+D*ut[F]},0)}),Y=Math.max.apply(Math,R);return Y?R.map(function(ut){return ut/Y}):R},complexSpectrum:function(L){return L.complexSpectrum},energy:function(L){var C=L.signal;if(typeof C!="object")throw new TypeError;for(var N=0,R=0;R<C.length;R++)N+=Math.pow(Math.abs(C[R]),2);return N},loudness:G,melBands:$,mfcc:function(L){var C=L.ampSpectrum,N=L.melFilterBank,R=L.numberOfMFCCCoefficients,Y=L.bufferSize,ut=Math.min(40,Math.max(1,R||13));if(N.length<ut)throw new Error("Insufficient filter bank for requested number of coefficients");var mt=$({ampSpectrum:C,melFilterBank:N,bufferSize:Y});return n(mt).slice(0,ut)},perceptualSharpness:function(L){for(var C=G({ampSpectrum:L.ampSpectrum,barkScale:L.barkScale}),N=C.specific,R=0,Y=0;Y<N.length;Y++)R+=Y<15?(Y+1)*N[Y+1]:.066*Math.exp(.171*(Y+1));return R*=.11/C.total},perceptualSpread:function(L){for(var C=G({ampSpectrum:L.ampSpectrum,barkScale:L.barkScale}),N=0,R=0;R<C.specific.length;R++)C.specific[R]>N&&(N=C.specific[R]);return Math.pow((C.total-N)/C.total,2)},powerSpectrum:z,rms:function(L){var C=L.signal;if(typeof C!="object")throw new TypeError;for(var N=0,R=0;R<C.length;R++)N+=Math.pow(C[R],2);return N/=C.length,N=Math.sqrt(N)},spectralCentroid:function(L){var C=L.ampSpectrum;if(typeof C!="object")throw new TypeError;return S(1,C)},spectralCrest:function(L){var C=L.ampSpectrum;if(typeof C!="object")throw new TypeError;var N=0,R=-1/0;return C.forEach(function(Y){N+=Math.pow(Y,2),R=Y>R?Y:R}),N/=C.length,N=Math.sqrt(N),R/N},spectralFlatness:function(L){var C=L.ampSpectrum;if(typeof C!="object")throw new TypeError;for(var N=0,R=0,Y=0;Y<C.length;Y++)N+=Math.log(C[Y]),R+=C[Y];return Math.exp(N/C.length)*C.length/R},spectralFlux:function(L){var C=L.signal,N=L.previousSignal,R=L.bufferSize;if(typeof C!="object"||typeof N!="object")throw new TypeError;for(var Y=0,ut=-R/2;ut<C.length/2-1;ut++)x=Math.abs(C[ut])-Math.abs(N[ut]),Y+=(x+Math.abs(x))/2;return Y},spectralKurtosis:function(L){var C=L.ampSpectrum;if(typeof C!="object")throw new TypeError;var N=C,R=S(1,N),Y=S(2,N),ut=S(3,N),mt=S(4,N);return(-3*Math.pow(R,4)+6*R*Y-4*R*ut+mt)/Math.pow(Math.sqrt(Y-Math.pow(R,2)),4)},spectralRolloff:function(L){var C=L.ampSpectrum,N=L.sampleRate;if(typeof C!="object")throw new TypeError;for(var R=C,Y=N/(2*(R.length-1)),ut=0,mt=0;mt<R.length;mt++)ut+=R[mt];for(var yt=.99*ut,D=R.length-1;ut>yt&&D>=0;)ut-=R[D],--D;return(D+1)*Y},spectralSkewness:function(L){var C=L.ampSpectrum;if(typeof C!="object")throw new TypeError;var N=S(1,C),R=S(2,C),Y=S(3,C);return(2*Math.pow(N,3)-3*N*R+Y)/Math.pow(Math.sqrt(R-Math.pow(N,2)),3)},spectralSlope:function(L){var C=L.ampSpectrum,N=L.sampleRate,R=L.bufferSize;if(typeof C!="object")throw new TypeError;for(var Y=0,ut=0,mt=new Float32Array(C.length),yt=0,D=0,F=0;F<C.length;F++){Y+=C[F];var E=F*N/R;mt[F]=E,yt+=E*E,ut+=E,D+=E*C[F]}return(C.length*D-ut*Y)/(Y*(yt-Math.pow(ut,2)))},spectralSpread:function(L){var C=L.ampSpectrum;if(typeof C!="object")throw new TypeError;return Math.sqrt(S(2,C)-Math.pow(S(1,C),2))},zcr:function(L){var C=L.signal;if(typeof C!="object")throw new TypeError;for(var N=0,R=1;R<C.length;R++)(C[R-1]>=0&&C[R]<0||C[R-1]<0&&C[R]>=0)&&N++;return N}}),l=function(){function L(C,N){var R=this;if(this._m=N,!C.audioContext)throw this._m.errors.noAC;if(C.bufferSize&&!u(C.bufferSize))throw this._m._errors.notPow2;if(!C.source)throw this._m._errors.noSource;this._m.audioContext=C.audioContext,this._m.bufferSize=C.bufferSize||this._m.bufferSize||256,this._m.hopSize=C.hopSize||this._m.hopSize||this._m.bufferSize,this._m.sampleRate=C.sampleRate||this._m.audioContext.sampleRate||44100,this._m.callback=C.callback,this._m.windowingFunction=C.windowingFunction||"hanning",this._m.featureExtractors=A,this._m.EXTRACTION_STARTED=C.startImmediately||!1,this._m.channel=typeof C.channel=="number"?C.channel:0,this._m.inputs=C.inputs||1,this._m.outputs=C.outputs||1,this._m.numberOfMFCCCoefficients=C.numberOfMFCCCoefficients||this._m.numberOfMFCCCoefficients||13,this._m.numberOfBarkBands=C.numberOfBarkBands||this._m.numberOfBarkBands||24,this._m.spn=this._m.audioContext.createScriptProcessor(this._m.bufferSize,this._m.inputs,this._m.outputs),this._m.spn.connect(this._m.audioContext.destination),this._m._featuresToExtract=C.featureExtractors||[],this._m.barkScale=c(this._m.bufferSize,this._m.sampleRate,this._m.bufferSize),this._m.melFilterBank=d(Math.max(this._m.melBands,this._m.numberOfMFCCCoefficients),this._m.sampleRate,this._m.bufferSize),this._m.inputData=null,this._m.previousInputData=null,this._m.frame=null,this._m.previousFrame=null,this.setSource(C.source),this._m.spn.onaudioprocess=function(Y){var ut;R._m.inputData!==null&&(R._m.previousInputData=R._m.inputData),R._m.inputData=Y.inputBuffer.getChannelData(R._m.channel),R._m.previousInputData?((ut=new Float32Array(R._m.previousInputData.length+R._m.inputData.length-R._m.hopSize)).set(R._m.previousInputData.slice(R._m.hopSize)),ut.set(R._m.inputData,R._m.previousInputData.length-R._m.hopSize)):ut=R._m.inputData;var mt=function(yt,D,F){if(yt.length<D)throw new Error("Buffer is too short for frame length");if(F<1)throw new Error("Hop length cannot be less that 1");if(D<1)throw new Error("Frame length cannot be less that 1");var E=1+Math.floor((yt.length-D)/F);return new Array(E).fill(0).map(function(Q,P){return yt.slice(P*F,P*F+D)})}(ut,R._m.bufferSize,R._m.hopSize);mt.forEach(function(yt){R._m.frame=yt;var D=R._m.extract(R._m._featuresToExtract,R._m.frame,R._m.previousFrame);typeof R._m.callback=="function"&&R._m.EXTRACTION_STARTED&&R._m.callback(D),R._m.previousFrame=R._m.frame})}}return L.prototype.start=function(C){this._m._featuresToExtract=C||this._m._featuresToExtract,this._m.EXTRACTION_STARTED=!0},L.prototype.stop=function(){this._m.EXTRACTION_STARTED=!1},L.prototype.setSource=function(C){this._m.source&&this._m.source.disconnect(this._m.spn),this._m.source=C,this._m.source.connect(this._m.spn)},L.prototype.setChannel=function(C){C<=this._m.inputs?this._m.channel=C:console.error("Channel ".concat(C," does not exist. Make sure you've provided a value for 'inputs' that is greater than ").concat(C," when instantiating the MeydaAnalyzer"))},L.prototype.get=function(C){return this._m.inputData?this._m.extract(C||this._m._featuresToExtract,this._m.inputData,this._m.previousInputData):null},L}(),I={audioContext:null,spn:null,bufferSize:512,sampleRate:44100,melBands:26,chromaBands:12,callback:null,windowingFunction:"hanning",featureExtractors:A,EXTRACTION_STARTED:!1,numberOfMFCCCoefficients:13,numberOfBarkBands:24,_featuresToExtract:[],windowing:f,_errors:{notPow2:new Error("Meyda: Buffer size must be a power of 2, e.g. 64 or 512"),featureUndef:new Error("Meyda: No features defined."),invalidFeatureFmt:new Error("Meyda: Invalid feature format"),invalidInput:new Error("Meyda: Invalid input."),noAC:new Error("Meyda: No AudioContext specified."),noSource:new Error("Meyda: No source node specified.")},createMeydaAnalyzer:function(L){return new l(L,Object.assign({},I))},listAvailableFeatureExtractors:function(){return Object.keys(this.featureExtractors)},extract:function(L,C,N){var R=this;if(!C)throw this._errors.invalidInput;if(typeof C!="object")throw this._errors.invalidInput;if(!L)throw this._errors.featureUndef;if(!u(C.length))throw this._errors.notPow2;this.barkScale!==void 0&&this.barkScale.length==this.bufferSize||(this.barkScale=c(this.bufferSize,this.sampleRate,this.bufferSize)),this.melFilterBank!==void 0&&this.barkScale.length==this.bufferSize&&this.melFilterBank.length==this.melBands||(this.melFilterBank=d(Math.max(this.melBands,this.numberOfMFCCCoefficients),this.sampleRate,this.bufferSize)),this.chromaFilterBank!==void 0&&this.chromaFilterBank.length==this.chromaBands||(this.chromaFilterBank=b(this.chromaBands,this.sampleRate,this.bufferSize)),"buffer"in C&&C.buffer===void 0?this.signal=_(C):this.signal=C;var Y=T(C,this.windowingFunction,this.bufferSize);if(this.signal=Y.windowedSignal,this.complexSpectrum=Y.complexSpectrum,this.ampSpectrum=Y.ampSpectrum,N){var ut=T(N,this.windowingFunction,this.bufferSize);this.previousSignal=ut.windowedSignal,this.previousComplexSpectrum=ut.complexSpectrum,this.previousAmpSpectrum=ut.ampSpectrum}var mt=function(yt){return R.featureExtractors[yt]({ampSpectrum:R.ampSpectrum,chromaFilterBank:R.chromaFilterBank,complexSpectrum:R.complexSpectrum,signal:R.signal,bufferSize:R.bufferSize,sampleRate:R.sampleRate,barkScale:R.barkScale,melFilterBank:R.melFilterBank,previousSignal:R.previousSignal,previousAmpSpectrum:R.previousAmpSpectrum,previousComplexSpectrum:R.previousComplexSpectrum,numberOfMFCCCoefficients:R.numberOfMFCCCoefficients,numberOfBarkBands:R.numberOfBarkBands})};if(typeof L=="object")return L.reduce(function(yt,D){var F;return Object.assign({},yt,((F={})[D]=mt(D),F))},{});if(typeof L=="string")return mt(L);throw this._errors.invalidFeatureFmt}},T=function(L,C,N){var R={};L.buffer===void 0?R.signal=_(L):R.signal=L,R.windowedSignal=f(R.signal,C),R.complexSpectrum=r.fft(R.windowedSignal),R.ampSpectrum=new Float32Array(N/2);for(var Y=0;Y<N/2;Y++)R.ampSpectrum[Y]=Math.sqrt(Math.pow(R.complexSpectrum.real[Y],2)+Math.pow(R.complexSpectrum.imag[Y],2));return R};return typeof window<"u"&&(window.Meyda=I),I})})(meyda_min);var meyda_minExports=meyda_min.exports;const Meyda=getDefaultExportFromCjs(meyda_minExports);class Audio{constructor({numBins:t=4,cutoff:n=2,smooth:r=.4,max:s=15,scale:o=10,isDrawing:h=!1,parentEl:u=document.body}){this.vol=0,this.scale=o,this.max=s,this.cutoff=n,this.smooth=r,this.setBins(t),this.beat={holdFrames:20,threshold:40,_cutoff:0,decay:.98,_framesSinceBeat:0},this.onBeat=()=>{},this.canvas=document.createElement("canvas"),this.canvas.width=100,this.canvas.height=80,this.canvas.style.width="100px",this.canvas.style.height="80px",this.canvas.style.position="absolute",this.canvas.style.right="0px",this.canvas.style.bottom="0px",u.appendChild(this.canvas),this.isDrawing=h,this.ctx=this.canvas.getContext("2d"),this.ctx.fillStyle="#DFFFFF",this.ctx.strokeStyle="#0ff",this.ctx.lineWidth=.5,window.navigator.mediaDevices&&window.navigator.mediaDevices.getUserMedia({video:!1,audio:!0}).then(f=>{this.stream=f,this.context=new AudioContext;let c=this.context.createMediaStreamSource(f);this.meyda=Meyda.createMeydaAnalyzer({audioContext:this.context,source:c,featureExtractors:["loudness"]})}).catch(f=>console.log("ERROR",f))}detectBeat(t){t>this.beat._cutoff&&t>this.beat.threshold?(this.onBeat(),this.beat._cutoff=t*1.2,this.beat._framesSinceBeat=0):this.beat._framesSinceBeat<=this.beat.holdFrames?this.beat._framesSinceBeat++:(this.beat._cutoff*=this.beat.decay,this.beat._cutoff=Math.max(this.beat._cutoff,this.beat.threshold))}tick(){if(this.meyda){var t=this.meyda.get();if(t&&t!==null){this.vol=t.loudness.total,this.detectBeat(this.vol);const n=(s,o)=>s+o;let r=Math.floor(t.loudness.specific.length/this.bins.length);this.prevBins=this.bins.slice(0),this.bins=this.bins.map((s,o)=>t.loudness.specific.slice(o*r,(o+1)*r).reduce(n)).map((s,o)=>s*(1-this.settings[o].smooth)+this.prevBins[o]*this.settings[o].smooth),this.fft=this.bins.map((s,o)=>Math.max(0,(s-this.settings[o].cutoff)/this.settings[o].scale)),this.isDrawing&&this.draw()}}}setCutoff(t){this.cutoff=t,this.settings=this.settings.map(n=>(n.cutoff=t,n))}setSmooth(t){this.smooth=t,this.settings=this.settings.map(n=>(n.smooth=t,n))}setBins(t){this.bins=Array(t).fill(0),this.prevBins=Array(t).fill(0),this.fft=Array(t).fill(0),this.settings=Array(t).fill(0).map(()=>({cutoff:this.cutoff,scale:this.scale,smooth:this.smooth})),this.bins.forEach((n,r)=>{window["a"+r]=(s=1,o=0)=>()=>a.fft[r]*s+o})}setScale(t){this.scale=t,this.settings=this.settings.map(n=>(n.scale=t,n))}setMax(t){this.max=t,console.log("set max is deprecated")}hide(){this.isDrawing=!1,this.canvas.style.display="none"}show(){this.isDrawing=!0,this.canvas.style.display="block"}draw(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);var t=this.canvas.width/this.bins.length,n=this.canvas.height/(this.max*2);this.bins.forEach((r,s)=>{var o=r*n;this.ctx.fillRect(s*t,this.canvas.height-o,t,o);var h=this.canvas.height-n*this.settings[s].cutoff;this.ctx.beginPath(),this.ctx.moveTo(s*t,h),this.ctx.lineTo((s+1)*t,h),this.ctx.stroke();var u=this.canvas.height-n*(this.settings[s].scale+this.settings[s].cutoff);this.ctx.beginPath(),this.ctx.moveTo(s*t,u),this.ctx.lineTo((s+1)*t,u),this.ctx.stroke()})}}class VideoRecorder{constructor(t){this.mediaSource=new MediaSource,this.stream=t,this.output=document.createElement("video"),this.output.autoplay=!0,this.output.loop=!0;let n=this;this.mediaSource.addEventListener("sourceopen",()=>{console.log("MediaSource opened"),n.sourceBuffer=n.mediaSource.addSourceBuffer('video/webm; codecs="vp8"'),console.log("Source buffer: ",sourceBuffer)})}start(){let t={mimeType:"video/webm;codecs=vp9"};this.recordedBlobs=[];try{this.mediaRecorder=new MediaRecorder(this.stream,t)}catch(n){console.log("Unable to create MediaRecorder with options Object: ",n);try{t={mimeType:"video/webm,codecs=vp9"},this.mediaRecorder=new MediaRecorder(this.stream,t)}catch(r){console.log("Unable to create MediaRecorder with options Object: ",r);try{t="video/vp8",this.mediaRecorder=new MediaRecorder(this.stream,t)}catch(s){alert(`MediaRecorder is not supported by this browser.

Try Firefox 29 or later, or Chrome 47 or later, with Enable experimental Web Platform features enabled from chrome://flags.`),console.error("Exception while creating MediaRecorder:",s);return}}}console.log("Created MediaRecorder",this.mediaRecorder,"with options",t),this.mediaRecorder.onstop=this._handleStop.bind(this),this.mediaRecorder.ondataavailable=this._handleDataAvailable.bind(this),this.mediaRecorder.start(100),console.log("MediaRecorder started",this.mediaRecorder)}stop(){this.mediaRecorder.stop()}_handleStop(){const t=new Blob(this.recordedBlobs,{type:this.mediaRecorder.mimeType}),n=window.URL.createObjectURL(t);this.output.src=n;const r=document.createElement("a");r.style.display="none",r.href=n;let s=new Date;r.download=`hydra-${s.getFullYear()}-${s.getMonth()+1}-${s.getDate()}-${s.getHours()}.${s.getMinutes()}.${s.getSeconds()}.webm`,document.body.appendChild(r),r.click(),setTimeout(()=>{document.body.removeChild(r),window.URL.revokeObjectURL(n)},300)}_handleDataAvailable(t){t.data&&t.data.size>0&&this.recordedBlobs.push(t.data)}}const easing={linear:function(e){return e},easeInQuad:function(e){return e*e},easeOutQuad:function(e){return e*(2-e)},easeInOutQuad:function(e){return e<.5?2*e*e:-1+(4-2*e)*e},easeInCubic:function(e){return e*e*e},easeOutCubic:function(e){return--e*e*e+1},easeInOutCubic:function(e){return e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1},easeInQuart:function(e){return e*e*e*e},easeOutQuart:function(e){return 1- --e*e*e*e},easeInOutQuart:function(e){return e<.5?8*e*e*e*e:1-8*--e*e*e*e},easeInQuint:function(e){return e*e*e*e*e},easeOutQuint:function(e){return 1+--e*e*e*e*e},easeInOutQuint:function(e){return e<.5?16*e*e*e*e*e:1+16*--e*e*e*e*e},sin:function(e){return(1+Math.sin(Math.PI*e-Math.PI/2))/2}};var map=(e,t,n,r,s)=>(e-t)*(s-r)/(n-t)+r;const ArrayUtils={init:()=>{Array.prototype.fast=function(e=1){return this._speed=e,this},Array.prototype.smooth=function(e=1){return this._smooth=e,this},Array.prototype.ease=function(e="linear"){return typeof e=="function"?(this._smooth=1,this._ease=e):easing[e]&&(this._smooth=1,this._ease=easing[e]),this},Array.prototype.offset=function(e=.5){return this._offset=e%1,this},Array.prototype.fit=function(e=0,t=1){let n=Math.min(...this),r=Math.max(...this);var s=this.map(o=>map(o,n,r,e,t));return s._speed=this._speed,s._smooth=this._smooth,s._ease=this._ease,s}},getValue:(e=[])=>({time:t,bpm:n})=>{let r=e._speed?e._speed:1,s=e._smooth?e._smooth:0,o=t*r*(n/60)+(e._offset||0);if(s!==0){let h=e._ease?e._ease:easing.linear,u=o-s/2,f=e[Math.floor(u%e.length)],c=e[Math.floor((u+1)%e.length)],_=Math.min(u%1/s,1);return h(_)*(c-f)+f}else return e[Math.floor(o%e.length)],e[Math.floor(o%e.length)]}},Sandbox=e=>{var t="",n=s(t),r=(o,h)=>{t+=`
      var ${o} = ${h}
    `,n=s(t)};return{addToContext:r,eval:o=>n.eval(o)};function s(o){globalThis.eval(o);var h=function(u){globalThis.eval(u)};return{eval:h}}};class EvalSandbox{constructor(t,n,r=[]){this.makeGlobal=n,this.sandbox=Sandbox(),this.parent=t;var s=Object.keys(t);s.forEach(o=>this.add(o)),this.userProps=r}add(t){this.makeGlobal&&(window[t]=this.parent[t])}set(t,n){this.makeGlobal&&(window[t]=n),this.parent[t]=n}tick(){this.makeGlobal&&this.userProps.forEach(t=>{this.parent[t]=window[t]})}eval(t){this.sandbox.eval(t)}}const DEFAULT_CONVERSIONS={float:{vec4:{name:"sum",args:[[1,1,1,1]]},vec2:{name:"sum",args:[[1,1]]}}},ensure_decimal_dot=e=>(e=e.toString(),e.indexOf(".")<0&&(e+="."),e);function formatArguments(e,t,n){const r=e.transform.inputs,s=e.userArgs,{generators:o}=e.synth,{src:h}=o;return r.map((u,f)=>{const c={value:u.default,type:u.type,isUniform:!1,name:u.name,vecLen:0};if(c.type==="float"&&(c.value=ensure_decimal_dot(u.default)),u.type.startsWith("vec"))try{c.vecLen=Number.parseInt(u.type.substr(3))}catch{console.log(`Error determining length of vector input type ${u.type} (${u.name})`)}if(s.length>f&&(c.value=s[f],typeof s[f]=="function"?(c.value=(d,b,S)=>{try{const G=s[f](b);return typeof G=="number"?G:(console.warn("function does not return a number",s[f]),u.default)}catch(G){return console.warn("ERROR",G),u.default}},c.isUniform=!0):s[f].constructor===Array&&(c.value=(d,b,S)=>ArrayUtils.getValue(s[f])(b),c.isUniform=!0)),!(t<0)){if(c.value&&c.value.transforms){const d=c.value.transforms[c.value.transforms.length-1];if(d.transform.glsl_return_type!==u.type){const b=DEFAULT_CONVERSIONS[u.type];if(typeof b<"u"){const S=b[d.transform.glsl_return_type];if(typeof S<"u"){const{name:G,args:z}=S;c.value=c.value[G](...z)}}}c.isUniform=!1}else if(c.type==="float"&&typeof c.value=="number")c.value=ensure_decimal_dot(c.value);else if(c.type.startsWith("vec")&&typeof c.value=="object"&&Array.isArray(c.value))c.isUniform=!1,c.value=`${c.type}(${c.value.map(ensure_decimal_dot).join(", ")})`;else if(u.type==="sampler2D"){var _=c.value;c.value=()=>_.getTexture(),c.isUniform=!0}else if(c.value.getTexture&&u.type==="vec4"){var O=c.value;c.value=h(O),c.isUniform=!1}c.isUniform&&(c.name+=t)}return c})}function generateGlsl(e){var t={uniforms:[],glslFunctions:[],fragColor:""},n=generateGlsl$1(e,t)("st");t.fragColor=n;let r={};return t.uniforms.forEach(s=>r[s.name]=s),t.uniforms=Object.values(r),t}function generateGlsl$1(e,t){var n=()=>"";return e.forEach(r=>{var s=formatArguments(r,t.uniforms.length);s.forEach(u=>{u.isUniform&&t.uniforms.push(u)}),contains(r,t.glslFunctions)||t.glslFunctions.push(r);var o=n;if(r.transform.type==="src")n=u=>`${shaderString(u,r.name,s,t)}`;else if(r.transform.type==="coord")n=u=>`${o(`${shaderString(u,r.name,s,t)}`)}`;else if(r.transform.type==="color")n=u=>`${shaderString(`${o(u)}`,r.name,s,t)}`;else if(r.transform.type==="combine"){var h=s[0].value&&s[0].value.transforms?u=>`${generateGlsl$1(s[0].value.transforms,t)(u)}`:s[0].isUniform?()=>s[0].name:()=>s[0].value;n=u=>`${shaderString(`${o(u)}, ${h(u)}`,r.name,s.slice(1),t)}`}else if(r.transform.type==="combineCoord"){var h=s[0].value&&s[0].value.transforms?f=>`${generateGlsl$1(s[0].value.transforms,t)(f)}`:s[0].isUniform?()=>s[0].name:()=>s[0].value;n=f=>`${o(`${shaderString(`${f}, ${h(f)}`,r.name,s.slice(1),t)}`)}`}}),n}function shaderString(e,t,n,r){const s=n.map(o=>o.isUniform?o.name:o.value&&o.value.transforms?`${generateGlsl$1(o.value.transforms,r)("st")}`:o.value).reduce((o,h)=>`${o}, ${h}`,"");return`${t}(${e}${s})`}function contains(e,t){for(var n=0;n<t.length;n++)if(e.name==t[n].name)return!0;return!1}const utilityGlsl={_luminance:{type:"util",glsl:`float _luminance(vec3 rgb){
      const vec3 W = vec3(0.2125, 0.7154, 0.0721);
      return dot(rgb, W);
    }`},_noise:{type:"util",glsl:`
    //	Simplex 3D Noise
    //	by Ian McEwan, Ashima Arts
    vec4 permute(vec4 x){return mod(((x*34.0)+1.0)*x, 289.0);}
  vec4 taylorInvSqrt(vec4 r){return 1.79284291400159 - 0.85373472095314 * r;}

  float _noise(vec3 v){
    const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;
    const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);

  // First corner
    vec3 i  = floor(v + dot(v, C.yyy) );
    vec3 x0 =   v - i + dot(i, C.xxx) ;

  // Other corners
    vec3 g = step(x0.yzx, x0.xyz);
    vec3 l = 1.0 - g;
    vec3 i1 = min( g.xyz, l.zxy );
    vec3 i2 = max( g.xyz, l.zxy );

    //  x0 = x0 - 0. + 0.0 * C
    vec3 x1 = x0 - i1 + 1.0 * C.xxx;
    vec3 x2 = x0 - i2 + 2.0 * C.xxx;
    vec3 x3 = x0 - 1. + 3.0 * C.xxx;

  // Permutations
    i = mod(i, 289.0 );
    vec4 p = permute( permute( permute(
               i.z + vec4(0.0, i1.z, i2.z, 1.0 ))
             + i.y + vec4(0.0, i1.y, i2.y, 1.0 ))
             + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));

  // Gradients
  // ( N*N points uniformly over a square, mapped onto an octahedron.)
    float n_ = 1.0/7.0; // N=7
    vec3  ns = n_ * D.wyz - D.xzx;

    vec4 j = p - 49.0 * floor(p * ns.z *ns.z);  //  mod(p,N*N)

    vec4 x_ = floor(j * ns.z);
    vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)

    vec4 x = x_ *ns.x + ns.yyyy;
    vec4 y = y_ *ns.x + ns.yyyy;
    vec4 h = 1.0 - abs(x) - abs(y);

    vec4 b0 = vec4( x.xy, y.xy );
    vec4 b1 = vec4( x.zw, y.zw );

    vec4 s0 = floor(b0)*2.0 + 1.0;
    vec4 s1 = floor(b1)*2.0 + 1.0;
    vec4 sh = -step(h, vec4(0.0));

    vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;
    vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;

    vec3 p0 = vec3(a0.xy,h.x);
    vec3 p1 = vec3(a0.zw,h.y);
    vec3 p2 = vec3(a1.xy,h.z);
    vec3 p3 = vec3(a1.zw,h.w);

  //Normalise gradients
    vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));
    p0 *= norm.x;
    p1 *= norm.y;
    p2 *= norm.z;
    p3 *= norm.w;

  // Mix final noise value
    vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);
    m = m * m;
    return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1),
                                  dot(p2,x2), dot(p3,x3) ) );
  }
    `},_rgbToHsv:{type:"util",glsl:`vec3 _rgbToHsv(vec3 c){
            vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
            vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));
            vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));

            float d = q.x - min(q.w, q.y);
            float e = 1.0e-10;
            return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);
        }`},_hsvToRgb:{type:"util",glsl:`vec3 _hsvToRgb(vec3 c){
        vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
        vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
        return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
    }`}};var GlslSource=function(e){return this.transforms=[],this.transforms.push(e),this.defaultOutput=e.defaultOutput,this.synth=e.synth,this.type="GlslSource",this.defaultUniforms=e.defaultUniforms,this};GlslSource.prototype.addTransform=function(e){this.transforms.push(e)};GlslSource.prototype.out=function(e){var t=e||this.defaultOutput,n=this.glsl(t);if(this.synth.currentFunctions=[],t)try{t.render(n)}catch(r){console.log("shader could not compile",r)}};GlslSource.prototype.glsl=function(){var e=[],t=[];return this.transforms.forEach(n=>{n.transform.type==="renderpass"?console.warn("no support for renderpass"):t.push(n)}),t.length>0&&e.push(this.compile(t)),e};GlslSource.prototype.compile=function(e){var t=generateGlsl(e,this.synth),n={};t.uniforms.forEach(s=>{n[s.name]=s.value});var r=`
  precision ${this.defaultOutput.precision} float;
  ${Object.values(t.uniforms).map(s=>{let o=s.type;switch(s.type){case"texture":o="sampler2D";break}return`
      uniform ${o} ${s.name};`}).join("")}
  uniform float time;
  uniform vec2 resolution;
  varying vec2 uv;
  uniform sampler2D prevBuffer;

  ${Object.values(utilityGlsl).map(s=>`
            ${s.glsl}
          `).join("")}

  ${t.glslFunctions.map(s=>`
            ${s.transform.glsl}
          `).join("")}

  void main () {
    vec4 c = vec4(1, 0, 0, 1);
    vec2 st = gl_FragCoord.xy/resolution.xy;
    gl_FragColor = ${t.fragColor};
  }
  `;return{frag:r,uniforms:Object.assign({},this.defaultUniforms,n)}};const glslFunctions=()=>[{name:"noise",type:"src",inputs:[{type:"float",name:"scale",default:10},{type:"float",name:"offset",default:.1}],glsl:"   return vec4(vec3(_noise(vec3(_st*scale, offset*time))), 1.0);"},{name:"voronoi",type:"src",inputs:[{type:"float",name:"scale",default:5},{type:"float",name:"speed",default:.3},{type:"float",name:"blending",default:.3}],glsl:`   vec3 color = vec3(.0);
   // Scale
   _st *= scale;
   // Tile the space
   vec2 i_st = floor(_st);
   vec2 f_st = fract(_st);
   float m_dist = 10.;  // minimun distance
   vec2 m_point;        // minimum point
   for (int j=-1; j<=1; j++ ) {
   for (int i=-1; i<=1; i++ ) {
   vec2 neighbor = vec2(float(i),float(j));
   vec2 p = i_st + neighbor;
   vec2 point = fract(sin(vec2(dot(p,vec2(127.1,311.7)),dot(p,vec2(269.5,183.3))))*43758.5453);
   point = 0.5 + 0.5*sin(time*speed + 6.2831*point);
   vec2 diff = neighbor + point - f_st;
   float dist = length(diff);
   if( dist < m_dist ) {
   m_dist = dist;
   m_point = point;
   }
   }
   }
   // Assign a color using the closest point position
   color += dot(m_point,vec2(.3,.6));
   color *= 1.0 - blending*m_dist;
   return vec4(color, 1.0);`},{name:"osc",type:"src",inputs:[{type:"float",name:"frequency",default:60},{type:"float",name:"sync",default:.1},{type:"float",name:"offset",default:0}],glsl:`   vec2 st = _st;
   float r = sin((st.x-offset/frequency+time*sync)*frequency)*0.5  + 0.5;
   float g = sin((st.x+time*sync)*frequency)*0.5 + 0.5;
   float b = sin((st.x+offset/frequency+time*sync)*frequency)*0.5  + 0.5;
   return vec4(r, g, b, 1.0);`},{name:"shape",type:"src",inputs:[{type:"float",name:"sides",default:3},{type:"float",name:"radius",default:.3},{type:"float",name:"smoothing",default:.01}],glsl:`   vec2 st = _st * 2. - 1.;
   // Angle and radius from the current pixel
   float a = atan(st.x,st.y)+3.1416;
   float r = (2.*3.1416)/sides;
   float d = cos(floor(.5+a/r)*r-a)*length(st);
   return vec4(vec3(1.0-smoothstep(radius,radius + smoothing + 0.0000001,d)), 1.0);`},{name:"gradient",type:"src",inputs:[{type:"float",name:"speed",default:0}],glsl:"   return vec4(_st, sin(time*speed), 1.0);"},{name:"src",type:"src",inputs:[{type:"sampler2D",name:"tex",default:NaN}],glsl:`   //  vec2 uv = gl_FragCoord.xy/vec2(1280., 720.);
   return texture2D(tex, fract(_st));`},{name:"solid",type:"src",inputs:[{type:"float",name:"r",default:0},{type:"float",name:"g",default:0},{type:"float",name:"b",default:0},{type:"float",name:"a",default:1}],glsl:"   return vec4(r, g, b, a);"},{name:"rotate",type:"coord",inputs:[{type:"float",name:"angle",default:10},{type:"float",name:"speed",default:0}],glsl:`   vec2 xy = _st - vec2(0.5);
   float ang = angle + speed *time;
   xy = mat2(cos(ang),-sin(ang), sin(ang),cos(ang))*xy;
   xy += 0.5;
   return xy;`},{name:"scale",type:"coord",inputs:[{type:"float",name:"amount",default:1.5},{type:"float",name:"xMult",default:1},{type:"float",name:"yMult",default:1},{type:"float",name:"offsetX",default:.5},{type:"float",name:"offsetY",default:.5}],glsl:`   vec2 xy = _st - vec2(offsetX, offsetY);
   xy*=(1.0/vec2(amount*xMult, amount*yMult));
   xy+=vec2(offsetX, offsetY);
   return xy;
   `},{name:"pixelate",type:"coord",inputs:[{type:"float",name:"pixelX",default:20},{type:"float",name:"pixelY",default:20}],glsl:`   vec2 xy = vec2(pixelX, pixelY);
   return (floor(_st * xy) + 0.5)/xy;`},{name:"posterize",type:"color",inputs:[{type:"float",name:"bins",default:3},{type:"float",name:"gamma",default:.6}],glsl:`   vec4 c2 = pow(_c0, vec4(gamma));
   c2 *= vec4(bins);
   c2 = floor(c2);
   c2/= vec4(bins);
   c2 = pow(c2, vec4(1.0/gamma));
   return vec4(c2.xyz, _c0.a);`},{name:"shift",type:"color",inputs:[{type:"float",name:"r",default:.5},{type:"float",name:"g",default:0},{type:"float",name:"b",default:0},{type:"float",name:"a",default:0}],glsl:`   vec4 c2 = vec4(_c0);
   c2.r = fract(c2.r + r);
   c2.g = fract(c2.g + g);
   c2.b = fract(c2.b + b);
   c2.a = fract(c2.a + a);
   return vec4(c2.rgba);`},{name:"repeat",type:"coord",inputs:[{type:"float",name:"repeatX",default:3},{type:"float",name:"repeatY",default:3},{type:"float",name:"offsetX",default:0},{type:"float",name:"offsetY",default:0}],glsl:`   vec2 st = _st * vec2(repeatX, repeatY);
   st.x += step(1., mod(st.y,2.0)) * offsetX;
   st.y += step(1., mod(st.x,2.0)) * offsetY;
   return fract(st);`},{name:"modulateRepeat",type:"combineCoord",inputs:[{type:"float",name:"repeatX",default:3},{type:"float",name:"repeatY",default:3},{type:"float",name:"offsetX",default:.5},{type:"float",name:"offsetY",default:.5}],glsl:`   vec2 st = _st * vec2(repeatX, repeatY);
   st.x += step(1., mod(st.y,2.0)) + _c0.r * offsetX;
   st.y += step(1., mod(st.x,2.0)) + _c0.g * offsetY;
   return fract(st);`},{name:"repeatX",type:"coord",inputs:[{type:"float",name:"reps",default:3},{type:"float",name:"offset",default:0}],glsl:`   vec2 st = _st * vec2(reps, 1.0);
   //  float f =  mod(_st.y,2.0);
   st.y += step(1., mod(st.x,2.0))* offset;
   return fract(st);`},{name:"modulateRepeatX",type:"combineCoord",inputs:[{type:"float",name:"reps",default:3},{type:"float",name:"offset",default:.5}],glsl:`   vec2 st = _st * vec2(reps, 1.0);
   //  float f =  mod(_st.y,2.0);
   st.y += step(1., mod(st.x,2.0)) + _c0.r * offset;
   return fract(st);`},{name:"repeatY",type:"coord",inputs:[{type:"float",name:"reps",default:3},{type:"float",name:"offset",default:0}],glsl:`   vec2 st = _st * vec2(1.0, reps);
   //  float f =  mod(_st.y,2.0);
   st.x += step(1., mod(st.y,2.0))* offset;
   return fract(st);`},{name:"modulateRepeatY",type:"combineCoord",inputs:[{type:"float",name:"reps",default:3},{type:"float",name:"offset",default:.5}],glsl:`   vec2 st = _st * vec2(reps, 1.0);
   //  float f =  mod(_st.y,2.0);
   st.x += step(1., mod(st.y,2.0)) + _c0.r * offset;
   return fract(st);`},{name:"kaleid",type:"coord",inputs:[{type:"float",name:"nSides",default:4}],glsl:`   vec2 st = _st;
   st -= 0.5;
   float r = length(st);
   float a = atan(st.y, st.x);
   float pi = 2.*3.1416;
   a = mod(a,pi/nSides);
   a = abs(a-pi/nSides/2.);
   return r*vec2(cos(a), sin(a));`},{name:"modulateKaleid",type:"combineCoord",inputs:[{type:"float",name:"nSides",default:4}],glsl:`   vec2 st = _st - 0.5;
   float r = length(st);
   float a = atan(st.y, st.x);
   float pi = 2.*3.1416;
   a = mod(a,pi/nSides);
   a = abs(a-pi/nSides/2.);
   return (_c0.r+r)*vec2(cos(a), sin(a));`},{name:"scroll",type:"coord",inputs:[{type:"float",name:"scrollX",default:.5},{type:"float",name:"scrollY",default:.5},{type:"float",name:"speedX",default:0},{type:"float",name:"speedY",default:0}],glsl:`
   _st.x += scrollX + time*speedX;
   _st.y += scrollY + time*speedY;
   return fract(_st);`},{name:"scrollX",type:"coord",inputs:[{type:"float",name:"scrollX",default:.5},{type:"float",name:"speed",default:0}],glsl:`   _st.x += scrollX + time*speed;
   return fract(_st);`},{name:"modulateScrollX",type:"combineCoord",inputs:[{type:"float",name:"scrollX",default:.5},{type:"float",name:"speed",default:0}],glsl:`   _st.x += _c0.r*scrollX + time*speed;
   return fract(_st);`},{name:"scrollY",type:"coord",inputs:[{type:"float",name:"scrollY",default:.5},{type:"float",name:"speed",default:0}],glsl:`   _st.y += scrollY + time*speed;
   return fract(_st);`},{name:"modulateScrollY",type:"combineCoord",inputs:[{type:"float",name:"scrollY",default:.5},{type:"float",name:"speed",default:0}],glsl:`   _st.y += _c0.r*scrollY + time*speed;
   return fract(_st);`},{name:"add",type:"combine",inputs:[{type:"float",name:"amount",default:1}],glsl:"   return (_c0+_c1)*amount + _c0*(1.0-amount);"},{name:"sub",type:"combine",inputs:[{type:"float",name:"amount",default:1}],glsl:"   return (_c0-_c1)*amount + _c0*(1.0-amount);"},{name:"layer",type:"combine",inputs:[],glsl:"   return vec4(mix(_c0.rgb, _c1.rgb, _c1.a), clamp(_c0.a + _c1.a, 0.0, 1.0));"},{name:"blend",type:"combine",inputs:[{type:"float",name:"amount",default:.5}],glsl:"   return _c0*(1.0-amount)+_c1*amount;"},{name:"mult",type:"combine",inputs:[{type:"float",name:"amount",default:1}],glsl:"   return _c0*(1.0-amount)+(_c0*_c1)*amount;"},{name:"diff",type:"combine",inputs:[],glsl:"   return vec4(abs(_c0.rgb-_c1.rgb), max(_c0.a, _c1.a));"},{name:"modulate",type:"combineCoord",inputs:[{type:"float",name:"amount",default:.1}],glsl:`   //  return fract(st+(_c0.xy-0.5)*amount);
   return _st + _c0.xy*amount;`},{name:"modulateScale",type:"combineCoord",inputs:[{type:"float",name:"multiple",default:1},{type:"float",name:"offset",default:1}],glsl:`   vec2 xy = _st - vec2(0.5);
   xy*=(1.0/vec2(offset + multiple*_c0.r, offset + multiple*_c0.g));
   xy+=vec2(0.5);
   return xy;`},{name:"modulatePixelate",type:"combineCoord",inputs:[{type:"float",name:"multiple",default:10},{type:"float",name:"offset",default:3}],glsl:`   vec2 xy = vec2(offset + _c0.x*multiple, offset + _c0.y*multiple);
   return (floor(_st * xy) + 0.5)/xy;`},{name:"modulateRotate",type:"combineCoord",inputs:[{type:"float",name:"multiple",default:1},{type:"float",name:"offset",default:0}],glsl:`   vec2 xy = _st - vec2(0.5);
   float angle = offset + _c0.x * multiple;
   xy = mat2(cos(angle),-sin(angle), sin(angle),cos(angle))*xy;
   xy += 0.5;
   return xy;`},{name:"modulateHue",type:"combineCoord",inputs:[{type:"float",name:"amount",default:1}],glsl:"   return _st + (vec2(_c0.g - _c0.r, _c0.b - _c0.g) * amount * 1.0/resolution);"},{name:"invert",type:"color",inputs:[{type:"float",name:"amount",default:1}],glsl:"   return vec4((1.0-_c0.rgb)*amount + _c0.rgb*(1.0-amount), _c0.a);"},{name:"contrast",type:"color",inputs:[{type:"float",name:"amount",default:1.6}],glsl:`   vec4 c = (_c0-vec4(0.5))*vec4(amount) + vec4(0.5);
   return vec4(c.rgb, _c0.a);`},{name:"brightness",type:"color",inputs:[{type:"float",name:"amount",default:.4}],glsl:"   return vec4(_c0.rgb + vec3(amount), _c0.a);"},{name:"mask",type:"combine",inputs:[],glsl:`   float a = _luminance(_c1.rgb);
  return vec4(_c0.rgb*a, a*_c0.a);`},{name:"luma",type:"color",inputs:[{type:"float",name:"threshold",default:.5},{type:"float",name:"tolerance",default:.1}],glsl:`   float a = smoothstep(threshold-(tolerance+0.0000001), threshold+(tolerance+0.0000001), _luminance(_c0.rgb));
   return vec4(_c0.rgb*a, a);`},{name:"thresh",type:"color",inputs:[{type:"float",name:"threshold",default:.5},{type:"float",name:"tolerance",default:.04}],glsl:"   return vec4(vec3(smoothstep(threshold-(tolerance+0.0000001), threshold+(tolerance+0.0000001), _luminance(_c0.rgb))), _c0.a);"},{name:"color",type:"color",inputs:[{type:"float",name:"r",default:1},{type:"float",name:"g",default:1},{type:"float",name:"b",default:1},{type:"float",name:"a",default:1}],glsl:`   vec4 c = vec4(r, g, b, a);
   vec4 pos = step(0.0, c); // detect whether negative
   // if > 0, return r * _c0
   // if < 0 return (1.0-r) * _c0
   return vec4(mix((1.0-_c0)*abs(c), c*_c0, pos));`},{name:"saturate",type:"color",inputs:[{type:"float",name:"amount",default:2}],glsl:`   const vec3 W = vec3(0.2125, 0.7154, 0.0721);
   vec3 intensity = vec3(dot(_c0.rgb, W));
   return vec4(mix(intensity, _c0.rgb, amount), _c0.a);`},{name:"hue",type:"color",inputs:[{type:"float",name:"hue",default:.4}],glsl:`   vec3 c = _rgbToHsv(_c0.rgb);
   c.r += hue;
   //  c.r = fract(c.r);
   return vec4(_hsvToRgb(c), _c0.a);`},{name:"colorama",type:"color",inputs:[{type:"float",name:"amount",default:.005}],glsl:`   vec3 c = _rgbToHsv(_c0.rgb);
   c += vec3(amount);
   c = _hsvToRgb(c);
   c = fract(c);
   return vec4(c, _c0.a);`},{name:"prev",type:"src",inputs:[],glsl:"   return texture2D(prevBuffer, fract(_st));"},{name:"sum",type:"color",inputs:[{type:"vec4",name:"scale",default:1}],glsl:`   vec4 v = _c0 * s;
   return v.r + v.g + v.b + v.a;
   }
   float sum(vec2 _st, vec4 s) { // vec4 is not a typo, because argument type is not overloaded
   vec2 v = _st.xy * s.xy;
   return v.x + v.y;`},{name:"r",type:"color",inputs:[{type:"float",name:"scale",default:1},{type:"float",name:"offset",default:0}],glsl:"   return vec4(_c0.r * scale + offset);"},{name:"g",type:"color",inputs:[{type:"float",name:"scale",default:1},{type:"float",name:"offset",default:0}],glsl:"   return vec4(_c0.g * scale + offset);"},{name:"b",type:"color",inputs:[{type:"float",name:"scale",default:1},{type:"float",name:"offset",default:0}],glsl:"   return vec4(_c0.b * scale + offset);"},{name:"a",type:"color",inputs:[{type:"float",name:"scale",default:1},{type:"float",name:"offset",default:0}],glsl:"   return vec4(_c0.a * scale + offset);"}];class GeneratorFactory{constructor({defaultUniforms:t,defaultOutput:n,extendTransforms:r=[],changeListener:s=()=>{}}={}){this.defaultOutput=n,this.defaultUniforms=t,this.changeListener=s,this.extendTransforms=r,this.generators={},this.init()}init(){const t=glslFunctions();return this.glslTransforms={},this.generators=Object.entries(this.generators).reduce((n,[r,s])=>(this.changeListener({type:"remove",synth:this,method:r}),n),{}),this.sourceClass=class extends GlslSource{},Array.isArray(this.extendTransforms)?t.concat(this.extendTransforms):typeof this.extendTransforms=="object"&&this.extendTransforms.type&&t.push(this.extendTransforms),t.map(n=>this.setFunction(n))}_addMethod(t,n){const r=this;if(this.glslTransforms[t]=n,n.type==="src"){const s=(...o)=>new this.sourceClass({name:t,transform:n,userArgs:o,defaultOutput:this.defaultOutput,defaultUniforms:this.defaultUniforms,synth:r});return this.generators[t]=s,this.changeListener({type:"add",synth:this,method:t}),s}else this.sourceClass.prototype[t]=function(...s){return this.transforms.push({name:t,transform:n,userArgs:s,synth:r}),this}}setFunction(t){var n=processGlsl(t);n&&this._addMethod(t.name,n)}}const typeLookup={src:{returnType:"vec4",args:["vec2 _st"]},coord:{returnType:"vec2",args:["vec2 _st"]},color:{returnType:"vec4",args:["vec4 _c0"]},combine:{returnType:"vec4",args:["vec4 _c0","vec4 _c1"]},combineCoord:{returnType:"vec2",args:["vec2 _st","vec4 _c0"]}};function processGlsl(e){let t=typeLookup[e.type];if(t){let n=t.args.map(h=>h).join(", "),r=e.inputs.map(h=>`${h.type} ${h.name}`).join(", "),s=`${n}${r.length>0?", "+r:""}`,o=`
  ${t.returnType} ${e.name}(${s}) {
      ${e.glsl}
  }
`;return(e.type==="combine"||e.type==="combineCoord")&&e.inputs.unshift({name:"color",type:"vec4"}),Object.assign({},e,{glsl:o})}else console.warn(`type ${e.type} not recognized`,e)}var regl$1={exports:{}};(function(e,t){(function(n,r){e.exports=r()})(commonjsGlobal,function(){var n=function(g){return g instanceof Uint8Array||g instanceof Uint16Array||g instanceof Uint32Array||g instanceof Int8Array||g instanceof Int16Array||g instanceof Int32Array||g instanceof Float32Array||g instanceof Float64Array||g instanceof Uint8ClampedArray},r=function(g,B){for(var K=Object.keys(B),dt=0;dt<K.length;++dt)g[K[dt]]=B[K[dt]];return g},s=`
`;function o(g){return typeof atob<"u"?atob(g):"base64:"+g}function h(g){var B=new Error("(regl) "+g);throw console.error(B),B}function u(g,B){g||h(B)}function f(g){return g?": "+g:""}function c(g,B,K){g in B||h("unknown parameter ("+g+")"+f(K)+". possible values: "+Object.keys(B).join())}function _(g,B){n(g)||h("invalid parameter type"+f(B)+". must be a typed array")}function O(g,B){switch(B){case"number":return typeof g=="number";case"object":return typeof g=="object";case"string":return typeof g=="string";case"boolean":return typeof g=="boolean";case"function":return typeof g=="function";case"undefined":return typeof g>"u";case"symbol":return typeof g=="symbol"}}function d(g,B,K){O(g,B)||h("invalid parameter type"+f(K)+". expected "+B+", got "+typeof g)}function b(g,B){g>=0&&(g|0)===g||h("invalid parameter type, ("+g+")"+f(B)+". must be a nonnegative integer")}function S(g,B,K){B.indexOf(g)<0&&h("invalid value"+f(K)+". must be one of: "+B)}var G=["gl","canvas","container","attributes","pixelRatio","extensions","optionalExtensions","profile","onDone"];function z(g){Object.keys(g).forEach(function(B){G.indexOf(B)<0&&h('invalid regl constructor argument "'+B+'". must be one of '+G)})}function $(g,B){for(g=g+"";g.length<B;)g=" "+g;return g}function A(){this.name="unknown",this.lines=[],this.index={},this.hasErrors=!1}function l(g,B){this.number=g,this.line=B,this.errors=[]}function I(g,B,K){this.file=g,this.line=B,this.message=K}function T(){var g=new Error,B=(g.stack||g).toString(),K=/compileProcedure.*\n\s*at.*\((.*)\)/.exec(B);if(K)return K[1];var dt=/compileProcedure.*\n\s*at\s+(.*)(\n|$)/.exec(B);return dt?dt[1]:"unknown"}function L(){var g=new Error,B=(g.stack||g).toString(),K=/at REGLCommand.*\n\s+at.*\((.*)\)/.exec(B);if(K)return K[1];var dt=/at REGLCommand.*\n\s+at\s+(.*)\n/.exec(B);return dt?dt[1]:"unknown"}function C(g,B){var K=g.split(`
`),dt=1,Lt=0,ft={unknown:new A,0:new A};ft.unknown.name=ft[0].name=B||T(),ft.unknown.lines.push(new l(0,""));for(var bt=0;bt<K.length;++bt){var It=K[bt],Nt=/^\s*#\s*(\w+)\s+(.+)\s*$/.exec(It);if(Nt)switch(Nt[1]){case"line":var Ft=/(\d+)(\s+\d+)?/.exec(Nt[2]);Ft&&(dt=Ft[1]|0,Ft[2]&&(Lt=Ft[2]|0,Lt in ft||(ft[Lt]=new A)));break;case"define":var Rt=/SHADER_NAME(_B64)?\s+(.*)$/.exec(Nt[2]);Rt&&(ft[Lt].name=Rt[1]?o(Rt[2]):Rt[2]);break}ft[Lt].lines.push(new l(dt++,It))}return Object.keys(ft).forEach(function(zt){var Xt=ft[zt];Xt.lines.forEach(function(Dt){Xt.index[Dt.number]=Dt})}),ft}function N(g){var B=[];return g.split(`
`).forEach(function(K){if(!(K.length<5)){var dt=/^ERROR:\s+(\d+):(\d+):\s*(.*)$/.exec(K);dt?B.push(new I(dt[1]|0,dt[2]|0,dt[3].trim())):K.length>0&&B.push(new I("unknown",0,K))}}),B}function R(g,B){B.forEach(function(K){var dt=g[K.file];if(dt){var Lt=dt.index[K.line];if(Lt){Lt.errors.push(K),dt.hasErrors=!0;return}}g.unknown.hasErrors=!0,g.unknown.lines[0].errors.push(K)})}function Y(g,B,K,dt,Lt){if(!g.getShaderParameter(B,g.COMPILE_STATUS)){var ft=g.getShaderInfoLog(B),bt=dt===g.FRAGMENT_SHADER?"fragment":"vertex";Q(K,"string",bt+" shader source must be a string",Lt);var It=C(K,Lt),Nt=N(ft);R(It,Nt),Object.keys(It).forEach(function(Ft){var Rt=It[Ft];if(!Rt.hasErrors)return;var zt=[""],Xt=[""];function Dt(Ut,ht){zt.push(Ut),Xt.push(ht||"")}Dt("file number "+Ft+": "+Rt.name+`
`,"color:red;text-decoration:underline;font-weight:bold"),Rt.lines.forEach(function(Ut){if(Ut.errors.length>0){Dt($(Ut.number,4)+"|  ","background-color:yellow; font-weight:bold"),Dt(Ut.line+s,"color:red; background-color:yellow; font-weight:bold");var ht=0;Ut.errors.forEach(function(xt){var Mt=xt.message,jt=/^\s*'(.*)'\s*:\s*(.*)$/.exec(Mt);if(jt){var At=jt[1];switch(Mt=jt[2],At){case"assign":At="=";break}ht=Math.max(Ut.line.indexOf(At,ht),0)}else ht=0;Dt($("| ",6)),Dt($("^^^",ht+3)+s,"font-weight:bold"),Dt($("| ",6)),Dt(Mt+s,"font-weight:bold")}),Dt($("| ",6)+s)}else Dt($(Ut.number,4)+"|  "),Dt(Ut.line+s,"color:red")}),typeof document<"u"&&!window.chrome?(Xt[0]=zt.join("%c"),console.log.apply(console,Xt)):console.log(zt.join(""))}),u.raise("Error compiling "+bt+" shader, "+It[0].name)}}function ut(g,B,K,dt,Lt){if(!g.getProgramParameter(B,g.LINK_STATUS)){var ft=g.getProgramInfoLog(B),bt=C(K,Lt),It=C(dt,Lt),Nt='Error linking program with vertex shader, "'+It[0].name+'", and fragment shader "'+bt[0].name+'"';typeof document<"u"?console.log("%c"+Nt+s+"%c"+ft,"color:red;text-decoration:underline;font-weight:bold","color:red"):console.log(Nt+s+ft),u.raise(Nt)}}function mt(g){g._commandRef=T()}function yt(g,B,K,dt){mt(g);function Lt(Nt){return Nt?dt.id(Nt):0}g._fragId=Lt(g.static.frag),g._vertId=Lt(g.static.vert);function ft(Nt,Ft){Object.keys(Ft).forEach(function(Rt){Nt[dt.id(Rt)]=!0})}var bt=g._uniformSet={};ft(bt,B.static),ft(bt,B.dynamic);var It=g._attributeSet={};ft(It,K.static),ft(It,K.dynamic),g._hasCount="count"in g.static||"count"in g.dynamic||"elements"in g.static||"elements"in g.dynamic}function D(g,B){var K=L();h(g+" in command "+(B||T())+(K==="unknown"?"":" called from "+K))}function F(g,B,K){g||D(B,K||T())}function E(g,B,K,dt){g in B||D("unknown parameter ("+g+")"+f(K)+". possible values: "+Object.keys(B).join(),dt||T())}function Q(g,B,K,dt){O(g,B)||D("invalid parameter type"+f(K)+". expected "+B+", got "+typeof g,dt||T())}function P(g){g()}function H(g,B,K){g.texture?S(g.texture._texture.internalformat,B,"unsupported texture format for attachment"):S(g.renderbuffer._renderbuffer.format,K,"unsupported renderbuffer format for attachment")}var q=33071,st=9728,vt=9984,kt=9985,Yt=9986,te=9987,re=5120,m=5121,M=5122,Z=5123,it=5124,gt=5125,Tt=5126,qt=32819,$t=32820,le=33635,ye=34042,ce=36193,Te={};Te[re]=Te[m]=1,Te[M]=Te[Z]=Te[ce]=Te[le]=Te[qt]=Te[$t]=2,Te[it]=Te[gt]=Te[Tt]=Te[ye]=4;function Be(g,B){return g===$t||g===qt||g===le?2:g===ye?4:Te[g]*B}function dr(g){return!(g&g-1)&&!!g}function He(g,B,K){var dt,Lt=B.width,ft=B.height,bt=B.channels;u(Lt>0&&Lt<=K.maxTextureSize&&ft>0&&ft<=K.maxTextureSize,"invalid texture shape"),(g.wrapS!==q||g.wrapT!==q)&&u(dr(Lt)&&dr(ft),"incompatible wrap mode for texture, both width and height must be power of 2"),B.mipmask===1?Lt!==1&&ft!==1&&u(g.minFilter!==vt&&g.minFilter!==Yt&&g.minFilter!==kt&&g.minFilter!==te,"min filter requires mipmap"):(u(dr(Lt)&&dr(ft),"texture must be a square power of 2 to support mipmapping"),u(B.mipmask===(Lt<<1)-1,"missing or incomplete mipmap data")),B.type===Tt&&(K.extensions.indexOf("oes_texture_float_linear")<0&&u(g.minFilter===st&&g.magFilter===st,"filter not supported, must enable oes_texture_float_linear"),u(!g.genMipmaps,"mipmap generation not supported with float textures"));var It=B.images;for(dt=0;dt<16;++dt)if(It[dt]){var Nt=Lt>>dt,Ft=ft>>dt;u(B.mipmask&1<<dt,"missing mipmap data");var Rt=It[dt];if(u(Rt.width===Nt&&Rt.height===Ft,"invalid shape for mip images"),u(Rt.format===B.format&&Rt.internalformat===B.internalformat&&Rt.type===B.type,"incompatible type for mip image"),!Rt.compressed)if(Rt.data){var zt=Math.ceil(Be(Rt.type,bt)*Nt/Rt.unpackAlignment)*Rt.unpackAlignment;u(Rt.data.byteLength===zt*Ft,"invalid data for image, buffer size is inconsistent with image format")}else Rt.element||Rt.copy}else g.genMipmaps||u((B.mipmask&1<<dt)===0,"extra mipmap data");B.compressed&&u(!g.genMipmaps,"mipmap generation for compressed images not supported")}function ir(g,B,K,dt){var Lt=g.width,ft=g.height,bt=g.channels;u(Lt>0&&Lt<=dt.maxTextureSize&&ft>0&&ft<=dt.maxTextureSize,"invalid texture shape"),u(Lt===ft,"cube map must be square"),u(B.wrapS===q&&B.wrapT===q,"wrap mode not supported by cube map");for(var It=0;It<K.length;++It){var Nt=K[It];u(Nt.width===Lt&&Nt.height===ft,"inconsistent cube map face shape"),B.genMipmaps&&(u(!Nt.compressed,"can not generate mipmap for compressed textures"),u(Nt.mipmask===1,"can not specify mipmaps and generate mipmaps"));for(var Ft=Nt.images,Rt=0;Rt<16;++Rt){var zt=Ft[Rt];if(zt){var Xt=Lt>>Rt,Dt=ft>>Rt;u(Nt.mipmask&1<<Rt,"missing mipmap data"),u(zt.width===Xt&&zt.height===Dt,"invalid shape for mip images"),u(zt.format===g.format&&zt.internalformat===g.internalformat&&zt.type===g.type,"incompatible type for mip image"),zt.compressed||(zt.data?u(zt.data.byteLength===Xt*Dt*Math.max(Be(zt.type,bt),zt.unpackAlignment),"invalid data for image, buffer size is inconsistent with image format"):zt.element||zt.copy)}}}}var V=r(u,{optional:P,raise:h,commandRaise:D,command:F,parameter:c,commandParameter:E,constructor:z,type:d,commandType:Q,isTypedArray:_,nni:b,oneOf:S,shaderError:Y,linkError:ut,callSite:L,saveCommandRef:mt,saveDrawInfo:yt,framebufferFormat:H,guessCommand:T,texture2D:He,textureCube:ir}),Or=0,Mi=0,Ns=5,Rs=6;function vr(g,B){this.id=Or++,this.type=g,this.data=B}function kn(g){return g.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function Xr(g){if(g.length===0)return[];var B=g.charAt(0),K=g.charAt(g.length-1);if(g.length>1&&B===K&&(B==='"'||B==="'"))return['"'+kn(g.substr(1,g.length-2))+'"'];var dt=/\[(false|true|null|\d+|'[^']*'|"[^"]*")\]/.exec(g);if(dt)return Xr(g.substr(0,dt.index)).concat(Xr(dt[1])).concat(Xr(g.substr(dt.index+dt[0].length)));var Lt=g.split(".");if(Lt.length===1)return['"'+kn(g)+'"'];for(var ft=[],bt=0;bt<Lt.length;++bt)ft=ft.concat(Xr(Lt[bt]));return ft}function Pn(g){return"["+Xr(g).join("][")+"]"}function ks(g,B){return new vr(g,Pn(B+""))}function Ps(g){return typeof g=="function"&&!g._reglType||g instanceof vr}function Mn(g,B){if(typeof g=="function")return new vr(Mi,g);if(typeof g=="number"||typeof g=="boolean")return new vr(Ns,g);if(Array.isArray(g))return new vr(Rs,g.map((K,dt)=>Mn(K,B+"["+dt+"]")));if(g instanceof vr)return g;V(!1,"invalid option type in uniform "+B)}var Ke={DynamicVariable:vr,define:ks,isDynamic:Ps,unbox:Mn,accessor:Pn},Fi={next:typeof requestAnimationFrame=="function"?function(g){return requestAnimationFrame(g)}:function(g){return setTimeout(g,16)},cancel:typeof cancelAnimationFrame=="function"?function(g){return cancelAnimationFrame(g)}:clearTimeout},Fn=typeof performance<"u"&&performance.now?function(){return performance.now()}:function(){return+new Date};function Ms(){var g={"":0},B=[""];return{id:function(K){var dt=g[K];return dt||(dt=g[K]=B.length,B.push(K),dt)},str:function(K){return B[K]}}}function Fs(g,B,K){var dt=document.createElement("canvas");r(dt.style,{border:0,margin:0,padding:0,top:0,left:0}),g.appendChild(dt),g===document.body&&(dt.style.position="absolute",r(g.style,{margin:0,padding:0}));function Lt(){var It=window.innerWidth,Nt=window.innerHeight;if(g!==document.body){var Ft=g.getBoundingClientRect();It=Ft.right-Ft.left,Nt=Ft.bottom-Ft.top}dt.width=K*It,dt.height=K*Nt,r(dt.style,{width:It+"px",height:Nt+"px"})}var ft;g!==document.body&&typeof ResizeObserver=="function"?(ft=new ResizeObserver(function(){setTimeout(Lt)}),ft.observe(g)):window.addEventListener("resize",Lt,!1);function bt(){ft?ft.disconnect():window.removeEventListener("resize",Lt),g.removeChild(dt)}return Lt(),{canvas:dt,onDestroy:bt}}function Bs(g,B){function K(dt){try{return g.getContext(dt,B)}catch{return null}}return K("webgl")||K("experimental-webgl")||K("webgl-experimental")}function zs(g){return typeof g.nodeName=="string"&&typeof g.appendChild=="function"&&typeof g.getBoundingClientRect=="function"}function Us(g){return typeof g.drawArrays=="function"||typeof g.drawElements=="function"}function Bn(g){return typeof g=="string"?g.split():(V(Array.isArray(g),"invalid extension array"),g)}function zn(g){return typeof g=="string"?(V(typeof document<"u","not supported outside of DOM"),document.querySelector(g)):g}function Hs(g){var B=g||{},K,dt,Lt,ft,bt={},It=[],Nt=[],Ft=typeof window>"u"?1:window.devicePixelRatio,Rt=!1,zt=function(Ut){Ut&&V.raise(Ut)},Xt=function(){};if(typeof B=="string"?(V(typeof document<"u","selector queries only supported in DOM enviroments"),K=document.querySelector(B),V(K,"invalid query string for element")):typeof B=="object"?zs(B)?K=B:Us(B)?(ft=B,Lt=ft.canvas):(V.constructor(B),"gl"in B?ft=B.gl:"canvas"in B?Lt=zn(B.canvas):"container"in B&&(dt=zn(B.container)),"attributes"in B&&(bt=B.attributes,V.type(bt,"object","invalid context attributes")),"extensions"in B&&(It=Bn(B.extensions)),"optionalExtensions"in B&&(Nt=Bn(B.optionalExtensions)),"onDone"in B&&(V.type(B.onDone,"function","invalid or missing onDone callback"),zt=B.onDone),"profile"in B&&(Rt=!!B.profile),"pixelRatio"in B&&(Ft=+B.pixelRatio,V(Ft>0,"invalid pixel ratio"))):V.raise("invalid arguments to regl"),K&&(K.nodeName.toLowerCase()==="canvas"?Lt=K:dt=K),!ft){if(!Lt){V(typeof document<"u","must manually specify webgl context outside of DOM environments");var Dt=Fs(dt||document.body,zt,Ft);if(!Dt)return null;Lt=Dt.canvas,Xt=Dt.onDestroy}bt.premultipliedAlpha===void 0&&(bt.premultipliedAlpha=!0),ft=Bs(Lt,bt)}return ft?{gl:ft,canvas:Lt,container:dt,extensions:It,optionalExtensions:Nt,pixelRatio:Ft,profile:Rt,onDone:zt,onDestroy:Xt}:(Xt(),zt("webgl not supported, try upgrading your browser or graphics drivers http://get.webgl.org"),null)}function Vs(g,B){var K={};function dt(bt){V.type(bt,"string","extension name must be string");var It=bt.toLowerCase(),Nt;try{Nt=K[It]=g.getExtension(It)}catch{}return!!Nt}for(var Lt=0;Lt<B.extensions.length;++Lt){var ft=B.extensions[Lt];if(!dt(ft))return B.onDestroy(),B.onDone('"'+ft+'" extension is not supported by the current WebGL context, try upgrading your system or a different browser'),null}return B.optionalExtensions.forEach(dt),{extensions:K,restore:function(){Object.keys(K).forEach(function(bt){if(K[bt]&&!dt(bt))throw new Error("(regl): error restoring extension "+bt)})}}}function Ye(g,B){for(var K=Array(g),dt=0;dt<g;++dt)K[dt]=B(dt);return K}var Xs=5120,Ws=5121,qs=5122,js=5123,Ys=5124,$s=5125,Ks=5126;function Qs(g){for(var B=16;B<=1<<28;B*=16)if(g<=B)return B;return 0}function Un(g){var B,K;return B=(g>65535)<<4,g>>>=B,K=(g>255)<<3,g>>>=K,B|=K,K=(g>15)<<2,g>>>=K,B|=K,K=(g>3)<<1,g>>>=K,B|=K,B|g>>1}function Hn(){var g=Ye(8,function(){return[]});function B(ft){var bt=Qs(ft),It=g[Un(bt)>>2];return It.length>0?It.pop():new ArrayBuffer(bt)}function K(ft){g[Un(ft.byteLength)>>2].push(ft)}function dt(ft,bt){var It=null;switch(ft){case Xs:It=new Int8Array(B(bt),0,bt);break;case Ws:It=new Uint8Array(B(bt),0,bt);break;case qs:It=new Int16Array(B(2*bt),0,bt);break;case js:It=new Uint16Array(B(2*bt),0,bt);break;case Ys:It=new Int32Array(B(4*bt),0,bt);break;case $s:It=new Uint32Array(B(4*bt),0,bt);break;case Ks:It=new Float32Array(B(4*bt),0,bt);break;default:return null}return It.length!==bt?It.subarray(0,bt):It}function Lt(ft){K(ft.buffer)}return{alloc:B,free:K,allocType:dt,freeType:Lt}}var De=Hn();De.zero=Hn();var Zs=3408,Js=3410,to=3411,eo=3412,ro=3413,io=3414,no=3415,ao=33901,so=33902,oo=3379,uo=3386,ho=34921,lo=36347,po=36348,co=35661,fo=35660,vo=34930,_o=36349,go=34076,mo=34024,yo=7936,bo=7937,xo=7938,Eo=35724,To=34047,wo=36063,Lo=34852,ui=3553,Vn=34067,So=34069,Oo=33984,Wr=6408,Bi=5126,Xn=5121,zi=36160,Ao=36053,Go=36064,Co=16384,Io=function(g,B){var K=1;B.ext_texture_filter_anisotropic&&(K=g.getParameter(To));var dt=1,Lt=1;B.webgl_draw_buffers&&(dt=g.getParameter(Lo),Lt=g.getParameter(wo));var ft=!!B.oes_texture_float;if(ft){var bt=g.createTexture();g.bindTexture(ui,bt),g.texImage2D(ui,0,Wr,1,1,0,Wr,Bi,null);var It=g.createFramebuffer();if(g.bindFramebuffer(zi,It),g.framebufferTexture2D(zi,Go,ui,bt,0),g.bindTexture(ui,null),g.checkFramebufferStatus(zi)!==Ao)ft=!1;else{g.viewport(0,0,1,1),g.clearColor(1,0,0,1),g.clear(Co);var Nt=De.allocType(Bi,4);g.readPixels(0,0,1,1,Wr,Bi,Nt),g.getError()?ft=!1:(g.deleteFramebuffer(It),g.deleteTexture(bt),ft=Nt[0]===1),De.freeType(Nt)}}var Ft=typeof navigator<"u"&&(/MSIE/.test(navigator.userAgent)||/Trident\//.test(navigator.appVersion)||/Edge/.test(navigator.userAgent)),Rt=!0;if(!Ft){var zt=g.createTexture(),Xt=De.allocType(Xn,36);g.activeTexture(Oo),g.bindTexture(Vn,zt),g.texImage2D(So,0,Wr,3,3,0,Wr,Xn,Xt),De.freeType(Xt),g.bindTexture(Vn,null),g.deleteTexture(zt),Rt=!g.getError()}return{colorBits:[g.getParameter(Js),g.getParameter(to),g.getParameter(eo),g.getParameter(ro)],depthBits:g.getParameter(io),stencilBits:g.getParameter(no),subpixelBits:g.getParameter(Zs),extensions:Object.keys(B).filter(function(Dt){return!!B[Dt]}),maxAnisotropic:K,maxDrawbuffers:dt,maxColorAttachments:Lt,pointSizeDims:g.getParameter(ao),lineWidthDims:g.getParameter(so),maxViewportDims:g.getParameter(uo),maxCombinedTextureUnits:g.getParameter(co),maxCubeMapSize:g.getParameter(go),maxRenderbufferSize:g.getParameter(mo),maxTextureUnits:g.getParameter(vo),maxTextureSize:g.getParameter(oo),maxAttributes:g.getParameter(ho),maxVertexUniforms:g.getParameter(lo),maxVertexTextureUnits:g.getParameter(fo),maxVaryingVectors:g.getParameter(po),maxFragmentUniforms:g.getParameter(_o),glsl:g.getParameter(Eo),renderer:g.getParameter(bo),vendor:g.getParameter(yo),version:g.getParameter(xo),readFloat:ft,npotTextureCube:Rt}};function tr(g){return!!g&&typeof g=="object"&&Array.isArray(g.shape)&&Array.isArray(g.stride)&&typeof g.offset=="number"&&g.shape.length===g.stride.length&&(Array.isArray(g.data)||n(g.data))}var Qe=function(g){return Object.keys(g).map(function(B){return g[B]})},hi={shape:ko,flatten:Ro};function Do(g,B,K){for(var dt=0;dt<B;++dt)K[dt]=g[dt]}function No(g,B,K,dt){for(var Lt=0,ft=0;ft<B;++ft)for(var bt=g[ft],It=0;It<K;++It)dt[Lt++]=bt[It]}function Wn(g,B,K,dt,Lt,ft){for(var bt=ft,It=0;It<B;++It)for(var Nt=g[It],Ft=0;Ft<K;++Ft)for(var Rt=Nt[Ft],zt=0;zt<dt;++zt)Lt[bt++]=Rt[zt]}function qn(g,B,K,dt,Lt){for(var ft=1,bt=K+1;bt<B.length;++bt)ft*=B[bt];var It=B[K];if(B.length-K===4){var Nt=B[K+1],Ft=B[K+2],Rt=B[K+3];for(bt=0;bt<It;++bt)Wn(g[bt],Nt,Ft,Rt,dt,Lt),Lt+=ft}else for(bt=0;bt<It;++bt)qn(g[bt],B,K+1,dt,Lt),Lt+=ft}function Ro(g,B,K,dt){var Lt=1;if(B.length)for(var ft=0;ft<B.length;++ft)Lt*=B[ft];else Lt=0;var bt=dt||De.allocType(K,Lt);switch(B.length){case 0:break;case 1:Do(g,B[0],bt);break;case 2:No(g,B[0],B[1],bt);break;case 3:Wn(g,B[0],B[1],B[2],bt,0);break;default:qn(g,B,0,bt,0)}return bt}function ko(g){for(var B=[],K=g;K.length;K=K[0])B.push(K.length);return B}var Ui={"[object Int8Array]":5120,"[object Int16Array]":5122,"[object Int32Array]":5124,"[object Uint8Array]":5121,"[object Uint8ClampedArray]":5121,"[object Uint16Array]":5123,"[object Uint32Array]":5125,"[object Float32Array]":5126,"[object Float64Array]":5121,"[object ArrayBuffer]":5121},Po=5120,Mo=5122,Fo=5124,Bo=5121,zo=5123,Uo=5125,Ho=5126,Vo=5126,_r={int8:Po,int16:Mo,int32:Fo,uint8:Bo,uint16:zo,uint32:Uo,float:Ho,float32:Vo},Xo=35048,Wo=35040,li={dynamic:Xo,stream:Wo,static:35044},Hi=hi.flatten,jn=hi.shape,Yn=35044,qo=35040,Vi=5121,Xi=5126,hr=[];hr[5120]=1,hr[5122]=2,hr[5124]=4,hr[5121]=1,hr[5123]=2,hr[5125]=4,hr[5126]=4;function pi(g){return Ui[Object.prototype.toString.call(g)]|0}function $n(g,B){for(var K=0;K<B.length;++K)g[K]=B[K]}function Kn(g,B,K,dt,Lt,ft,bt){for(var It=0,Nt=0;Nt<K;++Nt)for(var Ft=0;Ft<dt;++Ft)g[It++]=B[Lt*Nt+ft*Ft+bt]}function jo(g,B,K,dt){var Lt=0,ft={};function bt(ht){this.id=Lt++,this.buffer=g.createBuffer(),this.type=ht,this.usage=Yn,this.byteLength=0,this.dimension=1,this.dtype=Vi,this.persistentData=null,K.profile&&(this.stats={size:0})}bt.prototype.bind=function(){g.bindBuffer(this.type,this.buffer)},bt.prototype.destroy=function(){Xt(this)};var It=[];function Nt(ht,xt){var Mt=It.pop();return Mt||(Mt=new bt(ht)),Mt.bind(),zt(Mt,xt,qo,0,1,!1),Mt}function Ft(ht){It.push(ht)}function Rt(ht,xt,Mt){ht.byteLength=xt.byteLength,g.bufferData(ht.type,xt,Mt)}function zt(ht,xt,Mt,jt,At,Kt){var Ct;if(ht.usage=Mt,Array.isArray(xt)){if(ht.dtype=jt||Xi,xt.length>0){var Ht;if(Array.isArray(xt[0])){Ct=jn(xt);for(var Gt=1,Vt=1;Vt<Ct.length;++Vt)Gt*=Ct[Vt];ht.dimension=Gt,Ht=Hi(xt,Ct,ht.dtype),Rt(ht,Ht,Mt),Kt?ht.persistentData=Ht:De.freeType(Ht)}else if(typeof xt[0]=="number"){ht.dimension=At;var ie=De.allocType(ht.dtype,xt.length);$n(ie,xt),Rt(ht,ie,Mt),Kt?ht.persistentData=ie:De.freeType(ie)}else n(xt[0])?(ht.dimension=xt[0].length,ht.dtype=jt||pi(xt[0])||Xi,Ht=Hi(xt,[xt.length,xt[0].length],ht.dtype),Rt(ht,Ht,Mt),Kt?ht.persistentData=Ht:De.freeType(Ht)):V.raise("invalid buffer data")}}else if(n(xt))ht.dtype=jt||pi(xt),ht.dimension=At,Rt(ht,xt,Mt),Kt&&(ht.persistentData=new Uint8Array(new Uint8Array(xt.buffer)));else if(tr(xt)){Ct=xt.shape;var oe=xt.stride,Wt=xt.offset,Bt=0,Ot=0,se=0,fe=0;Ct.length===1?(Bt=Ct[0],Ot=1,se=oe[0],fe=0):Ct.length===2?(Bt=Ct[0],Ot=Ct[1],se=oe[0],fe=oe[1]):V.raise("invalid shape"),ht.dtype=jt||pi(xt.data)||Xi,ht.dimension=Ot;var Zt=De.allocType(ht.dtype,Bt*Ot);Kn(Zt,xt.data,Bt,Ot,se,fe,Wt),Rt(ht,Zt,Mt),Kt?ht.persistentData=Zt:De.freeType(Zt)}else xt instanceof ArrayBuffer?(ht.dtype=Vi,ht.dimension=At,Rt(ht,xt,Mt),Kt&&(ht.persistentData=new Uint8Array(new Uint8Array(xt)))):V.raise("invalid buffer data")}function Xt(ht){B.bufferCount--,dt(ht);var xt=ht.buffer;V(xt,"buffer must not be deleted already"),g.deleteBuffer(xt),ht.buffer=null,delete ft[ht.id]}function Dt(ht,xt,Mt,jt){B.bufferCount++;var At=new bt(xt);ft[At.id]=At;function Kt(Gt){var Vt=Yn,ie=null,oe=0,Wt=0,Bt=1;return Array.isArray(Gt)||n(Gt)||tr(Gt)||Gt instanceof ArrayBuffer?ie=Gt:typeof Gt=="number"?oe=Gt|0:Gt&&(V.type(Gt,"object","buffer arguments must be an object, a number or an array"),"data"in Gt&&(V(ie===null||Array.isArray(ie)||n(ie)||tr(ie),"invalid data for buffer"),ie=Gt.data),"usage"in Gt&&(V.parameter(Gt.usage,li,"invalid buffer usage"),Vt=li[Gt.usage]),"type"in Gt&&(V.parameter(Gt.type,_r,"invalid buffer type"),Wt=_r[Gt.type]),"dimension"in Gt&&(V.type(Gt.dimension,"number","invalid dimension"),Bt=Gt.dimension|0),"length"in Gt&&(V.nni(oe,"buffer length must be a nonnegative integer"),oe=Gt.length|0)),At.bind(),ie?zt(At,ie,Vt,Wt,Bt,jt):(oe&&g.bufferData(At.type,oe,Vt),At.dtype=Wt||Vi,At.usage=Vt,At.dimension=Bt,At.byteLength=oe),K.profile&&(At.stats.size=At.byteLength*hr[At.dtype]),Kt}function Ct(Gt,Vt){V(Vt+Gt.byteLength<=At.byteLength,"invalid buffer subdata call, buffer is too small.  Can't write data of size "+Gt.byteLength+" starting from offset "+Vt+" to a buffer of size "+At.byteLength),g.bufferSubData(At.type,Vt,Gt)}function Ht(Gt,Vt){var ie=(Vt||0)|0,oe;if(At.bind(),n(Gt)||Gt instanceof ArrayBuffer)Ct(Gt,ie);else if(Array.isArray(Gt)){if(Gt.length>0)if(typeof Gt[0]=="number"){var Wt=De.allocType(At.dtype,Gt.length);$n(Wt,Gt),Ct(Wt,ie),De.freeType(Wt)}else if(Array.isArray(Gt[0])||n(Gt[0])){oe=jn(Gt);var Bt=Hi(Gt,oe,At.dtype);Ct(Bt,ie),De.freeType(Bt)}else V.raise("invalid buffer data")}else if(tr(Gt)){oe=Gt.shape;var Ot=Gt.stride,se=0,fe=0,Zt=0,ge=0;oe.length===1?(se=oe[0],fe=1,Zt=Ot[0],ge=0):oe.length===2?(se=oe[0],fe=oe[1],Zt=Ot[0],ge=Ot[1]):V.raise("invalid shape");var ue=Array.isArray(Gt.data)?At.dtype:pi(Gt.data),_e=De.allocType(ue,se*fe);Kn(_e,Gt.data,se,fe,Zt,ge,Gt.offset),Ct(_e,ie),De.freeType(_e)}else V.raise("invalid data for buffer subdata");return Kt}return Mt||Kt(ht),Kt._reglType="buffer",Kt._buffer=At,Kt.subdata=Ht,K.profile&&(Kt.stats=At.stats),Kt.destroy=function(){Xt(At)},Kt}function Ut(){Qe(ft).forEach(function(ht){ht.buffer=g.createBuffer(),g.bindBuffer(ht.type,ht.buffer),g.bufferData(ht.type,ht.persistentData||ht.byteLength,ht.usage)})}return K.profile&&(B.getTotalBufferSize=function(){var ht=0;return Object.keys(ft).forEach(function(xt){ht+=ft[xt].stats.size}),ht}),{create:Dt,createStream:Nt,destroyStream:Ft,clear:function(){Qe(ft).forEach(Xt),It.forEach(Xt)},getBuffer:function(ht){return ht&&ht._buffer instanceof bt?ht._buffer:null},restore:Ut,_initBuffer:zt}}var Yo=0,$o=0,Ko=1,Qo=1,Zo=4,Jo=4,Ar={points:Yo,point:$o,lines:Ko,line:Qo,triangles:Zo,triangle:Jo,"line loop":2,"line strip":3,"triangle strip":5,"triangle fan":6},tu=0,eu=1,qr=4,ru=5120,Gr=5121,Qn=5122,Cr=5123,Zn=5124,gr=5125,Wi=34963,iu=35040,nu=35044;function au(g,B,K,dt){var Lt={},ft=0,bt={uint8:Gr,uint16:Cr};B.oes_element_index_uint&&(bt.uint32=gr);function It(Ut){this.id=ft++,Lt[this.id]=this,this.buffer=Ut,this.primType=qr,this.vertCount=0,this.type=0}It.prototype.bind=function(){this.buffer.bind()};var Nt=[];function Ft(Ut){var ht=Nt.pop();return ht||(ht=new It(K.create(null,Wi,!0,!1)._buffer)),zt(ht,Ut,iu,-1,-1,0,0),ht}function Rt(Ut){Nt.push(Ut)}function zt(Ut,ht,xt,Mt,jt,At,Kt){Ut.buffer.bind();var Ct;if(ht){var Ht=Kt;!Kt&&(!n(ht)||tr(ht)&&!n(ht.data))&&(Ht=B.oes_element_index_uint?gr:Cr),K._initBuffer(Ut.buffer,ht,xt,Ht,3)}else g.bufferData(Wi,At,xt),Ut.buffer.dtype=Ct||Gr,Ut.buffer.usage=xt,Ut.buffer.dimension=3,Ut.buffer.byteLength=At;if(Ct=Kt,!Kt){switch(Ut.buffer.dtype){case Gr:case ru:Ct=Gr;break;case Cr:case Qn:Ct=Cr;break;case gr:case Zn:Ct=gr;break;default:V.raise("unsupported type for element array")}Ut.buffer.dtype=Ct}Ut.type=Ct,V(Ct!==gr||!!B.oes_element_index_uint,"32 bit element buffers not supported, enable oes_element_index_uint first");var Gt=jt;Gt<0&&(Gt=Ut.buffer.byteLength,Ct===Cr?Gt>>=1:Ct===gr&&(Gt>>=2)),Ut.vertCount=Gt;var Vt=Mt;if(Mt<0){Vt=qr;var ie=Ut.buffer.dimension;ie===1&&(Vt=tu),ie===2&&(Vt=eu),ie===3&&(Vt=qr)}Ut.primType=Vt}function Xt(Ut){dt.elementsCount--,V(Ut.buffer!==null,"must not double destroy elements"),delete Lt[Ut.id],Ut.buffer.destroy(),Ut.buffer=null}function Dt(Ut,ht){var xt=K.create(null,Wi,!0),Mt=new It(xt._buffer);dt.elementsCount++;function jt(At){if(!At)xt(),Mt.primType=qr,Mt.vertCount=0,Mt.type=Gr;else if(typeof At=="number")xt(At),Mt.primType=qr,Mt.vertCount=At|0,Mt.type=Gr;else{var Kt=null,Ct=nu,Ht=-1,Gt=-1,Vt=0,ie=0;Array.isArray(At)||n(At)||tr(At)?Kt=At:(V.type(At,"object","invalid arguments for elements"),"data"in At&&(Kt=At.data,V(Array.isArray(Kt)||n(Kt)||tr(Kt),"invalid data for element buffer")),"usage"in At&&(V.parameter(At.usage,li,"invalid element buffer usage"),Ct=li[At.usage]),"primitive"in At&&(V.parameter(At.primitive,Ar,"invalid element buffer primitive"),Ht=Ar[At.primitive]),"count"in At&&(V(typeof At.count=="number"&&At.count>=0,"invalid vertex count for elements"),Gt=At.count|0),"type"in At&&(V.parameter(At.type,bt,"invalid buffer type"),ie=bt[At.type]),"length"in At?Vt=At.length|0:(Vt=Gt,ie===Cr||ie===Qn?Vt*=2:(ie===gr||ie===Zn)&&(Vt*=4))),zt(Mt,Kt,Ct,Ht,Gt,Vt,ie)}return jt}return jt(Ut),jt._reglType="elements",jt._elements=Mt,jt.subdata=function(At,Kt){return xt.subdata(At,Kt),jt},jt.destroy=function(){Xt(Mt)},jt}return{create:Dt,createStream:Ft,destroyStream:Rt,getElements:function(Ut){return typeof Ut=="function"&&Ut._elements instanceof It?Ut._elements:null},clear:function(){Qe(Lt).forEach(Xt)}}}var Jn=new Float32Array(1),su=new Uint32Array(Jn.buffer),ou=5123;function ta(g){for(var B=De.allocType(ou,g.length),K=0;K<g.length;++K)if(isNaN(g[K]))B[K]=65535;else if(g[K]===1/0)B[K]=31744;else if(g[K]===-1/0)B[K]=64512;else{Jn[0]=g[K];var dt=su[0],Lt=dt>>>31<<15,ft=(dt<<1>>>24)-127,bt=dt>>13&1023;if(ft<-24)B[K]=Lt;else if(ft<-14){var It=-14-ft;B[K]=Lt+(bt+1024>>It)}else ft>15?B[K]=Lt+31744:B[K]=Lt+(ft+15<<10)+bt}return B}function Ge(g){return Array.isArray(g)||n(g)}var ea=function(g){return!(g&g-1)&&!!g},uu=34467,nr=3553,qi=34067,ci=34069,mr=6408,ji=6406,fi=6407,jr=6409,di=6410,ra=32854,Yi=32855,ia=36194,hu=32819,lu=32820,pu=33635,cu=34042,$i=6402,vi=34041,Ki=35904,Qi=35906,Ir=36193,Zi=33776,Ji=33777,tn=33778,en=33779,na=35986,aa=35987,sa=34798,oa=35840,ua=35841,ha=35842,la=35843,pa=36196,Dr=5121,rn=5123,nn=5125,Yr=5126,fu=10242,du=10243,vu=10497,an=33071,_u=33648,gu=10240,mu=10241,sn=9728,yu=9729,on=9984,ca=9985,fa=9986,un=9987,bu=33170,_i=4352,xu=4353,Eu=4354,Tu=34046,wu=3317,Lu=37440,Su=37441,Ou=37443,da=37444,$r=33984,Au=[on,fa,ca,un],gi=[0,jr,di,fi,mr],Ze={};Ze[jr]=Ze[ji]=Ze[$i]=1,Ze[vi]=Ze[di]=2,Ze[fi]=Ze[Ki]=3,Ze[mr]=Ze[Qi]=4;function Nr(g){return"[object "+g+"]"}var va=Nr("HTMLCanvasElement"),_a=Nr("OffscreenCanvas"),ga=Nr("CanvasRenderingContext2D"),ma=Nr("ImageBitmap"),ya=Nr("HTMLImageElement"),ba=Nr("HTMLVideoElement"),Gu=Object.keys(Ui).concat([va,_a,ga,ma,ya,ba]),Rr=[];Rr[Dr]=1,Rr[Yr]=4,Rr[Ir]=2,Rr[rn]=2,Rr[nn]=4;var Ve=[];Ve[ra]=2,Ve[Yi]=2,Ve[ia]=2,Ve[vi]=4,Ve[Zi]=.5,Ve[Ji]=.5,Ve[tn]=1,Ve[en]=1,Ve[na]=.5,Ve[aa]=1,Ve[sa]=1,Ve[oa]=.5,Ve[ua]=.25,Ve[ha]=.5,Ve[la]=.25,Ve[pa]=.5;function xa(g){return Array.isArray(g)&&(g.length===0||typeof g[0]=="number")}function Ea(g){if(!Array.isArray(g))return!1;var B=g.length;return!(B===0||!Ge(g[0]))}function yr(g){return Object.prototype.toString.call(g)}function Ta(g){return yr(g)===va}function wa(g){return yr(g)===_a}function Cu(g){return yr(g)===ga}function Iu(g){return yr(g)===ma}function Du(g){return yr(g)===ya}function Nu(g){return yr(g)===ba}function hn(g){if(!g)return!1;var B=yr(g);return Gu.indexOf(B)>=0?!0:xa(g)||Ea(g)||tr(g)}function La(g){return Ui[Object.prototype.toString.call(g)]|0}function Ru(g,B){var K=B.length;switch(g.type){case Dr:case rn:case nn:case Yr:var dt=De.allocType(g.type,K);dt.set(B),g.data=dt;break;case Ir:g.data=ta(B);break;default:V.raise("unsupported texture type, must specify a typed array")}}function Sa(g,B){return De.allocType(g.type===Ir?Yr:g.type,B)}function Oa(g,B){g.type===Ir?(g.data=ta(B),De.freeType(B)):g.data=B}function ku(g,B,K,dt,Lt,ft){for(var bt=g.width,It=g.height,Nt=g.channels,Ft=bt*It*Nt,Rt=Sa(g,Ft),zt=0,Xt=0;Xt<It;++Xt)for(var Dt=0;Dt<bt;++Dt)for(var Ut=0;Ut<Nt;++Ut)Rt[zt++]=B[K*Dt+dt*Xt+Lt*Ut+ft];Oa(g,Rt)}function mi(g,B,K,dt,Lt,ft){var bt;if(typeof Ve[g]<"u"?bt=Ve[g]:bt=Ze[g]*Rr[B],ft&&(bt*=6),Lt){for(var It=0,Nt=K;Nt>=1;)It+=bt*Nt*Nt,Nt/=2;return It}else return bt*K*dt}function Pu(g,B,K,dt,Lt,ft,bt){var It={"don't care":_i,"dont care":_i,nice:Eu,fast:xu},Nt={repeat:vu,clamp:an,mirror:_u},Ft={nearest:sn,linear:yu},Rt=r({mipmap:un,"nearest mipmap nearest":on,"linear mipmap nearest":ca,"nearest mipmap linear":fa,"linear mipmap linear":un},Ft),zt={none:0,browser:da},Xt={uint8:Dr,rgba4:hu,rgb565:pu,"rgb5 a1":lu},Dt={alpha:ji,luminance:jr,"luminance alpha":di,rgb:fi,rgba:mr,rgba4:ra,"rgb5 a1":Yi,rgb565:ia},Ut={};B.ext_srgb&&(Dt.srgb=Ki,Dt.srgba=Qi),B.oes_texture_float&&(Xt.float32=Xt.float=Yr),B.oes_texture_half_float&&(Xt.float16=Xt["half float"]=Ir),B.webgl_depth_texture&&(r(Dt,{depth:$i,"depth stencil":vi}),r(Xt,{uint16:rn,uint32:nn,"depth stencil":cu})),B.webgl_compressed_texture_s3tc&&r(Ut,{"rgb s3tc dxt1":Zi,"rgba s3tc dxt1":Ji,"rgba s3tc dxt3":tn,"rgba s3tc dxt5":en}),B.webgl_compressed_texture_atc&&r(Ut,{"rgb atc":na,"rgba atc explicit alpha":aa,"rgba atc interpolated alpha":sa}),B.webgl_compressed_texture_pvrtc&&r(Ut,{"rgb pvrtc 4bppv1":oa,"rgb pvrtc 2bppv1":ua,"rgba pvrtc 4bppv1":ha,"rgba pvrtc 2bppv1":la}),B.webgl_compressed_texture_etc1&&(Ut["rgb etc1"]=pa);var ht=Array.prototype.slice.call(g.getParameter(uu));Object.keys(Ut).forEach(function(j){var _t=Ut[j];ht.indexOf(_t)>=0&&(Dt[j]=_t)});var xt=Object.keys(Dt);K.textureFormats=xt;var Mt=[];Object.keys(Dt).forEach(function(j){var _t=Dt[j];Mt[_t]=j});var jt=[];Object.keys(Xt).forEach(function(j){var _t=Xt[j];jt[_t]=j});var At=[];Object.keys(Ft).forEach(function(j){var _t=Ft[j];At[_t]=j});var Kt=[];Object.keys(Rt).forEach(function(j){var _t=Rt[j];Kt[_t]=j});var Ct=[];Object.keys(Nt).forEach(function(j){var _t=Nt[j];Ct[_t]=j});var Ht=xt.reduce(function(j,_t){var ct=Dt[_t];return ct===jr||ct===ji||ct===jr||ct===di||ct===$i||ct===vi||B.ext_srgb&&(ct===Ki||ct===Qi)?j[ct]=ct:ct===Yi||_t.indexOf("rgba")>=0?j[ct]=mr:j[ct]=fi,j},{});function Gt(){this.internalformat=mr,this.format=mr,this.type=Dr,this.compressed=!1,this.premultiplyAlpha=!1,this.flipY=!1,this.unpackAlignment=1,this.colorSpace=da,this.width=0,this.height=0,this.channels=0}function Vt(j,_t){j.internalformat=_t.internalformat,j.format=_t.format,j.type=_t.type,j.compressed=_t.compressed,j.premultiplyAlpha=_t.premultiplyAlpha,j.flipY=_t.flipY,j.unpackAlignment=_t.unpackAlignment,j.colorSpace=_t.colorSpace,j.width=_t.width,j.height=_t.height,j.channels=_t.channels}function ie(j,_t){if(!(typeof _t!="object"||!_t)){if("premultiplyAlpha"in _t&&(V.type(_t.premultiplyAlpha,"boolean","invalid premultiplyAlpha"),j.premultiplyAlpha=_t.premultiplyAlpha),"flipY"in _t&&(V.type(_t.flipY,"boolean","invalid texture flip"),j.flipY=_t.flipY),"alignment"in _t&&(V.oneOf(_t.alignment,[1,2,4,8],"invalid texture unpack alignment"),j.unpackAlignment=_t.alignment),"colorSpace"in _t&&(V.parameter(_t.colorSpace,zt,"invalid colorSpace"),j.colorSpace=zt[_t.colorSpace]),"type"in _t){var ct=_t.type;V(B.oes_texture_float||!(ct==="float"||ct==="float32"),"you must enable the OES_texture_float extension in order to use floating point textures."),V(B.oes_texture_half_float||!(ct==="half float"||ct==="float16"),"you must enable the OES_texture_half_float extension in order to use 16-bit floating point textures."),V(B.webgl_depth_texture||!(ct==="uint16"||ct==="uint32"||ct==="depth stencil"),"you must enable the WEBGL_depth_texture extension in order to use depth/stencil textures."),V.parameter(ct,Xt,"invalid texture type"),j.type=Xt[ct]}var Qt=j.width,me=j.height,X=j.channels,k=!1;"shape"in _t?(V(Array.isArray(_t.shape)&&_t.shape.length>=2,"shape must be an array"),Qt=_t.shape[0],me=_t.shape[1],_t.shape.length===3&&(X=_t.shape[2],V(X>0&&X<=4,"invalid number of channels"),k=!0),V(Qt>=0&&Qt<=K.maxTextureSize,"invalid width"),V(me>=0&&me<=K.maxTextureSize,"invalid height")):("radius"in _t&&(Qt=me=_t.radius,V(Qt>=0&&Qt<=K.maxTextureSize,"invalid radius")),"width"in _t&&(Qt=_t.width,V(Qt>=0&&Qt<=K.maxTextureSize,"invalid width")),"height"in _t&&(me=_t.height,V(me>=0&&me<=K.maxTextureSize,"invalid height")),"channels"in _t&&(X=_t.channels,V(X>0&&X<=4,"invalid number of channels"),k=!0)),j.width=Qt|0,j.height=me|0,j.channels=X|0;var tt=!1;if("format"in _t){var ot=_t.format;V(B.webgl_depth_texture||!(ot==="depth"||ot==="depth stencil"),"you must enable the WEBGL_depth_texture extension in order to use depth/stencil textures."),V.parameter(ot,Dt,"invalid texture format");var lt=j.internalformat=Dt[ot];j.format=Ht[lt],ot in Xt&&("type"in _t||(j.type=Xt[ot])),ot in Ut&&(j.compressed=!0),tt=!0}!k&&tt?j.channels=Ze[j.format]:k&&!tt?j.channels!==gi[j.format]&&(j.format=j.internalformat=gi[j.channels]):tt&&k&&V(j.channels===Ze[j.format],"number of channels inconsistent with specified format")}}function oe(j){g.pixelStorei(Lu,j.flipY),g.pixelStorei(Su,j.premultiplyAlpha),g.pixelStorei(Ou,j.colorSpace),g.pixelStorei(wu,j.unpackAlignment)}function Wt(){Gt.call(this),this.xOffset=0,this.yOffset=0,this.data=null,this.needsFree=!1,this.element=null,this.needsCopy=!1}function Bt(j,_t){var ct=null;if(hn(_t)?ct=_t:_t&&(V.type(_t,"object","invalid pixel data type"),ie(j,_t),"x"in _t&&(j.xOffset=_t.x|0),"y"in _t&&(j.yOffset=_t.y|0),hn(_t.data)&&(ct=_t.data)),V(!j.compressed||ct instanceof Uint8Array,"compressed texture data must be stored in a uint8array"),_t.copy){V(!ct,"can not specify copy and data field for the same texture");var Qt=Lt.viewportWidth,me=Lt.viewportHeight;j.width=j.width||Qt-j.xOffset,j.height=j.height||me-j.yOffset,j.needsCopy=!0,V(j.xOffset>=0&&j.xOffset<Qt&&j.yOffset>=0&&j.yOffset<me&&j.width>0&&j.width<=Qt&&j.height>0&&j.height<=me,"copy texture read out of bounds")}else if(!ct)j.width=j.width||1,j.height=j.height||1,j.channels=j.channels||4;else if(n(ct))j.channels=j.channels||4,j.data=ct,!("type"in _t)&&j.type===Dr&&(j.type=La(ct));else if(xa(ct))j.channels=j.channels||4,Ru(j,ct),j.alignment=1,j.needsFree=!0;else if(tr(ct)){var X=ct.data;!Array.isArray(X)&&j.type===Dr&&(j.type=La(X));var k=ct.shape,tt=ct.stride,ot,lt,rt,et,nt,W;k.length===3?(rt=k[2],W=tt[2]):(V(k.length===2,"invalid ndarray pixel data, must be 2 or 3D"),rt=1,W=1),ot=k[0],lt=k[1],et=tt[0],nt=tt[1],j.alignment=1,j.width=ot,j.height=lt,j.channels=rt,j.format=j.internalformat=gi[rt],j.needsFree=!0,ku(j,X,et,nt,W,ct.offset)}else if(Ta(ct)||wa(ct)||Cu(ct))Ta(ct)||wa(ct)?j.element=ct:j.element=ct.canvas,j.width=j.element.width,j.height=j.element.height,j.channels=4;else if(Iu(ct))j.element=ct,j.width=ct.width,j.height=ct.height,j.channels=4;else if(Du(ct))j.element=ct,j.width=ct.naturalWidth,j.height=ct.naturalHeight,j.channels=4;else if(Nu(ct))j.element=ct,j.width=ct.videoWidth,j.height=ct.videoHeight,j.channels=4;else if(Ea(ct)){var J=j.width||ct[0].length,U=j.height||ct.length,at=j.channels;Ge(ct[0][0])?at=at||ct[0][0].length:at=at||1;for(var pt=hi.shape(ct),wt=1,St=0;St<pt.length;++St)wt*=pt[St];var Et=Sa(j,wt);hi.flatten(ct,pt,"",Et),Oa(j,Et),j.alignment=1,j.width=J,j.height=U,j.channels=at,j.format=j.internalformat=gi[at],j.needsFree=!0}j.type===Yr?V(K.extensions.indexOf("oes_texture_float")>=0,"oes_texture_float extension not enabled"):j.type===Ir&&V(K.extensions.indexOf("oes_texture_half_float")>=0,"oes_texture_half_float extension not enabled")}function Ot(j,_t,ct){var Qt=j.element,me=j.data,X=j.internalformat,k=j.format,tt=j.type,ot=j.width,lt=j.height;oe(j),Qt?g.texImage2D(_t,ct,k,k,tt,Qt):j.compressed?g.compressedTexImage2D(_t,ct,X,ot,lt,0,me):j.needsCopy?(dt(),g.copyTexImage2D(_t,ct,k,j.xOffset,j.yOffset,ot,lt,0)):g.texImage2D(_t,ct,k,ot,lt,0,k,tt,me||null)}function se(j,_t,ct,Qt,me){var X=j.element,k=j.data,tt=j.internalformat,ot=j.format,lt=j.type,rt=j.width,et=j.height;oe(j),X?g.texSubImage2D(_t,me,ct,Qt,ot,lt,X):j.compressed?g.compressedTexSubImage2D(_t,me,ct,Qt,tt,rt,et,k):j.needsCopy?(dt(),g.copyTexSubImage2D(_t,me,ct,Qt,j.xOffset,j.yOffset,rt,et)):g.texSubImage2D(_t,me,ct,Qt,rt,et,ot,lt,k)}var fe=[];function Zt(){return fe.pop()||new Wt}function ge(j){j.needsFree&&De.freeType(j.data),Wt.call(j),fe.push(j)}function ue(){Gt.call(this),this.genMipmaps=!1,this.mipmapHint=_i,this.mipmask=0,this.images=Array(16)}function _e(j,_t,ct){var Qt=j.images[0]=Zt();j.mipmask=1,Qt.width=j.width=_t,Qt.height=j.height=ct,Qt.channels=j.channels=4}function we(j,_t){var ct=null;if(hn(_t))ct=j.images[0]=Zt(),Vt(ct,j),Bt(ct,_t),j.mipmask=1;else if(ie(j,_t),Array.isArray(_t.mipmap))for(var Qt=_t.mipmap,me=0;me<Qt.length;++me)ct=j.images[me]=Zt(),Vt(ct,j),ct.width>>=me,ct.height>>=me,Bt(ct,Qt[me]),j.mipmask|=1<<me;else ct=j.images[0]=Zt(),Vt(ct,j),Bt(ct,_t),j.mipmask=1;Vt(j,j.images[0]),j.compressed&&(j.internalformat===Zi||j.internalformat===Ji||j.internalformat===tn||j.internalformat===en)&&V(j.width%4===0&&j.height%4===0,"for compressed texture formats, mipmap level 0 must have width and height that are a multiple of 4")}function Re(j,_t){for(var ct=j.images,Qt=0;Qt<ct.length;++Qt){if(!ct[Qt])return;Ot(ct[Qt],_t,Qt)}}var ze=[];function xe(){var j=ze.pop()||new ue;Gt.call(j),j.mipmask=0;for(var _t=0;_t<16;++_t)j.images[_t]=null;return j}function Pe(j){for(var _t=j.images,ct=0;ct<_t.length;++ct)_t[ct]&&ge(_t[ct]),_t[ct]=null;ze.push(j)}function Oe(){this.minFilter=sn,this.magFilter=sn,this.wrapS=an,this.wrapT=an,this.anisotropic=1,this.genMipmaps=!1,this.mipmapHint=_i}function ke(j,_t){if("min"in _t){var ct=_t.min;V.parameter(ct,Rt),j.minFilter=Rt[ct],Au.indexOf(j.minFilter)>=0&&!("faces"in _t)&&(j.genMipmaps=!0)}if("mag"in _t){var Qt=_t.mag;V.parameter(Qt,Ft),j.magFilter=Ft[Qt]}var me=j.wrapS,X=j.wrapT;if("wrap"in _t){var k=_t.wrap;typeof k=="string"?(V.parameter(k,Nt),me=X=Nt[k]):Array.isArray(k)&&(V.parameter(k[0],Nt),V.parameter(k[1],Nt),me=Nt[k[0]],X=Nt[k[1]])}else{if("wrapS"in _t){var tt=_t.wrapS;V.parameter(tt,Nt),me=Nt[tt]}if("wrapT"in _t){var ot=_t.wrapT;V.parameter(ot,Nt),X=Nt[ot]}}if(j.wrapS=me,j.wrapT=X,"anisotropic"in _t){var lt=_t.anisotropic;V(typeof lt=="number"&&lt>=1&&lt<=K.maxAnisotropic,"aniso samples must be between 1 and "),j.anisotropic=_t.anisotropic}if("mipmap"in _t){var rt=!1;switch(typeof _t.mipmap){case"string":V.parameter(_t.mipmap,It,"invalid mipmap hint"),j.mipmapHint=It[_t.mipmap],j.genMipmaps=!0,rt=!0;break;case"boolean":rt=j.genMipmaps=_t.mipmap;break;case"object":V(Array.isArray(_t.mipmap),"invalid mipmap type"),j.genMipmaps=!1,rt=!0;break;default:V.raise("invalid mipmap type")}rt&&!("min"in _t)&&(j.minFilter=on)}}function Me(j,_t){g.texParameteri(_t,mu,j.minFilter),g.texParameteri(_t,gu,j.magFilter),g.texParameteri(_t,fu,j.wrapS),g.texParameteri(_t,du,j.wrapT),B.ext_texture_filter_anisotropic&&g.texParameteri(_t,Tu,j.anisotropic),j.genMipmaps&&(g.hint(bu,j.mipmapHint),g.generateMipmap(_t))}var Fe=0,Ue={},Xe=K.maxTextureUnits,Ce=Array(Xe).map(function(){return null});function de(j){Gt.call(this),this.mipmask=0,this.internalformat=mr,this.id=Fe++,this.refCount=1,this.target=j,this.texture=g.createTexture(),this.unit=-1,this.bindCount=0,this.texInfo=new Oe,bt.profile&&(this.stats={size:0})}function We(j){g.activeTexture($r),g.bindTexture(j.target,j.texture)}function Se(){var j=Ce[0];j?g.bindTexture(j.target,j.texture):g.bindTexture(nr,null)}function ne(j){var _t=j.texture;V(_t,"must not double destroy texture");var ct=j.unit,Qt=j.target;ct>=0&&(g.activeTexture($r+ct),g.bindTexture(Qt,null),Ce[ct]=null),g.deleteTexture(_t),j.texture=null,j.params=null,j.pixels=null,j.refCount=0,delete Ue[j.id],ft.textureCount--}r(de.prototype,{bind:function(){var j=this;j.bindCount+=1;var _t=j.unit;if(_t<0){for(var ct=0;ct<Xe;++ct){var Qt=Ce[ct];if(Qt){if(Qt.bindCount>0)continue;Qt.unit=-1}Ce[ct]=j,_t=ct;break}_t>=Xe&&V.raise("insufficient number of texture units"),bt.profile&&ft.maxTextureUnits<_t+1&&(ft.maxTextureUnits=_t+1),j.unit=_t,g.activeTexture($r+_t),g.bindTexture(j.target,j.texture)}return _t},unbind:function(){this.bindCount-=1},decRef:function(){--this.refCount<=0&&ne(this)}});function be(j,_t){var ct=new de(nr);Ue[ct.id]=ct,ft.textureCount++;function Qt(k,tt){var ot=ct.texInfo;Oe.call(ot);var lt=xe();return typeof k=="number"?typeof tt=="number"?_e(lt,k|0,tt|0):_e(lt,k|0,k|0):k?(V.type(k,"object","invalid arguments to regl.texture"),ke(ot,k),we(lt,k)):_e(lt,1,1),ot.genMipmaps&&(lt.mipmask=(lt.width<<1)-1),ct.mipmask=lt.mipmask,Vt(ct,lt),V.texture2D(ot,lt,K),ct.internalformat=lt.internalformat,Qt.width=lt.width,Qt.height=lt.height,We(ct),Re(lt,nr),Me(ot,nr),Se(),Pe(lt),bt.profile&&(ct.stats.size=mi(ct.internalformat,ct.type,lt.width,lt.height,ot.genMipmaps,!1)),Qt.format=Mt[ct.internalformat],Qt.type=jt[ct.type],Qt.mag=At[ot.magFilter],Qt.min=Kt[ot.minFilter],Qt.wrapS=Ct[ot.wrapS],Qt.wrapT=Ct[ot.wrapT],Qt}function me(k,tt,ot,lt){V(!!k,"must specify image data");var rt=tt|0,et=ot|0,nt=lt|0,W=Zt();return Vt(W,ct),W.width=0,W.height=0,Bt(W,k),W.width=W.width||(ct.width>>nt)-rt,W.height=W.height||(ct.height>>nt)-et,V(ct.type===W.type&&ct.format===W.format&&ct.internalformat===W.internalformat,"incompatible format for texture.subimage"),V(rt>=0&&et>=0&&rt+W.width<=ct.width&&et+W.height<=ct.height,"texture.subimage write out of bounds"),V(ct.mipmask&1<<nt,"missing mipmap data"),V(W.data||W.element||W.needsCopy,"missing image data"),We(ct),se(W,nr,rt,et,nt),Se(),ge(W),Qt}function X(k,tt){var ot=k|0,lt=tt|0||ot;if(ot===ct.width&&lt===ct.height)return Qt;Qt.width=ct.width=ot,Qt.height=ct.height=lt,We(ct);for(var rt=0;ct.mipmask>>rt;++rt){var et=ot>>rt,nt=lt>>rt;if(!et||!nt)break;g.texImage2D(nr,rt,ct.format,et,nt,0,ct.format,ct.type,null)}return Se(),bt.profile&&(ct.stats.size=mi(ct.internalformat,ct.type,ot,lt,!1,!1)),Qt}return Qt(j,_t),Qt.subimage=me,Qt.resize=X,Qt._reglType="texture2d",Qt._texture=ct,bt.profile&&(Qt.stats=ct.stats),Qt.destroy=function(){ct.decRef()},Qt}function Ee(j,_t,ct,Qt,me,X){var k=new de(qi);Ue[k.id]=k,ft.cubeCount++;var tt=new Array(6);function ot(et,nt,W,J,U,at){var pt,wt=k.texInfo;for(Oe.call(wt),pt=0;pt<6;++pt)tt[pt]=xe();if(typeof et=="number"||!et){var St=et|0||1;for(pt=0;pt<6;++pt)_e(tt[pt],St,St)}else if(typeof et=="object")if(nt)we(tt[0],et),we(tt[1],nt),we(tt[2],W),we(tt[3],J),we(tt[4],U),we(tt[5],at);else if(ke(wt,et),ie(k,et),"faces"in et){var Et=et.faces;for(V(Array.isArray(Et)&&Et.length===6,"cube faces must be a length 6 array"),pt=0;pt<6;++pt)V(typeof Et[pt]=="object"&&!!Et[pt],"invalid input for cube map face"),Vt(tt[pt],k),we(tt[pt],Et[pt])}else for(pt=0;pt<6;++pt)we(tt[pt],et);else V.raise("invalid arguments to cube map");for(Vt(k,tt[0]),K.npotTextureCube||V(ea(k.width)&&ea(k.height),"your browser does not support non power or two texture dimensions"),wt.genMipmaps?k.mipmask=(tt[0].width<<1)-1:k.mipmask=tt[0].mipmask,V.textureCube(k,wt,tt,K),k.internalformat=tt[0].internalformat,ot.width=tt[0].width,ot.height=tt[0].height,We(k),pt=0;pt<6;++pt)Re(tt[pt],ci+pt);for(Me(wt,qi),Se(),bt.profile&&(k.stats.size=mi(k.internalformat,k.type,ot.width,ot.height,wt.genMipmaps,!0)),ot.format=Mt[k.internalformat],ot.type=jt[k.type],ot.mag=At[wt.magFilter],ot.min=Kt[wt.minFilter],ot.wrapS=Ct[wt.wrapS],ot.wrapT=Ct[wt.wrapT],pt=0;pt<6;++pt)Pe(tt[pt]);return ot}function lt(et,nt,W,J,U){V(!!nt,"must specify image data"),V(typeof et=="number"&&et===(et|0)&&et>=0&&et<6,"invalid face");var at=W|0,pt=J|0,wt=U|0,St=Zt();return Vt(St,k),St.width=0,St.height=0,Bt(St,nt),St.width=St.width||(k.width>>wt)-at,St.height=St.height||(k.height>>wt)-pt,V(k.type===St.type&&k.format===St.format&&k.internalformat===St.internalformat,"incompatible format for texture.subimage"),V(at>=0&&pt>=0&&at+St.width<=k.width&&pt+St.height<=k.height,"texture.subimage write out of bounds"),V(k.mipmask&1<<wt,"missing mipmap data"),V(St.data||St.element||St.needsCopy,"missing image data"),We(k),se(St,ci+et,at,pt,wt),Se(),ge(St),ot}function rt(et){var nt=et|0;if(nt!==k.width){ot.width=k.width=nt,ot.height=k.height=nt,We(k);for(var W=0;W<6;++W)for(var J=0;k.mipmask>>J;++J)g.texImage2D(ci+W,J,k.format,nt>>J,nt>>J,0,k.format,k.type,null);return Se(),bt.profile&&(k.stats.size=mi(k.internalformat,k.type,ot.width,ot.height,!1,!0)),ot}}return ot(j,_t,ct,Qt,me,X),ot.subimage=lt,ot.resize=rt,ot._reglType="textureCube",ot._texture=k,bt.profile&&(ot.stats=k.stats),ot.destroy=function(){k.decRef()},ot}function Ie(){for(var j=0;j<Xe;++j)g.activeTexture($r+j),g.bindTexture(nr,null),Ce[j]=null;Qe(Ue).forEach(ne),ft.cubeCount=0,ft.textureCount=0}bt.profile&&(ft.getTotalTextureSize=function(){var j=0;return Object.keys(Ue).forEach(function(_t){j+=Ue[_t].stats.size}),j});function sr(){for(var j=0;j<Xe;++j){var _t=Ce[j];_t&&(_t.bindCount=0,_t.unit=-1,Ce[j]=null)}Qe(Ue).forEach(function(ct){ct.texture=g.createTexture(),g.bindTexture(ct.target,ct.texture);for(var Qt=0;Qt<32;++Qt)if(ct.mipmask&1<<Qt)if(ct.target===nr)g.texImage2D(nr,Qt,ct.internalformat,ct.width>>Qt,ct.height>>Qt,0,ct.internalformat,ct.type,null);else for(var me=0;me<6;++me)g.texImage2D(ci+me,Qt,ct.internalformat,ct.width>>Qt,ct.height>>Qt,0,ct.internalformat,ct.type,null);Me(ct.texInfo,ct.target)})}function Sr(){for(var j=0;j<Xe;++j){var _t=Ce[j];_t&&(_t.bindCount=0,_t.unit=-1,Ce[j]=null),g.activeTexture($r+j),g.bindTexture(nr,null),g.bindTexture(qi,null)}}return{create2D:be,createCube:Ee,clear:Ie,getTexture:function(j){return null},restore:sr,refresh:Sr}}var lr=36161,yi=32854,Aa=32855,Ga=36194,Ca=33189,Ia=36168,Da=34041,Na=35907,Ra=34836,ka=34842,Pa=34843,er=[];er[yi]=2,er[Aa]=2,er[Ga]=2,er[Ca]=2,er[Ia]=1,er[Da]=4,er[Na]=4,er[Ra]=16,er[ka]=8,er[Pa]=6;function Ma(g,B,K){return er[g]*B*K}var Mu=function(g,B,K,dt,Lt){var ft={rgba4:yi,rgb565:Ga,"rgb5 a1":Aa,depth:Ca,stencil:Ia,"depth stencil":Da};B.ext_srgb&&(ft.srgba=Na),B.ext_color_buffer_half_float&&(ft.rgba16f=ka,ft.rgb16f=Pa),B.webgl_color_buffer_float&&(ft.rgba32f=Ra);var bt=[];Object.keys(ft).forEach(function(Dt){var Ut=ft[Dt];bt[Ut]=Dt});var It=0,Nt={};function Ft(Dt){this.id=It++,this.refCount=1,this.renderbuffer=Dt,this.format=yi,this.width=0,this.height=0,Lt.profile&&(this.stats={size:0})}Ft.prototype.decRef=function(){--this.refCount<=0&&Rt(this)};function Rt(Dt){var Ut=Dt.renderbuffer;V(Ut,"must not double destroy renderbuffer"),g.bindRenderbuffer(lr,null),g.deleteRenderbuffer(Ut),Dt.renderbuffer=null,Dt.refCount=0,delete Nt[Dt.id],dt.renderbufferCount--}function zt(Dt,Ut){var ht=new Ft(g.createRenderbuffer());Nt[ht.id]=ht,dt.renderbufferCount++;function xt(jt,At){var Kt=0,Ct=0,Ht=yi;if(typeof jt=="object"&&jt){var Gt=jt;if("shape"in Gt){var Vt=Gt.shape;V(Array.isArray(Vt)&&Vt.length>=2,"invalid renderbuffer shape"),Kt=Vt[0]|0,Ct=Vt[1]|0}else"radius"in Gt&&(Kt=Ct=Gt.radius|0),"width"in Gt&&(Kt=Gt.width|0),"height"in Gt&&(Ct=Gt.height|0);"format"in Gt&&(V.parameter(Gt.format,ft,"invalid renderbuffer format"),Ht=ft[Gt.format])}else typeof jt=="number"?(Kt=jt|0,typeof At=="number"?Ct=At|0:Ct=Kt):jt?V.raise("invalid arguments to renderbuffer constructor"):Kt=Ct=1;if(V(Kt>0&&Ct>0&&Kt<=K.maxRenderbufferSize&&Ct<=K.maxRenderbufferSize,"invalid renderbuffer size"),!(Kt===ht.width&&Ct===ht.height&&Ht===ht.format))return xt.width=ht.width=Kt,xt.height=ht.height=Ct,ht.format=Ht,g.bindRenderbuffer(lr,ht.renderbuffer),g.renderbufferStorage(lr,Ht,Kt,Ct),V(g.getError()===0,"invalid render buffer format"),Lt.profile&&(ht.stats.size=Ma(ht.format,ht.width,ht.height)),xt.format=bt[ht.format],xt}function Mt(jt,At){var Kt=jt|0,Ct=At|0||Kt;return Kt===ht.width&&Ct===ht.height||(V(Kt>0&&Ct>0&&Kt<=K.maxRenderbufferSize&&Ct<=K.maxRenderbufferSize,"invalid renderbuffer size"),xt.width=ht.width=Kt,xt.height=ht.height=Ct,g.bindRenderbuffer(lr,ht.renderbuffer),g.renderbufferStorage(lr,ht.format,Kt,Ct),V(g.getError()===0,"invalid render buffer format"),Lt.profile&&(ht.stats.size=Ma(ht.format,ht.width,ht.height))),xt}return xt(Dt,Ut),xt.resize=Mt,xt._reglType="renderbuffer",xt._renderbuffer=ht,Lt.profile&&(xt.stats=ht.stats),xt.destroy=function(){ht.decRef()},xt}Lt.profile&&(dt.getTotalRenderbufferSize=function(){var Dt=0;return Object.keys(Nt).forEach(function(Ut){Dt+=Nt[Ut].stats.size}),Dt});function Xt(){Qe(Nt).forEach(function(Dt){Dt.renderbuffer=g.createRenderbuffer(),g.bindRenderbuffer(lr,Dt.renderbuffer),g.renderbufferStorage(lr,Dt.format,Dt.width,Dt.height)}),g.bindRenderbuffer(lr,null)}return{create:zt,clear:function(){Qe(Nt).forEach(Rt)},restore:Xt}},or=36160,ln=36161,br=3553,bi=34069,Fa=36064,Ba=36096,za=36128,Ua=33306,Ha=36053,Fu=36054,Bu=36055,zu=36057,Uu=36061,Hu=36193,Vu=5121,Xu=5126,Va=6407,Xa=6408,Wu=6402,qu=[Va,Xa],pn=[];pn[Xa]=4,pn[Va]=3;var xi=[];xi[Vu]=1,xi[Xu]=4,xi[Hu]=2;var ju=32854,Yu=32855,$u=36194,Ku=33189,Qu=36168,Wa=34041,Zu=35907,Ju=34836,th=34842,eh=34843,rh=[ju,Yu,$u,Zu,th,eh,Ju],kr={};kr[Ha]="complete",kr[Fu]="incomplete attachment",kr[zu]="incomplete dimensions",kr[Bu]="incomplete, missing attachment",kr[Uu]="unsupported";function ih(g,B,K,dt,Lt,ft){var bt={cur:null,next:null,dirty:!1,setFBO:null},It=["rgba"],Nt=["rgba4","rgb565","rgb5 a1"];B.ext_srgb&&Nt.push("srgba"),B.ext_color_buffer_half_float&&Nt.push("rgba16f","rgb16f"),B.webgl_color_buffer_float&&Nt.push("rgba32f");var Ft=["uint8"];B.oes_texture_half_float&&Ft.push("half float","float16"),B.oes_texture_float&&Ft.push("float","float32");function Rt(Wt,Bt,Ot){this.target=Wt,this.texture=Bt,this.renderbuffer=Ot;var se=0,fe=0;Bt?(se=Bt.width,fe=Bt.height):Ot&&(se=Ot.width,fe=Ot.height),this.width=se,this.height=fe}function zt(Wt){Wt&&(Wt.texture&&Wt.texture._texture.decRef(),Wt.renderbuffer&&Wt.renderbuffer._renderbuffer.decRef())}function Xt(Wt,Bt,Ot){if(Wt)if(Wt.texture){var se=Wt.texture._texture,fe=Math.max(1,se.width),Zt=Math.max(1,se.height);V(fe===Bt&&Zt===Ot,"inconsistent width/height for supplied texture"),se.refCount+=1}else{var ge=Wt.renderbuffer._renderbuffer;V(ge.width===Bt&&ge.height===Ot,"inconsistent width/height for renderbuffer"),ge.refCount+=1}}function Dt(Wt,Bt){Bt&&(Bt.texture?g.framebufferTexture2D(or,Wt,Bt.target,Bt.texture._texture.texture,0):g.framebufferRenderbuffer(or,Wt,ln,Bt.renderbuffer._renderbuffer.renderbuffer))}function Ut(Wt){var Bt=br,Ot=null,se=null,fe=Wt;typeof Wt=="object"&&(fe=Wt.data,"target"in Wt&&(Bt=Wt.target|0)),V.type(fe,"function","invalid attachment data");var Zt=fe._reglType;return Zt==="texture2d"?(Ot=fe,V(Bt===br)):Zt==="textureCube"?(Ot=fe,V(Bt>=bi&&Bt<bi+6,"invalid cube map target")):Zt==="renderbuffer"?(se=fe,Bt=ln):V.raise("invalid regl object for attachment"),new Rt(Bt,Ot,se)}function ht(Wt,Bt,Ot,se,fe){if(Ot){var Zt=dt.create2D({width:Wt,height:Bt,format:se,type:fe});return Zt._texture.refCount=0,new Rt(br,Zt,null)}else{var ge=Lt.create({width:Wt,height:Bt,format:se});return ge._renderbuffer.refCount=0,new Rt(ln,null,ge)}}function xt(Wt){return Wt&&(Wt.texture||Wt.renderbuffer)}function Mt(Wt,Bt,Ot){Wt&&(Wt.texture?Wt.texture.resize(Bt,Ot):Wt.renderbuffer&&Wt.renderbuffer.resize(Bt,Ot),Wt.width=Bt,Wt.height=Ot)}var jt=0,At={};function Kt(){this.id=jt++,At[this.id]=this,this.framebuffer=g.createFramebuffer(),this.width=0,this.height=0,this.colorAttachments=[],this.depthAttachment=null,this.stencilAttachment=null,this.depthStencilAttachment=null}function Ct(Wt){Wt.colorAttachments.forEach(zt),zt(Wt.depthAttachment),zt(Wt.stencilAttachment),zt(Wt.depthStencilAttachment)}function Ht(Wt){var Bt=Wt.framebuffer;V(Bt,"must not double destroy framebuffer"),g.deleteFramebuffer(Bt),Wt.framebuffer=null,ft.framebufferCount--,delete At[Wt.id]}function Gt(Wt){var Bt;g.bindFramebuffer(or,Wt.framebuffer);var Ot=Wt.colorAttachments;for(Bt=0;Bt<Ot.length;++Bt)Dt(Fa+Bt,Ot[Bt]);for(Bt=Ot.length;Bt<K.maxColorAttachments;++Bt)g.framebufferTexture2D(or,Fa+Bt,br,null,0);g.framebufferTexture2D(or,Ua,br,null,0),g.framebufferTexture2D(or,Ba,br,null,0),g.framebufferTexture2D(or,za,br,null,0),Dt(Ba,Wt.depthAttachment),Dt(za,Wt.stencilAttachment),Dt(Ua,Wt.depthStencilAttachment);var se=g.checkFramebufferStatus(or);!g.isContextLost()&&se!==Ha&&V.raise("framebuffer configuration not supported, status = "+kr[se]),g.bindFramebuffer(or,bt.next?bt.next.framebuffer:null),bt.cur=bt.next,g.getError()}function Vt(Wt,Bt){var Ot=new Kt;ft.framebufferCount++;function se(Zt,ge){var ue;V(bt.next!==Ot,"can not update framebuffer which is currently in use");var _e=0,we=0,Re=!0,ze=!0,xe=null,Pe=!0,Oe="rgba",ke="uint8",Me=1,Fe=null,Ue=null,Xe=null,Ce=!1;if(typeof Zt=="number")_e=Zt|0,we=ge|0||_e;else if(!Zt)_e=we=1;else{V.type(Zt,"object","invalid arguments for framebuffer");var de=Zt;if("shape"in de){var We=de.shape;V(Array.isArray(We)&&We.length>=2,"invalid shape for framebuffer"),_e=We[0],we=We[1]}else"radius"in de&&(_e=we=de.radius),"width"in de&&(_e=de.width),"height"in de&&(we=de.height);("color"in de||"colors"in de)&&(xe=de.color||de.colors,Array.isArray(xe)&&V(xe.length===1||B.webgl_draw_buffers,"multiple render targets not supported")),xe||("colorCount"in de&&(Me=de.colorCount|0,V(Me>0,"invalid color buffer count")),"colorTexture"in de&&(Pe=!!de.colorTexture,Oe="rgba4"),"colorType"in de&&(ke=de.colorType,Pe?(V(B.oes_texture_float||!(ke==="float"||ke==="float32"),"you must enable OES_texture_float in order to use floating point framebuffer objects"),V(B.oes_texture_half_float||!(ke==="half float"||ke==="float16"),"you must enable OES_texture_half_float in order to use 16-bit floating point framebuffer objects")):ke==="half float"||ke==="float16"?(V(B.ext_color_buffer_half_float,"you must enable EXT_color_buffer_half_float to use 16-bit render buffers"),Oe="rgba16f"):(ke==="float"||ke==="float32")&&(V(B.webgl_color_buffer_float,"you must enable WEBGL_color_buffer_float in order to use 32-bit floating point renderbuffers"),Oe="rgba32f"),V.oneOf(ke,Ft,"invalid color type")),"colorFormat"in de&&(Oe=de.colorFormat,It.indexOf(Oe)>=0?Pe=!0:Nt.indexOf(Oe)>=0?Pe=!1:Pe?V.oneOf(de.colorFormat,It,"invalid color format for texture"):V.oneOf(de.colorFormat,Nt,"invalid color format for renderbuffer"))),("depthTexture"in de||"depthStencilTexture"in de)&&(Ce=!!(de.depthTexture||de.depthStencilTexture),V(!Ce||B.webgl_depth_texture,"webgl_depth_texture extension not supported")),"depth"in de&&(typeof de.depth=="boolean"?Re=de.depth:(Fe=de.depth,ze=!1)),"stencil"in de&&(typeof de.stencil=="boolean"?ze=de.stencil:(Ue=de.stencil,Re=!1)),"depthStencil"in de&&(typeof de.depthStencil=="boolean"?Re=ze=de.depthStencil:(Xe=de.depthStencil,Re=!1,ze=!1))}var Se=null,ne=null,be=null,Ee=null;if(Array.isArray(xe))Se=xe.map(Ut);else if(xe)Se=[Ut(xe)];else for(Se=new Array(Me),ue=0;ue<Me;++ue)Se[ue]=ht(_e,we,Pe,Oe,ke);V(B.webgl_draw_buffers||Se.length<=1,"you must enable the WEBGL_draw_buffers extension in order to use multiple color buffers."),V(Se.length<=K.maxColorAttachments,"too many color attachments, not supported"),_e=_e||Se[0].width,we=we||Se[0].height,Fe?ne=Ut(Fe):Re&&!ze&&(ne=ht(_e,we,Ce,"depth","uint32")),Ue?be=Ut(Ue):ze&&!Re&&(be=ht(_e,we,!1,"stencil","uint8")),Xe?Ee=Ut(Xe):!Fe&&!Ue&&ze&&Re&&(Ee=ht(_e,we,Ce,"depth stencil","depth stencil")),V(!!Fe+!!Ue+!!Xe<=1,"invalid framebuffer configuration, can specify exactly one depth/stencil attachment");var Ie=null;for(ue=0;ue<Se.length;++ue)if(Xt(Se[ue],_e,we),V(!Se[ue]||Se[ue].texture&&qu.indexOf(Se[ue].texture._texture.format)>=0||Se[ue].renderbuffer&&rh.indexOf(Se[ue].renderbuffer._renderbuffer.format)>=0,"framebuffer color attachment "+ue+" is invalid"),Se[ue]&&Se[ue].texture){var sr=pn[Se[ue].texture._texture.format]*xi[Se[ue].texture._texture.type];Ie===null?Ie=sr:V(Ie===sr,"all color attachments much have the same number of bits per pixel.")}return Xt(ne,_e,we),V(!ne||ne.texture&&ne.texture._texture.format===Wu||ne.renderbuffer&&ne.renderbuffer._renderbuffer.format===Ku,"invalid depth attachment for framebuffer object"),Xt(be,_e,we),V(!be||be.renderbuffer&&be.renderbuffer._renderbuffer.format===Qu,"invalid stencil attachment for framebuffer object"),Xt(Ee,_e,we),V(!Ee||Ee.texture&&Ee.texture._texture.format===Wa||Ee.renderbuffer&&Ee.renderbuffer._renderbuffer.format===Wa,"invalid depth-stencil attachment for framebuffer object"),Ct(Ot),Ot.width=_e,Ot.height=we,Ot.colorAttachments=Se,Ot.depthAttachment=ne,Ot.stencilAttachment=be,Ot.depthStencilAttachment=Ee,se.color=Se.map(xt),se.depth=xt(ne),se.stencil=xt(be),se.depthStencil=xt(Ee),se.width=Ot.width,se.height=Ot.height,Gt(Ot),se}function fe(Zt,ge){V(bt.next!==Ot,"can not resize a framebuffer which is currently in use");var ue=Math.max(Zt|0,1),_e=Math.max(ge|0||ue,1);if(ue===Ot.width&&_e===Ot.height)return se;for(var we=Ot.colorAttachments,Re=0;Re<we.length;++Re)Mt(we[Re],ue,_e);return Mt(Ot.depthAttachment,ue,_e),Mt(Ot.stencilAttachment,ue,_e),Mt(Ot.depthStencilAttachment,ue,_e),Ot.width=se.width=ue,Ot.height=se.height=_e,Gt(Ot),se}return se(Wt,Bt),r(se,{resize:fe,_reglType:"framebuffer",_framebuffer:Ot,destroy:function(){Ht(Ot),Ct(Ot)},use:function(Zt){bt.setFBO({framebuffer:se},Zt)}})}function ie(Wt){var Bt=Array(6);function Ot(fe){var Zt;V(Bt.indexOf(bt.next)<0,"can not update framebuffer which is currently in use");var ge={color:null},ue=0,_e=null,we="rgba",Re="uint8",ze=1;if(typeof fe=="number")ue=fe|0;else if(!fe)ue=1;else{V.type(fe,"object","invalid arguments for framebuffer");var xe=fe;if("shape"in xe){var Pe=xe.shape;V(Array.isArray(Pe)&&Pe.length>=2,"invalid shape for framebuffer"),V(Pe[0]===Pe[1],"cube framebuffer must be square"),ue=Pe[0]}else"radius"in xe&&(ue=xe.radius|0),"width"in xe?(ue=xe.width|0,"height"in xe&&V(xe.height===ue,"must be square")):"height"in xe&&(ue=xe.height|0);("color"in xe||"colors"in xe)&&(_e=xe.color||xe.colors,Array.isArray(_e)&&V(_e.length===1||B.webgl_draw_buffers,"multiple render targets not supported")),_e||("colorCount"in xe&&(ze=xe.colorCount|0,V(ze>0,"invalid color buffer count")),"colorType"in xe&&(V.oneOf(xe.colorType,Ft,"invalid color type"),Re=xe.colorType),"colorFormat"in xe&&(we=xe.colorFormat,V.oneOf(xe.colorFormat,It,"invalid color format for texture"))),"depth"in xe&&(ge.depth=xe.depth),"stencil"in xe&&(ge.stencil=xe.stencil),"depthStencil"in xe&&(ge.depthStencil=xe.depthStencil)}var Oe;if(_e)if(Array.isArray(_e))for(Oe=[],Zt=0;Zt<_e.length;++Zt)Oe[Zt]=_e[Zt];else Oe=[_e];else{Oe=Array(ze);var ke={radius:ue,format:we,type:Re};for(Zt=0;Zt<ze;++Zt)Oe[Zt]=dt.createCube(ke)}for(ge.color=Array(Oe.length),Zt=0;Zt<Oe.length;++Zt){var Me=Oe[Zt];V(typeof Me=="function"&&Me._reglType==="textureCube","invalid cube map"),ue=ue||Me.width,V(Me.width===ue&&Me.height===ue,"invalid cube map shape"),ge.color[Zt]={target:bi,data:Oe[Zt]}}for(Zt=0;Zt<6;++Zt){for(var Fe=0;Fe<Oe.length;++Fe)ge.color[Fe].target=bi+Zt;Zt>0&&(ge.depth=Bt[0].depth,ge.stencil=Bt[0].stencil,ge.depthStencil=Bt[0].depthStencil),Bt[Zt]?Bt[Zt](ge):Bt[Zt]=Vt(ge)}return r(Ot,{width:ue,height:ue,color:Oe})}function se(fe){var Zt,ge=fe|0;if(V(ge>0&&ge<=K.maxCubeMapSize,"invalid radius for cube fbo"),ge===Ot.width)return Ot;var ue=Ot.color;for(Zt=0;Zt<ue.length;++Zt)ue[Zt].resize(ge);for(Zt=0;Zt<6;++Zt)Bt[Zt].resize(ge);return Ot.width=Ot.height=ge,Ot}return Ot(Wt),r(Ot,{faces:Bt,resize:se,_reglType:"framebufferCube",destroy:function(){Bt.forEach(function(fe){fe.destroy()})}})}function oe(){bt.cur=null,bt.next=null,bt.dirty=!0,Qe(At).forEach(function(Wt){Wt.framebuffer=g.createFramebuffer(),Gt(Wt)})}return r(bt,{getFramebuffer:function(Wt){if(typeof Wt=="function"&&Wt._reglType==="framebuffer"){var Bt=Wt._framebuffer;if(Bt instanceof Kt)return Bt}return null},create:Vt,createCube:ie,clear:function(){Qe(At).forEach(Ht)},restore:oe})}var nh=5126,qa=34962;function cn(){this.state=0,this.x=0,this.y=0,this.z=0,this.w=0,this.buffer=null,this.size=0,this.normalized=!1,this.type=nh,this.offset=0,this.stride=0,this.divisor=0}function ah(g,B,K,dt,Lt){for(var ft=K.maxAttributes,bt=new Array(ft),It=0;It<ft;++It)bt[It]=new cn;var Nt=0,Ft={},Rt={Record:cn,scope:{},state:bt,currentVAO:null,targetVAO:null,restore:Xt()?At:function(){},createVAO:Kt,getVAO:Ut,destroyBuffer:zt,setVAO:Xt()?ht:xt,clear:Xt()?Mt:function(){}};function zt(Ct){for(var Ht=0;Ht<bt.length;++Ht){var Gt=bt[Ht];Gt.buffer===Ct&&(g.disableVertexAttribArray(Ht),Gt.buffer=null)}}function Xt(){return B.oes_vertex_array_object}function Dt(){return B.angle_instanced_arrays}function Ut(Ct){return typeof Ct=="function"&&Ct._vao?Ct._vao:null}function ht(Ct){if(Ct!==Rt.currentVAO){var Ht=Xt();Ct?Ht.bindVertexArrayOES(Ct.vao):Ht.bindVertexArrayOES(null),Rt.currentVAO=Ct}}function xt(Ct){if(Ct!==Rt.currentVAO){if(Ct)Ct.bindAttrs();else for(var Ht=Dt(),Gt=0;Gt<bt.length;++Gt){var Vt=bt[Gt];Vt.buffer?(g.enableVertexAttribArray(Gt),g.vertexAttribPointer(Gt,Vt.size,Vt.type,Vt.normalized,Vt.stride,Vt.offfset),Ht&&Vt.divisor&&Ht.vertexAttribDivisorANGLE(Gt,Vt.divisor)):(g.disableVertexAttribArray(Gt),g.vertexAttrib4f(Gt,Vt.x,Vt.y,Vt.z,Vt.w))}Rt.currentVAO=Ct}}function Mt(){Qe(Ft).forEach(function(Ct){Ct.destroy()})}function jt(){this.id=++Nt,this.attributes=[];var Ct=Xt();Ct?this.vao=Ct.createVertexArrayOES():this.vao=null,Ft[this.id]=this,this.buffers=[]}jt.prototype.bindAttrs=function(){for(var Ct=Dt(),Ht=this.attributes,Gt=0;Gt<Ht.length;++Gt){var Vt=Ht[Gt];Vt.buffer?(g.enableVertexAttribArray(Gt),g.bindBuffer(qa,Vt.buffer.buffer),g.vertexAttribPointer(Gt,Vt.size,Vt.type,Vt.normalized,Vt.stride,Vt.offset),Ct&&Vt.divisor&&Ct.vertexAttribDivisorANGLE(Gt,Vt.divisor)):(g.disableVertexAttribArray(Gt),g.vertexAttrib4f(Gt,Vt.x,Vt.y,Vt.z,Vt.w))}for(var ie=Ht.length;ie<ft;++ie)g.disableVertexAttribArray(ie)},jt.prototype.refresh=function(){var Ct=Xt();Ct&&(Ct.bindVertexArrayOES(this.vao),this.bindAttrs(),Rt.currentVAO=this)},jt.prototype.destroy=function(){if(this.vao){var Ct=Xt();this===Rt.currentVAO&&(Rt.currentVAO=null,Ct.bindVertexArrayOES(null)),Ct.deleteVertexArrayOES(this.vao),this.vao=null}Ft[this.id]&&(delete Ft[this.id],dt.vaoCount-=1)};function At(){var Ct=Xt();Ct&&Qe(Ft).forEach(function(Ht){Ht.refresh()})}function Kt(Ct){var Ht=new jt;dt.vaoCount+=1;function Gt(Vt){V(Array.isArray(Vt),"arguments to vertex array constructor must be an array"),V(Vt.length<ft,"too many attributes"),V(Vt.length>0,"must specify at least one attribute");var ie={},oe=Ht.attributes;oe.length=Vt.length;for(var Wt=0;Wt<Vt.length;++Wt){var Bt=Vt[Wt],Ot=oe[Wt]=new cn,se=Bt.data||Bt;if(Array.isArray(se)||n(se)||tr(se)){var fe;Ht.buffers[Wt]&&(fe=Ht.buffers[Wt],n(se)&&fe._buffer.byteLength>=se.byteLength?fe.subdata(se):(fe.destroy(),Ht.buffers[Wt]=null)),Ht.buffers[Wt]||(fe=Ht.buffers[Wt]=Lt.create(Bt,qa,!1,!0)),Ot.buffer=Lt.getBuffer(fe),Ot.size=Ot.buffer.dimension|0,Ot.normalized=!1,Ot.type=Ot.buffer.dtype,Ot.offset=0,Ot.stride=0,Ot.divisor=0,Ot.state=1,ie[Wt]=1}else Lt.getBuffer(Bt)?(Ot.buffer=Lt.getBuffer(Bt),Ot.size=Ot.buffer.dimension|0,Ot.normalized=!1,Ot.type=Ot.buffer.dtype,Ot.offset=0,Ot.stride=0,Ot.divisor=0,Ot.state=1):Lt.getBuffer(Bt.buffer)?(Ot.buffer=Lt.getBuffer(Bt.buffer),Ot.size=(+Bt.size||Ot.buffer.dimension)|0,Ot.normalized=!!Bt.normalized||!1,"type"in Bt?(V.parameter(Bt.type,_r,"invalid buffer type"),Ot.type=_r[Bt.type]):Ot.type=Ot.buffer.dtype,Ot.offset=(Bt.offset||0)|0,Ot.stride=(Bt.stride||0)|0,Ot.divisor=(Bt.divisor||0)|0,Ot.state=1,V(Ot.size>=1&&Ot.size<=4,"size must be between 1 and 4"),V(Ot.offset>=0,"invalid offset"),V(Ot.stride>=0&&Ot.stride<=255,"stride must be between 0 and 255"),V(Ot.divisor>=0,"divisor must be positive"),V(!Ot.divisor||!!B.angle_instanced_arrays,"ANGLE_instanced_arrays must be enabled to use divisor")):"x"in Bt?(V(Wt>0,"first attribute must not be a constant"),Ot.x=+Bt.x||0,Ot.y=+Bt.y||0,Ot.z=+Bt.z||0,Ot.w=+Bt.w||0,Ot.state=2):V(!1,"invalid attribute spec for location "+Wt)}for(var Zt=0;Zt<Ht.buffers.length;++Zt)!ie[Zt]&&Ht.buffers[Zt]&&(Ht.buffers[Zt].destroy(),Ht.buffers[Zt]=null);return Ht.refresh(),Gt}return Gt.destroy=function(){for(var Vt=0;Vt<Ht.buffers.length;++Vt)Ht.buffers[Vt]&&Ht.buffers[Vt].destroy();Ht.buffers.length=0,Ht.destroy()},Gt._vao=Ht,Gt._reglType="vao",Gt(Ct)}return Rt}var ja=35632,sh=35633,oh=35718,uh=35721;function hh(g,B,K,dt){var Lt={},ft={};function bt(ht,xt,Mt,jt){this.name=ht,this.id=xt,this.location=Mt,this.info=jt}function It(ht,xt){for(var Mt=0;Mt<ht.length;++Mt)if(ht[Mt].id===xt.id){ht[Mt].location=xt.location;return}ht.push(xt)}function Nt(ht,xt,Mt){var jt=ht===ja?Lt:ft,At=jt[xt];if(!At){var Kt=B.str(xt);At=g.createShader(ht),g.shaderSource(At,Kt),g.compileShader(At),V.shaderError(g,At,Kt,ht,Mt),jt[xt]=At}return At}var Ft={},Rt=[],zt=0;function Xt(ht,xt){this.id=zt++,this.fragId=ht,this.vertId=xt,this.program=null,this.uniforms=[],this.attributes=[],this.refCount=1,dt.profile&&(this.stats={uniformsCount:0,attributesCount:0})}function Dt(ht,xt,Mt){var jt,At,Kt=Nt(ja,ht.fragId),Ct=Nt(sh,ht.vertId),Ht=ht.program=g.createProgram();if(g.attachShader(Ht,Kt),g.attachShader(Ht,Ct),Mt)for(jt=0;jt<Mt.length;++jt){var Gt=Mt[jt];g.bindAttribLocation(Ht,Gt[0],Gt[1])}g.linkProgram(Ht),V.linkError(g,Ht,B.str(ht.fragId),B.str(ht.vertId),xt);var Vt=g.getProgramParameter(Ht,oh);dt.profile&&(ht.stats.uniformsCount=Vt);var ie=ht.uniforms;for(jt=0;jt<Vt;++jt)if(At=g.getActiveUniform(Ht,jt),At)if(At.size>1)for(var oe=0;oe<At.size;++oe){var Wt=At.name.replace("[0]","["+oe+"]");It(ie,new bt(Wt,B.id(Wt),g.getUniformLocation(Ht,Wt),At))}else It(ie,new bt(At.name,B.id(At.name),g.getUniformLocation(Ht,At.name),At));var Bt=g.getProgramParameter(Ht,uh);dt.profile&&(ht.stats.attributesCount=Bt);var Ot=ht.attributes;for(jt=0;jt<Bt;++jt)At=g.getActiveAttrib(Ht,jt),At&&It(Ot,new bt(At.name,B.id(At.name),g.getAttribLocation(Ht,At.name),At))}dt.profile&&(K.getMaxUniformsCount=function(){var ht=0;return Rt.forEach(function(xt){xt.stats.uniformsCount>ht&&(ht=xt.stats.uniformsCount)}),ht},K.getMaxAttributesCount=function(){var ht=0;return Rt.forEach(function(xt){xt.stats.attributesCount>ht&&(ht=xt.stats.attributesCount)}),ht});function Ut(){Lt={},ft={};for(var ht=0;ht<Rt.length;++ht)Dt(Rt[ht],null,Rt[ht].attributes.map(function(xt){return[xt.location,xt.name]}))}return{clear:function(){var ht=g.deleteShader.bind(g);Qe(Lt).forEach(ht),Lt={},Qe(ft).forEach(ht),ft={},Rt.forEach(function(xt){g.deleteProgram(xt.program)}),Rt.length=0,Ft={},K.shaderCount=0},program:function(ht,xt,Mt,jt){V.command(ht>=0,"missing vertex shader",Mt),V.command(xt>=0,"missing fragment shader",Mt);var At=Ft[xt];At||(At=Ft[xt]={});var Kt=At[ht];if(Kt&&(Kt.refCount++,!jt))return Kt;var Ct=new Xt(xt,ht);return K.shaderCount++,Dt(Ct,Mt,jt),Kt||(At[ht]=Ct),Rt.push(Ct),r(Ct,{destroy:function(){if(Ct.refCount--,Ct.refCount<=0){g.deleteProgram(Ct.program);var Ht=Rt.indexOf(Ct);Rt.splice(Ht,1),K.shaderCount--}At[Ct.vertId].refCount<=0&&(g.deleteShader(ft[Ct.vertId]),delete ft[Ct.vertId],delete Ft[Ct.fragId][Ct.vertId]),Object.keys(Ft[Ct.fragId]).length||(g.deleteShader(Lt[Ct.fragId]),delete Lt[Ct.fragId],delete Ft[Ct.fragId])}})},restore:Ut,shader:Nt,frag:-1,vert:-1}}var lh=6408,Kr=5121,ph=3333,Ei=5126;function ch(g,B,K,dt,Lt,ft,bt){function It(Rt){var zt;B.next===null?(V(Lt.preserveDrawingBuffer,'you must create a webgl context with "preserveDrawingBuffer":true in order to read pixels from the drawing buffer'),zt=Kr):(V(B.next.colorAttachments[0].texture!==null,"You cannot read from a renderbuffer"),zt=B.next.colorAttachments[0].texture._texture.type,ft.oes_texture_float?(V(zt===Kr||zt===Ei,"Reading from a framebuffer is only allowed for the types 'uint8' and 'float'"),zt===Ei&&V(bt.readFloat,"Reading 'float' values is not permitted in your browser. For a fallback, please see: https://www.npmjs.com/package/glsl-read-float")):V(zt===Kr,"Reading from a framebuffer is only allowed for the type 'uint8'"));var Xt=0,Dt=0,Ut=dt.framebufferWidth,ht=dt.framebufferHeight,xt=null;n(Rt)?xt=Rt:Rt&&(V.type(Rt,"object","invalid arguments to regl.read()"),Xt=Rt.x|0,Dt=Rt.y|0,V(Xt>=0&&Xt<dt.framebufferWidth,"invalid x offset for regl.read"),V(Dt>=0&&Dt<dt.framebufferHeight,"invalid y offset for regl.read"),Ut=(Rt.width||dt.framebufferWidth-Xt)|0,ht=(Rt.height||dt.framebufferHeight-Dt)|0,xt=Rt.data||null),xt&&(zt===Kr?V(xt instanceof Uint8Array,"buffer must be 'Uint8Array' when reading from a framebuffer of type 'uint8'"):zt===Ei&&V(xt instanceof Float32Array,"buffer must be 'Float32Array' when reading from a framebuffer of type 'float'")),V(Ut>0&&Ut+Xt<=dt.framebufferWidth,"invalid width for read pixels"),V(ht>0&&ht+Dt<=dt.framebufferHeight,"invalid height for read pixels"),K();var Mt=Ut*ht*4;return xt||(zt===Kr?xt=new Uint8Array(Mt):zt===Ei&&(xt=xt||new Float32Array(Mt))),V.isTypedArray(xt,"data buffer for regl.read() must be a typedarray"),V(xt.byteLength>=Mt,"data buffer for regl.read() too small"),g.pixelStorei(ph,4),g.readPixels(Xt,Dt,Ut,ht,lh,zt,xt),xt}function Nt(Rt){var zt;return B.setFBO({framebuffer:Rt.framebuffer},function(){zt=It(Rt)}),zt}function Ft(Rt){return!Rt||!("framebuffer"in Rt)?It(Rt):Nt(Rt)}return Ft}function Pr(g){return Array.prototype.slice.call(g)}function Mr(g){return Pr(g).join("")}function fh(){var g=0,B=[],K=[];function dt(zt){for(var Xt=0;Xt<K.length;++Xt)if(K[Xt]===zt)return B[Xt];var Dt="g"+g++;return B.push(Dt),K.push(zt),Dt}function Lt(){var zt=[];function Xt(){zt.push.apply(zt,Pr(arguments))}var Dt=[];function Ut(){var ht="v"+g++;return Dt.push(ht),arguments.length>0&&(zt.push(ht,"="),zt.push.apply(zt,Pr(arguments)),zt.push(";")),ht}return r(Xt,{def:Ut,toString:function(){return Mr([Dt.length>0?"var "+Dt.join(",")+";":"",Mr(zt)])}})}function ft(){var zt=Lt(),Xt=Lt(),Dt=zt.toString,Ut=Xt.toString;function ht(xt,Mt){Xt(xt,Mt,"=",zt.def(xt,Mt),";")}return r(function(){zt.apply(zt,Pr(arguments))},{def:zt.def,entry:zt,exit:Xt,save:ht,set:function(xt,Mt,jt){ht(xt,Mt),zt(xt,Mt,"=",jt,";")},toString:function(){return Dt()+Ut()}})}function bt(){var zt=Mr(arguments),Xt=ft(),Dt=ft(),Ut=Xt.toString,ht=Dt.toString;return r(Xt,{then:function(){return Xt.apply(Xt,Pr(arguments)),this},else:function(){return Dt.apply(Dt,Pr(arguments)),this},toString:function(){var xt=ht();return xt&&(xt="else{"+xt+"}"),Mr(["if(",zt,"){",Ut(),"}",xt])}})}var It=Lt(),Nt={};function Ft(zt,Xt){var Dt=[];function Ut(){var At="a"+Dt.length;return Dt.push(At),At}Xt=Xt||0;for(var ht=0;ht<Xt;++ht)Ut();var xt=ft(),Mt=xt.toString,jt=Nt[zt]=r(xt,{arg:Ut,toString:function(){return Mr(["function(",Dt.join(),"){",Mt(),"}"])}});return jt}function Rt(){var zt=['"use strict";',It,"return {"];Object.keys(Nt).forEach(function(Ut){zt.push('"',Ut,'":',Nt[Ut].toString(),",")}),zt.push("}");var Xt=Mr(zt).replace(/;/g,`;
`).replace(/}/g,`}
`).replace(/{/g,`{
`),Dt=Function.apply(null,B.concat(Xt));return Dt.apply(null,K)}return{global:It,link:dt,block:Lt,proc:Ft,scope:ft,cond:bt,compile:Rt}}var Fr="xyzw".split(""),Ya=5121,Br=1,fn=2,dn=0,vn=1,_n=2,gn=3,Ti=4,$a=5,Ka=6,Qa="dither",Za="blend.enable",Ja="blend.color",mn="blend.equation",yn="blend.func",ts="depth.enable",es="depth.func",rs="depth.range",is="depth.mask",bn="colorMask",ns="cull.enable",as="cull.face",xn="frontFace",En="lineWidth",ss="polygonOffset.enable",Tn="polygonOffset.offset",os="sample.alpha",us="sample.enable",wn="sample.coverage",hs="stencil.enable",ls="stencil.mask",Ln="stencil.func",Sn="stencil.opFront",Qr="stencil.opBack",ps="scissor.enable",wi="scissor.box",ur="viewport",Zr="profile",xr="framebuffer",Jr="vert",ti="frag",Er="elements",Tr="primitive",wr="count",Li="offset",Si="instances",ei="vao",On="Width",An="Height",zr=xr+On,Ur=xr+An,dh=ur+On,vh=ur+An,cs="drawingBuffer",fs=cs+On,ds=cs+An,_h=[yn,mn,Ln,Sn,Qr,wn,ur,wi,Tn],Hr=34962,gh=34963,mh=35632,yh=35633,vs=3553,bh=34067,xh=2884,Eh=3042,Th=3024,wh=2960,Lh=2929,Sh=3089,Oh=32823,Ah=32926,Gh=32928,Gn=5126,Oi=35664,Ai=35665,Gi=35666,Cn=5124,Ci=35667,Ii=35668,Di=35669,In=35670,Ni=35671,Ri=35672,ki=35673,ri=35674,ii=35675,ni=35676,ai=35678,si=35680,_s=4,oi=1028,Lr=1029,gs=2304,Dn=2305,Ch=32775,Ih=32776,Dh=519,pr=7680,ms=0,ys=1,bs=32774,Nh=513,xs=36160,Rh=36064,ar={0:0,1:1,zero:0,one:1,"src color":768,"one minus src color":769,"src alpha":770,"one minus src alpha":771,"dst color":774,"one minus dst color":775,"dst alpha":772,"one minus dst alpha":773,"constant color":32769,"one minus constant color":32770,"constant alpha":32771,"one minus constant alpha":32772,"src alpha saturate":776},Es=["constant color, constant alpha","one minus constant color, constant alpha","constant color, one minus constant alpha","one minus constant color, one minus constant alpha","constant alpha, constant color","constant alpha, one minus constant color","one minus constant alpha, constant color","one minus constant alpha, one minus constant color"],Vr={never:512,less:513,"<":513,equal:514,"=":514,"==":514,"===":514,lequal:515,"<=":515,greater:516,">":516,notequal:517,"!=":517,"!==":517,gequal:518,">=":518,always:519},cr={0:0,zero:0,keep:7680,replace:7681,increment:7682,decrement:7683,"increment wrap":34055,"decrement wrap":34056,invert:5386},Ts={frag:mh,vert:yh},Nn={cw:gs,ccw:Dn};function Pi(g){return Array.isArray(g)||n(g)||tr(g)}function ws(g){return g.sort(function(B,K){return B===ur?-1:K===ur?1:B<K?-1:1})}function qe(g,B,K,dt){this.thisDep=g,this.contextDep=B,this.propDep=K,this.append=dt}function fr(g){return g&&!(g.thisDep||g.contextDep||g.propDep)}function Ne(g){return new qe(!1,!1,!1,g)}function $e(g,B){var K=g.type;if(K===dn){var dt=g.data.length;return new qe(!0,dt>=1,dt>=2,B)}else if(K===Ti){var Lt=g.data;return new qe(Lt.thisDep,Lt.contextDep,Lt.propDep,B)}else{if(K===$a)return new qe(!1,!1,!1,B);if(K===Ka){for(var ft=!1,bt=!1,It=!1,Nt=0;Nt<g.data.length;++Nt){var Ft=g.data[Nt];if(Ft.type===vn)It=!0;else if(Ft.type===_n)bt=!0;else if(Ft.type===gn)ft=!0;else if(Ft.type===dn){ft=!0;var Rt=Ft.data;Rt>=1&&(bt=!0),Rt>=2&&(It=!0)}else Ft.type===Ti&&(ft=ft||Ft.data.thisDep,bt=bt||Ft.data.contextDep,It=It||Ft.data.propDep)}return new qe(ft,bt,It,B)}else return new qe(K===gn,K===_n,K===vn,B)}}var Ls=new qe(!1,!1,!1,function(){});function kh(g,B,K,dt,Lt,ft,bt,It,Nt,Ft,Rt,zt,Xt,Dt,Ut){var ht=Ft.Record,xt={add:32774,subtract:32778,"reverse subtract":32779};K.ext_blend_minmax&&(xt.min=Ch,xt.max=Ih);var Mt=K.angle_instanced_arrays,jt=K.webgl_draw_buffers,At={dirty:!0,profile:Ut.profile},Kt={},Ct=[],Ht={},Gt={};function Vt(X){return X.replace(".","_")}function ie(X,k,tt){var ot=Vt(X);Ct.push(X),Kt[ot]=At[ot]=!!tt,Ht[ot]=k}function oe(X,k,tt){var ot=Vt(X);Ct.push(X),Array.isArray(tt)?(At[ot]=tt.slice(),Kt[ot]=tt.slice()):At[ot]=Kt[ot]=tt,Gt[ot]=k}ie(Qa,Th),ie(Za,Eh),oe(Ja,"blendColor",[0,0,0,0]),oe(mn,"blendEquationSeparate",[bs,bs]),oe(yn,"blendFuncSeparate",[ys,ms,ys,ms]),ie(ts,Lh,!0),oe(es,"depthFunc",Nh),oe(rs,"depthRange",[0,1]),oe(is,"depthMask",!0),oe(bn,bn,[!0,!0,!0,!0]),ie(ns,xh),oe(as,"cullFace",Lr),oe(xn,xn,Dn),oe(En,En,1),ie(ss,Oh),oe(Tn,"polygonOffset",[0,0]),ie(os,Ah),ie(us,Gh),oe(wn,"sampleCoverage",[1,!1]),ie(hs,wh),oe(ls,"stencilMask",-1),oe(Ln,"stencilFunc",[Dh,0,-1]),oe(Sn,"stencilOpSeparate",[oi,pr,pr,pr]),oe(Qr,"stencilOpSeparate",[Lr,pr,pr,pr]),ie(ps,Sh),oe(wi,"scissor",[0,0,g.drawingBufferWidth,g.drawingBufferHeight]),oe(ur,ur,[0,0,g.drawingBufferWidth,g.drawingBufferHeight]);var Wt={gl:g,context:Xt,strings:B,next:Kt,current:At,draw:zt,elements:ft,buffer:Lt,shader:Rt,attributes:Ft.state,vao:Ft,uniforms:Nt,framebuffer:It,extensions:K,timer:Dt,isBufferArgs:Pi},Bt={primTypes:Ar,compareFuncs:Vr,blendFuncs:ar,blendEquations:xt,stencilOps:cr,glTypes:_r,orientationType:Nn};V.optional(function(){Wt.isArrayLike=Ge}),jt&&(Bt.backBuffer=[Lr],Bt.drawBuffer=Ye(dt.maxDrawbuffers,function(X){return X===0?[0]:Ye(X,function(k){return Rh+k})}));var Ot=0;function se(){var X=fh(),k=X.link,tt=X.global;X.id=Ot++,X.batchId="0";var ot=k(Wt),lt=X.shared={props:"a0"};Object.keys(Wt).forEach(function(J){lt[J]=tt.def(ot,".",J)}),V.optional(function(){X.CHECK=k(V),X.commandStr=V.guessCommand(),X.command=k(X.commandStr),X.assert=function(J,U,at){J("if(!(",U,"))",this.CHECK,".commandRaise(",k(at),",",this.command,");")},Bt.invalidBlendCombinations=Es});var rt=X.next={},et=X.current={};Object.keys(Gt).forEach(function(J){Array.isArray(At[J])&&(rt[J]=tt.def(lt.next,".",J),et[J]=tt.def(lt.current,".",J))});var nt=X.constants={};Object.keys(Bt).forEach(function(J){nt[J]=tt.def(JSON.stringify(Bt[J]))}),X.invoke=function(J,U){switch(U.type){case dn:var at=["this",lt.context,lt.props,X.batchId];return J.def(k(U.data),".call(",at.slice(0,Math.max(U.data.length+1,4)),")");case vn:return J.def(lt.props,U.data);case _n:return J.def(lt.context,U.data);case gn:return J.def("this",U.data);case Ti:return U.data.append(X,J),U.data.ref;case $a:return U.data.toString();case Ka:return U.data.map(function(pt){return X.invoke(J,pt)})}},X.attribCache={};var W={};return X.scopeAttrib=function(J){var U=B.id(J);if(U in W)return W[U];var at=Ft.scope[U];at||(at=Ft.scope[U]=new ht);var pt=W[U]=k(at);return pt},X}function fe(X){var k=X.static,tt=X.dynamic,ot;if(Zr in k){var lt=!!k[Zr];ot=Ne(function(et,nt){return lt}),ot.enable=lt}else if(Zr in tt){var rt=tt[Zr];ot=$e(rt,function(et,nt){return et.invoke(nt,rt)})}return ot}function Zt(X,k){var tt=X.static,ot=X.dynamic;if(xr in tt){var lt=tt[xr];return lt?(lt=It.getFramebuffer(lt),V.command(lt,"invalid framebuffer object"),Ne(function(et,nt){var W=et.link(lt),J=et.shared;nt.set(J.framebuffer,".next",W);var U=J.context;return nt.set(U,"."+zr,W+".width"),nt.set(U,"."+Ur,W+".height"),W})):Ne(function(et,nt){var W=et.shared;nt.set(W.framebuffer,".next","null");var J=W.context;return nt.set(J,"."+zr,J+"."+fs),nt.set(J,"."+Ur,J+"."+ds),"null"})}else if(xr in ot){var rt=ot[xr];return $e(rt,function(et,nt){var W=et.invoke(nt,rt),J=et.shared,U=J.framebuffer,at=nt.def(U,".getFramebuffer(",W,")");V.optional(function(){et.assert(nt,"!"+W+"||"+at,"invalid framebuffer object")}),nt.set(U,".next",at);var pt=J.context;return nt.set(pt,"."+zr,at+"?"+at+".width:"+pt+"."+fs),nt.set(pt,"."+Ur,at+"?"+at+".height:"+pt+"."+ds),at})}else return null}function ge(X,k,tt){var ot=X.static,lt=X.dynamic;function rt(W){if(W in ot){var J=ot[W];V.commandType(J,"object","invalid "+W,tt.commandStr);var U=!0,at=J.x|0,pt=J.y|0,wt,St;return"width"in J?(wt=J.width|0,V.command(wt>=0,"invalid "+W,tt.commandStr)):U=!1,"height"in J?(St=J.height|0,V.command(St>=0,"invalid "+W,tt.commandStr)):U=!1,new qe(!U&&k&&k.thisDep,!U&&k&&k.contextDep,!U&&k&&k.propDep,function(ee,ve){var Jt=ee.shared.context,ae=wt;"width"in J||(ae=ve.def(Jt,".",zr,"-",at));var he=St;return"height"in J||(he=ve.def(Jt,".",Ur,"-",pt)),[at,pt,ae,he]})}else if(W in lt){var Et=lt[W],Pt=$e(Et,function(ee,ve){var Jt=ee.invoke(ve,Et);V.optional(function(){ee.assert(ve,Jt+"&&typeof "+Jt+'==="object"',"invalid "+W)});var ae=ee.shared.context,he=ve.def(Jt,".x|0"),Le=ve.def(Jt,".y|0"),Ae=ve.def('"width" in ',Jt,"?",Jt,".width|0:","(",ae,".",zr,"-",he,")"),je=ve.def('"height" in ',Jt,"?",Jt,".height|0:","(",ae,".",Ur,"-",Le,")");return V.optional(function(){ee.assert(ve,Ae+">=0&&"+je+">=0","invalid "+W)}),[he,Le,Ae,je]});return k&&(Pt.thisDep=Pt.thisDep||k.thisDep,Pt.contextDep=Pt.contextDep||k.contextDep,Pt.propDep=Pt.propDep||k.propDep),Pt}else return k?new qe(k.thisDep,k.contextDep,k.propDep,function(ee,ve){var Jt=ee.shared.context;return[0,0,ve.def(Jt,".",zr),ve.def(Jt,".",Ur)]}):null}var et=rt(ur);if(et){var nt=et;et=new qe(et.thisDep,et.contextDep,et.propDep,function(W,J){var U=nt.append(W,J),at=W.shared.context;return J.set(at,"."+dh,U[2]),J.set(at,"."+vh,U[3]),U})}return{viewport:et,scissor_box:rt(wi)}}function ue(X,k){var tt=X.static,ot=typeof tt[ti]=="string"&&typeof tt[Jr]=="string";if(ot){if(Object.keys(k.dynamic).length>0)return null;var lt=k.static,rt=Object.keys(lt);if(rt.length>0&&typeof lt[rt[0]]=="number"){for(var et=[],nt=0;nt<rt.length;++nt)V(typeof lt[rt[nt]]=="number","must specify all vertex attribute locations when using vaos"),et.push([lt[rt[nt]]|0,rt[nt]]);return et}}return null}function _e(X,k,tt){var ot=X.static,lt=X.dynamic;function rt(U){if(U in ot){var at=B.id(ot[U]);V.optional(function(){Rt.shader(Ts[U],at,V.guessCommand())});var pt=Ne(function(){return at});return pt.id=at,pt}else if(U in lt){var wt=lt[U];return $e(wt,function(St,Et){var Pt=St.invoke(Et,wt),ee=Et.def(St.shared.strings,".id(",Pt,")");return V.optional(function(){Et(St.shared.shader,".shader(",Ts[U],",",ee,",",St.command,");")}),ee})}return null}var et=rt(ti),nt=rt(Jr),W=null,J;return fr(et)&&fr(nt)?(W=Rt.program(nt.id,et.id,null,tt),J=Ne(function(U,at){return U.link(W)})):J=new qe(et&&et.thisDep||nt&&nt.thisDep,et&&et.contextDep||nt&&nt.contextDep,et&&et.propDep||nt&&nt.propDep,function(U,at){var pt=U.shared.shader,wt;et?wt=et.append(U,at):wt=at.def(pt,".",ti);var St;nt?St=nt.append(U,at):St=at.def(pt,".",Jr);var Et=pt+".program("+St+","+wt;return V.optional(function(){Et+=","+U.command}),at.def(Et+")")}),{frag:et,vert:nt,progVar:J,program:W}}function we(X,k){var tt=X.static,ot=X.dynamic;function lt(){if(Er in tt){var U=tt[Er];Pi(U)?U=ft.getElements(ft.create(U,!0)):U&&(U=ft.getElements(U),V.command(U,"invalid elements",k.commandStr));var at=Ne(function(wt,St){if(U){var Et=wt.link(U);return wt.ELEMENTS=Et,Et}return wt.ELEMENTS=null,null});return at.value=U,at}else if(Er in ot){var pt=ot[Er];return $e(pt,function(wt,St){var Et=wt.shared,Pt=Et.isBufferArgs,ee=Et.elements,ve=wt.invoke(St,pt),Jt=St.def("null"),ae=St.def(Pt,"(",ve,")"),he=wt.cond(ae).then(Jt,"=",ee,".createStream(",ve,");").else(Jt,"=",ee,".getElements(",ve,");");return V.optional(function(){wt.assert(he.else,"!"+ve+"||"+Jt,"invalid elements")}),St.entry(he),St.exit(wt.cond(ae).then(ee,".destroyStream(",Jt,");")),wt.ELEMENTS=Jt,Jt})}return null}var rt=lt();function et(){if(Tr in tt){var U=tt[Tr];return V.commandParameter(U,Ar,"invalid primitve",k.commandStr),Ne(function(pt,wt){return Ar[U]})}else if(Tr in ot){var at=ot[Tr];return $e(at,function(pt,wt){var St=pt.constants.primTypes,Et=pt.invoke(wt,at);return V.optional(function(){pt.assert(wt,Et+" in "+St,"invalid primitive, must be one of "+Object.keys(Ar))}),wt.def(St,"[",Et,"]")})}else if(rt)return fr(rt)?rt.value?Ne(function(pt,wt){return wt.def(pt.ELEMENTS,".primType")}):Ne(function(){return _s}):new qe(rt.thisDep,rt.contextDep,rt.propDep,function(pt,wt){var St=pt.ELEMENTS;return wt.def(St,"?",St,".primType:",_s)});return null}function nt(U,at){if(U in tt){var pt=tt[U]|0;return V.command(!at||pt>=0,"invalid "+U,k.commandStr),Ne(function(St,Et){return at&&(St.OFFSET=pt),pt})}else if(U in ot){var wt=ot[U];return $e(wt,function(St,Et){var Pt=St.invoke(Et,wt);return at&&(St.OFFSET=Pt,V.optional(function(){St.assert(Et,Pt+">=0","invalid "+U)})),Pt})}else if(at&&rt)return Ne(function(St,Et){return St.OFFSET="0",0});return null}var W=nt(Li,!0);function J(){if(wr in tt){var U=tt[wr]|0;return V.command(typeof U=="number"&&U>=0,"invalid vertex count",k.commandStr),Ne(function(){return U})}else if(wr in ot){var at=ot[wr];return $e(at,function(St,Et){var Pt=St.invoke(Et,at);return V.optional(function(){St.assert(Et,"typeof "+Pt+'==="number"&&'+Pt+">=0&&"+Pt+"===("+Pt+"|0)","invalid vertex count")}),Pt})}else if(rt)if(fr(rt)){if(rt)return W?new qe(W.thisDep,W.contextDep,W.propDep,function(St,Et){var Pt=Et.def(St.ELEMENTS,".vertCount-",St.OFFSET);return V.optional(function(){St.assert(Et,Pt+">=0","invalid vertex offset/element buffer too small")}),Pt}):Ne(function(St,Et){return Et.def(St.ELEMENTS,".vertCount")});var pt=Ne(function(){return-1});return V.optional(function(){pt.MISSING=!0}),pt}else{var wt=new qe(rt.thisDep||W.thisDep,rt.contextDep||W.contextDep,rt.propDep||W.propDep,function(St,Et){var Pt=St.ELEMENTS;return St.OFFSET?Et.def(Pt,"?",Pt,".vertCount-",St.OFFSET,":-1"):Et.def(Pt,"?",Pt,".vertCount:-1")});return V.optional(function(){wt.DYNAMIC=!0}),wt}return null}return{elements:rt,primitive:et(),count:J(),instances:nt(Si,!1),offset:W}}function Re(X,k){var tt=X.static,ot=X.dynamic,lt={};return Ct.forEach(function(rt){var et=Vt(rt);function nt(W,J){if(rt in tt){var U=W(tt[rt]);lt[et]=Ne(function(){return U})}else if(rt in ot){var at=ot[rt];lt[et]=$e(at,function(pt,wt){return J(pt,wt,pt.invoke(wt,at))})}}switch(rt){case ns:case Za:case Qa:case hs:case ts:case ps:case ss:case os:case us:case is:return nt(function(W){return V.commandType(W,"boolean",rt,k.commandStr),W},function(W,J,U){return V.optional(function(){W.assert(J,"typeof "+U+'==="boolean"',"invalid flag "+rt,W.commandStr)}),U});case es:return nt(function(W){return V.commandParameter(W,Vr,"invalid "+rt,k.commandStr),Vr[W]},function(W,J,U){var at=W.constants.compareFuncs;return V.optional(function(){W.assert(J,U+" in "+at,"invalid "+rt+", must be one of "+Object.keys(Vr))}),J.def(at,"[",U,"]")});case rs:return nt(function(W){return V.command(Ge(W)&&W.length===2&&typeof W[0]=="number"&&typeof W[1]=="number"&&W[0]<=W[1],"depth range is 2d array",k.commandStr),W},function(W,J,U){V.optional(function(){W.assert(J,W.shared.isArrayLike+"("+U+")&&"+U+".length===2&&typeof "+U+'[0]==="number"&&typeof '+U+'[1]==="number"&&'+U+"[0]<="+U+"[1]","depth range must be a 2d array")});var at=J.def("+",U,"[0]"),pt=J.def("+",U,"[1]");return[at,pt]});case yn:return nt(function(W){V.commandType(W,"object","blend.func",k.commandStr);var J="srcRGB"in W?W.srcRGB:W.src,U="srcAlpha"in W?W.srcAlpha:W.src,at="dstRGB"in W?W.dstRGB:W.dst,pt="dstAlpha"in W?W.dstAlpha:W.dst;return V.commandParameter(J,ar,et+".srcRGB",k.commandStr),V.commandParameter(U,ar,et+".srcAlpha",k.commandStr),V.commandParameter(at,ar,et+".dstRGB",k.commandStr),V.commandParameter(pt,ar,et+".dstAlpha",k.commandStr),V.command(Es.indexOf(J+", "+at)===-1,"unallowed blending combination (srcRGB, dstRGB) = ("+J+", "+at+")",k.commandStr),[ar[J],ar[at],ar[U],ar[pt]]},function(W,J,U){var at=W.constants.blendFuncs;V.optional(function(){W.assert(J,U+"&&typeof "+U+'==="object"',"invalid blend func, must be an object")});function pt(Jt,ae){var he=J.def('"',Jt,ae,'" in ',U,"?",U,".",Jt,ae,":",U,".",Jt);return V.optional(function(){W.assert(J,he+" in "+at,"invalid "+rt+"."+Jt+ae+", must be one of "+Object.keys(ar))}),he}var wt=pt("src","RGB"),St=pt("dst","RGB");V.optional(function(){var Jt=W.constants.invalidBlendCombinations;W.assert(J,Jt+".indexOf("+wt+'+", "+'+St+") === -1 ","unallowed blending combination for (srcRGB, dstRGB)")});var Et=J.def(at,"[",wt,"]"),Pt=J.def(at,"[",pt("src","Alpha"),"]"),ee=J.def(at,"[",St,"]"),ve=J.def(at,"[",pt("dst","Alpha"),"]");return[Et,ee,Pt,ve]});case mn:return nt(function(W){if(typeof W=="string")return V.commandParameter(W,xt,"invalid "+rt,k.commandStr),[xt[W],xt[W]];if(typeof W=="object")return V.commandParameter(W.rgb,xt,rt+".rgb",k.commandStr),V.commandParameter(W.alpha,xt,rt+".alpha",k.commandStr),[xt[W.rgb],xt[W.alpha]];V.commandRaise("invalid blend.equation",k.commandStr)},function(W,J,U){var at=W.constants.blendEquations,pt=J.def(),wt=J.def(),St=W.cond("typeof ",U,'==="string"');return V.optional(function(){function Et(Pt,ee,ve){W.assert(Pt,ve+" in "+at,"invalid "+ee+", must be one of "+Object.keys(xt))}Et(St.then,rt,U),W.assert(St.else,U+"&&typeof "+U+'==="object"',"invalid "+rt),Et(St.else,rt+".rgb",U+".rgb"),Et(St.else,rt+".alpha",U+".alpha")}),St.then(pt,"=",wt,"=",at,"[",U,"];"),St.else(pt,"=",at,"[",U,".rgb];",wt,"=",at,"[",U,".alpha];"),J(St),[pt,wt]});case Ja:return nt(function(W){return V.command(Ge(W)&&W.length===4,"blend.color must be a 4d array",k.commandStr),Ye(4,function(J){return+W[J]})},function(W,J,U){return V.optional(function(){W.assert(J,W.shared.isArrayLike+"("+U+")&&"+U+".length===4","blend.color must be a 4d array")}),Ye(4,function(at){return J.def("+",U,"[",at,"]")})});case ls:return nt(function(W){return V.commandType(W,"number",et,k.commandStr),W|0},function(W,J,U){return V.optional(function(){W.assert(J,"typeof "+U+'==="number"',"invalid stencil.mask")}),J.def(U,"|0")});case Ln:return nt(function(W){V.commandType(W,"object",et,k.commandStr);var J=W.cmp||"keep",U=W.ref||0,at="mask"in W?W.mask:-1;return V.commandParameter(J,Vr,rt+".cmp",k.commandStr),V.commandType(U,"number",rt+".ref",k.commandStr),V.commandType(at,"number",rt+".mask",k.commandStr),[Vr[J],U,at]},function(W,J,U){var at=W.constants.compareFuncs;V.optional(function(){function Et(){W.assert(J,Array.prototype.join.call(arguments,""),"invalid stencil.func")}Et(U+"&&typeof ",U,'==="object"'),Et('!("cmp" in ',U,")||(",U,".cmp in ",at,")")});var pt=J.def('"cmp" in ',U,"?",at,"[",U,".cmp]",":",pr),wt=J.def(U,".ref|0"),St=J.def('"mask" in ',U,"?",U,".mask|0:-1");return[pt,wt,St]});case Sn:case Qr:return nt(function(W){V.commandType(W,"object",et,k.commandStr);var J=W.fail||"keep",U=W.zfail||"keep",at=W.zpass||"keep";return V.commandParameter(J,cr,rt+".fail",k.commandStr),V.commandParameter(U,cr,rt+".zfail",k.commandStr),V.commandParameter(at,cr,rt+".zpass",k.commandStr),[rt===Qr?Lr:oi,cr[J],cr[U],cr[at]]},function(W,J,U){var at=W.constants.stencilOps;V.optional(function(){W.assert(J,U+"&&typeof "+U+'==="object"',"invalid "+rt)});function pt(wt){return V.optional(function(){W.assert(J,'!("'+wt+'" in '+U+")||("+U+"."+wt+" in "+at+")","invalid "+rt+"."+wt+", must be one of "+Object.keys(cr))}),J.def('"',wt,'" in ',U,"?",at,"[",U,".",wt,"]:",pr)}return[rt===Qr?Lr:oi,pt("fail"),pt("zfail"),pt("zpass")]});case Tn:return nt(function(W){V.commandType(W,"object",et,k.commandStr);var J=W.factor|0,U=W.units|0;return V.commandType(J,"number",et+".factor",k.commandStr),V.commandType(U,"number",et+".units",k.commandStr),[J,U]},function(W,J,U){V.optional(function(){W.assert(J,U+"&&typeof "+U+'==="object"',"invalid "+rt)});var at=J.def(U,".factor|0"),pt=J.def(U,".units|0");return[at,pt]});case as:return nt(function(W){var J=0;return W==="front"?J=oi:W==="back"&&(J=Lr),V.command(!!J,et,k.commandStr),J},function(W,J,U){return V.optional(function(){W.assert(J,U+'==="front"||'+U+'==="back"',"invalid cull.face")}),J.def(U,'==="front"?',oi,":",Lr)});case En:return nt(function(W){return V.command(typeof W=="number"&&W>=dt.lineWidthDims[0]&&W<=dt.lineWidthDims[1],"invalid line width, must be a positive number between "+dt.lineWidthDims[0]+" and "+dt.lineWidthDims[1],k.commandStr),W},function(W,J,U){return V.optional(function(){W.assert(J,"typeof "+U+'==="number"&&'+U+">="+dt.lineWidthDims[0]+"&&"+U+"<="+dt.lineWidthDims[1],"invalid line width")}),U});case xn:return nt(function(W){return V.commandParameter(W,Nn,et,k.commandStr),Nn[W]},function(W,J,U){return V.optional(function(){W.assert(J,U+'==="cw"||'+U+'==="ccw"',"invalid frontFace, must be one of cw,ccw")}),J.def(U+'==="cw"?'+gs+":"+Dn)});case bn:return nt(function(W){return V.command(Ge(W)&&W.length===4,"color.mask must be length 4 array",k.commandStr),W.map(function(J){return!!J})},function(W,J,U){return V.optional(function(){W.assert(J,W.shared.isArrayLike+"("+U+")&&"+U+".length===4","invalid color.mask")}),Ye(4,function(at){return"!!"+U+"["+at+"]"})});case wn:return nt(function(W){V.command(typeof W=="object"&&W,et,k.commandStr);var J="value"in W?W.value:1,U=!!W.invert;return V.command(typeof J=="number"&&J>=0&&J<=1,"sample.coverage.value must be a number between 0 and 1",k.commandStr),[J,U]},function(W,J,U){V.optional(function(){W.assert(J,U+"&&typeof "+U+'==="object"',"invalid sample.coverage")});var at=J.def('"value" in ',U,"?+",U,".value:1"),pt=J.def("!!",U,".invert");return[at,pt]})}}),lt}function ze(X,k){var tt=X.static,ot=X.dynamic,lt={};return Object.keys(tt).forEach(function(rt){var et=tt[rt],nt;if(typeof et=="number"||typeof et=="boolean")nt=Ne(function(){return et});else if(typeof et=="function"){var W=et._reglType;W==="texture2d"||W==="textureCube"?nt=Ne(function(J){return J.link(et)}):W==="framebuffer"||W==="framebufferCube"?(V.command(et.color.length>0,'missing color attachment for framebuffer sent to uniform "'+rt+'"',k.commandStr),nt=Ne(function(J){return J.link(et.color[0])})):V.commandRaise('invalid data for uniform "'+rt+'"',k.commandStr)}else Ge(et)?nt=Ne(function(J){var U=J.global.def("[",Ye(et.length,function(at){return V.command(typeof et[at]=="number"||typeof et[at]=="boolean","invalid uniform "+rt,J.commandStr),et[at]}),"]");return U}):V.commandRaise('invalid or missing data for uniform "'+rt+'"',k.commandStr);nt.value=et,lt[rt]=nt}),Object.keys(ot).forEach(function(rt){var et=ot[rt];lt[rt]=$e(et,function(nt,W){return nt.invoke(W,et)})}),lt}function xe(X,k){var tt=X.static,ot=X.dynamic,lt={};return Object.keys(tt).forEach(function(rt){var et=tt[rt],nt=B.id(rt),W=new ht;if(Pi(et))W.state=Br,W.buffer=Lt.getBuffer(Lt.create(et,Hr,!1,!0)),W.type=0;else{var J=Lt.getBuffer(et);if(J)W.state=Br,W.buffer=J,W.type=0;else if(V.command(typeof et=="object"&&et,"invalid data for attribute "+rt,k.commandStr),"constant"in et){var U=et.constant;W.buffer="null",W.state=fn,typeof U=="number"?W.x=U:(V.command(Ge(U)&&U.length>0&&U.length<=4,"invalid constant for attribute "+rt,k.commandStr),Fr.forEach(function(ee,ve){ve<U.length&&(W[ee]=U[ve])}))}else{Pi(et.buffer)?J=Lt.getBuffer(Lt.create(et.buffer,Hr,!1,!0)):J=Lt.getBuffer(et.buffer),V.command(!!J,'missing buffer for attribute "'+rt+'"',k.commandStr);var at=et.offset|0;V.command(at>=0,'invalid offset for attribute "'+rt+'"',k.commandStr);var pt=et.stride|0;V.command(pt>=0&&pt<256,'invalid stride for attribute "'+rt+'", must be integer betweeen [0, 255]',k.commandStr);var wt=et.size|0;V.command(!("size"in et)||wt>0&&wt<=4,'invalid size for attribute "'+rt+'", must be 1,2,3,4',k.commandStr);var St=!!et.normalized,Et=0;"type"in et&&(V.commandParameter(et.type,_r,"invalid type for attribute "+rt,k.commandStr),Et=_r[et.type]);var Pt=et.divisor|0;"divisor"in et&&(V.command(Pt===0||Mt,'cannot specify divisor for attribute "'+rt+'", instancing not supported',k.commandStr),V.command(Pt>=0,'invalid divisor for attribute "'+rt+'"',k.commandStr)),V.optional(function(){var ee=k.commandStr,ve=["buffer","offset","divisor","normalized","type","size","stride"];Object.keys(et).forEach(function(Jt){V.command(ve.indexOf(Jt)>=0,'unknown parameter "'+Jt+'" for attribute pointer "'+rt+'" (valid parameters are '+ve+")",ee)})}),W.buffer=J,W.state=Br,W.size=wt,W.normalized=St,W.type=Et||J.dtype,W.offset=at,W.stride=pt,W.divisor=Pt}}lt[rt]=Ne(function(ee,ve){var Jt=ee.attribCache;if(nt in Jt)return Jt[nt];var ae={isStream:!1};return Object.keys(W).forEach(function(he){ae[he]=W[he]}),W.buffer&&(ae.buffer=ee.link(W.buffer),ae.type=ae.type||ae.buffer+".dtype"),Jt[nt]=ae,ae})}),Object.keys(ot).forEach(function(rt){var et=ot[rt];function nt(W,J){var U=W.invoke(J,et),at=W.shared,pt=W.constants,wt=at.isBufferArgs,St=at.buffer;V.optional(function(){W.assert(J,U+"&&(typeof "+U+'==="object"||typeof '+U+'==="function")&&('+wt+"("+U+")||"+St+".getBuffer("+U+")||"+St+".getBuffer("+U+".buffer)||"+wt+"("+U+'.buffer)||("constant" in '+U+"&&(typeof "+U+'.constant==="number"||'+at.isArrayLike+"("+U+".constant))))",'invalid dynamic attribute "'+rt+'"')});var Et={isStream:J.def(!1)},Pt=new ht;Pt.state=Br,Object.keys(Pt).forEach(function(ae){Et[ae]=J.def(""+Pt[ae])});var ee=Et.buffer,ve=Et.type;J("if(",wt,"(",U,")){",Et.isStream,"=true;",ee,"=",St,".createStream(",Hr,",",U,");",ve,"=",ee,".dtype;","}else{",ee,"=",St,".getBuffer(",U,");","if(",ee,"){",ve,"=",ee,".dtype;",'}else if("constant" in ',U,"){",Et.state,"=",fn,";","if(typeof "+U+'.constant === "number"){',Et[Fr[0]],"=",U,".constant;",Fr.slice(1).map(function(ae){return Et[ae]}).join("="),"=0;","}else{",Fr.map(function(ae,he){return Et[ae]+"="+U+".constant.length>"+he+"?"+U+".constant["+he+"]:0;"}).join(""),"}}else{","if(",wt,"(",U,".buffer)){",ee,"=",St,".createStream(",Hr,",",U,".buffer);","}else{",ee,"=",St,".getBuffer(",U,".buffer);","}",ve,'="type" in ',U,"?",pt.glTypes,"[",U,".type]:",ee,".dtype;",Et.normalized,"=!!",U,".normalized;");function Jt(ae){J(Et[ae],"=",U,".",ae,"|0;")}return Jt("size"),Jt("offset"),Jt("stride"),Jt("divisor"),J("}}"),J.exit("if(",Et.isStream,"){",St,".destroyStream(",ee,");","}"),Et}lt[rt]=$e(et,nt)}),lt}function Pe(X,k){var tt=X.static,ot=X.dynamic;if(ei in tt){var lt=tt[ei];return lt!==null&&Ft.getVAO(lt)===null&&(lt=Ft.createVAO(lt)),Ne(function(et){return et.link(Ft.getVAO(lt))})}else if(ei in ot){var rt=ot[ei];return $e(rt,function(et,nt){var W=et.invoke(nt,rt);return nt.def(et.shared.vao+".getVAO("+W+")")})}return null}function Oe(X){var k=X.static,tt=X.dynamic,ot={};return Object.keys(k).forEach(function(lt){var rt=k[lt];ot[lt]=Ne(function(et,nt){return typeof rt=="number"||typeof rt=="boolean"?""+rt:et.link(rt)})}),Object.keys(tt).forEach(function(lt){var rt=tt[lt];ot[lt]=$e(rt,function(et,nt){return et.invoke(nt,rt)})}),ot}function ke(X,k,tt,ot,lt){var rt=X.static,et=X.dynamic;V.optional(function(){var Jt=[xr,Jr,ti,Er,Tr,Li,wr,Si,Zr,ei].concat(Ct);function ae(he){Object.keys(he).forEach(function(Le){V.command(Jt.indexOf(Le)>=0,'unknown parameter "'+Le+'"',lt.commandStr)})}ae(rt),ae(et)});var nt=ue(X,k),W=Zt(X),J=ge(X,W,lt),U=we(X,lt),at=Re(X,lt),pt=_e(X,lt,nt);function wt(Jt){var ae=J[Jt];ae&&(at[Jt]=ae)}wt(ur),wt(Vt(wi));var St=Object.keys(at).length>0,Et={framebuffer:W,draw:U,shader:pt,state:at,dirty:St,scopeVAO:null,drawVAO:null,useVAO:!1,attributes:{}};if(Et.profile=fe(X),Et.uniforms=ze(tt,lt),Et.drawVAO=Et.scopeVAO=Pe(X),!Et.drawVAO&&pt.program&&!nt&&K.angle_instanced_arrays){var Pt=!0,ee=pt.program.attributes.map(function(Jt){var ae=k.static[Jt];return Pt=Pt&&!!ae,ae});if(Pt&&ee.length>0){var ve=Ft.getVAO(Ft.createVAO(ee));Et.drawVAO=new qe(null,null,null,function(Jt,ae){return Jt.link(ve)}),Et.useVAO=!0}}return nt?Et.useVAO=!0:Et.attributes=xe(k,lt),Et.context=Oe(ot),Et}function Me(X,k,tt){var ot=X.shared,lt=ot.context,rt=X.scope();Object.keys(tt).forEach(function(et){k.save(lt,"."+et);var nt=tt[et],W=nt.append(X,k);Array.isArray(W)?rt(lt,".",et,"=[",W.join(),"];"):rt(lt,".",et,"=",W,";")}),k(rt)}function Fe(X,k,tt,ot){var lt=X.shared,rt=lt.gl,et=lt.framebuffer,nt;jt&&(nt=k.def(lt.extensions,".webgl_draw_buffers"));var W=X.constants,J=W.drawBuffer,U=W.backBuffer,at;tt?at=tt.append(X,k):at=k.def(et,".next"),ot||k("if(",at,"!==",et,".cur){"),k("if(",at,"){",rt,".bindFramebuffer(",xs,",",at,".framebuffer);"),jt&&k(nt,".drawBuffersWEBGL(",J,"[",at,".colorAttachments.length]);"),k("}else{",rt,".bindFramebuffer(",xs,",null);"),jt&&k(nt,".drawBuffersWEBGL(",U,");"),k("}",et,".cur=",at,";"),ot||k("}")}function Ue(X,k,tt){var ot=X.shared,lt=ot.gl,rt=X.current,et=X.next,nt=ot.current,W=ot.next,J=X.cond(nt,".dirty");Ct.forEach(function(U){var at=Vt(U);if(!(at in tt.state)){var pt,wt;if(at in et){pt=et[at],wt=rt[at];var St=Ye(At[at].length,function(Pt){return J.def(pt,"[",Pt,"]")});J(X.cond(St.map(function(Pt,ee){return Pt+"!=="+wt+"["+ee+"]"}).join("||")).then(lt,".",Gt[at],"(",St,");",St.map(function(Pt,ee){return wt+"["+ee+"]="+Pt}).join(";"),";"))}else{pt=J.def(W,".",at);var Et=X.cond(pt,"!==",nt,".",at);J(Et),at in Ht?Et(X.cond(pt).then(lt,".enable(",Ht[at],");").else(lt,".disable(",Ht[at],");"),nt,".",at,"=",pt,";"):Et(lt,".",Gt[at],"(",pt,");",nt,".",at,"=",pt,";")}}}),Object.keys(tt.state).length===0&&J(nt,".dirty=false;"),k(J)}function Xe(X,k,tt,ot){var lt=X.shared,rt=X.current,et=lt.current,nt=lt.gl;ws(Object.keys(tt)).forEach(function(W){var J=tt[W];if(!(ot&&!ot(J))){var U=J.append(X,k);if(Ht[W]){var at=Ht[W];fr(J)?U?k(nt,".enable(",at,");"):k(nt,".disable(",at,");"):k(X.cond(U).then(nt,".enable(",at,");").else(nt,".disable(",at,");")),k(et,".",W,"=",U,";")}else if(Ge(U)){var pt=rt[W];k(nt,".",Gt[W],"(",U,");",U.map(function(wt,St){return pt+"["+St+"]="+wt}).join(";"),";")}else k(nt,".",Gt[W],"(",U,");",et,".",W,"=",U,";")}})}function Ce(X,k){Mt&&(X.instancing=k.def(X.shared.extensions,".angle_instanced_arrays"))}function de(X,k,tt,ot,lt){var rt=X.shared,et=X.stats,nt=rt.current,W=rt.timer,J=tt.profile;function U(){return typeof performance>"u"?"Date.now()":"performance.now()"}var at,pt;function wt(Jt){at=k.def(),Jt(at,"=",U(),";"),typeof lt=="string"?Jt(et,".count+=",lt,";"):Jt(et,".count++;"),Dt&&(ot?(pt=k.def(),Jt(pt,"=",W,".getNumPendingQueries();")):Jt(W,".beginQuery(",et,");"))}function St(Jt){Jt(et,".cpuTime+=",U(),"-",at,";"),Dt&&(ot?Jt(W,".pushScopeStats(",pt,",",W,".getNumPendingQueries(),",et,");"):Jt(W,".endQuery();"))}function Et(Jt){var ae=k.def(nt,".profile");k(nt,".profile=",Jt,";"),k.exit(nt,".profile=",ae,";")}var Pt;if(J){if(fr(J)){J.enable?(wt(k),St(k.exit),Et("true")):Et("false");return}Pt=J.append(X,k),Et(Pt)}else Pt=k.def(nt,".profile");var ee=X.block();wt(ee),k("if(",Pt,"){",ee,"}");var ve=X.block();St(ve),k.exit("if(",Pt,"){",ve,"}")}function We(X,k,tt,ot,lt){var rt=X.shared;function et(W){switch(W){case Oi:case Ci:case Ni:return 2;case Ai:case Ii:case Ri:return 3;case Gi:case Di:case ki:return 4;default:return 1}}function nt(W,J,U){var at=rt.gl,pt=k.def(W,".location"),wt=k.def(rt.attributes,"[",pt,"]"),St=U.state,Et=U.buffer,Pt=[U.x,U.y,U.z,U.w],ee=["buffer","normalized","offset","stride"];function ve(){k("if(!",wt,".buffer){",at,".enableVertexAttribArray(",pt,");}");var ae=U.type,he;if(U.size?he=k.def(U.size,"||",J):he=J,k("if(",wt,".type!==",ae,"||",wt,".size!==",he,"||",ee.map(function(Ae){return wt+"."+Ae+"!=="+U[Ae]}).join("||"),"){",at,".bindBuffer(",Hr,",",Et,".buffer);",at,".vertexAttribPointer(",[pt,he,ae,U.normalized,U.stride,U.offset],");",wt,".type=",ae,";",wt,".size=",he,";",ee.map(function(Ae){return wt+"."+Ae+"="+U[Ae]+";"}).join(""),"}"),Mt){var Le=U.divisor;k("if(",wt,".divisor!==",Le,"){",X.instancing,".vertexAttribDivisorANGLE(",[pt,Le],");",wt,".divisor=",Le,";}")}}function Jt(){k("if(",wt,".buffer){",at,".disableVertexAttribArray(",pt,");",wt,".buffer=null;","}if(",Fr.map(function(ae,he){return wt+"."+ae+"!=="+Pt[he]}).join("||"),"){",at,".vertexAttrib4f(",pt,",",Pt,");",Fr.map(function(ae,he){return wt+"."+ae+"="+Pt[he]+";"}).join(""),"}")}St===Br?ve():St===fn?Jt():(k("if(",St,"===",Br,"){"),ve(),k("}else{"),Jt(),k("}"))}ot.forEach(function(W){var J=W.name,U=tt.attributes[J],at;if(U){if(!lt(U))return;at=U.append(X,k)}else{if(!lt(Ls))return;var pt=X.scopeAttrib(J);V.optional(function(){X.assert(k,pt+".state","missing attribute "+J)}),at={},Object.keys(new ht).forEach(function(wt){at[wt]=k.def(pt,".",wt)})}nt(X.link(W),et(W.info.type),at)})}function Se(X,k,tt,ot,lt){for(var rt=X.shared,et=rt.gl,nt,W=0;W<ot.length;++W){var J=ot[W],U=J.name,at=J.info.type,pt=tt.uniforms[U],wt=X.link(J),St=wt+".location",Et;if(pt){if(!lt(pt))continue;if(fr(pt)){var Pt=pt.value;if(V.command(Pt!==null&&typeof Pt<"u",'missing uniform "'+U+'"',X.commandStr),at===ai||at===si){V.command(typeof Pt=="function"&&(at===ai&&(Pt._reglType==="texture2d"||Pt._reglType==="framebuffer")||at===si&&(Pt._reglType==="textureCube"||Pt._reglType==="framebufferCube")),"invalid texture for uniform "+U,X.commandStr);var ee=X.link(Pt._texture||Pt.color[0]._texture);k(et,".uniform1i(",St,",",ee+".bind());"),k.exit(ee,".unbind();")}else if(at===ri||at===ii||at===ni){V.optional(function(){V.command(Ge(Pt),"invalid matrix for uniform "+U,X.commandStr),V.command(at===ri&&Pt.length===4||at===ii&&Pt.length===9||at===ni&&Pt.length===16,"invalid length for matrix uniform "+U,X.commandStr)});var ve=X.global.def("new Float32Array(["+Array.prototype.slice.call(Pt)+"])"),Jt=2;at===ii?Jt=3:at===ni&&(Jt=4),k(et,".uniformMatrix",Jt,"fv(",St,",false,",ve,");")}else{switch(at){case Gn:V.commandType(Pt,"number","uniform "+U,X.commandStr),nt="1f";break;case Oi:V.command(Ge(Pt)&&Pt.length===2,"uniform "+U,X.commandStr),nt="2f";break;case Ai:V.command(Ge(Pt)&&Pt.length===3,"uniform "+U,X.commandStr),nt="3f";break;case Gi:V.command(Ge(Pt)&&Pt.length===4,"uniform "+U,X.commandStr),nt="4f";break;case In:V.commandType(Pt,"boolean","uniform "+U,X.commandStr),nt="1i";break;case Cn:V.commandType(Pt,"number","uniform "+U,X.commandStr),nt="1i";break;case Ni:V.command(Ge(Pt)&&Pt.length===2,"uniform "+U,X.commandStr),nt="2i";break;case Ci:V.command(Ge(Pt)&&Pt.length===2,"uniform "+U,X.commandStr),nt="2i";break;case Ri:V.command(Ge(Pt)&&Pt.length===3,"uniform "+U,X.commandStr),nt="3i";break;case Ii:V.command(Ge(Pt)&&Pt.length===3,"uniform "+U,X.commandStr),nt="3i";break;case ki:V.command(Ge(Pt)&&Pt.length===4,"uniform "+U,X.commandStr),nt="4i";break;case Di:V.command(Ge(Pt)&&Pt.length===4,"uniform "+U,X.commandStr),nt="4i";break}k(et,".uniform",nt,"(",St,",",Ge(Pt)?Array.prototype.slice.call(Pt):Pt,");")}continue}else Et=pt.append(X,k)}else{if(!lt(Ls))continue;Et=k.def(rt.uniforms,"[",B.id(U),"]")}at===ai?(V(!Array.isArray(Et),"must specify a scalar prop for textures"),k("if(",Et,"&&",Et,'._reglType==="framebuffer"){',Et,"=",Et,".color[0];","}")):at===si&&(V(!Array.isArray(Et),"must specify a scalar prop for cube maps"),k("if(",Et,"&&",Et,'._reglType==="framebufferCube"){',Et,"=",Et,".color[0];","}")),V.optional(function(){function je(rr,Ds){X.assert(k,rr,'bad data or missing for uniform "'+U+'".  '+Ds)}function Rn(rr){V(!Array.isArray(Et),"must not specify an array type for uniform"),je("typeof "+Et+'==="'+rr+'"',"invalid type, expected "+rr)}function Je(rr,Ds){Array.isArray(Et)?V(Et.length===rr,"must have length "+rr):je(rt.isArrayLike+"("+Et+")&&"+Et+".length==="+rr,"invalid vector, should have length "+rr,X.commandStr)}function Is(rr){V(!Array.isArray(Et),"must not specify a value type"),je("typeof "+Et+'==="function"&&'+Et+'._reglType==="texture'+(rr===vs?"2d":"Cube")+'"',"invalid texture type",X.commandStr)}switch(at){case Cn:Rn("number");break;case Ci:Je(2);break;case Ii:Je(3);break;case Di:Je(4);break;case Gn:Rn("number");break;case Oi:Je(2);break;case Ai:Je(3);break;case Gi:Je(4);break;case In:Rn("boolean");break;case Ni:Je(2);break;case Ri:Je(3);break;case ki:Je(4);break;case ri:Je(4);break;case ii:Je(9);break;case ni:Je(16);break;case ai:Is(vs);break;case si:Is(bh);break}});var ae=1;switch(at){case ai:case si:var he=k.def(Et,"._texture");k(et,".uniform1i(",St,",",he,".bind());"),k.exit(he,".unbind();");continue;case Cn:case In:nt="1i";break;case Ci:case Ni:nt="2i",ae=2;break;case Ii:case Ri:nt="3i",ae=3;break;case Di:case ki:nt="4i",ae=4;break;case Gn:nt="1f";break;case Oi:nt="2f",ae=2;break;case Ai:nt="3f",ae=3;break;case Gi:nt="4f",ae=4;break;case ri:nt="Matrix2fv";break;case ii:nt="Matrix3fv";break;case ni:nt="Matrix4fv";break}if(k(et,".uniform",nt,"(",St,","),nt.charAt(0)==="M"){var Le=Math.pow(at-ri+2,2),Ae=X.global.def("new Float32Array(",Le,")");Array.isArray(Et)?k("false,(",Ye(Le,function(je){return Ae+"["+je+"]="+Et[je]}),",",Ae,")"):k("false,(Array.isArray(",Et,")||",Et," instanceof Float32Array)?",Et,":(",Ye(Le,function(je){return Ae+"["+je+"]="+Et+"["+je+"]"}),",",Ae,")")}else ae>1?k(Ye(ae,function(je){return Array.isArray(Et)?Et[je]:Et+"["+je+"]"})):(V(!Array.isArray(Et),"uniform value must not be an array"),k(Et));k(");")}}function ne(X,k,tt,ot){var lt=X.shared,rt=lt.gl,et=lt.draw,nt=ot.draw;function W(){var he=nt.elements,Le,Ae=k;return he?((he.contextDep&&ot.contextDynamic||he.propDep)&&(Ae=tt),Le=he.append(X,Ae)):Le=Ae.def(et,".",Er),Le&&Ae("if("+Le+")"+rt+".bindBuffer("+gh+","+Le+".buffer.buffer);"),Le}function J(){var he=nt.count,Le,Ae=k;return he?((he.contextDep&&ot.contextDynamic||he.propDep)&&(Ae=tt),Le=he.append(X,Ae),V.optional(function(){he.MISSING&&X.assert(k,"false","missing vertex count"),he.DYNAMIC&&X.assert(Ae,Le+">=0","missing vertex count")})):(Le=Ae.def(et,".",wr),V.optional(function(){X.assert(Ae,Le+">=0","missing vertex count")})),Le}var U=W();function at(he){var Le=nt[he];return Le?Le.contextDep&&ot.contextDynamic||Le.propDep?Le.append(X,tt):Le.append(X,k):k.def(et,".",he)}var pt=at(Tr),wt=at(Li),St=J();if(typeof St=="number"){if(St===0)return}else tt("if(",St,"){"),tt.exit("}");var Et,Pt;Mt&&(Et=at(Si),Pt=X.instancing);var ee=U+".type",ve=nt.elements&&fr(nt.elements);function Jt(){function he(){tt(Pt,".drawElementsInstancedANGLE(",[pt,St,ee,wt+"<<(("+ee+"-"+Ya+")>>1)",Et],");")}function Le(){tt(Pt,".drawArraysInstancedANGLE(",[pt,wt,St,Et],");")}U?ve?he():(tt("if(",U,"){"),he(),tt("}else{"),Le(),tt("}")):Le()}function ae(){function he(){tt(rt+".drawElements("+[pt,St,ee,wt+"<<(("+ee+"-"+Ya+")>>1)"]+");")}function Le(){tt(rt+".drawArrays("+[pt,wt,St]+");")}U?ve?he():(tt("if(",U,"){"),he(),tt("}else{"),Le(),tt("}")):Le()}Mt&&(typeof Et!="number"||Et>=0)?typeof Et=="string"?(tt("if(",Et,">0){"),Jt(),tt("}else if(",Et,"<0){"),ae(),tt("}")):Jt():ae()}function be(X,k,tt,ot,lt){var rt=se(),et=rt.proc("body",lt);return V.optional(function(){rt.commandStr=k.commandStr,rt.command=rt.link(k.commandStr)}),Mt&&(rt.instancing=et.def(rt.shared.extensions,".angle_instanced_arrays")),X(rt,et,tt,ot),rt.compile().body}function Ee(X,k,tt,ot){Ce(X,k),tt.useVAO?tt.drawVAO?k(X.shared.vao,".setVAO(",tt.drawVAO.append(X,k),");"):k(X.shared.vao,".setVAO(",X.shared.vao,".targetVAO);"):(k(X.shared.vao,".setVAO(null);"),We(X,k,tt,ot.attributes,function(){return!0})),Se(X,k,tt,ot.uniforms,function(){return!0}),ne(X,k,k,tt)}function Ie(X,k){var tt=X.proc("draw",1);Ce(X,tt),Me(X,tt,k.context),Fe(X,tt,k.framebuffer),Ue(X,tt,k),Xe(X,tt,k.state),de(X,tt,k,!1,!0);var ot=k.shader.progVar.append(X,tt);if(tt(X.shared.gl,".useProgram(",ot,".program);"),k.shader.program)Ee(X,tt,k,k.shader.program);else{tt(X.shared.vao,".setVAO(null);");var lt=X.global.def("{}"),rt=tt.def(ot,".id"),et=tt.def(lt,"[",rt,"]");tt(X.cond(et).then(et,".call(this,a0);").else(et,"=",lt,"[",rt,"]=",X.link(function(nt){return be(Ee,X,k,nt,1)}),"(",ot,");",et,".call(this,a0);"))}Object.keys(k.state).length>0&&tt(X.shared.current,".dirty=true;")}function sr(X,k,tt,ot){X.batchId="a1",Ce(X,k);function lt(){return!0}We(X,k,tt,ot.attributes,lt),Se(X,k,tt,ot.uniforms,lt),ne(X,k,k,tt)}function Sr(X,k,tt,ot){Ce(X,k);var lt=tt.contextDep,rt=k.def(),et="a0",nt="a1",W=k.def();X.shared.props=W,X.batchId=rt;var J=X.scope(),U=X.scope();k(J.entry,"for(",rt,"=0;",rt,"<",nt,";++",rt,"){",W,"=",et,"[",rt,"];",U,"}",J.exit);function at(ee){return ee.contextDep&&lt||ee.propDep}function pt(ee){return!at(ee)}if(tt.needsContext&&Me(X,U,tt.context),tt.needsFramebuffer&&Fe(X,U,tt.framebuffer),Xe(X,U,tt.state,at),tt.profile&&at(tt.profile)&&de(X,U,tt,!1,!0),ot)tt.useVAO?tt.drawVAO?at(tt.drawVAO)?U(X.shared.vao,".setVAO(",tt.drawVAO.append(X,U),");"):J(X.shared.vao,".setVAO(",tt.drawVAO.append(X,J),");"):J(X.shared.vao,".setVAO(",X.shared.vao,".targetVAO);"):(J(X.shared.vao,".setVAO(null);"),We(X,J,tt,ot.attributes,pt),We(X,U,tt,ot.attributes,at)),Se(X,J,tt,ot.uniforms,pt),Se(X,U,tt,ot.uniforms,at),ne(X,J,U,tt);else{var wt=X.global.def("{}"),St=tt.shader.progVar.append(X,U),Et=U.def(St,".id"),Pt=U.def(wt,"[",Et,"]");U(X.shared.gl,".useProgram(",St,".program);","if(!",Pt,"){",Pt,"=",wt,"[",Et,"]=",X.link(function(ee){return be(sr,X,tt,ee,2)}),"(",St,");}",Pt,".call(this,a0[",rt,"],",rt,");")}}function j(X,k){var tt=X.proc("batch",2);X.batchId="0",Ce(X,tt);var ot=!1,lt=!0;Object.keys(k.context).forEach(function(wt){ot=ot||k.context[wt].propDep}),ot||(Me(X,tt,k.context),lt=!1);var rt=k.framebuffer,et=!1;rt?(rt.propDep?ot=et=!0:rt.contextDep&&ot&&(et=!0),et||Fe(X,tt,rt)):Fe(X,tt,null),k.state.viewport&&k.state.viewport.propDep&&(ot=!0);function nt(wt){return wt.contextDep&&ot||wt.propDep}Ue(X,tt,k),Xe(X,tt,k.state,function(wt){return!nt(wt)}),(!k.profile||!nt(k.profile))&&de(X,tt,k,!1,"a1"),k.contextDep=ot,k.needsContext=lt,k.needsFramebuffer=et;var W=k.shader.progVar;if(W.contextDep&&ot||W.propDep)Sr(X,tt,k,null);else{var J=W.append(X,tt);if(tt(X.shared.gl,".useProgram(",J,".program);"),k.shader.program)Sr(X,tt,k,k.shader.program);else{tt(X.shared.vao,".setVAO(null);");var U=X.global.def("{}"),at=tt.def(J,".id"),pt=tt.def(U,"[",at,"]");tt(X.cond(pt).then(pt,".call(this,a0,a1);").else(pt,"=",U,"[",at,"]=",X.link(function(wt){return be(Sr,X,k,wt,2)}),"(",J,");",pt,".call(this,a0,a1);"))}}Object.keys(k.state).length>0&&tt(X.shared.current,".dirty=true;")}function _t(X,k){var tt=X.proc("scope",3);X.batchId="a2";var ot=X.shared,lt=ot.current;Me(X,tt,k.context),k.framebuffer&&k.framebuffer.append(X,tt),ws(Object.keys(k.state)).forEach(function(et){var nt=k.state[et],W=nt.append(X,tt);Ge(W)?W.forEach(function(J,U){tt.set(X.next[et],"["+U+"]",J)}):tt.set(ot.next,"."+et,W)}),de(X,tt,k,!0,!0),[Er,Li,wr,Si,Tr].forEach(function(et){var nt=k.draw[et];nt&&tt.set(ot.draw,"."+et,""+nt.append(X,tt))}),Object.keys(k.uniforms).forEach(function(et){var nt=k.uniforms[et].append(X,tt);Array.isArray(nt)&&(nt="["+nt.join()+"]"),tt.set(ot.uniforms,"["+B.id(et)+"]",nt)}),Object.keys(k.attributes).forEach(function(et){var nt=k.attributes[et].append(X,tt),W=X.scopeAttrib(et);Object.keys(new ht).forEach(function(J){tt.set(W,"."+J,nt[J])})}),k.scopeVAO&&tt.set(ot.vao,".targetVAO",k.scopeVAO.append(X,tt));function rt(et){var nt=k.shader[et];nt&&tt.set(ot.shader,"."+et,nt.append(X,tt))}rt(Jr),rt(ti),Object.keys(k.state).length>0&&(tt(lt,".dirty=true;"),tt.exit(lt,".dirty=true;")),tt("a1(",X.shared.context,",a0,",X.batchId,");")}function ct(X){if(!(typeof X!="object"||Ge(X))){for(var k=Object.keys(X),tt=0;tt<k.length;++tt)if(Ke.isDynamic(X[k[tt]]))return!0;return!1}}function Qt(X,k,tt){var ot=k.static[tt];if(!ot||!ct(ot))return;var lt=X.global,rt=Object.keys(ot),et=!1,nt=!1,W=!1,J=X.global.def("{}");rt.forEach(function(at){var pt=ot[at];if(Ke.isDynamic(pt)){typeof pt=="function"&&(pt=ot[at]=Ke.unbox(pt));var wt=$e(pt,null);et=et||wt.thisDep,W=W||wt.propDep,nt=nt||wt.contextDep}else{switch(lt(J,".",at,"="),typeof pt){case"number":lt(pt);break;case"string":lt('"',pt,'"');break;case"object":Array.isArray(pt)&&lt("[",pt.join(),"]");break;default:lt(X.link(pt));break}lt(";")}});function U(at,pt){rt.forEach(function(wt){var St=ot[wt];if(Ke.isDynamic(St)){var Et=at.invoke(pt,St);pt(J,".",wt,"=",Et,";")}})}k.dynamic[tt]=new Ke.DynamicVariable(Ti,{thisDep:et,contextDep:nt,propDep:W,ref:J,append:U}),delete k.static[tt]}function me(X,k,tt,ot,lt){var rt=se();rt.stats=rt.link(lt),Object.keys(k.static).forEach(function(nt){Qt(rt,k,nt)}),_h.forEach(function(nt){Qt(rt,X,nt)});var et=ke(X,k,tt,ot,rt);return Ie(rt,et),_t(rt,et),j(rt,et),r(rt.compile(),{destroy:function(){et.shader.program.destroy()}})}return{next:Kt,current:At,procs:function(){var X=se(),k=X.proc("poll"),tt=X.proc("refresh"),ot=X.block();k(ot),tt(ot);var lt=X.shared,rt=lt.gl,et=lt.next,nt=lt.current;ot(nt,".dirty=false;"),Fe(X,k),Fe(X,tt,null,!0);var W;Mt&&(W=X.link(Mt)),K.oes_vertex_array_object&&tt(X.link(K.oes_vertex_array_object),".bindVertexArrayOES(null);");for(var J=0;J<dt.maxAttributes;++J){var U=tt.def(lt.attributes,"[",J,"]"),at=X.cond(U,".buffer");at.then(rt,".enableVertexAttribArray(",J,");",rt,".bindBuffer(",Hr,",",U,".buffer.buffer);",rt,".vertexAttribPointer(",J,",",U,".size,",U,".type,",U,".normalized,",U,".stride,",U,".offset);").else(rt,".disableVertexAttribArray(",J,");",rt,".vertexAttrib4f(",J,",",U,".x,",U,".y,",U,".z,",U,".w);",U,".buffer=null;"),tt(at),Mt&&tt(W,".vertexAttribDivisorANGLE(",J,",",U,".divisor);")}return tt(X.shared.vao,".currentVAO=null;",X.shared.vao,".setVAO(",X.shared.vao,".targetVAO);"),Object.keys(Ht).forEach(function(pt){var wt=Ht[pt],St=ot.def(et,".",pt),Et=X.block();Et("if(",St,"){",rt,".enable(",wt,")}else{",rt,".disable(",wt,")}",nt,".",pt,"=",St,";"),tt(Et),k("if(",St,"!==",nt,".",pt,"){",Et,"}")}),Object.keys(Gt).forEach(function(pt){var wt=Gt[pt],St=At[pt],Et,Pt,ee=X.block();if(ee(rt,".",wt,"("),Ge(St)){var ve=St.length;Et=X.global.def(et,".",pt),Pt=X.global.def(nt,".",pt),ee(Ye(ve,function(Jt){return Et+"["+Jt+"]"}),");",Ye(ve,function(Jt){return Pt+"["+Jt+"]="+Et+"["+Jt+"];"}).join("")),k("if(",Ye(ve,function(Jt){return Et+"["+Jt+"]!=="+Pt+"["+Jt+"]"}).join("||"),"){",ee,"}")}else Et=ot.def(et,".",pt),Pt=ot.def(nt,".",pt),ee(Et,");",nt,".",pt,"=",Et,";"),k("if(",Et,"!==",Pt,"){",ee,"}");tt(ee)}),X.compile()}(),compile:me}}function Ph(){return{vaoCount:0,bufferCount:0,elementsCount:0,framebufferCount:0,shaderCount:0,textureCount:0,cubeCount:0,renderbufferCount:0,maxTextureUnits:0}}var Mh=34918,Fh=34919,Ss=35007,Bh=function(g,B){if(!B.ext_disjoint_timer_query)return null;var K=[];function dt(){return K.pop()||B.ext_disjoint_timer_query.createQueryEXT()}function Lt(Mt){K.push(Mt)}var ft=[];function bt(Mt){var jt=dt();B.ext_disjoint_timer_query.beginQueryEXT(Ss,jt),ft.push(jt),Dt(ft.length-1,ft.length,Mt)}function It(){B.ext_disjoint_timer_query.endQueryEXT(Ss)}function Nt(){this.startQueryIndex=-1,this.endQueryIndex=-1,this.sum=0,this.stats=null}var Ft=[];function Rt(){return Ft.pop()||new Nt}function zt(Mt){Ft.push(Mt)}var Xt=[];function Dt(Mt,jt,At){var Kt=Rt();Kt.startQueryIndex=Mt,Kt.endQueryIndex=jt,Kt.sum=0,Kt.stats=At,Xt.push(Kt)}var Ut=[],ht=[];function xt(){var Mt,jt,At=ft.length;if(At!==0){ht.length=Math.max(ht.length,At+1),Ut.length=Math.max(Ut.length,At+1),Ut[0]=0,ht[0]=0;var Kt=0;for(Mt=0,jt=0;jt<ft.length;++jt){var Ct=ft[jt];B.ext_disjoint_timer_query.getQueryObjectEXT(Ct,Fh)?(Kt+=B.ext_disjoint_timer_query.getQueryObjectEXT(Ct,Mh),Lt(Ct)):ft[Mt++]=Ct,Ut[jt+1]=Kt,ht[jt+1]=Mt}for(ft.length=Mt,Mt=0,jt=0;jt<Xt.length;++jt){var Ht=Xt[jt],Gt=Ht.startQueryIndex,Vt=Ht.endQueryIndex;Ht.sum+=Ut[Vt]-Ut[Gt];var ie=ht[Gt],oe=ht[Vt];oe===ie?(Ht.stats.gpuTime+=Ht.sum/1e6,zt(Ht)):(Ht.startQueryIndex=ie,Ht.endQueryIndex=oe,Xt[Mt++]=Ht)}Xt.length=Mt}}return{beginQuery:bt,endQuery:It,pushScopeStats:Dt,update:xt,getNumPendingQueries:function(){return ft.length},clear:function(){K.push.apply(K,ft);for(var Mt=0;Mt<K.length;Mt++)B.ext_disjoint_timer_query.deleteQueryEXT(K[Mt]);ft.length=0,K.length=0},restore:function(){ft.length=0,K.length=0}}},zh=16384,Uh=256,Hh=1024,Vh=34962,Os="webglcontextlost",As="webglcontextrestored",Gs=1,Xh=2,Wh=3;function Cs(g,B){for(var K=0;K<g.length;++K)if(g[K]===B)return K;return-1}function qh(g){var B=Hs(g);if(!B)return null;var K=B.gl,dt=K.getContextAttributes(),Lt=K.isContextLost(),ft=Vs(K,B);if(!ft)return null;var bt=Ms(),It=Ph(),Nt=ft.extensions,Ft=Bh(K,Nt),Rt=Fn(),zt=K.drawingBufferWidth,Xt=K.drawingBufferHeight,Dt={tick:0,time:0,viewportWidth:zt,viewportHeight:Xt,framebufferWidth:zt,framebufferHeight:Xt,drawingBufferWidth:zt,drawingBufferHeight:Xt,pixelRatio:B.pixelRatio},Ut={},ht={elements:null,primitive:4,count:-1,offset:0,instances:-1},xt=Io(K,Nt),Mt=jo(K,It,B,At),jt=ah(K,Nt,xt,It,Mt);function At(ne){return jt.destroyBuffer(ne)}var Kt=au(K,Nt,Mt,It),Ct=hh(K,bt,It,B),Ht=Pu(K,Nt,xt,function(){ie.procs.poll()},Dt,It,B),Gt=Mu(K,Nt,xt,It,B),Vt=ih(K,Nt,xt,Ht,Gt,It),ie=kh(K,bt,Nt,xt,Mt,Kt,Ht,Vt,Ut,jt,Ct,ht,Dt,Ft,B),oe=ch(K,Vt,ie.procs.poll,Dt,dt,Nt,xt),Wt=ie.next,Bt=K.canvas,Ot=[],se=[],fe=[],Zt=[B.onDestroy],ge=null;function ue(){if(Ot.length===0){Ft&&Ft.update(),ge=null;return}ge=Fi.next(ue),Xe();for(var ne=Ot.length-1;ne>=0;--ne){var be=Ot[ne];be&&be(Dt,null,0)}K.flush(),Ft&&Ft.update()}function _e(){!ge&&Ot.length>0&&(ge=Fi.next(ue))}function we(){ge&&(Fi.cancel(ue),ge=null)}function Re(ne){ne.preventDefault(),Lt=!0,we(),se.forEach(function(be){be()})}function ze(ne){K.getError(),Lt=!1,ft.restore(),Ct.restore(),Mt.restore(),Ht.restore(),Gt.restore(),Vt.restore(),jt.restore(),Ft&&Ft.restore(),ie.procs.refresh(),_e(),fe.forEach(function(be){be()})}Bt&&(Bt.addEventListener(Os,Re,!1),Bt.addEventListener(As,ze,!1));function xe(){Ot.length=0,we(),Bt&&(Bt.removeEventListener(Os,Re),Bt.removeEventListener(As,ze)),Ct.clear(),Vt.clear(),Gt.clear(),Ht.clear(),Kt.clear(),Mt.clear(),jt.clear(),Ft&&Ft.clear(),Zt.forEach(function(ne){ne()})}function Pe(ne){V(!!ne,"invalid args to regl({...})"),V.type(ne,"object","invalid args to regl({...})");function be(lt){var rt=r({},lt);delete rt.uniforms,delete rt.attributes,delete rt.context,delete rt.vao,"stencil"in rt&&rt.stencil.op&&(rt.stencil.opBack=rt.stencil.opFront=rt.stencil.op,delete rt.stencil.op);function et(nt){if(nt in rt){var W=rt[nt];delete rt[nt],Object.keys(W).forEach(function(J){rt[nt+"."+J]=W[J]})}}return et("blend"),et("depth"),et("cull"),et("stencil"),et("polygonOffset"),et("scissor"),et("sample"),"vao"in lt&&(rt.vao=lt.vao),rt}function Ee(lt,rt){var et={},nt={};return Object.keys(lt).forEach(function(W){var J=lt[W];if(Ke.isDynamic(J)){nt[W]=Ke.unbox(J,W);return}else if(rt&&Array.isArray(J)){for(var U=0;U<J.length;++U)if(Ke.isDynamic(J[U])){nt[W]=Ke.unbox(J,W);return}}et[W]=J}),{dynamic:nt,static:et}}var Ie=Ee(ne.context||{},!0),sr=Ee(ne.uniforms||{},!0),Sr=Ee(ne.attributes||{},!1),j=Ee(be(ne),!1),_t={gpuTime:0,cpuTime:0,count:0},ct=ie.compile(j,Sr,sr,Ie,_t),Qt=ct.draw,me=ct.batch,X=ct.scope,k=[];function tt(lt){for(;k.length<lt;)k.push(null);return k}function ot(lt,rt){var et;if(Lt&&V.raise("context lost"),typeof lt=="function")return X.call(this,null,lt,0);if(typeof rt=="function")if(typeof lt=="number")for(et=0;et<lt;++et)X.call(this,null,rt,et);else if(Array.isArray(lt))for(et=0;et<lt.length;++et)X.call(this,lt[et],rt,et);else return X.call(this,lt,rt,0);else if(typeof lt=="number"){if(lt>0)return me.call(this,tt(lt|0),lt|0)}else if(Array.isArray(lt)){if(lt.length)return me.call(this,lt,lt.length)}else return Qt.call(this,lt)}return r(ot,{stats:_t,destroy:function(){ct.destroy()}})}var Oe=Vt.setFBO=Pe({framebuffer:Ke.define.call(null,Gs,"framebuffer")});function ke(ne,be){var Ee=0;ie.procs.poll();var Ie=be.color;Ie&&(K.clearColor(+Ie[0]||0,+Ie[1]||0,+Ie[2]||0,+Ie[3]||0),Ee|=zh),"depth"in be&&(K.clearDepth(+be.depth),Ee|=Uh),"stencil"in be&&(K.clearStencil(be.stencil|0),Ee|=Hh),V(!!Ee,"called regl.clear with no buffer specified"),K.clear(Ee)}function Me(ne){if(V(typeof ne=="object"&&ne,"regl.clear() takes an object as input"),"framebuffer"in ne)if(ne.framebuffer&&ne.framebuffer_reglType==="framebufferCube")for(var be=0;be<6;++be)Oe(r({framebuffer:ne.framebuffer.faces[be]},ne),ke);else Oe(ne,ke);else ke(null,ne)}function Fe(ne){V.type(ne,"function","regl.frame() callback must be a function"),Ot.push(ne);function be(){var Ee=Cs(Ot,ne);V(Ee>=0,"cannot cancel a frame twice");function Ie(){var sr=Cs(Ot,Ie);Ot[sr]=Ot[Ot.length-1],Ot.length-=1,Ot.length<=0&&we()}Ot[Ee]=Ie}return _e(),{cancel:be}}function Ue(){var ne=Wt.viewport,be=Wt.scissor_box;ne[0]=ne[1]=be[0]=be[1]=0,Dt.viewportWidth=Dt.framebufferWidth=Dt.drawingBufferWidth=ne[2]=be[2]=K.drawingBufferWidth,Dt.viewportHeight=Dt.framebufferHeight=Dt.drawingBufferHeight=ne[3]=be[3]=K.drawingBufferHeight}function Xe(){Dt.tick+=1,Dt.time=de(),Ue(),ie.procs.poll()}function Ce(){Ht.refresh(),Ue(),ie.procs.refresh(),Ft&&Ft.update()}function de(){return(Fn()-Rt)/1e3}Ce();function We(ne,be){V.type(be,"function","listener callback must be a function");var Ee;switch(ne){case"frame":return Fe(be);case"lost":Ee=se;break;case"restore":Ee=fe;break;case"destroy":Ee=Zt;break;default:V.raise("invalid event, must be one of frame,lost,restore,destroy")}return Ee.push(be),{cancel:function(){for(var Ie=0;Ie<Ee.length;++Ie)if(Ee[Ie]===be){Ee[Ie]=Ee[Ee.length-1],Ee.pop();return}}}}var Se=r(Pe,{clear:Me,prop:Ke.define.bind(null,Gs),context:Ke.define.bind(null,Xh),this:Ke.define.bind(null,Wh),draw:Pe({}),buffer:function(ne){return Mt.create(ne,Vh,!1,!1)},elements:function(ne){return Kt.create(ne,!1)},texture:Ht.create2D,cube:Ht.createCube,renderbuffer:Gt.create,framebuffer:Vt.create,framebufferCube:Vt.createCube,vao:jt.createVAO,attributes:dt,frame:Fe,on:We,limits:xt,hasExtension:function(ne){return xt.extensions.indexOf(ne.toLowerCase())>=0},read:oe,destroy:xe,_gl:K,_refresh:Ce,poll:function(){Xe(),Ft&&Ft.update()},now:de,stats:It});return B.onDone(null,Se),Se}return qh})})(regl$1);var reglExports=regl$1.exports;const regl=getDefaultExportFromCjs(reglExports),Mouse=mouseListen();class HydraRenderer{constructor({pb:t=null,width:n=1280,height:r=720,numSources:s=4,numOutputs:o=4,makeGlobal:h=!0,autoLoop:u=!0,detectAudio:f=!0,enableStreamCapture:c=!0,canvas:_,precision:O,extendTransforms:d={}}={}){if(ArrayUtils.init(),this.pb=t,this.width=n,this.height=r,this.renderAll=!1,this.detectAudio=f,this._initCanvas(_),this.synth={time:0,bpm:30,width:this.width,height:this.height,fps:void 0,stats:{fps:0},speed:1,mouse:Mouse,render:this._render.bind(this),setResolution:this.setResolution.bind(this),update:S=>{},hush:this.hush.bind(this),tick:this.tick.bind(this)},h&&(window.loadScript=this.loadScript),this.timeSinceLastUpdate=0,this._time=0,O&&["lowp","mediump","highp"].includes(O.toLowerCase()))this.precision=O.toLowerCase();else{let S=(/iPad|iPhone|iPod/.test(navigator.platform)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1)&&!window.MSStream;this.precision=S?"highp":"mediump"}if(this.extendTransforms=d,this.saveFrame=!1,this.captureStream=null,this.generator=void 0,this._initRegl(),this._initOutputs(o),this._initSources(s),this._generateGlslTransforms(),this.synth.screencap=()=>{this.saveFrame=!0},c)try{this.captureStream=this.canvas.captureStream(25),this.synth.vidRecorder=new VideoRecorder(this.captureStream)}catch(S){console.warn(`[hydra-synth warning]
new MediaSource() is not currently supported on iOS.`),console.error(S)}f&&this._initAudio(),u&&loop(this.tick.bind(this)).start(),this.sandbox=new EvalSandbox(this.synth,h,["speed","update","bpm","fps"])}eval(t){this.sandbox.eval(t)}getScreenImage(t){this.imageCallback=t,this.saveFrame=!0}hush(){this.s.forEach(t=>{t.clear()}),this.o.forEach(t=>{this.synth.solid(0,0,0,0).out(t)}),this.synth.render(this.o[0]),this.sandbox.set("update",t=>{})}loadScript(t=""){return new Promise((r,s)=>{var o=document.createElement("script");o.onload=function(){console.log(`loaded script ${t}`),r()},o.onerror=h=>{console.log(`error loading script ${t}`,"log-error"),r()},o.src=t,document.head.appendChild(o)})}setResolution(t,n){this.canvas.width=t,this.canvas.height=n,this.width=t,this.height=n,this.sandbox.set("width",t),this.sandbox.set("height",n),console.log(this.width),this.o.forEach(r=>{r.resize(t,n)}),this.s.forEach(r=>{r.resize(t,n)}),this.regl._refresh(),console.log(this.canvas.width)}canvasToImage(t){const n=document.createElement("a");n.style.display="none";let r=new Date;n.download=`hydra-${r.getFullYear()}-${r.getMonth()+1}-${r.getDate()}-${r.getHours()}.${r.getMinutes()}.${r.getSeconds()}.png`,document.body.appendChild(n);var s=this;this.canvas.toBlob(o=>{s.imageCallback?(s.imageCallback(o),delete s.imageCallback):(n.href=URL.createObjectURL(o),console.log(n.href),n.click())},"image/png"),setTimeout(()=>{document.body.removeChild(n),window.URL.revokeObjectURL(n.href)},300)}_initAudio(){this.synth.a=new Audio({numBins:4,parentEl:this.canvas.parentNode})}_initCanvas(t){t?(this.canvas=t,this.width=t.width,this.height=t.height):(this.canvas=document.createElement("canvas"),this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.imageRendering="pixelated",document.body.appendChild(this.canvas))}_initRegl(){this.regl=regl({canvas:this.canvas,pixelRatio:1}),this.regl.clear({color:[0,0,0,1]}),this.renderAll=this.regl({frag:`
      precision ${this.precision} float;
      varying vec2 uv;
      uniform sampler2D tex0;
      uniform sampler2D tex1;
      uniform sampler2D tex2;
      uniform sampler2D tex3;

      void main () {
        vec2 st = vec2(1.0 - uv.x, uv.y);
        st*= vec2(2);
        vec2 q = floor(st).xy*(vec2(2.0, 1.0));
        int quad = int(q.x) + int(q.y);
        st.x += step(1., mod(st.y,2.0));
        st.y += step(1., mod(st.x,2.0));
        st = fract(st);
        if(quad==0){
          gl_FragColor = texture2D(tex0, st);
        } else if(quad==1){
          gl_FragColor = texture2D(tex1, st);
        } else if (quad==2){
          gl_FragColor = texture2D(tex2, st);
        } else {
          gl_FragColor = texture2D(tex3, st);
        }

      }
      `,vert:`
      precision ${this.precision} float;
      attribute vec2 position;
      varying vec2 uv;

      void main () {
        uv = position;
        gl_Position = vec4(1.0 - 2.0 * position, 0, 1);
      }`,attributes:{position:[[-2,0],[0,-2],[2,2]]},uniforms:{tex0:this.regl.prop("tex0"),tex1:this.regl.prop("tex1"),tex2:this.regl.prop("tex2"),tex3:this.regl.prop("tex3")},count:3,depth:{enable:!1}}),this.renderFbo=this.regl({frag:`
      precision ${this.precision} float;
      varying vec2 uv;
      uniform vec2 resolution;
      uniform sampler2D tex0;

      void main () {
        gl_FragColor = texture2D(tex0, vec2(1.0 - uv.x, uv.y));
      }
      `,vert:`
      precision ${this.precision} float;
      attribute vec2 position;
      varying vec2 uv;

      void main () {
        uv = position;
        gl_Position = vec4(1.0 - 2.0 * position, 0, 1);
      }`,attributes:{position:[[-2,0],[0,-2],[2,2]]},uniforms:{tex0:this.regl.prop("tex0"),resolution:this.regl.prop("resolution")},count:3,depth:{enable:!1}})}_initOutputs(t){const n=this;this.o=Array(t).fill().map((r,s)=>{var o=new Output({regl:this.regl,width:this.width,height:this.height,precision:this.precision,label:`o${s}`});return o.id=s,n.synth["o"+s]=o,o}),this.output=this.o[0]}_initSources(t){this.s=[];for(var n=0;n<t;n++)this.createSource(n)}createSource(t){let n=new HydraSource({regl:this.regl,pb:this.pb,width:this.width,height:this.height,label:`s${t}`});return this.synth["s"+this.s.length]=n,this.s.push(n),n}_generateGlslTransforms(){var t=this;this.generator=new GeneratorFactory({defaultOutput:this.o[0],defaultUniforms:this.o[0].uniforms,extendTransforms:this.extendTransforms,changeListener:({type:n,method:r,synth:s})=>{n==="add"&&(t.synth[r]=s.generators[r],t.sandbox&&t.sandbox.add(r))}}),this.synth.setFunction=this.generator.setFunction.bind(this.generator)}_render(t){t?(this.output=t,this.isRenderingAll=!1):this.isRenderingAll=!0}tick(t,n){if(this.sandbox.tick(),this.detectAudio===!0&&this.synth.a.tick(),this.sandbox.set("time",this.synth.time+=t*.001*this.synth.speed),this.timeSinceLastUpdate+=t,!this.synth.fps||this.timeSinceLastUpdate>=1e3/this.synth.fps){if(this.synth.stats.fps=Math.ceil(1e3/this.timeSinceLastUpdate),this.synth.update)try{this.synth.update(this.timeSinceLastUpdate)}catch(r){console.log(r)}for(let r=0;r<this.s.length;r++)this.s[r].tick(this.synth.time);for(let r=0;r<this.o.length;r++)this.o[r].tick({time:this.synth.time,mouse:this.synth.mouse,bpm:this.synth.bpm,resolution:[this.canvas.width,this.canvas.height]});this.isRenderingAll?this.renderAll({tex0:this.o[0].getCurrent(),tex1:this.o[1].getCurrent(),tex2:this.o[2].getCurrent(),tex3:this.o[3].getCurrent(),resolution:[this.canvas.width,this.canvas.height]}):this.renderFbo({tex0:this.output.getCurrent(),resolution:[this.canvas.width,this.canvas.height]}),this.timeSinceLastUpdate=0}this.saveFrame===!0&&(this.canvasToImage(),this.saveFrame=!1)}}var litegraph={};(function(exports){(function(global){var LiteGraph=global.LiteGraph={VERSION:.4,CANVAS_GRID_SIZE:10,NODE_TITLE_HEIGHT:30,NODE_TITLE_TEXT_Y:20,NODE_SLOT_HEIGHT:20,NODE_WIDGET_HEIGHT:20,NODE_WIDTH:140,NODE_MIN_WIDTH:50,NODE_COLLAPSED_RADIUS:10,NODE_COLLAPSED_WIDTH:80,NODE_TITLE_COLOR:"#999",NODE_SELECTED_TITLE_COLOR:"#FFF",NODE_TEXT_SIZE:14,NODE_TEXT_COLOR:"#AAA",NODE_SUBTEXT_SIZE:12,NODE_DEFAULT_COLOR:"#333",NODE_DEFAULT_BGCOLOR:"#353535",NODE_DEFAULT_BOXCOLOR:"#666",NODE_DEFAULT_SHAPE:"box",NODE_BOX_OUTLINE_COLOR:"#FFF",DEFAULT_SHADOW_COLOR:"rgba(0,0,0,0.5)",DEFAULT_GROUP_FONT:24,WIDGET_BGCOLOR:"#222",WIDGET_OUTLINE_COLOR:"#666",WIDGET_TEXT_COLOR:"#DDD",WIDGET_SECONDARY_TEXT_COLOR:"#999",LINK_COLOR:"#9A9",EVENT_LINK_COLOR:"#A86",CONNECTING_LINK_COLOR:"#AFA",MAX_NUMBER_OF_NODES:1e3,DEFAULT_POSITION:[100,100],VALID_SHAPES:["default","box","round","card"],BOX_SHAPE:1,ROUND_SHAPE:2,CIRCLE_SHAPE:3,CARD_SHAPE:4,ARROW_SHAPE:5,GRID_SHAPE:6,INPUT:1,OUTPUT:2,EVENT:-1,ACTION:-1,NODE_MODES:["Always","On Event","Never","On Trigger"],NODE_MODES_COLORS:["#666","#422","#333","#224","#626"],ALWAYS:0,ON_EVENT:1,NEVER:2,ON_TRIGGER:3,UP:1,DOWN:2,LEFT:3,RIGHT:4,CENTER:5,LINK_RENDER_MODES:["Straight","Linear","Spline"],STRAIGHT_LINK:0,LINEAR_LINK:1,SPLINE_LINK:2,NORMAL_TITLE:0,NO_TITLE:1,TRANSPARENT_TITLE:2,AUTOHIDE_TITLE:3,VERTICAL_LAYOUT:"vertical",proxy:null,node_images_path:"",debug:!1,catch_exceptions:!0,throw_errors:!0,allow_scripts:!1,use_deferred_actions:!0,registered_node_types:{},node_types_by_file_extension:{},Nodes:{},Globals:{},searchbox_extras:{},auto_sort_node_types:!1,node_box_coloured_when_on:!1,node_box_coloured_by_mode:!1,dialog_close_on_mouse_leave:!0,dialog_close_on_mouse_leave_delay:500,shift_click_do_break_link_from:!1,click_do_break_link_to:!1,search_hide_on_mouse_leave:!0,search_filter_enabled:!1,search_show_all_on_open:!0,auto_load_slot_types:!1,registered_slot_in_types:{},registered_slot_out_types:{},slot_types_in:[],slot_types_out:[],slot_types_default_in:[],slot_types_default_out:[],alt_drag_do_clone_nodes:!1,do_add_triggers_slots:!1,allow_multi_output_for_events:!0,middle_click_slot_add_default_node:!1,release_link_on_empty_shows_menu:!1,pointerevents_method:"mouse",ctrl_shift_v_paste_connect_unselected_outputs:!1,use_uuids:!1,registerNodeType:function(e,t){if(!t.prototype)throw"Cannot register a simple object, it must be a class with a prototype";t.type=e,LiteGraph.debug&&console.log("Node registered: "+e);const n=t.name,r=e.lastIndexOf("/");t.category=e.substring(0,r),t.title||(t.title=n);for(var s in LGraphNode.prototype)t.prototype[s]||(t.prototype[s]=LGraphNode.prototype[s]);const o=this.registered_node_types[e];if(o&&console.log("replacing node type: "+e),!Object.prototype.hasOwnProperty.call(t.prototype,"shape")&&(Object.defineProperty(t.prototype,"shape",{set:function(h){switch(h){case"default":delete this._shape;break;case"box":this._shape=LiteGraph.BOX_SHAPE;break;case"round":this._shape=LiteGraph.ROUND_SHAPE;break;case"circle":this._shape=LiteGraph.CIRCLE_SHAPE;break;case"card":this._shape=LiteGraph.CARD_SHAPE;break;default:this._shape=h}},get:function(){return this._shape},enumerable:!0,configurable:!0}),t.supported_extensions))for(let h in t.supported_extensions){const u=t.supported_extensions[h];u&&u.constructor===String&&(this.node_types_by_file_extension[u.toLowerCase()]=t)}this.registered_node_types[e]=t,t.constructor.name&&(this.Nodes[n]=t),LiteGraph.onNodeTypeRegistered&&LiteGraph.onNodeTypeRegistered(e,t),o&&LiteGraph.onNodeTypeReplaced&&LiteGraph.onNodeTypeReplaced(e,t,o),t.prototype.onPropertyChange&&console.warn("LiteGraph node class "+e+" has onPropertyChange method, it must be called onPropertyChanged with d at the end"),this.auto_load_slot_types&&new t(t.title||"tmpnode")},unregisterNodeType:function(e){const t=e.constructor===String?this.registered_node_types[e]:e;if(!t)throw"node type not found: "+e;delete this.registered_node_types[t.type],t.constructor.name&&delete this.Nodes[t.constructor.name]},registerNodeAndSlotType:function(e,t,n){n=n||!1;const s=(e.constructor===String&&this.registered_node_types[e]!=="anonymous"?this.registered_node_types[e]:e).constructor.type;let o=[];typeof t=="string"?o=t.split(","):t==this.EVENT||t==this.ACTION?o=["_event_"]:o=["*"];for(let h=0;h<o.length;++h){let u=o[h];u===""&&(u="*");const f=n?"registered_slot_out_types":"registered_slot_in_types";this[f][u]===void 0&&(this[f][u]={nodes:[]}),this[f][u].nodes.includes(s)||this[f][u].nodes.push(s),n?this.slot_types_out.includes(u.toLowerCase())||(this.slot_types_out.push(u.toLowerCase()),this.slot_types_out.sort()):this.slot_types_in.includes(u.toLowerCase())||(this.slot_types_in.push(u.toLowerCase()),this.slot_types_in.sort())}},buildNodeClassFromObject:function(e,t){var n="";if(t.inputs)for(var r=0;r<t.inputs.length;++r){var s=t.inputs[r][0],o=t.inputs[r][1];o&&o.constructor===String&&(o='"'+o+'"'),n+="this.addInput('"+s+"',"+o+`);
`}if(t.outputs)for(var r=0;r<t.outputs.length;++r){var s=t.outputs[r][0],o=t.outputs[r][1];o&&o.constructor===String&&(o='"'+o+'"'),n+="this.addOutput('"+s+"',"+o+`);
`}if(t.properties)for(var r in t.properties){var h=t.properties[r];h&&h.constructor===String&&(h='"'+h+'"'),n+="this.addProperty('"+r+"',"+h+`);
`}n+="if(this.onCreate)this.onCreate()";var u=Function(n);for(var r in t)r!="inputs"&&r!="outputs"&&r!="properties"&&(u.prototype[r]=t[r]);return u.title=t.title||e.split("/").pop(),u.desc=t.desc||"Generated from object",this.registerNodeType(e,u),u},wrapFunctionAsNode:function(e,t,n,r,s){var o=Array(t.length),h="";if(n!==null)for(var u=LiteGraph.getParameterNames(t),f=0;f<u.length;++f){var c=0;n&&(n[f]!=null&&n[f].constructor===String?c="'"+n[f]+"'":n[f]!=null&&(c=n[f])),h+="this.addInput('"+u[f]+"',"+c+`);
`}r!==null&&(h+="this.addOutput('out',"+(r!=null?r.constructor===String?"'"+r+"'":r:0)+`);
`),s&&(h+="this.properties = "+JSON.stringify(s)+`;
`);var _=Function(h);return _.title=e.split("/").pop(),_.desc="Generated from "+t.name,_.prototype.onExecute=function(){for(var d=0;d<o.length;++d)o[d]=this.getInputData(d);var b=t.apply(this,o);this.setOutputData(0,b)},this.registerNodeType(e,_),_},clearRegisteredTypes:function(){this.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}},addNodeMethod:function(e,t){LGraphNode.prototype[e]=t;for(var n in this.registered_node_types){var r=this.registered_node_types[n];r.prototype[e]&&(r.prototype["_"+e]=r.prototype[e]),r.prototype[e]=t}},createNode:function(e,t,n){var r=this.registered_node_types[e];if(!r)return LiteGraph.debug&&console.log('GraphNode type "'+e+'" not registered.'),null;r.prototype,t=t||r.title||e;var s=null;if(LiteGraph.catch_exceptions)try{s=new r(t)}catch(h){return console.error(h),null}else s=new r(t);if(s.type=e,!s.title&&t&&(s.title=t),s.properties||(s.properties={}),s.properties_info||(s.properties_info=[]),s.flags||(s.flags={}),s.size||(s.size=s.computeSize()),s.pos||(s.pos=LiteGraph.DEFAULT_POSITION.concat()),s.mode||(s.mode=LiteGraph.ALWAYS),n)for(var o in n)s[o]=n[o];return s.onNodeCreated&&s.onNodeCreated(),s},getNodeType:function(e){return this.registered_node_types[e]},getNodeTypesInCategory:function(e,t){var n=[];for(var r in this.registered_node_types){var s=this.registered_node_types[r];s.filter==t&&(e==""?s.category==null&&n.push(s):s.category==e&&n.push(s))}return this.auto_sort_node_types&&n.sort(function(o,h){return o.title.localeCompare(h.title)}),n},getNodeTypesCategories:function(e){var t={"":1};for(var n in this.registered_node_types){var r=this.registered_node_types[n];if(r.category&&!r.skip_list){if(r.filter!=e)continue;t[r.category]=1}}var s=[];for(var n in t)s.push(n);return this.auto_sort_node_types?s.sort():s},reloadNodes:function(e){for(var t=document.getElementsByTagName("script"),n=[],r=0;r<t.length;r++)n.push(t[r]);var s=document.getElementsByTagName("head")[0];e=document.location.href+e;for(var r=0;r<n.length;r++){var o=n[r].src;if(!(!o||o.substr(0,e.length)!=e))try{LiteGraph.debug&&console.log("Reloading: "+o);var h=document.createElement("script");h.type="text/javascript",h.src=o,s.appendChild(h),s.removeChild(n[r])}catch(f){if(LiteGraph.throw_errors)throw f;LiteGraph.debug&&console.log("Error while reloading "+o)}}LiteGraph.debug&&console.log("Nodes reloaded")},cloneObject:function(e,t){if(e==null)return null;var n=JSON.parse(JSON.stringify(e));if(!t)return n;for(var r in n)t[r]=n[r];return t},uuidv4:function(){return("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,e=>(e^Math.random()*16>>e/4).toString(16))},isValidConnection:function(e,t){if((e==""||e==="*")&&(e=0),(t==""||t==="*")&&(t=0),!e||!t||e==t||e==LiteGraph.EVENT&&t==LiteGraph.ACTION)return!0;if(e=String(e),t=String(t),e=e.toLowerCase(),t=t.toLowerCase(),e.indexOf(",")==-1&&t.indexOf(",")==-1)return e==t;for(var n=e.split(","),r=t.split(","),s=0;s<n.length;++s)for(var o=0;o<r.length;++o)if(this.isValidConnection(n[s],r[o]))return!0;return!1},registerSearchboxExtra:function(e,t,n){this.searchbox_extras[t.toLowerCase()]={type:e,desc:t,data:n}},fetchFile:function(e,t,n,r){if(!e)return null;if(t=t||"text",e.constructor===String)return e.substr(0,4)=="http"&&LiteGraph.proxy&&(e=LiteGraph.proxy+e.substr(e.indexOf(":")+3)),fetch(e).then(function(o){if(!o.ok)throw new Error("File not found");if(t=="arraybuffer")return o.arrayBuffer();if(t=="text"||t=="string")return o.text();if(t=="json")return o.json();if(t=="blob")return o.blob()}).then(function(o){n&&n(o)}).catch(function(o){console.error("error fetching file:",e),r&&r(o)});if(e.constructor===File||e.constructor===Blob){var s=new FileReader;if(s.onload=function(o){var h=o.target.result;t=="json"&&(h=JSON.parse(h)),n&&n(h)},t=="arraybuffer")return s.readAsArrayBuffer(e);if(t=="text"||t=="json")return s.readAsText(e);if(t=="blob")return s.readAsBinaryString(e)}return null}};typeof performance<"u"?LiteGraph.getTime=performance.now.bind(performance):typeof Date<"u"&&Date.now?LiteGraph.getTime=Date.now.bind(Date):typeof process<"u"?LiteGraph.getTime=function(){var e=process.hrtime();return e[0]*.001+e[1]*1e-6}:LiteGraph.getTime=function(){return new Date().getTime()};function LGraph(e){LiteGraph.debug&&console.log("Graph created"),this.list_of_graphcanvas=null,this.clear(),e&&this.configure(e)}global.LGraph=LiteGraph.LGraph=LGraph,LGraph.supported_types=["number","string","boolean"],LGraph.prototype.getSupportedTypes=function(){return this.supported_types||LGraph.supported_types},LGraph.STATUS_STOPPED=1,LGraph.STATUS_RUNNING=2,LGraph.prototype.clear=function(){if(this.stop(),this.status=LGraph.STATUS_STOPPED,this.last_node_id=0,this.last_link_id=0,this._version=-1,this._nodes)for(var e=0;e<this._nodes.length;++e){var t=this._nodes[e];t.onRemoved&&t.onRemoved()}this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[],this.inputs={},this.outputs={},this.change(),this.sendActionToCanvas("clear")},LGraph.prototype.attachCanvas=function(e){if(e.constructor!=LGraphCanvas)throw"attachCanvas expects a LGraphCanvas instance";e.graph&&e.graph!=this&&e.graph.detachCanvas(e),e.graph=this,this.list_of_graphcanvas||(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.push(e)},LGraph.prototype.detachCanvas=function(e){if(this.list_of_graphcanvas){var t=this.list_of_graphcanvas.indexOf(e);t!=-1&&(e.graph=null,this.list_of_graphcanvas.splice(t,1))}},LGraph.prototype.start=function(e){if(this.status!=LGraph.STATUS_RUNNING){this.status=LGraph.STATUS_RUNNING,this.onPlayEvent&&this.onPlayEvent(),this.sendEventToAllNodes("onStart"),this.starttime=LiteGraph.getTime(),this.last_update_time=this.starttime,e=e||0;var t=this;if(e==0&&typeof window<"u"&&window.requestAnimationFrame){let n=function(){t.execution_timer_id==-1&&(window.requestAnimationFrame(n),t.onBeforeStep&&t.onBeforeStep(),t.runStep(1,!t.catch_errors),t.onAfterStep&&t.onAfterStep())};this.execution_timer_id=-1,n()}else this.execution_timer_id=setInterval(function(){t.onBeforeStep&&t.onBeforeStep(),t.runStep(1,!t.catch_errors),t.onAfterStep&&t.onAfterStep()},e)}},LGraph.prototype.stop=function(){this.status!=LGraph.STATUS_STOPPED&&(this.status=LGraph.STATUS_STOPPED,this.onStopEvent&&this.onStopEvent(),this.execution_timer_id!=null&&(this.execution_timer_id!=-1&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))},LGraph.prototype.runStep=function(e,t,n){e=e||1;var r=LiteGraph.getTime();this.globaltime=.001*(r-this.starttime);var s=this._nodes_executable?this._nodes_executable:this._nodes;if(s){if(n=n||s.length,t){for(var o=0;o<e;o++){for(var h=0;h<n;++h){var u=s[h];LiteGraph.use_deferred_actions&&u._waiting_actions&&u._waiting_actions.length&&u.executePendingActions(),u.mode==LiteGraph.ALWAYS&&u.onExecute&&u.doExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute()}else try{for(var o=0;o<e;o++){for(var h=0;h<n;++h){var u=s[h];LiteGraph.use_deferred_actions&&u._waiting_actions&&u._waiting_actions.length&&u.executePendingActions(),u.mode==LiteGraph.ALWAYS&&u.onExecute&&u.onExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute(),this.errors_in_execution=!1}catch(_){if(this.errors_in_execution=!0,LiteGraph.throw_errors)throw _;LiteGraph.debug&&console.log("Error during execution: "+_),this.stop()}var f=LiteGraph.getTime(),c=f-r;c==0&&(c=1),this.execution_time=.001*c,this.globaltime+=.001*c,this.iteration+=1,this.elapsed_time=(f-this.last_update_time)*.001,this.last_update_time=f,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[]}},LGraph.prototype.updateExecutionOrder=function(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(var e=0;e<this._nodes_in_order.length;++e)this._nodes_in_order[e].onExecute&&this._nodes_executable.push(this._nodes_in_order[e])},LGraph.prototype.computeExecutionOrder=function(e,t){for(var n=[],r=[],s={},o={},h={},u=0,z=this._nodes.length;u<z;++u){var f=this._nodes[u];if(!(e&&!f.onExecute)){s[f.id]=f;var c=0;if(f.inputs)for(var _=0,O=f.inputs.length;_<O;_++)f.inputs[_]&&f.inputs[_].link!=null&&(c+=1);c==0?(r.push(f),t&&(f._level=1)):(t&&(f._level=0),h[f.id]=c)}}for(;r.length!=0;){var f=r.shift();if(n.push(f),delete s[f.id],!!f.outputs)for(var u=0;u<f.outputs.length;u++){var d=f.outputs[u];if(!(d==null||d.links==null||d.links.length==0))for(var _=0;_<d.links.length;_++){var b=d.links[_],S=this.links[b];if(S&&!o[S.id]){var G=this.getNodeById(S.target_id);if(G==null){o[S.id]=!0;continue}t&&(!G._level||G._level<=f._level)&&(G._level=f._level+1),o[S.id]=!0,h[G.id]-=1,h[G.id]==0&&r.push(G)}}}}for(var u in s)n.push(s[u]);n.length!=this._nodes.length&&LiteGraph.debug&&console.warn("something went wrong, nodes missing");for(var z=n.length,u=0;u<z;++u)n[u].order=u;n=n.sort(function($,A){var l=$.constructor.priority||$.priority||0,I=A.constructor.priority||A.priority||0;return l==I?$.order-A.order:l-I});for(var u=0;u<z;++u)n[u].order=u;return n},LGraph.prototype.getAncestors=function(e){for(var t=[],n=[e],r={};n.length;){var s=n.shift();if(s.inputs){!r[s.id]&&s!=e&&(r[s.id]=!0,t.push(s));for(var o=0;o<s.inputs.length;++o){var h=s.getInputNode(o);h&&t.indexOf(h)==-1&&n.push(h)}}}return t.sort(function(u,f){return u.order-f.order}),t},LGraph.prototype.arrange=function(e,t){e=e||100;const n=this.computeExecutionOrder(!1,!0),r=[];for(let o=0;o<n.length;++o){const h=n[o],u=h._level||1;r[u]||(r[u]=[]),r[u].push(h)}let s=e;for(let o=0;o<r.length;++o){const h=r[o];if(!h)continue;let u=100,f=e+LiteGraph.NODE_TITLE_HEIGHT;for(let c=0;c<h.length;++c){const _=h[c];_.pos[0]=t==LiteGraph.VERTICAL_LAYOUT?f:s,_.pos[1]=t==LiteGraph.VERTICAL_LAYOUT?s:f;const O=t==LiteGraph.VERTICAL_LAYOUT?1:0;_.size[O]>u&&(u=_.size[O]);const d=t==LiteGraph.VERTICAL_LAYOUT?0:1;f+=_.size[d]+e+LiteGraph.NODE_TITLE_HEIGHT}s+=u+e}this.setDirtyCanvas(!0,!0)},LGraph.prototype.getTime=function(){return this.globaltime},LGraph.prototype.getFixedTime=function(){return this.fixedtime},LGraph.prototype.getElapsedTime=function(){return this.elapsed_time},LGraph.prototype.sendEventToAllNodes=function(e,t,n){n=n||LiteGraph.ALWAYS;var r=this._nodes_in_order?this._nodes_in_order:this._nodes;if(r)for(var s=0,o=r.length;s<o;++s){var h=r[s];if(h.constructor===LiteGraph.Subgraph&&e!="onExecute"){h.mode==n&&h.sendEventToAllNodes(e,t,n);continue}!h[e]||h.mode!=n||(t===void 0?h[e]():t&&t.constructor===Array?h[e].apply(h,t):h[e](t))}},LGraph.prototype.sendActionToCanvas=function(e,t){if(this.list_of_graphcanvas)for(var n=0;n<this.list_of_graphcanvas.length;++n){var r=this.list_of_graphcanvas[n];r[e]&&r[e].apply(r,t)}},LGraph.prototype.add=function(e,t){if(e){if(e.constructor===LGraphGroup){this._groups.push(e),this.setDirtyCanvas(!0),this.change(),e.graph=this,this._version++;return}if(e.id!=-1&&this._nodes_by_id[e.id]!=null&&(console.warn("LiteGraph: there is already a node with this ID, changing it"),LiteGraph.use_uuids?e.id=LiteGraph.uuidv4():e.id=++this.last_node_id),this._nodes.length>=LiteGraph.MAX_NUMBER_OF_NODES)throw"LiteGraph: max number of nodes in a graph reached";return LiteGraph.use_uuids?(e.id==null||e.id==-1)&&(e.id=LiteGraph.uuidv4()):e.id==null||e.id==-1?e.id=++this.last_node_id:this.last_node_id<e.id&&(this.last_node_id=e.id),e.graph=this,this._version++,this._nodes.push(e),this._nodes_by_id[e.id]=e,e.onAdded&&e.onAdded(this),this.config.align_to_grid&&e.alignToGrid(),t||this.updateExecutionOrder(),this.onNodeAdded&&this.onNodeAdded(e),this.setDirtyCanvas(!0),this.change(),e}},LGraph.prototype.remove=function(e){if(e.constructor===LiteGraph.LGraphGroup){var t=this._groups.indexOf(e);t!=-1&&this._groups.splice(t,1),e.graph=null,this._version++,this.setDirtyCanvas(!0,!0),this.change();return}if(this._nodes_by_id[e.id]!=null&&!e.ignore_remove){if(this.beforeChange(),e.inputs)for(var n=0;n<e.inputs.length;n++){var r=e.inputs[n];r.link!=null&&e.disconnectInput(n)}if(e.outputs)for(var n=0;n<e.outputs.length;n++){var r=e.outputs[n];r.links!=null&&r.links.length&&e.disconnectOutput(n)}if(e.onRemoved&&e.onRemoved(),e.graph=null,this._version++,this.list_of_graphcanvas)for(var n=0;n<this.list_of_graphcanvas.length;++n){var s=this.list_of_graphcanvas[n];s.selected_nodes[e.id]&&delete s.selected_nodes[e.id],s.node_dragged==e&&(s.node_dragged=null)}var o=this._nodes.indexOf(e);o!=-1&&this._nodes.splice(o,1),delete this._nodes_by_id[e.id],this.onNodeRemoved&&this.onNodeRemoved(e),this.sendActionToCanvas("checkPanels"),this.setDirtyCanvas(!0,!0),this.afterChange(),this.change(),this.updateExecutionOrder()}},LGraph.prototype.getNodeById=function(e){return e==null?null:this._nodes_by_id[e]},LGraph.prototype.findNodesByClass=function(e,t){t=t||[],t.length=0;for(var n=0,r=this._nodes.length;n<r;++n)this._nodes[n].constructor===e&&t.push(this._nodes[n]);return t},LGraph.prototype.findNodesByType=function(n,t){var n=n.toLowerCase();t=t||[],t.length=0;for(var r=0,s=this._nodes.length;r<s;++r)this._nodes[r].type.toLowerCase()==n&&t.push(this._nodes[r]);return t},LGraph.prototype.findNodeByTitle=function(e){for(var t=0,n=this._nodes.length;t<n;++t)if(this._nodes[t].title==e)return this._nodes[t];return null},LGraph.prototype.findNodesByTitle=function(e){for(var t=[],n=0,r=this._nodes.length;n<r;++n)this._nodes[n].title==e&&t.push(this._nodes[n]);return t},LGraph.prototype.getNodeOnPos=function(e,t,n,r){n=n||this._nodes;for(var s=null,o=n.length-1;o>=0;o--){var h=n[o];if(h.isPointInside(e,t,r))return h}return s},LGraph.prototype.getGroupOnPos=function(e,t){for(var n=this._groups.length-1;n>=0;n--){var r=this._groups[n];if(r.isPointInside(e,t,2,!0))return r}return null},LGraph.prototype.checkNodeTypes=function(){for(var e=0;e<this._nodes.length;e++){var t=this._nodes[e],n=LiteGraph.registered_node_types[t.type];if(t.constructor!=n){console.log("node being replaced by newer version: "+t.type);var r=LiteGraph.createNode(t.type);this._nodes[e]=r,r.configure(t.serialize()),r.graph=this,this._nodes_by_id[r.id]=r,t.inputs&&(r.inputs=t.inputs.concat()),t.outputs&&(r.outputs=t.outputs.concat())}}this.updateExecutionOrder()},LGraph.prototype.onAction=function(e,t,n){this._input_nodes=this.findNodesByClass(LiteGraph.GraphInput,this._input_nodes);for(var r=0;r<this._input_nodes.length;++r){var s=this._input_nodes[r];if(s.properties.name==e){s.actionDo(e,t,n);break}}},LGraph.prototype.trigger=function(e,t){this.onTrigger&&this.onTrigger(e,t)},LGraph.prototype.addInput=function(e,t,n){var r=this.inputs[e];r||(this.beforeChange(),this.inputs[e]={name:e,type:t,value:n},this._version++,this.afterChange(),this.onInputAdded&&this.onInputAdded(e,t),this.onInputsOutputsChange&&this.onInputsOutputsChange())},LGraph.prototype.setInputData=function(e,t){var n=this.inputs[e];n&&(n.value=t)},LGraph.prototype.getInputData=function(e){var t=this.inputs[e];return t?t.value:null},LGraph.prototype.renameInput=function(e,t){if(t!=e){if(!this.inputs[e])return!1;if(this.inputs[t])return console.error("there is already one input with that name"),!1;this.inputs[t]=this.inputs[e],delete this.inputs[e],this._version++,this.onInputRenamed&&this.onInputRenamed(e,t),this.onInputsOutputsChange&&this.onInputsOutputsChange()}},LGraph.prototype.changeInputType=function(e,t){if(!this.inputs[e])return!1;this.inputs[e].type&&String(this.inputs[e].type).toLowerCase()==String(t).toLowerCase()||(this.inputs[e].type=t,this._version++,this.onInputTypeChanged&&this.onInputTypeChanged(e,t))},LGraph.prototype.removeInput=function(e){return this.inputs[e]?(delete this.inputs[e],this._version++,this.onInputRemoved&&this.onInputRemoved(e),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0):!1},LGraph.prototype.addOutput=function(e,t,n){this.outputs[e]={name:e,type:t,value:n},this._version++,this.onOutputAdded&&this.onOutputAdded(e,t),this.onInputsOutputsChange&&this.onInputsOutputsChange()},LGraph.prototype.setOutputData=function(e,t){var n=this.outputs[e];n&&(n.value=t)},LGraph.prototype.getOutputData=function(e){var t=this.outputs[e];return t?t.value:null},LGraph.prototype.renameOutput=function(e,t){if(!this.outputs[e])return!1;if(this.outputs[t])return console.error("there is already one output with that name"),!1;this.outputs[t]=this.outputs[e],delete this.outputs[e],this._version++,this.onOutputRenamed&&this.onOutputRenamed(e,t),this.onInputsOutputsChange&&this.onInputsOutputsChange()},LGraph.prototype.changeOutputType=function(e,t){if(!this.outputs[e])return!1;this.outputs[e].type&&String(this.outputs[e].type).toLowerCase()==String(t).toLowerCase()||(this.outputs[e].type=t,this._version++,this.onOutputTypeChanged&&this.onOutputTypeChanged(e,t))},LGraph.prototype.removeOutput=function(e){return this.outputs[e]?(delete this.outputs[e],this._version++,this.onOutputRemoved&&this.onOutputRemoved(e),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0):!1},LGraph.prototype.triggerInput=function(e,t){for(var n=this.findNodesByTitle(e),r=0;r<n.length;++r)n[r].onTrigger(t)},LGraph.prototype.setCallback=function(e,t){for(var n=this.findNodesByTitle(e),r=0;r<n.length;++r)n[r].setTrigger(t)},LGraph.prototype.beforeChange=function(e){this.onBeforeChange&&this.onBeforeChange(this,e),this.sendActionToCanvas("onBeforeChange",this)},LGraph.prototype.afterChange=function(e){this.onAfterChange&&this.onAfterChange(this,e),this.sendActionToCanvas("onAfterChange",this)},LGraph.prototype.connectionChange=function(e,t){this.updateExecutionOrder(),this.onConnectionChange&&this.onConnectionChange(e),this._version++,this.sendActionToCanvas("onConnectionChange")},LGraph.prototype.isLive=function(){if(!this.list_of_graphcanvas)return!1;for(var e=0;e<this.list_of_graphcanvas.length;++e){var t=this.list_of_graphcanvas[e];if(t.live_mode)return!0}return!1},LGraph.prototype.clearTriggeredSlots=function(){for(var e in this.links){var t=this.links[e];t&&t._last_time&&(t._last_time=0)}},LGraph.prototype.change=function(){LiteGraph.debug&&console.log("Graph changed"),this.sendActionToCanvas("setDirty",[!0,!0]),this.on_change&&this.on_change(this)},LGraph.prototype.setDirtyCanvas=function(e,t){this.sendActionToCanvas("setDirty",[e,t])},LGraph.prototype.removeLink=function(e){var t=this.links[e];if(t){var n=this.getNodeById(t.target_id);n&&n.disconnectInput(t.target_slot)}},LGraph.prototype.serialize=function(){for(var e=[],t=0,n=this._nodes.length;t<n;++t)e.push(this._nodes[t].serialize());var r=[];for(var t in this.links){var s=this.links[t];if(!s.serialize){console.warn("weird LLink bug, link info is not a LLink but a regular object");var o=new LLink;for(var h in s)o[h]=s[h];this.links[t]=o,s=o}r.push(s.serialize())}for(var u=[],t=0;t<this._groups.length;++t)u.push(this._groups[t].serialize());var f={last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:e,links:r,groups:u,config:this.config,extra:this.extra,version:LiteGraph.VERSION};return this.onSerialize&&this.onSerialize(f),f},LGraph.prototype.configure=function(e,t){if(e){t||this.clear();var n=e.nodes;if(e.links&&e.links.constructor===Array){for(var r=[],s=0;s<e.links.length;++s){var o=e.links[s];if(!o){console.warn("serialized graph link data contains errors, skipping.");continue}var h=new LLink;h.configure(o),r[h.id]=h}e.links=r}for(var s in e)s=="nodes"||s=="groups"||(this[s]=e[s]);var u=!1;if(this._nodes=[],n){for(var s=0,f=n.length;s<f;++s){var c=n[s],_=LiteGraph.createNode(c.type,c.title);_||(LiteGraph.debug&&console.log("Node not found or has errors: "+c.type),_=new LGraphNode,_.last_serialization=c,_.has_errors=!0,u=!0),_.id=c.id,this.add(_,!0)}for(var s=0,f=n.length;s<f;++s){var c=n[s],_=this.getNodeById(c.id);_&&_.configure(c)}}if(this._groups.length=0,e.groups)for(var s=0;s<e.groups.length;++s){var O=new LiteGraph.LGraphGroup;O.configure(e.groups[s]),this.add(O)}return this.updateExecutionOrder(),this.extra=e.extra||{},this.onConfigure&&this.onConfigure(e),this._version++,this.setDirtyCanvas(!0,!0),u}},LGraph.prototype.load=function(e,t){var n=this;if(e.constructor===File||e.constructor===Blob){var r=new FileReader;r.addEventListener("load",function(o){var h=JSON.parse(o.target.result);n.configure(h),t&&t()}),r.readAsText(e);return}var s=new XMLHttpRequest;s.open("GET",e,!0),s.send(null),s.onload=function(o){if(s.status!==200){console.error("Error loading graph:",s.status,s.response);return}var h=JSON.parse(s.response);n.configure(h),t&&t()},s.onerror=function(o){console.error("Error loading graph:",o)}},LGraph.prototype.onNodeTrace=function(e,t,n){};function LLink(e,t,n,r,s,o){this.id=e,this.type=t,this.origin_id=n,this.origin_slot=r,this.target_id=s,this.target_slot=o,this._data=null,this._pos=new Float32Array(2)}LLink.prototype.configure=function(e){e.constructor===Array?(this.id=e[0],this.origin_id=e[1],this.origin_slot=e[2],this.target_id=e[3],this.target_slot=e[4],this.type=e[5]):(this.id=e.id,this.type=e.type,this.origin_id=e.origin_id,this.origin_slot=e.origin_slot,this.target_id=e.target_id,this.target_slot=e.target_slot)},LLink.prototype.serialize=function(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]},LiteGraph.LLink=LLink;function LGraphNode(e){this._ctor(e)}global.LGraphNode=LiteGraph.LGraphNode=LGraphNode,LGraphNode.prototype._ctor=function(e){this.title=e||"Unnamed",this.size=[LiteGraph.NODE_WIDTH,60],this.graph=null,this._pos=new Float32Array(10,10),Object.defineProperty(this,"pos",{set:function(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])},get:function(){return this._pos},enumerable:!0}),LiteGraph.use_uuids?this.id=LiteGraph.uuidv4():this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.properties_info=[],this.flags={}},LGraphNode.prototype.configure=function(e){this.graph&&this.graph._version++;for(var t in e){if(t=="properties"){for(var n in e.properties)this.properties[n]=e.properties[n],this.onPropertyChanged&&this.onPropertyChanged(n,e.properties[n]);continue}e[t]!=null&&(typeof e[t]=="object"?this[t]&&this[t].configure?this[t].configure(e[t]):this[t]=LiteGraph.cloneObject(e[t],this[t]):this[t]=e[t])}if(e.title||(this.title=this.constructor.title),this.inputs)for(var r=0;r<this.inputs.length;++r){var s=this.inputs[r],o=this.graph?this.graph.links[s.link]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,r,!0,o,s),this.onInputAdded&&this.onInputAdded(s)}if(this.outputs)for(var r=0;r<this.outputs.length;++r){var h=this.outputs[r];if(h.links){for(var t=0;t<h.links.length;++t){var o=this.graph?this.graph.links[h.links[t]]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,r,!0,o,h)}this.onOutputAdded&&this.onOutputAdded(h)}}if(this.widgets){for(var r=0;r<this.widgets.length;++r){var u=this.widgets[r];u&&u.options&&u.options.property&&this.properties[u.options.property]!=null&&(u.value=JSON.parse(JSON.stringify(this.properties[u.options.property])))}if(e.widgets_values)for(var r=0;r<e.widgets_values.length;++r)this.widgets[r]&&(this.widgets[r].value=e.widgets_values[r])}this.onConfigure&&this.onConfigure(e)},LGraphNode.prototype.serialize=function(){var e={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:LiteGraph.cloneObject(this.flags),order:this.order,mode:this.mode};if(this.constructor===LGraphNode&&this.last_serialization)return this.last_serialization;if(this.inputs&&(e.inputs=this.inputs),this.outputs){for(var t=0;t<this.outputs.length;t++)delete this.outputs[t]._data;e.outputs=this.outputs}if(this.title&&this.title!=this.constructor.title&&(e.title=this.title),this.properties&&(e.properties=LiteGraph.cloneObject(this.properties)),this.widgets&&this.serialize_widgets){e.widgets_values=[];for(var t=0;t<this.widgets.length;++t)this.widgets[t]?e.widgets_values[t]=this.widgets[t].value:e.widgets_values[t]=null}return e.type||(e.type=this.constructor.type),this.color&&(e.color=this.color),this.bgcolor&&(e.bgcolor=this.bgcolor),this.boxcolor&&(e.boxcolor=this.boxcolor),this.shape&&(e.shape=this.shape),this.onSerialize&&this.onSerialize(e)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),e},LGraphNode.prototype.clone=function(){var e=LiteGraph.createNode(this.type);if(!e)return null;var t=LiteGraph.cloneObject(this.serialize());if(t.inputs)for(var n=0;n<t.inputs.length;++n)t.inputs[n].link=null;if(t.outputs)for(var n=0;n<t.outputs.length;++n)t.outputs[n].links&&(t.outputs[n].links.length=0);return delete t.id,LiteGraph.use_uuids&&(t.id=LiteGraph.uuidv4()),e.configure(t),e},LGraphNode.prototype.toString=function(){return JSON.stringify(this.serialize())},LGraphNode.prototype.getTitle=function(){return this.title||this.constructor.title},LGraphNode.prototype.setProperty=function(e,t){if(this.properties||(this.properties={}),t!==this.properties[e]){var n=this.properties[e];if(this.properties[e]=t,this.onPropertyChanged&&this.onPropertyChanged(e,t,n)===!1&&(this.properties[e]=n),this.widgets)for(var r=0;r<this.widgets.length;++r){var s=this.widgets[r];if(s&&s.options.property==e){s.value=t;break}}}},LGraphNode.prototype.setOutputData=function(e,t){if(this.outputs&&!(e==-1||e>=this.outputs.length)){var n=this.outputs[e];if(n&&(n._data=t,this.outputs[e].links))for(var r=0;r<this.outputs[e].links.length;r++){var s=this.outputs[e].links[r],o=this.graph.links[s];o&&(o.data=t)}}},LGraphNode.prototype.setOutputDataType=function(e,t){if(this.outputs&&!(e==-1||e>=this.outputs.length)){var n=this.outputs[e];if(n&&(n.type=t,this.outputs[e].links))for(var r=0;r<this.outputs[e].links.length;r++){var s=this.outputs[e].links[r];this.graph.links[s].type=t}}},LGraphNode.prototype.getInputData=function(e,t){if(this.inputs&&!(e>=this.inputs.length||this.inputs[e].link==null)){var n=this.inputs[e].link,r=this.graph.links[n];if(!r)return null;if(!t)return r.data;var s=this.graph.getNodeById(r.origin_id);return s&&(s.updateOutputData?s.updateOutputData(r.origin_slot):s.onExecute&&s.onExecute()),r.data}},LGraphNode.prototype.getInputDataType=function(e){if(!this.inputs||e>=this.inputs.length||this.inputs[e].link==null)return null;var t=this.inputs[e].link,n=this.graph.links[t];if(!n)return null;var r=this.graph.getNodeById(n.origin_id);if(!r)return n.type;var s=r.outputs[n.origin_slot];return s?s.type:null},LGraphNode.prototype.getInputDataByName=function(e,t){var n=this.findInputSlot(e);return n==-1?null:this.getInputData(n,t)},LGraphNode.prototype.isInputConnected=function(e){return this.inputs?e<this.inputs.length&&this.inputs[e].link!=null:!1},LGraphNode.prototype.getInputInfo=function(e){return this.inputs&&e<this.inputs.length?this.inputs[e]:null},LGraphNode.prototype.getInputLink=function(e){if(!this.inputs)return null;if(e<this.inputs.length){var t=this.inputs[e];return this.graph.links[t.link]}return null},LGraphNode.prototype.getInputNode=function(e){if(!this.inputs||e>=this.inputs.length)return null;var t=this.inputs[e];if(!t||t.link===null)return null;var n=this.graph.links[t.link];return n?this.graph.getNodeById(n.origin_id):null},LGraphNode.prototype.getInputOrProperty=function(e){if(!this.inputs||!this.inputs.length)return this.properties?this.properties[e]:null;for(var t=0,n=this.inputs.length;t<n;++t){var r=this.inputs[t];if(e==r.name&&r.link!=null){var s=this.graph.links[r.link];if(s)return s.data}}return this.properties[e]},LGraphNode.prototype.getOutputData=function(e){if(!this.outputs||e>=this.outputs.length)return null;var t=this.outputs[e];return t._data},LGraphNode.prototype.getOutputInfo=function(e){return this.outputs&&e<this.outputs.length?this.outputs[e]:null},LGraphNode.prototype.isOutputConnected=function(e){return this.outputs?e<this.outputs.length&&this.outputs[e].links&&this.outputs[e].links.length:!1},LGraphNode.prototype.isAnyOutputConnected=function(){if(!this.outputs)return!1;for(var e=0;e<this.outputs.length;++e)if(this.outputs[e].links&&this.outputs[e].links.length)return!0;return!1},LGraphNode.prototype.getOutputNodes=function(e){if(!this.outputs||this.outputs.length==0||e>=this.outputs.length)return null;var t=this.outputs[e];if(!t.links||t.links.length==0)return null;for(var n=[],r=0;r<t.links.length;r++){var s=t.links[r],o=this.graph.links[s];if(o){var h=this.graph.getNodeById(o.target_id);h&&n.push(h)}}return n},LGraphNode.prototype.addOnTriggerInput=function(){var e=this.findInputSlot("onTrigger");if(e==-1){//!trigS || 
return this.addInput("onTrigger",LiteGraph.EVENT,{optional:!0,nameLocked:!0}),this.findInputSlot("onTrigger")}return e},LGraphNode.prototype.addOnExecutedOutput=function(){var e=this.findOutputSlot("onExecuted");if(e==-1){//!trigS || 
return this.addOutput("onExecuted",LiteGraph.ACTION,{optional:!0,nameLocked:!0}),this.findOutputSlot("onExecuted")}return e},LGraphNode.prototype.onAfterExecuteNode=function(e,t){var n=this.findOutputSlot("onExecuted");n!=-1&&this.triggerSlot(n,e,null,t)},LGraphNode.prototype.changeMode=function(e){switch(e){case LiteGraph.ON_EVENT:break;case LiteGraph.ON_TRIGGER:this.addOnTriggerInput(),this.addOnExecutedOutput();break;case LiteGraph.NEVER:break;case LiteGraph.ALWAYS:break;case LiteGraph.ON_REQUEST:break;default:return!1}return this.mode=e,!0},LGraphNode.prototype.executePendingActions=function(){if(!(!this._waiting_actions||!this._waiting_actions.length)){for(var e=0;e<this._waiting_actions.length;++e){var t=this._waiting_actions[e];this.onAction(t[0],t[1],t[2],t[3],t[4])}this._waiting_actions.length=0}},LGraphNode.prototype.doExecute=function(e,t){t=t||{},this.onExecute&&(t.action_call||(t.action_call=this.id+"_exec_"+Math.floor(Math.random()*9999)),this.graph.nodes_executing[this.id]=!0,this.onExecute(e,t),this.graph.nodes_executing[this.id]=!1,this.exec_version=this.graph.iteration,t&&t.action_call&&(this.action_call=t.action_call,this.graph.nodes_executedAction[this.id]=t.action_call)),this.execute_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(e,t)},LGraphNode.prototype.actionDo=function(e,t,n,r){n=n||{},this.onAction&&(n.action_call||(n.action_call=this.id+"_"+(e||"action")+"_"+Math.floor(Math.random()*9999)),this.graph.nodes_actioning[this.id]=e||"actioning",this.onAction(e,t,n,r),this.graph.nodes_actioning[this.id]=!1,n&&n.action_call&&(this.action_call=n.action_call,this.graph.nodes_executedAction[this.id]=n.action_call)),this.action_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(t,n)},LGraphNode.prototype.trigger=function(e,t,n){if(!(!this.outputs||!this.outputs.length)){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var r=0;r<this.outputs.length;++r){var s=this.outputs[r];!s||s.type!==LiteGraph.EVENT||e&&s.name!=e||this.triggerSlot(r,t,null,n)}}},LGraphNode.prototype.triggerSlot=function(e,t,n,r){if(r=r||{},!!this.outputs){if(e==null){console.error("slot must be a number");return}e.constructor!==Number&&console.warn("slot must be a number, use node.trigger('name') if you want to use a string");var s=this.outputs[e];if(s){var o=s.links;if(!(!o||!o.length)){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var h=0;h<o.length;++h){var u=o[h];if(!(n!=null&&n!=u)){var f=this.graph.links[o[h]];if(f){f._last_time=LiteGraph.getTime();var c=this.graph.getNodeById(f.target_id);if(c){var _=c.inputs[f.target_slot];if(c.mode===LiteGraph.ON_TRIGGER)r.action_call||(r.action_call=this.id+"_trigg_"+Math.floor(Math.random()*9999)),c.onExecute&&c.doExecute(t,r);else if(c.onAction){r.action_call||(r.action_call=this.id+"_act_"+Math.floor(Math.random()*9999));var _=c.inputs[f.target_slot];LiteGraph.use_deferred_actions&&c.onExecute?(c._waiting_actions||(c._waiting_actions=[]),c._waiting_actions.push([_.name,t,r,f.target_slot])):c.actionDo(_.name,t,r,f.target_slot)}}}}}}}}},LGraphNode.prototype.clearTriggeredSlot=function(e,t){if(this.outputs){var n=this.outputs[e];if(n){var r=n.links;if(!(!r||!r.length))for(var s=0;s<r.length;++s){var o=r[s];if(!(t!=null&&t!=o)){var h=this.graph.links[r[s]];h&&(h._last_time=0)}}}}},LGraphNode.prototype.setSize=function(e){this.size=e,this.onResize&&this.onResize(this.size)},LGraphNode.prototype.addProperty=function(e,t,n,r){var s={name:e,type:n,default_value:t};if(r)for(var o in r)s[o]=r[o];return this.properties_info||(this.properties_info=[]),this.properties_info.push(s),this.properties||(this.properties={}),this.properties[e]=t,s},LGraphNode.prototype.addOutput=function(e,t,n){var r={name:e,type:t,links:null};if(n)for(var s in n)r[s]=n[s];return this.outputs||(this.outputs=[]),this.outputs.push(r),this.onOutputAdded&&this.onOutputAdded(r),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,t,!0),this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0),r},LGraphNode.prototype.addOutputs=function(e){for(var t=0;t<e.length;++t){var n=e[t],r={name:n[0],type:n[1],link:null};if(e[2])for(var s in n[2])r[s]=n[2][s];this.outputs||(this.outputs=[]),this.outputs.push(r),this.onOutputAdded&&this.onOutputAdded(r),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,n[1],!0)}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.removeOutput=function(e){this.disconnectOutput(e),this.outputs.splice(e,1);for(var t=e;t<this.outputs.length;++t)if(!(!this.outputs[t]||!this.outputs[t].links))for(var n=this.outputs[t].links,r=0;r<n.length;++r){var s=this.graph.links[n[r]];s&&(s.origin_slot-=1)}this.setSize(this.computeSize()),this.onOutputRemoved&&this.onOutputRemoved(e),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.addInput=function(e,t,n){t=t||0;var r={name:e,type:t,link:null};if(n)for(var s in n)r[s]=n[s];return this.inputs||(this.inputs=[]),this.inputs.push(r),this.setSize(this.computeSize()),this.onInputAdded&&this.onInputAdded(r),LiteGraph.registerNodeAndSlotType(this,t),this.setDirtyCanvas(!0,!0),r},LGraphNode.prototype.addInputs=function(e){for(var t=0;t<e.length;++t){var n=e[t],r={name:n[0],type:n[1],link:null};if(e[2])for(var s in n[2])r[s]=n[2][s];this.inputs||(this.inputs=[]),this.inputs.push(r),this.onInputAdded&&this.onInputAdded(r),LiteGraph.registerNodeAndSlotType(this,n[1])}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.removeInput=function(e){this.disconnectInput(e);for(var t=this.inputs.splice(e,1),n=e;n<this.inputs.length;++n)if(this.inputs[n]){var r=this.graph.links[this.inputs[n].link];r&&(r.target_slot-=1)}this.setSize(this.computeSize()),this.onInputRemoved&&this.onInputRemoved(e,t[0]),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.addConnection=function(e,t,n,r){var s={name:e,type:t,pos:n,direction:r,links:null};return this.connections.push(s),s},LGraphNode.prototype.computeSize=function(e){if(this.constructor.size)return this.constructor.size.concat();var t=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1),n=e||new Float32Array([0,0]);t=Math.max(t,1);var r=LiteGraph.NODE_TEXT_SIZE,s=S(this.title),o=0,h=0;if(this.inputs)for(var u=0,f=this.inputs.length;u<f;++u){var c=this.inputs[u],_=c.label||c.name||"",O=S(_);o<O&&(o=O)}if(this.outputs)for(var u=0,f=this.outputs.length;u<f;++u){var d=this.outputs[u],_=d.label||d.name||"",O=S(_);h<O&&(h=O)}n[0]=Math.max(o+h+10,s),n[0]=Math.max(n[0],LiteGraph.NODE_WIDTH),this.widgets&&this.widgets.length&&(n[0]=Math.max(n[0],LiteGraph.NODE_WIDTH*1.5)),n[1]=(this.constructor.slot_start_y||0)+t*LiteGraph.NODE_SLOT_HEIGHT;var b=0;if(this.widgets&&this.widgets.length){for(var u=0,f=this.widgets.length;u<f;++u)this.widgets[u].computeSize?b+=this.widgets[u].computeSize(n[0])[1]+4:b+=LiteGraph.NODE_WIDGET_HEIGHT+4;b+=8}this.widgets_up?n[1]=Math.max(n[1],b):this.widgets_start_y!=null?n[1]=Math.max(n[1],b+this.widgets_start_y):n[1]+=b;function S(G){return G?r*G.length*.6:0}return this.constructor.min_height&&n[1]<this.constructor.min_height&&(n[1]=this.constructor.min_height),n[1]+=6,n},LGraphNode.prototype.getPropertyInfo=function(e){var t=null;if(this.properties_info){for(var n=0;n<this.properties_info.length;++n)if(this.properties_info[n].name==e){t=this.properties_info[n];break}}return this.constructor["@"+e]&&(t=this.constructor["@"+e]),this.constructor.widgets_info&&this.constructor.widgets_info[e]&&(t=this.constructor.widgets_info[e]),!t&&this.onGetPropertyInfo&&(t=this.onGetPropertyInfo(e)),t||(t={}),t.type||(t.type=typeof this.properties[e]),t.widget=="combo"&&(t.type="enum"),t},LGraphNode.prototype.addWidget=function(e,t,n,r,s){this.widgets||(this.widgets=[]),!s&&r&&r.constructor===Object&&(s=r,r=null),s&&s.constructor===String&&(s={property:s}),r&&r.constructor===String&&(s||(s={}),s.property=r,r=null),r&&r.constructor!==Function&&(console.warn("addWidget: callback must be a function"),r=null);var o={type:e.toLowerCase(),name:t,value:n,callback:r,options:s||{}};if(o.options.y!==void 0&&(o.y=o.options.y),!r&&!o.options.callback&&!o.options.property&&console.warn("LiteGraph addWidget(...) without a callback or property assigned"),e=="combo"&&!o.options.values)throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }";return this.widgets.push(o),this.setSize(this.computeSize()),o},LGraphNode.prototype.addCustomWidget=function(e){return this.widgets||(this.widgets=[]),this.widgets.push(e),e},LGraphNode.prototype.getBounding=function(e,t){e=e||new Float32Array(4);const n=this.pos,r=this.flags.collapsed,s=this.size;let o=0,h=1,u=0,f=0;return t&&(o=4,h=6+o,u=4,f=5+u),e[0]=n[0]-o,e[1]=n[1]-LiteGraph.NODE_TITLE_HEIGHT-u,e[2]=r?(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+h:s[0]+h,e[3]=r?LiteGraph.NODE_TITLE_HEIGHT+f:s[1]+LiteGraph.NODE_TITLE_HEIGHT+f,this.onBounding&&this.onBounding(e),e},LGraphNode.prototype.isPointInside=function(e,t,n,r){n=n||0;var s=this.graph&&this.graph.isLive()?0:LiteGraph.NODE_TITLE_HEIGHT;if(r&&(s=0),this.flags&&this.flags.collapsed){if(isInsideRectangle(e,t,this.pos[0]-n,this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT-n,(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+2*n,LiteGraph.NODE_TITLE_HEIGHT+2*n))return!0}else if(this.pos[0]-4-n<e&&this.pos[0]+this.size[0]+4+n>e&&this.pos[1]-s-n<t&&this.pos[1]+this.size[1]+n>t)return!0;return!1},LGraphNode.prototype.getSlotInPosition=function(e,t){var n=new Float32Array(2);if(this.inputs)for(var r=0,s=this.inputs.length;r<s;++r){var o=this.inputs[r];if(this.getConnectionPos(!0,r,n),isInsideRectangle(e,t,n[0]-10,n[1]-5,20,10))return{input:o,slot:r,link_pos:n}}if(this.outputs)for(var r=0,s=this.outputs.length;r<s;++r){var h=this.outputs[r];if(this.getConnectionPos(!1,r,n),isInsideRectangle(e,t,n[0]-10,n[1]-5,20,10))return{output:h,slot:r,link_pos:n}}return null},LGraphNode.prototype.findInputSlot=function(e,t){if(!this.inputs)return-1;for(var n=0,r=this.inputs.length;n<r;++n)if(e==this.inputs[n].name)return t?this.inputs[n]:n;return-1},LGraphNode.prototype.findOutputSlot=function(e,t){if(t=t||!1,!this.outputs)return-1;for(var n=0,r=this.outputs.length;n<r;++n)if(e==this.outputs[n].name)return t?this.outputs[n]:n;return-1},LGraphNode.prototype.findInputSlotFree=function(t){var t=t||{},n={returnObj:!1,typesNotAccepted:[]},r=Object.assign(n,t);if(!this.inputs)return-1;for(var s=0,o=this.inputs.length;s<o;++s)if(!(this.inputs[s].link&&this.inputs[s].link!=null)&&!(r.typesNotAccepted&&r.typesNotAccepted.includes&&r.typesNotAccepted.includes(this.inputs[s].type)))return r.returnObj?this.inputs[s]:s;return-1},LGraphNode.prototype.findOutputSlotFree=function(t){var t=t||{},n={returnObj:!1,typesNotAccepted:[]},r=Object.assign(n,t);if(!this.outputs)return-1;for(var s=0,o=this.outputs.length;s<o;++s)if(!(this.outputs[s].links&&this.outputs[s].links!=null)&&!(r.typesNotAccepted&&r.typesNotAccepted.includes&&r.typesNotAccepted.includes(this.outputs[s].type)))return r.returnObj?this.outputs[s]:s;return-1},LGraphNode.prototype.findInputSlotByType=function(e,t,n,r){return this.findSlotByType(!0,e,t,n,r)},LGraphNode.prototype.findOutputSlotByType=function(e,t,n,r){return this.findSlotByType(!1,e,t,n,r)},LGraphNode.prototype.findSlotByType=function(e,t,n,r,s){e=e||!1,n=n||!1,r=r||!1,s=s||!1;var o=e?this.inputs:this.outputs;if(!o)return-1;(t==""||t=="*")&&(t=0);for(var h=0,u=o.length;h<u;++h){var f=(t+"").toLowerCase().split(","),c=o[h].type=="0"||o[h].type=="*"?"0":o[h].type;c=(c+"").toLowerCase().split(",");for(var _=0;_<f.length;_++)for(var O=0;O<c.length;O++)if(f[_]=="_event_"&&(f[_]=LiteGraph.EVENT),c[_]=="_event_"&&(c[_]=LiteGraph.EVENT),f[_]=="*"&&(f[_]=0),c[_]=="*"&&(c[_]=0),f[_]==c[O]){if(r&&o[h].links&&o[h].links!==null)continue;return n?o[h]:h}}if(r&&!s)for(var h=0,u=o.length;h<u;++h){var f=(t+"").toLowerCase().split(","),c=o[h].type=="0"||o[h].type=="*"?"0":o[h].type;c=(c+"").toLowerCase().split(",");for(var _=0;_<f.length;_++)for(var O=0;O<c.length;O++)if(f[_]=="*"&&(f[_]=0),c[_]=="*"&&(c[_]=0),f[_]==c[O])return n?o[h]:h}return-1},LGraphNode.prototype.connectByType=function(e,t,n,s){var s=s||{},o={createEventInCase:!0,firstFreeIfOutputGeneralInCase:!0,generalTypeInCase:!0},h=Object.assign(o,s);t&&t.constructor===Number&&(t=this.graph.getNodeById(t));var u=t.findInputSlotByType(n,!1,!0);if(u>=0&&u!==null)return this.connect(e,t,u);if(h.createEventInCase&&n==LiteGraph.EVENT)return this.connect(e,t,-1);if(h.generalTypeInCase){var u=t.findInputSlotByType(0,!1,!0,!0);if(u>=0)return this.connect(e,t,u)}if(h.firstFreeIfOutputGeneralInCase&&(n==0||n=="*"||n=="")){var u=t.findInputSlotFree({typesNotAccepted:[LiteGraph.EVENT]});if(u>=0)return this.connect(e,t,u)}return console.debug("no way to connect type: ",n," to targetNODE ",t),null},LGraphNode.prototype.connectByTypeOutput=function(e,t,n,s){var s=s||{},o={createEventInCase:!0,firstFreeIfInputGeneralInCase:!0,generalTypeInCase:!0},h=Object.assign(o,s);t&&t.constructor===Number&&(t=this.graph.getNodeById(t));var u=t.findOutputSlotByType(n,!1,!0);if(u>=0&&u!==null)return t.connect(u,this,e);if(h.generalTypeInCase){var u=t.findOutputSlotByType(0,!1,!0,!0);if(u>=0)return t.connect(u,this,e)}if(h.createEventInCase&&n==LiteGraph.EVENT&&LiteGraph.do_add_triggers_slots){var u=t.addOnExecutedOutput();return t.connect(u,this,e)}if(h.firstFreeIfInputGeneralInCase&&(n==0||n=="*"||n=="")){var u=t.findOutputSlotFree({typesNotAccepted:[LiteGraph.EVENT]});if(u>=0)return t.connect(u,this,e)}return console.debug("no way to connect byOUT type: ",n," to sourceNODE ",t),null},LGraphNode.prototype.connect=function(e,t,n){if(n=n||0,!this.graph)return console.log("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(e.constructor===String){if(e=this.findOutputSlot(e),e==-1)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+e),null}else if(!this.outputs||e>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;if(t&&t.constructor===Number&&(t=this.graph.getNodeById(t)),!t)throw"target node is null";if(t==this)return null;if(n.constructor===String){if(n=t.findInputSlot(n),n==-1)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+n),null}else if(n===LiteGraph.EVENT)if(LiteGraph.do_add_triggers_slots)t.changeMode(LiteGraph.ON_TRIGGER),n=t.findInputSlot("onTrigger");else return null;else if(!t.inputs||n>=t.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;var r=!1,s=t.inputs[n],o=null,h=this.outputs[e];if(!this.outputs[e])return null;if(t.onBeforeConnectInput&&(n=t.onBeforeConnectInput(n)),n===!1||n===null||!LiteGraph.isValidConnection(h.type,s.type))return this.setDirtyCanvas(!1,!0),r&&this.graph.connectionChange(this,o),null;if(t.onConnectInput&&t.onConnectInput(n,h.type,h,this,e)===!1||this.onConnectOutput&&this.onConnectOutput(e,s.type,s,t,n)===!1)return null;if(t.inputs[n]&&t.inputs[n].link!=null&&(this.graph.beforeChange(),t.disconnectInput(n,{doProcessChange:!1}),r=!0),h.links!==null&&h.links.length)switch(h.type){case LiteGraph.EVENT:LiteGraph.allow_multi_output_for_events||(this.graph.beforeChange(),this.disconnectOutput(e,!1,{doProcessChange:!1}),r=!0);break}var u;return LiteGraph.use_uuids?u=LiteGraph.uuidv4():u=++this.graph.last_link_id,o=new LLink(u,s.type||h.type,this.id,e,t.id,n),this.graph.links[o.id]=o,h.links==null&&(h.links=[]),h.links.push(o.id),t.inputs[n].link=o.id,this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,e,!0,o,h),t.onConnectionsChange&&t.onConnectionsChange(LiteGraph.INPUT,n,!0,o,s),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.INPUT,t,n,this,e),this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,e,t,n)),this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,o),o},LGraphNode.prototype.disconnectOutput=function(e,t){if(e.constructor===String){if(e=this.findOutputSlot(e),e==-1)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+e),!1}else if(!this.outputs||e>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;var n=this.outputs[e];if(!n||!n.links||n.links.length==0)return!1;if(t){if(t.constructor===Number&&(t=this.graph.getNodeById(t)),!t)throw"Target Node not found";for(var r=0,s=n.links.length;r<s;r++){var o=n.links[r],h=this.graph.links[o];if(h.target_id==t.id){n.links.splice(r,1);var u=t.inputs[h.target_slot];u.link=null,delete this.graph.links[o],this.graph&&this.graph._version++,t.onConnectionsChange&&t.onConnectionsChange(LiteGraph.INPUT,h.target_slot,!1,h,u),this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,e,!1,h,n),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,e),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,e),this.graph.onNodeConnectionChange(LiteGraph.INPUT,t,h.target_slot));break}}}else{for(var r=0,s=n.links.length;r<s;r++){var o=n.links[r],h=this.graph.links[o];if(h){var t=this.graph.getNodeById(h.target_id),u=null;this.graph&&this.graph._version++,t&&(u=t.inputs[h.target_slot],u.link=null,t.onConnectionsChange&&t.onConnectionsChange(LiteGraph.INPUT,h.target_slot,!1,h,u),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.INPUT,t,h.target_slot)),delete this.graph.links[o],this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,e,!1,h,n),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,e),this.graph.onNodeConnectionChange(LiteGraph.INPUT,t,h.target_slot))}}n.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0},LGraphNode.prototype.disconnectInput=function(e){if(e.constructor===String){if(e=this.findInputSlot(e),e==-1)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+e),!1}else if(!this.inputs||e>=this.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;var t=this.inputs[e];if(!t)return!1;var n=this.inputs[e].link;if(n!=null){this.inputs[e].link=null;var r=this.graph.links[n];if(r){var s=this.graph.getNodeById(r.origin_id);if(!s)return!1;var o=s.outputs[r.origin_slot];if(!o||!o.links||o.links.length==0)return!1;for(var h=0,u=o.links.length;h<u;h++)if(o.links[h]==n){o.links.splice(h,1);break}delete this.graph.links[n],this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,e,!1,r,t),s.onConnectionsChange&&s.onConnectionsChange(LiteGraph.OUTPUT,h,!1,r,o),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,s,h),this.graph.onNodeConnectionChange(LiteGraph.INPUT,this,e))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0},LGraphNode.prototype.getConnectionPos=function(e,t,n){n=n||new Float32Array(2);var r=0;e&&this.inputs&&(r=this.inputs.length),!e&&this.outputs&&(r=this.outputs.length);var s=LiteGraph.NODE_SLOT_HEIGHT*.5;if(this.flags.collapsed){var o=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH;return this.horizontal?(n[0]=this.pos[0]+o*.5,e?n[1]=this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:n[1]=this.pos[1]):(e?n[0]=this.pos[0]:n[0]=this.pos[0]+o,n[1]=this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT*.5),n}return e&&t==-1?(n[0]=this.pos[0]+LiteGraph.NODE_TITLE_HEIGHT*.5,n[1]=this.pos[1]+LiteGraph.NODE_TITLE_HEIGHT*.5,n):e&&r>t&&this.inputs[t].pos?(n[0]=this.pos[0]+this.inputs[t].pos[0],n[1]=this.pos[1]+this.inputs[t].pos[1],n):!e&&r>t&&this.outputs[t].pos?(n[0]=this.pos[0]+this.outputs[t].pos[0],n[1]=this.pos[1]+this.outputs[t].pos[1],n):this.horizontal?(n[0]=this.pos[0]+(t+.5)*(this.size[0]/r),e?n[1]=this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:n[1]=this.pos[1]+this.size[1],n):(e?n[0]=this.pos[0]+s:n[0]=this.pos[0]+this.size[0]+1-s,n[1]=this.pos[1]+(t+.7)*LiteGraph.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0),n)},LGraphNode.prototype.alignToGrid=function(){this.pos[0]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[0]/LiteGraph.CANVAS_GRID_SIZE),this.pos[1]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[1]/LiteGraph.CANVAS_GRID_SIZE)},LGraphNode.prototype.trace=function(e){this.console||(this.console=[]),this.console.push(e),this.console.length>LGraphNode.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace&&this.graph.onNodeTrace(this,e)},LGraphNode.prototype.setDirtyCanvas=function(e,t){this.graph&&this.graph.sendActionToCanvas("setDirty",[e,t])},LGraphNode.prototype.loadImage=function(e){var t=new Image;t.src=LiteGraph.node_images_path+e,t.ready=!1;var n=this;return t.onload=function(){this.ready=!0,n.setDirtyCanvas(!0)},t},LGraphNode.prototype.captureInput=function(e){if(!(!this.graph||!this.graph.list_of_graphcanvas))for(var t=this.graph.list_of_graphcanvas,n=0;n<t.length;++n){var r=t[n];!e&&r.node_capturing_input!=this||(r.node_capturing_input=e?this:null)}},LGraphNode.prototype.collapse=function(e){this.graph._version++,!(this.constructor.collapsable===!1&&!e)&&(this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0))},LGraphNode.prototype.pin=function(e){this.graph._version++,e===void 0?this.flags.pinned=!this.flags.pinned:this.flags.pinned=e},LGraphNode.prototype.localToScreen=function(e,t,n){return[(e+this.pos[0])*n.scale+n.offset[0],(t+this.pos[1])*n.scale+n.offset[1]]};function LGraphGroup(e){this._ctor(e)}global.LGraphGroup=LiteGraph.LGraphGroup=LGraphGroup,LGraphGroup.prototype._ctor=function(e){this.title=e||"Group",this.font_size=24,this.color=LGraphCanvas.node_colors.pale_blue?LGraphCanvas.node_colors.pale_blue.groupcolor:"#AAA",this._bounding=new Float32Array([10,10,140,80]),this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4),this._nodes=[],this.graph=null,Object.defineProperty(this,"pos",{set:function(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])},get:function(){return this._pos},enumerable:!0}),Object.defineProperty(this,"size",{set:function(t){!t||t.length<2||(this._size[0]=Math.max(140,t[0]),this._size[1]=Math.max(80,t[1]))},get:function(){return this._size},enumerable:!0})},LGraphGroup.prototype.configure=function(e){this.title=e.title,this._bounding.set(e.bounding),this.color=e.color,this.font_size=e.font_size},LGraphGroup.prototype.serialize=function(){var e=this._bounding;return{title:this.title,bounding:[Math.round(e[0]),Math.round(e[1]),Math.round(e[2]),Math.round(e[3])],color:this.color,font_size:this.font_size}},LGraphGroup.prototype.move=function(e,t,n){if(this._pos[0]+=e,this._pos[1]+=t,!n)for(var r=0;r<this._nodes.length;++r){var s=this._nodes[r];s.pos[0]+=e,s.pos[1]+=t}},LGraphGroup.prototype.recomputeInsideNodes=function(){this._nodes.length=0;for(var e=this.graph._nodes,t=new Float32Array(4),n=0;n<e.length;++n){var r=e[n];r.getBounding(t),overlapBounding(this._bounding,t)&&this._nodes.push(r)}},LGraphGroup.prototype.isPointInside=LGraphNode.prototype.isPointInside,LGraphGroup.prototype.setDirtyCanvas=LGraphNode.prototype.setDirtyCanvas;function DragAndScale(e,t){this.offset=new Float32Array([0,0]),this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array(4),e&&(this.element=e,t||this.bindEvents(e))}LiteGraph.DragAndScale=DragAndScale,DragAndScale.prototype.bindEvents=function(e){this.last_mouse=new Float32Array(2),this._binded_mouse_callback=this.onMouse.bind(this),LiteGraph.pointerListenerAdd(e,"down",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(e,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(e,"up",this._binded_mouse_callback),e.addEventListener("mousewheel",this._binded_mouse_callback,!1),e.addEventListener("wheel",this._binded_mouse_callback,!1)},DragAndScale.prototype.computeVisibleArea=function(e){if(!this.element){this.visible_area[0]=this.visible_area[1]=this.visible_area[2]=this.visible_area[3]=0;return}var t=this.element.width,n=this.element.height,r=-this.offset[0],s=-this.offset[1];e&&(r+=e[0]/this.scale,s+=e[1]/this.scale,t=e[2],n=e[3]);var o=r+t/this.scale,h=s+n/this.scale;this.visible_area[0]=r,this.visible_area[1]=s,this.visible_area[2]=o-r,this.visible_area[3]=h-s},DragAndScale.prototype.onMouse=function(e){if(this.enabled){var t=this.element,n=t.getBoundingClientRect(),r=e.clientX-n.left,s=e.clientY-n.top;e.canvasx=r,e.canvasy=s,e.dragging=this.dragging;var o=!this.viewport||this.viewport&&r>=this.viewport[0]&&r<this.viewport[0]+this.viewport[2]&&s>=this.viewport[1]&&s<this.viewport[1]+this.viewport[3],h=!1;if(this.onmouse&&(h=this.onmouse(e)),e.type==LiteGraph.pointerevents_method+"down"&&o)this.dragging=!0,LiteGraph.pointerListenerRemove(t,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(document,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(document,"up",this._binded_mouse_callback);else if(e.type==LiteGraph.pointerevents_method+"move"){if(!h){var u=r-this.last_mouse[0],f=s-this.last_mouse[1];this.dragging&&this.mouseDrag(u,f)}}else e.type==LiteGraph.pointerevents_method+"up"?(this.dragging=!1,LiteGraph.pointerListenerRemove(document,"move",this._binded_mouse_callback),LiteGraph.pointerListenerRemove(document,"up",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(t,"move",this._binded_mouse_callback)):o&&(e.type=="mousewheel"||e.type=="wheel"||e.type=="DOMMouseScroll")&&(e.eventType="mousewheel",e.type=="wheel"?e.wheel=-e.deltaY:e.wheel=e.wheelDeltaY!=null?e.wheelDeltaY:e.detail*-60,e.delta=e.wheelDelta?e.wheelDelta/40:e.deltaY?-e.deltaY/3:0,this.changeDeltaScale(1+e.delta*.05));if(this.last_mouse[0]=r,this.last_mouse[1]=s,o)return e.preventDefault(),e.stopPropagation(),!1}},DragAndScale.prototype.toCanvasContext=function(e){e.scale(this.scale,this.scale),e.translate(this.offset[0],this.offset[1])},DragAndScale.prototype.convertOffsetToCanvas=function(e){return[(e[0]+this.offset[0])*this.scale,(e[1]+this.offset[1])*this.scale]},DragAndScale.prototype.convertCanvasToOffset=function(e,t){return t=t||[0,0],t[0]=e[0]/this.scale-this.offset[0],t[1]=e[1]/this.scale-this.offset[1],t},DragAndScale.prototype.mouseDrag=function(e,t){this.offset[0]+=e/this.scale,this.offset[1]+=t/this.scale,this.onredraw&&this.onredraw(this)},DragAndScale.prototype.changeScale=function(e,t){if(e<this.min_scale?e=this.min_scale:e>this.max_scale&&(e=this.max_scale),e!=this.scale&&this.element){var n=this.element.getBoundingClientRect();if(n){t=t||[n.width*.5,n.height*.5];var r=this.convertCanvasToOffset(t);this.scale=e,Math.abs(this.scale-1)<.01&&(this.scale=1);var s=this.convertCanvasToOffset(t),o=[s[0]-r[0],s[1]-r[1]];this.offset[0]+=o[0],this.offset[1]+=o[1],this.onredraw&&this.onredraw(this)}}},DragAndScale.prototype.changeDeltaScale=function(e,t){this.changeScale(this.scale*e,t)},DragAndScale.prototype.reset=function(){this.scale=1,this.offset[0]=0,this.offset[1]=0};function LGraphCanvas(e,t,n){this.options=n=n||{},this.background_image=LGraphCanvas.DEFAULT_BACKGROUND_IMAGE,e&&e.constructor===String&&(e=document.querySelector(e)),this.ds=new DragAndScale,this.zoom_modify_alpha=!0,this.title_text_font=""+LiteGraph.NODE_TEXT_SIZE+"px Arial",this.inner_text_font="normal "+LiteGraph.NODE_SUBTEXT_SIZE+"px Arial",this.node_title_color=LiteGraph.NODE_TITLE_COLOR,this.default_link_color=LiteGraph.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.default_connection_color_byType={},this.default_connection_color_byTypeOff={},this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.clear_background_color="#222",this.read_only=!1,this.render_only_selected=!0,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.multi_select=!1,this.allow_searchbox=!0,this.allow_reconnect_links=!0,this.align_to_grid=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!1,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_title_colored=!0,this.render_link_tooltip=!0,this.links_render_mode=LiteGraph.SPLINE_LINK,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.onDrawLinkTooltip=null,this.onNodeMoved=null,this.onSelectionChange=null,this.onConnectingChange=null,this.onBeforeChange=null,this.onAfterChange=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.over_link_center=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.visible_links=[],this.viewport=n.viewport||null,t&&t.attachCanvas(this),this.setCanvas(e,n.skip_events),this.clear(),n.skip_render||this.startRendering(),this.autoresize=n.autoresize}global.LGraphCanvas=LiteGraph.LGraphCanvas=LGraphCanvas,LGraphCanvas.DEFAULT_BACKGROUND_IMAGE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII=",LGraphCanvas.link_type_colors={"-1":LiteGraph.EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"},LGraphCanvas.gradients={},LGraphCanvas.prototype.clear=function(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.pointer_is_down=!1,this.pointer_is_double=!1,this.visible_area.set([0,0,0,0]),this.onClear&&this.onClear()},LGraphCanvas.prototype.setGraph=function(e,t){if(this.graph!=e){if(t||this.clear(),!e&&this.graph){this.graph.detachCanvas(this);return}e.attachCanvas(this),this._graph_stack&&(this._graph_stack=null),this.setDirty(!0,!0)}},LGraphCanvas.prototype.getTopGraph=function(){return this._graph_stack.length?this._graph_stack[0]:this.graph},LGraphCanvas.prototype.openSubgraph=function(e){if(!e)throw"graph cannot be null";if(this.graph==e)throw"graph cannot be the same";this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph)),e.attachCanvas(this),this.checkPanels(),this.setDirty(!0,!0)},LGraphCanvas.prototype.closeSubgraph=function(){if(!(!this._graph_stack||this._graph_stack.length==0)){var e=this.graph._subgraph_node,t=this._graph_stack.pop();this.selected_nodes={},this.highlighted_links={},t.attachCanvas(this),this.setDirty(!0,!0),e&&(this.centerOnNode(e),this.selectNodes([e])),this.ds.offset=[0,0],this.ds.scale=1}},LGraphCanvas.prototype.getCurrentGraph=function(){return this.graph},LGraphCanvas.prototype.setCanvas=function(e,t){if(e&&e.constructor===String&&(e=document.getElementById(e),!e))throw"Error creating LiteGraph canvas: Canvas not found";if(e!==this.canvas&&(!e&&this.canvas&&(t||this.unbindEvents()),this.canvas=e,this.ds.element=e,!!e)){if(e.className+=" lgraphcanvas",e.data=this,e.tabindex="1",this.bgcanvas=null,this.bgcanvas||(this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height),e.getContext==null)throw e.localName!="canvas"?"Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+e.localName:"This browser doesn't support Canvas";var n=this.ctx=e.getContext("2d");n==null&&(e.webgl_enabled||console.warn("This canvas seems to be WebGL, enabling WebGL renderer"),this.enableWebGL()),t||this.bindEvents()}},LGraphCanvas.prototype._doNothing=function(t){return t.preventDefault(),!1},LGraphCanvas.prototype._doReturnTrue=function(t){return t.preventDefault(),!0},LGraphCanvas.prototype.bindEvents=function(){if(this._events_binded){console.warn("LGraphCanvas: events already binded");return}var e=this.canvas,t=this.getCanvasWindow(),n=t.document;this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),LiteGraph.pointerListenerAdd(e,"down",this._mousedown_callback,!0),e.addEventListener("mousewheel",this._mousewheel_callback,!1),LiteGraph.pointerListenerAdd(e,"up",this._mouseup_callback,!0),LiteGraph.pointerListenerAdd(e,"move",this._mousemove_callback),e.addEventListener("contextmenu",this._doNothing),e.addEventListener("DOMMouseScroll",this._mousewheel_callback,!1),this._key_callback=this.processKey.bind(this),e.setAttribute("tabindex",1),e.addEventListener("keydown",this._key_callback,!0),n.addEventListener("keyup",this._key_callback,!0),this._ondrop_callback=this.processDrop.bind(this),e.addEventListener("dragover",this._doNothing,!1),e.addEventListener("dragend",this._doNothing,!1),e.addEventListener("drop",this._ondrop_callback,!1),e.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0},LGraphCanvas.prototype.unbindEvents=function(){if(!this._events_binded){console.warn("LGraphCanvas: no events binded");return}var e=this.getCanvasWindow(),t=e.document;LiteGraph.pointerListenerRemove(this.canvas,"move",this._mousedown_callback),LiteGraph.pointerListenerRemove(this.canvas,"up",this._mousedown_callback),LiteGraph.pointerListenerRemove(this.canvas,"down",this._mousedown_callback),this.canvas.removeEventListener("mousewheel",this._mousewheel_callback),this.canvas.removeEventListener("DOMMouseScroll",this._mousewheel_callback),this.canvas.removeEventListener("keydown",this._key_callback),t.removeEventListener("keyup",this._key_callback),this.canvas.removeEventListener("contextmenu",this._doNothing),this.canvas.removeEventListener("drop",this._ondrop_callback),this.canvas.removeEventListener("dragenter",this._doReturnTrue),this._mousedown_callback=null,this._mousewheel_callback=null,this._key_callback=null,this._ondrop_callback=null,this._events_binded=!1},LGraphCanvas.getFileExtension=function(e){var t=e.indexOf("?");t!=-1&&(e=e.substr(0,t));var n=e.lastIndexOf(".");return n==-1?"":e.substr(n+1).toLowerCase()},LGraphCanvas.prototype.enableWebGL=function(){if(typeof GL>"u")throw"litegl.js must be included to use a WebGL canvas";if(typeof enableWebGLCanvas>"u")throw"webglCanvas.js must be included to use this feature";this.gl=this.ctx=enableWebGLCanvas(this.canvas),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.bgctx=this.gl,this.canvas.webgl_enabled=!0},LGraphCanvas.prototype.setDirty=function(e,t){e&&(this.dirty_canvas=!0),t&&(this.dirty_bgcanvas=!0)},LGraphCanvas.prototype.getCanvasWindow=function(){if(!this.canvas)return window;var e=this.canvas.ownerDocument;return e.defaultView||e.parentWindow},LGraphCanvas.prototype.startRendering=function(){if(this.is_rendering)return;this.is_rendering=!0,e.call(this);function e(){this.pause_rendering||this.draw();var t=this.getCanvasWindow();this.is_rendering&&t.requestAnimationFrame(e.bind(this))}},LGraphCanvas.prototype.stopRendering=function(){this.is_rendering=!1},LGraphCanvas.prototype.blockClick=function(){this.block_click=!0,this.last_mouseclick=0},LGraphCanvas.prototype.processMouseDown=function(e){if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!!this.graph){this.adjustMouseEvent(e);var t=this.getCanvasWindow();t.document,LGraphCanvas.active_canvas=this;var n=this,r=e.clientX,s=e.clientY;this.ds.viewport=this.viewport;var o=!this.viewport||this.viewport&&r>=this.viewport[0]&&r<this.viewport[0]+this.viewport[2]&&s>=this.viewport[1]&&s<this.viewport[1]+this.viewport[3];if(this.options.skip_events||(LiteGraph.pointerListenerRemove(this.canvas,"move",this._mousemove_callback),LiteGraph.pointerListenerAdd(t.document,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerAdd(t.document,"up",this._mouseup_callback,!0)),!!o){var h=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes,5),u=!1,f=LiteGraph.getTime(),c=e.isPrimary===void 0||!e.isPrimary,_=f-this.last_mouseclick<300&&c;if(this.mouse[0]=e.clientX,this.mouse[1]=e.clientY,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.pointer_is_down&&c?this.pointer_is_double=!0:this.pointer_is_double=!1,this.pointer_is_down=!0,this.canvas.focus(),LiteGraph.closeAllContextMenus(t),!(this.onMouse&&this.onMouse(e)==!0)){if(e.which==1&&!this.pointer_is_double){e.ctrlKey&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=e.canvasX,this.dragging_rectangle[1]=e.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,u=!0),LiteGraph.alt_drag_do_clone_nodes&&e.altKey&&h&&this.allow_interaction&&!u&&!this.read_only&&(cloned=h.clone())&&(cloned.pos[0]+=5,cloned.pos[1]+=5,this.graph.add(cloned,!1,{doCalcSize:!1}),h=cloned,u=!0,A||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=h),this.selected_nodes[h.id]||this.processNodeSelected(h,e)));var O=!1;if(h&&(this.allow_interaction||h.flags.allow_interaction)&&!u&&!this.read_only){if(!this.live_mode&&!h.flags.pinned&&this.bringToFront(h),this.allow_interaction&&!this.connecting_node&&!h.flags.collapsed&&!this.live_mode)if(!u&&h.resizable!==!1&&isInsideRectangle(e.canvasX,e.canvasY,h.pos[0]+h.size[0]-5,h.pos[1]+h.size[1]-5,10,10))this.graph.beforeChange(),this.resizing_node=h,this.canvas.style.cursor="se-resize",u=!0;else{if(h.outputs)for(var d=0,b=h.outputs.length;d<b;++d){var S=h.outputs[d],G=h.getConnectionPos(!1,d);if(isInsideRectangle(e.canvasX,e.canvasY,G[0]-15,G[1]-10,30,20)){this.connecting_node=h,this.connecting_output=S,this.connecting_output.slot_index=d,this.connecting_pos=h.getConnectionPos(!1,d),this.connecting_slot=d,LiteGraph.shift_click_do_break_link_from&&e.shiftKey&&h.disconnectOutput(d),_?h.onOutputDblClick&&h.onOutputDblClick(d,e):h.onOutputClick&&h.onOutputClick(d,e),u=!0;break}}if(h.inputs)for(var d=0,b=h.inputs.length;d<b;++d){var z=h.inputs[d],G=h.getConnectionPos(!0,d);if(isInsideRectangle(e.canvasX,e.canvasY,G[0]-15,G[1]-10,30,20)){if(_?h.onInputDblClick&&h.onInputDblClick(d,e):h.onInputClick&&h.onInputClick(d,e),z.link!==null){var $=this.graph.links[z.link];LiteGraph.click_do_break_link_to&&(h.disconnectInput(d),this.dirty_bgcanvas=!0,u=!0),(this.allow_reconnect_links||e.shiftKey)&&(LiteGraph.click_do_break_link_to||h.disconnectInput(d),this.connecting_node=this.graph._nodes_by_id[$.origin_id],this.connecting_slot=$.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot),this.dirty_bgcanvas=!0,u=!0)}u||(this.connecting_node=h,this.connecting_input=z,this.connecting_input.slot_index=d,this.connecting_pos=h.getConnectionPos(!0,d),this.connecting_slot=d,this.dirty_bgcanvas=!0,u=!0)}}}if(!u){var A=!1,l=[e.canvasX-h.pos[0],e.canvasY-h.pos[1]],I=this.processNodeWidgets(h,this.graph_mouse,e);if(I&&(A=!0,this.node_widget=[h,I]),this.allow_interaction&&_&&this.selected_nodes[h.id]&&(h.onDblClick&&h.onDblClick(e,l,this),this.processNodeDblClicked(h),A=!0),h.onMouseDown&&h.onMouseDown(e,l,this))A=!0;else{if(h.subgraph&&!h.skip_subgraph_button&&!h.flags.collapsed&&l[0]>h.size[0]-LiteGraph.NODE_TITLE_HEIGHT&&l[1]<0){var n=this;setTimeout(function(){n.openSubgraph(h.subgraph)},10)}this.live_mode&&(O=!0,A=!0)}A?h.is_selected||this.processNodeSelected(h,e):(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=h),this.processNodeSelected(h,e)),this.dirty_canvas=!0}}else if(!u){if(!this.read_only)for(var d=0;d<this.visible_links.length;++d){var T=this.visible_links[d],L=T._pos;if(!(!L||e.canvasX<L[0]-4||e.canvasX>L[0]+4||e.canvasY<L[1]-4||e.canvasY>L[1]+4)){this.showLinkMenu(T,e),this.over_link_center=null;break}}if(this.selected_group=this.graph.getGroupOnPos(e.canvasX,e.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only){e.ctrlKey&&(this.dragging_rectangle=null);var C=distance([e.canvasX,e.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]]);C*this.ds.scale<10?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes()}_&&!this.read_only&&this.allow_searchbox&&(this.showSearchBox(e),e.preventDefault(),e.stopPropagation()),O=!0}!u&&O&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}else if(e.which==2)if(LiteGraph.middle_click_slot_add_default_node){if(h&&this.allow_interaction&&!u&&!this.read_only&&!this.connecting_node&&!h.flags.collapsed&&!this.live_mode){var N=!1,R=!1,Y=!1;if(h.outputs)for(var d=0,b=h.outputs.length;d<b;++d){var S=h.outputs[d],G=h.getConnectionPos(!1,d);if(isInsideRectangle(e.canvasX,e.canvasY,G[0]-15,G[1]-10,30,20)){N=S,R=d,Y=!0;break}}if(h.inputs)for(var d=0,b=h.inputs.length;d<b;++d){var z=h.inputs[d],G=h.getConnectionPos(!0,d);if(isInsideRectangle(e.canvasX,e.canvasY,G[0]-15,G[1]-10,30,20)){N=z,R=d,Y=!1;break}}if(N&&R!==!1){var ut=.5-(R+1)/(Y?h.outputs.length:h.inputs.length),mt=h.getBounding(),yt=[Y?mt[0]+mt[2]:mt[0],e.canvasY-80];this.createDefaultNodeForSlot({nodeFrom:Y?h:null,slotFrom:Y?R:null,nodeTo:Y?null:h,slotTo:Y?null:R,position:yt,nodeType:"AUTO",posAdd:[Y?30:-30,-ut*130],posSizeFix:[Y?0:-1,0]})}}}else!u&&this.allow_dragcanvas&&(this.dragging_canvas=!0);else(e.which==3||this.pointer_is_double)&&this.allow_interaction&&!u&&!this.read_only&&(h&&(Object.keys(this.selected_nodes).length&&(this.selected_nodes[h.id]||e.shiftKey||e.ctrlKey||e.metaKey)?this.selected_nodes[h.id]||this.selectNodes([h],!0):this.selectNodes([h])),this.processContextMenu(h,e));return this.last_mouse[0]=e.clientX,this.last_mouse[1]=e.clientY,this.last_mouseclick=LiteGraph.getTime(),this.last_mouse_dragging=!0,this.graph.change(),(!t.document.activeElement||t.document.activeElement.nodeName.toLowerCase()!="input"&&t.document.activeElement.nodeName.toLowerCase()!="textarea")&&e.preventDefault(),e.stopPropagation(),this.onMouseDown&&this.onMouseDown(e),!1}}}},LGraphCanvas.prototype.processMouseMove=function(e){if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!!this.graph){LGraphCanvas.active_canvas=this,this.adjustMouseEvent(e);var t=[e.clientX,e.clientY];this.mouse[0]=t[0],this.mouse[1]=t[1];var n=[t[0]-this.last_mouse[0],t[1]-this.last_mouse[1]];if(this.last_mouse=t,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,this.block_click)return e.preventDefault(),!1;e.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e,this.node_widget[1]),this.dirty_canvas=!0);var r=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);if(this.dragging_rectangle)this.dragging_rectangle[2]=e.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=e.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only){if(this.selected_group_resizing)this.selected_group.size=[e.canvasX-this.selected_group.pos[0],e.canvasY-this.selected_group.pos[1]];else{var s=n[0]/this.ds.scale,o=n[1]/this.ds.scale;this.selected_group.move(s,o,e.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0)}this.dirty_bgcanvas=!0}else if(this.dragging_canvas)this.ds.offset[0]+=n[0]/this.ds.scale,this.ds.offset[1]+=n[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if((this.allow_interaction||r&&r.flags.allow_interaction)&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);for(var h=0,u=this.graph._nodes.length;h<u;++h)this.graph._nodes[h].mouseOver&&r!=this.graph._nodes[h]&&(this.graph._nodes[h].mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(e),this.node_over=null,this.dirty_canvas=!0);if(r){if(r.redraw_on_mouse&&(this.dirty_canvas=!0),r.mouseOver||(r.mouseOver=!0,this.node_over=r,this.dirty_canvas=!0,r.onMouseEnter&&r.onMouseEnter(e)),r.onMouseMove&&r.onMouseMove(e,[e.canvasX-r.pos[0],e.canvasY-r.pos[1]],this),this.connecting_node){if(this.connecting_output){var f=this._highlight_input||[0,0];if(!this.isOverNodeBox(r,e.canvasX,e.canvasY)){var c=this.isOverNodeInput(r,e.canvasX,e.canvasY,f);if(c!=-1&&r.inputs[c]){var _=r.inputs[c].type;LiteGraph.isValidConnection(this.connecting_output.type,_)&&(this._highlight_input=f,this._highlight_input_slot=r.inputs[c])}else this._highlight_input=null,this._highlight_input_slot=null}}else if(this.connecting_input){var f=this._highlight_output||[0,0];if(!this.isOverNodeBox(r,e.canvasX,e.canvasY)){var c=this.isOverNodeOutput(r,e.canvasX,e.canvasY,f);if(c!=-1&&r.outputs[c]){var _=r.outputs[c].type;LiteGraph.isValidConnection(this.connecting_input.type,_)&&(this._highlight_output=f)}else this._highlight_output=null}}}this.canvas&&(isInsideRectangle(e.canvasX,e.canvasY,r.pos[0]+r.size[0]-5,r.pos[1]+r.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair")}else{for(var O=null,h=0;h<this.visible_links.length;++h){var d=this.visible_links[h],b=d._pos;if(!(!b||e.canvasX<b[0]-4||e.canvasX>b[0]+4||e.canvasY<b[1]-4||e.canvasY>b[1]+4)){O=d;break}}O!=this.over_link_center&&(this.over_link_center=O,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!=r&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){for(var h in this.selected_nodes){var S=this.selected_nodes[h];S.pos[0]+=n[0]/this.ds.scale,S.pos[1]+=n[1]/this.ds.scale,S.is_selected||this.processNodeSelected(S,e)}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}if(this.resizing_node&&!this.live_mode){var G=[e.canvasX-this.resizing_node.pos[0],e.canvasY-this.resizing_node.pos[1]],z=this.resizing_node.computeSize();G[0]=Math.max(z[0],G[0]),G[1]=Math.max(z[1],G[1]),this.resizing_node.setSize(G),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0}}return e.preventDefault(),!1}},LGraphCanvas.prototype.processMouseUp=function(e){var t=e.isPrimary===void 0||e.isPrimary;if(!t)return!1;if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!!this.graph){var n=this.getCanvasWindow(),r=n.document;LGraphCanvas.active_canvas=this,this.options.skip_events||(LiteGraph.pointerListenerRemove(r,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerAdd(this.canvas,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerRemove(r,"up",this._mouseup_callback,!0)),this.adjustMouseEvent(e);var s=LiteGraph.getTime();if(e.click_time=s-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(this.block_click=!1),e.which==1){if(this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e),this.node_widget=null,this.selected_group){var o=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),h=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]);this.selected_group.move(o,h,e.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group=null}this.selected_group_resizing=!1;var u=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);if(this.dragging_rectangle){if(this.graph){var f=this.graph._nodes,c=new Float32Array(4),_=Math.abs(this.dragging_rectangle[2]),O=Math.abs(this.dragging_rectangle[3]),d=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-_:this.dragging_rectangle[0],b=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-O:this.dragging_rectangle[1];if(this.dragging_rectangle[0]=d,this.dragging_rectangle[1]=b,this.dragging_rectangle[2]=_,this.dragging_rectangle[3]=O,!u||_>10&&O>10){for(var S=[],G=0;G<f.length;++G){var z=f[G];z.getBounding(c),overlapBounding(this.dragging_rectangle,c)&&S.push(z)}S.length&&this.selectNodes(S,e.shiftKey)}else this.selectNodes([u],e.shiftKey||e.ctrlKey)}this.dragging_rectangle=null}else if(this.connecting_node){this.dirty_canvas=!0,this.dirty_bgcanvas=!0;var $=this.connecting_output||this.connecting_input,A=$.type;if(u){if(this.connecting_output){var l=this.isOverNodeInput(u,e.canvasX,e.canvasY);l!=-1?this.connecting_node.connect(this.connecting_slot,u,l):this.connecting_node.connectByType(this.connecting_slot,u,A)}else if(this.connecting_input){var l=this.isOverNodeOutput(u,e.canvasX,e.canvasY);l!=-1?u.connect(l,this.connecting_node,this.connecting_slot):this.connecting_node.connectByTypeOutput(this.connecting_slot,u,A)}}else LiteGraph.release_link_on_empty_shows_menu&&(e.shiftKey&&this.allow_searchbox?this.connecting_output?this.showSearchBox(e,{node_from:this.connecting_node,slot_from:this.connecting_output,type_filter_in:this.connecting_output.type}):this.connecting_input&&this.showSearchBox(e,{node_to:this.connecting_node,slot_from:this.connecting_input,type_filter_out:this.connecting_input.type}):this.connecting_output?this.showConnectionMenu({nodeFrom:this.connecting_node,slotFrom:this.connecting_output,e}):this.connecting_input&&this.showConnectionMenu({nodeTo:this.connecting_node,slotTo:this.connecting_input,e}));this.connecting_output=null,this.connecting_input=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1}else if(this.resizing_node)this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null;else if(this.node_dragged){var u=this.node_dragged;u&&e.click_time<300&&isInsideRectangle(e.canvasX,e.canvasY,u.pos[0],u.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT)&&u.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),(this.graph.config.align_to_grid||this.align_to_grid)&&this.node_dragged.alignToGrid(),this.onNodeMoved&&this.onNodeMoved(this.node_dragged),this.graph.afterChange(this.node_dragged),this.node_dragged=null}else{var u=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);!u&&e.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(e,[e.canvasX-this.node_over.pos[0],e.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]])}}else e.which==2?(this.dirty_canvas=!0,this.dragging_canvas=!1):e.which==3&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return t&&(this.pointer_is_down=!1,this.pointer_is_double=!1),this.graph.change(),e.stopPropagation(),e.preventDefault(),!1}},LGraphCanvas.prototype.processMouseWheel=function(e){if(!(!this.graph||!this.allow_dragcanvas)){var t=e.wheelDeltaY!=null?e.wheelDeltaY:e.detail*-60;this.adjustMouseEvent(e);var n=e.clientX,r=e.clientY,s=!this.viewport||this.viewport&&n>=this.viewport[0]&&n<this.viewport[0]+this.viewport[2]&&r>=this.viewport[1]&&r<this.viewport[1]+this.viewport[3];if(s){var o=this.ds.scale;return t>0?o*=1.1:t<0&&(o*=1/1.1),this.ds.changeScale(o,[e.clientX,e.clientY]),this.graph.change(),e.preventDefault(),!1}}},LGraphCanvas.prototype.isOverNodeBox=function(e,t,n){var r=LiteGraph.NODE_TITLE_HEIGHT;return!!isInsideRectangle(t,n,e.pos[0]+2,e.pos[1]+2-r,r-4,r-4)},LGraphCanvas.prototype.isOverNodeInput=function(e,t,n,r){if(e.inputs)for(var s=0,o=e.inputs.length;s<o;++s){e.inputs[s];var h=e.getConnectionPos(!0,s),u=!1;if(e.horizontal?u=isInsideRectangle(t,n,h[0]-5,h[1]-10,10,20):u=isInsideRectangle(t,n,h[0]-10,h[1]-5,40,10),u)return r&&(r[0]=h[0],r[1]=h[1]),s}return-1},LGraphCanvas.prototype.isOverNodeOutput=function(e,t,n,r){if(e.outputs)for(var s=0,o=e.outputs.length;s<o;++s){e.outputs[s];var h=e.getConnectionPos(!1,s),u=!1;if(e.horizontal?u=isInsideRectangle(t,n,h[0]-5,h[1]-10,10,20):u=isInsideRectangle(t,n,h[0]-10,h[1]-5,40,10),u)return r&&(r[0]=h[0],r[1]=h[1]),s}return-1},LGraphCanvas.prototype.processKey=function(e){if(this.graph){var t=!1;if(e.target.localName!="input"){if(e.type=="keydown"){if(e.keyCode==32&&(this.dragging_canvas=!0,t=!0),e.keyCode==27&&(this.node_panel&&this.node_panel.close(),this.options_panel&&this.options_panel.close(),t=!0),e.keyCode==65&&e.ctrlKey&&(this.selectNodes(),t=!0),e.keyCode===67&&(e.metaKey||e.ctrlKey)&&!e.shiftKey&&this.selected_nodes&&(this.copyToClipboard(),t=!0),e.keyCode===86&&(e.metaKey||e.ctrlKey)&&this.pasteFromClipboard(e.shiftKey),(e.keyCode==46||e.keyCode==8)&&e.target.localName!="input"&&e.target.localName!="textarea"&&(this.deleteSelectedNodes(),t=!0),this.selected_nodes)for(var n in this.selected_nodes)this.selected_nodes[n].onKeyDown&&this.selected_nodes[n].onKeyDown(e)}else if(e.type=="keyup"&&(e.keyCode==32&&(this.dragging_canvas=!1),this.selected_nodes))for(var n in this.selected_nodes)this.selected_nodes[n].onKeyUp&&this.selected_nodes[n].onKeyUp(e);if(this.graph.change(),t)return e.preventDefault(),e.stopImmediatePropagation(),!1}}},LGraphCanvas.prototype.copyToClipboard=function(){var e={nodes:[],links:[]},t=0,n=[];for(var r in this.selected_nodes){var s=this.selected_nodes[r];s.clonable!==!1&&(s._relative_id=t,n.push(s),t+=1)}for(var r=0;r<n.length;++r){var s=n[r];if(s.clonable!==!1){var o=s.clone();if(!o){console.warn("node type not found: "+s.type);continue}if(e.nodes.push(o.serialize()),s.inputs&&s.inputs.length)for(var h=0;h<s.inputs.length;++h){var u=s.inputs[h];if(!(!u||u.link==null)){var f=this.graph.links[u.link];if(f){var c=this.graph.getNodeById(f.origin_id);c&&e.links.push([c._relative_id,f.origin_slot,s._relative_id,f.target_slot,c.id])}}}}}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(e))},LGraphCanvas.prototype.pasteFromClipboard=function(e=!1){if(!(!LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&e)){var t=localStorage.getItem("litegrapheditor_clipboard");if(t){this.graph.beforeChange();for(var n=JSON.parse(t),r=!1,s=!1,o=0;o<n.nodes.length;++o)r?(r[0]>n.nodes[o].pos[0]&&(r[0]=n.nodes[o].pos[0],s[0]=o),r[1]>n.nodes[o].pos[1]&&(r[1]=n.nodes[o].pos[1],s[1]=o)):(r=[n.nodes[o].pos[0],n.nodes[o].pos[1]],s=[o,o]);for(var h=[],o=0;o<n.nodes.length;++o){var u=n.nodes[o],f=LiteGraph.createNode(u.type);f&&(f.configure(u),f.pos[0]+=this.graph_mouse[0]-r[0],f.pos[1]+=this.graph_mouse[1]-r[1],this.graph.add(f,{doProcessChange:!1}),h.push(f))}for(var o=0;o<n.links.length;++o){var c=n.links[o],_,O=c[0];if(O!=null)_=h[O];else if(LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&e){var d=c[4];d&&(_=this.graph.getNodeById(d))}var b=h[c[2]];_&&b?_.connect(c[1],b,c[3]):console.warn("Warning, nodes missing on pasting")}this.selectNodes(h),this.graph.afterChange()}}},LGraphCanvas.prototype.processDrop=function(e){e.preventDefault(),this.adjustMouseEvent(e);var t=e.clientX,n=e.clientY,r=!this.viewport||this.viewport&&t>=this.viewport[0]&&t<this.viewport[0]+this.viewport[2]&&n>=this.viewport[1]&&n<this.viewport[1]+this.viewport[3];if(r){var s=[e.canvasX,e.canvasY],o=this.graph?this.graph.getNodeOnPos(s[0],s[1]):null;if(!o){var h=null;this.onDropItem&&(h=this.onDropItem(event)),h||this.checkDropItem(e);return}if(o.onDropFile||o.onDropData){var u=e.dataTransfer.files;if(u&&u.length)for(var f=0;f<u.length;f++){var c=e.dataTransfer.files[0],_=c.name;if(LGraphCanvas.getFileExtension(_),o.onDropFile&&o.onDropFile(c),o.onDropData){var O=new FileReader;O.onload=function(b){var S=b.target.result;o.onDropData(S,_,c)};var d=c.type.split("/")[0];d=="text"||d==""?O.readAsText(c):d=="image"?O.readAsDataURL(c):O.readAsArrayBuffer(c)}}}return o.onDropItem&&o.onDropItem(event)?!0:this.onDropItem?this.onDropItem(event):!1}},LGraphCanvas.prototype.checkDropItem=function(e){if(e.dataTransfer.files.length){var t=e.dataTransfer.files[0],n=LGraphCanvas.getFileExtension(t.name).toLowerCase(),r=LiteGraph.node_types_by_file_extension[n];if(r){this.graph.beforeChange();var s=LiteGraph.createNode(r.type);s.pos=[e.canvasX,e.canvasY],this.graph.add(s),s.onDropFile&&s.onDropFile(t),this.graph.afterChange()}}},LGraphCanvas.prototype.processNodeDblClicked=function(e){this.onShowNodePanel?this.onShowNodePanel(e):this.showShowNodePanel(e),this.onNodeDblClicked&&this.onNodeDblClicked(e),this.setDirty(!0)},LGraphCanvas.prototype.processNodeSelected=function(e,t){this.selectNode(e,t&&(t.shiftKey||t.ctrlKey||this.multi_select)),this.onNodeSelected&&this.onNodeSelected(e)},LGraphCanvas.prototype.selectNode=function(e,t){e==null?this.deselectAllNodes():this.selectNodes([e],t)},LGraphCanvas.prototype.selectNodes=function(e,t){t||this.deselectAllNodes(),e=e||this.graph._nodes,typeof e=="string"&&(e=[e]);for(var n in e){var r=e[n];if(r.is_selected){this.deselectNode(r);continue}if(!r.is_selected&&r.onSelected&&r.onSelected(),r.is_selected=!0,this.selected_nodes[r.id]=r,r.inputs)for(var s=0;s<r.inputs.length;++s)this.highlighted_links[r.inputs[s].link]=!0;if(r.outputs)for(var s=0;s<r.outputs.length;++s){var o=r.outputs[s];if(o.links)for(var h=0;h<o.links.length;++h)this.highlighted_links[o.links[h]]=!0}}this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)},LGraphCanvas.prototype.deselectNode=function(e){if(e.is_selected){if(e.onDeselected&&e.onDeselected(),e.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(e),e.inputs)for(var t=0;t<e.inputs.length;++t)delete this.highlighted_links[e.inputs[t].link];if(e.outputs)for(var t=0;t<e.outputs.length;++t){var n=e.outputs[t];if(n.links)for(var r=0;r<n.links.length;++r)delete this.highlighted_links[n.links[r]]}}},LGraphCanvas.prototype.deselectAllNodes=function(){if(this.graph){for(var e=this.graph._nodes,t=0,n=e.length;t<n;++t){var r=e[t];r.is_selected&&(r.onDeselected&&r.onDeselected(),r.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(r))}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}},LGraphCanvas.prototype.deleteSelectedNodes=function(){this.graph.beforeChange();for(var e in this.selected_nodes){var t=this.selected_nodes[e];if(!t.block_delete){if(t.inputs&&t.inputs.length&&t.outputs&&t.outputs.length&&LiteGraph.isValidConnection(t.inputs[0].type,t.outputs[0].type)&&t.inputs[0].link&&t.outputs[0].links&&t.outputs[0].links.length){var n=t.graph.links[t.inputs[0].link],r=t.graph.links[t.outputs[0].links[0]],s=t.getInputNode(0),o=t.getOutputNodes(0)[0];s&&o&&s.connect(n.origin_slot,o,r.target_slot)}this.graph.remove(t),this.onNodeDeselected&&this.onNodeDeselected(t)}}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()},LGraphCanvas.prototype.centerOnNode=function(e){this.ds.offset[0]=-e.pos[0]-e.size[0]*.5+this.canvas.width*.5/this.ds.scale,this.ds.offset[1]=-e.pos[1]-e.size[1]*.5+this.canvas.height*.5/this.ds.scale,this.setDirty(!0,!0)},LGraphCanvas.prototype.adjustMouseEvent=function(e){var t=0,n=0;if(this.canvas){var r=this.canvas.getBoundingClientRect();t=e.clientX-r.left,n=e.clientY-r.top}else t=e.clientX,n=e.clientY;this.last_mouse_position[0]=t,this.last_mouse_position[1]=n,e.canvasX=t/this.ds.scale-this.ds.offset[0],e.canvasY=n/this.ds.scale-this.ds.offset[1]},LGraphCanvas.prototype.setZoom=function(e,t){this.ds.changeScale(e,t),this.dirty_canvas=!0,this.dirty_bgcanvas=!0},LGraphCanvas.prototype.convertOffsetToCanvas=function(e,t){return this.ds.convertOffsetToCanvas(e,t)},LGraphCanvas.prototype.convertCanvasToOffset=function(e,t){return this.ds.convertCanvasToOffset(e,t)},LGraphCanvas.prototype.convertEventToCanvasOffset=function(e){var t=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([e.clientX-t.left,e.clientY-t.top])},LGraphCanvas.prototype.bringToFront=function(e){var t=this.graph._nodes.indexOf(e);t!=-1&&(this.graph._nodes.splice(t,1),this.graph._nodes.push(e))},LGraphCanvas.prototype.sendToBack=function(e){var t=this.graph._nodes.indexOf(e);t!=-1&&(this.graph._nodes.splice(t,1),this.graph._nodes.unshift(e))};var temp=new Float32Array(4);LGraphCanvas.prototype.computeVisibleNodes=function(e,t){var n=t||[];n.length=0,e=e||this.graph._nodes;for(var r=0,s=e.length;r<s;++r){var o=e[r];this.live_mode&&!o.onDrawBackground&&!o.onDrawForeground||overlapBounding(this.visible_area,o.getBounding(temp,!0))&&n.push(o)}return n},LGraphCanvas.prototype.draw=function(e,t){if(!(!this.canvas||this.canvas.width==0||this.canvas.height==0)){var n=LiteGraph.getTime();this.render_time=(n-this.last_draw_time)*.001,this.last_draw_time=n,this.graph&&this.ds.computeVisibleArea(this.viewport),(this.dirty_bgcanvas||t||this.always_render_background||this.graph&&this.graph._last_trigger_time&&n-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||e)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1}},LGraphCanvas.prototype.drawFrontCanvas=function(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));var e=this.ctx;if(e){var t=this.canvas;e.start2D&&!this.viewport&&(e.start2D(),e.restore(),e.setTransform(1,0,0,1,0,0));var n=this.viewport||this.dirty_area;if(n&&(e.save(),e.beginPath(),e.rect(n[0],n[1],n[2],n[3]),e.clip()),this.clear_background&&(n?e.clearRect(n[0],n[1],n[2],n[3]):e.clearRect(0,0,t.width,t.height)),this.bgcanvas==this.canvas?this.drawBackCanvas():e.drawImage(this.bgcanvas,0,0),this.onRender&&this.onRender(t,e),this.show_info&&this.renderInfo(e,n?n[0]:0,n?n[1]:0),this.graph){e.save(),this.ds.toCanvasContext(e);for(var r=this.computeVisibleNodes(null,this.visible_nodes),s=0;s<r.length;++s){var o=r[s];e.save(),e.translate(o.pos[0],o.pos[1]),this.drawNode(o,e),e.restore()}if(this.render_execution_order&&this.drawExecutionOrder(e),this.graph.config.links_ontop&&(this.live_mode||this.drawConnections(e)),this.connecting_pos!=null){e.lineWidth=this.connections_width;var h=null,u=this.connecting_output||this.connecting_input,f=u.type,c=u.dir;c==null&&(this.connecting_output?c=this.connecting_node.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT:c=this.connecting_node.horizontal?LiteGraph.UP:LiteGraph.LEFT);var _=u.shape;switch(f){case LiteGraph.EVENT:h=LiteGraph.EVENT_LINK_COLOR;break;default:h=LiteGraph.CONNECTING_LINK_COLOR}if(this.renderLink(e,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,h,c,LiteGraph.CENTER),e.beginPath(),f===LiteGraph.EVENT||_===LiteGraph.BOX_SHAPE?(e.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10),e.fill(),e.beginPath(),e.rect(this.graph_mouse[0]-6+.5,this.graph_mouse[1]-5+.5,14,10)):_===LiteGraph.ARROW_SHAPE?(e.moveTo(this.connecting_pos[0]+8,this.connecting_pos[1]+.5),e.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]+6+.5),e.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]-6+.5),e.closePath()):(e.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(this.graph_mouse[0],this.graph_mouse[1],4,0,Math.PI*2)),e.fill(),e.fillStyle="#ffcc00",this._highlight_input){e.beginPath();var O=this._highlight_input_slot.shape;O===LiteGraph.ARROW_SHAPE?(e.moveTo(this._highlight_input[0]+8,this._highlight_input[1]+.5),e.lineTo(this._highlight_input[0]-4,this._highlight_input[1]+6+.5),e.lineTo(this._highlight_input[0]-4,this._highlight_input[1]-6+.5),e.closePath()):e.arc(this._highlight_input[0],this._highlight_input[1],6,0,Math.PI*2),e.fill()}this._highlight_output&&(e.beginPath(),O===LiteGraph.ARROW_SHAPE?(e.moveTo(this._highlight_output[0]+8,this._highlight_output[1]+.5),e.lineTo(this._highlight_output[0]-4,this._highlight_output[1]+6+.5),e.lineTo(this._highlight_output[0]-4,this._highlight_output[1]-6+.5),e.closePath()):e.arc(this._highlight_output[0],this._highlight_output[1],6,0,Math.PI*2),e.fill())}this.dragging_rectangle&&(e.strokeStyle="#FFF",e.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(e,this.over_link_center):this.onDrawLinkTooltip&&this.onDrawLinkTooltip(e,null),this.onDrawForeground&&this.onDrawForeground(e,this.visible_rect),e.restore()}this._graph_stack&&this._graph_stack.length&&this.drawSubgraphPanel(e),this.onDrawOverlay&&this.onDrawOverlay(e),n&&e.restore(),e.finish2D&&e.finish2D()}},LGraphCanvas.prototype.drawSubgraphPanel=function(e){var t=this.graph,n=t._subgraph_node;if(!n){console.warn("subgraph without subnode");return}this.drawSubgraphPanelLeft(t,n,e),this.drawSubgraphPanelRight(t,n,e)},LGraphCanvas.prototype.drawSubgraphPanelLeft=function(e,t,n){var r=t.inputs?t.inputs.length:0,s=200,o=Math.floor(LiteGraph.NODE_SLOT_HEIGHT*1.6);if(n.fillStyle="#111",n.globalAlpha=.8,n.beginPath(),n.roundRect(10,10,s,(r+1)*o+50,[8]),n.fill(),n.globalAlpha=1,n.fillStyle="#888",n.font="14px Arial",n.textAlign="left",n.fillText("Graph Inputs",20,34),this.drawButton(s-20,20,20,20,"X","#151515")){this.closeSubgraph();return}var h=50;if(n.font="14px Arial",t.inputs)for(var u=0;u<t.inputs.length;++u){var f=t.inputs[u];if(!f.not_subgraph_input){if(this.drawButton(20,h+2,s-20,o-2)){var c=t.constructor.input_node_type||"graph/input";this.graph.beforeChange();var _=LiteGraph.createNode(c);_?(e.add(_),this.block_click=!1,this.last_click_position=null,this.selectNodes([_]),this.node_dragged=_,this.dragging_canvas=!1,_.setProperty("name",f.name),_.setProperty("type",f.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",c)}n.fillStyle="#9C9",n.beginPath(),n.arc(s-16,h+o*.5,5,0,2*Math.PI),n.fill(),n.fillStyle="#AAA",n.fillText(f.name,30,h+o*.75),n.fillStyle="#777",n.fillText(f.type,130,h+o*.75),h+=o}}this.drawButton(20,h+2,s-20,o-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(t)},LGraphCanvas.prototype.drawSubgraphPanelRight=function(e,t,n){var r=t.outputs?t.outputs.length:0,s=this.bgcanvas.width,o=200,h=Math.floor(LiteGraph.NODE_SLOT_HEIGHT*1.6);n.fillStyle="#111",n.globalAlpha=.8,n.beginPath(),n.roundRect(s-o-10,10,o,(r+1)*h+50,[8]),n.fill(),n.globalAlpha=1,n.fillStyle="#888",n.font="14px Arial",n.textAlign="left";var u="Graph Outputs",f=n.measureText(u).width;if(n.fillText(u,s-f-20,34),this.drawButton(s-o,20,20,20,"X","#151515")){this.closeSubgraph();return}var c=50;if(n.font="14px Arial",t.outputs)for(var _=0;_<t.outputs.length;++_){var O=t.outputs[_];if(!O.not_subgraph_input){if(this.drawButton(s-o,c+2,o-20,h-2)){var d=t.constructor.output_node_type||"graph/output";this.graph.beforeChange();var b=LiteGraph.createNode(d);b?(e.add(b),this.block_click=!1,this.last_click_position=null,this.selectNodes([b]),this.node_dragged=b,this.dragging_canvas=!1,b.setProperty("name",O.name),b.setProperty("type",O.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",d)}n.fillStyle="#9C9",n.beginPath(),n.arc(s-o+16,c+h*.5,5,0,2*Math.PI),n.fill(),n.fillStyle="#AAA",n.fillText(O.name,s-o+30,c+h*.75),n.fillStyle="#777",n.fillText(O.type,s-o+130,c+h*.75),c+=h}}this.drawButton(s-o,c+2,o-20,h-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialogRight(t)},LGraphCanvas.prototype.drawButton=function(e,t,n,r,s,o,h,u){var f=this.ctx;o=o||LiteGraph.NODE_DEFAULT_COLOR,h=h||"#555",u=u||LiteGraph.NODE_TEXT_COLOR;var c=this.ds.convertOffsetToCanvas(this.graph_mouse),_=LiteGraph.isInsideRectangle(c[0],c[1],e,t,n,r);if(c=this.last_click_position?[this.last_click_position[0],this.last_click_position[1]]:null,c){var O=this.canvas.getBoundingClientRect();c[0]-=O.left,c[1]-=O.top}var d=c&&LiteGraph.isInsideRectangle(c[0],c[1],e,t,n,r);f.fillStyle=_?h:o,d&&(f.fillStyle="#AAA"),f.beginPath(),f.roundRect(e,t,n,r,[4]),f.fill(),s!=null&&s.constructor==String&&(f.fillStyle=u,f.textAlign="center",f.font=(r*.65|0)+"px Arial",f.fillText(s,e+n*.5,t+r*.75),f.textAlign="left");var b=d&&!this.block_click;return d&&this.blockClick(),b},LGraphCanvas.prototype.isAreaClicked=function(e,t,n,r,s){var o=this.mouse;LiteGraph.isInsideRectangle(o[0],o[1],e,t,n,r),o=this.last_click_position;var h=o&&LiteGraph.isInsideRectangle(o[0],o[1],e,t,n,r),u=h&&!this.block_click;return h&&s&&this.blockClick(),u},LGraphCanvas.prototype.renderInfo=function(e,t,n){t=t||10,n=n||this.canvas.height-80,e.save(),e.translate(t,n),e.font="10px Arial",e.fillStyle="#888",e.textAlign="left",this.graph?(e.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13*1),e.fillText("I: "+this.graph.iteration,5,13*2),e.fillText("N: "+this.graph._nodes.length+" ["+this.visible_nodes.length+"]",5,13*3),e.fillText("V: "+this.graph._version,5,13*4),e.fillText("FPS:"+this.fps.toFixed(2),5,13*5)):e.fillText("No graph selected",5,13*1),e.restore()},LGraphCanvas.prototype.drawBackCanvas=function(){var e=this.bgcanvas;(e.width!=this.canvas.width||e.height!=this.canvas.height)&&(e.width=this.canvas.width,e.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));var t=this.bgctx;t.start&&t.start();var n=this.viewport||[0,0,t.canvas.width,t.canvas.height];if(this.clear_background&&t.clearRect(n[0],n[1],n[2],n[3]),this._graph_stack&&this._graph_stack.length){t.save(),this._graph_stack[this._graph_stack.length-1];var r=this.graph._subgraph_node;t.strokeStyle=r.bgcolor,t.lineWidth=10,t.strokeRect(1,1,e.width-2,e.height-2),t.lineWidth=1,t.font="40px Arial",t.textAlign="center",t.fillStyle=r.bgcolor||"#AAA";for(var s="",o=1;o<this._graph_stack.length;++o)s+=this._graph_stack[o]._subgraph_node.getTitle()+" >> ";t.fillText(s+r.getTitle(),e.width*.5,40),t.restore()}var h=!1;if(this.onRenderBackground&&(h=this.onRenderBackground(e,t)),this.viewport||(t.restore(),t.setTransform(1,0,0,1,0,0)),this.visible_links.length=0,this.graph){if(t.save(),this.ds.toCanvasContext(t),this.ds.scale<1.5&&!h&&this.clear_background_color&&(t.fillStyle=this.clear_background_color,t.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3])),this.background_image&&this.ds.scale>.5&&!h){if(this.zoom_modify_alpha?t.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:t.globalAlpha=this.editor_alpha,t.imageSmoothingEnabled=t.imageSmoothingEnabled=!1,!this._bg_img||this._bg_img.name!=this.background_image){this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image;var u=this;this._bg_img.onload=function(){u.draw(!0,!0)}}var f=null;this._pattern==null&&this._bg_img.width>0?(f=t.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=f):f=this._pattern,f&&(t.fillStyle=f,t.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),t.fillStyle="transparent"),t.globalAlpha=1,t.imageSmoothingEnabled=t.imageSmoothingEnabled=!0}this.graph._groups.length&&!this.live_mode&&this.drawGroups(e,t),this.onDrawBackground&&this.onDrawBackground(t,this.visible_area),this.onBackgroundRender&&(console.error("WARNING! onBackgroundRender deprecated, now is named onDrawBackground "),this.onBackgroundRender=null),this.render_canvas_border&&(t.strokeStyle="#235",t.strokeRect(0,0,e.width,e.height)),this.render_connections_shadows?(t.shadowColor="#000",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=6):t.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(t),t.shadowColor="rgba(0,0,0,0)",t.restore()}t.finish&&t.finish(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0};var temp_vec2=new Float32Array(2);LGraphCanvas.prototype.drawNode=function(e,t){this.current_node=e;var n=e.color||e.constructor.color||LiteGraph.NODE_DEFAULT_COLOR,r=e.bgcolor||e.constructor.bgcolor||LiteGraph.NODE_DEFAULT_BGCOLOR;e.mouseOver;var s=this.ds.scale<.6;if(this.live_mode){e.flags.collapsed||(t.shadowColor="transparent",e.onDrawForeground&&e.onDrawForeground(t,this,this.canvas));return}var o=this.editor_alpha;if(t.globalAlpha=o,this.render_shadows&&!s?(t.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR,t.shadowOffsetX=2*this.ds.scale,t.shadowOffsetY=2*this.ds.scale,t.shadowBlur=3*this.ds.scale):t.shadowColor="transparent",!(e.flags.collapsed&&e.onDrawCollapsed&&e.onDrawCollapsed(t,this)==!0)){var h=e._shape||LiteGraph.BOX_SHAPE,u=temp_vec2;temp_vec2.set(e.size);var f=e.horizontal;if(e.flags.collapsed){t.font=this.inner_text_font;var c=e.getTitle?e.getTitle():e.title;c!=null&&(e._collapsed_width=Math.min(e.size[0],t.measureText(c).width+LiteGraph.NODE_TITLE_HEIGHT*2),u[0]=e._collapsed_width,u[1]=0)}e.clip_area&&(t.save(),t.beginPath(),h==LiteGraph.BOX_SHAPE?t.rect(0,0,u[0],u[1]):h==LiteGraph.ROUND_SHAPE?t.roundRect(0,0,u[0],u[1],[10]):h==LiteGraph.CIRCLE_SHAPE&&t.arc(u[0]*.5,u[1]*.5,u[0]*.5,0,Math.PI*2),t.clip()),e.has_errors&&(r="red"),this.drawNodeShape(e,t,u,n,r,e.is_selected,e.mouseOver),t.shadowColor="transparent",e.onDrawForeground&&e.onDrawForeground(t,this,this.canvas),t.textAlign=f?"center":"left",t.font=this.inner_text_font;var _=!s,O=this.connecting_output,d=this.connecting_input;t.lineWidth=1;var b=0,S=new Float32Array(2);if(e.flags.collapsed){if(this.render_collapsed_slots){var C=null,N=null;if(e.inputs)for(var G=0;G<e.inputs.length;G++){var z=e.inputs[G];if(z.link!=null){C=z;break}}if(e.outputs)for(var G=0;G<e.outputs.length;G++){var z=e.outputs[G];!z.links||!z.links.length||(N=z)}if(C){var R=0,Y=LiteGraph.NODE_TITLE_HEIGHT*-.5;f&&(R=e._collapsed_width*.5,Y=-LiteGraph.NODE_TITLE_HEIGHT),t.fillStyle="#686",t.beginPath(),z.type===LiteGraph.EVENT||z.shape===LiteGraph.BOX_SHAPE?t.rect(R-7+.5,Y-4,14,8):z.shape===LiteGraph.ARROW_SHAPE?(t.moveTo(R+8,Y),t.lineTo(R+-4,Y-4),t.lineTo(R+-4,Y+4),t.closePath()):t.arc(R,Y,4,0,Math.PI*2),t.fill()}if(N){var R=e._collapsed_width,Y=LiteGraph.NODE_TITLE_HEIGHT*-.5;f&&(R=e._collapsed_width*.5,Y=0),t.fillStyle="#686",t.strokeStyle="black",t.beginPath(),z.type===LiteGraph.EVENT||z.shape===LiteGraph.BOX_SHAPE?t.rect(R-7+.5,Y-4,14,8):z.shape===LiteGraph.ARROW_SHAPE?(t.moveTo(R+6,Y),t.lineTo(R-6,Y-4),t.lineTo(R-6,Y+4),t.closePath()):t.arc(R,Y,4,0,Math.PI*2),t.fill()}}}else{if(e.inputs)for(var G=0;G<e.inputs.length;G++){var z=e.inputs[G],$=z.type,A=z.shape;t.globalAlpha=o,this.connecting_output&&!LiteGraph.isValidConnection(z.type,O.type)&&(t.globalAlpha=.4*o),t.fillStyle=z.link!=null?z.color_on||this.default_connection_color_byType[$]||this.default_connection_color.input_on:z.color_off||this.default_connection_color_byTypeOff[$]||this.default_connection_color_byType[$]||this.default_connection_color.input_off;var l=e.getConnectionPos(!0,G,S);l[0]-=e.pos[0],l[1]-=e.pos[1],b<l[1]+LiteGraph.NODE_SLOT_HEIGHT*.5&&(b=l[1]+LiteGraph.NODE_SLOT_HEIGHT*.5),t.beginPath(),$=="array"&&(A=LiteGraph.GRID_SHAPE);var I=!0;if(z.type===LiteGraph.EVENT||z.shape===LiteGraph.BOX_SHAPE?f?t.rect(l[0]-5+.5,l[1]-8+.5,10,14):t.rect(l[0]-6+.5,l[1]-5+.5,14,10):A===LiteGraph.ARROW_SHAPE?(t.moveTo(l[0]+8,l[1]+.5),t.lineTo(l[0]-4,l[1]+6+.5),t.lineTo(l[0]-4,l[1]-6+.5),t.closePath()):A===LiteGraph.GRID_SHAPE?(t.rect(l[0]-4,l[1]-4,2,2),t.rect(l[0]-1,l[1]-4,2,2),t.rect(l[0]+2,l[1]-4,2,2),t.rect(l[0]-4,l[1]-1,2,2),t.rect(l[0]-1,l[1]-1,2,2),t.rect(l[0]+2,l[1]-1,2,2),t.rect(l[0]-4,l[1]+2,2,2),t.rect(l[0]-1,l[1]+2,2,2),t.rect(l[0]+2,l[1]+2,2,2),I=!1):s?t.rect(l[0]-4,l[1]-4,8,8):t.arc(l[0],l[1],4,0,Math.PI*2),t.fill(),_){var T=z.label!=null?z.label:z.name;T&&(t.fillStyle=LiteGraph.NODE_TEXT_COLOR,f||z.dir==LiteGraph.UP?t.fillText(T,l[0],l[1]-10):t.fillText(T,l[0]+10,l[1]+5))}}if(t.textAlign=f?"center":"right",t.strokeStyle="black",e.outputs)for(var G=0;G<e.outputs.length;G++){var z=e.outputs[G],$=z.type,A=z.shape;this.connecting_input&&!LiteGraph.isValidConnection($,d.type)&&(t.globalAlpha=.4*o);var l=e.getConnectionPos(!1,G,S);l[0]-=e.pos[0],l[1]-=e.pos[1],b<l[1]+LiteGraph.NODE_SLOT_HEIGHT*.5&&(b=l[1]+LiteGraph.NODE_SLOT_HEIGHT*.5),t.fillStyle=z.links&&z.links.length?z.color_on||this.default_connection_color_byType[$]||this.default_connection_color.output_on:z.color_off||this.default_connection_color_byTypeOff[$]||this.default_connection_color_byType[$]||this.default_connection_color.output_off,t.beginPath(),$=="array"&&(A=LiteGraph.GRID_SHAPE);var I=!0;if($===LiteGraph.EVENT||A===LiteGraph.BOX_SHAPE?f?t.rect(l[0]-5+.5,l[1]-8+.5,10,14):t.rect(l[0]-6+.5,l[1]-5+.5,14,10):A===LiteGraph.ARROW_SHAPE?(t.moveTo(l[0]+8,l[1]+.5),t.lineTo(l[0]-4,l[1]+6+.5),t.lineTo(l[0]-4,l[1]-6+.5),t.closePath()):A===LiteGraph.GRID_SHAPE?(t.rect(l[0]-4,l[1]-4,2,2),t.rect(l[0]-1,l[1]-4,2,2),t.rect(l[0]+2,l[1]-4,2,2),t.rect(l[0]-4,l[1]-1,2,2),t.rect(l[0]-1,l[1]-1,2,2),t.rect(l[0]+2,l[1]-1,2,2),t.rect(l[0]-4,l[1]+2,2,2),t.rect(l[0]-1,l[1]+2,2,2),t.rect(l[0]+2,l[1]+2,2,2),I=!1):s?t.rect(l[0]-4,l[1]-4,8,8):t.arc(l[0],l[1],4,0,Math.PI*2),t.fill(),!s&&I&&t.stroke(),_){var T=z.label!=null?z.label:z.name;T&&(t.fillStyle=LiteGraph.NODE_TEXT_COLOR,f||z.dir==LiteGraph.DOWN?t.fillText(T,l[0],l[1]-8):t.fillText(T,l[0]-10,l[1]+5))}}if(t.textAlign="left",t.globalAlpha=1,e.widgets){var L=b;(f||e.widgets_up)&&(L=2),e.widgets_start_y!=null&&(L=e.widgets_start_y),this.drawNodeWidgets(e,L,t,this.node_widget&&this.node_widget[0]==e?this.node_widget[1]:null)}}e.clip_area&&t.restore(),t.globalAlpha=1}},LGraphCanvas.prototype.drawLinkTooltip=function(e,t){var n=t._pos;if(e.fillStyle="black",e.beginPath(),e.arc(n[0],n[1],3,0,Math.PI*2),e.fill(),t.data!=null&&!(this.onDrawLinkTooltip&&this.onDrawLinkTooltip(e,t,this)==!0)){var r=t.data,s=null;if(r.constructor===Number?s=r.toFixed(2):r.constructor===String?s='"'+r+'"':r.constructor===Boolean?s=String(r):r.toToolTip?s=r.toToolTip():s="["+r.constructor.name+"]",s!=null){s=s.substr(0,30),e.font="14px Courier New";var o=e.measureText(s),h=o.width+20,u=24;e.shadowColor="black",e.shadowOffsetX=2,e.shadowOffsetY=2,e.shadowBlur=3,e.fillStyle="#454",e.beginPath(),e.roundRect(n[0]-h*.5,n[1]-15-u,h,u,[3]),e.moveTo(n[0]-10,n[1]-15),e.lineTo(n[0]+10,n[1]-15),e.lineTo(n[0],n[1]-5),e.fill(),e.shadowColor="transparent",e.textAlign="center",e.fillStyle="#CEC",e.fillText(s,n[0],n[1]-15-u*.3)}}};var tmp_area=new Float32Array(4);LGraphCanvas.prototype.drawNodeShape=function(e,t,n,r,s,o,h){t.strokeStyle=r,t.fillStyle=s;var u=LiteGraph.NODE_TITLE_HEIGHT,f=this.ds.scale<.5,c=e._shape||e.constructor.shape||LiteGraph.ROUND_SHAPE,_=e.constructor.title_mode,O=!0;_==LiteGraph.TRANSPARENT_TITLE||_==LiteGraph.NO_TITLE?O=!1:_==LiteGraph.AUTOHIDE_TITLE&&h&&(O=!0);var d=tmp_area;d[0]=0,d[1]=O?-u:0,d[2]=n[0]+1,d[3]=O?n[1]+u:n[1];var b=t.globalAlpha;if(t.beginPath(),c==LiteGraph.BOX_SHAPE||f?t.fillRect(d[0],d[1],d[2],d[3]):c==LiteGraph.ROUND_SHAPE||c==LiteGraph.CARD_SHAPE?t.roundRect(d[0],d[1],d[2],d[3],c==LiteGraph.CARD_SHAPE?[this.round_radius,this.round_radius,0,0]:[this.round_radius]):c==LiteGraph.CIRCLE_SHAPE&&t.arc(n[0]*.5,n[1]*.5,n[0]*.5,0,Math.PI*2),t.fill(),!e.flags.collapsed&&O&&(t.shadowColor="transparent",t.fillStyle="rgba(0,0,0,0.2)",t.fillRect(0,-1,d[2],2)),t.shadowColor="transparent",e.onDrawBackground&&e.onDrawBackground(t,this,this.canvas,this.graph_mouse),O||_==LiteGraph.TRANSPARENT_TITLE){if(e.onDrawTitleBar)e.onDrawTitleBar(t,u,n,this.ds.scale,r);else if(_!=LiteGraph.TRANSPARENT_TITLE&&(e.constructor.title_color||this.render_title_colored)){var S=e.constructor.title_color||r;if(e.flags.collapsed&&(t.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR),this.use_gradients){var G=LGraphCanvas.gradients[S];G||(G=LGraphCanvas.gradients[S]=t.createLinearGradient(0,0,400,0),G.addColorStop(0,S),G.addColorStop(1,"#000")),t.fillStyle=G}else t.fillStyle=S;t.beginPath(),c==LiteGraph.BOX_SHAPE||f?t.rect(0,-u,n[0]+1,u):(c==LiteGraph.ROUND_SHAPE||c==LiteGraph.CARD_SHAPE)&&t.roundRect(0,-u,n[0]+1,u,e.flags.collapsed?[this.round_radius]:[this.round_radius,this.round_radius,0,0]),t.fill(),t.shadowColor="transparent"}var z=!1;LiteGraph.node_box_coloured_by_mode&&LiteGraph.NODE_MODES_COLORS[e.mode]&&(z=LiteGraph.NODE_MODES_COLORS[e.mode]),LiteGraph.node_box_coloured_when_on&&(z=e.action_triggered?"#FFF":e.execute_triggered?"#AAA":z);var $=10;if(e.onDrawTitleBox?e.onDrawTitleBox(t,u,n,this.ds.scale):c==LiteGraph.ROUND_SHAPE||c==LiteGraph.CIRCLE_SHAPE||c==LiteGraph.CARD_SHAPE?(f&&(t.fillStyle="black",t.beginPath(),t.arc(u*.5,u*-.5,$*.5+1,0,Math.PI*2),t.fill()),t.fillStyle=e.boxcolor||z||LiteGraph.NODE_DEFAULT_BOXCOLOR,f?t.fillRect(u*.5-$*.5,u*-.5-$*.5,$,$):(t.beginPath(),t.arc(u*.5,u*-.5,$*.5,0,Math.PI*2),t.fill())):(f&&(t.fillStyle="black",t.fillRect((u-$)*.5-1,(u+$)*-.5-1,$+2,$+2)),t.fillStyle=e.boxcolor||z||LiteGraph.NODE_DEFAULT_BOXCOLOR,t.fillRect((u-$)*.5,(u+$)*-.5,$,$)),t.globalAlpha=b,e.onDrawTitleText&&e.onDrawTitleText(t,u,n,this.ds.scale,this.title_text_font,o),!f){t.font=this.title_text_font;var A=String(e.getTitle());A&&(o?t.fillStyle=LiteGraph.NODE_SELECTED_TITLE_COLOR:t.fillStyle=e.constructor.title_text_color||this.node_title_color,e.flags.collapsed?(t.textAlign="left",t.measureText(A),t.fillText(A.substr(0,20),u,LiteGraph.NODE_TITLE_TEXT_Y-u),t.textAlign="left"):(t.textAlign="left",t.fillText(A,u,LiteGraph.NODE_TITLE_TEXT_Y-u)))}if(!e.flags.collapsed&&e.subgraph&&!e.skip_subgraph_button){var l=LiteGraph.NODE_TITLE_HEIGHT,I=e.size[0]-l,T=LiteGraph.isInsideRectangle(this.graph_mouse[0]-e.pos[0],this.graph_mouse[1]-e.pos[1],I+2,-l+2,l-4,l-4);t.fillStyle=T?"#888":"#555",c==LiteGraph.BOX_SHAPE||f?t.fillRect(I+2,-l+2,l-4,l-4):(t.beginPath(),t.roundRect(I+2,-l+2,l-4,l-4,[4]),t.fill()),t.fillStyle="#333",t.beginPath(),t.moveTo(I+l*.2,-l*.6),t.lineTo(I+l*.8,-l*.6),t.lineTo(I+l*.5,-l*.3),t.fill()}e.onDrawTitle&&e.onDrawTitle(t)}o&&(e.onBounding&&e.onBounding(d),_==LiteGraph.TRANSPARENT_TITLE&&(d[1]-=u,d[3]+=u),t.lineWidth=1,t.globalAlpha=.8,t.beginPath(),c==LiteGraph.BOX_SHAPE?t.rect(-6+d[0],-6+d[1],12+d[2],12+d[3]):c==LiteGraph.ROUND_SHAPE||c==LiteGraph.CARD_SHAPE&&e.flags.collapsed?t.roundRect(-6+d[0],-6+d[1],12+d[2],12+d[3],[this.round_radius*2]):c==LiteGraph.CARD_SHAPE?t.roundRect(-6+d[0],-6+d[1],12+d[2],12+d[3],[this.round_radius*2,2,this.round_radius*2,2]):c==LiteGraph.CIRCLE_SHAPE&&t.arc(n[0]*.5,n[1]*.5,n[0]*.5+6,0,Math.PI*2),t.strokeStyle=LiteGraph.NODE_BOX_OUTLINE_COLOR,t.stroke(),t.strokeStyle=r,t.globalAlpha=1),e.execute_triggered>0&&e.execute_triggered--,e.action_triggered>0&&e.action_triggered--};var margin_area=new Float32Array(4),link_bounding=new Float32Array(4),tempA=new Float32Array(2),tempB=new Float32Array(2);LGraphCanvas.prototype.drawConnections=function(e){var t=LiteGraph.getTime(),n=this.visible_area;margin_area[0]=n[0]-20,margin_area[1]=n[1]-20,margin_area[2]=n[2]+40,margin_area[3]=n[3]+40,e.lineWidth=this.connections_width,e.fillStyle="#AAA",e.strokeStyle="#AAA",e.globalAlpha=this.editor_alpha;for(var r=this.graph._nodes,s=0,o=r.length;s<o;++s){var h=r[s];if(!(!h.inputs||!h.inputs.length))for(var u=0;u<h.inputs.length;++u){var f=h.inputs[u];if(!(!f||f.link==null)){var c=f.link,_=this.graph.links[c];if(_){var O=this.graph.getNodeById(_.origin_id);if(O!=null){var d=_.origin_slot,b=null;d==-1?b=[O.pos[0]+10,O.pos[1]+10]:b=O.getConnectionPos(!1,d,tempA);var S=h.getConnectionPos(!0,u,tempB);if(link_bounding[0]=b[0],link_bounding[1]=b[1],link_bounding[2]=S[0]-b[0],link_bounding[3]=S[1]-b[1],link_bounding[2]<0&&(link_bounding[0]+=link_bounding[2],link_bounding[2]=Math.abs(link_bounding[2])),link_bounding[3]<0&&(link_bounding[1]+=link_bounding[3],link_bounding[3]=Math.abs(link_bounding[3])),!!overlapBounding(link_bounding,margin_area)){var G=O.outputs[d],z=h.inputs[u];if(!(!G||!z)){var $=G.dir||(O.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT),A=z.dir||(h.horizontal?LiteGraph.UP:LiteGraph.LEFT);if(this.renderLink(e,b,S,_,!1,0,null,$,A),_&&_._last_time&&t-_._last_time<1e3){var l=2-(t-_._last_time)*.002,I=e.globalAlpha;e.globalAlpha=I*l,this.renderLink(e,b,S,_,!0,l,"white",$,A),e.globalAlpha=I}}}}}}}}e.globalAlpha=1},LGraphCanvas.prototype.renderLink=function(e,t,n,r,s,o,h,u,f,c){r&&this.visible_links.push(r),!h&&r&&(h=r.color||LGraphCanvas.link_type_colors[r.type]),h||(h=this.default_link_color),r!=null&&this.highlighted_links[r.id]&&(h="#FFF"),u=u||LiteGraph.RIGHT,f=f||LiteGraph.LEFT;var _=distance(t,n);this.render_connections_border&&this.ds.scale>.6&&(e.lineWidth=this.connections_width+4),e.lineJoin="round",c=c||1,c>1&&(e.lineWidth=.5),e.beginPath();for(var O=0;O<c;O+=1){var d=(O-(c-1)*.5)*5;if(this.links_render_mode==LiteGraph.SPLINE_LINK){e.moveTo(t[0],t[1]+d);var b=0,S=0,G=0,z=0;switch(u){case LiteGraph.LEFT:b=_*-.25;break;case LiteGraph.RIGHT:b=_*.25;break;case LiteGraph.UP:S=_*-.25;break;case LiteGraph.DOWN:S=_*.25;break}switch(f){case LiteGraph.LEFT:G=_*-.25;break;case LiteGraph.RIGHT:G=_*.25;break;case LiteGraph.UP:z=_*-.25;break;case LiteGraph.DOWN:z=_*.25;break}e.bezierCurveTo(t[0]+b,t[1]+S+d,n[0]+G,n[1]+z+d,n[0],n[1]+d)}else if(this.links_render_mode==LiteGraph.LINEAR_LINK){e.moveTo(t[0],t[1]+d);var b=0,S=0,G=0,z=0;switch(u){case LiteGraph.LEFT:b=-1;break;case LiteGraph.RIGHT:b=1;break;case LiteGraph.UP:S=-1;break;case LiteGraph.DOWN:S=1;break}switch(f){case LiteGraph.LEFT:G=-1;break;case LiteGraph.RIGHT:G=1;break;case LiteGraph.UP:z=-1;break;case LiteGraph.DOWN:z=1;break}var $=15;e.lineTo(t[0]+b*$,t[1]+S*$+d),e.lineTo(n[0]+G*$,n[1]+z*$+d),e.lineTo(n[0],n[1]+d)}else if(this.links_render_mode==LiteGraph.STRAIGHT_LINK){e.moveTo(t[0],t[1]);var A=t[0],l=t[1],I=n[0],T=n[1];u==LiteGraph.RIGHT?A+=10:l+=10,f==LiteGraph.LEFT?I-=10:T-=10,e.lineTo(A,l),e.lineTo((A+I)*.5,l),e.lineTo((A+I)*.5,T),e.lineTo(I,T),e.lineTo(n[0],n[1])}else return}this.render_connections_border&&this.ds.scale>.6&&!s&&(e.strokeStyle="rgba(0,0,0,0.5)",e.stroke()),e.lineWidth=this.connections_width,e.fillStyle=e.strokeStyle=h,e.stroke();var L=this.computeConnectionPoint(t,n,.5,u,f);if(r&&r._pos&&(r._pos[0]=L[0],r._pos[1]=L[1]),this.ds.scale>=.6&&this.highquality_render&&f!=LiteGraph.CENTER){if(this.render_connection_arrows){var C=this.computeConnectionPoint(t,n,.25,u,f),N=this.computeConnectionPoint(t,n,.26,u,f),R=this.computeConnectionPoint(t,n,.75,u,f),Y=this.computeConnectionPoint(t,n,.76,u,f),ut=0,mt=0;this.render_curved_connections?(ut=-Math.atan2(N[0]-C[0],N[1]-C[1]),mt=-Math.atan2(Y[0]-R[0],Y[1]-R[1])):mt=ut=n[1]>t[1]?0:Math.PI,e.save(),e.translate(C[0],C[1]),e.rotate(ut),e.beginPath(),e.moveTo(-5,-3),e.lineTo(0,7),e.lineTo(5,-3),e.fill(),e.restore(),e.save(),e.translate(R[0],R[1]),e.rotate(mt),e.beginPath(),e.moveTo(-5,-3),e.lineTo(0,7),e.lineTo(5,-3),e.fill(),e.restore()}e.beginPath(),e.arc(L[0],L[1],5,0,Math.PI*2),e.fill()}if(o){e.fillStyle=h;for(var O=0;O<5;++O){var yt=(LiteGraph.getTime()*.001+O*.2)%1,L=this.computeConnectionPoint(t,n,yt,u,f);e.beginPath(),e.arc(L[0],L[1],5,0,2*Math.PI),e.fill()}}},LGraphCanvas.prototype.computeConnectionPoint=function(e,t,n,r,s){r=r||LiteGraph.RIGHT,s=s||LiteGraph.LEFT;var o=distance(e,t),h=e,u=[e[0],e[1]],f=[t[0],t[1]],c=t;switch(r){case LiteGraph.LEFT:u[0]+=o*-.25;break;case LiteGraph.RIGHT:u[0]+=o*.25;break;case LiteGraph.UP:u[1]+=o*-.25;break;case LiteGraph.DOWN:u[1]+=o*.25;break}switch(s){case LiteGraph.LEFT:f[0]+=o*-.25;break;case LiteGraph.RIGHT:f[0]+=o*.25;break;case LiteGraph.UP:f[1]+=o*-.25;break;case LiteGraph.DOWN:f[1]+=o*.25;break}var _=(1-n)*(1-n)*(1-n),O=3*((1-n)*(1-n))*n,d=3*(1-n)*(n*n),b=n*n*n,S=_*h[0]+O*u[0]+d*f[0]+b*c[0],G=_*h[1]+O*u[1]+d*f[1]+b*c[1];return[S,G]},LGraphCanvas.prototype.drawExecutionOrder=function(e){e.shadowColor="transparent",e.globalAlpha=.25,e.textAlign="center",e.strokeStyle="white",e.globalAlpha=.75;for(var t=this.visible_nodes,n=0;n<t.length;++n){var r=t[n];e.fillStyle="black",e.fillRect(r.pos[0]-LiteGraph.NODE_TITLE_HEIGHT,r.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),r.order==0&&e.strokeRect(r.pos[0]-LiteGraph.NODE_TITLE_HEIGHT+.5,r.pos[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),e.fillStyle="#FFF",e.fillText(r.order,r.pos[0]+LiteGraph.NODE_TITLE_HEIGHT*-.5,r.pos[1]-6)}e.globalAlpha=1},LGraphCanvas.prototype.drawNodeWidgets=function(e,t,n,r){if(!e.widgets||!e.widgets.length)return 0;var s=e.size[0],o=e.widgets;t+=2;var h=LiteGraph.NODE_WIDGET_HEIGHT,u=this.ds.scale>.5;n.save(),n.globalAlpha=this.editor_alpha;for(var f=LiteGraph.WIDGET_OUTLINE_COLOR,c=LiteGraph.WIDGET_BGCOLOR,_=LiteGraph.WIDGET_TEXT_COLOR,O=LiteGraph.WIDGET_SECONDARY_TEXT_COLOR,d=15,b=0;b<o.length;++b){var S=o[b],G=t;S.y&&(G=S.y),S.last_y=G,n.strokeStyle=f,n.fillStyle="#222",n.textAlign="left",S.disabled&&(n.globalAlpha*=.5);var z=S.width||s;switch(S.type){case"button":S.clicked&&(n.fillStyle="#AAA",S.clicked=!1,this.dirty_canvas=!0),n.fillRect(d,G,z-d*2,h),u&&!S.disabled&&n.strokeRect(d,G,z-d*2,h),u&&(n.textAlign="center",n.fillStyle=_,n.fillText(S.label||S.name,z*.5,G+h*.7));break;case"toggle":if(n.textAlign="left",n.strokeStyle=f,n.fillStyle=c,n.beginPath(),u?n.roundRect(d,G,z-d*2,h,[h*.5]):n.rect(d,G,z-d*2,h),n.fill(),u&&!S.disabled&&n.stroke(),n.fillStyle=S.value?"#89A":"#333",n.beginPath(),n.arc(z-d*2,G+h*.5,h*.36,0,Math.PI*2),n.fill(),u){n.fillStyle=O;const L=S.label||S.name;L!=null&&n.fillText(L,d*2,G+h*.7),n.fillStyle=S.value?_:O,n.textAlign="right",n.fillText(S.value?S.options.on||"true":S.options.off||"false",z-40,G+h*.7)}break;case"slider":n.fillStyle=c,n.fillRect(d,G,z-d*2,h);var $=S.options.max-S.options.min,A=(S.value-S.options.min)/$;if(A<0&&(A=0),A>1&&(A=1),n.fillStyle=S.options.hasOwnProperty("slider_color")?S.options.slider_color:r==S?"#89A":"#678",n.fillRect(d,G,A*(z-d*2),h),u&&!S.disabled&&n.strokeRect(d,G,z-d*2,h),S.marker){var l=(S.marker-S.options.min)/$;l<0&&(l=0),l>1&&(l=1),n.fillStyle=S.options.hasOwnProperty("marker_color")?S.options.marker_color:"#AA9",n.fillRect(d+l*(z-d*2),G,2,h)}u&&(n.textAlign="center",n.fillStyle=_,n.fillText(S.label||S.name+"  "+Number(S.value).toFixed(S.options.precision!=null?S.options.precision:3),z*.5,G+h*.7));break;case"number":case"combo":if(n.textAlign="left",n.strokeStyle=f,n.fillStyle=c,n.beginPath(),u?n.roundRect(d,G,z-d*2,h,[h*.5]):n.rect(d,G,z-d*2,h),n.fill(),u)if(S.disabled||n.stroke(),n.fillStyle=_,S.disabled||(n.beginPath(),n.moveTo(d+16,G+5),n.lineTo(d+6,G+h*.5),n.lineTo(d+16,G+h-5),n.fill(),n.beginPath(),n.moveTo(z-d-16,G+5),n.lineTo(z-d-6,G+h*.5),n.lineTo(z-d-16,G+h-5),n.fill()),n.fillStyle=O,n.fillText(S.label||S.name,d*2+5,G+h*.7),n.fillStyle=_,n.textAlign="right",S.type=="number")n.fillText(Number(S.value).toFixed(S.options.precision!==void 0?S.options.precision:3),z-d*2-20,G+h*.7);else{var I=S.value;if(S.options.values){var T=S.options.values;T.constructor===Function&&(T=T()),T&&T.constructor!==Array&&(I=T[S.value])}n.fillText(I,z-d*2-20,G+h*.7)}break;case"string":case"text":if(n.textAlign="left",n.strokeStyle=f,n.fillStyle=c,n.beginPath(),u?n.roundRect(d,G,z-d*2,h,[h*.5]):n.rect(d,G,z-d*2,h),n.fill(),u){S.disabled||n.stroke(),n.save(),n.beginPath(),n.rect(d,G,z-d*2,h),n.clip(),n.fillStyle=O;const L=S.label||S.name;L!=null&&n.fillText(L,d*2,G+h*.7),n.fillStyle=_,n.textAlign="right",n.fillText(String(S.value).substr(0,30),z-d*2,G+h*.7),n.restore()}break;default:S.draw&&S.draw(n,e,z,G,h);break}t+=(S.computeSize?S.computeSize(z)[1]:h)+4,n.globalAlpha=this.editor_alpha}n.restore(),n.textAlign="left"},LGraphCanvas.prototype.processNodeWidgets=function(node,pos,event,active_widget){if(!node.widgets||!node.widgets.length||!this.allow_interaction&&!node.flags.allow_interaction)return null;for(var x=pos[0]-node.pos[0],y=pos[1]-node.pos[1],width=node.size[0],deltaX=event.deltaX||event.deltax||0,that=this,ref_window=this.getCanvasWindow(),i=0;i<node.widgets.length;++i){var w=node.widgets[i];if(!(!w||w.disabled)){var widget_height=w.computeSize?w.computeSize(width)[1]:LiteGraph.NODE_WIDGET_HEIGHT,widget_width=w.width||width;if(!(w!=active_widget&&(x<6||x>widget_width-12||y<w.last_y||y>w.last_y+widget_height||w.last_y===void 0))){var old_value=w.value;switch(w.type){case"button":event.type===LiteGraph.pointerevents_method+"down"&&(w.callback&&setTimeout(function(){w.callback(w,that,node,pos,event)},20),w.clicked=!0,this.dirty_canvas=!0);break;case"slider":var old_value=w.value,nvalue=clamp((x-15)/(widget_width-30),0,1);if(w.options.read_only)break;w.value=w.options.min+(w.options.max-w.options.min)*nvalue,old_value!=w.value&&setTimeout(function(){inner_value_change(w,w.value)},20),this.dirty_canvas=!0;break;case"number":case"combo":var old_value=w.value;if(event.type==LiteGraph.pointerevents_method+"move"&&w.type=="number")deltaX&&(w.value+=deltaX*.1*(w.options.step||1)),w.options.min!=null&&w.value<w.options.min&&(w.value=w.options.min),w.options.max!=null&&w.value>w.options.max&&(w.value=w.options.max);else if(event.type==LiteGraph.pointerevents_method+"down"){var values=w.options.values;values&&values.constructor===Function&&(values=w.options.values(w,node));var values_list=null;w.type!="number"&&(values_list=values.constructor===Array?values:Object.keys(values));var delta=x<40?-1:x>widget_width-40?1:0;if(w.type=="number")w.value+=delta*.1*(w.options.step||1),w.options.min!=null&&w.value<w.options.min&&(w.value=w.options.min),w.options.max!=null&&w.value>w.options.max&&(w.value=w.options.max);else if(delta){var index=-1;this.last_mouseclick=0,values.constructor===Object?index=values_list.indexOf(String(w.value))+delta:index=values_list.indexOf(w.value)+delta,index>=values_list.length&&(index=values_list.length-1),index<0&&(index=0),values.constructor===Array?w.value=values[index]:w.value=index}else{let e=function(t,n,r){return values!=values_list&&(t=text_values.indexOf(t)),this.value=t,inner_value_change(this,t),that.dirty_canvas=!0,!1};var text_values=values!=values_list?Object.values(values):values;new LiteGraph.ContextMenu(text_values,{scale:Math.max(1,this.ds.scale),event,className:"dark",callback:e.bind(w)},ref_window)}}else if(event.type==LiteGraph.pointerevents_method+"up"&&w.type=="number"){var delta=x<40?-1:x>widget_width-40?1:0;event.click_time<200&&delta==0&&this.prompt("Value",w.value,(function(v){if(/^[0-9+\-*/()\s]+|\d+\.\d+$/.test(v))try{v=eval(v)}catch(e){}this.value=Number(v),inner_value_change(this,this.value)}).bind(w),event)}old_value!=w.value&&setTimeout((function(){inner_value_change(this,this.value)}).bind(w),20),this.dirty_canvas=!0;break;case"toggle":event.type==LiteGraph.pointerevents_method+"down"&&(w.value=!w.value,setTimeout(function(){inner_value_change(w,w.value)},20));break;case"string":case"text":event.type==LiteGraph.pointerevents_method+"down"&&this.prompt("Value",w.value,(function(e){inner_value_change(this,e)}).bind(w),event,w.options?w.options.multiline:!1);break;default:w.mouse&&(this.dirty_canvas=w.mouse(event,[x,y],node));break}return old_value!=w.value&&(node.onWidgetChanged&&node.onWidgetChanged(w.name,w.value,old_value,w),node.graph._version++),w}}}function inner_value_change(e,t){e.type=="number"&&(t=Number(t)),e.value=t,e.options&&e.options.property&&node.properties[e.options.property]!==void 0&&node.setProperty(e.options.property,t),e.callback&&e.callback(e.value,that,node,pos,event)}return null},LGraphCanvas.prototype.drawGroups=function(e,t){if(this.graph){var n=this.graph._groups;t.save(),t.globalAlpha=.5*this.editor_alpha;for(var r=0;r<n.length;++r){var s=n[r];if(overlapBounding(this.visible_area,s._bounding)){t.fillStyle=s.color||"#335",t.strokeStyle=s.color||"#335";var o=s._pos,h=s._size;t.globalAlpha=.25*this.editor_alpha,t.beginPath(),t.rect(o[0]+.5,o[1]+.5,h[0],h[1]),t.fill(),t.globalAlpha=this.editor_alpha,t.stroke(),t.beginPath(),t.moveTo(o[0]+h[0],o[1]+h[1]),t.lineTo(o[0]+h[0]-10,o[1]+h[1]),t.lineTo(o[0]+h[0],o[1]+h[1]-10),t.fill();var u=s.font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE;t.font=u+"px Arial",t.textAlign="left",t.fillText(s.title,o[0]+4,o[1]+u)}}t.restore()}},LGraphCanvas.prototype.adjustNodesSize=function(){for(var e=this.graph._nodes,t=0;t<e.length;++t)e[t].size=e[t].computeSize();this.setDirty(!0,!0)},LGraphCanvas.prototype.resize=function(e,t){if(!e&&!t){var n=this.canvas.parentNode;e=n.offsetWidth,t=n.offsetHeight}this.canvas.width==e&&this.canvas.height==t||(this.canvas.width=e,this.canvas.height=t,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))},LGraphCanvas.prototype.switchLiveMode=function(e){if(!e){this.live_mode=!this.live_mode,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;return}var t=this,n=this.live_mode?1.1:.9;this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1);var r=setInterval(function(){t.editor_alpha*=n,t.dirty_canvas=!0,t.dirty_bgcanvas=!0,n<1&&t.editor_alpha<.01&&(clearInterval(r),n<1&&(t.live_mode=!0)),n>1&&t.editor_alpha>.99&&(clearInterval(r),t.editor_alpha=1)},1)},LGraphCanvas.prototype.onNodeSelectionChange=function(e){},LGraphCanvas.onGroupAdd=function(e,t,n){var r=LGraphCanvas.active_canvas;r.getCanvasWindow();var s=new LiteGraph.LGraphGroup;s.pos=r.convertEventToCanvasOffset(n),r.graph.add(s)},LGraphCanvas.getBoundaryNodes=function(e){let t=null,n=null,r=null,s=null;for(const o in e){const h=e[o],[u,f]=h.pos,[c,_]=h.size;(t===null||f<t.pos[1])&&(t=h),(n===null||u+c>n.pos[0]+n.size[0])&&(n=h),(r===null||f+_>r.pos[1]+r.size[1])&&(r=h),(s===null||u<s.pos[0])&&(s=h)}return{top:t,right:n,bottom:r,left:s}},LGraphCanvas.prototype.boundaryNodesForSelection=function(){return LGraphCanvas.getBoundaryNodes(Object.values(this.selected_nodes))},LGraphCanvas.alignNodes=function(e,t,n){if(!e)return;const r=LGraphCanvas.active_canvas;let s=[];n===void 0?s=LGraphCanvas.getBoundaryNodes(e):s={top:n,right:n,bottom:n,left:n};for(const[o,h]of Object.entries(r.selected_nodes))switch(t){case"right":h.pos[0]=s.right.pos[0]+s.right.size[0]-h.size[0];break;case"left":h.pos[0]=s.left.pos[0];break;case"top":h.pos[1]=s.top.pos[1];break;case"bottom":h.pos[1]=s.bottom.pos[1]+s.bottom.size[1]-h.size[1];break}r.dirty_canvas=!0,r.dirty_bgcanvas=!0},LGraphCanvas.onNodeAlign=function(e,t,n,r,s){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:n,callback:o,parentMenu:r});function o(h){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,h.toLowerCase(),s)}},LGraphCanvas.onGroupAlign=function(e,t,n,r){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:n,callback:s,parentMenu:r});function s(o){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,o.toLowerCase())}},LGraphCanvas.onMenuAdd=function(e,t,n,r,s){var o=LGraphCanvas.active_canvas,h=o.getCanvasWindow(),u=o.graph;if(!u)return;function f(c,_){var O=LiteGraph.getNodeTypesCategories(o.filter||u.filter).filter(function(S){return S.startsWith(c)}),d=[];O.map(function(S){if(S){var G=new RegExp("^("+c+")"),z=S.replace(G,"").split("/")[0],$=c===""?z+"/":c+z+"/",A=z;A.indexOf("::")!=-1&&(A=A.split("::")[1]);var l=d.findIndex(function(I){return I.value===$});l===-1&&d.push({value:$,content:A,has_submenu:!0,callback:function(I,T,L,C){f(I.value,C)}})}});var b=LiteGraph.getNodeTypesInCategory(c.slice(0,-1),o.filter||u.filter);b.map(function(S){if(!S.skip_list){var G={value:S.type,content:S.title,has_submenu:!1,callback:function(z,$,A,l){var I=l.getFirstEvent();o.graph.beforeChange();var T=LiteGraph.createNode(z.value);T&&(T.pos=o.convertEventToCanvasOffset(I),o.graph.add(T)),s&&s(T),o.graph.afterChange()}};d.push(G)}}),new LiteGraph.ContextMenu(d,{event:n,parentMenu:_},h)}return f("",r),!1},LGraphCanvas.onMenuCollapseAll=function(){},LGraphCanvas.onMenuNodeEdit=function(){},LGraphCanvas.showMenuNodeOptionalInputs=function(e,f,n,r,s){if(!s)return;var o=this,h=LGraphCanvas.active_canvas,u=h.getCanvasWindow(),f=s.optional_inputs;s.onGetInputs&&(f=s.onGetInputs());var c=[];if(f)for(var _=0;_<f.length;_++){var O=f[_];if(!O){c.push(null);continue}var d=O[0];O[2]||(O[2]={}),O[2].label&&(d=O[2].label),O[2].removable=!0;var b={content:d,value:O};O[1]==LiteGraph.ACTION&&(b.className="event"),c.push(b)}if(s.onMenuNodeInputs){var S=s.onMenuNodeInputs(c);S&&(c=S)}if(!c.length){console.log("no input entries");return}new LiteGraph.ContextMenu(c,{event:n,callback:G,parentMenu:r,node:s},u);function G(z,$,A){s&&(z.callback&&z.callback.call(o,s,z,$,A),z.value&&(s.graph.beforeChange(),s.addInput(z.value[0],z.value[1],z.value[2]),s.onNodeInputAdd&&s.onNodeInputAdd(z.value),s.setDirtyCanvas(!0,!0),s.graph.afterChange()))}return!1},LGraphCanvas.showMenuNodeOptionalOutputs=function(e,f,n,r,s){if(!s)return;var o=this,h=LGraphCanvas.active_canvas,u=h.getCanvasWindow(),f=s.optional_outputs;s.onGetOutputs&&(f=s.onGetOutputs());var c=[];if(f)for(var _=0;_<f.length;_++){var O=f[_];if(!O){c.push(null);continue}if(!(s.flags&&s.flags.skip_repeated_outputs&&s.findOutputSlot(O[0])!=-1)){var d=O[0];O[2]||(O[2]={}),O[2].label&&(d=O[2].label),O[2].removable=!0;var b={content:d,value:O};O[1]==LiteGraph.EVENT&&(b.className="event"),c.push(b)}}if(this.onMenuNodeOutputs&&(c=this.onMenuNodeOutputs(c)),LiteGraph.do_add_triggers_slots&&s.findOutputSlot("onExecuted")==-1&&c.push({content:"On Executed",value:["onExecuted",LiteGraph.EVENT,{nameLocked:!0}],className:"event"}),s.onMenuNodeOutputs){var S=s.onMenuNodeOutputs(c);S&&(c=S)}if(!c.length)return;new LiteGraph.ContextMenu(c,{event:n,callback:G,parentMenu:r,node:s},u);function G(z,$,A){if(s&&(z.callback&&z.callback.call(o,s,z,$,A),!!z.value)){var l=z.value[1];if(l&&(l.constructor===Object||l.constructor===Array)){var I=[];for(var T in l)I.push({content:T,value:l[T]});return new LiteGraph.ContextMenu(I,{event:$,callback:G,parentMenu:r,node:s}),!1}else s.graph.beforeChange(),s.addOutput(z.value[0],z.value[1],z.value[2]),s.onNodeOutputAdd&&s.onNodeOutputAdd(z.value),s.setDirtyCanvas(!0,!0),s.graph.afterChange()}}return!1},LGraphCanvas.onShowMenuNodeProperties=function(e,t,n,r,s){if(!s||!s.properties)return;var o=LGraphCanvas.active_canvas,h=o.getCanvasWindow(),u=[];for(var f in s.properties){var e=s.properties[f]!==void 0?s.properties[f]:" ";typeof e=="object"&&(e=JSON.stringify(e));var c=s.getPropertyInfo(f);(c.type=="enum"||c.type=="combo")&&(e=LGraphCanvas.getPropertyPrintableValue(e,c.values)),e=LGraphCanvas.decodeHTML(e),u.push({content:"<span class='property_name'>"+(c.label?c.label:f)+"</span><span class='property_value'>"+e+"</span>",value:f})}if(!u.length)return;new LiteGraph.ContextMenu(u,{event:n,callback:_,parentMenu:r,allow_html:!0,node:s},h);function _(O,d,b,S){if(s){var G=this.getBoundingClientRect();o.showEditPropertyValue(s,O.value,{position:[G.left,G.top]})}}return!1},LGraphCanvas.decodeHTML=function(e){var t=document.createElement("div");return t.innerText=e,t.innerHTML},LGraphCanvas.onMenuResizeNode=function(e,t,n,r,s){if(s){var o=function(f){f.size=f.computeSize(),f.onResize&&f.onResize(f.size)},h=LGraphCanvas.active_canvas;if(!h.selected_nodes||Object.keys(h.selected_nodes).length<=1)o(s);else for(var u in h.selected_nodes)o(h.selected_nodes[u]);s.setDirtyCanvas(!0,!0)}},LGraphCanvas.prototype.showLinkMenu=function(e,t){var n=this,r=n.graph.getNodeById(e.origin_id),s=n.graph.getNodeById(e.target_id),o=!1;r&&r.outputs&&r.outputs[e.origin_slot]&&(o=r.outputs[e.origin_slot].type);var h=!1;s&&s.outputs&&s.outputs[e.target_slot]&&(h=s.inputs[e.target_slot].type);var u=["Add Node",null,"Delete",null],f=new LiteGraph.ContextMenu(u,{event:t,title:e.data!=null?e.data.constructor.name:null,callback:c});function c(_,O,d){switch(_){case"Add Node":LGraphCanvas.onMenuAdd(null,null,d,f,function(b){!b.inputs||!b.inputs.length||!b.outputs||!b.outputs.length||r.connectByType(e.origin_slot,b,o)&&(b.connectByType(e.target_slot,s,h),b.pos[0]-=b.size[0]*.5)});break;case"Delete":n.graph.removeLink(e.id);break}}return!1},LGraphCanvas.prototype.createDefaultNodeForSlot=function(t){var t=t||{},n=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,position:[],nodeType:null,posAdd:[0,0],posSizeFix:[0,0]},t),r=this,s=n.nodeFrom&&n.slotFrom!==null,o=!s&&n.nodeTo&&n.slotTo!==null;if(!s&&!o)return console.warn("No data passed to createDefaultNodeForSlot "+n.nodeFrom+" "+n.slotFrom+" "+n.nodeTo+" "+n.slotTo),!1;if(!n.nodeType)return console.warn("No type to createDefaultNodeForSlot"),!1;var h=s?n.nodeFrom:n.nodeTo,u=s?n.slotFrom:n.slotTo,f=!1;switch(typeof u){case"string":f=s?h.findOutputSlot(u,!1):h.findInputSlot(u,!1),u=s?h.outputs[u]:h.inputs[u];break;case"object":f=s?h.findOutputSlot(u.name):h.findInputSlot(u.name);break;case"number":f=u,u=s?h.outputs[u]:h.inputs[u];break;case"undefined":default:return console.warn("Cant get slot information "+u),!1}(u===!1||f===!1)&&console.warn("createDefaultNodeForSlot bad slotX "+u+" "+f);var c=u.type==LiteGraph.EVENT?"_event_":u.type,_=s?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(_&&_[c]){if(u.link,nodeNewType=!1,typeof _[c]=="object"||typeof _[c]=="array"){for(var O in _[c])if(n.nodeType==_[c][O]||n.nodeType=="AUTO"){nodeNewType=_[c][O];break}}else(n.nodeType==_[c]||n.nodeType=="AUTO")&&(nodeNewType=_[c]);if(nodeNewType){var d=!1;typeof nodeNewType=="object"&&nodeNewType.node&&(d=nodeNewType,nodeNewType=nodeNewType.node);var b=LiteGraph.createNode(nodeNewType);if(b){if(d){if(d.properties)for(var S in d.properties)b.addProperty(S,d.properties[S]);if(d.inputs){b.inputs=[];for(var S in d.inputs)b.addOutput(d.inputs[S][0],d.inputs[S][1])}if(d.outputs){b.outputs=[];for(var S in d.outputs)b.addOutput(d.outputs[S][0],d.outputs[S][1])}d.title&&(b.title=d.title),d.json&&b.configure(d.json)}return r.graph.add(b),b.pos=[n.position[0]+n.posAdd[0]+(n.posSizeFix[0]?n.posSizeFix[0]*b.size[0]:0),n.position[1]+n.posAdd[1]+(n.posSizeFix[1]?n.posSizeFix[1]*b.size[1]:0)],s?n.nodeFrom.connectByType(f,b,c):n.nodeTo.connectByTypeOutput(f,b,c),!0}else console.log("failed creating "+nodeNewType)}}return!1},LGraphCanvas.prototype.showConnectionMenu=function(t){var t=t||{},n=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,e:null},t),r=this,s=n.nodeFrom&&n.slotFrom,o=!s&&n.nodeTo&&n.slotTo;if(!s&&!o)return console.warn("No data passed to showConnectionMenu"),!1;var h=s?n.nodeFrom:n.nodeTo,u=s?n.slotFrom:n.slotTo,f=!1;switch(typeof u){case"string":f=s?h.findOutputSlot(u,!1):h.findInputSlot(u,!1),u=s?h.outputs[u]:h.inputs[u];break;case"object":f=s?h.findOutputSlot(u.name):h.findInputSlot(u.name);break;case"number":f=u,u=s?h.outputs[u]:h.inputs[u];break;default:return console.warn("Cant get slot information "+u),!1}var c=["Add Node",null];r.allow_searchbox&&(c.push("Search"),c.push(null));var _=u.type==LiteGraph.EVENT?"_event_":u.type,O=s?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(O&&O[_])if(typeof O[_]=="object"||typeof O[_]=="array")for(var d in O[_])c.push(O[_][d]);else c.push(O[_]);var b=new LiteGraph.ContextMenu(c,{event:n.e,title:(u&&u.name!=""?u.name+(_?" | ":""):"")+(u&&_?_:""),callback:S});function S(G,z,$){switch(G){case"Add Node":LGraphCanvas.onMenuAdd(null,null,$,b,function(A){s?n.nodeFrom.connectByType(f,A,_):n.nodeTo.connectByTypeOutput(f,A,_)});break;case"Search":s?r.showSearchBox($,{node_from:n.nodeFrom,slot_from:u,type_filter_in:_}):r.showSearchBox($,{node_to:n.nodeTo,slot_from:u,type_filter_out:_});break;default:r.createDefaultNodeForSlot(Object.assign(n,{position:[n.e.canvasX,n.e.canvasY],nodeType:G}));break}}return!1},LGraphCanvas.onShowPropertyEditor=function(e,t,n,r,s){var o=e.property||"title",h=s[o],u=document.createElement("div");u.is_modified=!1,u.className="graphdialog",u.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",u.close=function(){u.parentNode&&u.parentNode.removeChild(u)};var f=u.querySelector(".name");f.innerText=o;var c=u.querySelector(".value");c&&(c.value=h,c.addEventListener("blur",function(l){this.focus()}),c.addEventListener("keydown",function(l){if(u.is_modified=!0,l.keyCode==27)u.close();else if(l.keyCode==13)$();else if(l.keyCode!=13&&l.target.localName!="textarea")return;l.preventDefault(),l.stopPropagation()}));var _=LGraphCanvas.active_canvas,O=_.canvas,d=O.getBoundingClientRect(),b=-20,S=-20;d&&(b-=d.left,S-=d.top),event?(u.style.left=event.clientX+b+"px",u.style.top=event.clientY+S+"px"):(u.style.left=O.width*.5+b+"px",u.style.top=O.height*.5+S+"px");var G=u.querySelector("button");G.addEventListener("click",$),O.parentNode.appendChild(u),c&&c.focus();var z=null;u.addEventListener("mouseleave",function(l){LiteGraph.dialog_close_on_mouse_leave&&!u.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(z=setTimeout(u.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),u.addEventListener("mouseenter",function(l){LiteGraph.dialog_close_on_mouse_leave&&z&&clearTimeout(z)});function $(){c&&A(c.value)}function A(l){e.type=="Number"?l=Number(l):e.type=="Boolean"&&(l=!!l),s[o]=l,u.parentNode&&u.parentNode.removeChild(u),s.setDirtyCanvas(!0,!0)}},LGraphCanvas.prototype.prompt=function(e,t,n,r,s){var o=this;e=e||"";var h=document.createElement("div");h.is_modified=!1,h.className="graphdialog rounded",s?h.innerHTML="<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":h.innerHTML="<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",h.close=function(){o.prompt_box=null,h.parentNode&&h.parentNode.removeChild(h)};var u=LGraphCanvas.active_canvas,f=u.canvas;f.parentNode.appendChild(h),this.ds.scale>1&&(h.style.transform="scale("+this.ds.scale+")");var c=null,_=!1;LiteGraph.pointerListenerAdd(h,"leave",function(l){_||LiteGraph.dialog_close_on_mouse_leave&&!h.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(c=setTimeout(h.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),LiteGraph.pointerListenerAdd(h,"enter",function(l){LiteGraph.dialog_close_on_mouse_leave&&c&&clearTimeout(c)});var O=h.querySelectorAll("select");O&&O.forEach(function(l){l.addEventListener("click",function(I){_++}),l.addEventListener("blur",function(I){_=0}),l.addEventListener("change",function(I){_=-1})}),o.prompt_box&&o.prompt_box.close(),o.prompt_box=h;var d=h.querySelector(".name");d.innerText=e;var b=h.querySelector(".value");b.value=t;var S=b;S.addEventListener("keydown",function(l){if(h.is_modified=!0,l.keyCode==27)h.close();else if(l.keyCode==13&&l.target.localName!="textarea")n&&n(this.value),h.close();else return;l.preventDefault(),l.stopPropagation()});var G=h.querySelector("button");G.addEventListener("click",function(l){n&&n(S.value),o.setDirty(!0),h.close()});var z=f.getBoundingClientRect(),$=-20,A=-20;return z&&($-=z.left,A-=z.top),r?(h.style.left=r.clientX+$+"px",h.style.top=r.clientY+A+"px"):(h.style.left=f.width*.5+$+"px",h.style.top=f.height*.5+A+"px"),setTimeout(function(){S.focus()},10),h},LGraphCanvas.search_limit=-1,LGraphCanvas.prototype.showSearchBox=function(e,t){var n={slot_from:null,node_from:null,node_to:null,do_type_filter:LiteGraph.search_filter_enabled,type_filter_in:!1,type_filter_out:!1,show_general_if_none_on_typefilter:!0,show_general_after_typefiltered:!0,hide_on_mouse_leave:LiteGraph.search_hide_on_mouse_leave,show_all_if_empty:!0,show_all_on_open:LiteGraph.search_show_all_on_open};t=Object.assign(n,t||{});var r=this,s=LGraphCanvas.active_canvas,o=s.canvas,h=o.ownerDocument||document,u=document.createElement("div");if(u.className="litegraph litesearchbox graphdialog rounded",u.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/>",t.do_type_filter&&(u.innerHTML+="<select class='slot_in_type_filter'><option value=''></option></select>",u.innerHTML+="<select class='slot_out_type_filter'><option value=''></option></select>"),u.innerHTML+="<div class='helper'></div>",h.fullscreenElement?h.fullscreenElement.appendChild(u):(h.body.appendChild(u),h.body.style.overflow="hidden"),t.do_type_filter)var f=u.querySelector(".slot_in_type_filter"),c=u.querySelector(".slot_out_type_filter");if(u.close=function(){r.search_box=null,this.blur(),o.focus(),h.body.style.overflow="",setTimeout(function(){r.canvas.focus()},20),u.parentNode&&u.parentNode.removeChild(u)},this.ds.scale>1&&(u.style.transform="scale("+this.ds.scale+")"),t.hide_on_mouse_leave){var _=!1,O=null;LiteGraph.pointerListenerAdd(u,"enter",function(ut){O&&(clearTimeout(O),O=null)}),LiteGraph.pointerListenerAdd(u,"leave",function(ut){_||(O=setTimeout(function(){u.close()},500))}),t.do_type_filter&&(f.addEventListener("click",function(ut){_++}),f.addEventListener("blur",function(ut){_=0}),f.addEventListener("change",function(ut){_=-1}),c.addEventListener("click",function(ut){_++}),c.addEventListener("blur",function(ut){_=0}),c.addEventListener("change",function(ut){_=-1}))}r.search_box&&r.search_box.close(),r.search_box=u;var d=u.querySelector(".helper"),b=null,S=null,G=null,z=u.querySelector("input");if(z&&(z.addEventListener("blur",function(ut){r.search_box&&this.focus()}),z.addEventListener("keydown",function(ut){if(ut.keyCode==38)R(!1);else if(ut.keyCode==40)R(!0);else if(ut.keyCode==27)u.close();else if(ut.keyCode==13)Y(),G?N(G.innerHTML):b?N(b):u.close();else{S&&clearInterval(S),S=setTimeout(Y,250);return}return ut.preventDefault(),ut.stopPropagation(),ut.stopImmediatePropagation(),!0})),t.do_type_filter){if(f){var $=LiteGraph.slot_types_in,A=$.length;(t.type_filter_in==LiteGraph.EVENT||t.type_filter_in==LiteGraph.ACTION)&&(t.type_filter_in="_event_");for(var l=0;l<A;l++){var I=document.createElement("option");I.value=$[l],I.innerHTML=$[l],f.appendChild(I),t.type_filter_in!==!1&&(t.type_filter_in+"").toLowerCase()==($[l]+"").toLowerCase()&&(I.selected=!0)}f.addEventListener("change",function(){Y()})}if(c){var $=LiteGraph.slot_types_out,A=$.length;(t.type_filter_out==LiteGraph.EVENT||t.type_filter_out==LiteGraph.ACTION)&&(t.type_filter_out="_event_");for(var l=0;l<A;l++){var I=document.createElement("option");I.value=$[l],I.innerHTML=$[l],c.appendChild(I),t.type_filter_out!==!1&&(t.type_filter_out+"").toLowerCase()==($[l]+"").toLowerCase()&&(I.selected=!0)}c.addEventListener("change",function(){Y()})}}var T=o.getBoundingClientRect(),L=(e?e.clientX:T.left+T.width*.5)-80,C=(e?e.clientY:T.top+T.height*.5)-20;u.style.left=L+"px",u.style.top=C+"px",e.layerY>T.height-200&&(d.style.maxHeight=T.height-e.layerY-20+"px"),z.focus(),t.show_all_on_open&&Y();function N(ut){if(ut)if(r.onSearchBoxSelection)r.onSearchBoxSelection(ut,e,s);else{var mt=LiteGraph.searchbox_extras[ut.toLowerCase()];mt&&(ut=mt.type),s.graph.beforeChange();var yt=LiteGraph.createNode(ut);if(yt&&(yt.pos=s.convertEventToCanvasOffset(e),s.graph.add(yt,!1)),mt&&mt.data){if(mt.data.properties)for(var D in mt.data.properties)yt.addProperty(D,mt.data.properties[D]);if(mt.data.inputs){yt.inputs=[];for(var D in mt.data.inputs)yt.addOutput(mt.data.inputs[D][0],mt.data.inputs[D][1])}if(mt.data.outputs){yt.outputs=[];for(var D in mt.data.outputs)yt.addOutput(mt.data.outputs[D][0],mt.data.outputs[D][1])}mt.data.title&&(yt.title=mt.data.title),mt.data.json&&yt.configure(mt.data.json)}if(t.node_from){var F=!1;switch(typeof t.slot_from){case"string":F=t.node_from.findOutputSlot(t.slot_from);break;case"object":t.slot_from.name?F=t.node_from.findOutputSlot(t.slot_from.name):F=-1,F==-1&&typeof t.slot_from.slot_index<"u"&&(F=t.slot_from.slot_index);break;case"number":F=t.slot_from;break;default:F=0}typeof t.node_from.outputs[F]<"u"&&F!==!1&&F>-1&&t.node_from.connectByType(F,yt,t.node_from.outputs[F].type)}if(t.node_to){var F=!1;switch(typeof t.slot_from){case"string":F=t.node_to.findInputSlot(t.slot_from);break;case"object":t.slot_from.name?F=t.node_to.findInputSlot(t.slot_from.name):F=-1,F==-1&&typeof t.slot_from.slot_index<"u"&&(F=t.slot_from.slot_index);break;case"number":F=t.slot_from;break;default:F=0}typeof t.node_to.inputs[F]<"u"&&F!==!1&&F>-1&&t.node_to.connectByTypeOutput(F,yt,t.node_to.inputs[F].type)}s.graph.afterChange()}u.close()}function R(ut){var mt=G;G&&G.classList.remove("selected"),G?(G=ut?G.nextSibling:G.previousSibling,G||(G=mt)):G=ut?d.childNodes[0]:d.childNodes[d.childNodes.length],G&&(G.classList.add("selected"),G.scrollIntoView({block:"end",behavior:"smooth"}))}function Y(){S=null;var ut=z.value;if(b=null,d.innerHTML="",!ut&&!t.show_all_if_empty)return;if(r.onSearchBox){var mt=r.onSearchBox(d,ut,s);if(mt)for(var yt=0;yt<mt.length;++yt)vt(mt[yt])}else{let kt=function(Yt,re){var re=re||{},m={skipFilter:!1,inTypeOverride:!1,outTypeOverride:!1},M=Object.assign(m,re),Z=LiteGraph.registered_node_types[Yt];if(F&&Z.filter!=F||(!t.show_all_if_empty||ut)&&Yt.toLowerCase().indexOf(ut)===-1)return!1;if(t.do_type_filter&&!M.skipFilter){var it=Yt,Tt=E.value;if(M.inTypeOverride!==!1&&(Tt=M.inTypeOverride),E&&Tt&&LiteGraph.registered_slot_in_types[Tt]&&LiteGraph.registered_slot_in_types[Tt].nodes){var gt=LiteGraph.registered_slot_in_types[Tt].nodes.includes(it);if(gt===!1)return!1}var Tt=Q.value;if(M.outTypeOverride!==!1&&(Tt=M.outTypeOverride),Q&&Tt&&LiteGraph.registered_slot_out_types[Tt]&&LiteGraph.registered_slot_out_types[Tt].nodes){var gt=LiteGraph.registered_slot_out_types[Tt].nodes.includes(it);if(gt===!1)return!1}}return!0};var D=0;ut=ut.toLowerCase();var F=s.filter||s.graph.filter;if(t.do_type_filter&&r.search_box)var E=r.search_box.querySelector(".slot_in_type_filter"),Q=r.search_box.querySelector(".slot_out_type_filter");else var E=!1,Q=!1;for(var yt in LiteGraph.searchbox_extras){var P=LiteGraph.searchbox_extras[yt];if(!((!t.show_all_if_empty||ut)&&P.desc.toLowerCase().indexOf(ut)===-1)){var H=LiteGraph.registered_node_types[P.type];if(!(H&&H.filter!=F)&&kt(P.type)&&(vt(P.desc,"searchbox_extra"),LGraphCanvas.search_limit!==-1&&D++>LGraphCanvas.search_limit))break}}var q=null;if(Array.prototype.filter)var st=Object.keys(LiteGraph.registered_node_types),q=st.filter(kt);else{q=[];for(var yt in LiteGraph.registered_node_types)kt(yt)&&q.push(yt)}for(var yt=0;yt<q.length&&(vt(q[yt]),!(LGraphCanvas.search_limit!==-1&&D++>LGraphCanvas.search_limit));yt++);if(t.show_general_after_typefiltered&&(E.value||Q.value)){filtered_extra=[];for(var yt in LiteGraph.registered_node_types)kt(yt,{inTypeOverride:E&&E.value?"*":!1,outTypeOverride:Q&&Q.value?"*":!1})&&filtered_extra.push(yt);for(var yt=0;yt<filtered_extra.length&&(vt(filtered_extra[yt],"generic_type"),!(LGraphCanvas.search_limit!==-1&&D++>LGraphCanvas.search_limit));yt++);}if((E.value||Q.value)&&d.childNodes.length==0&&t.show_general_if_none_on_typefilter){filtered_extra=[];for(var yt in LiteGraph.registered_node_types)kt(yt,{skipFilter:!0})&&filtered_extra.push(yt);for(var yt=0;yt<filtered_extra.length&&(vt(filtered_extra[yt],"not_in_filter"),!(LGraphCanvas.search_limit!==-1&&D++>LGraphCanvas.search_limit));yt++);}}function vt(kt,Yt){var te=document.createElement("div");b||(b=kt),te.innerText=kt,te.dataset.type=escape(kt),te.className="litegraph lite-search-item",Yt&&(te.className+=" "+Yt),te.addEventListener("click",function(re){N(unescape(this.dataset.type))}),d.appendChild(te)}}return u},LGraphCanvas.prototype.showEditPropertyValue=function(e,t,n){if(!e||e.properties[t]===void 0)return;n=n||{};var r=e.getPropertyInfo(t),s=r.type,o="";if(s=="string"||s=="number"||s=="array"||s=="object")o="<input autofocus type='text' class='value'/>";else if((s=="enum"||s=="combo")&&r.values){o="<select autofocus type='text' class='value'>";for(var h in r.values){var u=h;r.values.constructor===Array&&(u=r.values[h]),o+="<option value='"+u+"' "+(u==e.properties[t]?"selected":"")+">"+r.values[h]+"</option>"}o+="</select>"}else if(s=="boolean"||s=="toggle")o="<input autofocus type='checkbox' class='value' "+(e.properties[t]?"checked":"")+"/>";else{console.warn("unknown type: "+s);return}var f=this.createDialog("<span class='name'>"+(r.label?r.label:t)+"</span>"+o+"<button>OK</button>",n),c=!1;if((s=="enum"||s=="combo")&&r.values)c=f.querySelector("select"),c.addEventListener("change",function(b){f.modified(),d(b.target.value)});else if(s=="boolean"||s=="toggle")c=f.querySelector("input"),c&&c.addEventListener("click",function(b){f.modified(),d(!!c.checked)});else if(c=f.querySelector("input"),c){c.addEventListener("blur",function(S){this.focus()});var u=e.properties[t]!==void 0?e.properties[t]:"";s!=="string"&&(u=JSON.stringify(u)),c.value=u,c.addEventListener("keydown",function(S){if(S.keyCode==27)f.close();else if(S.keyCode==13)O();else if(S.keyCode!=13){f.modified();return}S.preventDefault(),S.stopPropagation()})}c&&c.focus();var _=f.querySelector("button");_.addEventListener("click",O);function O(){d(c.value)}function d(b){r&&r.values&&r.values.constructor===Object&&r.values[b]!=null&&(b=r.values[b]),typeof e.properties[t]=="number"&&(b=Number(b)),(s=="array"||s=="object")&&(b=JSON.parse(b)),e.properties[t]=b,e.graph&&e.graph._version++,e.onPropertyChanged&&e.onPropertyChanged(t,b),n.onclose&&n.onclose(),f.close(),e.setDirtyCanvas(!0,!0)}return f},LGraphCanvas.prototype.createDialog=function(e,t){var n={checkForInput:!1,closeOnLeave:!0,closeOnLeave_checkModified:!0};t=Object.assign(n,t||{});var r=document.createElement("div");r.className="graphdialog",r.innerHTML=e,r.is_modified=!1;var s=this.canvas.getBoundingClientRect(),o=-20,h=-20;if(s&&(o-=s.left,h-=s.top),t.position?(o+=t.position[0],h+=t.position[1]):t.event?(o+=t.event.clientX,h+=t.event.clientY):(o+=this.canvas.width*.5,h+=this.canvas.height*.5),r.style.left=o+"px",r.style.top=h+"px",this.canvas.parentNode.appendChild(r),t.checkForInput){var u=[],f=!1;(u=r.querySelectorAll("input"))&&u.forEach(function(d){d.addEventListener("keydown",function(b){if(r.modified(),b.keyCode==27)r.close();else if(b.keyCode!=13)return;b.preventDefault(),b.stopPropagation()}),f||d.focus()})}r.modified=function(){r.is_modified=!0},r.close=function(){r.parentNode&&r.parentNode.removeChild(r)};var c=null,_=!1;r.addEventListener("mouseleave",function(d){_||(t.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&!r.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(c=setTimeout(r.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),r.addEventListener("mouseenter",function(d){(t.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&c&&clearTimeout(c)});var O=r.querySelectorAll("select");return O&&O.forEach(function(d){d.addEventListener("click",function(b){_++}),d.addEventListener("blur",function(b){_=0}),d.addEventListener("change",function(b){_=-1})}),r},LGraphCanvas.prototype.createPanel=function(e,t){t=t||{};var n=t.window||window,r=document.createElement("div");if(r.className="litegraph dialog",r.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div style='display:none;' class='dialog-alt-content'></div><div class='dialog-footer'></div>",r.header=r.querySelector(".dialog-header"),t.width&&(r.style.width=t.width+(t.width.constructor===Number?"px":"")),t.height&&(r.style.height=t.height+(t.height.constructor===Number?"px":"")),t.closable){var s=document.createElement("span");s.innerHTML="&#10005;",s.classList.add("close"),s.addEventListener("click",function(){r.close()}),r.header.appendChild(s)}return r.title_element=r.querySelector(".dialog-title"),r.title_element.innerText=e,r.content=r.querySelector(".dialog-content"),r.alt_content=r.querySelector(".dialog-alt-content"),r.footer=r.querySelector(".dialog-footer"),r.close=function(){r.onClose&&typeof r.onClose=="function"&&r.onClose(),r.parentNode&&r.parentNode.removeChild(r),this.parentNode&&this.parentNode.removeChild(this)},r.toggleAltContent=function(o){if(typeof o<"u")var h=o?"block":"none",u=o?"none":"block";else var h=r.alt_content.style.display!="block"?"block":"none",u=r.alt_content.style.display!="block"?"none":"block";r.alt_content.style.display=h,r.content.style.display=u},r.toggleFooterVisibility=function(o){if(typeof o<"u")var h=o?"block":"none";else var h=r.footer.style.display!="block"?"block":"none";r.footer.style.display=h},r.clear=function(){this.content.innerHTML=""},r.addHTML=function(o,h,u){var f=document.createElement("div");return h&&(f.className=h),f.innerHTML=o,u?r.footer.appendChild(f):r.content.appendChild(f),f},r.addButton=function(o,h,u){var f=document.createElement("button");return f.innerText=o,f.options=u,f.classList.add("btn"),f.addEventListener("click",h),r.footer.appendChild(f),f},r.addSeparator=function(){var o=document.createElement("div");o.className="separator",r.content.appendChild(o)},r.addWidget=function(o,h,u,f,c){f=f||{};var _=String(u);o=o.toLowerCase(),o=="number"&&(_=u.toFixed(3));var O=document.createElement("div");O.className="property",O.innerHTML="<span class='property_name'></span><span class='property_value'></span>",O.querySelector(".property_name").innerText=f.label||h;var d=O.querySelector(".property_value");if(d.innerText=_,O.dataset.property=h,O.dataset.type=f.type||o,O.options=f,O.value=u,o=="code")O.addEventListener("click",function(S){r.inner_showCodePad(this.dataset.property)});else if(o=="boolean")O.classList.add("boolean"),u&&O.classList.add("bool-on"),O.addEventListener("click",function(){var S=this.dataset.property;this.value=!this.value,this.classList.toggle("bool-on"),this.querySelector(".property_value").innerText=this.value?"true":"false",b(S,this.value)});else if(o=="string"||o=="number")d.setAttribute("contenteditable",!0),d.addEventListener("keydown",function(S){S.code=="Enter"&&(o!="string"||!S.shiftKey)&&(S.preventDefault(),this.blur())}),d.addEventListener("blur",function(){var S=this.innerText,G=this.parentNode.dataset.property,z=this.parentNode.dataset.type;z=="number"&&(S=Number(S)),b(G,S)});else if(o=="enum"||o=="combo"){var _=LGraphCanvas.getPropertyPrintableValue(u,f.values);d.innerText=_,d.addEventListener("click",function(G){var z=f.values||[],$=this.parentNode.dataset.property,A=this;new LiteGraph.ContextMenu(z,{event:G,className:"dark",callback:l},n);function l(I,T,L){return A.innerText=I,b($,I),!1}})}r.content.appendChild(O);function b(S,G){f.callback&&f.callback(S,G,f),c&&c(S,G,f)}return O},r.onOpen&&typeof r.onOpen=="function"&&r.onOpen(),r},LGraphCanvas.getPropertyPrintableValue=function(e,t){if(!t||t.constructor===Array)return String(e);if(t.constructor===Object){var n="";for(var r in t)if(t[r]==e){n=r;break}return String(e)+" ("+n+")"}},LGraphCanvas.prototype.closePanels=function(){var e=document.querySelector("#node-panel");e&&e.close();var e=document.querySelector("#option-panel");e&&e.close()},LGraphCanvas.prototype.showShowGraphOptionsPanel=function(e,t,n,r){if(this.constructor&&this.constructor.name=="HTMLDivElement"){if(!t||!t.event||!t.event.target||!t.event.target.lgraphcanvas){console.warn("Canvas not found");return}var s=t.event.target.lgraphcanvas}else var s=this;s.closePanels();var o=s.getCanvasWindow();panel=s.createPanel("Options",{closable:!0,window:o,onOpen:function(){s.OPTIONPANEL_IS_OPEN=!0},onClose:function(){s.OPTIONPANEL_IS_OPEN=!1,s.options_panel=null}}),s.options_panel=panel,panel.id="option-panel",panel.classList.add("settings");function h(){panel.content.innerHTML="";var u=function(O,d,b){switch(O){default:b&&b.key&&(O=b.key),b.values&&(d=Object.values(b.values).indexOf(d)),s[O]=d;break}},f=LiteGraph.availableCanvasOptions;f.sort();for(var c in f){var _=f[c];panel.addWidget("boolean",_,s[_],{key:_,on:"True",off:"False"},u)}s.links_render_mode,panel.addWidget("combo","Render mode",LiteGraph.LINK_RENDER_MODES[s.links_render_mode],{key:"links_render_mode",values:LiteGraph.LINK_RENDER_MODES},u),panel.addSeparator(),panel.footer.innerHTML=""}h(),s.canvas.parentNode.appendChild(panel)},LGraphCanvas.prototype.showShowNodePanel=function(e){this.SELECTED_NODE=e,this.closePanels();var t=this.getCanvasWindow(),n=this,r=this.createPanel(e.title||"",{closable:!0,window:t,onOpen:function(){n.NODEPANEL_IS_OPEN=!0},onClose:function(){n.NODEPANEL_IS_OPEN=!1,n.node_panel=null}});n.node_panel=r,r.id="node-panel",r.node=e,r.classList.add("settings");function s(){r.content.innerHTML="",r.addHTML("<span class='node_type'>"+e.type+"</span><span class='node_desc'>"+(e.constructor.desc||"")+"</span><span class='separator'></span>"),r.addHTML("<h3>Properties</h3>");var o=function(_,O){switch(n.graph.beforeChange(e),_){case"Title":e.title=O;break;case"Mode":var d=Object.values(LiteGraph.NODE_MODES).indexOf(O);d>=0&&LiteGraph.NODE_MODES[d]?e.changeMode(d):console.warn("unexpected mode: "+O);break;case"Color":LGraphCanvas.node_colors[O]?(e.color=LGraphCanvas.node_colors[O].color,e.bgcolor=LGraphCanvas.node_colors[O].bgcolor):console.warn("unexpected color: "+O);break;default:e.setProperty(_,O);break}n.graph.afterChange(),n.dirty_canvas=!0};r.addWidget("string","Title",e.title,{},o),r.addWidget("combo","Mode",LiteGraph.NODE_MODES[e.mode],{values:LiteGraph.NODE_MODES},o);var h="";e.color!==void 0&&(h=Object.keys(LGraphCanvas.node_colors).filter(function(_){return LGraphCanvas.node_colors[_].color==e.color})),r.addWidget("combo","Color",h,{values:Object.keys(LGraphCanvas.node_colors)},o);for(var u in e.properties){var f=e.properties[u],c=e.getPropertyInfo(u);c.type,!(e.onAddPropertyToPanel&&e.onAddPropertyToPanel(u,r))&&r.addWidget(c.widget||c.type,u,f,c,o)}r.addSeparator(),e.onShowCustomPanelInfo&&e.onShowCustomPanelInfo(r),r.footer.innerHTML="",r.addButton("Delete",function(){e.block_delete||(e.graph.remove(e),r.close())}).classList.add("delete")}r.inner_showCodePad=function(o){r.classList.remove("settings"),r.classList.add("centered"),r.alt_content.innerHTML="<textarea class='code'></textarea>";var h=r.alt_content.querySelector("textarea"),u=function(){r.toggleAltContent(!1),r.toggleFooterVisibility(!0),h.parentNode.removeChild(h),r.classList.add("settings"),r.classList.remove("centered"),s()};h.value=e.properties[o],h.addEventListener("keydown",function(_){_.code=="Enter"&&_.ctrlKey&&(e.setProperty(o,h.value),u())}),r.toggleAltContent(!0),r.toggleFooterVisibility(!1),h.style.height="calc(100% - 40px)";var f=r.addButton("Assign",function(){e.setProperty(o,h.value),u()});r.alt_content.appendChild(f);var c=r.addButton("Close",u);c.style.float="right",r.alt_content.appendChild(c)},s(),this.canvas.parentNode.appendChild(r)},LGraphCanvas.prototype.showSubgraphPropertiesDialog=function(e){console.log("showing subgraph properties dialog");var t=this.canvas.parentNode.querySelector(".subgraph_dialog");t&&t.close();var n=this.createPanel("Subgraph Inputs",{closable:!0,width:500});n.node=e,n.classList.add("subgraph_dialog");function r(){if(n.clear(),e.inputs)for(var h=0;h<e.inputs.length;++h){var u=e.inputs[h];if(!u.not_subgraph_input){var f="<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>",c=n.addHTML(f,"subgraph_property");c.dataset.name=u.name,c.dataset.slot=h,c.querySelector(".name").innerText=u.name,c.querySelector(".type").innerText=u.type,c.querySelector("button").addEventListener("click",function(_){e.removeInput(Number(this.parentNode.dataset.slot)),r()})}}}var s=" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>",o=n.addHTML(s,"subgraph_property extra",!0);return o.querySelector("button").addEventListener("click",function(h){var u=this.parentNode,f=u.querySelector(".name").value,c=u.querySelector(".type").value;!f||e.findInputSlot(f)!=-1||(e.addInput(f,c),u.querySelector(".name").value="",u.querySelector(".type").value="",r())}),r(),this.canvas.parentNode.appendChild(n),n},LGraphCanvas.prototype.showSubgraphPropertiesDialogRight=function(e){var t=this.canvas.parentNode.querySelector(".subgraph_dialog");t&&t.close();var n=this.createPanel("Subgraph Outputs",{closable:!0,width:500});n.node=e,n.classList.add("subgraph_dialog");function r(){if(n.clear(),e.outputs)for(var u=0;u<e.outputs.length;++u){var f=e.outputs[u];if(!f.not_subgraph_output){var c="<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>",_=n.addHTML(c,"subgraph_property");_.dataset.name=f.name,_.dataset.slot=u,_.querySelector(".name").innerText=f.name,_.querySelector(".type").innerText=f.type,_.querySelector("button").addEventListener("click",function(O){e.removeOutput(Number(this.parentNode.dataset.slot)),r()})}}}var s=" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>",o=n.addHTML(s,"subgraph_property extra",!0);o.querySelector(".name").addEventListener("keydown",function(u){u.keyCode==13&&h.apply(this)}),o.querySelector("button").addEventListener("click",function(u){h.apply(this)});function h(){var u=this.parentNode,f=u.querySelector(".name").value,c=u.querySelector(".type").value;!f||e.findOutputSlot(f)!=-1||(e.addOutput(f,c),u.querySelector(".name").value="",u.querySelector(".type").value="",r())}return r(),this.canvas.parentNode.appendChild(n),n},LGraphCanvas.prototype.checkPanels=function(){if(this.canvas)for(var e=this.canvas.parentNode.querySelectorAll(".litegraph.dialog"),t=0;t<e.length;++t){var n=e[t];n.node&&(!n.node.graph||n.graph!=this.graph)&&n.close()}},LGraphCanvas.onMenuNodeCollapse=function(e,t,n,r,s){s.graph.beforeChange();var o=function(f){f.collapse()},h=LGraphCanvas.active_canvas;if(!h.selected_nodes||Object.keys(h.selected_nodes).length<=1)o(s);else for(var u in h.selected_nodes)o(h.selected_nodes[u]);s.graph.afterChange()},LGraphCanvas.onMenuNodePin=function(e,t,n,r,s){s.pin()},LGraphCanvas.onMenuNodeMode=function(e,t,n,r,s){new LiteGraph.ContextMenu(LiteGraph.NODE_MODES,{event:n,callback:o,parentMenu:r,node:s});function o(h){if(s){var u=Object.values(LiteGraph.NODE_MODES).indexOf(h),f=function(O){u>=0&&LiteGraph.NODE_MODES[u]?O.changeMode(u):(console.warn("unexpected mode: "+h),O.changeMode(LiteGraph.ALWAYS))},c=LGraphCanvas.active_canvas;if(!c.selected_nodes||Object.keys(c.selected_nodes).length<=1)f(s);else for(var _ in c.selected_nodes)f(c.selected_nodes[_])}}return!1},LGraphCanvas.onMenuNodeColors=function(e,t,n,r,s){if(!s)throw"no node for color";var o=[];o.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"});for(var h in LGraphCanvas.node_colors){var u=LGraphCanvas.node_colors[h],e={value:h,content:"<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid "+u.color+"; background-color:"+u.bgcolor+"'>"+h+"</span>"};o.push(e)}new LiteGraph.ContextMenu(o,{event:n,callback:f,parentMenu:r,node:s});function f(c){if(s){var _=c.value?LGraphCanvas.node_colors[c.value]:null,O=function(S){_?S.constructor===LiteGraph.LGraphGroup?S.color=_.groupcolor:(S.color=_.color,S.bgcolor=_.bgcolor):(delete S.color,delete S.bgcolor)},d=LGraphCanvas.active_canvas;if(!d.selected_nodes||Object.keys(d.selected_nodes).length<=1)O(s);else for(var b in d.selected_nodes)O(d.selected_nodes[b]);s.setDirtyCanvas(!0,!0)}}return!1},LGraphCanvas.onMenuNodeShapes=function(e,t,n,r,s){if(!s)throw"no node passed";new LiteGraph.ContextMenu(LiteGraph.VALID_SHAPES,{event:n,callback:o,parentMenu:r,node:s});function o(h){if(s){s.graph.beforeChange();var u=function(_){_.shape=h},f=LGraphCanvas.active_canvas;if(!f.selected_nodes||Object.keys(f.selected_nodes).length<=1)u(s);else for(var c in f.selected_nodes)u(f.selected_nodes[c]);s.graph.afterChange(),s.setDirtyCanvas(!0)}}return!1},LGraphCanvas.onMenuNodeRemove=function(e,t,n,r,s){if(!s)throw"no node passed";var o=s.graph;o.beforeChange();var h=function(c){c.removable!==!1&&o.remove(c)},u=LGraphCanvas.active_canvas;if(!u.selected_nodes||Object.keys(u.selected_nodes).length<=1)h(s);else for(var f in u.selected_nodes)h(u.selected_nodes[f]);o.afterChange(),s.setDirtyCanvas(!0,!0)},LGraphCanvas.onMenuNodeToSubgraph=function(e,t,n,r,s){var o=s.graph,h=LGraphCanvas.active_canvas;if(h){var u=Object.values(h.selected_nodes||{});u.length||(u=[s]);var f=LiteGraph.createNode("graph/subgraph");f.pos=s.pos.concat(),o.add(f),f.buildFromNodes(u),h.deselectAllNodes(),s.setDirtyCanvas(!0,!0)}},LGraphCanvas.onMenuNodeClone=function(e,t,n,r,s){s.graph.beforeChange();var o={},h=function(c){if(c.clonable!==!1){var _=c.clone();_&&(_.pos=[c.pos[0]+5,c.pos[1]+5],c.graph.add(_),o[_.id]=_)}},u=LGraphCanvas.active_canvas;if(!u.selected_nodes||Object.keys(u.selected_nodes).length<=1)h(s);else for(var f in u.selected_nodes)h(u.selected_nodes[f]);Object.keys(o).length&&u.selectNodes(o),s.graph.afterChange(),s.setDirtyCanvas(!0,!0)},LGraphCanvas.node_colors={red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}},LGraphCanvas.prototype.getCanvasMenuOptions=function(){var e=null;if(this.getMenuOptions?e=this.getMenuOptions():(e=[{content:"Add Node",has_submenu:!0,callback:LGraphCanvas.onMenuAdd},{content:"Add Group",callback:LGraphCanvas.onGroupAdd}],Object.keys(this.selected_nodes).length>1&&e.push({content:"Align",has_submenu:!0,callback:LGraphCanvas.onGroupAlign}),this._graph_stack&&this._graph_stack.length>0&&e.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),this.getExtraMenuOptions){var t=this.getExtraMenuOptions(this,e);t&&(e=e.concat(t))}return e},LGraphCanvas.prototype.getNodeMenuOptions=function(e){var t=null;if(e.getMenuOptions?t=e.getMenuOptions(this):(t=[{content:"Inputs",has_submenu:!0,disabled:!0,callback:LGraphCanvas.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:LGraphCanvas.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:LGraphCanvas.onShowMenuNodeProperties},null,{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:LGraphCanvas.onMenuNodeMode}],e.resizable!==!1&&t.push({content:"Resize",callback:LGraphCanvas.onMenuResizeNode}),t.push({content:"Collapse",callback:LGraphCanvas.onMenuNodeCollapse},{content:"Pin",callback:LGraphCanvas.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:LGraphCanvas.onMenuNodeShapes},null)),e.onGetInputs){var n=e.onGetInputs();n&&n.length&&(t[0].disabled=!1)}if(e.onGetOutputs){var r=e.onGetOutputs();r&&r.length&&(t[1].disabled=!1)}if(e.getExtraMenuOptions){var s=e.getExtraMenuOptions(this,t);s&&(s.push(null),t=s.concat(t))}return e.clonable!==!1&&t.push({content:"Clone",callback:LGraphCanvas.onMenuNodeClone}),Object.keys(this.selected_nodes).length>1&&t.push({content:"Align Selected To",has_submenu:!0,callback:LGraphCanvas.onNodeAlign}),t.push(null,{content:"Remove",disabled:!(e.removable!==!1&&!e.block_delete),callback:LGraphCanvas.onMenuNodeRemove}),e.graph&&e.graph.onGetNodeMenuOptions&&e.graph.onGetNodeMenuOptions(t,e),t},LGraphCanvas.prototype.getGroupMenuOptions=function(e){var t=[{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:LGraphCanvas.onShowPropertyEditor},null,{content:"Remove",callback:LGraphCanvas.onMenuNodeRemove}];return t},LGraphCanvas.prototype.processContextMenu=function(e,t){var n=this,r=LGraphCanvas.active_canvas,s=r.getCanvasWindow(),o=null,h={event:t,callback:_,extra:e};e&&(h.title=e.type);var u=null;if(e&&(u=e.getSlotInPosition(t.canvasX,t.canvasY),LGraphCanvas.active_node=e),u){if(o=[],e.getSlotMenuOptions)o=e.getSlotMenuOptions(u);else{u&&u.output&&u.output.links&&u.output.links.length&&o.push({content:"Disconnect Links",slot:u});var f=u.input||u.output;f.removable&&o.push(f.locked?"Cannot remove":{content:"Remove Slot",slot:u}),f.nameLocked||o.push({content:"Rename Slot",slot:u})}h.title=(u.input?u.input.type:u.output.type)||"*",u.input&&u.input.type==LiteGraph.ACTION&&(h.title="Action"),u.output&&u.output.type==LiteGraph.EVENT&&(h.title="Event")}else if(e)o=this.getNodeMenuOptions(e);else{o=this.getCanvasMenuOptions();var c=this.graph.getGroupOnPos(t.canvasX,t.canvasY);c&&o.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:c,options:this.getGroupMenuOptions(c)}})}if(!o)return;new LiteGraph.ContextMenu(o,h,s);function _(O,d,b){if(O){if(O.content=="Remove Slot"){var S=O.slot;e.graph.beforeChange(),S.input?e.removeInput(S.slot):S.output&&e.removeOutput(S.slot),e.graph.afterChange();return}else if(O.content=="Disconnect Links"){var S=O.slot;e.graph.beforeChange(),S.output?e.disconnectOutput(S.slot):S.input&&e.disconnectInput(S.slot),e.graph.afterChange();return}else if(O.content=="Rename Slot"){var S=O.slot,G=S.input?e.getInputInfo(S.slot):e.getOutputInfo(S.slot),z=n.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",d),$=z.querySelector("input");$&&G&&($.value=G.label||"");var A=function(){e.graph.beforeChange(),$.value&&(G&&(G.label=$.value),n.setDirty(!0)),z.close(),e.graph.afterChange()};z.querySelector("button").addEventListener("click",A),$.addEventListener("keydown",function(I){if(z.is_modified=!0,I.keyCode==27)z.close();else if(I.keyCode==13)A();else if(I.keyCode!=13&&I.target.localName!="textarea")return;I.preventDefault(),I.stopPropagation()}),$.focus()}}}};function compareObjects(e,t){for(var n in e)if(e[n]!=t[n])return!1;return!0}LiteGraph.compareObjects=compareObjects;function distance(e,t){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1]))}LiteGraph.distance=distance;function colorToString(e){return"rgba("+Math.round(e[0]*255).toFixed()+","+Math.round(e[1]*255).toFixed()+","+Math.round(e[2]*255).toFixed()+","+(e.length==4?e[3].toFixed(2):"1.0")+")"}LiteGraph.colorToString=colorToString;function isInsideRectangle(e,t,n,r,s,o){return n<e&&n+s>e&&r<t&&r+o>t}LiteGraph.isInsideRectangle=isInsideRectangle;function growBounding(e,t,n){t<e[0]?e[0]=t:t>e[2]&&(e[2]=t),n<e[1]?e[1]=n:n>e[3]&&(e[3]=n)}LiteGraph.growBounding=growBounding;function isInsideBounding(e,t){return!(e[0]<t[0][0]||e[1]<t[0][1]||e[0]>t[1][0]||e[1]>t[1][1])}LiteGraph.isInsideBounding=isInsideBounding;function overlapBounding(e,t){var n=e[0]+e[2],r=e[1]+e[3],s=t[0]+t[2],o=t[1]+t[3];return!(e[0]>s||e[1]>o||n<t[0]||r<t[1])}LiteGraph.overlapBounding=overlapBounding;function hex2num(e){e.charAt(0)=="#"&&(e=e.slice(1)),e=e.toUpperCase();for(var t="0123456789ABCDEF",n=new Array(3),r=0,s,o,h=0;h<6;h+=2)s=t.indexOf(e.charAt(h)),o=t.indexOf(e.charAt(h+1)),n[r]=s*16+o,r++;return n}LiteGraph.hex2num=hex2num;function num2hex(e){for(var t="0123456789ABCDEF",n="#",r,s,o=0;o<3;o++)r=e[o]/16,s=e[o]%16,n+=t.charAt(r)+t.charAt(s);return n}LiteGraph.num2hex=num2hex;function ContextMenu(e,t){t=t||{},this.options=t;var n=this;t.parentMenu&&(t.parentMenu.constructor!==this.constructor?(console.error("parentMenu must be of class ContextMenu, ignoring it"),t.parentMenu=null):(this.parentMenu=t.parentMenu,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this));var r=null;t.event&&(r=t.event.constructor.name),r!=="MouseEvent"&&r!=="CustomEvent"&&r!=="PointerEvent"&&(console.error("Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it. ("+r+")"),t.event=null);var s=document.createElement("div");s.className="litegraph litecontextmenu litemenubar-panel",t.className&&(s.className+=" "+t.className),s.style.minWidth=100,s.style.minHeight=100,s.style.pointerEvents="none",setTimeout(function(){s.style.pointerEvents="auto"},100),LiteGraph.pointerListenerAdd(s,"up",function(z){return z.preventDefault(),!0},!0),s.addEventListener("contextmenu",function(z){return z.button!=2||z.preventDefault(),!1},!0),LiteGraph.pointerListenerAdd(s,"down",function(z){if(z.button==2)return n.close(),z.preventDefault(),!0},!0);function o(z){var $=parseInt(s.style.top);return s.style.top=($+z.deltaY*t.scroll_speed).toFixed()+"px",z.preventDefault(),!0}if(t.scroll_speed||(t.scroll_speed=.1),s.addEventListener("wheel",o,!0),s.addEventListener("mousewheel",o,!0),this.root=s,t.title){var h=document.createElement("div");h.className="litemenu-title",h.innerHTML=t.title,s.appendChild(h)}for(var u=0;u<e.length;u++){var f=e.constructor==Array?e[u]:u;f!=null&&f.constructor!==String&&(f=f.content===void 0?String(f):f.content);var c=e[u];this.addItem(f,c,t)}LiteGraph.pointerListenerAdd(s,"enter",function(z){s.closing_timer&&clearTimeout(s.closing_timer)});var _=document;t.event&&(_=t.event.target.ownerDocument),_||(_=document),_.fullscreenElement?_.fullscreenElement.appendChild(s):_.body.appendChild(s);var O=t.left||0,d=t.top||0;if(t.event){if(O=t.event.clientX-10,d=t.event.clientY-10,t.title&&(d-=20),t.parentMenu){var b=t.parentMenu.root.getBoundingClientRect();O=b.left+b.width}var S=document.body.getBoundingClientRect(),G=s.getBoundingClientRect();S.height==0&&console.error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),S.width&&O>S.width-G.width-10&&(O=S.width-G.width-10),S.height&&d>S.height-G.height-10&&(d=S.height-G.height-10)}s.style.left=O+"px",s.style.top=d+"px",t.scale&&(s.style.transform="scale("+t.scale+")")}ContextMenu.prototype.addItem=function(e,t,n){var r=this;n=n||{};var s=document.createElement("div");s.className="litemenu-entry submenu";var o=!1;t===null?s.classList.add("separator"):(s.innerHTML=t&&t.title?t.title:e,s.value=t,t&&(t.disabled&&(o=!0,s.classList.add("disabled")),(t.submenu||t.has_submenu)&&s.classList.add("has_submenu")),typeof t=="function"?(s.dataset.value=e,s.onclick_callback=t):s.dataset.value=t,t.className&&(s.className+=" "+t.className)),this.root.appendChild(s),o||s.addEventListener("click",u),!o&&n.autoopen&&LiteGraph.pointerListenerAdd(s,"enter",h);function h(f){var c=this.value;!c||!c.has_submenu||u.call(this,f)}function u(f){var c=this.value,_=!0;if(r.current_submenu&&r.current_submenu.close(f),n.callback){var O=n.callback.call(this,c,n,f,r,n.node);O===!0&&(_=!1)}if(c){if(c.callback&&!n.ignore_item_callbacks&&c.disabled!==!0){var O=c.callback.call(this,c,n,f,r,n.extra);O===!0&&(_=!1)}if(c.submenu){if(!c.submenu.options)throw"ContextMenu submenu needs options";new r.constructor(c.submenu.options,{callback:c.submenu.callback,event:f,parentMenu:r,ignore_item_callbacks:c.submenu.ignore_item_callbacks,title:c.submenu.title,extra:c.submenu.extra,autoopen:n.autoopen}),_=!1}}_&&!r.lock&&r.close()}return s},ContextMenu.prototype.close=function(e,t){this.root.parentNode&&this.root.parentNode.removeChild(this.root),this.parentMenu&&!t&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,e===void 0?this.parentMenu.close():e&&!ContextMenu.isCursorOverElement(e,this.parentMenu.root)&&ContextMenu.trigger(this.parentMenu.root,LiteGraph.pointerevents_method+"leave",e)),this.current_submenu&&this.current_submenu.close(e,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer)},ContextMenu.trigger=function(e,t,n,r){var s=document.createEvent("CustomEvent");return s.initCustomEvent(t,!0,!0,n),s.srcElement=r,e.dispatchEvent?e.dispatchEvent(s):e.__events&&e.__events.dispatchEvent(s),s},ContextMenu.prototype.getTopMenu=function(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this},ContextMenu.prototype.getFirstEvent=function(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event},ContextMenu.isCursorOverElement=function(e,t){var n=e.clientX,r=e.clientY,s=t.getBoundingClientRect();return s?r>s.top&&r<s.top+s.height&&n>s.left&&n<s.left+s.width:!1},LiteGraph.ContextMenu=ContextMenu,LiteGraph.closeAllContextMenus=function(e){e=e||window;var t=e.document.querySelectorAll(".litecontextmenu");if(t.length){for(var n=[],r=0;r<t.length;r++)n.push(t[r]);for(var r=0;r<n.length;r++)n[r].close?n[r].close():n[r].parentNode&&n[r].parentNode.removeChild(n[r])}},LiteGraph.extendClass=function(e,t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n]);if(t.prototype)for(var n in t.prototype)t.prototype.hasOwnProperty(n)&&(e.prototype.hasOwnProperty(n)||(t.prototype.__lookupGetter__(n)?e.prototype.__defineGetter__(n,t.prototype.__lookupGetter__(n)):e.prototype[n]=t.prototype[n],t.prototype.__lookupSetter__(n)&&e.prototype.__defineSetter__(n,t.prototype.__lookupSetter__(n))))};function CurveEditor(e){this.points=e,this.selected=-1,this.nearest=-1,this.size=null,this.must_update=!0,this.margin=5}CurveEditor.sampleCurve=function(e,t){if(t){for(var n=0;n<t.length-1;++n){var r=t[n],s=t[n+1];if(!(s[0]<e)){var o=s[0]-r[0];if(Math.abs(o)<1e-5)return r[1];var h=(e-r[0])/o;return r[1]*(1-h)+s[1]*h}}return 0}},CurveEditor.prototype.draw=function(e,t,n,r,s,o){var h=this.points;if(h){this.size=t;var u=t[0]-this.margin*2,f=t[1]-this.margin*2;s=s||"#666",e.save(),e.translate(this.margin,this.margin),r&&(e.fillStyle="#111",e.fillRect(0,0,u,f),e.fillStyle="#222",e.fillRect(u*.5,0,1,f),e.strokeStyle="#333",e.strokeRect(0,0,u,f)),e.strokeStyle=s,o&&(e.globalAlpha=.5),e.beginPath();for(var c=0;c<h.length;++c){var _=h[c];e.lineTo(_[0]*u,(1-_[1])*f)}if(e.stroke(),e.globalAlpha=1,!o)for(var c=0;c<h.length;++c){var _=h[c];e.fillStyle=this.selected==c?"#FFF":this.nearest==c?"#DDD":"#AAA",e.beginPath(),e.arc(_[0]*u,(1-_[1])*f,2,0,Math.PI*2),e.fill()}e.restore()}},CurveEditor.prototype.onMouseDown=function(e,t){var n=this.points;if(n&&!(e[1]<0)){var r=this.size[0]-this.margin*2,s=this.size[1]-this.margin*2,o=e[0]-this.margin,h=e[1]-this.margin,u=[o,h],f=30/t.ds.scale;if(this.selected=this.getCloserPoint(u,f),this.selected==-1){var c=[o/r,1-h/s];n.push(c),n.sort(function(_,O){return _[0]-O[0]}),this.selected=n.indexOf(c),this.must_update=!0}if(this.selected!=-1)return!0}},CurveEditor.prototype.onMouseMove=function(e,t){var n=this.points;if(n){var r=this.selected;if(!(r<0)){var s=(e[0]-this.margin)/(this.size[0]-this.margin*2),o=(e[1]-this.margin)/(this.size[1]-this.margin*2),h=[e[0]-this.margin,e[1]-this.margin],u=30/t.ds.scale;this._nearest=this.getCloserPoint(h,u);var f=n[r];if(f){var c=r==0||r==n.length-1;if(!c&&(e[0]<-10||e[0]>this.size[0]+10||e[1]<-10||e[1]>this.size[1]+10)){n.splice(r,1),this.selected=-1;return}c?f[0]=r==0?0:1:f[0]=clamp(s,0,1),f[1]=1-clamp(o,0,1),n.sort(function(_,O){return _[0]-O[0]}),this.selected=n.indexOf(f),this.must_update=!0}}}},CurveEditor.prototype.onMouseUp=function(e,t){return this.selected=-1,!1},CurveEditor.prototype.getCloserPoint=function(e,t){var n=this.points;if(!n)return-1;t=t||30;for(var r=this.size[0]-this.margin*2,s=this.size[1]-this.margin*2,o=n.length,h=[0,0],u=1e6,f=-1,c=0;c<o;++c){var _=n[c];h[0]=_[0]*r,h[1]=(1-_[1])*s,h[0]<e[0];var O=vec2.distance(e,h);O>u||O>t||(f=c,u=O)}return f},LiteGraph.CurveEditor=CurveEditor,LiteGraph.getParameterNames=function(e){return(e+"").replace(/[/][/].*$/gm,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)},LiteGraph.pointerListenerAdd=function(e,t,n,r=!1){if(!(!e||!e.addEventListener||!t||typeof n!="function")){var s=LiteGraph.pointerevents_method,o=t;if(s=="pointer"&&!window.PointerEvent)switch(console.warn("sMethod=='pointer' && !window.PointerEvent"),console.log("Converting pointer["+o+"] : down move up cancel enter TO touchstart touchmove touchend, etc .."),o){case"down":{s="touch",o="start";break}case"move":{s="touch";break}case"up":{s="touch",o="end";break}case"cancel":{s="touch";break}case"enter":{console.log("debug: Should I send a move event?");break}default:console.warn("PointerEvent not available in this browser ? The event "+o+" would not be called")}switch(o){case"down":case"up":case"move":case"over":case"out":case"enter":e.addEventListener(s+o,n,r);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if(s!="mouse")return e.addEventListener(s+o,n,r);default:return e.addEventListener(o,n,r)}}},LiteGraph.pointerListenerRemove=function(e,t,n,r=!1){if(!(!e||!e.removeEventListener||!t||typeof n!="function"))switch(t){case"down":case"up":case"move":case"over":case"out":case"enter":(LiteGraph.pointerevents_method=="pointer"||LiteGraph.pointerevents_method=="mouse")&&e.removeEventListener(LiteGraph.pointerevents_method+t,n,r);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if(LiteGraph.pointerevents_method=="pointer")return e.removeEventListener(LiteGraph.pointerevents_method+t,n,r);default:return e.removeEventListener(t,n,r)}};function clamp(e,t,n){return t>e?t:n<e?n:e}global.clamp=clamp,typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)})})(commonjsGlobal),exports.LiteGraph=commonjsGlobal.LiteGraph,exports.LGraph=commonjsGlobal.LGraph,exports.LLink=commonjsGlobal.LLink,exports.LGraphNode=commonjsGlobal.LGraphNode,exports.LGraphGroup=commonjsGlobal.LGraphGroup,exports.DragAndScale=commonjsGlobal.DragAndScale,exports.LGraphCanvas=commonjsGlobal.LGraphCanvas,exports.ContextMenu=commonjsGlobal.ContextMenu,function(e){var t=e.LiteGraph;function n(){this.addOutput("in ms","number"),this.addOutput("in sec","number")}n.title="Time",n.desc="Time",n.prototype.onExecute=function(){this.setOutputData(0,this.graph.globaltime*1e3),this.setOutputData(1,this.graph.globaltime)},t.registerNodeType("basic/time",n);function r(){this.size=[140,80],this.properties={enabled:!0},this.enabled=!0,this.subgraph=new t.LGraph,this.subgraph._subgraph_node=this,this.subgraph._is_subgraph=!0,this.subgraph.onTrigger=this.onSubgraphTrigger.bind(this),this.subgraph.onInputAdded=this.onSubgraphNewInput.bind(this),this.subgraph.onInputRenamed=this.onSubgraphRenamedInput.bind(this),this.subgraph.onInputTypeChanged=this.onSubgraphTypeChangeInput.bind(this),this.subgraph.onInputRemoved=this.onSubgraphRemovedInput.bind(this),this.subgraph.onOutputAdded=this.onSubgraphNewOutput.bind(this),this.subgraph.onOutputRenamed=this.onSubgraphRenamedOutput.bind(this),this.subgraph.onOutputTypeChanged=this.onSubgraphTypeChangeOutput.bind(this),this.subgraph.onOutputRemoved=this.onSubgraphRemovedOutput.bind(this)}r.title="Subgraph",r.desc="Graph inside a node",r.title_color="#334",r.prototype.onGetInputs=function(){return[["enabled","boolean"]]},r.prototype.onDblClick=function(D,F,E){var Q=this;setTimeout(function(){E.openSubgraph(Q.subgraph)},10)},r.prototype.onAction=function(D,F){this.subgraph.onAction(D,F)},r.prototype.onExecute=function(){if(this.enabled=this.getInputOrProperty("enabled"),!!this.enabled){if(this.inputs)for(var D=0;D<this.inputs.length;D++){var F=this.inputs[D],E=this.getInputData(D);this.subgraph.setInputData(F.name,E)}if(this.subgraph.runStep(),this.outputs)for(var D=0;D<this.outputs.length;D++){var Q=this.outputs[D],E=this.subgraph.getOutputData(Q.name);this.setOutputData(D,E)}}},r.prototype.sendEventToAllNodes=function(D,F,E){this.enabled&&this.subgraph.sendEventToAllNodes(D,F,E)},r.prototype.onDrawBackground=function(D,F,E,Q){if(this.flags.collapsed)return;var P=this.size[1]-t.NODE_TITLE_HEIGHT+.5,H=t.isInsideRectangle(Q[0],Q[1],this.pos[0],this.pos[1]+P,this.size[0],t.NODE_TITLE_HEIGHT);let q=t.isInsideRectangle(Q[0],Q[1],this.pos[0],this.pos[1]+P,this.size[0]/2,t.NODE_TITLE_HEIGHT);D.fillStyle=H?"#555":"#222",D.beginPath(),this._shape==t.BOX_SHAPE?q?D.rect(0,P,this.size[0]/2+1,t.NODE_TITLE_HEIGHT):D.rect(this.size[0]/2,P,this.size[0]/2+1,t.NODE_TITLE_HEIGHT):q?D.roundRect(0,P,this.size[0]/2+1,t.NODE_TITLE_HEIGHT,[0,0,8,8]):D.roundRect(this.size[0]/2,P,this.size[0]/2+1,t.NODE_TITLE_HEIGHT,[0,0,8,8]),H?D.fill():D.fillRect(0,P,this.size[0]+1,t.NODE_TITLE_HEIGHT),D.textAlign="center",D.font="24px Arial",D.fillStyle=H?"#DDD":"#999",D.fillText("+",this.size[0]*.25,P+24),D.fillText("+",this.size[0]*.75,P+24)},r.prototype.onMouseDown=function(D,F,E){var Q=this.size[1]-t.NODE_TITLE_HEIGHT+.5;console.log(0),F[1]>Q&&(F[0]<this.size[0]/2?(console.log(1),E.showSubgraphPropertiesDialog(this)):(console.log(2),E.showSubgraphPropertiesDialogRight(this)))},r.prototype.computeSize=function(){var D=this.inputs?this.inputs.length:0,F=this.outputs?this.outputs.length:0;return[200,Math.max(D,F)*t.NODE_SLOT_HEIGHT+t.NODE_TITLE_HEIGHT]},r.prototype.onSubgraphTrigger=function(D,F){var E=this.findOutputSlot(D);E!=-1&&this.triggerSlot(E)},r.prototype.onSubgraphNewInput=function(D,F){var E=this.findInputSlot(D);E==-1&&this.addInput(D,F)},r.prototype.onSubgraphRenamedInput=function(D,F){var E=this.findInputSlot(D);if(E!=-1){var Q=this.getInputInfo(E);Q.name=F}},r.prototype.onSubgraphTypeChangeInput=function(D,F){var E=this.findInputSlot(D);if(E!=-1){var Q=this.getInputInfo(E);Q.type=F}},r.prototype.onSubgraphRemovedInput=function(D){var F=this.findInputSlot(D);F!=-1&&this.removeInput(F)},r.prototype.onSubgraphNewOutput=function(D,F){var E=this.findOutputSlot(D);E==-1&&this.addOutput(D,F)},r.prototype.onSubgraphRenamedOutput=function(D,F){var E=this.findOutputSlot(D);if(E!=-1){var Q=this.getOutputInfo(E);Q.name=F}},r.prototype.onSubgraphTypeChangeOutput=function(D,F){var E=this.findOutputSlot(D);if(E!=-1){var Q=this.getOutputInfo(E);Q.type=F}},r.prototype.onSubgraphRemovedOutput=function(D){var F=this.findOutputSlot(D);F!=-1&&this.removeOutput(F)},r.prototype.getExtraMenuOptions=function(D){var F=this;return[{content:"Open",callback:function(){D.openSubgraph(F.subgraph)}}]},r.prototype.onResize=function(D){D[1]+=20},r.prototype.serialize=function(){var D=t.LGraphNode.prototype.serialize.call(this);return D.subgraph=this.subgraph.serialize(),D},r.prototype.reassignSubgraphUUIDs=function(D){const F={nodeIDs:{},linkIDs:{}};for(const E of D.nodes){const Q=E.id,P=t.uuidv4();if(E.id=P,F.nodeIDs[Q]||F.nodeIDs[P])throw new Error(`New/old node UUID wasn't unique in changed map! ${Q} ${P}`);F.nodeIDs[Q]=P,F.nodeIDs[P]=Q}for(const E of D.links){const Q=E[0],P=t.uuidv4();if(E[0]=P,F.linkIDs[Q]||F.linkIDs[P])throw new Error(`New/old link UUID wasn't unique in changed map! ${Q} ${P}`);F.linkIDs[Q]=P,F.linkIDs[P]=Q;const H=E[1],q=E[3];if(!F.nodeIDs[H])throw new Error(`Old node UUID not found in mapping! ${H}`);if(E[1]=F.nodeIDs[H],!F.nodeIDs[q])throw new Error(`Old node UUID not found in mapping! ${q}`);E[3]=F.nodeIDs[q]}for(const E of D.nodes){if(E.inputs)for(const Q of E.inputs)Q.link&&(Q.link=F.linkIDs[Q.link]);if(E.outputs)for(const Q of E.outputs)Q.links&&(Q.links=Q.links.map(P=>F.linkIDs[P]))}for(const E of D.nodes)if(E.type==="graph/subgraph"){const Q=reassignGraphUUIDs(E.subgraph);F.nodeIDs.assign(Q.nodeIDs),F.linkIDs.assign(Q.linkIDs)}},r.prototype.clone=function(){var D=t.createNode(this.type),F=this.serialize();if(t.use_uuids){const E=t.cloneObject(F.subgraph);this.reassignSubgraphUUIDs(E),F.subgraph=E}return delete F.id,delete F.inputs,delete F.outputs,D.configure(F),D},r.prototype.buildFromNodes=function(D){for(var F={},E=0,Q=0;Q<D.length;++Q){var P=D[Q];F[P.id]=P,E=Math.min(P.pos[0],E),Math.max(P.pos[0],E)}for(var Q=0;Q<D.length;++Q){var P=D[Q];if(P.inputs)for(var H=0;H<P.inputs.length;++H){var q=P.inputs[H];if(!(!q||!q.link)){var st=P.graph.links[q.link];st&&(F[st.origin_id]||this.subgraph.addInput(q.name,st.type))}}if(P.outputs)for(var H=0;H<P.outputs.length;++H){var vt=P.outputs[H];if(!(!vt||!vt.links||!vt.links.length))for(var kt=!1,Yt=0;Yt<vt.links.length;++Yt){var st=P.graph.links[vt.links[Yt]];if(st&&!F[st.target_id]){kt=!0;break}}}}},t.Subgraph=r,t.registerNodeType("graph/subgraph",r);function s(){this.addOutput("","number"),this.name_in_graph="",this.properties={name:"",type:"number",value:0};var D=this;this.name_widget=this.addWidget("text","Name",this.properties.name,function(F){F&&D.setProperty("name",F)}),this.type_widget=this.addWidget("text","Type",this.properties.type,function(F){D.setProperty("type",F)}),this.value_widget=this.addWidget("number","Value",this.properties.value,function(F){D.setProperty("value",F)}),this.widgets_up=!0,this.size=[180,90]}s.title="Input",s.desc="Input of the graph",s.prototype.onConfigure=function(){this.updateType()},s.prototype.updateType=function(){var D=this.properties.type;this.type_widget.value=D,this.outputs[0].type!=D&&(t.isValidConnection(this.outputs[0].type,D)||this.disconnectOutput(0),this.outputs[0].type=D),D=="number"?(this.value_widget.type="number",this.value_widget.value=0):D=="boolean"?(this.value_widget.type="toggle",this.value_widget.value=!0):D=="string"?(this.value_widget.type="text",this.value_widget.value=""):(this.value_widget.type=null,this.value_widget.value=null),this.properties.value=this.value_widget.value,this.graph&&this.name_in_graph&&this.graph.changeInputType(this.name_in_graph,D)},s.prototype.onPropertyChanged=function(D,F){if(D=="name"){if(F==""||F==this.name_in_graph||F=="enabled")return!1;this.graph&&(this.name_in_graph?this.graph.renameInput(this.name_in_graph,F):this.graph.addInput(F,this.properties.type)),this.name_widget.value=F,this.name_in_graph=F}else D=="type"&&this.updateType()},s.prototype.getTitle=function(){return this.flags.collapsed?this.properties.name:this.title},s.prototype.onAction=function(D,F){this.properties.type==t.EVENT&&this.triggerSlot(0,F)},s.prototype.onExecute=function(){var D=this.properties.name,F=this.graph.inputs[D];if(!F){this.setOutputData(0,this.properties.value);return}this.setOutputData(0,F.value!==void 0?F.value:this.properties.value)},s.prototype.onRemoved=function(){this.name_in_graph&&this.graph.removeInput(this.name_in_graph)},t.GraphInput=s,t.registerNodeType("graph/input",s);function o(){this.addInput("",""),this.name_in_graph="",this.properties={name:"",type:""},this.name_widget=this.addWidget("text","Name",this.properties.name,"name"),this.type_widget=this.addWidget("text","Type",this.properties.type,"type"),this.widgets_up=!0,this.size=[180,60]}o.title="Output",o.desc="Output of the graph",o.prototype.onPropertyChanged=function(D,F){if(D=="name"){if(F==""||F==this.name_in_graph||F=="enabled")return!1;this.graph&&(this.name_in_graph?this.graph.renameOutput(this.name_in_graph,F):this.graph.addOutput(F,this.properties.type)),this.name_widget.value=F,this.name_in_graph=F}else D=="type"&&this.updateType()},o.prototype.updateType=function(){var D=this.properties.type;this.type_widget&&(this.type_widget.value=D),this.inputs[0].type!=D&&((D=="action"||D=="event")&&(D=t.EVENT),t.isValidConnection(this.inputs[0].type,D)||this.disconnectInput(0),this.inputs[0].type=D),this.graph&&this.name_in_graph&&this.graph.changeOutputType(this.name_in_graph,D)},o.prototype.onExecute=function(){this._value=this.getInputData(0),this.graph.setOutputData(this.properties.name,this._value)},o.prototype.onAction=function(D,F){this.properties.type==t.ACTION&&this.graph.trigger(this.properties.name,F)},o.prototype.onRemoved=function(){this.name_in_graph&&this.graph.removeOutput(this.name_in_graph)},o.prototype.getTitle=function(){return this.flags.collapsed?this.properties.name:this.title},t.GraphOutput=o,t.registerNodeType("graph/output",o);function h(){this.addOutput("value","number"),this.addProperty("value",1),this.widget=this.addWidget("number","value",1,"value"),this.widgets_up=!0,this.size=[180,30]}h.title="Const Number",h.desc="Constant number",h.prototype.onExecute=function(){this.setOutputData(0,parseFloat(this.properties.value))},h.prototype.getTitle=function(){return this.flags.collapsed?this.properties.value:this.title},h.prototype.setValue=function(D){this.setProperty("value",D)},h.prototype.onDrawBackground=function(D){this.outputs[0].label=this.properties.value.toFixed(3)},t.registerNodeType("basic/const",h);function u(){this.addOutput("bool","boolean"),this.addProperty("value",!0),this.widget=this.addWidget("toggle","value",!0,"value"),this.serialize_widgets=!0,this.widgets_up=!0,this.size=[140,30]}u.title="Const Boolean",u.desc="Constant boolean",u.prototype.getTitle=h.prototype.getTitle,u.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},u.prototype.setValue=h.prototype.setValue,u.prototype.onGetInputs=function(){return[["toggle",t.ACTION]]},u.prototype.onAction=function(D){this.setValue(!this.properties.value)},t.registerNodeType("basic/boolean",u);function f(){this.addOutput("string","string"),this.addProperty("value",""),this.widget=this.addWidget("text","value","","value"),this.widgets_up=!0,this.size=[180,30]}f.title="Const String",f.desc="Constant string",f.prototype.getTitle=h.prototype.getTitle,f.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},f.prototype.setValue=h.prototype.setValue,f.prototype.onDropFile=function(D){var F=this,E=new FileReader;E.onload=function(Q){F.setProperty("value",Q.target.result)},E.readAsText(D)},t.registerNodeType("basic/string",f);function c(){this.addOutput("obj","object"),this.size=[120,30],this._object={}}c.title="Const Object",c.desc="Constant Object",c.prototype.onExecute=function(){this.setOutputData(0,this._object)},t.registerNodeType("basic/object",c);function _(){this.addInput("url","string"),this.addOutput("file","string"),this.addProperty("url",""),this.addProperty("type","text"),this.widget=this.addWidget("text","url","","url"),this._data=null}_.title="Const File",_.desc="Fetches a file from an url",_["@type"]={type:"enum",values:["text","arraybuffer","blob","json"]},_.prototype.onPropertyChanged=function(D,F){D=="url"&&(F==null||F==""?this._data=null:this.fetchFile(F))},_.prototype.onExecute=function(){var D=this.getInputData(0)||this.properties.url;D&&(D!=this._url||this._type!=this.properties.type)&&this.fetchFile(D),this.setOutputData(0,this._data)},_.prototype.setValue=h.prototype.setValue,_.prototype.fetchFile=function(D){var F=this;if(!D||D.constructor!==String){F._data=null,F.boxcolor=null;return}this._url=D,this._type=this.properties.type,D.substr(0,4)=="http"&&t.proxy&&(D=t.proxy+D.substr(D.indexOf(":")+3)),fetch(D).then(function(E){if(!E.ok)throw new Error("File not found");if(F.properties.type=="arraybuffer")return E.arrayBuffer();if(F.properties.type=="text")return E.text();if(F.properties.type=="json")return E.json();if(F.properties.type=="blob")return E.blob()}).then(function(E){F._data=E,F.boxcolor="#AEA"}).catch(function(E){F._data=null,F.boxcolor="red",console.error("error fetching file:",D)})},_.prototype.onDropFile=function(D){var F=this;this._url=D.name,this._type=this.properties.type,this.properties.url=D.name;var E=new FileReader;if(E.onload=function(Q){F.boxcolor="#AEA";var P=Q.target.result;F.properties.type=="json"&&(P=JSON.parse(P)),F._data=P},F.properties.type=="arraybuffer")E.readAsArrayBuffer(D);else if(F.properties.type=="text"||F.properties.type=="json")E.readAsText(D);else if(F.properties.type=="blob")return E.readAsBinaryString(D)},t.registerNodeType("basic/file",_);function O(){this.addInput("parse",t.ACTION),this.addInput("json","string"),this.addOutput("done",t.EVENT),this.addOutput("object","object"),this.widget=this.addWidget("button","parse","",this.parse.bind(this)),this._str=null,this._obj=null}O.title="JSON Parse",O.desc="Parses JSON String into object",O.prototype.parse=function(){if(this._str)try{this._str=this.getInputData(1),this._obj=JSON.parse(this._str),this.boxcolor="#AEA",this.triggerSlot(0)}catch{this.boxcolor="red"}},O.prototype.onExecute=function(){this._str=this.getInputData(1),this.setOutputData(1,this._obj)},O.prototype.onAction=function(D){D=="parse"&&this.parse()},t.registerNodeType("basic/jsonparse",O);function d(){this.addOutput("data","object"),this.addProperty("value",""),this.widget=this.addWidget("text","json","","value"),this.widgets_up=!0,this.size=[140,30],this._value=null}d.title="Const Data",d.desc="Constant Data",d.prototype.onPropertyChanged=function(D,F){if(this.widget.value=F,!(F==null||F==""))try{this._value=JSON.parse(F),this.boxcolor="#AEA"}catch{this.boxcolor="red"}},d.prototype.onExecute=function(){this.setOutputData(0,this._value)},d.prototype.setValue=h.prototype.setValue,t.registerNodeType("basic/data",d);function b(){this._value=[],this.addInput("json",""),this.addOutput("arrayOut","array"),this.addOutput("length","number"),this.addProperty("value","[]"),this.widget=this.addWidget("text","array",this.properties.value,"value"),this.widgets_up=!0,this.size=[140,50]}b.title="Const Array",b.desc="Constant Array",b.prototype.onPropertyChanged=function(D,F){if(this.widget.value=F,!(F==null||F==""))try{F[0]!="["?this._value=JSON.parse("["+F+"]"):this._value=JSON.parse(F),this.boxcolor="#AEA"}catch{this.boxcolor="red"}},b.prototype.onExecute=function(){var D=this.getInputData(0);if(D&&D.length){this._value||(this._value=new Array),this._value.length=D.length;for(var F=0;F<D.length;++F)this._value[F]=D[F]}this.setOutputData(0,this._value),this.setOutputData(1,this._value&&this._value.length||0)},b.prototype.setValue=h.prototype.setValue,t.registerNodeType("basic/array",b);function S(){this.addInput("arr","array"),this.addInput("value",""),this.addOutput("arr","array"),this.properties={index:0},this.widget=this.addWidget("number","i",this.properties.index,"index",{precision:0,step:10,min:0})}S.title="Set Array",S.desc="Sets index of array",S.prototype.onExecute=function(){var D=this.getInputData(0);if(D){var F=this.getInputData(1);F!==void 0&&(this.properties.index&&(D[Math.floor(this.properties.index)]=F),this.setOutputData(0,D))}},t.registerNodeType("basic/set_array",S);function G(){this.addInput("array","array,table,string"),this.addInput("index","number"),this.addOutput("value",""),this.addProperty("index",0)}G.title="Array[i]",G.desc="Returns an element from an array",G.prototype.onExecute=function(){var D=this.getInputData(0),F=this.getInputData(1);F==null&&(F=this.properties.index),!(D==null||F==null)&&this.setOutputData(0,D[Math.floor(Number(F))])},t.registerNodeType("basic/array[]",G);function z(){this.addInput("table","table"),this.addInput("row","number"),this.addInput("col","number"),this.addOutput("value",""),this.addProperty("row",0),this.addProperty("column",0)}z.title="Table[row][col]",z.desc="Returns an element from a table",z.prototype.onExecute=function(){var D=this.getInputData(0),E=this.getInputData(1),F=this.getInputData(2);if(E==null&&(E=this.properties.row),F==null&&(F=this.properties.column),!(D==null||E==null||F==null)){var E=D[Math.floor(Number(E))];E?this.setOutputData(0,E[Math.floor(Number(F))]):this.setOutputData(0,null)}},t.registerNodeType("basic/table[][]",z);function $(){this.addInput("obj","object"),this.addOutput("property",0),this.addProperty("value",0),this.widget=this.addWidget("text","prop.","",this.setValue.bind(this)),this.widgets_up=!0,this.size=[140,30],this._value=null}$.title="Object property",$.desc="Outputs the property of an object",$.prototype.setValue=function(D){this.properties.value=D,this.widget.value=D},$.prototype.getTitle=function(){return this.flags.collapsed?"in."+this.properties.value:this.title},$.prototype.onPropertyChanged=function(D,F){this.widget.value=F},$.prototype.onExecute=function(){var D=this.getInputData(0);D!=null&&this.setOutputData(0,D[this.properties.value])},t.registerNodeType("basic/object_property",$);function A(){this.addInput("obj",""),this.addOutput("keys","array"),this.size=[140,30]}A.title="Object keys",A.desc="Outputs an array with the keys of an object",A.prototype.onExecute=function(){var D=this.getInputData(0);D!=null&&this.setOutputData(0,Object.keys(D))},t.registerNodeType("basic/object_keys",A);function l(){this.addInput("obj",""),this.addInput("value",""),this.addOutput("obj",""),this.properties={property:""},this.name_widget=this.addWidget("text","prop.",this.properties.property,"property")}l.title="Set Object",l.desc="Adds propertiesrty to object",l.prototype.onExecute=function(){var D=this.getInputData(0);if(D){var F=this.getInputData(1);F!==void 0&&(this.properties.property&&(D[this.properties.property]=F),this.setOutputData(0,D))}},t.registerNodeType("basic/set_object",l);function I(){this.addInput("A","object"),this.addInput("B","object"),this.addOutput("out","object"),this._result={};var D=this;this.addWidget("button","clear","",function(){D._result={}}),this.size=this.computeSize()}I.title="Merge Objects",I.desc="Creates an object copying properties from others",I.prototype.onExecute=function(){var D=this.getInputData(0),F=this.getInputData(1),E=this._result;if(D)for(var Q in D)E[Q]=D[Q];if(F)for(var Q in F)E[Q]=F[Q];this.setOutputData(0,E)},t.registerNodeType("basic/merge_objects",I);function T(){this.size=[60,30],this.addInput("in"),this.addOutput("out"),this.properties={varname:"myname",container:T.LITEGRAPH},this.value=null}T.title="Variable",T.desc="store/read variable value",T.LITEGRAPH=0,T.GRAPH=1,T.GLOBALSCOPE=2,T["@container"]={type:"enum",values:{litegraph:T.LITEGRAPH,graph:T.GRAPH,global:T.GLOBALSCOPE}},T.prototype.onExecute=function(){var D=this.getContainer();if(this.isInputConnected(0)){this.value=this.getInputData(0),D[this.properties.varname]=this.value,this.setOutputData(0,this.value);return}this.setOutputData(0,D[this.properties.varname])},T.prototype.getContainer=function(){switch(this.properties.container){case T.GRAPH:return this.graph?this.graph.vars:{};case T.GLOBALSCOPE:return e;case T.LITEGRAPH:default:return t.Globals}},T.prototype.getTitle=function(){return this.properties.varname},t.registerNodeType("basic/variable",T);function L(D){return D&&D.length!=null?Number(D.length):0}t.wrapFunctionAsNode("basic/length",L,[""],"number"),t.wrapFunctionAsNode("basic/not",function(D){return!D},[""],"boolean");function C(){this.size=[60,30],this.addInput("data",0),this.addInput("download",t.ACTION),this.properties={filename:"data.json"},this.value=null;var D=this;this.addWidget("button","Download","",function(F){D.value&&D.downloadAsFile()})}C.title="Download",C.desc="Download some data",C.prototype.downloadAsFile=function(){if(this.value!=null){var D=null;this.value.constructor===String?D=this.value:D=JSON.stringify(this.value);var F=new Blob([D]),E=URL.createObjectURL(F),Q=document.createElement("a");Q.setAttribute("href",E),Q.setAttribute("download",this.properties.filename),Q.style.display="none",document.body.appendChild(Q),Q.click(),document.body.removeChild(Q),setTimeout(function(){URL.revokeObjectURL(E)},1e3*60)}},C.prototype.onAction=function(D,F){var E=this;setTimeout(function(){E.downloadAsFile()},100)},C.prototype.onExecute=function(){this.inputs[0]&&(this.value=this.getInputData(0))},C.prototype.getTitle=function(){return this.flags.collapsed?this.properties.filename:this.title},t.registerNodeType("basic/download",C);function N(){this.size=[60,30],this.addInput("value",0,{label:""}),this.value=0}N.title="Watch",N.desc="Show value of input",N.prototype.onExecute=function(){this.inputs[0]&&(this.value=this.getInputData(0))},N.prototype.getTitle=function(){return this.flags.collapsed?this.inputs[0].label:this.title},N.toString=function(D){if(D==null)return"null";if(D.constructor===Number)return D.toFixed(3);if(D.constructor===Array){for(var F="[",E=0;E<D.length;++E)F+=N.toString(D[E])+(E+1!=D.length?",":"");return F+="]",F}else return String(D)},N.prototype.onDrawBackground=function(D){this.inputs[0].label=N.toString(this.value)},t.registerNodeType("basic/watch",N);function R(){this.addInput("in",0),this.addOutput("out",0),this.size=[40,30]}R.title="Cast",R.desc="Allows to connect different types",R.prototype.onExecute=function(){this.setOutputData(0,this.getInputData(0))},t.registerNodeType("basic/cast",R);function Y(){this.mode=t.ON_EVENT,this.size=[80,30],this.addProperty("msg",""),this.addInput("log",t.EVENT),this.addInput("msg",0)}Y.title="Console",Y.desc="Show value inside the console",Y.prototype.onAction=function(D,F){var E=this.getInputData(1);E||(E=this.properties.msg),E||(E="Event: "+F),D=="log"?console.log(E):D=="warn"?console.warn(E):D=="error"&&console.error(E)},Y.prototype.onExecute=function(){var D=this.getInputData(1);D||(D=this.properties.msg),D!=null&&typeof D<"u"&&(this.properties.msg=D,console.log(D))},Y.prototype.onGetInputs=function(){return[["log",t.ACTION],["warn",t.ACTION],["error",t.ACTION]]},t.registerNodeType("basic/console",Y);function ut(){this.mode=t.ON_EVENT,this.addProperty("msg",""),this.addInput("",t.EVENT),this.widget=this.addWidget("text","Text","","msg"),this.widgets_up=!0,this.size=[200,30]}ut.title="Alert",ut.desc="Show an alert window",ut.color="#510",ut.prototype.onConfigure=function(D){this.widget.value=D.properties.msg},ut.prototype.onAction=function(D,F){var E=this.properties.msg;setTimeout(function(){alert(E)},10)},t.registerNodeType("basic/alert",ut);function mt(){this.size=[60,30],this.addProperty("onExecute","return A;"),this.addInput("A",0),this.addInput("B",0),this.addOutput("out",0),this._func=null,this.data={}}mt.prototype.onConfigure=function(D){D.properties.onExecute&&t.allow_scripts?this.compileCode(D.properties.onExecute):console.warn("Script not compiled, LiteGraph.allow_scripts is false")},mt.title="Script",mt.desc="executes a code (max 256 characters)",mt.widgets_info={onExecute:{type:"code"}},mt.prototype.onPropertyChanged=function(D,F){D=="onExecute"&&t.allow_scripts?this.compileCode(F):console.warn("Script not compiled, LiteGraph.allow_scripts is false")},mt.prototype.compileCode=function(D){if(this._func=null,D.length>256)console.warn("Script too long, max 256 chars");else{for(var F=D.toLowerCase(),E=["script","body","document","eval","nodescript","function"],Q=0;Q<E.length;++Q)if(F.indexOf(E[Q])!=-1){console.warn("invalid script");return}try{this._func=new Function("A","B","C","DATA","node",D)}catch(P){console.error("Error parsing script"),console.error(P)}}},mt.prototype.onExecute=function(){if(this._func)try{var D=this.getInputData(0),F=this.getInputData(1),E=this.getInputData(2);this.setOutputData(0,this._func(D,F,E,this.data,this))}catch(Q){console.error("Error in script"),console.error(Q)}},mt.prototype.onGetOutputs=function(){return[["C",""]]},t.registerNodeType("basic/script",mt);function yt(){this.addInput("A",0),this.addInput("B",0),this.addOutput("true","boolean"),this.addOutput("false","boolean"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP","==","enum",{values:yt.values}),this.addWidget("combo","Op.",this.properties.OP,{property:"OP",values:yt.values}),this.size=[80,60]}yt.values=["==","!="],yt["@OP"]={type:"enum",title:"operation",values:yt.values},yt.title="Compare *",yt.desc="evaluates condition between A and B",yt.prototype.getTitle=function(){return"*A "+this.properties.OP+" *B"},yt.prototype.onExecute=function(){var D=this.getInputData(0);D===void 0?D=this.properties.A:this.properties.A=D;var F=this.getInputData(1);F===void 0?F=this.properties.B:this.properties.B=F;var E=!1;if(typeof D==typeof F)switch(this.properties.OP){case"==":case"!=":switch(E=!0,typeof D){case"object":var Q=Object.getOwnPropertyNames(D),P=Object.getOwnPropertyNames(F);if(Q.length!=P.length){E=!1;break}for(var H=0;H<Q.length;H++){var q=Q[H];if(D[q]!==F[q]){E=!1;break}}break;default:E=D==F}this.properties.OP=="!="&&(E=!E);break}this.setOutputData(0,E),this.setOutputData(1,!E)},t.registerNodeType("basic/CompareValues",yt)}(commonjsGlobal),function(e){var t=e.LiteGraph;function n(){this.size=[60,30],this.addInput("event",t.ACTION)}n.title="Log Event",n.desc="Log event in console",n.prototype.onAction=function(G,z,$){console.log(G,z)},t.registerNodeType("events/log",n);function r(){this.size=[60,30],this.addInput("if",""),this.addOutput("true",t.EVENT),this.addOutput("change",t.EVENT),this.addOutput("false",t.EVENT),this.properties={only_on_change:!0},this.prev=0}r.title="TriggerEvent",r.desc="Triggers event if input evaluates to true",r.prototype.onExecute=function(G,z){var $=this.getInputData(0),A=$!=this.prev;this.prev===0&&(A=!1);var l=A&&this.properties.only_on_change||!A&&!this.properties.only_on_change;$&&l&&this.triggerSlot(0,G,null,z),!$&&l&&this.triggerSlot(2,G,null,z),A&&this.triggerSlot(1,G,null,z),this.prev=$},t.registerNodeType("events/trigger",r);function s(){var G=this;this.addInput("",t.ACTION),this.addInput("",t.ACTION),this.addInput("",t.ACTION),this.addOutput("",t.EVENT),this.addOutput("",t.EVENT),this.addOutput("",t.EVENT),this.addWidget("button","+",null,function(){G.addInput("",t.ACTION),G.addOutput("",t.EVENT)}),this.size=[90,70],this.flags={horizontal:!0,render_box:!1}}s.title="Sequence",s.desc="Triggers a sequence of events when an event arrives",s.prototype.getTitle=function(){return""},s.prototype.onAction=function(G,z,$){if(this.outputs){$=$||{};for(var A=0;A<this.outputs.length;++A)this.outputs[A],$.action_call?$.action_call=$.action_call+"_seq_"+A:$.action_call=this.id+"_"+(G||"action")+"_seq_"+A+"_"+Math.floor(Math.random()*9999),this.triggerSlot(A,z,null,$)}},t.registerNodeType("events/sequence",s);function o(){var G=this;this.addInput("",t.ACTION),this.addInput("",t.ACTION),this.addOutput("",t.EVENT),this.addWidget("button","+",null,function(){G.addInput("",t.ACTION),G.size[0]=90}),this.size=[90,70],this.ready=[]}o.title="WaitAll",o.desc="Wait until all input events arrive then triggers output",o.prototype.getTitle=function(){return""},o.prototype.onDrawBackground=function(G){if(!this.flags.collapsed)for(var z=0;z<this.inputs.length;++z){var $=z*t.NODE_SLOT_HEIGHT+10;G.fillStyle=this.ready[z]?"#AFB":"#000",G.fillRect(20,$,10,10)}},o.prototype.onAction=function(G,z,$,A){if(A!=null){this.ready.length=this.outputs.length,this.ready[A]=!0;for(var l=0;l<this.ready.length;++l)if(!this.ready[l])return;this.reset(),this.triggerSlot(0)}},o.prototype.reset=function(){this.ready.length=0},t.registerNodeType("events/waitAll",o);function h(){var G=this;this.properties={index:0},this.addInput("index","number"),this.addInput("step",t.ACTION),this.addInput("reset",t.ACTION),this.addOutput("index","number"),this.addOutput("",t.EVENT),this.addOutput("",t.EVENT),this.addOutput("",t.EVENT,{removable:!0}),this.addWidget("button","+",null,function(){G.addOutput("",t.EVENT,{removable:!0})}),this.size=[120,120],this.flags={render_box:!1}}h.title="Stepper",h.desc="Trigger events sequentially when an tick arrives",h.prototype.onDrawBackground=function(G){if(!this.flags.collapsed){var z=this.properties.index||0;G.fillStyle="#AFB";var $=this.size[0],A=(z+1)*t.NODE_SLOT_HEIGHT+4;G.beginPath(),G.moveTo($-30,A),G.lineTo($-30,A+t.NODE_SLOT_HEIGHT),G.lineTo($-15,A+t.NODE_SLOT_HEIGHT*.5),G.fill()}},h.prototype.onExecute=function(){var G=this.getInputData(0);G!=null&&(G=Math.floor(G),G=clamp(G,0,this.outputs?this.outputs.length-2:0),G!=this.properties.index&&(this.properties.index=G,this.triggerSlot(G+1))),this.setOutputData(0,this.properties.index)},h.prototype.onAction=function(G,z){if(G=="reset")this.properties.index=0;else if(G=="step"){this.triggerSlot(this.properties.index+1,z);var $=this.outputs?this.outputs.length-1:0;this.properties.index=(this.properties.index+1)%$}},t.registerNodeType("events/stepper",h);function u(){this.size=[60,30],this.addInput("event",t.ACTION),this.addOutput("event",t.EVENT),this.properties={equal_to:"",has_property:"",property_equal_to:""}}u.title="Filter Event",u.desc="Blocks events that do not match the filter",u.prototype.onAction=function(G,z,$){if(z!=null&&!(this.properties.equal_to&&this.properties.equal_to!=z)){if(this.properties.has_property){var A=z[this.properties.has_property];if(A==null||this.properties.property_equal_to&&this.properties.property_equal_to!=A)return}this.triggerSlot(0,z,null,$)}},t.registerNodeType("events/filter",u);function f(){this.addInput("in",t.ACTION),this.addInput("cond","boolean"),this.addOutput("true",t.EVENT),this.addOutput("false",t.EVENT),this.size=[120,60],this._value=!1}f.title="Branch",f.desc="If condition is true, outputs triggers true, otherwise false",f.prototype.onExecute=function(){this._value=this.getInputData(1)},f.prototype.onAction=function(G,z,$){this._value=this.getInputData(1),this.triggerSlot(this._value?0:1,z,null,$)},t.registerNodeType("events/branch",f);function c(){this.addInput("inc",t.ACTION),this.addInput("dec",t.ACTION),this.addInput("reset",t.ACTION),this.addOutput("change",t.EVENT),this.addOutput("num","number"),this.addProperty("doCountExecution",!1,"boolean",{name:"Count Executions"}),this.addWidget("toggle","Count Exec.",this.properties.doCountExecution,"doCountExecution"),this.num=0}c.title="Counter",c.desc="Counts events",c.prototype.getTitle=function(){return this.flags.collapsed?String(this.num):this.title},c.prototype.onAction=function(G,z,$){var A=this.num;G=="inc"?this.num+=1:G=="dec"?this.num-=1:G=="reset"&&(this.num=0),this.num!=A&&this.trigger("change",this.num)},c.prototype.onDrawBackground=function(G){this.flags.collapsed||(G.fillStyle="#AAA",G.font="20px Arial",G.textAlign="center",G.fillText(this.num,this.size[0]*.5,this.size[1]*.5))},c.prototype.onExecute=function(){this.properties.doCountExecution&&(this.num+=1),this.setOutputData(1,this.num)},t.registerNodeType("events/counter",c);function _(){this.size=[60,30],this.addProperty("time_in_ms",1e3),this.addInput("event",t.ACTION),this.addOutput("on_time",t.EVENT),this._pending=[]}_.title="Delay",_.desc="Delays one event",_.prototype.onAction=function(G,z,$){var A=this.properties.time_in_ms;A<=0?this.trigger(null,z,$):this._pending.push([A,z])},_.prototype.onExecute=function(G,z){var $=this.graph.elapsed_time*1e3;this.isInputConnected(1)&&(this.properties.time_in_ms=this.getInputData(1));for(var A=0;A<this._pending.length;++A){var l=this._pending[A];l[0]-=$,!(l[0]>0)&&(this._pending.splice(A,1),--A,this.trigger(null,l[1],z))}},_.prototype.onGetInputs=function(){return[["event",t.ACTION],["time_in_ms","number"]]},t.registerNodeType("events/delay",_);function O(){this.addProperty("interval",1e3),this.addProperty("event","tick"),this.addOutput("on_tick",t.EVENT),this.time=0,this.last_interval=1e3,this.triggered=!1}O.title="Timer",O.desc="Sends an event every N milliseconds",O.prototype.onStart=function(){this.time=0},O.prototype.getTitle=function(){return"Timer: "+this.last_interval.toString()+"ms"},O.on_color="#AAA",O.off_color="#222",O.prototype.onDrawBackground=function(){this.boxcolor=this.triggered?O.on_color:O.off_color,this.triggered=!1},O.prototype.onExecute=function(){var G=this.graph.elapsed_time*1e3,z=this.time==0;if(this.time+=G,this.last_interval=Math.max(1,this.getInputOrProperty("interval")|0),!z&&(this.time<this.last_interval||isNaN(this.last_interval))){this.inputs&&this.inputs.length>1&&this.inputs[1]&&this.setOutputData(1,!1);return}this.triggered=!0,this.time=this.time%this.last_interval,this.trigger("on_tick",this.properties.event),this.inputs&&this.inputs.length>1&&this.inputs[1]&&this.setOutputData(1,!0)},O.prototype.onGetInputs=function(){return[["interval","number"]]},O.prototype.onGetOutputs=function(){return[["tick","boolean"]]},t.registerNodeType("events/timer",O);function d(){this.addInput("go",t.ACTION),this.addInput("green",t.ACTION),this.addInput("red",t.ACTION),this.addOutput("continue",t.EVENT),this.addOutput("blocked",t.EVENT),this.addOutput("is_green","boolean"),this._ready=!1,this.properties={};var G=this;this.addWidget("button","reset","",function(){G._ready=!1})}d.title="Semaphore Event",d.desc="Until both events are not triggered, it doesnt continue.",d.prototype.onExecute=function(){this.setOutputData(1,this._ready),this.boxcolor=this._ready?"#9F9":"#FA5"},d.prototype.onAction=function(G,z){G=="go"?this.triggerSlot(this._ready?0:1):G=="green"?this._ready=!0:G=="red"&&(this._ready=!1)},t.registerNodeType("events/semaphore",d);function b(){this.addInput("in",t.ACTION),this.addInput("reset",t.ACTION),this.addOutput("out",t.EVENT),this._once=!1,this.properties={};var G=this;this.addWidget("button","reset","",function(){G._once=!1})}b.title="Once",b.desc="Only passes an event once, then gets locked",b.prototype.onAction=function(G,z){G=="in"&&!this._once?(this._once=!0,this.triggerSlot(0,z)):G=="reset"&&(this._once=!1)},t.registerNodeType("events/once",b);function S(){this.addInput("data",0),this.addInput("assign",t.ACTION),this.addOutput("data",0),this._last_value=null,this.properties={data:null,serialize:!0};var G=this;this.addWidget("button","store","",function(){G.properties.data=G._last_value})}S.title="Data Store",S.desc="Stores data and only changes when event is received",S.prototype.onExecute=function(){this._last_value=this.getInputData(0),this.setOutputData(0,this.properties.data)},S.prototype.onAction=function(G,z,$){this.properties.data=this._last_value},S.prototype.onSerialize=function(G){G.data!=null&&(this.properties.serialize==!1||G.data.constructor!==String&&G.data.constructor!==Number&&G.data.constructor!==Boolean&&G.data.constructor!==Array&&G.data.constructor!==Object)&&(G.data=null)},t.registerNodeType("basic/data_store",S)}(commonjsGlobal),function(e){var t=e.LiteGraph;function n(){this.addOutput("",t.EVENT),this.addOutput("","boolean"),this.addProperty("text","click me"),this.addProperty("font_size",30),this.addProperty("message",""),this.size=[164,84],this.clicked=!1}n.title="Button",n.desc="Triggers an event",n.font="Arial",n.prototype.onDrawForeground=function(d){if(!this.flags.collapsed){var b=10;if(d.fillStyle="black",d.fillRect(b+1,b+1,this.size[0]-b*2,this.size[1]-b*2),d.fillStyle="#AAF",d.fillRect(b-1,b-1,this.size[0]-b*2,this.size[1]-b*2),d.fillStyle=this.clicked?"white":this.mouseOver?"#668":"#334",d.fillRect(b,b,this.size[0]-b*2,this.size[1]-b*2),this.properties.text||this.properties.text===0){var S=this.properties.font_size||30;d.textAlign="center",d.fillStyle=this.clicked?"black":"white",d.font=S+"px "+n.font,d.fillText(this.properties.text,this.size[0]*.5,this.size[1]*.5+S*.3),d.textAlign="left"}}},n.prototype.onMouseDown=function(d,b){if(b[0]>1&&b[1]>1&&b[0]<this.size[0]-2&&b[1]<this.size[1]-2)return this.clicked=!0,this.setOutputData(1,this.clicked),this.triggerSlot(0,this.properties.message),!0},n.prototype.onExecute=function(){this.setOutputData(1,this.clicked)},n.prototype.onMouseUp=function(d){this.clicked=!1},t.registerNodeType("widget/button",n);function r(){this.addInput("","boolean"),this.addInput("e",t.ACTION),this.addOutput("v","boolean"),this.addOutput("e",t.EVENT),this.properties={font:"",value:!1},this.size=[160,44]}r.title="Toggle",r.desc="Toggles between true or false",r.prototype.onDrawForeground=function(d){if(!this.flags.collapsed){var b=this.size[1]*.5,S=.25,G=this.size[1]*.8;d.font=this.properties.font||(b*.8).toFixed(0)+"px Arial";var z=d.measureText(this.title).width,$=(this.size[0]-(z+b))*.5;d.fillStyle="#AAA",d.fillRect($,G-b,b,b),d.fillStyle=this.properties.value?"#AEF":"#000",d.fillRect($+b*S,G-b+b*S,b*(1-S*2),b*(1-S*2)),d.textAlign="left",d.fillStyle="#AAA",d.fillText(this.title,b*1.2+$,G*.85),d.textAlign="left"}},r.prototype.onAction=function(d){this.properties.value=!this.properties.value,this.trigger("e",this.properties.value)},r.prototype.onExecute=function(){var d=this.getInputData(0);d!=null&&(this.properties.value=d),this.setOutputData(0,this.properties.value)},r.prototype.onMouseDown=function(d,b){if(b[0]>1&&b[1]>1&&b[0]<this.size[0]-2&&b[1]<this.size[1]-2)return this.properties.value=!this.properties.value,this.graph._version++,this.trigger("e",this.properties.value),!0},t.registerNodeType("widget/toggle",r);function s(){this.addOutput("","number"),this.size=[80,60],this.properties={min:-1e3,max:1e3,value:1,step:1},this.old_y=-1,this._remainder=0,this._precision=0,this.mouse_captured=!1}s.title="Number",s.desc="Widget to select number value",s.pixels_threshold=10,s.markers_color="#666",s.prototype.onDrawForeground=function(d){var b=this.size[0]*.5,S=this.size[1];S>30?(d.fillStyle=s.markers_color,d.beginPath(),d.moveTo(b,S*.1),d.lineTo(b+S*.1,S*.2),d.lineTo(b+S*-.1,S*.2),d.fill(),d.beginPath(),d.moveTo(b,S*.9),d.lineTo(b+S*.1,S*.8),d.lineTo(b+S*-.1,S*.8),d.fill(),d.font=(S*.7).toFixed(1)+"px Arial"):d.font=(S*.8).toFixed(1)+"px Arial",d.textAlign="center",d.font=(S*.7).toFixed(1)+"px Arial",d.fillStyle="#EEE",d.fillText(this.properties.value.toFixed(this._precision),b,S*.75)},s.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},s.prototype.onPropertyChanged=function(d,b){var S=(this.properties.step+"").split(".");this._precision=S.length>1?S[1].length:0},s.prototype.onMouseDown=function(d,b){if(!(b[1]<0))return this.old_y=d.canvasY,this.captureInput(!0),this.mouse_captured=!0,!0},s.prototype.onMouseMove=function(d){if(this.mouse_captured){var b=this.old_y-d.canvasY;d.shiftKey&&(b*=10),(d.metaKey||d.altKey)&&(b*=.1),this.old_y=d.canvasY;var S=this._remainder+b/s.pixels_threshold;this._remainder=S%1,S=S|0;var G=clamp(this.properties.value+S*this.properties.step,this.properties.min,this.properties.max);this.properties.value=G,this.graph._version++,this.setDirtyCanvas(!0)}},s.prototype.onMouseUp=function(d,b){if(d.click_time<200){var S=b[1]>this.size[1]*.5?-1:1;this.properties.value=clamp(this.properties.value+S*this.properties.step,this.properties.min,this.properties.max),this.graph._version++,this.setDirtyCanvas(!0)}this.mouse_captured&&(this.mouse_captured=!1,this.captureInput(!1))},t.registerNodeType("widget/number",s);function o(){this.addOutput("","string"),this.addOutput("change",t.EVENT),this.size=[80,60],this.properties={value:"A",values:"A;B;C"},this.old_y=-1,this.mouse_captured=!1,this._values=this.properties.values.split(";");var d=this;this.widgets_up=!0,this.widget=this.addWidget("combo","",this.properties.value,function(b){d.properties.value=b,d.triggerSlot(1,b)},{property:"value",values:this._values})}o.title="Combo",o.desc="Widget to select from a list",o.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},o.prototype.onPropertyChanged=function(d,b){d=="values"?(this._values=b.split(";"),this.widget.options.values=this._values):d=="value"&&(this.widget.value=b)},t.registerNodeType("widget/combo",o);function h(){this.addOutput("","number"),this.size=[64,84],this.properties={min:0,max:1,value:.5,color:"#7AF",precision:2},this.value=-1}h.title="Knob",h.desc="Circular controller",h.size=[80,100],h.prototype.onDrawForeground=function(d){if(!this.flags.collapsed){this.value==-1&&(this.value=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min));var b=this.size[0]*.5,S=this.size[1]*.5,G=Math.min(this.size[0],this.size[1])*.5-5;d.globalAlpha=1,d.save(),d.translate(b,S),d.rotate(Math.PI*.75),d.fillStyle="rgba(0,0,0,0.5)",d.beginPath(),d.moveTo(0,0),d.arc(0,0,G,0,Math.PI*1.5),d.fill(),d.strokeStyle="black",d.fillStyle=this.properties.color,d.lineWidth=2,d.beginPath(),d.moveTo(0,0),d.arc(0,0,G-4,0,Math.PI*1.5*Math.max(.01,this.value)),d.closePath(),d.fill(),d.lineWidth=1,d.globalAlpha=1,d.restore(),d.fillStyle="black",d.beginPath(),d.arc(b,S,G*.75,0,Math.PI*2,!0),d.fill(),d.fillStyle=this.mouseOver?"white":this.properties.color,d.beginPath();var z=this.value*Math.PI*1.5+Math.PI*.75;d.arc(b+Math.cos(z)*G*.65,S+Math.sin(z)*G*.65,G*.05,0,Math.PI*2,!0),d.fill(),d.fillStyle=this.mouseOver?"white":"#AAA",d.font=Math.floor(G*.5)+"px Arial",d.textAlign="center",d.fillText(this.properties.value.toFixed(this.properties.precision),b,S+G*.15)}},h.prototype.onExecute=function(){this.setOutputData(0,this.properties.value),this.boxcolor=t.colorToString([this.value,this.value,this.value])},h.prototype.onMouseDown=function(d){return this.center=[this.size[0]*.5,this.size[1]*.5+20],this.radius=this.size[0]*.5,d.canvasY-this.pos[1]<20||t.distance([d.canvasX,d.canvasY],[this.pos[0]+this.center[0],this.pos[1]+this.center[1]])>this.radius?!1:(this.oldmouse=[d.canvasX-this.pos[0],d.canvasY-this.pos[1]],this.captureInput(!0),!0)},h.prototype.onMouseMove=function(d){if(this.oldmouse){var b=[d.canvasX-this.pos[0],d.canvasY-this.pos[1]],S=this.value;S-=(b[1]-this.oldmouse[1])*.01,S>1?S=1:S<0&&(S=0),this.value=S,this.properties.value=this.properties.min+(this.properties.max-this.properties.min)*this.value,this.oldmouse=b,this.setDirtyCanvas(!0)}},h.prototype.onMouseUp=function(d){this.oldmouse&&(this.oldmouse=null,this.captureInput(!1))},h.prototype.onPropertyChanged=function(d,b){if(d=="min"||d=="max"||d=="value")return this.properties[d]=parseFloat(b),!0},t.registerNodeType("widget/knob",h);function u(){this.addOutput("","number"),this.properties={value:.5,min:0,max:1,text:"V"};var d=this;this.size=[140,40],this.slider=this.addWidget("slider","V",this.properties.value,function(b){d.properties.value=b},this.properties),this.widgets_up=!0}u.title="Inner Slider",u.prototype.onPropertyChanged=function(d,b){d=="value"&&(this.slider.value=b)},u.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},t.registerNodeType("widget/internal_slider",u);function f(){this.size=[160,26],this.addOutput("","number"),this.properties={color:"#7AF",min:0,max:1,value:.5},this.value=-1}f.title="H.Slider",f.desc="Linear slider controller",f.prototype.onDrawForeground=function(d){this.value==-1&&(this.value=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min)),d.globalAlpha=1,d.lineWidth=1,d.fillStyle="#000",d.fillRect(2,2,this.size[0]-4,this.size[1]-4),d.fillStyle=this.properties.color,d.beginPath(),d.rect(4,4,(this.size[0]-8)*this.value,this.size[1]-8),d.fill()},f.prototype.onExecute=function(){this.properties.value=this.properties.min+(this.properties.max-this.properties.min)*this.value,this.setOutputData(0,this.properties.value),this.boxcolor=t.colorToString([this.value,this.value,this.value])},f.prototype.onMouseDown=function(d){return d.canvasY-this.pos[1]<0?!1:(this.oldmouse=[d.canvasX-this.pos[0],d.canvasY-this.pos[1]],this.captureInput(!0),!0)},f.prototype.onMouseMove=function(d){if(this.oldmouse){var b=[d.canvasX-this.pos[0],d.canvasY-this.pos[1]],S=this.value,G=b[0]-this.oldmouse[0];S+=G/this.size[0],S>1?S=1:S<0&&(S=0),this.value=S,this.oldmouse=b,this.setDirtyCanvas(!0)}},f.prototype.onMouseUp=function(d){this.oldmouse=null,this.captureInput(!1)},f.prototype.onMouseLeave=function(d){},t.registerNodeType("widget/hslider",f);function c(){this.size=[160,26],this.addInput("","number"),this.properties={min:0,max:1,value:0,color:"#AAF"}}c.title="Progress",c.desc="Shows data in linear progress",c.prototype.onExecute=function(){var d=this.getInputData(0);d!=null&&(this.properties.value=d)},c.prototype.onDrawForeground=function(d){d.lineWidth=1,d.fillStyle=this.properties.color;var b=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min);b=Math.min(1,b),b=Math.max(0,b),d.fillRect(2,2,(this.size[0]-4)*b,this.size[1]-4)},t.registerNodeType("widget/progress",c);function _(){this.addInputs("",0),this.properties={value:"...",font:"Arial",fontsize:18,color:"#AAA",align:"left",glowSize:0,decimals:1}}_.title="Text",_.desc="Shows the input value",_.widgets=[{name:"resize",text:"Resize box",type:"button"},{name:"led_text",text:"LED",type:"minibutton"},{name:"normal_text",text:"Normal",type:"minibutton"}],_.prototype.onDrawForeground=function(d){d.fillStyle=this.properties.color;var b=this.properties.value;this.properties.glowSize?(d.shadowColor=this.properties.color,d.shadowOffsetX=0,d.shadowOffsetY=0,d.shadowBlur=this.properties.glowSize):d.shadowColor="transparent";var S=this.properties.fontsize;if(d.textAlign=this.properties.align,d.font=S.toString()+"px "+this.properties.font,this.str=typeof b=="number"?b.toFixed(this.properties.decimals):b,typeof this.str=="string")for(var G=this.str.replace(/[\r\n]/g,"\\n").split("\\n"),z=0;z<G.length;z++)d.fillText(G[z],this.properties.align=="left"?15:this.size[0]-15,S*-.15+S*(parseInt(z)+1));d.shadowColor="transparent",this.last_ctx=d,d.textAlign="left"},_.prototype.onExecute=function(){var d=this.getInputData(0);d!=null&&(this.properties.value=d)},_.prototype.resize=function(){if(this.last_ctx){var d=this.str.split("\\n");this.last_ctx.font=this.properties.fontsize+"px "+this.properties.font;for(var b=0,S=0;S<d.length;S++){var G=this.last_ctx.measureText(d[S]).width;b<G&&(b=G)}this.size[0]=b+20,this.size[1]=4+d.length*this.properties.fontsize,this.setDirtyCanvas(!0)}},_.prototype.onPropertyChanged=function(d,b){return this.properties[d]=b,this.str=typeof b=="number"?b.toFixed(3):b,!0},t.registerNodeType("widget/text",_);function O(){this.size=[200,100],this.properties={borderColor:"#ffffff",bgcolorTop:"#f0f0f0",bgcolorBottom:"#e0e0e0",shadowSize:2,borderRadius:3}}O.title="Panel",O.desc="Non interactive panel",O.widgets=[{name:"update",text:"Update",type:"button"}],O.prototype.createGradient=function(d){if(this.properties.bgcolorTop==""||this.properties.bgcolorBottom==""){this.lineargradient=0;return}this.lineargradient=d.createLinearGradient(0,0,0,this.size[1]),this.lineargradient.addColorStop(0,this.properties.bgcolorTop),this.lineargradient.addColorStop(1,this.properties.bgcolorBottom)},O.prototype.onDrawForeground=function(d){this.flags.collapsed||(this.lineargradient==null&&this.createGradient(d),this.lineargradient&&(d.lineWidth=1,d.strokeStyle=this.properties.borderColor,d.fillStyle=this.lineargradient,this.properties.shadowSize?(d.shadowColor="#000",d.shadowOffsetX=0,d.shadowOffsetY=0,d.shadowBlur=this.properties.shadowSize):d.shadowColor="transparent",d.roundRect(0,0,this.size[0]-1,this.size[1]-1,this.properties.shadowSize),d.fill(),d.shadowColor="transparent",d.stroke()))},t.registerNodeType("widget/panel",O)}(commonjsGlobal),function(e){var t=e.LiteGraph;function n(){this.addOutput("left_x_axis","number"),this.addOutput("left_y_axis","number"),this.addOutput("button_pressed",t.EVENT),this.properties={gamepad_index:0,threshold:.1},this._left_axis=new Float32Array(2),this._right_axis=new Float32Array(2),this._triggers=new Float32Array(2),this._previous_buttons=new Uint8Array(17),this._current_buttons=new Uint8Array(17)}n.title="Gamepad",n.desc="gets the input of the gamepad",n.CENTER=0,n.LEFT=1,n.RIGHT=2,n.UP=4,n.DOWN=8,n.zero=new Float32Array(2),n.buttons=["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs","home"],n.prototype.onExecute=function(){var r=this.getGamepad(),s=this.properties.threshold||0;if(r&&(this._left_axis[0]=Math.abs(r.xbox.axes.lx)>s?r.xbox.axes.lx:0,this._left_axis[1]=Math.abs(r.xbox.axes.ly)>s?r.xbox.axes.ly:0,this._right_axis[0]=Math.abs(r.xbox.axes.rx)>s?r.xbox.axes.rx:0,this._right_axis[1]=Math.abs(r.xbox.axes.ry)>s?r.xbox.axes.ry:0,this._triggers[0]=Math.abs(r.xbox.axes.ltrigger)>s?r.xbox.axes.ltrigger:0,this._triggers[1]=Math.abs(r.xbox.axes.rtrigger)>s?r.xbox.axes.rtrigger:0),this.outputs)for(var o=0;o<this.outputs.length;o++){var h=this.outputs[o];if(!(!h.links||!h.links.length)){var u=null;if(r)switch(h.name){case"left_axis":u=this._left_axis;break;case"right_axis":u=this._right_axis;break;case"left_x_axis":u=this._left_axis[0];break;case"left_y_axis":u=this._left_axis[1];break;case"right_x_axis":u=this._right_axis[0];break;case"right_y_axis":u=this._right_axis[1];break;case"trigger_left":u=this._triggers[0];break;case"trigger_right":u=this._triggers[1];break;case"a_button":u=r.xbox.buttons.a?1:0;break;case"b_button":u=r.xbox.buttons.b?1:0;break;case"x_button":u=r.xbox.buttons.x?1:0;break;case"y_button":u=r.xbox.buttons.y?1:0;break;case"lb_button":u=r.xbox.buttons.lb?1:0;break;case"rb_button":u=r.xbox.buttons.rb?1:0;break;case"ls_button":u=r.xbox.buttons.ls?1:0;break;case"rs_button":u=r.xbox.buttons.rs?1:0;break;case"hat_left":u=r.xbox.hatmap&n.LEFT;break;case"hat_right":u=r.xbox.hatmap&n.RIGHT;break;case"hat_up":u=r.xbox.hatmap&n.UP;break;case"hat_down":u=r.xbox.hatmap&n.DOWN;break;case"hat":u=r.xbox.hatmap;break;case"start_button":u=r.xbox.buttons.start?1:0;break;case"back_button":u=r.xbox.buttons.back?1:0;break;case"button_pressed":for(var f=0;f<this._current_buttons.length;++f)this._current_buttons[f]&&!this._previous_buttons[f]&&this.triggerSlot(o,n.buttons[f]);break}else switch(h.name){case"button_pressed":break;case"left_axis":case"right_axis":u=n.zero;break;default:u=0}this.setOutputData(o,u)}}},n.mapping={a:0,b:1,x:2,y:3,lb:4,rb:5,lt:6,rt:7,back:8,start:9,ls:10,rs:11},n.mapping_array=["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs"],n.prototype.getGamepad=function(){var r=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(!r)return null;var s=r.call(navigator),o=null;this._previous_buttons.set(this._current_buttons);for(var h=this.properties.gamepad_index;h<4;h++)if(s[h]){o=s[h];var u=this.xbox_mapping;u||(u=this.xbox_mapping={axes:[],buttons:{},hat:"",hatmap:n.CENTER}),u.axes.lx=o.axes[0],u.axes.ly=o.axes[1],u.axes.rx=o.axes[2],u.axes.ry=o.axes[3],u.axes.ltrigger=o.buttons[6].value,u.axes.rtrigger=o.buttons[7].value,u.hat="",u.hatmap=n.CENTER;for(var f=0;f<o.buttons.length;f++)if(this._current_buttons[f]=o.buttons[f].pressed,f<12)u.buttons[n.mapping_array[f]]=o.buttons[f].pressed,o.buttons[f].was_pressed&&this.trigger(n.mapping_array[f]+"_button_event");else switch(f){case 12:o.buttons[f].pressed&&(u.hat+="up",u.hatmap|=n.UP);break;case 13:o.buttons[f].pressed&&(u.hat+="down",u.hatmap|=n.DOWN);break;case 14:o.buttons[f].pressed&&(u.hat+="left",u.hatmap|=n.LEFT);break;case 15:o.buttons[f].pressed&&(u.hat+="right",u.hatmap|=n.RIGHT);break;case 16:u.buttons.home=o.buttons[f].pressed;break}return o.xbox=u,o}},n.prototype.onDrawBackground=function(r){if(!this.flags.collapsed){var s=this._left_axis,o=this._right_axis;r.strokeStyle="#88A",r.strokeRect((s[0]+1)*.5*this.size[0]-4,(s[1]+1)*.5*this.size[1]-4,8,8),r.strokeStyle="#8A8",r.strokeRect((o[0]+1)*.5*this.size[0]-4,(o[1]+1)*.5*this.size[1]-4,8,8);var h=this.size[1]/this._current_buttons.length;r.fillStyle="#AEB";for(var u=0;u<this._current_buttons.length;++u)this._current_buttons[u]&&r.fillRect(0,h*u,6,h)}},n.prototype.onGetOutputs=function(){return[["left_axis","vec2"],["right_axis","vec2"],["left_x_axis","number"],["left_y_axis","number"],["right_x_axis","number"],["right_y_axis","number"],["trigger_left","number"],["trigger_right","number"],["a_button","number"],["b_button","number"],["x_button","number"],["y_button","number"],["lb_button","number"],["rb_button","number"],["ls_button","number"],["rs_button","number"],["start_button","number"],["back_button","number"],["a_button_event",t.EVENT],["b_button_event",t.EVENT],["x_button_event",t.EVENT],["y_button_event",t.EVENT],["lb_button_event",t.EVENT],["rb_button_event",t.EVENT],["ls_button_event",t.EVENT],["rs_button_event",t.EVENT],["start_button_event",t.EVENT],["back_button_event",t.EVENT],["hat_left","number"],["hat_right","number"],["hat_up","number"],["hat_down","number"],["hat","number"],["button_pressed",t.EVENT]]},t.registerNodeType("input/gamepad",n)}(commonjsGlobal),function(e){var t=e.LiteGraph;function n(){this.addInput("in",0),this.addOutput("out",0),this.size=[80,30]}n.title="Converter",n.desc="type A to type B",n.prototype.onExecute=function(){var E=this.getInputData(0);if(E!=null&&this.outputs)for(var Q=0;Q<this.outputs.length;Q++){var P=this.outputs[Q];if(!(!P.links||!P.links.length)){var H=null;switch(P.name){case"number":H=E.length?E[0]:parseFloat(E);break;case"vec2":case"vec3":case"vec4":var H=null,q=1;switch(P.name){case"vec2":q=2;break;case"vec3":q=3;break;case"vec4":q=4;break}var H=new Float32Array(q);if(E.length)for(var st=0;st<E.length&&st<H.length;st++)H[st]=E[st];else H[0]=parseFloat(E);break}this.setOutputData(Q,H)}}},n.prototype.onGetOutputs=function(){return[["number","number"],["vec2","vec2"],["vec3","vec3"],["vec4","vec4"]]},t.registerNodeType("math/converter",n);function r(){this.addInput("in"),this.addOutput("out"),this.size=[80,30]}r.title="Bypass",r.desc="removes the type",r.prototype.onExecute=function(){var E=this.getInputData(0);this.setOutputData(0,E)},t.registerNodeType("math/bypass",r);function s(){this.addInput("in"),this.addOutput("out")}s.title="to Number",s.desc="Cast to number",s.prototype.onExecute=function(){var E=this.getInputData(0);this.setOutputData(0,Number(E))},t.registerNodeType("math/to_number",s);function o(){this.addInput("in","number",{locked:!0}),this.addOutput("out","number",{locked:!0}),this.addOutput("clamped","number",{locked:!0}),this.addProperty("in",0),this.addProperty("in_min",0),this.addProperty("in_max",1),this.addProperty("out_min",0),this.addProperty("out_max",1),this.size=[120,50]}o.title="Range",o.desc="Convert a number from one range to another",o.prototype.getTitle=function(){return this.flags.collapsed?(this._last_v||0).toFixed(2):this.title},o.prototype.onExecute=function(){if(this.inputs)for(var E=0;E<this.inputs.length;E++){var Q=this.inputs[E],P=this.getInputData(E);P!==void 0&&(this.properties[Q.name]=P)}var P=this.properties.in;(P==null||P.constructor!==Number)&&(P=0);var H=this.properties.in_min,q=this.properties.in_max,st=this.properties.out_min,vt=this.properties.out_max;this._last_v=(P-H)/(q-H)*(vt-st)+st,this.setOutputData(0,this._last_v),this.setOutputData(1,clamp(this._last_v,st,vt))},o.prototype.onDrawBackground=function(E){this._last_v?this.outputs[0].label=this._last_v.toFixed(3):this.outputs[0].label="?"},o.prototype.onGetInputs=function(){return[["in_min","number"],["in_max","number"],["out_min","number"],["out_max","number"]]},t.registerNodeType("math/range",o);function h(){this.addOutput("value","number"),this.addProperty("min",0),this.addProperty("max",1),this.size=[80,30]}h.title="Rand",h.desc="Random number",h.prototype.onExecute=function(){if(this.inputs)for(var E=0;E<this.inputs.length;E++){var Q=this.inputs[E],P=this.getInputData(E);P!==void 0&&(this.properties[Q.name]=P)}var H=this.properties.min,q=this.properties.max;this._last_v=Math.random()*(q-H)+H,this.setOutputData(0,this._last_v)},h.prototype.onDrawBackground=function(E){this.outputs[0].label=(this._last_v||0).toFixed(3)},h.prototype.onGetInputs=function(){return[["min","number"],["max","number"]]},t.registerNodeType("math/rand",h);function u(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("min",0),this.addProperty("max",1),this.addProperty("smooth",!0),this.addProperty("seed",0),this.addProperty("octaves",1),this.addProperty("persistence",.8),this.addProperty("speed",1),this.size=[90,30]}u.title="Noise",u.desc="Random number with temporal continuity",u.data=null,u.getValue=function(q,Q){if(!u.data){u.data=new Float32Array(1024);for(var P=0;P<u.data.length;++P)u.data[P]=Math.random()}q=q%1024,q<0&&(q+=1024);var H=Math.floor(q),q=q-H,st=u.data[H],vt=u.data[H==1023?0:H+1];return Q&&(q=q*q*q*(q*(q*6-15)+10)),st*(1-q)+vt*q},u.prototype.onExecute=function(){var E=this.getInputData(0)||0,Q=this.properties.octaves||1,P=0,H=1,q=this.properties.seed||0;E+=q;for(var st=this.properties.speed||1,vt=0,kt=0;kt<Q&&(P+=u.getValue(E*(1+kt)*st,this.properties.smooth)*H,vt+=H,H*=this.properties.persistence,!(H<.001));++kt);P/=vt;var Yt=this.properties.min,te=this.properties.max;this._last_v=P*(te-Yt)+Yt,this.setOutputData(0,this._last_v)},u.prototype.onDrawBackground=function(E){this.outputs[0].label=(this._last_v||0).toFixed(3)},t.registerNodeType("math/noise",u);function f(){this.addOutput("out","number"),this.addProperty("min_time",1),this.addProperty("max_time",2),this.addProperty("duration",.2),this.size=[90,30],this._remaining_time=0,this._blink_time=0}f.title="Spikes",f.desc="spike every random time",f.prototype.onExecute=function(){var E=this.graph.elapsed_time;this._remaining_time-=E,this._blink_time-=E;var Q=0;if(this._blink_time>0){var P=this._blink_time/this.properties.duration;Q=1/(Math.pow(P*8-4,4)+1)}this._remaining_time<0?(this._remaining_time=Math.random()*(this.properties.max_time-this.properties.min_time)+this.properties.min_time,this._blink_time=this.properties.duration,this.boxcolor="#FFF"):this.boxcolor="#000",this.setOutputData(0,Q)},t.registerNodeType("math/spikes",f);function c(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.addProperty("min",0),this.addProperty("max",1)}c.title="Clamp",c.desc="Clamp number between min and max",c.prototype.onExecute=function(){var E=this.getInputData(0);E!=null&&(E=Math.max(this.properties.min,E),E=Math.min(this.properties.max,E),this.setOutputData(0,E))},c.prototype.getCode=function(E){var Q="";return this.isInputConnected(0)&&(Q+="clamp({{0}},"+this.properties.min+","+this.properties.max+")"),Q},t.registerNodeType("math/clamp",c);function _(){this.properties={f:.5},this.addInput("A","number"),this.addInput("B","number"),this.addOutput("out","number")}_.title="Lerp",_.desc="Linear Interpolation",_.prototype.onExecute=function(){var E=this.getInputData(0);E==null&&(E=0);var Q=this.getInputData(1);Q==null&&(Q=0);var P=this.properties.f,H=this.getInputData(2);H!==void 0&&(P=H),this.setOutputData(0,E*(1-P)+Q*P)},_.prototype.onGetInputs=function(){return[["f","number"]]},t.registerNodeType("math/lerp",_);function O(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}O.title="Abs",O.desc="Absolute",O.prototype.onExecute=function(){var E=this.getInputData(0);E!=null&&this.setOutputData(0,Math.abs(E))},t.registerNodeType("math/abs",O);function d(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}d.title="Floor",d.desc="Floor number to remove fractional part",d.prototype.onExecute=function(){var E=this.getInputData(0);E!=null&&this.setOutputData(0,Math.floor(E))},t.registerNodeType("math/floor",d);function b(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}b.title="Frac",b.desc="Returns fractional part",b.prototype.onExecute=function(){var E=this.getInputData(0);E!=null&&this.setOutputData(0,E%1)},t.registerNodeType("math/frac",b);function S(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.properties={A:0,B:1}}S.title="Smoothstep",S.desc="Smoothstep",S.prototype.onExecute=function(){var E=this.getInputData(0);if(E!==void 0){var Q=this.properties.A,P=this.properties.B;E=clamp((E-Q)/(P-Q),0,1),E=E*E*(3-2*E),this.setOutputData(0,E)}},t.registerNodeType("math/smoothstep",S);function G(){this.addInput("in","number",{label:""}),this.addOutput("out","number",{label:""}),this.size=[80,30],this.addProperty("factor",1)}G.title="Scale",G.desc="v * factor",G.prototype.onExecute=function(){var E=this.getInputData(0);E!=null&&this.setOutputData(0,E*this.properties.factor)},t.registerNodeType("math/scale",G);function z(){this.addInput("v","boolean"),this.addInput("A"),this.addInput("B"),this.addOutput("out")}z.title="Gate",z.desc="if v is true, then outputs A, otherwise B",z.prototype.onExecute=function(){var E=this.getInputData(0);this.setOutputData(0,this.getInputData(E?1:2))},t.registerNodeType("math/gate",z);function $(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.addProperty("samples",10),this._values=new Float32Array(10),this._current=0}$.title="Average",$.desc="Average Filter",$.prototype.onExecute=function(){var E=this.getInputData(0);E==null&&(E=0);var Q=this._values.length;this._values[this._current%Q]=E,this._current+=1,this._current>Q&&(this._current=0);for(var P=0,H=0;H<Q;++H)P+=this._values[H];this.setOutputData(0,P/Q)},$.prototype.onPropertyChanged=function(E,Q){Q<1&&(Q=1),this.properties.samples=Math.round(Q);var P=this._values;this._values=new Float32Array(this.properties.samples),P.length<=this._values.length?this._values.set(P):this._values.set(P.subarray(0,this._values.length))},t.registerNodeType("math/average",$);function A(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("factor",.1),this.size=[80,30],this._value=null}A.title="TendTo",A.desc="moves the output value always closer to the input",A.prototype.onExecute=function(){var E=this.getInputData(0);E==null&&(E=0);var Q=this.properties.factor;this._value==null?this._value=E:this._value=this._value*(1-Q)+E*Q,this.setOutputData(0,this._value)},t.registerNodeType("math/tendTo",A);function l(){this.addInput("A","number,array,object"),this.addInput("B","number"),this.addOutput("=","number"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP","+","enum",{values:l.values}),this._func=l.funcs[this.properties.OP],this._result=[]}l.values=["+","-","*","/","%","^","max","min"],l.funcs={"+":function(E,Q){return E+Q},"-":function(E,Q){return E-Q},x:function(E,Q){return E*Q},X:function(E,Q){return E*Q},"*":function(E,Q){return E*Q},"/":function(E,Q){return E/Q},"%":function(E,Q){return E%Q},"^":function(E,Q){return Math.pow(E,Q)},max:function(E,Q){return Math.max(E,Q)},min:function(E,Q){return Math.min(E,Q)}},l.title="Operation",l.desc="Easy math operators",l["@OP"]={type:"enum",title:"operation",values:l.values},l.size=[100,60],l.prototype.getTitle=function(){return this.properties.OP=="max"||this.properties.OP=="min"?this.properties.OP+"(A,B)":"A "+this.properties.OP+" B"},l.prototype.setValue=function(E){typeof E=="string"&&(E=parseFloat(E)),this.properties.value=E},l.prototype.onPropertyChanged=function(E,Q){E=="OP"&&(this._func=l.funcs[this.properties.OP],this._func||(console.warn("Unknown operation: "+this.properties.OP),this._func=function(P){return P}))},l.prototype.onExecute=function(){var E=this.getInputData(0),Q=this.getInputData(1);E!=null?E.constructor===Number&&(this.properties.A=E):E=this.properties.A,Q!=null?this.properties.B=Q:Q=this.properties.B;var P=l.funcs[this.properties.OP],H;if(E.constructor===Number)H=0,H=P(E,Q);else if(E.constructor===Array){H=this._result,H.length=E.length;for(var q=0;q<E.length;++q)H[q]=P(E[q],Q)}else{H={};for(var q in E)H[q]=P(E[q],Q)}this.setOutputData(0,H)},l.prototype.onDrawBackground=function(E){this.flags.collapsed||(E.font="40px Arial",E.fillStyle="#666",E.textAlign="center",E.fillText(this.properties.OP,this.size[0]*.5,(this.size[1]+t.NODE_TITLE_HEIGHT)*.5),E.textAlign="left")},t.registerNodeType("math/operation",l),t.registerSearchboxExtra("math/operation","MAX",{properties:{OP:"max"},title:"MAX()"}),t.registerSearchboxExtra("math/operation","MIN",{properties:{OP:"min"},title:"MIN()"});function I(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("A==B","boolean"),this.addOutput("A!=B","boolean"),this.addProperty("A",0),this.addProperty("B",0)}I.title="Compare",I.desc="compares between two values",I.prototype.onExecute=function(){var E=this.getInputData(0),Q=this.getInputData(1);E!==void 0?this.properties.A=E:E=this.properties.A,Q!==void 0?this.properties.B=Q:Q=this.properties.B;for(var P=0,H=this.outputs.length;P<H;++P){var q=this.outputs[P];if(!(!q.links||!q.links.length)){var st;switch(q.name){case"A==B":st=E==Q;break;case"A!=B":st=E!=Q;break;case"A>B":st=E>Q;break;case"A<B":st=E<Q;break;case"A<=B":st=E<=Q;break;case"A>=B":st=E>=Q;break}this.setOutputData(P,st)}}},I.prototype.onGetOutputs=function(){return[["A==B","boolean"],["A!=B","boolean"],["A>B","boolean"],["A<B","boolean"],["A>=B","boolean"],["A<=B","boolean"]]},t.registerNodeType("math/compare",I),t.registerSearchboxExtra("math/compare","==",{outputs:[["A==B","boolean"]],title:"A==B"}),t.registerSearchboxExtra("math/compare","!=",{outputs:[["A!=B","boolean"]],title:"A!=B"}),t.registerSearchboxExtra("math/compare",">",{outputs:[["A>B","boolean"]],title:"A>B"}),t.registerSearchboxExtra("math/compare","<",{outputs:[["A<B","boolean"]],title:"A<B"}),t.registerSearchboxExtra("math/compare",">=",{outputs:[["A>=B","boolean"]],title:"A>=B"}),t.registerSearchboxExtra("math/compare","<=",{outputs:[["A<=B","boolean"]],title:"A<=B"});function T(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("true","boolean"),this.addOutput("false","boolean"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP",">","enum",{values:T.values}),this.addWidget("combo","Cond.",this.properties.OP,{property:"OP",values:T.values}),this.size=[80,60]}T.values=[">","<","==","!=","<=",">=","||","&&"],T["@OP"]={type:"enum",title:"operation",values:T.values},T.title="Condition",T.desc="evaluates condition between A and B",T.prototype.getTitle=function(){return"A "+this.properties.OP+" B"},T.prototype.onExecute=function(){var E=this.getInputData(0);E===void 0?E=this.properties.A:this.properties.A=E;var Q=this.getInputData(1);Q===void 0?Q=this.properties.B:this.properties.B=Q;var P=!0;switch(this.properties.OP){case">":P=E>Q;break;case"<":P=E<Q;break;case"==":P=E==Q;break;case"!=":P=E!=Q;break;case"<=":P=E<=Q;break;case">=":P=E>=Q;break;case"||":P=E||Q;break;case"&&":P=E&&Q;break}this.setOutputData(0,P),this.setOutputData(1,!P)},t.registerNodeType("math/condition",T);function L(){this.addInput("in",0),this.addInput("cond","boolean"),this.addOutput("true",0),this.addOutput("false",0),this.size=[80,60]}L.title="Branch",L.desc="If condition is true, outputs IN in true, otherwise in false",L.prototype.onExecute=function(){var E=this.getInputData(0),Q=this.getInputData(1);Q?(this.setOutputData(0,E),this.setOutputData(1,null)):(this.setOutputData(0,null),this.setOutputData(1,E))},t.registerNodeType("math/branch",L);function C(){this.addInput("inc","number"),this.addOutput("total","number"),this.addProperty("increment",1),this.addProperty("value",0)}C.title="Accumulate",C.desc="Increments a value every time",C.prototype.onExecute=function(){this.properties.value===null&&(this.properties.value=0);var E=this.getInputData(0);E!==null?this.properties.value+=E:this.properties.value+=this.properties.increment,this.setOutputData(0,this.properties.value)},t.registerNodeType("math/accumulate",C);function N(){this.addInput("v","number"),this.addOutput("sin","number"),this.addProperty("amplitude",1),this.addProperty("offset",0),this.bgImageUrl="nodes/imgs/icon-sin.png"}N.title="Trigonometry",N.desc="Sin Cos Tan",N.prototype.onExecute=function(){var E=this.getInputData(0);E==null&&(E=0);var Q=this.properties.amplitude,P=this.findInputSlot("amplitude");P!=-1&&(Q=this.getInputData(P));var H=this.properties.offset;P=this.findInputSlot("offset"),P!=-1&&(H=this.getInputData(P));for(var q=0,st=this.outputs.length;q<st;++q){var vt=this.outputs[q],kt;switch(vt.name){case"sin":kt=Math.sin(E);break;case"cos":kt=Math.cos(E);break;case"tan":kt=Math.tan(E);break;case"asin":kt=Math.asin(E);break;case"acos":kt=Math.acos(E);break;case"atan":kt=Math.atan(E);break}this.setOutputData(q,Q*kt+H)}},N.prototype.onGetInputs=function(){return[["v","number"],["amplitude","number"],["offset","number"]]},N.prototype.onGetOutputs=function(){return[["sin","number"],["cos","number"],["tan","number"],["asin","number"],["acos","number"],["atan","number"]]},t.registerNodeType("math/trigonometry",N),t.registerSearchboxExtra("math/trigonometry","SIN()",{outputs:[["sin","number"]],title:"SIN()"}),t.registerSearchboxExtra("math/trigonometry","COS()",{outputs:[["cos","number"]],title:"COS()"}),t.registerSearchboxExtra("math/trigonometry","TAN()",{outputs:[["tan","number"]],title:"TAN()"});function R(){this.addInput("x","number"),this.addInput("y","number"),this.addOutput("","number"),this.properties={x:1,y:1,formula:"x+y"},this.code_widget=this.addWidget("text","F(x,y)",this.properties.formula,function(E,Q,P){P.properties.formula=E}),this.addWidget("toggle","allow",t.allow_scripts,function(E){t.allow_scripts=E}),this._func=null}R.title="Formula",R.desc="Compute formula",R.size=[160,100],$.prototype.onPropertyChanged=function(E,Q){E=="formula"&&(this.code_widget.value=Q)},R.prototype.onExecute=function(){if(t.allow_scripts){var E=this.getInputData(0),Q=this.getInputData(1);E!=null?this.properties.x=E:E=this.properties.x,Q!=null?this.properties.y=Q:Q=this.properties.y,this.properties.formula;var P;try{(!this._func||this._func_code!=this.properties.formula)&&(this._func=new Function("x","y","TIME","return "+this.properties.formula),this._func_code=this.properties.formula),P=this._func(E,Q,this.graph.globaltime),this.boxcolor=null}catch{this.boxcolor="red"}this.setOutputData(0,P)}},R.prototype.getTitle=function(){return this._func_code||"Formula"},R.prototype.onDrawBackground=function(){var E=this.properties.formula;this.outputs&&this.outputs.length&&(this.outputs[0].label=E)},t.registerNodeType("math/formula",R);function Y(){this.addInput("vec2","vec2"),this.addOutput("x","number"),this.addOutput("y","number")}Y.title="Vec2->XY",Y.desc="vector 2 to components",Y.prototype.onExecute=function(){var E=this.getInputData(0);E!=null&&(this.setOutputData(0,E[0]),this.setOutputData(1,E[1]))},t.registerNodeType("math3d/vec2-to-xy",Y);function ut(){this.addInputs([["x","number"],["y","number"]]),this.addOutput("vec2","vec2"),this.properties={x:0,y:0},this._data=new Float32Array(2)}ut.title="XY->Vec2",ut.desc="components to vector2",ut.prototype.onExecute=function(){var E=this.getInputData(0);E==null&&(E=this.properties.x);var Q=this.getInputData(1);Q==null&&(Q=this.properties.y);var P=this._data;P[0]=E,P[1]=Q,this.setOutputData(0,P)},t.registerNodeType("math3d/xy-to-vec2",ut);function mt(){this.addInput("vec3","vec3"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number")}mt.title="Vec3->XYZ",mt.desc="vector 3 to components",mt.prototype.onExecute=function(){var E=this.getInputData(0);E!=null&&(this.setOutputData(0,E[0]),this.setOutputData(1,E[1]),this.setOutputData(2,E[2]))},t.registerNodeType("math3d/vec3-to-xyz",mt);function yt(){this.addInputs([["x","number"],["y","number"],["z","number"]]),this.addOutput("vec3","vec3"),this.properties={x:0,y:0,z:0},this._data=new Float32Array(3)}yt.title="XYZ->Vec3",yt.desc="components to vector3",yt.prototype.onExecute=function(){var E=this.getInputData(0);E==null&&(E=this.properties.x);var Q=this.getInputData(1);Q==null&&(Q=this.properties.y);var P=this.getInputData(2);P==null&&(P=this.properties.z);var H=this._data;H[0]=E,H[1]=Q,H[2]=P,this.setOutputData(0,H)},t.registerNodeType("math3d/xyz-to-vec3",yt);function D(){this.addInput("vec4","vec4"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number"),this.addOutput("w","number")}D.title="Vec4->XYZW",D.desc="vector 4 to components",D.prototype.onExecute=function(){var E=this.getInputData(0);E!=null&&(this.setOutputData(0,E[0]),this.setOutputData(1,E[1]),this.setOutputData(2,E[2]),this.setOutputData(3,E[3]))},t.registerNodeType("math3d/vec4-to-xyzw",D);function F(){this.addInputs([["x","number"],["y","number"],["z","number"],["w","number"]]),this.addOutput("vec4","vec4"),this.properties={x:0,y:0,z:0,w:0},this._data=new Float32Array(4)}F.title="XYZW->Vec4",F.desc="components to vector4",F.prototype.onExecute=function(){var E=this.getInputData(0);E==null&&(E=this.properties.x);var Q=this.getInputData(1);Q==null&&(Q=this.properties.y);var P=this.getInputData(2);P==null&&(P=this.properties.z);var H=this.getInputData(3);H==null&&(H=this.properties.w);var q=this._data;q[0]=E,q[1]=Q,q[2]=P,q[3]=H,this.setOutputData(0,q)},t.registerNodeType("math3d/xyzw-to-vec4",F)}(commonjsGlobal),function(e){var t=e.LiteGraph;function n(){this.addInput("T","vec3"),this.addInput("R","vec3"),this.addInput("S","vec3"),this.addOutput("mat4","mat4"),this.properties={T:[0,0,0],R:[0,0,0],S:[1,1,1],R_in_degrees:!0},this._result=mat4.create(),this._must_update=!0}n.title="mat4",n.temp_quat=new Float32Array([0,0,0,1]),n.temp_mat4=new Float32Array(16),n.temp_vec3=new Float32Array(3),n.prototype.onPropertyChanged=function(c,_){this._must_update=!0},n.prototype.onExecute=function(){var c=this._result,_=n.temp_quat,O=n.temp_mat4,d=n.temp_vec3,b=this.getInputData(0),S=this.getInputData(1),G=this.getInputData(2);(this._must_update||b||S||G)&&(b=b||this.properties.T,S=S||this.properties.R,G=G||this.properties.S,mat4.identity(c),mat4.translate(c,c,b),this.properties.R_in_degrees?(d.set(S),vec3.scale(d,d,DEG2RAD),quat.fromEuler(_,d)):quat.fromEuler(_,S),mat4.fromQuat(O,_),mat4.multiply(c,c,O),mat4.scale(c,c,G)),this.setOutputData(0,c)},t.registerNodeType("math3d/mat4",n);function r(){this.addInput("A","number,vec3"),this.addInput("B","number,vec3"),this.addOutput("=","number,vec3"),this.addProperty("OP","+","enum",{values:r.values}),this._result=vec3.create()}r.values=["+","-","*","/","%","^","max","min","dot","cross"],t.registerSearchboxExtra("math3d/operation","CROSS()",{properties:{OP:"cross"},title:"CROSS()"}),t.registerSearchboxExtra("math3d/operation","DOT()",{properties:{OP:"dot"},title:"DOT()"}),r.title="Operation",r.desc="Easy math 3D operators",r["@OP"]={type:"enum",title:"operation",values:r.values},r.size=[100,60],r.prototype.getTitle=function(){return this.properties.OP=="max"||this.properties.OP=="min"?this.properties.OP+"(A,B)":"A "+this.properties.OP+" B"},r.prototype.onExecute=function(){var c=this.getInputData(0),_=this.getInputData(1);if(!(c==null||_==null)){c.constructor===Number&&(c=[c,c,c]),_.constructor===Number&&(_=[_,_,_]);var O=this._result;switch(this.properties.OP){case"+":O=vec3.add(O,c,_);break;case"-":O=vec3.sub(O,c,_);break;case"x":case"X":case"*":O=vec3.mul(O,c,_);break;case"/":O=vec3.div(O,c,_);break;case"%":O[0]=c[0]%_[0],O[1]=c[1]%_[1],O[2]=c[2]%_[2];break;case"^":O[0]=Math.pow(c[0],_[0]),O[1]=Math.pow(c[1],_[1]),O[2]=Math.pow(c[2],_[2]);break;case"max":O[0]=Math.max(c[0],_[0]),O[1]=Math.max(c[1],_[1]),O[2]=Math.max(c[2],_[2]);break;case"min":O[0]=Math.min(c[0],_[0]),O[1]=Math.min(c[1],_[1]),O[2]=Math.min(c[2],_[2]);case"dot":O=vec3.dot(c,_);break;case"cross":vec3.cross(O,c,_);break;default:console.warn("Unknown operation: "+this.properties.OP)}this.setOutputData(0,O)}},r.prototype.onDrawBackground=function(c){this.flags.collapsed||(c.font="40px Arial",c.fillStyle="#666",c.textAlign="center",c.fillText(this.properties.OP,this.size[0]*.5,(this.size[1]+t.NODE_TITLE_HEIGHT)*.5),c.textAlign="left")},t.registerNodeType("math3d/operation",r);function s(){this.addInput("in","vec3"),this.addInput("f","number"),this.addOutput("out","vec3"),this.properties={f:1},this._data=new Float32Array(3)}s.title="vec3_scale",s.desc="scales the components of a vec3",s.prototype.onExecute=function(){var c=this.getInputData(0);if(c!=null){var _=this.getInputData(1);_==null&&(_=this.properties.f);var O=this._data;O[0]=c[0]*_,O[1]=c[1]*_,O[2]=c[2]*_,this.setOutputData(0,O)}},t.registerNodeType("math3d/vec3-scale",s);function o(){this.addInput("in","vec3"),this.addOutput("out","number")}o.title="vec3_length",o.desc="returns the module of a vector",o.prototype.onExecute=function(){var c=this.getInputData(0);if(c!=null){var _=Math.sqrt(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]);this.setOutputData(0,_)}},t.registerNodeType("math3d/vec3-length",o);function h(){this.addInput("in","vec3"),this.addOutput("out","vec3"),this._data=new Float32Array(3)}h.title="vec3_normalize",h.desc="returns the vector normalized",h.prototype.onExecute=function(){var c=this.getInputData(0);if(c!=null){var _=Math.sqrt(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]),O=this._data;O[0]=c[0]/_,O[1]=c[1]/_,O[2]=c[2]/_,this.setOutputData(0,O)}},t.registerNodeType("math3d/vec3-normalize",h);function u(){this.addInput("A","vec3"),this.addInput("B","vec3"),this.addInput("f","vec3"),this.addOutput("out","vec3"),this.properties={f:.5},this._data=new Float32Array(3)}u.title="vec3_lerp",u.desc="returns the interpolated vector",u.prototype.onExecute=function(){var c=this.getInputData(0);if(c!=null){var _=this.getInputData(1);if(_!=null){var O=this.getInputOrProperty("f"),d=this._data;d[0]=c[0]*(1-O)+_[0]*O,d[1]=c[1]*(1-O)+_[1]*O,d[2]=c[2]*(1-O)+_[2]*O,this.setOutputData(0,d)}}},t.registerNodeType("math3d/vec3-lerp",u);function f(){this.addInput("A","vec3"),this.addInput("B","vec3"),this.addOutput("out","number")}if(f.title="vec3_dot",f.desc="returns the dot product",f.prototype.onExecute=function(){var c=this.getInputData(0);if(c!=null){var _=this.getInputData(1);if(_!=null){var O=c[0]*_[0]+c[1]*_[1]+c[2]*_[2];this.setOutputData(0,O)}}},t.registerNodeType("math3d/vec3-dot",f),e.glMatrix){let c=function(){this.addOutput("quat","quat"),this.properties={x:0,y:0,z:0,w:1,normalize:!1},this._value=quat.create()},_=function(){this.addInputs([["degrees","number"],["axis","vec3"]]),this.addOutput("quat","quat"),this.properties={angle:90,axis:vec3.fromValues(0,1,0)},this._value=quat.create()},O=function(){this.addInput("euler","vec3"),this.addOutput("quat","quat"),this.properties={euler:[0,0,0],use_yaw_pitch_roll:!1},this._degs=vec3.create(),this._value=quat.create()},d=function(){this.addInput(["quat","quat"]),this.addOutput("euler","vec3"),this._value=vec3.create()},b=function(){this.addInputs([["vec3","vec3"],["quat","quat"]]),this.addOutput("result","vec3"),this.properties={vec:[0,0,1]}},S=function(){this.addInputs([["A","quat"],["B","quat"]]),this.addOutput("A*B","quat"),this._value=quat.create()},G=function(){this.addInputs([["A","quat"],["B","quat"],["factor","number"]]),this.addOutput("slerp","quat"),this.addProperty("factor",.5),this._value=quat.create()},z=function(){this.addInput("vec3","vec3"),this.addOutput("remap","vec3"),this.addOutput("clamped","vec3"),this.properties={clamp:!0,range_min:[-1,-1,0],range_max:[1,1,0],target_min:[-1,-1,0],target_max:[1,1,0]},this._value=vec3.create(),this._clamped=vec3.create()};c.title="Quaternion",c.desc="quaternion",c.prototype.onExecute=function(){this._value[0]=this.getInputOrProperty("x"),this._value[1]=this.getInputOrProperty("y"),this._value[2]=this.getInputOrProperty("z"),this._value[3]=this.getInputOrProperty("w"),this.properties.normalize&&quat.normalize(this._value,this._value),this.setOutputData(0,this._value)},c.prototype.onGetInputs=function(){return[["x","number"],["y","number"],["z","number"],["w","number"]]},t.registerNodeType("math3d/quaternion",c),_.title="Rotation",_.desc="quaternion rotation",_.prototype.onExecute=function(){var $=this.getInputData(0);$==null&&($=this.properties.angle);var A=this.getInputData(1);A==null&&(A=this.properties.axis);var l=quat.setAxisAngle(this._value,A,$*.0174532925);this.setOutputData(0,l)},t.registerNodeType("math3d/rotation",_),O.title="Euler->Quat",O.desc="Converts euler angles (in degrees) to quaternion",O.prototype.onExecute=function(){var $=this.getInputData(0);$==null&&($=this.properties.euler),vec3.scale(this._degs,$,DEG2RAD),this.properties.use_yaw_pitch_roll&&(this._degs=[this._degs[2],this._degs[0],this._degs[1]]);var A=quat.fromEuler(this._value,this._degs);this.setOutputData(0,A)},t.registerNodeType("math3d/euler_to_quat",O),d.title="Euler->Quat",d.desc="Converts rotX,rotY,rotZ in degrees to quat",d.prototype.onExecute=function(){var $=this.getInputData(0);$&&(quat.toEuler(this._value,$),vec3.scale(this._value,this._value,DEG2RAD),this.setOutputData(0,this._value))},t.registerNodeType("math3d/quat_to_euler",d),b.title="Rot. Vec3",b.desc="rotate a point",b.prototype.onExecute=function(){var $=this.getInputData(0);$==null&&($=this.properties.vec);var A=this.getInputData(1);A==null?this.setOutputData($):this.setOutputData(0,vec3.transformQuat(vec3.create(),$,A))},t.registerNodeType("math3d/rotate_vec3",b),S.title="Mult. Quat",S.desc="rotate quaternion",S.prototype.onExecute=function(){var $=this.getInputData(0);if($!=null){var A=this.getInputData(1);if(A!=null){var l=quat.multiply(this._value,$,A);this.setOutputData(0,l)}}},t.registerNodeType("math3d/mult-quat",S),G.title="Quat Slerp",G.desc="quaternion spherical interpolation",G.prototype.onExecute=function(){var $=this.getInputData(0);if($!=null){var A=this.getInputData(1);if(A!=null){var l=this.properties.factor;this.getInputData(2)!=null&&(l=this.getInputData(2));var I=quat.slerp(this._value,$,A,l);this.setOutputData(0,I)}}},t.registerNodeType("math3d/quat-slerp",G),z.title="Remap Range",z.desc="remap a 3D range",z.prototype.onExecute=function(){var $=this.getInputData(0);$&&this._value.set($);for(var A=this.properties.range_min,l=this.properties.range_max,I=this.properties.target_min,T=this.properties.target_max,L=0;L<3;++L){var C=l[L]-A[L];if(this._clamped[L]=clamp(this._value[L],A[L],l[L]),C==0){this._value[L]=(I[L]+T[L])*.5;continue}var N=(this._value[L]-A[L])/C;this.properties.clamp&&(N=clamp(N,0,1));var R=T[L]-I[L];this._value[L]=I[L]+N*R}this.setOutputData(0,this._value),this.setOutputData(1,this._clamped)},t.registerNodeType("math3d/remap_range",z)}else t.debug&&console.warn("No glmatrix found, some Math3D nodes may not work")}(commonjsGlobal),function(e){var t=e.LiteGraph;function n(_){if(_&&_.constructor===Object)try{return JSON.stringify(_)}catch{return String(_)}return String(_)}t.wrapFunctionAsNode("string/toString",n,[""],"string");function r(_,O){return _==O}t.wrapFunctionAsNode("string/compare",r,["string","string"],"boolean");function s(_,O){return _===void 0?O:O===void 0?_:_+O}t.wrapFunctionAsNode("string/concatenate",s,["string","string"],"string");function o(_,O){return _===void 0||O===void 0?!1:_.indexOf(O)!=-1}t.wrapFunctionAsNode("string/contains",o,["string","string"],"boolean");function h(_){return _!=null&&_.constructor===String?_.toUpperCase():_}t.wrapFunctionAsNode("string/toUpperCase",h,["string"],"string");function u(_,O){if(O==null&&(O=this.properties.separator),_==null)return[];if(_.constructor===String)return _.split(O||" ");if(_.constructor===Array){for(var d=[],b=0;b<_.length;++b)typeof _[b]=="string"&&(d[b]=_[b].split(O||" "));return d}return null}t.wrapFunctionAsNode("string/split",u,["string,array","string"],"array",{separator:","});function f(_){return _!=null&&_.constructor===Number?_.toFixed(this.properties.precision):_}t.wrapFunctionAsNode("string/toFixed",f,["number"],"string",{precision:0});function c(){this.addInput("","string"),this.addOutput("table","table"),this.addOutput("rows","number"),this.addProperty("value",""),this.addProperty("separator",","),this._table=null}c.title="toTable",c.desc="Splits a string to table",c.prototype.onExecute=function(){var _=this.getInputData(0);if(_){var O=this.properties.separator||",";(_!=this._str||O!=this._last_separator)&&(this._last_separator=O,this._str=_,this._table=_.split(`
`).map(function(d){return d.trim().split(O)})),this.setOutputData(0,this._table),this.setOutputData(1,this._table?this._table.length:0)}},t.registerNodeType("string/toTable",c)}(commonjsGlobal),function(e){var t=e.LiteGraph;function n(){this.addInput("sel","number"),this.addInput("A"),this.addInput("B"),this.addInput("C"),this.addInput("D"),this.addOutput("out"),this.selected=0}n.title="Selector",n.desc="selects an output",n.prototype.onDrawBackground=function(c){if(!this.flags.collapsed){c.fillStyle="#AFB";var _=(this.selected+1)*t.NODE_SLOT_HEIGHT+6;c.beginPath(),c.moveTo(50,_),c.lineTo(50,_+t.NODE_SLOT_HEIGHT),c.lineTo(34,_+t.NODE_SLOT_HEIGHT*.5),c.fill()}},n.prototype.onExecute=function(){var c=this.getInputData(0);(c==null||c.constructor!==Number)&&(c=0),this.selected=c=Math.round(c)%(this.inputs.length-1);var _=this.getInputData(c+1);_!==void 0&&this.setOutputData(0,_)},n.prototype.onGetInputs=function(){return[["E",0],["F",0],["G",0],["H",0]]},t.registerNodeType("logic/selector",n);function r(){this.properties={sequence:"A,B,C"},this.addInput("index","number"),this.addInput("seq"),this.addOutput("out"),this.index=0,this.values=this.properties.sequence.split(",")}r.title="Sequence",r.desc="select one element from a sequence from a string",r.prototype.onPropertyChanged=function(c,_){c=="sequence"&&(this.values=_.split(","))},r.prototype.onExecute=function(){var c=this.getInputData(1);c&&c!=this.current_sequence&&(this.values=c.split(","),this.current_sequence=c);var _=this.getInputData(0);_==null&&(_=0),this.index=_=Math.round(_)%this.values.length,this.setOutputData(0,this.values[_])},t.registerNodeType("logic/sequence",r);function s(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}s.title="AND",s.desc="Return true if all inputs are true",s.prototype.onExecute=function(){var c=!0;for(var _ in this.inputs)if(!this.getInputData(_)){var c=!1;break}this.setOutputData(0,c)},s.prototype.onGetInputs=function(){return[["and","boolean"]]},t.registerNodeType("logic/AND",s);function o(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}o.title="OR",o.desc="Return true if at least one input is true",o.prototype.onExecute=function(){var c=!1;for(var _ in this.inputs)if(this.getInputData(_)){c=!0;break}this.setOutputData(0,c)},o.prototype.onGetInputs=function(){return[["or","boolean"]]},t.registerNodeType("logic/OR",o);function h(){this.properties={},this.addInput("in","boolean"),this.addOutput("out","boolean")}h.title="NOT",h.desc="Return the logical negation",h.prototype.onExecute=function(){var c=!this.getInputData(0);this.setOutputData(0,c)},t.registerNodeType("logic/NOT",h);function u(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}u.title="bool == bool",u.desc="Compare for logical equality",u.prototype.onExecute=function(){var c=null,_=!0;for(var O in this.inputs)if(c===null)c=this.getInputData(O);else if(c!=this.getInputData(O)){_=!1;break}this.setOutputData(0,_)},u.prototype.onGetInputs=function(){return[["bool","boolean"]]},t.registerNodeType("logic/CompareBool",u);function f(){this.properties={},this.addInput("onTrigger",t.ACTION),this.addInput("condition","boolean"),this.addOutput("true",t.EVENT),this.addOutput("false",t.EVENT),this.mode=t.ON_TRIGGER}f.title="Branch",f.desc="Branch execution on condition",f.prototype.onExecute=function(c,_){var O=this.getInputData(1);O?this.triggerSlot(0):this.triggerSlot(1)},t.registerNodeType("logic/IF",f)}(commonjsGlobal),function(e){var t=e.LiteGraph;function n(){this.addInput("A","Number"),this.addInput("B","Number"),this.addInput("C","Number"),this.addInput("D","Number"),this.values=[[],[],[],[]],this.properties={scale:2}}n.title="Plot",n.desc="Plots data over time",n.colors=["#FFF","#F99","#9F9","#99F"],n.prototype.onExecute=function(b){if(!this.flags.collapsed)for(var S=this.size,G=0;G<4;++G){var z=this.getInputData(G);if(z!=null){var $=this.values[G];$.push(z),$.length>S[0]&&$.shift()}}},n.prototype.onDrawBackground=function(b){if(!this.flags.collapsed){var S=this.size,G=.5*S[1]/this.properties.scale,z=n.colors,$=S[1]*.5;if(b.fillStyle="#000",b.fillRect(0,0,S[0],S[1]),b.strokeStyle="#555",b.beginPath(),b.moveTo(0,$),b.lineTo(S[0],$),b.stroke(),this.inputs)for(var A=0;A<4;++A){var l=this.values[A];if(!(!this.inputs[A]||!this.inputs[A].link)){b.strokeStyle=z[A],b.beginPath();var I=l[0]*G*-1+$;b.moveTo(0,clamp(I,0,S[1]));for(var T=1;T<l.length&&T<S[0];++T){var I=l[T]*G*-1+$;b.lineTo(T,clamp(I,0,S[1]))}b.stroke()}}}},t.registerNodeType("graphics/plot",n);function r(){this.addOutput("frame","image"),this.properties={url:""}}r.title="Image",r.desc="Image loader",r.widgets=[{name:"load",text:"Load",type:"button"}],r.supported_extensions=["jpg","jpeg","png","gif"],r.prototype.onAdded=function(){this.properties.url!=""&&this.img==null&&this.loadImage(this.properties.url)},r.prototype.onDrawBackground=function(b){this.flags.collapsed||this.img&&this.size[0]>5&&this.size[1]>5&&this.img.width&&b.drawImage(this.img,0,0,this.size[0],this.size[1])},r.prototype.onExecute=function(){this.img||(this.boxcolor="#000"),this.img&&this.img.width?this.setOutputData(0,this.img):this.setOutputData(0,null),this.img&&this.img.dirty&&(this.img.dirty=!1)},r.prototype.onPropertyChanged=function(b,S){return this.properties[b]=S,b=="url"&&S!=""&&this.loadImage(S),!0},r.prototype.loadImage=function(b,S){if(b==""){this.img=null;return}this.img=document.createElement("img"),b.substr(0,4)=="http"&&t.proxy&&(b=t.proxy+b.substr(b.indexOf(":")+3)),this.img.src=b,this.boxcolor="#F95";var G=this;this.img.onload=function(){S&&S(this),console.log("Image loaded, size: "+G.img.width+"x"+G.img.height),this.dirty=!0,G.boxcolor="#9F9",G.setDirtyCanvas(!0)},this.img.onerror=function(){console.log("error loading the image:"+b)}},r.prototype.onWidget=function(b,S){S.name=="load"&&this.loadImage(this.properties.url)},r.prototype.onDropFile=function(b){var S=this;this._url&&URL.revokeObjectURL(this._url),this._url=URL.createObjectURL(b),this.properties.url=this._url,this.loadImage(this._url,function(G){S.size[1]=G.height/G.width*S.size[0]})},t.registerNodeType("graphics/image",r);function s(){this.addInput("f","number"),this.addOutput("Color","color"),this.properties={colorA:"#444444",colorB:"#44AAFF",colorC:"#44FFAA",colorD:"#FFFFFF"}}s.title="Palette",s.desc="Generates a color",s.prototype.onExecute=function(){var b=[];this.properties.colorA!=null&&b.push(hex2num(this.properties.colorA)),this.properties.colorB!=null&&b.push(hex2num(this.properties.colorB)),this.properties.colorC!=null&&b.push(hex2num(this.properties.colorC)),this.properties.colorD!=null&&b.push(hex2num(this.properties.colorD));var S=this.getInputData(0);if(S==null&&(S=.5),S>1?S=1:S<0&&(S=0),b.length!=0){var G=[0,0,0];if(S==0)G=b[0];else if(S==1)G=b[b.length-1];else{var z=(b.length-1)*S,$=b[Math.floor(z)],A=b[Math.floor(z)+1],l=z-Math.floor(z);G[0]=$[0]*(1-l)+A[0]*l,G[1]=$[1]*(1-l)+A[1]*l,G[2]=$[2]*(1-l)+A[2]*l}for(var I=0;I<G.length;I++)G[I]/=255;this.boxcolor=colorToString(G),this.setOutputData(0,G)}},t.registerNodeType("color/palette",s);function o(){this.addInput("","image,canvas"),this.size=[200,200]}o.title="Frame",o.desc="Frame viewerew",o.widgets=[{name:"resize",text:"Resize box",type:"button"},{name:"view",text:"View Image",type:"button"}],o.prototype.onDrawBackground=function(b){this.frame&&!this.flags.collapsed&&b.drawImage(this.frame,0,0,this.size[0],this.size[1])},o.prototype.onExecute=function(){this.frame=this.getInputData(0),this.setDirtyCanvas(!0)},o.prototype.onWidget=function(b,S){if(S.name=="resize"&&this.frame){var G=this.frame.width,z=this.frame.height;!G&&this.frame.videoWidth!=null&&(G=this.frame.videoWidth,z=this.frame.videoHeight),G&&z&&(this.size=[G,z]),this.setDirtyCanvas(!0,!0)}else S.name=="view"&&this.show()},o.prototype.show=function(){showElement&&this.frame&&showElement(this.frame)},t.registerNodeType("graphics/frame",o);function h(){this.addInputs([["img1","image"],["img2","image"],["fade","number"]]),this.addOutput("","image"),this.properties={fade:.5,width:512,height:512}}h.title="Image fade",h.desc="Fades between images",h.widgets=[{name:"resizeA",text:"Resize to A",type:"button"},{name:"resizeB",text:"Resize to B",type:"button"}],h.prototype.onAdded=function(){this.createCanvas();var b=this.canvas.getContext("2d");b.fillStyle="#000",b.fillRect(0,0,this.properties.width,this.properties.height)},h.prototype.createCanvas=function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.properties.width,this.canvas.height=this.properties.height},h.prototype.onExecute=function(){var b=this.canvas.getContext("2d");this.canvas.width=this.canvas.width;var S=this.getInputData(0);S!=null&&b.drawImage(S,0,0,this.canvas.width,this.canvas.height);var G=this.getInputData(2);G==null?G=this.properties.fade:this.properties.fade=G,b.globalAlpha=G;var z=this.getInputData(1);z!=null&&b.drawImage(z,0,0,this.canvas.width,this.canvas.height),b.globalAlpha=1,this.setOutputData(0,this.canvas),this.setDirtyCanvas(!0)},t.registerNodeType("graphics/imagefade",h);function u(){this.addInput("","image"),this.addOutput("","image"),this.properties={width:256,height:256,x:0,y:0,scale:1},this.size=[50,20]}u.title="Crop",u.desc="Crop Image",u.prototype.onAdded=function(){this.createCanvas()},u.prototype.createCanvas=function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.properties.width,this.canvas.height=this.properties.height},u.prototype.onExecute=function(){var b=this.getInputData(0);if(b)if(b.width){var S=this.canvas.getContext("2d");S.drawImage(b,-this.properties.x,-this.properties.y,b.width*this.properties.scale,b.height*this.properties.scale),this.setOutputData(0,this.canvas)}else this.setOutputData(0,null)},u.prototype.onDrawBackground=function(b){this.flags.collapsed||this.canvas&&b.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,this.size[0],this.size[1])},u.prototype.onPropertyChanged=function(b,S){return this.properties[b]=S,b=="scale"?(this.properties[b]=parseFloat(S),this.properties[b]==0&&(console.error("Error in scale"),this.properties[b]=1)):this.properties[b]=parseInt(S),this.createCanvas(),!0},t.registerNodeType("graphics/cropImage",u);function f(){this.addInput("clear",t.ACTION),this.addOutput("","canvas"),this.properties={width:512,height:512,autoclear:!0},this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d")}f.title="Canvas",f.desc="Canvas to render stuff",f.prototype.onExecute=function(){var b=this.canvas,S=this.properties.width|0,G=this.properties.height|0;b.width!=S&&(b.width=S),b.height!=G&&(b.height=G),this.properties.autoclear&&this.ctx.clearRect(0,0,b.width,b.height),this.setOutputData(0,b)},f.prototype.onAction=function(b,S){b=="clear"&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)},t.registerNodeType("graphics/canvas",f);function c(){this.addInput("canvas","canvas"),this.addInput("img","image,canvas"),this.addInput("x","number"),this.addInput("y","number"),this.properties={x:0,y:0,opacity:1}}c.title="DrawImage",c.desc="Draws image into a canvas",c.prototype.onExecute=function(){var b=this.getInputData(0);if(b){var S=this.getInputOrProperty("img");if(S){var G=this.getInputOrProperty("x"),z=this.getInputOrProperty("y"),$=b.getContext("2d");$.drawImage(S,G,z)}}},t.registerNodeType("graphics/drawImage",c);function _(){this.addInput("canvas","canvas"),this.addInput("x","number"),this.addInput("y","number"),this.addInput("w","number"),this.addInput("h","number"),this.properties={x:0,y:0,w:10,h:10,color:"white",opacity:1}}_.title="DrawRectangle",_.desc="Draws rectangle in canvas",_.prototype.onExecute=function(){var b=this.getInputData(0);if(b){var S=this.getInputOrProperty("x"),G=this.getInputOrProperty("y"),z=this.getInputOrProperty("w"),$=this.getInputOrProperty("h"),A=b.getContext("2d");A.fillRect(S,G,z,$)}},t.registerNodeType("graphics/drawRectangle",_);function O(){this.addInput("t","number"),this.addOutputs([["frame","image"],["t","number"],["d","number"]]),this.properties={url:"",use_proxy:!0}}O.title="Video",O.desc="Video playback",O.widgets=[{name:"play",text:"PLAY",type:"minibutton"},{name:"stop",text:"STOP",type:"minibutton"},{name:"demo",text:"Demo video",type:"button"},{name:"mute",text:"Mute video",type:"button"}],O.prototype.onExecute=function(){if(this.properties.url&&(this.properties.url!=this._video_url&&this.loadVideo(this.properties.url),!(!this._video||this._video.width==0))){var b=this.getInputData(0);b&&b>=0&&b<=1&&(this._video.currentTime=b*this._video.duration,this._video.pause()),this._video.dirty=!0,this.setOutputData(0,this._video),this.setOutputData(1,this._video.currentTime),this.setOutputData(2,this._video.duration),this.setDirtyCanvas(!0)}},O.prototype.onStart=function(){this.play()},O.prototype.onStop=function(){this.stop()},O.prototype.loadVideo=function(b){this._video_url=b;var S=b.substr(0,10).indexOf(":"),G="";S!=-1&&(G=b.substr(0,S));var z="";G&&(z=b.substr(0,b.indexOf("/",G.length+3)),z=z.substr(G.length+3)),this.properties.use_proxy&&G&&t.proxy&&z!=location.host&&(b=t.proxy+b.substr(b.indexOf(":")+3)),this._video=document.createElement("video"),this._video.src=b,this._video.type="type=video/mp4",this._video.muted=!0,this._video.autoplay=!0;var $=this;this._video.addEventListener("loadedmetadata",function(A){console.log("Duration: "+this.duration+" seconds"),console.log("Size: "+this.videoWidth+","+this.videoHeight),$.setDirtyCanvas(!0),this.width=this.videoWidth,this.height=this.videoHeight}),this._video.addEventListener("progress",function(A){console.log("video loading...")}),this._video.addEventListener("error",function(A){if(console.error("Error loading video: "+this.src),this.error)switch(this.error.code){case this.error.MEDIA_ERR_ABORTED:console.error("You stopped the video.");break;case this.error.MEDIA_ERR_NETWORK:console.error("Network error - please try again later.");break;case this.error.MEDIA_ERR_DECODE:console.error("Video is broken..");break;case this.error.MEDIA_ERR_SRC_NOT_SUPPORTED:console.error("Sorry, your browser can't play this video.");break}}),this._video.addEventListener("ended",function(A){console.log("Video Ended."),this.play()})},O.prototype.onPropertyChanged=function(b,S){return this.properties[b]=S,b=="url"&&S!=""&&this.loadVideo(S),!0},O.prototype.play=function(){this._video&&this._video.videoWidth&&this._video.play()},O.prototype.playPause=function(){this._video&&(this._video.paused?this.play():this.pause())},O.prototype.stop=function(){this._video&&(this._video.pause(),this._video.currentTime=0)},O.prototype.pause=function(){this._video&&(console.log("Video paused"),this._video.pause())},O.prototype.onWidget=function(b,S){},t.registerNodeType("graphics/video",O);function d(){this.addOutput("Webcam","image"),this.properties={filterFacingMode:!1,facingMode:"user"},this.boxcolor="black",this.frame=0}d.title="Webcam",d.desc="Webcam image",d.is_webcam_open=!1,d.prototype.openStream=function(){if(!navigator.mediaDevices.getUserMedia){console.log("getUserMedia() is not supported in your browser, use chrome and enable WebRTC from about://flags");return}this._waiting_confirmation=!0;var b={audio:!1,video:this.properties.filterFacingMode?{facingMode:this.properties.facingMode}:!0};navigator.mediaDevices.getUserMedia(b).then(this.streamReady.bind(this)).catch(G);var S=this;function G(z){console.log("Webcam rejected",z),S._webcam_stream=!1,d.is_webcam_open=!1,S.boxcolor="red",S.trigger("stream_error")}},d.prototype.closeStream=function(){if(this._webcam_stream){var b=this._webcam_stream.getTracks();if(b.length)for(var S=0;S<b.length;++S)b[S].stop();d.is_webcam_open=!1,this._webcam_stream=null,this._video=null,this.boxcolor="black",this.trigger("stream_closed")}},d.prototype.onPropertyChanged=function(b,S){b=="facingMode"&&(this.properties.facingMode=S,this.closeStream(),this.openStream())},d.prototype.onRemoved=function(){this.closeStream()},d.prototype.streamReady=function(b){this._webcam_stream=b,this.boxcolor="green";var S=this._video;S||(S=document.createElement("video"),S.autoplay=!0,S.srcObject=b,this._video=S,S.onloadedmetadata=function(G){console.log(G),d.is_webcam_open=!0}),this.trigger("stream_ready",S)},d.prototype.onExecute=function(){if(this._webcam_stream==null&&!this._waiting_confirmation&&this.openStream(),!(!this._video||!this._video.videoWidth)){this._video.frame=++this.frame,this._video.width=this._video.videoWidth,this._video.height=this._video.videoHeight,this.setOutputData(0,this._video);for(var b=1;b<this.outputs.length;++b)if(this.outputs[b])switch(this.outputs[b].name){case"width":this.setOutputData(b,this._video.videoWidth);break;case"height":this.setOutputData(b,this._video.videoHeight);break}}},d.prototype.getExtraMenuOptions=function(b){var S=this,G=S.properties.show?"Hide Frame":"Show Frame";return[{content:G,callback:function(){S.properties.show=!S.properties.show}}]},d.prototype.onDrawBackground=function(b){this.flags.collapsed||this.size[1]<=20||!this.properties.show||this._video&&(b.save(),b.drawImage(this._video,0,0,this.size[0],this.size[1]),b.restore())},d.prototype.onGetOutputs=function(){return[["width","number"],["height","number"],["stream_ready",t.EVENT],["stream_closed",t.EVENT],["stream_error",t.EVENT]]},t.registerNodeType("graphics/webcam",d)}(commonjsGlobal),function(e){var t=e.LiteGraph,n=e.LGraphCanvas;if(e.LGraphTexture=null,typeof GL>"u")return;n.link_type_colors.Texture="#987";function r(){this.addOutput("tex","Texture"),this.addOutput("name","string"),this.properties={name:"",filter:!0},this.size=[r.image_preview_size,r.image_preview_size]}e.LGraphTexture=r,r.title="Texture",r.desc="Texture",r.widgets_info={name:{widget:"texture"},filter:{widget:"checkbox"}},r.loadTextureCallback=null,r.image_preview_size=256,r.UNDEFINED=0,r.PASS_THROUGH=1,r.COPY=2,r.LOW=3,r.HIGH=4,r.REUSE=5,r.DEFAULT=2,r.MODE_VALUES={undefined:r.UNDEFINED,"pass through":r.PASS_THROUGH,copy:r.COPY,low:r.LOW,high:r.HIGH,reuse:r.REUSE,default:r.DEFAULT},r.getTexturesContainer=function(){return gl.textures},r.loadTexture=function(m,M){M=M||{};var Z=m;Z.substr(0,7)=="http://"&&t.proxy&&(Z=t.proxy+Z.substr(7));var it=r.getTexturesContainer(),gt=it[m]=GL.Texture.fromURL(Z,M);return gt},r.getTexture=function(m){var M=this.getTexturesContainer();if(!M)throw"Cannot load texture, container of textures not found";var Z=M[m];return!Z&&m&&m[0]!=":"?this.loadTexture(m):Z},r.getTargetTexture=function(m,M,Z){if(!m)throw"LGraphTexture.getTargetTexture expects a reference texture";var it=null;switch(Z){case r.LOW:it=gl.UNSIGNED_BYTE;break;case r.HIGH:it=gl.HIGH_PRECISION_FORMAT;break;case r.REUSE:return m;case r.COPY:default:it=m?m.type:gl.UNSIGNED_BYTE;break}return(!M||M.width!=m.width||M.height!=m.height||M.type!=it||M.format!=m.format)&&(M=new GL.Texture(m.width,m.height,{type:it,format:m.format,filter:gl.LINEAR})),M},r.getTextureType=function(m,M){var Z=M?M.type:gl.UNSIGNED_BYTE;switch(m){case r.HIGH:Z=gl.HIGH_PRECISION_FORMAT;break;case r.LOW:Z=gl.UNSIGNED_BYTE;break}return Z},r.getWhiteTexture=function(){if(this._white_texture)return this._white_texture;var m=this._white_texture=GL.Texture.fromMemory(1,1,[255,255,255,255],{format:gl.RGBA,wrap:gl.REPEAT,filter:gl.NEAREST});return m},r.getNoiseTexture=function(){if(this._noise_texture)return this._noise_texture;for(var m=new Uint8Array(512*512*4),M=0;M<512*512*4;++M)m[M]=Math.random()*255;var Z=GL.Texture.fromMemory(512,512,m,{format:gl.RGBA,wrap:gl.REPEAT,filter:gl.NEAREST});return this._noise_texture=Z,Z},r.prototype.onDropFile=function(m,M,Z){if(!m)this._drop_texture=null,this.properties.name="";else{var it=null;if(typeof m=="string")it=GL.Texture.fromURL(m);else if(M.toLowerCase().indexOf(".dds")!=-1)it=GL.Texture.fromDDSInMemory(m);else{var gt=new Blob([Z]),Tt=URL.createObjectURL(gt);it=GL.Texture.fromURL(Tt)}this._drop_texture=it,this.properties.name=M}},r.prototype.getExtraMenuOptions=function(m){var M=this;if(this._drop_texture)return[{content:"Clear",callback:function(){M._drop_texture=null,M.properties.name=""}}]},r.prototype.onExecute=function(){var m=null;if(this.isOutputConnected(1)&&(m=this.getInputData(0)),!m&&this._drop_texture&&(m=this._drop_texture),!m&&this.properties.name&&(m=r.getTexture(this.properties.name)),!m){this.setOutputData(0,null),this.setOutputData(1,"");return}this._last_tex=m,this.properties.filter===!1?m.setParameter(gl.TEXTURE_MAG_FILTER,gl.NEAREST):m.setParameter(gl.TEXTURE_MAG_FILTER,gl.LINEAR),this.setOutputData(0,m),this.setOutputData(1,m.fullpath||m.filename);for(var M=2;M<this.outputs.length;M++){var Z=this.outputs[M];if(Z){var it=null;Z.name=="width"?it=m.width:Z.name=="height"?it=m.height:Z.name=="aspect"&&(it=m.width/m.height),this.setOutputData(M,it)}}},r.prototype.onResourceRenamed=function(m,M){this.properties.name==m&&(this.properties.name=M)},r.prototype.onDrawBackground=function(m){if(!(this.flags.collapsed||this.size[1]<=20)){if(this._drop_texture&&m.webgl){m.drawImage(this._drop_texture,0,0,this.size[0],this.size[1]);return}if(this._last_preview_tex!=this._last_tex)if(m.webgl)this._canvas=this._last_tex;else{var M=r.generateLowResTexturePreview(this._last_tex);if(!M)return;this._last_preview_tex=this._last_tex,this._canvas=cloneCanvas(M)}this._canvas&&(m.save(),m.webgl||(m.translate(0,this.size[1]),m.scale(1,-1)),m.drawImage(this._canvas,0,0,this.size[0],this.size[1]),m.restore())}},r.generateLowResTexturePreview=function(m){if(!m)return null;var M=r.image_preview_size,Z=m;if(m.format==gl.DEPTH_COMPONENT)return null;(m.width>M||m.height>M)&&(Z=this._preview_temp_tex,this._preview_temp_tex||(Z=new GL.Texture(M,M,{minFilter:gl.NEAREST}),this._preview_temp_tex=Z),m.copyTo(Z),m=Z);var it=this._preview_canvas;return it||(it=createCanvas(M,M),this._preview_canvas=it),Z&&Z.toCanvas(it),it},r.prototype.getResources=function(m){return this.properties.name&&(m[this.properties.name]=GL.Texture),m},r.prototype.onGetInputs=function(){return[["in","Texture"]]},r.prototype.onGetOutputs=function(){return[["width","number"],["height","number"],["aspect","number"]]},r.replaceCode=function(m,M){return m.replace(/\{\{[a-zA-Z0-9_]*\}\}/g,function(Z){return Z=Z.replace(/[\{\}]/g,""),M[Z]||""})},t.registerNodeType("texture/texture",r);function s(){this.addInput("Texture","Texture"),this.properties={flipY:!1},this.size=[r.image_preview_size,r.image_preview_size]}s.title="Preview",s.desc="Show a texture in the graph canvas",s.allow_preview=!1,s.prototype.onDrawBackground=function(m){if(!this.flags.collapsed&&!(!m.webgl&&!s.allow_preview)){var M=this.getInputData(0);if(M){var Z=null;!M.handle&&m.webgl?Z=M:Z=r.generateLowResTexturePreview(M),m.save(),this.properties.flipY&&(m.translate(0,this.size[1]),m.scale(1,-1)),m.drawImage(Z,0,0,this.size[0],this.size[1]),m.restore()}}},t.registerNodeType("texture/preview",s);function o(){this.addInput("Texture","Texture"),this.addOutput("tex","Texture"),this.addOutput("name","string"),this.properties={name:"",generate_mipmaps:!1}}o.title="Save",o.desc="Save a texture in the repository",o.prototype.getPreviewTexture=function(){return this._texture},o.prototype.onExecute=function(){var m=this.getInputData(0);if(m){if(this.properties.generate_mipmaps&&(m.bind(0),m.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR),gl.generateMipmap(m.texture_type),m.unbind(0)),this.properties.name)if(r.storeTexture)r.storeTexture(this.properties.name,m);else{var M=r.getTexturesContainer();M[this.properties.name]=m}this._texture=m,this.setOutputData(0,m),this.setOutputData(1,this.properties.name)}},t.registerNodeType("texture/save",o);function h(){this.addInput("Texture","Texture"),this.addInput("TextureB","Texture"),this.addInput("value","number"),this.addOutput("Texture","Texture"),this.help="<p>pixelcode must be vec3, uvcode must be vec2, is optional</p>		<p><strong>uv:</strong> tex. coords</p><p><strong>color:</strong> texture <strong>colorB:</strong> textureB</p><p><strong>time:</strong> scene time <strong>value:</strong> input value</p><p>For multiline you must type: result = ...</p>",this.properties={value:1,pixelcode:"color + colorB * value",uvcode:"",precision:r.DEFAULT},this.has_error=!1}h.widgets_info={uvcode:{widget:"code"},pixelcode:{widget:"code"},precision:{widget:"combo",values:r.MODE_VALUES}},h.title="Operation",h.desc="Texture shader operation",h.presets={},h.prototype.getExtraMenuOptions=function(m){var M=this,Z=M.properties.show?"Hide Texture":"Show Texture";return[{content:Z,callback:function(){M.properties.show=!M.properties.show}}]},h.prototype.onPropertyChanged=function(){this.has_error=!1},h.prototype.onDrawBackground=function(m){this.flags.collapsed||this.size[1]<=20||!this.properties.show||this._tex&&this._tex.gl==m&&(m.save(),m.drawImage(this._tex,0,0,this.size[0],this.size[1]),m.restore())},h.prototype.onExecute=function(){var m=this.getInputData(0);if(this.isOutputConnected(0)){if(this.properties.precision===r.PASS_THROUGH){this.setOutputData(0,m);return}var M=this.getInputData(1);if(!(!this.properties.uvcode&&!this.properties.pixelcode)){var Z=512,it=512;m?(Z=m.width,it=m.height):M&&(Z=M.width,it=M.height),M||(M=GL.Texture.getWhiteTexture());var gt=r.getTextureType(this.properties.precision,m);!m&&!this._tex?this._tex=new GL.Texture(Z,it,{type:gt,format:gl.RGBA,filter:gl.LINEAR}):this._tex=r.getTargetTexture(m||this._tex,this._tex,this.properties.precision);var Tt="";this.properties.uvcode&&(Tt="uv = "+this.properties.uvcode,this.properties.uvcode.indexOf(";")!=-1&&(Tt=this.properties.uvcode));var qt="";this.properties.pixelcode&&(qt="result = "+this.properties.pixelcode,this.properties.pixelcode.indexOf(";")!=-1&&(qt=this.properties.pixelcode));var $t=this._shader;if(!this.has_error&&(!$t||this._shader_code!=Tt+"|"+qt)){var le=r.replaceCode(h.pixel_shader,{UV_CODE:Tt,PIXEL_CODE:qt});try{$t=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,le),this.boxcolor="#00FF00"}catch(Te){GL.Shader.dumpErrorToConsole(Te,Shader.SCREEN_VERTEX_SHADER,le),this.boxcolor="#FF0000",this.has_error=!0;return}this._shader=$t,this._shader_code=Tt+"|"+qt}if(this._shader){var ye=this.getInputData(2);ye!=null?this.properties.value=ye:ye=parseFloat(this.properties.value);var ce=this.graph.getTime();this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),m&&m.bind(0),M&&M.bind(1);var Te=Mesh.getScreenQuad();$t.uniforms({u_texture:0,u_textureB:1,value:ye,texSize:[Z,it,1/Z,1/it],time:ce}).draw(Te)}),this.setOutputData(0,this._tex)}}}},h.pixel_shader=`precision highp float;
		
		uniform sampler2D u_texture;
		uniform sampler2D u_textureB;
		varying vec2 v_coord;
		uniform vec4 texSize;
		uniform float time;
		uniform float value;
		
		void main() {
			vec2 uv = v_coord;
			{{UV_CODE}};
			vec4 color4 = texture2D(u_texture, uv);
			vec3 color = color4.rgb;
			vec4 color4B = texture2D(u_textureB, uv);
			vec3 colorB = color4B.rgb;
			vec3 result = color;
			float alpha = 1.0;
			{{PIXEL_CODE}};
			gl_FragColor = vec4(result, alpha);
		}
		`,h.registerPreset=function(m,M){h.presets[m]=M},h.registerPreset("",""),h.registerPreset("bypass","color"),h.registerPreset("add","color + colorB * value"),h.registerPreset("substract","(color - colorB) * value"),h.registerPreset("mate","mix( color, colorB, color4B.a * value)"),h.registerPreset("invert","vec3(1.0) - color"),h.registerPreset("multiply","color * colorB * value"),h.registerPreset("divide","(color / colorB) / value"),h.registerPreset("difference","abs(color - colorB) * value"),h.registerPreset("max","max(color, colorB) * value"),h.registerPreset("min","min(color, colorB) * value"),h.registerPreset("displace","texture2D(u_texture, uv + (colorB.xy - vec2(0.5)) * value).xyz"),h.registerPreset("grayscale","vec3(color.x + color.y + color.z) * value / 3.0"),h.registerPreset("saturation","mix( vec3(color.x + color.y + color.z) / 3.0, color, value )"),h.registerPreset("normalmap",`
		float z0 = texture2D(u_texture, uv + vec2(-texSize.z, -texSize.w) ).x;
		float z1 = texture2D(u_texture, uv + vec2(0.0, -texSize.w) ).x;
		float z2 = texture2D(u_texture, uv + vec2(texSize.z, -texSize.w) ).x;
		float z3 = texture2D(u_texture, uv + vec2(-texSize.z, 0.0) ).x;
		float z4 = color.x;
		float z5 = texture2D(u_texture, uv + vec2(texSize.z, 0.0) ).x;
		float z6 = texture2D(u_texture, uv + vec2(-texSize.z, texSize.w) ).x;
		float z7 = texture2D(u_texture, uv + vec2(0.0, texSize.w) ).x;
		float z8 = texture2D(u_texture, uv + vec2(texSize.z, texSize.w) ).x;
		vec3 normal = vec3( z2 + 2.0*z4 + z7 - z0 - 2.0*z3 - z5, z5 + 2.0*z6 + z7 -z0 - 2.0*z1 - z2, 1.0 );
		normal.xy *= value;
		result.xyz = normalize(normal) * 0.5 + vec3(0.5);
	`),h.registerPreset("threshold","vec3(color.x > colorB.x * value ? 1.0 : 0.0,color.y > colorB.y * value ? 1.0 : 0.0,color.z > colorB.z * value ? 1.0 : 0.0)"),h.prototype.onInspect=function(m){var M=this;m.addCombo("Presets","",{values:Object.keys(h.presets),callback:function(Z){var it=h.presets[Z];it&&(M.setProperty("pixelcode",it),M.title=Z,m.refresh())}})},t.registerNodeType("texture/operation",h);function u(){this.addOutput("out","Texture"),this.properties={code:"",u_value:1,u_color:[1,1,1,1],width:512,height:512,precision:r.DEFAULT},this.properties.code=u.pixel_shader,this._uniforms={u_value:1,u_color:vec4.create(),in_texture:0,texSize:vec4.create(),time:0}}u.title="Shader",u.desc="Texture shader",u.widgets_info={code:{type:"code",lang:"glsl"},precision:{widget:"combo",values:r.MODE_VALUES}},u.prototype.onPropertyChanged=function(m,M){if(m=="code"){var Z=this.getShader();if(Z){var it=Z.uniformInfo;if(this.inputs)for(var gt={},Tt=0;Tt<this.inputs.length;++Tt){var qt=this.getInputInfo(Tt);if(qt){if(it[qt.name]&&!gt[qt.name]){gt[qt.name]=!0;continue}this.removeInput(Tt),Tt--}}for(var Tt in it){var qt=Z.uniformInfo[Tt];if(qt.loc!==null&&Tt!="time"){var $t="number";if(this._shader.samplers[Tt])$t="texture";else switch(qt.size){case 1:$t="number";break;case 2:$t="vec2";break;case 3:$t="vec3";break;case 4:$t="vec4";break;case 9:$t="mat3";break;case 16:$t="mat4";break;default:continue}var le=this.findInputSlot(Tt);if(le==-1){this.addInput(Tt,$t);continue}var ye=this.getInputInfo(le);if(!ye)this.addInput(Tt,$t);else{if(ye.type==$t)continue;this.removeInput(le,$t),this.addInput(Tt,$t)}}}}}},u.prototype.getShader=function(){if(this._shader&&this._shader_code==this.properties.code)return this._shader;if(this._shader_code=this.properties.code,this._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,this.properties.code),this._shader)this.boxcolor="green";else return this.boxcolor="red",null;return this._shader},u.prototype.onExecute=function(){if(this.isOutputConnected(0)){var m=this.getShader();if(m){var M=0,Z=null;if(this.inputs)for(var it=0;it<this.inputs.length;++it){var gt=this.getInputInfo(it),Tt=this.getInputData(it);Tt!=null&&(Tt.constructor===GL.Texture&&(Tt.bind(M),Z||(Z=Tt),Tt=M,M++),m.setUniform(gt.name,Tt))}var qt=this._uniforms,$t=r.getTextureType(this.properties.precision,Z),le=this.properties.width|0,ye=this.properties.height|0;le==0&&(le=Z?Z.width:gl.canvas.width),ye==0&&(ye=Z?Z.height:gl.canvas.height),qt.texSize[0]=le,qt.texSize[1]=ye,qt.texSize[2]=1/le,qt.texSize[3]=1/ye,qt.time=this.graph.getTime(),qt.u_value=this.properties.u_value,qt.u_color.set(this.properties.u_color),(!this._tex||this._tex.type!=$t||this._tex.width!=le||this._tex.height!=ye)&&(this._tex=new GL.Texture(le,ye,{type:$t,format:gl.RGBA,filter:gl.LINEAR}));var ce=this._tex;ce.drawTo(function(){m.uniforms(qt).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,this._tex)}}},u.pixel_shader=`precision highp float;

varying vec2 v_coord;
uniform float time; //time in seconds
uniform vec4 texSize; //tex resolution
uniform float u_value;
uniform vec4 u_color;

void main() {
	vec2 uv = v_coord;
	vec3 color = vec3(0.0);
	//your code here
	color.xy=uv;

	gl_FragColor = vec4(color, 1.0);
}
`,t.registerNodeType("texture/shader",u);function f(){this.addInput("in","Texture"),this.addInput("scale","vec2"),this.addInput("offset","vec2"),this.addOutput("out","Texture"),this.properties={offset:vec2.fromValues(0,0),scale:vec2.fromValues(1,1),precision:r.DEFAULT}}f.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},f.title="Scale/Offset",f.desc="Applies an scaling and offseting",f.prototype.onExecute=function(){var m=this.getInputData(0);if(!(!this.isOutputConnected(0)||!m)){if(this.properties.precision===r.PASS_THROUGH){this.setOutputData(0,m);return}var M=m.width,Z=m.height,it=this.precision===r.LOW?gl.UNSIGNED_BYTE:gl.HIGH_PRECISION_FORMAT;this.precision===r.DEFAULT&&(it=m.type),(!this._tex||this._tex.width!=M||this._tex.height!=Z||this._tex.type!=it)&&(this._tex=new GL.Texture(M,Z,{type:it,format:gl.RGBA,filter:gl.LINEAR}));var gt=this._shader;gt||(gt=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,f.pixel_shader));var Tt=this.getInputData(1);Tt?(this.properties.scale[0]=Tt[0],this.properties.scale[1]=Tt[1]):Tt=this.properties.scale;var qt=this.getInputData(2);qt?(this.properties.offset[0]=qt[0],this.properties.offset[1]=qt[1]):qt=this.properties.offset,this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),m.bind(0);var $t=Mesh.getScreenQuad();gt.uniforms({u_texture:0,u_scale:Tt,u_offset:qt}).draw($t)}),this.setOutputData(0,this._tex)}},f.pixel_shader=`precision highp float;
		
		uniform sampler2D u_texture;
		uniform sampler2D u_textureB;
		varying vec2 v_coord;
		uniform vec2 u_scale;
		uniform vec2 u_offset;
		
		void main() {
			vec2 uv = v_coord;
			uv = uv / u_scale - u_offset;
			gl_FragColor = texture2D(u_texture, uv);
		}
		`,t.registerNodeType("texture/scaleOffset",f);function c(){this.addInput("in","Texture"),this.addInput("warp","Texture"),this.addInput("factor","number"),this.addOutput("out","Texture"),this.properties={factor:.01,scale:[1,1],offset:[0,0],precision:r.DEFAULT},this._uniforms={u_texture:0,u_textureB:1,u_factor:1,u_scale:vec2.create(),u_offset:vec2.create()}}c.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},c.title="Warp",c.desc="Texture warp operation",c.prototype.onExecute=function(){var m=this.getInputData(0);if(this.isOutputConnected(0)){if(this.properties.precision===r.PASS_THROUGH){this.setOutputData(0,m);return}var M=this.getInputData(1),Z=512,it=512;gl.UNSIGNED_BYTE,m?(Z=m.width,it=m.height,m.type):M&&(Z=M.width,it=M.height,M.type),!m&&!this._tex?this._tex=new GL.Texture(Z,it,{type:this.precision===r.LOW?gl.UNSIGNED_BYTE:gl.HIGH_PRECISION_FORMAT,format:gl.RGBA,filter:gl.LINEAR}):this._tex=r.getTargetTexture(m||this._tex,this._tex,this.properties.precision);var gt=this._shader;gt||(gt=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,c.pixel_shader));var Tt=this.getInputData(2);Tt!=null?this.properties.factor=Tt:Tt=parseFloat(this.properties.factor);var qt=this._uniforms;qt.u_factor=Tt,qt.u_scale.set(this.properties.scale),qt.u_offset.set(this.properties.offset),this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),m&&m.bind(0),M&&M.bind(1);var $t=Mesh.getScreenQuad();gt.uniforms(qt).draw($t)}),this.setOutputData(0,this._tex)}},c.pixel_shader=`precision highp float;
		
		uniform sampler2D u_texture;
		uniform sampler2D u_textureB;
		varying vec2 v_coord;
		uniform float u_factor;
		uniform vec2 u_scale;
		uniform vec2 u_offset;
		
		void main() {
			vec2 uv = v_coord;
			uv += ( texture2D(u_textureB, uv).rg - vec2(0.5)) * u_factor * u_scale + u_offset;
			gl_FragColor = texture2D(u_texture, uv);
		}
		`,t.registerNodeType("texture/warp",c);function _(){this.addInput("Texture","Texture"),this.properties={additive:!1,antialiasing:!1,filter:!0,disable_alpha:!1,gamma:1,viewport:[0,0,1,1]},this.size[0]=130}_.title="to Viewport",_.desc="Texture to viewport",_._prev_viewport=new Float32Array(4),_.prototype.onDrawBackground=function(m){if(!(this.flags.collapsed||this.size[1]<=40)){var M=this.getInputData(0);M&&m.drawImage(m==gl?M:gl.canvas,10,30,this.size[0]-20,this.size[1]-40)}},_.prototype.onExecute=function(){var m=this.getInputData(0);if(m){this.properties.disable_alpha?gl.disable(gl.BLEND):(gl.enable(gl.BLEND),this.properties.additive?gl.blendFunc(gl.SRC_ALPHA,gl.ONE):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)),gl.disable(gl.DEPTH_TEST);var M=this.properties.gamma||1;this.isInputConnected(1)&&(M=this.getInputData(1)),m.setParameter(gl.TEXTURE_MAG_FILTER,this.properties.filter?gl.LINEAR:gl.NEAREST);var Z=_._prev_viewport;Z.set(gl.viewport_data);var it=this.properties.viewport;if(gl.viewport(Z[0]+Z[2]*it[0],Z[1]+Z[3]*it[1],Z[2]*it[2],Z[3]*it[3]),gl.getViewport(),this.properties.antialiasing){_._shader||(_._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,_.aa_pixel_shader));var gt=Mesh.getScreenQuad();m.bind(0),_._shader.uniforms({u_texture:0,uViewportSize:[m.width,m.height],u_igamma:1/M,inverseVP:[1/m.width,1/m.height]}).draw(gt)}else M!=1?(_._gamma_shader||(_._gamma_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,_.gamma_pixel_shader)),m.toViewport(_._gamma_shader,{u_texture:0,u_igamma:1/M})):m.toViewport();gl.viewport(Z[0],Z[1],Z[2],Z[3])}},_.prototype.onGetInputs=function(){return[["gamma","number"]]},_.aa_pixel_shader=`precision highp float;
		precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform vec2 uViewportSize;
		uniform vec2 inverseVP;
		uniform float u_igamma;
		#define FXAA_REDUCE_MIN   (1.0/ 128.0)
		#define FXAA_REDUCE_MUL   (1.0 / 8.0)
		#define FXAA_SPAN_MAX     8.0
		
		/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */
		vec4 applyFXAA(sampler2D tex, vec2 fragCoord)
		{
			vec4 color = vec4(0.0);
			/*vec2 inverseVP = vec2(1.0 / uViewportSize.x, 1.0 / uViewportSize.y);*/
			vec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * inverseVP).xyz;
			vec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * inverseVP).xyz;
			vec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * inverseVP).xyz;
			vec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * inverseVP).xyz;
			vec3 rgbM  = texture2D(tex, fragCoord  * inverseVP).xyz;
			vec3 luma = vec3(0.299, 0.587, 0.114);
			float lumaNW = dot(rgbNW, luma);
			float lumaNE = dot(rgbNE, luma);
			float lumaSW = dot(rgbSW, luma);
			float lumaSE = dot(rgbSE, luma);
			float lumaM  = dot(rgbM,  luma);
			float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));
			float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));
			
			vec2 dir;
			dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));
			dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));
			
			float dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);
			
			float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);
			dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * inverseVP;
			
			vec3 rgbA = 0.5 * (texture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz + 
				texture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);
			vec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz + 
				texture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);
			
			//return vec4(rgbA,1.0);
			float lumaB = dot(rgbB, luma);
			if ((lumaB < lumaMin) || (lumaB > lumaMax))
				color = vec4(rgbA, 1.0);
			else
				color = vec4(rgbB, 1.0);
			if(u_igamma != 1.0)
				color.xyz = pow( color.xyz, vec3(u_igamma) );
			return color;
		}
		
		void main() {
		   gl_FragColor = applyFXAA( u_texture, v_coord * uViewportSize) ;
		}
		`,_.gamma_pixel_shader=`precision highp float;
		precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform float u_igamma;
		void main() {
			vec4 color = texture2D( u_texture, v_coord);
			color.xyz = pow(color.xyz, vec3(u_igamma) );
		   gl_FragColor = color;
		}
		`,t.registerNodeType("texture/toviewport",_);function O(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={size:0,generate_mipmaps:!1,precision:r.DEFAULT}}O.title="Copy",O.desc="Copy Texture",O.widgets_info={size:{widget:"combo",values:[0,32,64,128,256,512,1024,2048]},precision:{widget:"combo",values:r.MODE_VALUES}},O.prototype.onExecute=function(){var m=this.getInputData(0);if(!(!m&&!this._temp_texture)&&this.isOutputConnected(0)){if(m){var M=m.width,Z=m.height;this.properties.size!=0&&(M=this.properties.size,Z=this.properties.size);var it=this._temp_texture,gt=m.type;if(this.properties.precision===r.LOW?gt=gl.UNSIGNED_BYTE:this.properties.precision===r.HIGH&&(gt=gl.HIGH_PRECISION_FORMAT),!it||it.width!=M||it.height!=Z||it.type!=gt){var Tt=gl.LINEAR;this.properties.generate_mipmaps&&isPowerOfTwo(M)&&isPowerOfTwo(Z)&&(Tt=gl.LINEAR_MIPMAP_LINEAR),this._temp_texture=new GL.Texture(M,Z,{type:gt,format:gl.RGBA,minFilter:Tt,magFilter:gl.LINEAR})}m.copyTo(this._temp_texture),this.properties.generate_mipmaps&&(this._temp_texture.bind(0),gl.generateMipmap(this._temp_texture.texture_type),this._temp_texture.unbind(0))}this.setOutputData(0,this._temp_texture)}},t.registerNodeType("texture/copy",O);function d(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={iterations:1,generate_mipmaps:!1,precision:r.DEFAULT}}d.title="Downsample",d.desc="Downsample Texture",d.widgets_info={iterations:{type:"number",step:1,precision:0,min:0},precision:{widget:"combo",values:r.MODE_VALUES}},d.prototype.onExecute=function(){var m=this.getInputData(0);if(!(!m&&!this._temp_texture)&&this.isOutputConnected(0)&&!(!m||m.texture_type!==GL.TEXTURE_2D)){if(this.properties.iterations<1){this.setOutputData(0,m);return}var M=d._shader;M||(d._shader=M=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,d.pixel_shader));var Z=m.width|0,it=m.height|0,gt=m.type;this.properties.precision===r.LOW?gt=gl.UNSIGNED_BYTE:this.properties.precision===r.HIGH&&(gt=gl.HIGH_PRECISION_FORMAT);var Tt=this.properties.iterations||1,qt=m,$t=null,le=[],ye={type:gt,format:m.format},ce=vec2.create(),Te={u_offset:ce};this._texture&&GL.Texture.releaseTemporary(this._texture);for(var Be=0;Be<Tt&&(ce[0]=1/Z,ce[1]=1/it,Z=Z>>1||0,it=it>>1||0,$t=GL.Texture.getTemporary(Z,it,ye),le.push($t),qt.setParameter(GL.TEXTURE_MAG_FILTER,GL.NEAREST),qt.copyTo($t,M,Te),!(Z==1&&it==1));++Be)qt=$t;this._texture=le.pop();for(var Be=0;Be<le.length;++Be)GL.Texture.releaseTemporary(le[Be]);this.properties.generate_mipmaps&&(this._texture.bind(0),gl.generateMipmap(this._texture.texture_type),this._texture.unbind(0)),this.setOutputData(0,this._texture)}},d.pixel_shader=`precision highp float;
		precision highp float;
		uniform sampler2D u_texture;
		uniform vec2 u_offset;
		varying vec2 v_coord;
		
		void main() {
			vec4 color = texture2D(u_texture, v_coord );
			color += texture2D(u_texture, v_coord + vec2( u_offset.x, 0.0 ) );
			color += texture2D(u_texture, v_coord + vec2( 0.0, u_offset.y ) );
			color += texture2D(u_texture, v_coord + vec2( u_offset.x, u_offset.y ) );
		   gl_FragColor = color * 0.25;
		}
		`,t.registerNodeType("texture/downsample",d);function b(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={size:[512,512],generate_mipmaps:!1,precision:r.DEFAULT}}b.title="Resize",b.desc="Resize Texture",b.widgets_info={iterations:{type:"number",step:1,precision:0,min:0},precision:{widget:"combo",values:r.MODE_VALUES}},b.prototype.onExecute=function(){var m=this.getInputData(0);if(!(!m&&!this._temp_texture)&&this.isOutputConnected(0)&&!(!m||m.texture_type!==GL.TEXTURE_2D)){var M=this.properties.size[0]|0,Z=this.properties.size[1]|0;M==0&&(M=m.width),Z==0&&(Z=m.height);var it=m.type;this.properties.precision===r.LOW?it=gl.UNSIGNED_BYTE:this.properties.precision===r.HIGH&&(it=gl.HIGH_PRECISION_FORMAT),(!this._texture||this._texture.width!=M||this._texture.height!=Z||this._texture.type!=it)&&(this._texture=new GL.Texture(M,Z,{type:it})),m.copyTo(this._texture),this.properties.generate_mipmaps&&(this._texture.bind(0),gl.generateMipmap(this._texture.texture_type),this._texture.unbind(0)),this.setOutputData(0,this._texture)}},t.registerNodeType("texture/resize",b);function S(){this.addInput("Texture","Texture"),this.addOutput("tex","Texture"),this.addOutput("avg","vec4"),this.addOutput("lum","number"),this.properties={use_previous_frame:!0,high_quality:!1},this._uniforms={u_texture:0,u_mipmap_offset:0},this._luminance=new Float32Array(4)}S.title="Average",S.desc=`Compute a partial average (32 random samples) of a texture and stores it as a 1x1 pixel texture.
 If high_quality is true, then it generates the mipmaps first and reads from the lower one.`,S.prototype.onExecute=function(){this.properties.use_previous_frame||this.updateAverage();var m=this._luminance;this.setOutputData(0,this._temp_texture),this.setOutputData(1,m),this.setOutputData(2,(m[0]+m[1]+m[2])/3)},S.prototype.onPreRenderExecute=function(){this.updateAverage()},S.prototype.updateAverage=function(){var m=this.getInputData(0);if(m&&!(!this.isOutputConnected(0)&&!this.isOutputConnected(1)&&!this.isOutputConnected(2))){if(!S._shader){S._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,S.pixel_shader);for(var M=new Float32Array(16),Z=0;Z<M.length;++Z)M[Z]=Math.random();S._shader.uniforms({u_samples_a:M.subarray(0,16),u_samples_b:M.subarray(16,32)})}var it=this._temp_texture,gt=gl.UNSIGNED_BYTE;m.type!=gt&&(gt=gl.FLOAT),(!it||it.type!=gt)&&(this._temp_texture=new GL.Texture(1,1,{type:gt,format:gl.RGBA,filter:gl.NEAREST})),this._uniforms.u_mipmap_offset=0,this.properties.high_quality&&((!this._temp_pot2_texture||this._temp_pot2_texture.type!=gt)&&(this._temp_pot2_texture=new GL.Texture(512,512,{type:gt,format:gl.RGBA,minFilter:gl.LINEAR_MIPMAP_LINEAR,magFilter:gl.LINEAR})),m.copyTo(this._temp_pot2_texture),m=this._temp_pot2_texture,m.bind(0),gl.generateMipmap(GL.TEXTURE_2D),this._uniforms.u_mipmap_offset=9);var Tt=S._shader,qt=this._uniforms;if(qt.u_mipmap_offset=this.properties.mipmap_offset,gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),this._temp_texture.drawTo(function(){m.toViewport(Tt,qt)}),this.isOutputConnected(1)||this.isOutputConnected(2)){var $t=this._temp_texture.getPixels();if($t){var le=this._luminance,gt=this._temp_texture.type;le.set($t),gt==gl.UNSIGNED_BYTE?vec4.scale(le,le,1/255):gt==GL.HALF_FLOAT||gt==GL.HALF_FLOAT_OES}}}},S.pixel_shader=`precision highp float;
		precision highp float;
		uniform mat4 u_samples_a;
		uniform mat4 u_samples_b;
		uniform sampler2D u_texture;
		uniform float u_mipmap_offset;
		varying vec2 v_coord;
		
		void main() {
			vec4 color = vec4(0.0);
			//random average
			for(int i = 0; i < 4; ++i)
				for(int j = 0; j < 4; ++j)
				{
					color += texture2D(u_texture, vec2( u_samples_a[i][j], u_samples_b[i][j] ), u_mipmap_offset );
					color += texture2D(u_texture, vec2( 1.0 - u_samples_a[i][j], 1.0 - u_samples_b[i][j] ), u_mipmap_offset );
				}
		   gl_FragColor = color * 0.03125;
		}
		`,t.registerNodeType("texture/average",S);function G(){this.addInput("in","Texture"),this.addInput("factor","Number"),this.addOutput("out","Texture"),this.properties={factor:.5},this._uniforms={u_texture:0,u_textureB:1,u_factor:this.properties.factor}}G.title="Smooth",G.desc="Smooth texture over time",G.prototype.onExecute=function(){var m=this.getInputData(0);if(!(!m||!this.isOutputConnected(0))){G._shader||(G._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,G.pixel_shader));var M=this._temp_texture;if(!M||M.type!=m.type||M.width!=m.width||M.height!=m.height){var Z={type:m.type,format:gl.RGBA,filter:gl.NEAREST};this._temp_texture=new GL.Texture(m.width,m.height,Z),this._temp_texture2=new GL.Texture(m.width,m.height,Z),m.copyTo(this._temp_texture2)}var it=this._temp_texture,gt=this._temp_texture2,Tt=G._shader,qt=this._uniforms;qt.u_factor=1-this.getInputOrProperty("factor"),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),it.drawTo(function(){gt.bind(1),m.toViewport(Tt,qt)}),this.setOutputData(0,it),this._temp_texture=gt,this._temp_texture2=it}},G.pixel_shader=`precision highp float;
		precision highp float;
		uniform sampler2D u_texture;
		uniform sampler2D u_textureB;
		uniform float u_factor;
		varying vec2 v_coord;
		
		void main() {
			gl_FragColor = mix( texture2D( u_texture, v_coord ), texture2D( u_textureB, v_coord ), u_factor );
		}
		`,t.registerNodeType("texture/temporal_smooth",G);function z(){this.addInput("in","Texture"),this.addOutput("avg","Texture"),this.addOutput("array","Texture"),this.properties={samples:64,frames_interval:1},this._uniforms={u_texture:0,u_textureB:1,u_samples:this.properties.samples,u_isamples:1/this.properties.samples},this.frame=0}z.title="Lineal Avg Smooth",z.desc="Smooth texture linearly over time",z["@samples"]={type:"number",min:1,max:64,step:1,precision:1},z.prototype.getPreviewTexture=function(){return this._temp_texture2},z.prototype.onExecute=function(){var m=this.getInputData(0);if(!(!m||!this.isOutputConnected(0))){z._shader||(z._shader_copy=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,z.pixel_shader_copy),z._shader_avg=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,z.pixel_shader_avg));var M=clamp(this.properties.samples,0,64),Z=this.frame,it=this.properties.frames_interval;if(it==0||Z%it==0){var gt=this._temp_texture;if(!gt||gt.type!=m.type||gt.width!=M){var Tt={type:m.type,format:gl.RGBA,filter:gl.NEAREST};this._temp_texture=new GL.Texture(M,1,Tt),this._temp_texture2=new GL.Texture(M,1,Tt),this._temp_texture_out=new GL.Texture(1,1,Tt)}var qt=this._temp_texture,$t=this._temp_texture2,le=z._shader_copy,ye=z._shader_avg,ce=this._uniforms;ce.u_samples=M,ce.u_isamples=1/M,gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),qt.drawTo(function(){$t.bind(1),m.toViewport(le,ce)}),this._temp_texture_out.drawTo(function(){qt.toViewport(ye,ce)}),this.setOutputData(0,this._temp_texture_out),this._temp_texture=$t,this._temp_texture2=qt}else this.setOutputData(0,this._temp_texture_out);this.setOutputData(1,this._temp_texture2),this.frame++}},z.pixel_shader_copy=`precision highp float;
		precision highp float;
		uniform sampler2D u_texture;
		uniform sampler2D u_textureB;
		uniform float u_isamples;
		varying vec2 v_coord;
		
		void main() {
			if( v_coord.x <= u_isamples )
				gl_FragColor = texture2D( u_texture, vec2(0.5) );
			else
				gl_FragColor = texture2D( u_textureB, v_coord - vec2(u_isamples,0.0) );
		}
		`,z.pixel_shader_avg=`precision highp float;
		precision highp float;
		uniform sampler2D u_texture;
		uniform int u_samples;
		uniform float u_isamples;
		varying vec2 v_coord;
		
		void main() {
			vec4 color = vec4(0.0);
			for(int i = 0; i < 64; ++i)
			{
				color += texture2D( u_texture, vec2( float(i)*u_isamples,0.0) );
				if(i == (u_samples - 1))
					break;
			}
			gl_FragColor = color * u_isamples;
		}
		`,t.registerNodeType("texture/linear_avg_smooth",z);function $(){this.addInput("Image","image"),this.addOutput("","Texture"),this.properties={}}$.title="Image to Texture",$.desc="Uploads an image to the GPU",$.prototype.onExecute=function(){var m=this.getInputData(0);if(m){var M=m.videoWidth||m.width,Z=m.videoHeight||m.height;if(m.gltexture){this.setOutputData(0,m.gltexture);return}var it=this._temp_texture;(!it||it.width!=M||it.height!=Z)&&(this._temp_texture=new GL.Texture(M,Z,{format:gl.RGBA,filter:gl.LINEAR}));try{this._temp_texture.uploadImage(m)}catch(gt){console.error("image comes from an unsafe location, cannot be uploaded to webgl: "+gt);return}this.setOutputData(0,this._temp_texture)}},t.registerNodeType("texture/imageToTexture",$);function A(){this.addInput("Texture","Texture"),this.addInput("LUT","Texture"),this.addInput("Intensity","number"),this.addOutput("","Texture"),this.properties={enabled:!0,intensity:1,precision:r.DEFAULT,texture:null},A._shader||(A._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,A.pixel_shader))}A.widgets_info={texture:{widget:"texture"},precision:{widget:"combo",values:r.MODE_VALUES}},A.title="LUT",A.desc="Apply LUT to Texture",A.prototype.onExecute=function(){if(this.isOutputConnected(0)){var m=this.getInputData(0);if(this.properties.precision===r.PASS_THROUGH||this.properties.enabled===!1){this.setOutputData(0,m);return}if(m){var M=this.getInputData(1);if(M||(M=r.getTexture(this.properties.texture)),!M){this.setOutputData(0,m);return}M.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindTexture(gl.TEXTURE_2D,null);var Z=this.properties.intensity;this.isInputConnected(2)&&(this.properties.intensity=Z=this.getInputData(2)),this._tex=r.getTargetTexture(m,this._tex,this.properties.precision),this._tex.drawTo(function(){M.bind(1),m.toViewport(A._shader,{u_texture:0,u_textureB:1,u_amount:Z})}),this.setOutputData(0,this._tex)}}},A.pixel_shader=`precision highp float;
		precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform sampler2D u_textureB;
		uniform float u_amount;
		
		void main() {
			 lowp vec4 textureColor = clamp( texture2D(u_texture, v_coord), vec4(0.0), vec4(1.0) );
			 mediump float blueColor = textureColor.b * 63.0;
			 mediump vec2 quad1;
			 quad1.y = floor(floor(blueColor) / 8.0);
			 quad1.x = floor(blueColor) - (quad1.y * 8.0);
			 mediump vec2 quad2;
			 quad2.y = floor(ceil(blueColor) / 8.0);
			 quad2.x = ceil(blueColor) - (quad2.y * 8.0);
			 highp vec2 texPos1;
			 texPos1.x = (quad1.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);
			 texPos1.y = 1.0 - ((quad1.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));
			 highp vec2 texPos2;
			 texPos2.x = (quad2.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);
			 texPos2.y = 1.0 - ((quad2.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));
			 lowp vec4 newColor1 = texture2D(u_textureB, texPos1);
			 lowp vec4 newColor2 = texture2D(u_textureB, texPos2);
			 lowp vec4 newColor = mix(newColor1, newColor2, fract(blueColor));
			 gl_FragColor = vec4( mix( textureColor.rgb, newColor.rgb, u_amount), textureColor.w);
		}
		`,t.registerNodeType("texture/LUT",A);function l(){this.addInput("Texture","Texture"),this.addInput("Atlas","Texture"),this.addOutput("","Texture"),this.properties={enabled:!0,num_row_symbols:4,symbol_size:16,brightness:1,colorize:!1,filter:!1,invert:!1,precision:r.DEFAULT,generate_mipmaps:!1,texture:null},l._shader||(l._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,l.pixel_shader)),this._uniforms={u_texture:0,u_textureB:1,u_row_simbols:4,u_simbol_size:16,u_res:vec2.create()}}l.widgets_info={texture:{widget:"texture"},precision:{widget:"combo",values:r.MODE_VALUES}},l.title="Encode",l.desc="Apply a texture atlas to encode a texture",l.prototype.onExecute=function(){if(this.isOutputConnected(0)){var m=this.getInputData(0);if(this.properties.precision===r.PASS_THROUGH||this.properties.enabled===!1){this.setOutputData(0,m);return}if(m){var M=this.getInputData(1);if(M||(M=r.getTexture(this.properties.texture)),!M){this.setOutputData(0,m);return}M.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.properties.filter?gl.LINEAR:gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.properties.filter?gl.LINEAR:gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindTexture(gl.TEXTURE_2D,null);var Z=this._uniforms;Z.u_row_simbols=Math.floor(this.properties.num_row_symbols),Z.u_symbol_size=this.properties.symbol_size,Z.u_brightness=this.properties.brightness,Z.u_invert=this.properties.invert?1:0,Z.u_colorize=this.properties.colorize?1:0,this._tex=r.getTargetTexture(m,this._tex,this.properties.precision),Z.u_res[0]=this._tex.width,Z.u_res[1]=this._tex.height,this._tex.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),this._tex.drawTo(function(){M.bind(1),m.toViewport(l._shader,Z)}),this.properties.generate_mipmaps&&(this._tex.bind(0),gl.generateMipmap(this._tex.texture_type),this._tex.unbind(0)),this.setOutputData(0,this._tex)}}},l.pixel_shader=`precision highp float;
		precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform sampler2D u_textureB;
		uniform float u_row_simbols;
		uniform float u_symbol_size;
		uniform float u_brightness;
		uniform float u_invert;
		uniform float u_colorize;
		uniform vec2 u_res;
		
		void main() {
			vec2 total_symbols = u_res / u_symbol_size;
			vec2 uv = floor(v_coord * total_symbols) / total_symbols; //pixelate 
			vec2 local_uv = mod(v_coord * u_res, u_symbol_size) / u_symbol_size;
			lowp vec4 textureColor = texture2D(u_texture, uv );
			float lum = clamp(u_brightness * (textureColor.x + textureColor.y + textureColor.z)/3.0,0.0,1.0);
			if( u_invert == 1.0 ) lum = 1.0 - lum;
			float index = floor( lum * (u_row_simbols * u_row_simbols - 1.0));
			float col = mod( index, u_row_simbols );
			float row = u_row_simbols - floor( index / u_row_simbols ) - 1.0;
			vec2 simbol_uv = ( vec2( col, row ) + local_uv ) / u_row_simbols;
			vec4 color = texture2D( u_textureB, simbol_uv );
			if(u_colorize == 1.0)
				color *= textureColor;
			gl_FragColor = color;
		}
		`,t.registerNodeType("texture/encode",l);function I(){this.addInput("Texture","Texture"),this.addOutput("R","Texture"),this.addOutput("G","Texture"),this.addOutput("B","Texture"),this.addOutput("A","Texture"),I._shader||(I._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,I.pixel_shader))}I.title="Texture to Channels",I.desc="Split texture channels",I.prototype.onExecute=function(){var m=this.getInputData(0);if(m){this._channels||(this._channels=Array(4));for(var M=gl.RGB,Z=0,it=0;it<4;it++)this.isOutputConnected(it)?((!this._channels[it]||this._channels[it].width!=m.width||this._channels[it].height!=m.height||this._channels[it].type!=m.type||this._channels[it].format!=M)&&(this._channels[it]=new GL.Texture(m.width,m.height,{type:m.type,format:M,filter:gl.LINEAR})),Z++):this._channels[it]=null;if(Z){gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);for(var gt=Mesh.getScreenQuad(),Tt=I._shader,qt=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]],it=0;it<4;it++)this._channels[it]&&(this._channels[it].drawTo(function(){m.bind(0),Tt.uniforms({u_texture:0,u_mask:qt[it]}).draw(gt)}),this.setOutputData(it,this._channels[it]))}}},I.pixel_shader=`precision highp float;
		precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform vec4 u_mask;
		
		void main() {
		   gl_FragColor = vec4( vec3( length( texture2D(u_texture, v_coord) * u_mask )), 1.0 );
		}
		`,t.registerNodeType("texture/textureChannels",I);function T(){this.addInput("R","Texture"),this.addInput("G","Texture"),this.addInput("B","Texture"),this.addInput("A","Texture"),this.addOutput("Texture","Texture"),this.properties={precision:r.DEFAULT,R:1,G:1,B:1,A:1},this._color=vec4.create(),this._uniforms={u_textureR:0,u_textureG:1,u_textureB:2,u_textureA:3,u_color:this._color}}T.title="Channels to Texture",T.desc="Split texture channels",T.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},T.prototype.onExecute=function(){var m=r.getWhiteTexture(),M=this.getInputData(0)||m,Z=this.getInputData(1)||m,it=this.getInputData(2)||m,gt=this.getInputData(3)||m;gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var Tt=Mesh.getScreenQuad();T._shader||(T._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,T.pixel_shader));var qt=T._shader,$t=Math.max(M.width,Z.width,it.width,gt.width),le=Math.max(M.height,Z.height,it.height,gt.height),ye=this.properties.precision==r.HIGH?r.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE;(!this._texture||this._texture.width!=$t||this._texture.height!=le||this._texture.type!=ye)&&(this._texture=new GL.Texture($t,le,{type:ye,format:gl.RGBA,filter:gl.LINEAR}));var ce=this._color;ce[0]=this.properties.R,ce[1]=this.properties.G,ce[2]=this.properties.B,ce[3]=this.properties.A;var Te=this._uniforms;this._texture.drawTo(function(){M.bind(0),Z.bind(1),it.bind(2),gt.bind(3),qt.uniforms(Te).draw(Tt)}),this.setOutputData(0,this._texture)},T.pixel_shader=`precision highp float;
		precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_textureR;
		uniform sampler2D u_textureG;
		uniform sampler2D u_textureB;
		uniform sampler2D u_textureA;
		uniform vec4 u_color;
		
		void main() {
		   gl_FragColor = u_color * vec4( 					texture2D(u_textureR, v_coord).r,					texture2D(u_textureG, v_coord).r,					texture2D(u_textureB, v_coord).r,					texture2D(u_textureA, v_coord).r);
		}
		`,t.registerNodeType("texture/channelsTexture",T);function L(){this.addOutput("Texture","Texture"),this._tex_color=vec4.create(),this.properties={color:vec4.create(),precision:r.DEFAULT}}L.title="Color",L.desc="Generates a 1x1 texture with a constant color",L.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},L.prototype.onDrawBackground=function(m){var M=this.properties.color;m.fillStyle="rgb("+Math.floor(clamp(M[0],0,1)*255)+","+Math.floor(clamp(M[1],0,1)*255)+","+Math.floor(clamp(M[2],0,1)*255)+")",this.flags.collapsed?this.boxcolor=m.fillStyle:m.fillRect(0,0,this.size[0],this.size[1])},L.prototype.onExecute=function(){var m=this.properties.precision==r.HIGH?r.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE;(!this._tex||this._tex.type!=m)&&(this._tex=new GL.Texture(1,1,{format:gl.RGBA,type:m,minFilter:gl.NEAREST}));var M=this.properties.color;if(this.inputs)for(var Z=0;Z<this.inputs.length;Z++){var it=this.inputs[Z],gt=this.getInputData(Z);if(gt!==void 0)switch(it.name){case"RGB":case"RGBA":M.set(gt);break;case"R":M[0]=gt;break;case"G":M[1]=gt;break;case"B":M[2]=gt;break;case"A":M[3]=gt;break}}vec4.sqrDist(this._tex_color,M)>.001&&(this._tex_color.set(M),this._tex.fill(M)),this.setOutputData(0,this._tex)},L.prototype.onGetInputs=function(){return[["RGB","vec3"],["RGBA","vec4"],["R","number"],["G","number"],["B","number"],["A","number"]]},t.registerNodeType("texture/color",L);function C(){this.addInput("A","color"),this.addInput("B","color"),this.addOutput("Texture","Texture"),this.properties={angle:0,scale:1,A:[0,0,0],B:[1,1,1],texture_size:32},C._shader||(C._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,C.pixel_shader)),this._uniforms={u_angle:0,u_colorA:vec3.create(),u_colorB:vec3.create()}}C.title="Gradient",C.desc="Generates a gradient",C["@A"]={type:"color"},C["@B"]={type:"color"},C["@texture_size"]={type:"enum",values:[32,64,128,256,512]},C.prototype.onExecute=function(){gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var m=GL.Mesh.getScreenQuad(),M=C._shader,Z=this.getInputData(0);Z||(Z=this.properties.A);var it=this.getInputData(1);it||(it=this.properties.B);for(var gt=2;gt<this.inputs.length;gt++){var Tt=this.inputs[gt],qt=this.getInputData(gt);qt!==void 0&&(this.properties[Tt.name]=qt)}var $t=this._uniforms;this._uniforms.u_angle=this.properties.angle*DEG2RAD,this._uniforms.u_scale=this.properties.scale,vec3.copy($t.u_colorA,Z),vec3.copy($t.u_colorB,it);var le=parseInt(this.properties.texture_size);(!this._tex||this._tex.width!=le)&&(this._tex=new GL.Texture(le,le,{format:gl.RGB,filter:gl.LINEAR})),this._tex.drawTo(function(){M.uniforms($t).draw(m)}),this.setOutputData(0,this._tex)},C.prototype.onGetInputs=function(){return[["angle","number"],["scale","number"]]},C.pixel_shader=`precision highp float;
		precision highp float;
		varying vec2 v_coord;
		uniform float u_angle;
		uniform float u_scale;
		uniform vec3 u_colorA;
		uniform vec3 u_colorB;
		
		vec2 rotate(vec2 v, float angle)
		{
			vec2 result;
			float _cos = cos(angle);
			float _sin = sin(angle);
			result.x = v.x * _cos - v.y * _sin;
			result.y = v.x * _sin + v.y * _cos;
			return result;
		}
		void main() {
			float f = (rotate(u_scale * (v_coord - vec2(0.5)), u_angle) + vec2(0.5)).x;
			vec3 color = mix(u_colorA,u_colorB,clamp(f,0.0,1.0));
		   gl_FragColor = vec4(color,1.0);
		}
		`,t.registerNodeType("texture/gradient",C);function N(){this.addInput("A","Texture"),this.addInput("B","Texture"),this.addInput("Mixer","Texture"),this.addOutput("Texture","Texture"),this.properties={factor:.5,size_from_biggest:!0,invert:!1,precision:r.DEFAULT},this._uniforms={u_textureA:0,u_textureB:1,u_textureMix:2,u_mix:vec4.create()}}N.title="Mix",N.desc="Generates a texture mixing two textures",N.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},N.prototype.onExecute=function(){var m=this.getInputData(0);if(this.isOutputConnected(0)){if(this.properties.precision===r.PASS_THROUGH){this.setOutputData(0,m);return}var M=this.getInputData(1);if(!(!m||!M)){var Z=this.getInputData(2),it=this.getInputData(3);this._tex=r.getTargetTexture(this.properties.size_from_biggest&&M.width>m.width?M:m,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var gt=Mesh.getScreenQuad(),Tt=null,qt=this._uniforms;if(Z)Tt=N._shader_tex,Tt||(Tt=N._shader_tex=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,N.pixel_shader,{MIX_TEX:""}));else{Tt=N._shader_factor,Tt||(Tt=N._shader_factor=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,N.pixel_shader));var $t=it??this.properties.factor;qt.u_mix.set([$t,$t,$t,$t])}var le=this.properties.invert;this._tex.drawTo(function(){m.bind(le?1:0),M.bind(le?0:1),Z&&Z.bind(2),Tt.uniforms(qt).draw(gt)}),this.setOutputData(0,this._tex)}}},N.prototype.onGetInputs=function(){return[["factor","number"]]},N.pixel_shader=`precision highp float;
		precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_textureA;
		uniform sampler2D u_textureB;
		#ifdef MIX_TEX
			uniform sampler2D u_textureMix;
		#else
			uniform vec4 u_mix;
		#endif
		
		void main() {
			#ifdef MIX_TEX
			   vec4 f = texture2D(u_textureMix, v_coord);
			#else
			   vec4 f = u_mix;
			#endif
		   gl_FragColor = mix( texture2D(u_textureA, v_coord), texture2D(u_textureB, v_coord), f );
		}
		`,t.registerNodeType("texture/mix",N);function R(){this.addInput("Tex.","Texture"),this.addOutput("Edges","Texture"),this.properties={invert:!0,threshold:!1,factor:1,precision:r.DEFAULT},R._shader||(R._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,R.pixel_shader))}R.title="Edges",R.desc="Detects edges",R.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},R.prototype.onExecute=function(){if(this.isOutputConnected(0)){var m=this.getInputData(0);if(this.properties.precision===r.PASS_THROUGH){this.setOutputData(0,m);return}if(m){this._tex=r.getTargetTexture(m,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var M=Mesh.getScreenQuad(),Z=R._shader,it=this.properties.invert,gt=this.properties.factor,Tt=this.properties.threshold?1:0;this._tex.drawTo(function(){m.bind(0),Z.uniforms({u_texture:0,u_isize:[1/m.width,1/m.height],u_factor:gt,u_threshold:Tt,u_invert:it?1:0}).draw(M)}),this.setOutputData(0,this._tex)}}},R.pixel_shader=`precision highp float;
		precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform vec2 u_isize;
		uniform int u_invert;
		uniform float u_factor;
		uniform float u_threshold;
		
		void main() {
			vec4 center = texture2D(u_texture, v_coord);
			vec4 up = texture2D(u_texture, v_coord + u_isize * vec2(0.0,1.0) );
			vec4 down = texture2D(u_texture, v_coord + u_isize * vec2(0.0,-1.0) );
			vec4 left = texture2D(u_texture, v_coord + u_isize * vec2(1.0,0.0) );
			vec4 right = texture2D(u_texture, v_coord + u_isize * vec2(-1.0,0.0) );
			vec4 diff = abs(center - up) + abs(center - down) + abs(center - left) + abs(center - right);
			diff *= u_factor;
			if(u_invert == 1)
				diff.xyz = vec3(1.0) - diff.xyz;
			if( u_threshold == 0.0 )
				gl_FragColor = vec4( diff.xyz, center.a );
			else
				gl_FragColor = vec4( diff.x > 0.5 ? 1.0 : 0.0, diff.y > 0.5 ? 1.0 : 0.0, diff.z > 0.5 ? 1.0 : 0.0, center.a );
		}
		`,t.registerNodeType("texture/edges",R);function Y(){this.addInput("Texture","Texture"),this.addInput("Distance","number"),this.addInput("Range","number"),this.addOutput("Texture","Texture"),this.properties={distance:100,range:50,only_depth:!1,high_precision:!1},this._uniforms={u_texture:0,u_distance:100,u_range:50,u_camera_planes:null}}Y.title="Depth Range",Y.desc="Generates a texture with a depth range",Y.prototype.onExecute=function(){if(this.isOutputConnected(0)){var m=this.getInputData(0);if(m){var M=gl.UNSIGNED_BYTE;this.properties.high_precision&&(M=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.FLOAT),(!this._temp_texture||this._temp_texture.type!=M||this._temp_texture.width!=m.width||this._temp_texture.height!=m.height)&&(this._temp_texture=new GL.Texture(m.width,m.height,{type:M,format:gl.RGBA,filter:gl.LINEAR}));var Z=this._uniforms,it=this.properties.distance;this.isInputConnected(1)&&(it=this.getInputData(1),this.properties.distance=it);var gt=this.properties.range;this.isInputConnected(2)&&(gt=this.getInputData(2),this.properties.range=gt),Z.u_distance=it,Z.u_range=gt,gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var Tt=Mesh.getScreenQuad();Y._shader||(Y._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,Y.pixel_shader),Y._shader_onlydepth=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,Y.pixel_shader,{ONLY_DEPTH:""}));var qt=this.properties.only_depth?Y._shader_onlydepth:Y._shader,$t=null;m.near_far_planes?$t=m.near_far_planes:window.LS&&LS.Renderer._main_camera?$t=LS.Renderer._main_camera._uniforms.u_camera_planes:$t=[.1,1e3],Z.u_camera_planes=$t,this._temp_texture.drawTo(function(){m.bind(0),qt.uniforms(Z).draw(Tt)}),this._temp_texture.near_far_planes=$t,this.setOutputData(0,this._temp_texture)}}},Y.pixel_shader=`precision highp float;
		precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform vec2 u_camera_planes;
		uniform float u_distance;
		uniform float u_range;
		
		float LinearDepth()
		{
			float zNear = u_camera_planes.x;
			float zFar = u_camera_planes.y;
			float depth = texture2D(u_texture, v_coord).x;
			depth = depth * 2.0 - 1.0;
			return zNear * (depth + 1.0) / (zFar + zNear - depth * (zFar - zNear));
		}
		
		void main() {
			float depth = LinearDepth();
			#ifdef ONLY_DEPTH
			   gl_FragColor = vec4(depth);
			#else
				float diff = abs(depth * u_camera_planes.y - u_distance);
				float dof = 1.0;
				if(diff <= u_range)
					dof = diff / u_range;
			   gl_FragColor = vec4(dof);
			#endif
		}
		`,t.registerNodeType("texture/depth_range",Y);function ut(){this.addInput("Texture","Texture"),this.addOutput("Texture","Texture"),this.properties={precision:r.DEFAULT,invert:!1},this._uniforms={u_texture:0,u_camera_planes:null,u_ires:vec2.create()}}ut.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},ut.title="Linear Depth",ut.desc="Creates a color texture with linear depth",ut.prototype.onExecute=function(){if(this.isOutputConnected(0)){var m=this.getInputData(0);if(!(!m||m.format!=gl.DEPTH_COMPONENT&&m.format!=gl.DEPTH_STENCIL)){var M=this.properties.precision==r.HIGH?gl.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE;(!this._temp_texture||this._temp_texture.type!=M||this._temp_texture.width!=m.width||this._temp_texture.height!=m.height)&&(this._temp_texture=new GL.Texture(m.width,m.height,{type:M,format:gl.RGB,filter:gl.LINEAR}));var Z=this._uniforms;Z.u_invert=this.properties.invert?1:0,gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var it=Mesh.getScreenQuad();ut._shader||(ut._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,ut.pixel_shader));var gt=ut._shader,Tt=null;m.near_far_planes?Tt=m.near_far_planes:window.LS&&LS.Renderer._main_camera?Tt=LS.Renderer._main_camera._uniforms.u_camera_planes:Tt=[.1,1e3],Z.u_camera_planes=Tt,Z.u_ires.set([0,0]),this._temp_texture.drawTo(function(){m.bind(0),gt.uniforms(Z).draw(it)}),this._temp_texture.near_far_planes=Tt,this.setOutputData(0,this._temp_texture)}}},ut.pixel_shader=`precision highp float;
		precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform vec2 u_camera_planes;
		uniform int u_invert;
		uniform vec2 u_ires;
		
		void main() {
			float zNear = u_camera_planes.x;
			float zFar = u_camera_planes.y;
			float depth = texture2D(u_texture, v_coord + u_ires*0.5).x * 2.0 - 1.0;
			float f = zNear * (depth + 1.0) / (zFar + zNear - depth * (zFar - zNear));
			if( u_invert == 1 )
				f = 1.0 - f;
			gl_FragColor = vec4(vec3(f),1.0);
		}
		`,t.registerNodeType("texture/linear_depth",ut);function mt(){this.addInput("Texture","Texture"),this.addInput("Iterations","number"),this.addInput("Intensity","number"),this.addOutput("Blurred","Texture"),this.properties={intensity:1,iterations:1,preserve_aspect:!1,scale:[1,1],precision:r.DEFAULT}}mt.title="Blur",mt.desc="Blur a texture",mt.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},mt.max_iterations=20,mt.prototype.onExecute=function(){var m=this.getInputData(0);if(m&&this.isOutputConnected(0)){var M=this._final_texture;(!M||M.width!=m.width||M.height!=m.height||M.type!=m.type)&&(M=this._final_texture=new GL.Texture(m.width,m.height,{type:m.type,format:gl.RGBA,filter:gl.LINEAR}));var Z=this.properties.iterations;if(this.isInputConnected(1)&&(Z=this.getInputData(1),this.properties.iterations=Z),Z=Math.min(Math.floor(Z),mt.max_iterations),Z==0){this.setOutputData(0,m);return}var it=this.properties.intensity;this.isInputConnected(2)&&(it=this.getInputData(2),this.properties.intensity=it);var gt=t.camera_aspect;!gt&&window.gl!==void 0&&(gt=gl.canvas.height/gl.canvas.width),gt||(gt=1),gt=this.properties.preserve_aspect?gt:1;var Tt=this.properties.scale||[1,1];m.applyBlur(gt*Tt[0],Tt[1],it,M);for(var qt=1;qt<Z;++qt)M.applyBlur(gt*Tt[0]*(qt+1),Tt[1]*(qt+1),it);this.setOutputData(0,M)}},t.registerNodeType("texture/blur",mt);function yt(){this.intensity=.5,this.persistence=.6,this.iterations=8,this.threshold=.8,this.scale=1,this.dirt_texture=null,this.dirt_factor=.5,this._textures=[],this._uniforms={u_intensity:1,u_texture:0,u_glow_texture:1,u_threshold:0,u_texel_size:vec2.create()}}yt.prototype.applyFX=function(m,M,Z,it){var gt=m.width,Tt=m.height,qt={format:m.format,type:m.type,minFilter:GL.LINEAR,magFilter:GL.LINEAR,wrap:gl.CLAMP_TO_EDGE},$t=this._uniforms,le=this._textures,He=yt._cut_shader;He||(He=yt._cut_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,yt.cut_pixel_shader)),gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),$t.u_threshold=this.threshold;var ye=le[0]=GL.Texture.getTemporary(gt,Tt,qt);m.blit(ye,He.uniforms($t));var ce=ye,Te=this.iterations;Te=clamp(Te,1,16)|0;var Be=$t.u_texel_size,dr=this.intensity;$t.u_intensity=1,$t.u_delta=this.scale;var He=yt._shader;He||(He=yt._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,yt.scale_pixel_shader));for(var ir=1;ir<Te&&(gt=gt>>1,(Tt|0)>1&&(Tt=Tt>>1),!(gt<2));ir++)ye=le[ir]=GL.Texture.getTemporary(gt,Tt,qt),Be[0]=1/ce.width,Be[1]=1/ce.height,ce.blit(ye,He.uniforms($t)),ce=ye;for(it&&(Be[0]=1/ce.width,Be[1]=1/ce.height,$t.u_intensity=dr,$t.u_delta=1,ce.blit(it,He.uniforms($t))),gl.enable(gl.BLEND),gl.blendFunc(gl.ONE,gl.ONE),$t.u_intensity=this.persistence,$t.u_delta=.5,ir-=2;ir>=0;ir--)ye=le[ir],le[ir]=null,Be[0]=1/ce.width,Be[1]=1/ce.height,ce.blit(ye,He.uniforms($t)),GL.Texture.releaseTemporary(ce),ce=ye;if(gl.disable(gl.BLEND),Z&&ce.blit(Z),M){var V=M,Or=this.dirt_texture,Mi=this.dirt_factor;$t.u_intensity=dr,He=Or?yt._dirt_final_shader:yt._final_shader,He||(Or?He=yt._dirt_final_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,yt.final_pixel_shader,{USE_DIRT:""}):He=yt._final_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,yt.final_pixel_shader)),V.drawTo(function(){m.bind(0),ce.bind(1),Or&&(He.setUniform("u_dirt_factor",Mi),He.setUniform("u_dirt_texture",Or.bind(2))),He.toViewport($t)})}GL.Texture.releaseTemporary(ce)},yt.cut_pixel_shader=`precision highp float;
	varying vec2 v_coord;
	uniform sampler2D u_texture;
	uniform float u_threshold;
	void main() {
		gl_FragColor = max( texture2D( u_texture, v_coord ) - vec4( u_threshold ), vec4(0.0) );
	}`,yt.scale_pixel_shader=`precision highp float;
	varying vec2 v_coord;
	uniform sampler2D u_texture;
	uniform vec2 u_texel_size;
	uniform float u_delta;
	uniform float u_intensity;
	
	vec4 sampleBox(vec2 uv) {
		vec4 o = u_texel_size.xyxy * vec2(-u_delta, u_delta).xxyy;
		vec4 s = texture2D( u_texture, uv + o.xy ) + texture2D( u_texture, uv + o.zy) + texture2D( u_texture, uv + o.xw) + texture2D( u_texture, uv + o.zw);
		return s * 0.25;
	}
	void main() {
		gl_FragColor = u_intensity * sampleBox( v_coord );
	}`,yt.final_pixel_shader=`precision highp float;
	varying vec2 v_coord;
	uniform sampler2D u_texture;
	uniform sampler2D u_glow_texture;
	#ifdef USE_DIRT
		uniform sampler2D u_dirt_texture;
	#endif
	uniform vec2 u_texel_size;
	uniform float u_delta;
	uniform float u_intensity;
	uniform float u_dirt_factor;
	
	vec4 sampleBox(vec2 uv) {
		vec4 o = u_texel_size.xyxy * vec2(-u_delta, u_delta).xxyy;
		vec4 s = texture2D( u_glow_texture, uv + o.xy ) + texture2D( u_glow_texture, uv + o.zy) + texture2D( u_glow_texture, uv + o.xw) + texture2D( u_glow_texture, uv + o.zw);
		return s * 0.25;
	}
	void main() {
		vec4 glow = sampleBox( v_coord );
		#ifdef USE_DIRT
			glow = mix( glow, glow * texture2D( u_dirt_texture, v_coord ), u_dirt_factor );
		#endif
		gl_FragColor = texture2D( u_texture, v_coord ) + u_intensity * glow;
	}`;function D(){this.addInput("in","Texture"),this.addInput("dirt","Texture"),this.addOutput("out","Texture"),this.addOutput("glow","Texture"),this.properties={enabled:!0,intensity:1,persistence:.99,iterations:16,threshold:0,scale:1,dirt_factor:.5,precision:r.DEFAULT},this.fx=new yt}D.title="Glow",D.desc="Filters a texture giving it a glow effect",D.widgets_info={iterations:{type:"number",min:0,max:16,step:1,precision:0},threshold:{type:"number",min:0,max:10,step:.01,precision:2},precision:{widget:"combo",values:r.MODE_VALUES}},D.prototype.onGetInputs=function(){return[["enabled","boolean"],["threshold","number"],["intensity","number"],["persistence","number"],["iterations","number"],["dirt_factor","number"]]},D.prototype.onGetOutputs=function(){return[["average","Texture"]]},D.prototype.onExecute=function(){var m=this.getInputData(0);if(m&&this.isAnyOutputConnected()){if(this.properties.precision===r.PASS_THROUGH||this.getInputOrProperty("enabled")===!1){this.setOutputData(0,m);return}m.width,m.height;var M=this.fx;M.threshold=this.getInputOrProperty("threshold"),M.iterations=this.getInputOrProperty("iterations"),M.intensity=this.getInputOrProperty("intensity"),M.persistence=this.getInputOrProperty("persistence"),M.dirt_texture=this.getInputData(1),M.dirt_factor=this.getInputOrProperty("dirt_factor"),M.scale=this.properties.scale;var Z=r.getTextureType(this.properties.precision,m),it=null;this.isOutputConnected(2)&&(it=this._average_texture,(!it||it.type!=m.type||it.format!=m.format)&&(it=this._average_texture=new GL.Texture(1,1,{type:m.type,format:m.format,filter:gl.LINEAR})));var gt=null;this.isOutputConnected(1)&&(gt=this._glow_texture,(!gt||gt.width!=m.width||gt.height!=m.height||gt.type!=Z||gt.format!=m.format)&&(gt=this._glow_texture=new GL.Texture(m.width,m.height,{type:Z,format:m.format,filter:gl.LINEAR})));var Tt=null;this.isOutputConnected(0)&&(Tt=this._final_texture,(!Tt||Tt.width!=m.width||Tt.height!=m.height||Tt.type!=Z||Tt.format!=m.format)&&(Tt=this._final_texture=new GL.Texture(m.width,m.height,{type:Z,format:m.format,filter:gl.LINEAR}))),M.applyFX(m,Tt,gt,it),this.isOutputConnected(0)&&this.setOutputData(0,Tt),this.isOutputConnected(1)&&this.setOutputData(1,it),this.isOutputConnected(2)&&this.setOutputData(2,gt)}},t.registerNodeType("texture/glow",D);function F(){this.addInput("Texture","Texture"),this.addOutput("Filtered","Texture"),this.properties={intensity:1,radius:5}}F.title="Kuwahara Filter",F.desc="Filters a texture giving an artistic oil canvas painting",F.max_radius=10,F._shaders=[],F.prototype.onExecute=function(){var m=this.getInputData(0);if(m&&this.isOutputConnected(0)){var M=this._temp_texture;(!M||M.width!=m.width||M.height!=m.height||M.type!=m.type)&&(this._temp_texture=new GL.Texture(m.width,m.height,{type:m.type,format:gl.RGBA,filter:gl.LINEAR}));var Z=this.properties.radius;if(Z=Math.min(Math.floor(Z),F.max_radius),Z==0){this.setOutputData(0,m);return}var it=this.properties.intensity,gt=t.camera_aspect;!gt&&window.gl!==void 0&&(gt=gl.canvas.height/gl.canvas.width),gt||(gt=1),gt=this.properties.preserve_aspect?gt:1,F._shaders[Z]||(F._shaders[Z]=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,F.pixel_shader,{RADIUS:Z.toFixed(0)}));var Tt=F._shaders[Z],qt=GL.Mesh.getScreenQuad();m.bind(0),this._temp_texture.drawTo(function(){Tt.uniforms({u_texture:0,u_intensity:it,u_resolution:[m.width,m.height],u_iResolution:[1/m.width,1/m.height]}).draw(qt)}),this.setOutputData(0,this._temp_texture)}},F.pixel_shader=`
precision highp float;
varying vec2 v_coord;
uniform sampler2D u_texture;
uniform float u_intensity;
uniform vec2 u_resolution;
uniform vec2 u_iResolution;
#ifndef RADIUS
	#define RADIUS 7
#endif
void main() {

	const int radius = RADIUS;
	vec2 fragCoord = v_coord;
	vec2 src_size = u_iResolution;
	vec2 uv = v_coord;
	float n = float((radius + 1) * (radius + 1));
	int i;
	int j;
	vec3 m0 = vec3(0.0); vec3 m1 = vec3(0.0); vec3 m2 = vec3(0.0); vec3 m3 = vec3(0.0);
	vec3 s0 = vec3(0.0); vec3 s1 = vec3(0.0); vec3 s2 = vec3(0.0); vec3 s3 = vec3(0.0);
	vec3 c;
	
	for (int j = -radius; j <= 0; ++j)  {
		for (int i = -radius; i <= 0; ++i)  {
			c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;
			m0 += c;
			s0 += c * c;
		}
	}
	
	for (int j = -radius; j <= 0; ++j)  {
		for (int i = 0; i <= radius; ++i)  {
			c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;
			m1 += c;
			s1 += c * c;
		}
	}
	
	for (int j = 0; j <= radius; ++j)  {
		for (int i = 0; i <= radius; ++i)  {
			c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;
			m2 += c;
			s2 += c * c;
		}
	}
	
	for (int j = 0; j <= radius; ++j)  {
		for (int i = -radius; i <= 0; ++i)  {
			c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;
			m3 += c;
			s3 += c * c;
		}
	}
	
	float min_sigma2 = 1e+2;
	m0 /= n;
	s0 = abs(s0 / n - m0 * m0);
	
	float sigma2 = s0.r + s0.g + s0.b;
	if (sigma2 < min_sigma2) {
		min_sigma2 = sigma2;
		gl_FragColor = vec4(m0, 1.0);
	}
	
	m1 /= n;
	s1 = abs(s1 / n - m1 * m1);
	
	sigma2 = s1.r + s1.g + s1.b;
	if (sigma2 < min_sigma2) {
		min_sigma2 = sigma2;
		gl_FragColor = vec4(m1, 1.0);
	}
	
	m2 /= n;
	s2 = abs(s2 / n - m2 * m2);
	
	sigma2 = s2.r + s2.g + s2.b;
	if (sigma2 < min_sigma2) {
		min_sigma2 = sigma2;
		gl_FragColor = vec4(m2, 1.0);
	}
	
	m3 /= n;
	s3 = abs(s3 / n - m3 * m3);
	
	sigma2 = s3.r + s3.g + s3.b;
	if (sigma2 < min_sigma2) {
		min_sigma2 = sigma2;
		gl_FragColor = vec4(m3, 1.0);
	}
}
`,t.registerNodeType("texture/kuwahara",F);function E(){this.addInput("Texture","Texture"),this.addOutput("Filtered","Texture"),this.properties={sigma:1.4,k:1.6,p:21.7,epsilon:79,phi:.017}}E.title="XDoG Filter",E.desc="Filters a texture giving an artistic ink style",E.max_radius=10,E._shaders=[],E.prototype.onExecute=function(){var m=this.getInputData(0);if(m&&this.isOutputConnected(0)){var M=this._temp_texture;(!M||M.width!=m.width||M.height!=m.height||M.type!=m.type)&&(this._temp_texture=new GL.Texture(m.width,m.height,{type:m.type,format:gl.RGBA,filter:gl.LINEAR})),E._xdog_shader||(E._xdog_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,E.xdog_pixel_shader));var Z=E._xdog_shader,it=GL.Mesh.getScreenQuad(),gt=this.properties.sigma,Tt=this.properties.k,qt=this.properties.p,$t=this.properties.epsilon,le=this.properties.phi;m.bind(0),this._temp_texture.drawTo(function(){Z.uniforms({src:0,sigma:gt,k:Tt,p:qt,epsilon:$t,phi:le,cvsWidth:m.width,cvsHeight:m.height}).draw(it)}),this.setOutputData(0,this._temp_texture)}},E.xdog_pixel_shader=`
precision highp float;
uniform sampler2D src;

uniform float cvsHeight;
uniform float cvsWidth;

uniform float sigma;
uniform float k;
uniform float p;
uniform float epsilon;
uniform float phi;
varying vec2 v_coord;

float cosh(float val)
{
	float tmp = exp(val);
	float cosH = (tmp + 1.0 / tmp) / 2.0;
	return cosH;
}

float tanh(float val)
{
	float tmp = exp(val);
	float tanH = (tmp - 1.0 / tmp) / (tmp + 1.0 / tmp);
	return tanH;
}

float sinh(float val)
{
	float tmp = exp(val);
	float sinH = (tmp - 1.0 / tmp) / 2.0;
	return sinH;
}

void main(void){
	vec3 destColor = vec3(0.0);
	float tFrag = 1.0 / cvsHeight;
	float sFrag = 1.0 / cvsWidth;
	vec2 Frag = vec2(sFrag,tFrag);
	vec2 uv = gl_FragCoord.st;
	float twoSigmaESquared = 2.0 * sigma * sigma;
	float twoSigmaRSquared = twoSigmaESquared * k * k;
	int halfWidth = int(ceil( 1.0 * sigma * k ));

	const int MAX_NUM_ITERATION = 99999;
	vec2 sum = vec2(0.0);
	vec2 norm = vec2(0.0);

	for(int cnt=0;cnt<MAX_NUM_ITERATION;cnt++){
		if(cnt > (2*halfWidth+1)*(2*halfWidth+1)){break;}
		int i = int(cnt / (2*halfWidth+1)) - halfWidth;
		int j = cnt - halfWidth - int(cnt / (2*halfWidth+1)) * (2*halfWidth+1);

		float d = length(vec2(i,j));
		vec2 kernel = vec2( exp( -d * d / twoSigmaESquared ), 
							exp( -d * d / twoSigmaRSquared ));

		vec2 L = texture2D(src, (uv + vec2(i,j)) * Frag).xx;

		norm += kernel;
		sum += kernel * L;
	}

	sum /= norm;

	float H = 100.0 * ((1.0 + p) * sum.x - p * sum.y);
	float edge = ( H > epsilon )? 1.0 : 1.0 + tanh( phi * (H - epsilon));
	destColor = vec3(edge);
	gl_FragColor = vec4(destColor, 1.0);
}`,t.registerNodeType("texture/xDoG",E);function Q(){this.addOutput("Webcam","Texture"),this.properties={texture_name:"",facingMode:"user"},this.boxcolor="black",this.version=0}Q.title="Webcam",Q.desc="Webcam texture",Q.is_webcam_open=!1,Q.prototype.openStream=function(){if(!navigator.getUserMedia)return;this._waiting_confirmation=!0;var m={audio:!1,video:{facingMode:this.properties.facingMode}};navigator.mediaDevices.getUserMedia(m).then(this.streamReady.bind(this)).catch(Z);var M=this;function Z(it){Q.is_webcam_open=!1,console.log("Webcam rejected",it),M._webcam_stream=!1,M.boxcolor="red",M.trigger("stream_error")}},Q.prototype.closeStream=function(){if(this._webcam_stream){var m=this._webcam_stream.getTracks();if(m.length)for(var M=0;M<m.length;++M)m[M].stop();Q.is_webcam_open=!1,this._webcam_stream=null,this._video=null,this.boxcolor="black",this.trigger("stream_closed")}},Q.prototype.streamReady=function(m){this._webcam_stream=m,this.boxcolor="green";var M=this._video;M||(M=document.createElement("video"),M.autoplay=!0,M.srcObject=m,this._video=M,M.onloadedmetadata=function(Z){Q.is_webcam_open=!0,console.log(Z)}),this.trigger("stream_ready",M)},Q.prototype.onPropertyChanged=function(m,M){m=="facingMode"&&(this.properties.facingMode=M,this.closeStream(),this.openStream())},Q.prototype.onRemoved=function(){if(this._webcam_stream){var m=this._webcam_stream.getTracks();if(m.length)for(var M=0;M<m.length;++M)m[M].stop();this._webcam_stream=null,this._video=null}},Q.prototype.onDrawBackground=function(m){this.flags.collapsed||this.size[1]<=20||this._video&&(m.save(),m.webgl?this._video_texture&&m.drawImage(this._video_texture,0,0,this.size[0],this.size[1]):m.drawImage(this._video,0,0,this.size[0],this.size[1]),m.restore())},Q.prototype.onExecute=function(){if(this._webcam_stream==null&&!this._waiting_confirmation&&this.openStream(),!(!this._video||!this._video.videoWidth)){var m=this._video.videoWidth,M=this._video.videoHeight,Z=this._video_texture;if((!Z||Z.width!=m||Z.height!=M)&&(this._video_texture=new GL.Texture(m,M,{format:gl.RGB,filter:gl.LINEAR})),this._video_texture.uploadImage(this._video),this._video_texture.version=++this.version,this.properties.texture_name){var it=r.getTexturesContainer();it[this.properties.texture_name]=this._video_texture}this.setOutputData(0,this._video_texture);for(var gt=1;gt<this.outputs.length;++gt)if(this.outputs[gt])switch(this.outputs[gt].name){case"width":this.setOutputData(gt,this._video.videoWidth);break;case"height":this.setOutputData(gt,this._video.videoHeight);break}}},Q.prototype.onGetOutputs=function(){return[["width","number"],["height","number"],["stream_ready",t.EVENT],["stream_closed",t.EVENT],["stream_error",t.EVENT]]},t.registerNodeType("texture/webcam",Q);function P(){this.addInput("in","Texture"),this.addInput("f","number"),this.addOutput("out","Texture"),this.properties={enabled:!0,factor:1,precision:r.LOW},this._uniforms={u_texture:0,u_factor:1}}P.title="Lens FX",P.desc="distortion and chromatic aberration",P.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},P.prototype.onGetInputs=function(){return[["enabled","boolean"]]},P.prototype.onExecute=function(){var m=this.getInputData(0);if(m&&this.isOutputConnected(0)){if(this.properties.precision===r.PASS_THROUGH||this.getInputOrProperty("enabled")===!1){this.setOutputData(0,m);return}var M=this._temp_texture;(!M||M.width!=m.width||M.height!=m.height||M.type!=m.type)&&(M=this._temp_texture=new GL.Texture(m.width,m.height,{type:m.type,format:gl.RGBA,filter:gl.LINEAR}));var Z=P._shader;Z||(Z=P._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,P.pixel_shader));var it=this.getInputData(1);it==null&&(it=this.properties.factor);var gt=this._uniforms;gt.u_factor=it,gl.disable(gl.DEPTH_TEST),M.drawTo(function(){m.bind(0),Z.uniforms(gt).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,M)}},P.pixel_shader=`precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform float u_factor;
		vec2 barrelDistortion(vec2 coord, float amt) {
			vec2 cc = coord - 0.5;
			float dist = dot(cc, cc);
			return coord + cc * dist * amt;
		}
		
		float sat( float t )
		{
			return clamp( t, 0.0, 1.0 );
		}
		
		float linterp( float t ) {
			return sat( 1.0 - abs( 2.0*t - 1.0 ) );
		}
		
		float remap( float t, float a, float b ) {
			return sat( (t - a) / (b - a) );
		}
		
		vec4 spectrum_offset( float t ) {
			vec4 ret;
			float lo = step(t,0.5);
			float hi = 1.0-lo;
			float w = linterp( remap( t, 1.0/6.0, 5.0/6.0 ) );
			ret = vec4(lo,1.0,hi, 1.) * vec4(1.0-w, w, 1.0-w, 1.);
		
			return pow( ret, vec4(1.0/2.2) );
		}
		
		const float max_distort = 2.2;
		const int num_iter = 12;
		const float reci_num_iter_f = 1.0 / float(num_iter);
		
		void main()
		{	
			vec2 uv=v_coord;
			vec4 sumcol = vec4(0.0);
			vec4 sumw = vec4(0.0);	
			for ( int i=0; i<num_iter;++i )
			{
				float t = float(i) * reci_num_iter_f;
				vec4 w = spectrum_offset( t );
				sumw += w;
				sumcol += w * texture2D( u_texture, barrelDistortion(uv, .6 * max_distort*t * u_factor ) );
			}
			gl_FragColor = sumcol / sumw;
		}`,t.registerNodeType("texture/lensfx",P);function H(){this.addInput("in",""),this.properties={precision:r.LOW,width:0,height:0,channels:1},this.addOutput("out","Texture")}H.title="Data->Tex",H.desc="Generates or applies a curve to a texture",H.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},H.prototype.onExecute=function(){if(this.isOutputConnected(0)){var m=this.getInputData(0);if(m){var M=this.properties.channels,Z=this.properties.width,it=this.properties.height;(!Z||!it)&&(Z=Math.floor(m.length/M),it=1);var gt=gl.RGBA;M==3?gt=gl.RGB:M==1&&(gt=gl.LUMINANCE);var Tt=this._temp_texture,qt=r.getTextureType(this.properties.precision);(!Tt||Tt.width!=Z||Tt.height!=it||Tt.type!=qt)&&(Tt=this._temp_texture=new GL.Texture(Z,it,{type:qt,format:gt,filter:gl.LINEAR})),Tt.uploadData(m),this.setOutputData(0,Tt)}}},t.registerNodeType("texture/fromdata",H);function q(){this.addInput("in","Texture"),this.addOutput("out","Texture"),this.properties={precision:r.LOW,split_channels:!1},this._values=new Uint8Array(256*4),this._values.fill(255),this._curve_texture=null,this._uniforms={u_texture:0,u_curve:1,u_range:1},this._must_update=!0,this._points={RGB:[[0,0],[1,1]],R:[[0,0],[1,1]],G:[[0,0],[1,1]],B:[[0,0],[1,1]]},this.curve_editor=null,this.addWidget("toggle","Split Channels",!1,"split_channels"),this.addWidget("combo","Channel","RGB",{values:["RGB","R","G","B"]}),this.curve_offset=68,this.size=[240,160]}q.title="Curve",q.desc="Generates or applies a curve to a texture",q.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},q.prototype.onExecute=function(){if(this.isOutputConnected(0)){var m=this.getInputData(0),M=this._temp_texture;if(!m){(this._must_update||!this._curve_texture)&&this.updateCurve(),this.setOutputData(0,this._curve_texture);return}var Z=r.getTextureType(this.properties.precision,m);(!M||M.type!=Z||M.width!=m.width||M.height!=m.height||M.format!=m.format)&&(M=this._temp_texture=new GL.Texture(m.width,m.height,{type:Z,format:m.format,filter:gl.LINEAR}));var it=q._shader;it||(it=q._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,q.pixel_shader)),(this._must_update||!this._curve_texture)&&this.updateCurve();var gt=this._uniforms,Tt=this._curve_texture;M.drawTo(function(){gl.disable(gl.DEPTH_TEST),m.bind(0),Tt.bind(1),it.uniforms(gt).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,M)}},q.prototype.sampleCurve=function(m,Z){var Z=Z||this._points.RGB;if(Z){for(var it=0;it<Z.length-1;++it){var gt=Z[it],Tt=Z[it+1];if(!(Tt[0]<m)){var qt=Tt[0]-gt[0];if(Math.abs(qt)<1e-5)return gt[1];var $t=(m-gt[0])/qt;return gt[1]*(1-$t)+Tt[1]*$t}}return 0}},q.prototype.updateCurve=function(){for(var m=this._values,M=m.length/4,Z=this.properties.split_channels,it=0;it<M;++it){if(Z)m[it*4]=clamp(this.sampleCurve(it/M,this._points.R)*255,0,255),m[it*4+1]=clamp(this.sampleCurve(it/M,this._points.G)*255,0,255),m[it*4+2]=clamp(this.sampleCurve(it/M,this._points.B)*255,0,255);else{var gt=this.sampleCurve(it/M);m[it*4]=m[it*4+1]=m[it*4+2]=clamp(gt*255,0,255)}m[it*4+3]=255}this._curve_texture||(this._curve_texture=new GL.Texture(256,1,{format:gl.RGBA,magFilter:gl.LINEAR,wrap:gl.CLAMP_TO_EDGE})),this._curve_texture.uploadData(m,null,!0)},q.prototype.onSerialize=function(m){var M={};for(var Z in this._points)M[Z]=this._points[Z].concat();m.curves=M},q.prototype.onConfigure=function(m){this._points=m.curves,this.curve_editor&&(curve_editor.points=this._points),this._must_update=!0},q.prototype.onMouseDown=function(m,M,Z){if(this.curve_editor){var it=this.curve_editor.onMouseDown([M[0],M[1]-this.curve_offset],Z);return it&&this.captureInput(!0),it}},q.prototype.onMouseMove=function(m,M,Z){if(this.curve_editor)return this.curve_editor.onMouseMove([M[0],M[1]-this.curve_offset],Z)},q.prototype.onMouseUp=function(m,M,Z){if(this.curve_editor)return this.curve_editor.onMouseUp([M[0],M[1]-this.curve_offset],Z);this.captureInput(!1)},q.channel_line_colors={RGB:"#666",R:"#F33",G:"#3F3",B:"#33F"},q.prototype.onDrawBackground=function(m,M){if(!this.flags.collapsed){this.curve_editor||(this.curve_editor=new t.CurveEditor(this._points.R)),m.save(),m.translate(0,this.curve_offset);var Z=this.widgets[1].value;this.properties.split_channels?(Z=="RGB"&&(this.widgets[1].value=Z="R",this.widgets[1].disabled=!1),this.curve_editor.points=this._points.R,this.curve_editor.draw(m,[this.size[0],this.size[1]-this.curve_offset],M,"#111",q.channel_line_colors.R,!0),m.globalCompositeOperation="lighten",this.curve_editor.points=this._points.G,this.curve_editor.draw(m,[this.size[0],this.size[1]-this.curve_offset],M,null,q.channel_line_colors.G,!0),this.curve_editor.points=this._points.B,this.curve_editor.draw(m,[this.size[0],this.size[1]-this.curve_offset],M,null,q.channel_line_colors.B,!0),m.globalCompositeOperation="source-over"):(this.widgets[1].value=Z="RGB",this.widgets[1].disabled=!0),this.curve_editor.points=this._points[Z],this.curve_editor.draw(m,[this.size[0],this.size[1]-this.curve_offset],M,this.properties.split_channels?null:"#111",q.channel_line_colors[Z]),m.restore()}},q.pixel_shader=`precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform sampler2D u_curve;
		uniform float u_range;
		
		void main() {
			vec4 color = texture2D( u_texture, v_coord ) * u_range;
			color.x = texture2D( u_curve, vec2( color.x, 0.5 ) ).x;
			color.y = texture2D( u_curve, vec2( color.y, 0.5 ) ).y;
			color.z = texture2D( u_curve, vec2( color.z, 0.5 ) ).z;
			//color.w = texture2D( u_curve, vec2( color.w, 0.5 ) ).w;
			gl_FragColor = color;
		}`,t.registerNodeType("texture/curve",q);function st(){this.addInput("in","Texture"),this.addInput("exp","number"),this.addOutput("out","Texture"),this.properties={exposition:1,precision:r.LOW},this._uniforms={u_texture:0,u_exposition:1}}st.title="Exposition",st.desc="Controls texture exposition",st.widgets_info={exposition:{widget:"slider",min:0,max:3},precision:{widget:"combo",values:r.MODE_VALUES}},st.prototype.onExecute=function(){var m=this.getInputData(0);if(m&&this.isOutputConnected(0)){var M=this._temp_texture;(!M||M.width!=m.width||M.height!=m.height||M.type!=m.type)&&(M=this._temp_texture=new GL.Texture(m.width,m.height,{type:m.type,format:gl.RGBA,filter:gl.LINEAR}));var Z=st._shader;Z||(Z=st._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,st.pixel_shader)),this.properties.exposition;var it=this.getInputData(1);it!=null&&(this.properties.exposition=it);var gt=this._uniforms;M.drawTo(function(){gl.disable(gl.DEPTH_TEST),m.bind(0),Z.uniforms(gt).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,M)}},st.pixel_shader=`precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform float u_exposition;
		
		void main() {
			vec4 color = texture2D( u_texture, v_coord );
			gl_FragColor = vec4( color.xyz * u_exposition, color.a );
		}`,t.registerNodeType("texture/exposition",st);function vt(){this.addInput("in","Texture"),this.addInput("avg","number,Texture"),this.addOutput("out","Texture"),this.properties={enabled:!0,scale:1,gamma:1,average_lum:1,lum_white:1,precision:r.LOW},this._uniforms={u_texture:0,u_lumwhite2:1,u_igamma:1,u_scale:1,u_average_lum:1}}vt.title="Tone Mapping",vt.desc="Applies Tone Mapping to convert from high to low",vt.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},vt.prototype.onGetInputs=function(){return[["enabled","boolean"]]},vt.prototype.onExecute=function(){var m=this.getInputData(0);if(m&&this.isOutputConnected(0)){if(this.properties.precision===r.PASS_THROUGH||this.getInputOrProperty("enabled")===!1){this.setOutputData(0,m);return}var M=this._temp_texture;(!M||M.width!=m.width||M.height!=m.height||M.type!=m.type)&&(M=this._temp_texture=new GL.Texture(m.width,m.height,{type:m.type,format:gl.RGBA,filter:gl.LINEAR}));var Z=this.getInputData(1);Z==null&&(Z=this.properties.average_lum);var it=this._uniforms,gt=null;Z.constructor===Number?(this.properties.average_lum=Z,it.u_average_lum=this.properties.average_lum,gt=vt._shader,gt||(gt=vt._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,vt.pixel_shader))):Z.constructor===GL.Texture&&(it.u_average_texture=Z.bind(1),gt=vt._shader_texture,gt||(gt=vt._shader_texture=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,vt.pixel_shader,{AVG_TEXTURE:""}))),it.u_lumwhite2=this.properties.lum_white*this.properties.lum_white,it.u_scale=this.properties.scale,it.u_igamma=1/this.properties.gamma,gl.disable(gl.DEPTH_TEST),M.drawTo(function(){m.bind(0),gt.uniforms(it).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,this._temp_texture)}},vt.pixel_shader=`precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform float u_scale;
		#ifdef AVG_TEXTURE
			uniform sampler2D u_average_texture;
		#else
			uniform float u_average_lum;
		#endif
		uniform float u_lumwhite2;
		uniform float u_igamma;
		vec3 RGB2xyY (vec3 rgb)
		{
			 const mat3 RGB2XYZ = mat3(0.4124, 0.3576, 0.1805,
									   0.2126, 0.7152, 0.0722,
									   0.0193, 0.1192, 0.9505);
			vec3 XYZ = RGB2XYZ * rgb;
			
			float f = (XYZ.x + XYZ.y + XYZ.z);
			return vec3(XYZ.x / f,
						XYZ.y / f,
						XYZ.y);
		}
		
		void main() {
			vec4 color = texture2D( u_texture, v_coord );
			vec3 rgb = color.xyz;
			float average_lum = 0.0;
			#ifdef AVG_TEXTURE
				vec3 pixel = texture2D(u_average_texture,vec2(0.5)).xyz;
				average_lum = (pixel.x + pixel.y + pixel.z) / 3.0;
			#else
				average_lum = u_average_lum;
			#endif
			//Ld - this part of the code is the same for both versions
			float lum = dot(rgb, vec3(0.2126, 0.7152, 0.0722));
			float L = (u_scale / average_lum) * lum;
			float Ld = (L * (1.0 + L / u_lumwhite2)) / (1.0 + L);
			//first
			//vec3 xyY = RGB2xyY(rgb);
			//xyY.z *= Ld;
			//rgb = xyYtoRGB(xyY);
			//second
			rgb = (rgb / lum) * Ld;
			rgb = max(rgb,vec3(0.001));
			rgb = pow( rgb, vec3( u_igamma ) );
			gl_FragColor = vec4( rgb, color.a );
		}`,t.registerNodeType("texture/tonemapping",vt);function kt(){this.addOutput("out","Texture"),this.properties={width:512,height:512,seed:0,persistence:.1,octaves:8,scale:1,offset:[0,0],amplitude:1,precision:r.DEFAULT},this._key=0,this._texture=null,this._uniforms={u_persistence:.1,u_seed:0,u_offset:vec2.create(),u_scale:1,u_viewport:vec2.create()}}kt.title="Perlin",kt.desc="Generates a perlin noise texture",kt.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES},width:{type:"number",precision:0,step:1},height:{type:"number",precision:0,step:1},octaves:{type:"number",precision:0,step:1,min:1,max:50}},kt.prototype.onGetInputs=function(){return[["seed","number"],["persistence","number"],["octaves","number"],["scale","number"],["amplitude","number"],["offset","vec2"]]},kt.prototype.onExecute=function(){if(this.isOutputConnected(0)){var m=this.properties.width|0,M=this.properties.height|0;m==0&&(m=gl.viewport_data[2]),M==0&&(M=gl.viewport_data[3]);var Z=r.getTextureType(this.properties.precision),it=this._texture;(!it||it.width!=m||it.height!=M||it.type!=Z)&&(it=this._texture=new GL.Texture(m,M,{type:Z,format:gl.RGB,filter:gl.LINEAR}));var gt=this.getInputOrProperty("persistence"),Tt=this.getInputOrProperty("octaves"),qt=this.getInputOrProperty("offset"),$t=this.getInputOrProperty("scale"),le=this.getInputOrProperty("amplitude"),ye=this.getInputOrProperty("seed"),ce=""+m+M+Z+gt+Tt+$t+ye+qt[0]+qt[1]+le;if(ce==this._key){this.setOutputData(0,it);return}this._key=ce;var Te=this._uniforms;Te.u_persistence=gt,Te.u_octaves=Tt,Te.u_offset.set(qt),Te.u_scale=$t,Te.u_amplitude=le,Te.u_seed=ye*128,Te.u_viewport[0]=m,Te.u_viewport[1]=M;var Be=kt._shader;Be||(Be=kt._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,kt.pixel_shader)),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),it.drawTo(function(){Be.uniforms(Te).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,it)}},kt.pixel_shader=`precision highp float;
		varying vec2 v_coord;
		uniform vec2 u_offset;
		uniform float u_scale;
		uniform float u_persistence;
		uniform int u_octaves;
		uniform float u_amplitude;
		uniform vec2 u_viewport;
		uniform float u_seed;
		#define M_PI 3.14159265358979323846
		
		float rand(vec2 c){	return fract(sin(dot(c.xy ,vec2( 12.9898 + u_seed,78.233 + u_seed))) * 43758.5453); }
		
		float noise(vec2 p, float freq ){
			float unit = u_viewport.x/freq;
			vec2 ij = floor(p/unit);
			vec2 xy = mod(p,unit)/unit;
			//xy = 3.*xy*xy-2.*xy*xy*xy;
			xy = .5*(1.-cos(M_PI*xy));
			float a = rand((ij+vec2(0.,0.)));
			float b = rand((ij+vec2(1.,0.)));
			float c = rand((ij+vec2(0.,1.)));
			float d = rand((ij+vec2(1.,1.)));
			float x1 = mix(a, b, xy.x);
			float x2 = mix(c, d, xy.x);
			return mix(x1, x2, xy.y);
		}
		
		float pNoise(vec2 p, int res){
			float persistance = u_persistence;
			float n = 0.;
			float normK = 0.;
			float f = 4.;
			float amp = 1.0;
			int iCount = 0;
			for (int i = 0; i<50; i++){
				n+=amp*noise(p, f);
				f*=2.;
				normK+=amp;
				amp*=persistance;
				if (iCount >= res)
					break;
				iCount++;
			}
			float nf = n/normK;
			return nf*nf*nf*nf;
		}
		void main() {
			vec2 uv = v_coord * u_scale * u_viewport + u_offset * u_scale;
			vec4 color = vec4( pNoise( uv, u_octaves ) * u_amplitude );
			gl_FragColor = color;
		}`,t.registerNodeType("texture/perlin",kt);function Yt(){this.addInput("v"),this.addOutput("out","Texture"),this.properties={code:Yt.default_code,width:512,height:512,clear:!0,precision:r.DEFAULT,use_html_canvas:!1},this._func=null,this._temp_texture=null,this.compileCode()}Yt.title="Canvas2D",Yt.desc="Executes Canvas2D code inside a texture or the viewport.",Yt.help="Set width and height to 0 to match viewport size.",Yt.default_code=`//vars: canvas,ctx,time
ctx.fillStyle='red';
ctx.fillRect(0,0,50,50);
`,Yt.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES},code:{type:"code"},width:{type:"number",precision:0,step:1},height:{type:"number",precision:0,step:1}},Yt.prototype.onPropertyChanged=function(m,M){m=="code"&&this.compileCode(M)},Yt.prototype.compileCode=function(m){if(this._func=null,!!t.allow_scripts)try{this._func=new Function("canvas","ctx","time","script","v",m),this.boxcolor="#00FF00"}catch(M){this.boxcolor="#FF0000",console.error("Error parsing script"),console.error(M)}},Yt.prototype.onExecute=function(){var m=this._func;!m||!this.isOutputConnected(0)||this.executeDraw(m)},Yt.prototype.executeDraw=function(m){var M=this.properties.width||gl.canvas.width,Z=this.properties.height||gl.canvas.height,it=this._temp_texture,gt=r.getTextureType(this.properties.precision);(!it||it.width!=M||it.height!=Z||it.type!=gt)&&(it=this._temp_texture=new GL.Texture(M,Z,{format:gl.RGBA,filter:gl.LINEAR,type:gt}));var Tt=this.getInputData(0),qt=this.properties,$t=this,le=this.graph.getTime(),ye=gl,ce=gl.canvas;if((this.properties.use_html_canvas||!e.enableWebGLCanvas)&&(this._canvas?(ce=this._canvas,ye=this._ctx):(ce=this._canvas=createCanvas(M.height),ye=this._ctx=ce.getContext("2d")),ce.width=M,ce.height=Z),ye==gl)it.drawTo(function(){gl.start2D(),qt.clear&&(gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT));try{m.draw?m.draw.call($t,ce,ye,le,m,Tt):m.call($t,ce,ye,le,m,Tt),$t.boxcolor="#00FF00"}catch(Te){$t.boxcolor="#FF0000",console.error("Error executing script"),console.error(Te)}gl.finish2D()});else{qt.clear&&ye.clearRect(0,0,ce.width,ce.height);try{m.draw?m.draw.call(this,ce,ye,le,m,Tt):m.call(this,ce,ye,le,m,Tt),this.boxcolor="#00FF00"}catch(Te){this.boxcolor="#FF0000",console.error("Error executing script"),console.error(Te)}it.uploadImage(ce)}this.setOutputData(0,it)},t.registerNodeType("texture/canvas2D",Yt);function te(){this.addInput("in","Texture"),this.addOutput("out","Texture"),this.properties={key_color:vec3.fromValues(0,1,0),threshold:.8,slope:.2,precision:r.DEFAULT}}te.title="Matte",te.desc="Extracts background",te.widgets_info={key_color:{widget:"color"},precision:{widget:"combo",values:r.MODE_VALUES}},te.prototype.onExecute=function(){if(this.isOutputConnected(0)){var m=this.getInputData(0);if(this.properties.precision===r.PASS_THROUGH){this.setOutputData(0,m);return}if(m){this._tex=r.getTargetTexture(m,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),this._uniforms||(this._uniforms={u_texture:0,u_key_color:this.properties.key_color,u_threshold:1,u_slope:1});var M=this._uniforms,Z=Mesh.getScreenQuad(),it=te._shader;it||(it=te._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,te.pixel_shader)),M.u_key_color=this.properties.key_color,M.u_threshold=this.properties.threshold,M.u_slope=this.properties.slope,this._tex.drawTo(function(){m.bind(0),it.uniforms(M).draw(Z)}),this.setOutputData(0,this._tex)}}},te.pixel_shader=`precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform vec3 u_key_color;
		uniform float u_threshold;
		uniform float u_slope;
		
		void main() {
			vec3 color = texture2D( u_texture, v_coord ).xyz;
			float diff = length( normalize(color) - normalize(u_key_color) );
			float edge = u_threshold * (1.0 - u_slope);
			float alpha = smoothstep( edge, u_threshold, diff);
			gl_FragColor = vec4( color, alpha );
		}`,t.registerNodeType("texture/matte",te);function re(){this.addInput("in","texture"),this.addInput("yaw","number"),this.addOutput("out","texture"),this.properties={yaw:0}}re.title="CubemapToTexture2D",re.desc="Transforms a CUBEMAP texture into a TEXTURE2D in Polar Representation",re.prototype.onExecute=function(){if(this.isOutputConnected(0)){var m=this.getInputData(0);if(!(!m||m.texture_type!=GL.TEXTURE_CUBE_MAP)){this._last_tex&&(this._last_tex.height!=m.height||this._last_tex.type!=m.type)&&(this._last_tex=null);var M=this.getInputOrProperty("yaw");this._last_tex=GL.Texture.cubemapToTexture2D(m,m.height,this._last_tex,!0,M),this.setOutputData(0,this._last_tex)}}},t.registerNodeType("texture/cubemapToTexture2D",re)}(commonjsGlobal),function(e){if(typeof GL>"u")return;var t=e.LiteGraph;e.LGraphCanvas;var n="#345",r=t.Shaders={};r.GLSL_types=["float","vec2","vec3","vec4","mat3","mat4","sampler2D","samplerCube"];var s=r.GLSL_types_const=["float","vec2","vec3","vec4"],o={radians:"T radians(T degrees)",degrees:"T degrees(T radians)",sin:"T sin(T angle)",cos:"T cos(T angle)",tan:"T tan(T angle)",asin:"T asin(T x)",acos:"T acos(T x)",atan:"T atan(T x)",atan2:"T atan(T x,T y)",pow:"T pow(T x,T y)",exp:"T exp(T x)",log:"T log(T x)",exp2:"T exp2(T x)",log2:"T log2(T x)",sqrt:"T sqrt(T x)",inversesqrt:"T inversesqrt(T x)",abs:"T abs(T x)",sign:"T sign(T x)",floor:"T floor(T x)",round:"T round(T x)",ceil:"T ceil(T x)",fract:"T fract(T x)",mod:"T mod(T x,T y)",min:"T min(T x,T y)",max:"T max(T x,T y)",clamp:"T clamp(T x,T minVal = 0.0,T maxVal = 1.0)",mix:"T mix(T x,T y,T a)",step:"T step(T edge, T edge2, T x)",smoothstep:"T smoothstep(T edge, T edge2, T x)",length:"float length(T x)",distance:"float distance(T p0, T p1)",normalize:"T normalize(T x)",dot:"float dot(T x,T y)",cross:"vec3 cross(vec3 x,vec3 y)",reflect:"vec3 reflect(vec3 V,vec3 N)",refract:"vec3 refract(vec3 V,vec3 N, float IOR)"},h={},u=[];f(),r.ALL_TYPES="float,vec2,vec3,vec4";function f(){u.length=0;for(var P in o){var H=o[P],q=H.indexOf(" "),st=H.substr(0,q),vt=H.indexOf("(",q),kt=H.substr(q,vt-q).trim(),Yt=H.substr(vt+1,H.length-vt-2).split(",");for(var te in Yt){var re=Yt[te].split(" ").filter(function(m){return m});Yt[te]={type:re[0].trim(),name:re[1].trim()},re[2]=="="&&(Yt[te].value=re[3].trim())}h[P]={return_type:st,func:kt,params:Yt},u.push(kt)}}function c(P,H){H.color=n,H.filter="shader",H.prototype.clearDestination=function(){this.shader_destination={}},H.prototype.propagateDestination=function(st){if(this.shader_destination[st]=!0,this.inputs)for(var vt=0;vt<this.inputs.length;++vt){var kt=this.getInputNode(vt);kt&&kt.propagateDestination(st)}},H.prototype.onPropertyChanged||(H.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++}),t.registerNodeType("shader::"+P,H)}function _(P,H){return"VAR_"+(H||"TEMP")+"_"+P.id}function O(P,H){if(!P.inputs)return null;var q=P.getInputLink(H);if(!q)return null;var st=P.graph.getNodeById(q.origin_id);return st?st.getOutputVarName?st.getOutputVarName(q.origin_slot):"link_"+st.id+"_"+q.origin_slot:null}function d(P,H){return P.isOutputConnected(H)?"link_"+P.id+"_"+H:null}r.registerShaderNode=c,r.getInputLinkID=O,r.getOutputLinkID=d,r.getShaderNodeVarName=_,r.parseGLSLDescriptions=f;var b=t.valueToGLSL=function(H,q,st){var vt=5;if(st!=null&&(vt=st),!q)if(H.constructor===Number)q="float";else if(H.length)switch(H.length){case 2:q="vec2";break;case 3:q="vec3";break;case 4:q="vec4";break;case 9:q="mat3";break;case 16:q="mat4";break;default:throw"unknown type for glsl value size"}else throw"unknown type for glsl value: "+H.constructor;switch(q){case"float":return H.toFixed(vt);case"vec2":return"vec2("+H[0].toFixed(vt)+","+H[1].toFixed(vt)+")";case"color3":case"vec3":return"vec3("+H[0].toFixed(vt)+","+H[1].toFixed(vt)+","+H[2].toFixed(vt)+")";case"color4":case"vec4":return"vec4("+H[0].toFixed(vt)+","+H[1].toFixed(vt)+","+H[2].toFixed(vt)+","+H[3].toFixed(vt)+")";case"mat3":return"mat3(1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0)";case"mat4":return"mat4(1.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,1.0)";default:throw q}return""},S=t.varToTypeGLSL=function(H,q,st){if(q==st)return H;if(H==null)switch(st){case"float":return"0.0";case"vec2":return"vec2(0.0)";case"vec3":return"vec3(0.0)";case"vec4":return"vec4(0.0,0.0,0.0,1.0)";default:return null}if(!st)throw"error: no output type specified";if(st=="float")switch(q){case"vec2":case"vec3":case"vec4":return H+".x";default:return"0.0"}else if(st=="vec2")switch(q){case"float":return"vec2("+H+")";case"vec3":case"vec4":return H+".xy";default:return"vec2(0.0)"}else if(st=="vec3")switch(q){case"float":return"vec3("+H+")";case"vec2":return"vec3("+H+",0.0)";case"vec4":return H+".xyz";default:return"vec3(0.0)"}else if(st=="vec4")switch(q){case"float":return"vec4("+H+")";case"vec2":return"vec4("+H+",0.0,1.0)";case"vec3":return"vec4("+H+",1.0)";default:return"vec4(0.0,0.0,0.0,1.0)"}throw"type cannot be converted"},G=t.convertVarToGLSLType=function(H,q,st){if(q==st)return H;if(q=="float")return st+"("+H+")";if(st=="vec2")return"vec2("+H+".xy)";if(st=="vec3"){if(q=="vec2")return"vec3("+H+",0.0)";if(q=="vec4")return"vec4("+H+".xyz)"}if(st=="vec4"){if(q=="vec2")return"vec4("+H+",0.0,0.0)";if(st=="vec3")return"vec4("+H+",1.0)"}return null};function z(){this.vs_template="",this.fs_template="",this.buffer_names={uvs:"v_coord"},this.extra={},this._functions={},this._uniforms={},this._codeparts={},this._uniform_value=null}z.prototype.clear=function(){this._uniforms={},this._functions={},this._codeparts={},this._uniform_value=null,this.extra={}},z.prototype.addUniform=function(P,H,q){this._uniforms[P]=H,q!=null&&(this._uniform_value||(this._uniform_value={}),this._uniform_value[P]=q)},z.prototype.addFunction=function(P,H){this._functions[P]=H},z.prototype.addCode=function(P,H,q){q=q||{"":""};for(var st in q){var vt=st?st+"_"+P:P;this._codeparts[vt]?this._codeparts[vt]+=H+`
`:this._codeparts[vt]=H+`
`}},z.prototype.computeCodeBlocks=function(P,H){this.clear();var q=P.findNodesByType("shader::output/vertex");q=q&&q.length?q[0]:null;var st=P.findNodesByType("shader::output/fragcolor");if(st=st&&st.length?st[0]:null,!st)return null;P.sendEventToAllNodes("clearDestination"),q&&q.propagateDestination("vs"),st&&st.propagateDestination("fs"),P.sendEventToAllNodes("onGetCode",this);var vt="";for(var kt in this._uniforms)vt+="uniform "+this._uniforms[kt]+" "+kt+`;
`;if(H)for(var kt in H)vt+="uniform "+H[kt]+" "+kt+`;
`;var Yt="";for(var kt in this._functions)Yt+="//"+kt+`
`+this._functions[kt]+`
`;var te=this._codeparts;return te.uniforms=vt,te.functions=Yt,te},z.prototype.computeShaderCode=function(P){var H=this.computeCodeBlocks(P),q=GL.Shader.replaceCodeUsingContext(this.vs_template,H),st=GL.Shader.replaceCodeUsingContext(this.fs_template,H);return{vs_code:q,fs_code:st}},z.prototype.computeShader=function(P,H){var q=this.computeShaderCode(P);if(console.log(q.vs_code,q.fs_code),!t.catch_exceptions)return this._shader_error=!0,H?H.updateShader(q.vs_code,q.fs_code):H=new GL.Shader(q.vs_code,q.fs_code),this._shader_error=!1,H;try{return H?H.updateShader(q.vs_code,q.fs_code):H=new GL.Shader(q.vs_code,q.fs_code),this._shader_error=!1,H}catch(st){return this._shader_error||(console.error(st),st.indexOf("Fragment shader")!=-1?console.log(q.fs_code.split(`
`).map(function(vt,kt){return kt+".- "+vt}).join(`
`)):console.log(q.vs_code)),this._shader_error=!0,null}return null},z.prototype.getShader=function(P){if(this._shader&&this._shader._version==P._version)return this._shader;var H=this.computeShader(P,this._shader);return H?(this._shader=H,H._version=P._version,H):null},z.prototype.fillUniforms=function(P,H){if(this._uniform_value)for(var q in this._uniform_value){var st=this._uniform_value[q];st!=null&&(st.constructor===Function?P[q]=st.call(this,H):st.constructor===GL.Texture||(P[q]=st))}},t.ShaderContext=t.Shaders.Context=z;function $(){this.subgraph=new t.LGraph,this.subgraph._subgraph_node=this,this.subgraph._is_subgraph=!0,this.subgraph.filter="shader",this.addInput("in","texture"),this.addOutput("out","texture"),this.properties={width:0,height:0,alpha:!1,precision:typeof LGraphTexture<"u"?LGraphTexture.DEFAULT:2};var P=this.subgraph.findNodesByType("shader::input/uniform")[0];P.pos=[200,300];var H=t.createNode("shader::texture/sampler2D");H.pos=[400,300],this.subgraph.add(H);var q=t.createNode("shader::output/fragcolor");q.pos=[600,300],this.subgraph.add(q),P.connect(0,H),H.connect(0,q),this.size=[180,60],this.redraw_on_mouse=!0,this._uniforms={},this._shader=null,this._context=new z,this._context.vs_template=`#define VERTEX
`+GL.Shader.SCREEN_VERTEX_SHADER,this._context.fs_template=$.template}$.template=`
#define FRAGMENT
precision highp float;
varying vec2 v_coord;
{{varying}}
{{uniforms}}
{{functions}}
{{fs_functions}}
void main() {

vec2 uv = v_coord;
vec4 fragcolor = vec4(0.0);
vec4 fragcolor1 = vec4(0.0);
{{fs_code}}
gl_FragColor = fragcolor;
}
	`,$.widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},$.title="ShaderGraph",$.desc="Builds a shader using a graph",$.input_node_type="input/uniform",$.output_node_type="output/fragcolor",$.title_color=n,$.prototype.onSerialize=function(P){P.subgraph=this.subgraph.serialize()},$.prototype.onConfigure=function(P){this.subgraph.configure(P.subgraph)},$.prototype.onExecute=function(){if(this.isOutputConnected(0)){var P=this.getInputData(0);P&&P.constructor!=GL.Texture&&(P=null);var H=this.properties.width|0,q=this.properties.height|0;H==0&&(H=P?P.width:gl.viewport_data[2]),q==0&&(q=P?P.height:gl.viewport_data[3]);var st=LGraphTexture.getTextureType(this.properties.precision,P),vt=this._texture;(!vt||vt.width!=H||vt.height!=q||vt.type!=st)&&(vt=this._texture=new GL.Texture(H,q,{type:st,format:this.alpha?gl.RGBA:gl.RGB,filter:gl.LINEAR}));var kt=this.getShader(this.subgraph);if(kt){var Yt=this._uniforms;this._context.fillUniforms(Yt);var te=0;if(this.inputs)for(var re=0;re<this.inputs.length;++re){var m=this.inputs[re],M=this.getInputData(re);m.type=="texture"&&(M||(M=GL.Texture.getWhiteTexture()),M=M.bind(te++)),M!=null&&(Yt["u_"+m.name]=M)}var Z=GL.Mesh.getScreenQuad();gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),vt.drawTo(function(){kt.uniforms(Yt),kt.draw(Z)}),this.setOutputData(0,vt)}}},$.prototype.onInputAdded=function(P){var H=t.createNode("shader::input/uniform");H.setProperty("name",P.name),H.setProperty("type",P.type),this.subgraph.add(H)},$.prototype.onInputRemoved=function(P,H){for(var q=this.subgraph.findNodesByType("shader::input/uniform"),st=0;st<q.length;++st){var vt=q[st];vt.properties.name==H.name&&this.subgraph.remove(vt)}},$.prototype.computeSize=function(){var P=this.inputs?this.inputs.length:0,H=this.outputs?this.outputs.length:0;return[200,Math.max(P,H)*t.NODE_SLOT_HEIGHT+t.NODE_TITLE_HEIGHT+10]},$.prototype.getShader=function(){var P=this._context.getShader(this.subgraph);return P?this.boxcolor=null:this.boxcolor="red",P},$.prototype.onDrawBackground=function(P,H,q,st){if(!this.flags.collapsed){var vt=this.getOutputData(0),kt=this.inputs?this.inputs.length*t.NODE_SLOT_HEIGHT:0;vt&&P==vt.gl&&this.size[1]>kt+t.NODE_TITLE_HEIGHT&&P.drawImage(vt,10,Yt,this.size[0]-20,this.size[1]-kt-t.NODE_TITLE_HEIGHT);var Yt=this.size[1]-t.NODE_TITLE_HEIGHT+.5,te=t.isInsideRectangle(st[0],st[1],this.pos[0],this.pos[1]+Yt,this.size[0],t.NODE_TITLE_HEIGHT);P.fillStyle=te?"#555":"#222",P.beginPath(),this._shape==t.BOX_SHAPE?P.rect(0,Yt,this.size[0]+1,t.NODE_TITLE_HEIGHT):P.roundRect(0,Yt,this.size[0]+1,t.NODE_TITLE_HEIGHT,0,8),P.fill(),P.textAlign="center",P.font="24px Arial",P.fillStyle=te?"#DDD":"#999",P.fillText("+",this.size[0]*.5,Yt+24)}},$.prototype.onMouseDown=function(P,H,q){var st=this.size[1]-t.NODE_TITLE_HEIGHT+.5;H[1]>st&&q.showSubgraphPropertiesDialog(this)},$.prototype.onDrawSubgraphBackground=function(P){},$.prototype.getExtraMenuOptions=function(P){var H=this,q=[{content:"Print Code",callback:function(){var st=H._context.computeShaderCode();console.log(st.vs_code,st.fs_code)}}];return q},t.registerNodeType("texture/shaderGraph",$);function A(){this.addOutput("out",""),this.properties={name:"",type:""}}A.title="Uniform",A.desc="Input data for the shader",A.prototype.getTitle=function(){return this.properties.name&&this.flags.collapsed?this.properties.type+" "+this.properties.name:"Uniform"},A.prototype.onPropertyChanged=function(P,H){this.outputs[0].name=this.properties.type+" "+this.properties.name},A.prototype.onGetCode=function(P){if(this.shader_destination){var H=this.properties.type;if(!H){if(!P.onGetPropertyInfo)return;var q=P.onGetPropertyInfo(this.property.name);if(!q)return;H=q.type}H=="number"?H="float":H=="texture"&&(H="sampler2D"),r.GLSL_types.indexOf(H)!=-1&&(P.addUniform("u_"+this.properties.name,H),this.setOutputData(0,H))}},A.prototype.getOutputVarName=function(P){return"u_"+this.properties.name},c("input/uniform",A);function l(){this.addOutput("out","vec2"),this.properties={name:"coord",type:"vec2"}}l.title="Attribute",l.desc="Input data from mesh attribute",l.prototype.getTitle=function(){return"att. "+this.properties.name},l.prototype.onGetCode=function(P){if(this.shader_destination){var H=this.properties.type;!H||r.GLSL_types.indexOf(H)==-1||(H=="number"&&(H="float"),this.properties.name!="coord"&&P.addCode("varying"," varying "+H+" v_"+this.properties.name+";"),this.setOutputData(0,H))}},l.prototype.getOutputVarName=function(P){return"v_"+this.properties.name},c("input/attribute",l);function I(){this.addInput("tex","sampler2D"),this.addInput("uv","vec2"),this.addOutput("rgba","vec4"),this.addOutput("rgb","vec3")}I.title="Sampler2D",I.desc="Reads a pixel from a texture",I.prototype.onGetCode=function(P){if(this.shader_destination){var H=O(this,0),q=_(this),st="vec4 "+q+` = vec4(0.0);
`;if(H){var vt=O(this,1)||P.buffer_names.uvs;st+=q+" = texture2D("+H+","+vt+`);
`}var kt=d(this,0);kt&&(st+="vec4 "+d(this,0)+" = "+q+`;
`);var Yt=d(this,1);Yt&&(st+="vec3 "+d(this,1)+" = "+q+`.xyz;
`),P.addCode("code",st,this.shader_destination),this.setOutputData(0,"vec4"),this.setOutputData(1,"vec3")}},c("texture/sampler2D",I);function T(){this.addOutput("","float"),this.properties={type:"float",value:0},this.addWidget("combo","type","float",null,{values:s,property:"type"}),this.updateWidgets()}T.title="const",T.prototype.getTitle=function(){return this.flags.collapsed?b(this.properties.value,this.properties.type,2):"Const"},T.prototype.onPropertyChanged=function(P,H){P=="type"&&(this.outputs[0].type!=H&&(this.disconnectOutput(0),this.outputs[0].type=H),this.widgets.length=1,this.updateWidgets()),P=="value"&&(H.length?(this.widgets[1].value=H[1],H.length>2&&(this.widgets[2].value=H[2]),H.length>3&&(this.widgets[3].value=H[3])):this.widgets[1].value=H)},T.prototype.updateWidgets=function(q){var H=this,q=this.properties.value,st={step:.01};switch(this.properties.type){case"float":this.properties.value=0,this.addWidget("number","v",0,{step:.01,property:"value"});break;case"vec2":this.properties.value=q&&q.length==2?[q[0],q[1]]:[0,0,0],this.addWidget("number","x",this.properties.value[0],function(vt){H.properties.value[0]=vt},st),this.addWidget("number","y",this.properties.value[1],function(vt){H.properties.value[1]=vt},st);break;case"vec3":this.properties.value=q&&q.length==3?[q[0],q[1],q[2]]:[0,0,0],this.addWidget("number","x",this.properties.value[0],function(vt){H.properties.value[0]=vt},st),this.addWidget("number","y",this.properties.value[1],function(vt){H.properties.value[1]=vt},st),this.addWidget("number","z",this.properties.value[2],function(vt){H.properties.value[2]=vt},st);break;case"vec4":this.properties.value=q&&q.length==4?[q[0],q[1],q[2],q[3]]:[0,0,0,0],this.addWidget("number","x",this.properties.value[0],function(vt){H.properties.value[0]=vt},st),this.addWidget("number","y",this.properties.value[1],function(vt){H.properties.value[1]=vt},st),this.addWidget("number","z",this.properties.value[2],function(vt){H.properties.value[2]=vt},st),this.addWidget("number","w",this.properties.value[3],function(vt){H.properties.value[3]=vt},st);break;default:console.error("unknown type for constant")}},T.prototype.onGetCode=function(P){if(this.shader_destination){var H=b(this.properties.value,this.properties.type),q=d(this,0);if(q){var st="	"+this.properties.type+" "+q+" = "+H+";";P.addCode("code",st,this.shader_destination),this.setOutputData(0,this.properties.type)}}},c("const/const",T);function L(){this.addInput("xy","vec2"),this.addInput("x","float"),this.addInput("y","float"),this.addOutput("xy","vec2"),this.addOutput("x","float"),this.addOutput("y","float"),this.properties={x:0,y:0}}L.title="vec2",L.varmodes=["xy","x","y"],L.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++},L.prototype.onGetCode=function(P){if(this.shader_destination){for(var H=this.properties,q=_(this),st="	vec2 "+q+" = "+b([H.x,H.y])+`;
`,vt=0;vt<L.varmodes.length;++vt){var kt=L.varmodes[vt],Yt=O(this,vt);Yt&&(st+="	"+q+"."+kt+" = "+Yt+`;
`)}for(var vt=0;vt<L.varmodes.length;++vt){var kt=L.varmodes[vt],te=d(this,vt);if(te){var re=s[kt.length-1];st+="	"+re+" "+te+" = "+q+"."+kt+`;
`,this.setOutputData(vt,re)}}P.addCode("code",st,this.shader_destination)}},c("const/vec2",L);function C(){this.addInput("xyz","vec3"),this.addInput("x","float"),this.addInput("y","float"),this.addInput("z","float"),this.addInput("xy","vec2"),this.addInput("xz","vec2"),this.addInput("yz","vec2"),this.addOutput("xyz","vec3"),this.addOutput("x","float"),this.addOutput("y","float"),this.addOutput("z","float"),this.addOutput("xy","vec2"),this.addOutput("xz","vec2"),this.addOutput("yz","vec2"),this.properties={x:0,y:0,z:0}}C.title="vec3",C.varmodes=["xyz","x","y","z","xy","xz","yz"],C.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++},C.prototype.onGetCode=function(P){if(this.shader_destination){for(var H=this.properties,q=_(this),st="vec3 "+q+" = "+b([H.x,H.y,H.z])+`;
`,vt=0;vt<C.varmodes.length;++vt){var kt=C.varmodes[vt],Yt=O(this,vt);Yt&&(st+="	"+q+"."+kt+" = "+Yt+`;
`)}for(var vt=0;vt<C.varmodes.length;++vt){var kt=C.varmodes[vt],te=d(this,vt);if(te){var re=s[kt.length-1];st+="	"+re+" "+te+" = "+q+"."+kt+`;
`,this.setOutputData(vt,re)}}P.addCode("code",st,this.shader_destination)}},c("const/vec3",C);function N(){this.addInput("xyzw","vec4"),this.addInput("xyz","vec3"),this.addInput("x","float"),this.addInput("y","float"),this.addInput("z","float"),this.addInput("w","float"),this.addInput("xy","vec2"),this.addInput("yz","vec2"),this.addInput("zw","vec2"),this.addOutput("xyzw","vec4"),this.addOutput("xyz","vec3"),this.addOutput("x","float"),this.addOutput("y","float"),this.addOutput("z","float"),this.addOutput("xy","vec2"),this.addOutput("yz","vec2"),this.addOutput("zw","vec2"),this.properties={x:0,y:0,z:0,w:0}}N.title="vec4",N.varmodes=["xyzw","xyz","x","y","z","w","xy","yz","zw"],N.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++},N.prototype.onGetCode=function(P){if(this.shader_destination){for(var H=this.properties,q=_(this),st="vec4 "+q+" = "+b([H.x,H.y,H.z,H.w])+`;
`,vt=0;vt<N.varmodes.length;++vt){var kt=N.varmodes[vt],Yt=O(this,vt);Yt&&(st+="	"+q+"."+kt+" = "+Yt+`;
`)}for(var vt=0;vt<N.varmodes.length;++vt){var kt=N.varmodes[vt],te=d(this,vt);if(te){var re=s[kt.length-1];st+="	"+re+" "+te+" = "+q+"."+kt+`;
`,this.setOutputData(vt,re)}}P.addCode("code",st,this.shader_destination)}},c("const/vec4",N);function R(){this.addInput("color",r.ALL_TYPES),this.block_delete=!0}R.title="FragColor",R.desc="Pixel final color",R.prototype.onGetCode=function(P){var H=O(this,0);if(H){var q=this.getInputData(0),st=S(H,q,"vec4");P.addCode("fs_code","fragcolor = "+st+";")}},c("output/fragcolor",R);function Y(){this.addInput("A",r.ALL_TYPES),this.addInput("B",r.ALL_TYPES),this.addOutput("out",""),this.properties={operation:"*"},this.addWidget("combo","op.",this.properties.operation,{property:"operation",values:Y.operations})}Y.title="Operation",Y.operations=["+","-","*","/"],Y.prototype.getTitle=function(){return this.flags.collapsed?"A"+this.properties.operation+"B":"Operation"},Y.prototype.onGetCode=function(P){if(this.shader_destination&&this.isOutputConnected(0)){for(var H=[],q=0;q<3;++q)H.push({name:O(this,q),type:this.getInputData(q)||"float"});var st=d(this,0);if(st){for(var vt=H[0].type,kt=vt,Yt=this.properties.operation,te=[],q=0;q<2;++q){var re=H[q].name;re==null&&(re=p.value!=null?p.value:"(1.0)",H[q].type="float"),H[q].type!=vt&&(H[q].type=="float"&&(Yt=="*"||Yt=="/")||(re=G(re,H[q].type,vt))),te.push(re)}P.addCode("code",kt+" "+st+" = "+te[0]+Yt+te[1]+";",this.shader_destination),this.setOutputData(0,kt)}}},c("math/operation",Y);function ut(){this.addInput("A",r.ALL_TYPES),this.addInput("B",r.ALL_TYPES),this.addOutput("out",""),this.properties={func:"floor"},this._current="floor",this.addWidget("combo","func",this.properties.func,{property:"func",values:u})}ut.title="Func",ut.prototype.onPropertyChanged=function(P,H){if(this.graph&&this.graph._version++,P=="func"){var q=h[H];if(!q)return;for(var st=q.params.length;st<this.inputs.length;++st)this.removeInput(st);for(var st=0;st<q.params.length;++st){var vt=q.params[st];this.inputs[st]?this.inputs[st].name=vt.name+(vt.value?" ("+vt.value+")":""):this.addInput(vt.name,r.ALL_TYPES)}}},ut.prototype.getTitle=function(){return this.flags.collapsed?this.properties.func:"Func"},ut.prototype.onGetCode=function(P){if(this.shader_destination&&this.isOutputConnected(0)){for(var H=[],q=0;q<3;++q)H.push({name:O(this,q),type:this.getInputData(q)||"float"});var st=d(this,0);if(st){var vt=h[this.properties.func];if(vt){var kt=H[0].type,Yt=vt.return_type;Yt=="T"&&(Yt=kt);for(var te=[],q=0;q<vt.params.length;++q){var re=vt.params[q],m=H[q].name;m==null&&(m=re.value!=null?re.value:"(1.0)",H[q].type="float"),(re.type=="T"&&H[q].type!=kt||re.type!="T"&&H[q].type!=kt)&&(m=G(m,H[q].type,kt)),te.push(m)}P.addFunction("round",`float round(float v){ return floor(v+0.5); }
vec2 round(vec2 v){ return floor(v+vec2(0.5));}
vec3 round(vec3 v){ return floor(v+vec3(0.5));}
vec4 round(vec4 v){ return floor(v+vec4(0.5)); }
`),P.addCode("code",Yt+" "+st+" = "+vt.func+"("+te.join(",")+");",this.shader_destination),this.setOutputData(0,Yt)}}}},c("math/func",ut);function mt(){this.addInput("A",r.ALL_TYPES),this.addInput("B",r.ALL_TYPES),this.addOutput("C","vec4"),this.properties={code:"C = A+B",type:"vec4"},this.addWidget("text","code",this.properties.code,{property:"code"}),this.addWidget("combo","type",this.properties.type,{values:["float","vec2","vec3","vec4"],property:"type"})}mt.title="Snippet",mt.prototype.onPropertyChanged=function(P,H){this.graph&&this.graph._version++,P=="type"&&this.outputs[0].type!=H&&(this.disconnectOutput(0),this.outputs[0].type=H)},mt.prototype.getTitle=function(){return this.flags.collapsed?this.properties.code:"Snippet"},mt.prototype.onGetCode=function(P){if(!(!this.shader_destination||!this.isOutputConnected(0))){var H=O(this,0);H||(H="1.0");var q=O(this,1);q||(q="1.0");var st=d(this,0);if(st){var vt=this.getInputData(0)||"float",kt=this.getInputData(1)||"float",Yt=this.properties.type;if(vt=="T"||kt=="T")return null;var te="funcSnippet"+this.id,re=`
`+Yt+" "+te+"( "+vt+" A, "+kt+` B) {
`;re+="	"+Yt+" C = "+Yt+`(0.0);
`,re+="	"+this.properties.code+`;
`,re+=`	return C;
}
`,P.addCode("functions",re,this.shader_destination),P.addCode("code",Yt+" "+st+" = "+te+"("+H+","+q+");",this.shader_destination),this.setOutputData(0,Yt)}}},c("utils/snippet",mt);function yt(){this.addOutput("out","float")}yt.title="Rand",yt.prototype.onGetCode=function(P){if(!(!this.shader_destination||!this.isOutputConnected(0))){var H=d(this,0);P.addUniform("u_rand"+this.id,"float",function(){return Math.random()}),P.addCode("code","float "+H+" = u_rand"+this.id+";",this.shader_destination),this.setOutputData(0,"float")}},c("input/rand",yt);function D(){this.addInput("out",r.ALL_TYPES),this.addInput("scale","float"),this.addOutput("out","float"),this.properties={type:"noise",scale:1},this.addWidget("combo","type",this.properties.type,{property:"type",values:D.NOISE_TYPES}),this.addWidget("number","scale",this.properties.scale,{property:"scale"})}D.NOISE_TYPES=["noise","rand"],D.title="noise",D.prototype.onGetCode=function(P){if(!(!this.shader_destination||!this.isOutputConnected(0))){var H=O(this,0),q=d(this,0),st=this.getInputData(0);H||(st="vec2",H=P.buffer_names.uvs),P.addFunction("noise",D.shader_functions),P.addUniform("u_noise_scale"+this.id,"float",this.properties.scale),st=="float"?P.addCode("code","float "+q+" = snoise( vec2("+H+") * u_noise_scale"+this.id+");",this.shader_destination):st=="vec2"||st=="vec3"?P.addCode("code","float "+q+" = snoise("+H+" * u_noise_scale"+this.id+");",this.shader_destination):st=="vec4"&&P.addCode("code","float "+q+" = snoise("+H+".xyz * u_noise_scale"+this.id+");",this.shader_destination),this.setOutputData(0,"float")}},c("math/noise",D),D.shader_functions=`
vec3 permute(vec3 x) { return mod(((x*34.0)+1.0)*x, 289.0); }

float snoise(vec2 v){
  const vec4 C = vec4(0.211324865405187, 0.366025403784439,-0.577350269189626, 0.024390243902439);
  vec2 i  = floor(v + dot(v, C.yy) );
  vec2 x0 = v -   i + dot(i, C.xx);
  vec2 i1;
  i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
  vec4 x12 = x0.xyxy + C.xxzz;
  x12.xy -= i1;
  i = mod(i, 289.0);
  vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))
  + i.x + vec3(0.0, i1.x, 1.0 ));
  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy),dot(x12.zw,x12.zw)), 0.0);
  m = m*m ;
  m = m*m ;
  vec3 x = 2.0 * fract(p * C.www) - 1.0;
  vec3 h = abs(x) - 0.5;
  vec3 ox = floor(x + 0.5);
  vec3 a0 = x - ox;
  m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );
  vec3 g;
  g.x  = a0.x  * x0.x  + h.x  * x0.y;
  g.yz = a0.yz * x12.xz + h.yz * x12.yw;
  return 130.0 * dot(m, g);
}
vec4 permute(vec4 x){return mod(((x*34.0)+1.0)*x, 289.0);}
vec4 taylorInvSqrt(vec4 r){return 1.79284291400159 - 0.85373472095314 * r;}

float snoise(vec3 v){ 
  const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;
  const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);

// First corner
  vec3 i  = floor(v + dot(v, C.yyy) );
  vec3 x0 =   v - i + dot(i, C.xxx) ;

// Other corners
  vec3 g = step(x0.yzx, x0.xyz);
  vec3 l = 1.0 - g;
  vec3 i1 = min( g.xyz, l.zxy );
  vec3 i2 = max( g.xyz, l.zxy );

  //  x0 = x0 - 0. + 0.0 * C 
  vec3 x1 = x0 - i1 + 1.0 * C.xxx;
  vec3 x2 = x0 - i2 + 2.0 * C.xxx;
  vec3 x3 = x0 - 1. + 3.0 * C.xxx;

// Permutations
  i = mod(i, 289.0 ); 
  vec4 p = permute( permute( permute( 
             i.z + vec4(0.0, i1.z, i2.z, 1.0 ))
           + i.y + vec4(0.0, i1.y, i2.y, 1.0 )) 
           + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));

// Gradients
// ( N*N points uniformly over a square, mapped onto an octahedron.)
  float n_ = 1.0/7.0; // N=7
  vec3  ns = n_ * D.wyz - D.xzx;

  vec4 j = p - 49.0 * floor(p * ns.z *ns.z);  //  mod(p,N*N)

  vec4 x_ = floor(j * ns.z);
  vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)

  vec4 x = x_ *ns.x + ns.yyyy;
  vec4 y = y_ *ns.x + ns.yyyy;
  vec4 h = 1.0 - abs(x) - abs(y);

  vec4 b0 = vec4( x.xy, y.xy );
  vec4 b1 = vec4( x.zw, y.zw );

  vec4 s0 = floor(b0)*2.0 + 1.0;
  vec4 s1 = floor(b1)*2.0 + 1.0;
  vec4 sh = -step(h, vec4(0.0));

  vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;
  vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;

  vec3 p0 = vec3(a0.xy,h.x);
  vec3 p1 = vec3(a0.zw,h.y);
  vec3 p2 = vec3(a1.xy,h.z);
  vec3 p3 = vec3(a1.zw,h.w);

//Normalise gradients
  vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));
  p0 *= norm.x;
  p1 *= norm.y;
  p2 *= norm.z;
  p3 *= norm.w;

// Mix final noise value
  vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);
  m = m * m;
  return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1),dot(p2,x2), dot(p3,x3) ) );
}

vec3 hash3( vec2 p ){
    vec3 q = vec3( dot(p,vec2(127.1,311.7)), 
				   dot(p,vec2(269.5,183.3)), 
				   dot(p,vec2(419.2,371.9)) );
	return fract(sin(q)*43758.5453);
}
vec4 hash4( vec3 p ){
    vec4 q = vec4( dot(p,vec3(127.1,311.7,257.3)), 
				   dot(p,vec3(269.5,183.3,335.1)), 
				   dot(p,vec3(314.5,235.1,467.3)), 
				   dot(p,vec3(419.2,371.9,114.9)) );
	return fract(sin(q)*43758.5453);
}

float iqnoise( in vec2 x, float u, float v ){
    vec2 p = floor(x);
    vec2 f = fract(x);
	
	float k = 1.0+63.0*pow(1.0-v,4.0);
	
	float va = 0.0;
	float wt = 0.0;
    for( int j=-2; j<=2; j++ )
    for( int i=-2; i<=2; i++ )
    {
        vec2 g = vec2( float(i),float(j) );
		vec3 o = hash3( p + g )*vec3(u,u,1.0);
		vec2 r = g - f + o.xy;
		float d = dot(r,r);
		float ww = pow( 1.0-smoothstep(0.0,1.414,sqrt(d)), k );
		va += o.z*ww;
		wt += ww;
    }
	
    return va/wt;
}
`;function F(){this.addOutput("out","float")}F.title="Time",F.prototype.onGetCode=function(P){if(!(!this.shader_destination||!this.isOutputConnected(0))){var H=d(this,0);P.addUniform("u_time"+this.id,"float",function(){return getTime()*.001}),P.addCode("code","float "+H+" = u_time"+this.id+";",this.shader_destination),this.setOutputData(0,"float")}},c("input/time",F);function E(){this.addInput("in","T"),this.addOutput("out","float")}E.title="Dither",E.prototype.onGetCode=function(P){if(!(!this.shader_destination||!this.isOutputConnected(0))){var H=O(this,0),q="float",st=d(this,0),vt=this.getInputData(0);H=S(H,vt,"float"),P.addFunction("dither8x8",E.dither_func),P.addCode("code",q+" "+st+" = dither8x8("+H+");",this.shader_destination),this.setOutputData(0,q)}},E.dither_values=[.515625,.140625,.640625,.046875,.546875,.171875,.671875,.765625,.265625,.890625,.390625,.796875,.296875,.921875,.421875,.203125,.703125,.078125,.578125,.234375,.734375,.109375,.609375,.953125,.453125,.828125,.328125,.984375,.484375,.859375,.359375,.0625,.5625,.1875,.6875,.03125,.53125,.15625,.65625,.8125,.3125,.9375,.4375,.78125,.28125,.90625,.40625,.25,.75,.125,.625,.21875,.71875,.09375,.59375,1.0001,.5,.875,.375,.96875,.46875,.84375,.34375],E.dither_func=`
		float dither8x8(float brightness) {
		  vec2 position = vec2(0.0);
		  #ifdef FRAGMENT
			position = gl_FragCoord.xy;
		  #endif
		  int x = int(mod(position.x, 8.0));
		  int y = int(mod(position.y, 8.0));
		  int index = x + y * 8;
		  float limit = 0.0;
		  if (x < 8) {
			if(index==0) limit = 0.015625;
			`+E.dither_values.map(function(P,H){return"else if(index== "+(H+1)+") limit = "+P+";"}).join(`
`)+`
		  }
		  return brightness < limit ? 0.0 : 1.0;
		}
`,c("math/dither",E);function Q(){this.addInput("",r.ALL_TYPES),this.addOutput("",""),this.properties={min_value:0,max_value:1,min_value2:0,max_value2:1},this.addWidget("number","min",0,{step:.1,property:"min_value"}),this.addWidget("number","max",1,{step:.1,property:"max_value"}),this.addWidget("number","min2",0,{step:.1,property:"min_value2"}),this.addWidget("number","max2",1,{step:.1,property:"max_value2"})}Q.title="Remap",Q.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++},Q.prototype.onConnectionsChange=function(){var P=this.getInputDataType(0);this.outputs[0].type=P||"T"},Q.prototype.onGetCode=function(P){if(!(!this.shader_destination||!this.isOutputConnected(0))){var H=O(this,0),q=d(this,0);if(!(!H&&!q)){var st=this.getInputDataType(0);if(this.outputs[0].type=st,st=="T"){console.warn("node type is T and cannot be resolved");return}if(!H){P.addCode("code","	"+st+" "+q+" = "+st+`(0.0);
`);return}var vt=b(this.properties.min_value),kt=b(this.properties.max_value),Yt=b(this.properties.min_value2),te=b(this.properties.max_value2);P.addCode("code",st+" "+q+" = ( ("+H+" - "+vt+") / ("+kt+" - "+vt+") ) * ("+te+" - "+Yt+") + "+Yt+";",this.shader_destination),this.setOutputData(0,st)}}},c("math/remap",Q)}(commonjsGlobal),function(e){var t=e.LiteGraph,n=new Float32Array(16),r=new Float32Array(16),s=new Float32Array(16),o=new Float32Array(16),h={u_view:n,u_projection:r,u_viewprojection:s,u_model:o};t.LGraphRender={onRequestCameraMatrices:null};function u(){return Math.random()*1e5|0}function f(){this.addInput("obj",""),this.addInput("radius","number"),this.addOutput("out","geometry"),this.addOutput("points","[vec3]"),this.properties={radius:1,num_points:4096,generate_normals:!0,regular:!1,mode:f.SPHERE,force_update:!1},this.points=new Float32Array(this.properties.num_points*3),this.normals=new Float32Array(this.properties.num_points*3),this.must_update=!0,this.version=0;var T=this;this.addWidget("button","update",null,function(){T.must_update=!0}),this.geometry={vertices:null,_id:u()},this._old_obj=null,this._last_radius=null}e.LGraphPoints3D=f,f.RECTANGLE=1,f.CIRCLE=2,f.CUBE=10,f.SPHERE=11,f.HEMISPHERE=12,f.INSIDE_SPHERE=13,f.OBJECT=20,f.OBJECT_UNIFORMLY=21,f.OBJECT_INSIDE=22,f.MODE_VALUES={rectangle:f.RECTANGLE,circle:f.CIRCLE,cube:f.CUBE,sphere:f.SPHERE,hemisphere:f.HEMISPHERE,inside_sphere:f.INSIDE_SPHERE,object:f.OBJECT,object_uniformly:f.OBJECT_UNIFORMLY,object_inside:f.OBJECT_INSIDE},f.widgets_info={mode:{widget:"combo",values:f.MODE_VALUES}},f.title="list of points",f.desc="returns an array of points",f.prototype.onPropertyChanged=function(T,L){this.must_update=!0},f.prototype.onExecute=function(){var T=this.getInputData(0);(T!=this._old_obj||T&&T._version!=this._old_obj_version)&&(this._old_obj=T,this.must_update=!0);var L=this.getInputData(1);L==null&&(L=this.properties.radius),this._last_radius!=L&&(this._last_radius=L,this.must_update=!0),(this.must_update||this.properties.force_update)&&(this.must_update=!1,this.updatePoints()),this.geometry.vertices=this.points,this.geometry.normals=this.normals,this.geometry._version=this.version,this.setOutputData(0,this.geometry)},f.prototype.updatePoints=function(){var T=this.properties.num_points|0;T<1&&(T=1),(!this.points||this.points.length!=T*3)&&(this.points=new Float32Array(T*3)),this.properties.generate_normals?(!this.normals||this.normals.length!=this.points.length)&&(this.normals=new Float32Array(this.points.length)):this.normals=null;var L=this._last_radius||this.properties.radius,C=this.properties.mode,N=this.getInputData(0);this._old_obj_version=N?N._version:null,this.points=f.generatePoints(L,T,C,this.points,this.normals,this.properties.regular,N),this.version++},f.generatePoints=function(T,L,C,N,R,Y,ut){var mt=L*3;(!N||N.length!=mt)&&(N=new Float32Array(mt));var yt=new Float32Array(3),D=new Float32Array([0,1,0]);if(Y){if(C==f.RECTANGLE){for(var F=Math.floor(Math.sqrt(L)),E=0;E<F;++E)for(var Q=0;Q<F;++Q){var P=E*3+Q*3*F;N[P]=(E/F-.5)*T*2,N[P+1]=0,N[P+2]=(Q/F-.5)*T*2}if(N=new Float32Array(N.subarray(0,F*F*3)),R)for(var E=0;E<R.length;E+=3)R.set(D,E)}else if(C==f.SPHERE){for(var F=Math.floor(Math.sqrt(L)),E=0;E<F;++E)for(var Q=0;Q<F;++Q){var P=E*3+Q*3*F;polarToCartesian(yt,E/F*2*Math.PI,(Q/F-.5)*2*Math.PI,T),N[P]=yt[0],N[P+1]=yt[1],N[P+2]=yt[2]}N=new Float32Array(N.subarray(0,F*F*3)),R&&f.generateSphericalNormals(N,R)}else if(C==f.CIRCLE){for(var E=0;E<mt;E+=3){var H=2*Math.PI*(E/mt);N[E]=Math.cos(H)*T,N[E+1]=0,N[E+2]=Math.sin(H)*T}if(R)for(var E=0;E<R.length;E+=3)R.set(D,E)}}else if(C==f.RECTANGLE){for(var E=0;E<mt;E+=3)N[E]=(Math.random()-.5)*T*2,N[E+1]=0,N[E+2]=(Math.random()-.5)*T*2;if(R)for(var E=0;E<R.length;E+=3)R.set(D,E)}else if(C==f.CUBE){for(var E=0;E<mt;E+=3)N[E]=(Math.random()-.5)*T*2,N[E+1]=(Math.random()-.5)*T*2,N[E+2]=(Math.random()-.5)*T*2;if(R)for(var E=0;E<R.length;E+=3)R.set(D,E)}else C==f.SPHERE?(f.generateSphere(N,mt,T),R&&f.generateSphericalNormals(N,R)):C==f.HEMISPHERE?(f.generateHemisphere(N,mt,T),R&&f.generateSphericalNormals(N,R)):C==f.CIRCLE?(f.generateInsideCircle(N,mt,T),R&&f.generateSphericalNormals(N,R)):C==f.INSIDE_SPHERE?(f.generateInsideSphere(N,mt,T),R&&f.generateSphericalNormals(N,R)):C==f.OBJECT?f.generateFromObject(N,R,mt,ut,!1):C==f.OBJECT_UNIFORMLY?f.generateFromObject(N,R,mt,ut,!0):C==f.OBJECT_INSIDE?f.generateFromInsideObject(N,mt,ut):console.warn("wrong mode in LGraphPoints3D");return N},f.generateSphericalNormals=function(T,L){for(var C=new Float32Array(3),N=0;N<L.length;N+=3)C[0]=T[N],C[1]=T[N+1],C[2]=T[N+2],vec3.normalize(C,C),L.set(C,N)},f.generateSphere=function(T,L,C){for(var N=0;N<L;N+=3){var R=Math.random(),Y=Math.random(),ut=2*Math.cos(2*Math.PI*R)*Math.sqrt(Y*(1-Y)),mt=1-2*Y,yt=2*Math.sin(2*Math.PI*R)*Math.sqrt(Y*(1-Y));T[N]=ut*C,T[N+1]=mt*C,T[N+2]=yt*C}},f.generateHemisphere=function(T,L,C){for(var N=0;N<L;N+=3){var R=Math.random(),Y=Math.random(),ut=Math.cos(2*Math.PI*R)*Math.sqrt(1-Y*Y),mt=Y,yt=Math.sin(2*Math.PI*R)*Math.sqrt(1-Y*Y);T[N]=ut*C,T[N+1]=mt*C,T[N+2]=yt*C}},f.generateInsideCircle=function(T,L,C){for(var N=0;N<L;N+=3){var R=Math.random(),Y=Math.random(),ut=Math.cos(2*Math.PI*R)*Math.sqrt(1-Y*Y),mt=Math.sin(2*Math.PI*R)*Math.sqrt(1-Y*Y);T[N]=ut*C,T[N+1]=0,T[N+2]=mt*C}},f.generateInsideSphere=function(T,L,C){for(var N=0;N<L;N+=3){var R=Math.random(),Y=Math.random(),ut=R*2*Math.PI,mt=Math.acos(2*Y-1),yt=Math.cbrt(Math.random())*C,D=Math.sin(ut),F=Math.cos(ut),E=Math.sin(mt),Q=Math.cos(mt);T[N]=yt*E*F,T[N+1]=yt*E*D,T[N+2]=yt*Q}};function c(T,L){var C=T.length,N=0,R=0,Y=C;if(C==0)return-1;if(C==1)return 0;for(;Y>=N;){R=(Y+N)*.5|0;var ut=T[R];if(ut==L)return R;if(N==Y-1)return N;ut<L?N=R:Y=R}return R}f.generateFromObject=function(T,L,C,N,R){if(N){var Y=null,ut=null,mt=null,yt=null;if(N.constructor===GL.Mesh&&(Y=N.vertexBuffers.vertices.data,ut=N.vertexBuffers.normals?N.vertexBuffers.normals.data:null,mt=N.indexBuffers.indices?N.indexBuffers.indices.data:null,mt||(mt=N.indexBuffers.triangles?N.indexBuffers.triangles.data:null)),!Y)return null;var D=mt?mt.length/3:Y.length/(3*3),F=0;if(R){yt=new Float32Array(D);for(var E=0;E<D;++E){mt?(re=mt[E*3]*3,m=mt[E*3+1]*3,M=mt[E*3+2]*3):(re=E*9,m=E*9+3,M=E*9+6);var Q=Y.subarray(re,re+3),P=Y.subarray(m,m+3),H=Y.subarray(M,M+3),q=vec3.distance(Q,P),st=vec3.distance(P,H),vt=vec3.distance(H,Q),kt=(q+st+vt)/2;F+=Math.sqrt(kt*(kt-q)*(kt-st)*(kt-vt)),yt[E]=F}for(var E=0;E<D;++E)yt[E]/=F}for(var E=0;E<C;E+=3){var Yt=Math.random(),te=R?c(yt,Yt):Math.floor(Yt*D),re=0,m=0,M=0;mt?(re=mt[te*3]*3,m=mt[te*3+1]*3,M=mt[te*3+2]*3):(re=te*9,m=te*9+3,M=te*9+6);var kt=Math.random(),Z=Math.random(),it=Math.sqrt(kt),gt=1-it,Tt=it*(1-Z),qt=Z*it;if(T[E]=gt*Y[re]+Tt*Y[m]+qt*Y[M],T[E+1]=gt*Y[re+1]+Tt*Y[m+1]+qt*Y[M+1],T[E+2]=gt*Y[re+2]+Tt*Y[m+2]+qt*Y[M+2],L&&ut){L[E]=gt*ut[re]+Tt*ut[m]+qt*ut[M],L[E+1]=gt*ut[re+1]+Tt*ut[m+1]+qt*ut[M+1],L[E+2]=gt*ut[re+2]+Tt*ut[m+2]+qt*ut[M+2];var $t=L.subarray(E,E+3);vec3.normalize($t,$t)}}}},f.generateFromInsideObject=function(T,L,C){if(!(!C||C.constructor!==GL.Mesh)){var N=C.getBoundingBox();C.octree||(C.octree=new GL.Octree(C));for(var R=C.octree,Y=vec3.create(),ut=vec3.fromValues(1,0,0),mt=vec3.create(),yt=0,D=0;yt<L&&D<T.length*10;){D+=1;var F=vec3.random(mt);F[0]=(F[0]*2-1)*N[3]+N[0],F[1]=(F[1]*2-1)*N[4]+N[1],F[2]=(F[2]*2-1)*N[5]+N[2],Y.set(F);var E=R.testRay(Y,ut,0,1e4,!0,GL.Octree.ALL);!E||E.length%2==0||(T.set(F,yt),yt+=3)}}},t.registerNodeType("geometry/points3D",f);function _(){this.addInput("points","geometry"),this.addOutput("instances","[mat4]"),this.properties={mode:1,autoupdate:!0},this.must_update=!0,this.matrices=[],this.first_time=!0}_.NORMAL=0,_.VERTICAL=1,_.SPHERICAL=2,_.RANDOM=3,_.RANDOM_VERTICAL=4,_.modes={normal:0,vertical:1,spherical:2,random:3,random_vertical:4},_.widgets_info={mode:{widget:"combo",values:_.modes}},_.title="points to inst",_.prototype.onExecute=function(){var T=this.getInputData(0);if(!T){this.setOutputData(0,null);return}if(this.isOutputConnected(0)){var L=T._version!=this._version||T._id!=this._geometry_id;(L&&this.properties.autoupdate||this.first_time)&&(this.first_time=!1,this.updateInstances(T)),this.setOutputData(0,this.matrices)}},_.prototype.updateInstances=function(T){var L=T.vertices;if(!L)return null;var C=T.normals,N=this.matrices,R=L.length/3;N.length!=R&&(N.length=R);var Y=mat4.create(),ut=vec3.create();vec3.create();var mt=vec3.fromValues(0,1,0),yt=vec3.fromValues(0,0,-1);vec3.fromValues(1,0,0);for(var D=quat.create(),F=vec3.create(),E=vec3.create(),Q=vec3.create(),P=0;P<L.length;P+=3){var H=P/3,q=N[H];q||(q=N[H]=mat4.create()),q.set(Y);var st=L.subarray(P,P+3);switch(this.properties.mode){case _.NORMAL:if(mat4.setTranslation(q,st),C){var vt=C.subarray(P,P+3);Q.set(vt),vec3.normalize(Q,Q),vec3.cross(E,yt,Q),vec3.normalize(E,E),vec3.cross(F,E,Q),vec3.normalize(F,F),q.set(E,0),q.set(Q,4),q.set(F,8),mat4.setTranslation(q,st)}break;case _.VERTICAL:mat4.setTranslation(q,st);break;case _.SPHERICAL:F.set(st),vec3.normalize(F,F),vec3.cross(E,mt,F),vec3.normalize(E,E),vec3.cross(Q,F,E),vec3.normalize(Q,Q),q.set(E,0),q.set(Q,4),q.set(F,8),mat4.setTranslation(q,st);break;case _.RANDOM:ut[0]=Math.random()*2-1,ut[1]=Math.random()*2-1,ut[2]=Math.random()*2-1,vec3.normalize(ut,ut),quat.setAxisAngle(D,ut,Math.random()*2*Math.PI),mat4.fromQuat(q,D),mat4.setTranslation(q,st);break;case _.RANDOM_VERTICAL:quat.setAxisAngle(D,mt,Math.random()*2*Math.PI),mat4.fromQuat(q,D),mat4.setTranslation(q,st);break}}this._version=T._version,this._geometry_id=T._id},t.registerNodeType("geometry/points_to_instances",_);function O(){this.addInput("in","geometry,[mat4]"),this.addInput("mat4","mat4"),this.addOutput("out","geometry"),this.properties={},this.geometry={type:"triangles",vertices:null,_id:u(),_version:0},this._last_geometry_id=-1,this._last_version=-1,this._last_key="",this.must_update=!0}O.title="Transform",O.prototype.onExecute=function(){var T=this.getInputData(0),L=this.getInputData(1);if(T){if(T.constructor===Array){if(T.length==0||(this.outputs[0].type="[mat4]",!this.isOutputConnected(0)))return;if(!L){this.setOutputData(0,T);return}this._output||(this._output=new Array),this._output.length!=T.length&&(this._output.length=T.length);for(var C=0;C<T.length;++C){var N=this._output[C];N||(N=this._output[C]=mat4.create()),mat4.multiply(N,T[C],L)}this.setOutputData(0,this._output);return}if(!(!T.vertices||!T.vertices.length)){var R=T;if(this.outputs[0].type="geometry",!!this.isOutputConnected(0)){if(!L){this.setOutputData(0,R);return}var Y=typedArrayToArray(L).join(",");(this.must_update||R._id!=this._last_geometry_id||R._version!=this._last_version||Y!=this._last_key)&&(this.updateGeometry(R,L),this._last_key=Y,this._last_version=R._version,this._last_geometry_id=R._id,this.must_update=!1),this.setOutputData(0,this.geometry)}}}},O.prototype.updateGeometry=function(T,L){var C=T.vertices,N=this.geometry.vertices;(!N||N.length!=C.length)&&(N=this.geometry.vertices=new Float32Array(C.length));for(var R=vec3.create(),Y=0,ut=N.length;Y<ut;Y+=3)R[0]=C[Y],R[1]=C[Y+1],R[2]=C[Y+2],mat4.multiplyVec3(R,L,R),N[Y]=R[0],N[Y+1]=R[1],N[Y+2]=R[2];if(T.normals){(!this.geometry.normals||this.geometry.normals.length!=T.normals.length)&&(this.geometry.normals=new Float32Array(T.normals.length));var mt=this.geometry.normals,yt=mat4.invert(mat4.create(),L);yt&&mat4.transpose(yt,yt);for(var D=T.normals,Y=0,ut=mt.length;Y<ut;Y+=3)R[0]=D[Y],R[1]=D[Y+1],R[2]=D[Y+2],mat4.multiplyVec3(R,yt,R),mt[Y]=R[0],mt[Y+1]=R[1],mt[Y+2]=R[2]}this.geometry.type=T.type,this.geometry._version++},t.registerNodeType("geometry/transform",O);function d(){this.addInput("sides","number"),this.addInput("radius","number"),this.addOutput("out","geometry"),this.properties={sides:6,radius:1,uvs:!1},this.geometry={type:"line_loop",vertices:null,_id:u()},this.geometry_id=-1,this.version=-1,this.must_update=!0,this.last_info={sides:-1,radius:-1}}d.title="Polygon",d.prototype.onExecute=function(){if(this.isOutputConnected(0)){var T=this.getInputOrProperty("sides"),L=this.getInputOrProperty("radius");T=Math.max(3,T)|0,(this.last_info.sides!=T||this.last_info.radius!=L)&&this.updateGeometry(T,L),this.setOutputData(0,this.geometry)}},d.prototype.updateGeometry=function(T,L){var C=3*T,N=this.geometry.vertices;(!N||N.length!=C)&&(N=this.geometry.vertices=new Float32Array(3*T));var R=Math.PI*2/T,Y=this.properties.uvs;Y&&(uvs=this.geometry.coords=new Float32Array(3*T));for(var ut=0;ut<T;++ut){var mt=R*-ut,yt=Math.cos(mt)*L,D=0,F=Math.sin(mt)*L;N[ut*3]=yt,N[ut*3+1]=D,N[ut*3+2]=F}this.geometry._id=++this.geometry_id,this.geometry._version=++this.version,this.last_info.sides=T,this.last_info.radius=L},t.registerNodeType("geometry/polygon",d);function b(){this.addInput("","geometry"),this.addOutput("","geometry"),this.properties={top_cap:!0,bottom_cap:!0,offset:[0,100,0]},this.version=-1,this._last_geo_version=-1,this._must_update=!0}b.title="extrude",b.prototype.onPropertyChanged=function(T,L){this._must_update=!0},b.prototype.onExecute=function(){var T=this.getInputData(0);!T||!this.isOutputConnected(0)||((T.version!=this._last_geo_version||this._must_update)&&(this._geo=this.extrudeGeometry(T,this._geo),this._geo&&(this._geo.version=this.version++),this._must_update=!1),this.setOutputData(0,this._geo))},b.prototype.extrudeGeometry=function(T){var L=T.vertices,C=L.length/3,N=vec3.create(),R=vec3.create(),Y=vec3.create(),ut=vec3.create(),mt=new Float32Array(this.properties.offset);if(T.type=="line_loop")for(var yt=new Float32Array(C*6*3),D=0,F=0,E=L.length;F<E;F+=3)N[0]=L[F],N[1]=L[F+1],N[2]=L[F+2],F+3<E?(R[0]=L[F+3],R[1]=L[F+4],R[2]=L[F+5]):(R[0]=L[0],R[1]=L[1],R[2]=L[2]),vec3.add(Y,N,mt),vec3.add(ut,R,mt),yt.set(N,D),D+=3,yt.set(R,D),D+=3,yt.set(Y,D),D+=3,yt.set(R,D),D+=3,yt.set(ut,D),D+=3,yt.set(Y,D),D+=3;var Q={_id:u(),type:"triangles",vertices:yt};return Q},t.registerNodeType("geometry/extrude",b);function S(){this.addInput("in","geometry"),this.addOutput("out","geometry"),this.properties={code:"V[1] += 0.01 * Math.sin(I + T*0.001);",execute_every_frame:!1},this.geometry=null,this.geometry_id=-1,this.version=-1,this.must_update=!0,this.vertices=null,this.func=null}S.title="geoeval",S.desc="eval code",S.widgets_info={code:{widget:"code"}},S.prototype.onConfigure=function(T){this.compileCode()},S.prototype.compileCode=function(){if(this.properties.code)try{this.func=new Function("V","I","T",this.properties.code),this.boxcolor="#AFA",this.must_update=!0}catch{this.boxcolor="red"}},S.prototype.onPropertyChanged=function(T,L){T=="code"&&(this.properties.code=L,this.compileCode())},S.prototype.onExecute=function(){var T=this.getInputData(0);if(T){if(!this.func){this.setOutputData(0,T);return}if(this.geometry_id!=T._id||this.version!=T._version||this.must_update||this.properties.execute_every_frame){this.must_update=!1,this.geometry_id=T._id,this.properties.execute_every_frame?this.version++:this.version=T._version;var L=this.func,C=getTime();this.geometry||(this.geometry={});for(var N in T)T[N]!=null&&(T[N].constructor==Float32Array?this.geometry[N]=new Float32Array(T[N]):this.geometry[N]=T[N]);this.geometry._id=T._id,this.properties.execute_every_frame?this.geometry._version=this.version:this.geometry._version=T._version+1;var R=vec3.create(),Y=this.vertices;!Y||this.vertices.length!=T.vertices.length?Y=this.vertices=new Float32Array(T.vertices):Y.set(T.vertices);for(var N=0;N<Y.length;N+=3)R[0]=Y[N],R[1]=Y[N+1],R[2]=Y[N+2],L(R,N/3,C),Y[N]=R[0],Y[N+1]=R[1],Y[N+2]=R[2];this.geometry.vertices=Y}this.setOutputData(0,this.geometry)}},t.registerNodeType("geometry/eval",S);function G(){this.addInput("in","geometry"),this.addOutput("out","geometry"),this.properties={min_dist:.4,max_dist:.5,max_connections:0,probability:1},this.geometry_id=-1,this.version=-1,this.my_version=1,this.must_update=!0}if(G.title="connect points",G.desc="adds indices between near points",G.prototype.onPropertyChanged=function(T,L){this.must_update=!0},G.prototype.onExecute=function(){var T=this.getInputData(0);if(T){if(this.geometry_id!=T._id||this.version!=T._version||this.must_update){this.must_update=!1,this.geometry_id=T._id,this.version=T._version,this.geometry={};for(var L in T)this.geometry[L]=T[L];this.geometry._id=u(),this.geometry._version=this.my_version++;for(var C=T.vertices,N=C.length,R=this.properties.min_dist,Y=this.properties.max_dist,ut=this.properties.probability,mt=this.properties.max_connections,yt=[],L=0;L<N;L+=3)for(var D=C[L],F=C[L+1],E=C[L+2],Q=0,P=L+3;P<N;P+=3){var H=C[P],q=C[P+1],st=C[P+2],vt=Math.sqrt((D-H)*(D-H)+(F-q)*(F-q)+(E-st)*(E-st));if(!(vt>Y||vt<R||ut<1&&ut<Math.random())&&(yt.push(L/3,P/3),Q+=1,mt&&Q>mt))break}this.geometry.indices=this.indices=new Uint32Array(yt)}this.indices&&this.indices.length?(this.geometry.indices=this.indices,this.setOutputData(0,this.geometry)):this.setOutputData(0,null)}},t.registerNodeType("geometry/connectPoints",G),typeof GL>"u")return;function z(){this.addInput("mesh","mesh"),this.addOutput("out","geometry"),this.geometry={},this.last_mesh=null}z.title="to geometry",z.desc="converts a mesh to geometry",z.prototype.onExecute=function(){var T=this.getInputData(0);if(T){if(T!=this.last_mesh){this.last_mesh=T;for(i in T.vertexBuffers){var L=T.vertexBuffers[i];this.geometry[i]=L.data}T.indexBuffers.triangles&&(this.geometry.indices=T.indexBuffers.triangles.data),this.geometry._id=u(),this.geometry._version=0}this.setOutputData(0,this.geometry),this.geometry&&this.setOutputData(1,this.geometry.vertices)}},t.registerNodeType("geometry/toGeometry",z);function $(){this.addInput("in","geometry"),this.addOutput("mesh","mesh"),this.properties={},this.version=-1,this.mesh=null}$.title="Geo to Mesh",$.prototype.updateMesh=function(T){this.mesh||(this.mesh=new GL.Mesh);for(var L in T)if(L[0]!="_"){var C=T[L],N=GL.Mesh.common_buffers[L];if(!(!N&&L!="indices")){var R=N?N.spacing:3,Y=this.mesh.vertexBuffers[L];!Y||Y.data.length!=C.length?Y=new GL.Buffer(L=="indices"?GL.ELEMENT_ARRAY_BUFFER:GL.ARRAY_BUFFER,C,R,GL.DYNAMIC_DRAW):(Y.data.set(C),Y.upload(GL.DYNAMIC_DRAW)),this.mesh.addBuffer(L,Y)}}if(this.mesh.vertexBuffers.normals&&this.mesh.vertexBuffers.normals.data.length!=this.mesh.vertexBuffers.vertices.data.length){for(var ut=new Float32Array([0,1,0]),mt=new Float32Array(this.mesh.vertexBuffers.vertices.data.length),L=0;L<mt.length;L+=3)mt.set(ut,L);Y=new GL.Buffer(GL.ARRAY_BUFFER,mt,3),this.mesh.addBuffer("normals",Y)}return this.mesh.updateBoundingBox(),this.geometry_id=this.mesh.id=T._id,this.version=this.mesh.version=T._version,this.mesh},$.prototype.onExecute=function(){var T=this.getInputData(0);T&&((this.version!=T._version||this.geometry_id!=T._id)&&this.updateMesh(T),this.setOutputData(0,this.mesh))},t.registerNodeType("geometry/toMesh",$);function A(){this.addInput("mesh","mesh"),this.addInput("mat4","mat4"),this.addInput("tex","texture"),this.properties={enabled:!0,primitive:GL.TRIANGLES,additive:!1,color:[1,1,1],opacity:1},this.color=vec4.create([1,1,1,1]),this.model_matrix=mat4.create(),this.uniforms={u_color:this.color,u_model:this.model_matrix}}A.title="Render Mesh",A.desc="renders a mesh flat",A.PRIMITIVE_VALUES={points:GL.POINTS,lines:GL.LINES,line_loop:GL.LINE_LOOP,line_strip:GL.LINE_STRIP,triangles:GL.TRIANGLES,triangle_fan:GL.TRIANGLE_FAN,triangle_strip:GL.TRIANGLE_STRIP},A.widgets_info={primitive:{widget:"combo",values:A.PRIMITIVE_VALUES},color:{widget:"color"}},A.prototype.onExecute=function(){if(this.properties.enabled){var T=this.getInputData(0);if(T){if(!t.LGraphRender.onRequestCameraMatrices){console.warn("cannot render geometry, LiteGraph.onRequestCameraMatrices is null, remember to fill this with a callback(view_matrix, projection_matrix,viewprojection_matrix) to use 3D rendering from the graph");return}t.LGraphRender.onRequestCameraMatrices(n,r,s);var L=null,C=this.getInputData(2);C?(L=gl.shaders.textured,L||(L=gl.shaders.textured=new GL.Shader(I.vertex_shader_code,I.fragment_shader_code,{USE_TEXTURE:""}))):(L=gl.shaders.flat,L||(L=gl.shaders.flat=new GL.Shader(I.vertex_shader_code,I.fragment_shader_code))),this.color.set(this.properties.color),this.color[3]=this.properties.opacity;var N=this.model_matrix,R=this.getInputData(1);R?N.set(R):mat4.identity(N),this.uniforms.u_point_size=1;var Y=this.properties.primitive;L.uniforms(h),L.uniforms(this.uniforms),this.properties.opacity>=1?gl.disable(gl.BLEND):gl.enable(gl.BLEND),gl.enable(gl.DEPTH_TEST),this.properties.additive?(gl.blendFunc(gl.SRC_ALPHA,gl.ONE),gl.depthMask(!1)):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);var ut="indices";T.indexBuffers.triangles&&(ut="triangles"),L.draw(T,Y,ut),gl.disable(gl.BLEND),gl.depthMask(!0)}}},t.registerNodeType("geometry/render_mesh",A);function l(){this.addInput("size","number"),this.addOutput("out","mesh"),this.properties={type:1,size:1,subdivisions:32},this.version=Math.random()*1e5|0,this.last_info={type:-1,size:-1,subdivisions:-1}}l.title="Primitive",l.VALID={CUBE:1,PLANE:2,CYLINDER:3,SPHERE:4,CIRCLE:5,HEMISPHERE:6,ICOSAHEDRON:7,CONE:8,QUAD:9},l.widgets_info={type:{widget:"combo",values:l.VALID}},l.prototype.onExecute=function(){if(this.isOutputConnected(0)){var T=this.getInputOrProperty("size");(this.last_info.type!=this.properties.type||this.last_info.size!=T||this.last_info.subdivisions!=this.properties.subdivisions)&&this.updateMesh(this.properties.type,T,this.properties.subdivisions),this.setOutputData(0,this._mesh)}},l.prototype.updateMesh=function(T,L,C){switch(C=Math.max(0,C)|0,T){case 1:this._mesh=GL.Mesh.cube({size:L,normals:!0,coords:!0});break;case 2:this._mesh=GL.Mesh.plane({size:L,xz:!0,detail:C,normals:!0,coords:!0});break;case 3:this._mesh=GL.Mesh.cylinder({size:L,subdivisions:C,normals:!0,coords:!0});break;case 4:this._mesh=GL.Mesh.sphere({size:L,long:C,lat:C,normals:!0,coords:!0});break;case 5:this._mesh=GL.Mesh.circle({size:L,slices:C,normals:!0,coords:!0});break;case 6:this._mesh=GL.Mesh.sphere({size:L,long:C,lat:C,normals:!0,coords:!0,hemi:!0});break;case 7:this._mesh=GL.Mesh.icosahedron({size:L,subdivisions:C});break;case 8:this._mesh=GL.Mesh.cone({radius:L,height:L,subdivisions:C});break;case 9:this._mesh=GL.Mesh.plane({size:L,xz:!1,detail:C,normals:!0,coords:!0});break}this.last_info.type=T,this.last_info.size=L,this.last_info.subdivisions=C,this._mesh.version=this.version++},t.registerNodeType("geometry/mesh_primitive",l);function I(){this.addInput("in","geometry"),this.addInput("mat4","mat4"),this.addInput("tex","texture"),this.properties={enabled:!0,point_size:.1,fixed_size:!1,additive:!0,color:[1,1,1],opacity:1},this.color=vec4.create([1,1,1,1]),this.uniforms={u_point_size:1,u_perspective:1,u_point_perspective:1,u_color:this.color},this.geometry_id=-1,this.version=-1,this.mesh=null}I.title="renderPoints",I.desc="render points with a texture",I.widgets_info={color:{widget:"color"}},I.prototype.updateMesh=function(T){this.buffer,!this.buffer||!this.buffer.data||this.buffer.data.length!=T.vertices.length?this.buffer=new GL.Buffer(GL.ARRAY_BUFFER,T.vertices,3,GL.DYNAMIC_DRAW):(this.buffer.data.set(T.vertices),this.buffer.upload(GL.DYNAMIC_DRAW)),this.mesh||(this.mesh=new GL.Mesh),this.mesh.addBuffer("vertices",this.buffer),this.geometry_id=this.mesh.id=T._id,this.version=this.mesh.version=T._version},I.prototype.onExecute=function(){if(this.properties.enabled){var T=this.getInputData(0);if(T){if((this.version!=T._version||this.geometry_id!=T._id)&&this.updateMesh(T),!t.LGraphRender.onRequestCameraMatrices){console.warn("cannot render geometry, LiteGraph.onRequestCameraMatrices is null, remember to fill this with a callback(view_matrix, projection_matrix,viewprojection_matrix) to use 3D rendering from the graph");return}t.LGraphRender.onRequestCameraMatrices(n,r,s);var L=null,C=this.getInputData(2);C?(L=gl.shaders.textured_points,L||(L=gl.shaders.textured_points=new GL.Shader(I.vertex_shader_code,I.fragment_shader_code,{USE_TEXTURED_POINTS:""}))):(L=gl.shaders.points,L||(L=gl.shaders.points=new GL.Shader(I.vertex_shader_code,I.fragment_shader_code,{USE_POINTS:""}))),this.color.set(this.properties.color),this.color[3]=this.properties.opacity;var N=this.getInputData(1);N?o.set(N):mat4.identity(o),this.uniforms.u_point_size=this.properties.point_size,this.uniforms.u_point_perspective=this.properties.fixed_size?0:1,this.uniforms.u_perspective=gl.viewport_data[3]*r[5],L.uniforms(h),L.uniforms(this.uniforms),this.properties.opacity>=1?gl.disable(gl.BLEND):gl.enable(gl.BLEND),gl.enable(gl.DEPTH_TEST),this.properties.additive?(gl.blendFunc(gl.SRC_ALPHA,gl.ONE),gl.depthMask(!1)):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),L.draw(this.mesh,GL.POINTS),gl.disable(gl.BLEND),gl.depthMask(!0)}}},t.registerNodeType("geometry/render_points",I),I.vertex_shader_code=`		precision mediump float;
		attribute vec3 a_vertex;
		varying vec3 v_vertex;
		attribute vec3 a_normal;
		varying vec3 v_normal;
		#ifdef USE_COLOR
			attribute vec4 a_color;
			varying vec4 v_color;
		#endif
		attribute vec2 a_coord;
		varying vec2 v_coord;
		#ifdef USE_SIZE
			attribute float a_extra;
		#endif
		#ifdef USE_INSTANCING
			attribute mat4 u_model;
		#else
			uniform mat4 u_model;
		#endif
		uniform mat4 u_viewprojection;
		uniform float u_point_size;
		uniform float u_perspective;
		uniform float u_point_perspective;
		float computePointSize(float radius, float w)
		{
			if(radius < 0.0)
				return -radius;
			return u_perspective * radius / w;
		}
		void main() {
			v_coord = a_coord;
			#ifdef USE_COLOR
				v_color = a_color;
			#endif
			v_vertex = ( u_model * vec4( a_vertex, 1.0 )).xyz;
			v_normal = ( u_model * vec4( a_normal, 0.0 )).xyz;
			gl_Position = u_viewprojection * vec4(v_vertex,1.0);
			gl_PointSize = u_point_size;
			#ifdef USE_SIZE
				gl_PointSize = a_extra;
			#endif
			if(u_point_perspective != 0.0)
				gl_PointSize = computePointSize( gl_PointSize, gl_Position.w );
		}	`,I.fragment_shader_code=`		precision mediump float;
		uniform vec4 u_color;
		#ifdef USE_COLOR
			varying vec4 v_color;
		#endif
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		void main() {
			vec4 color = u_color;
			#ifdef USE_TEXTURED_POINTS
				color *= texture2D(u_texture, gl_PointCoord.xy);
			#else
				#ifdef USE_TEXTURE
				  color *= texture2D(u_texture, v_coord);
				  if(color.a < 0.1)
					discard;
				#endif
				#ifdef USE_POINTS
					float dist = length( gl_PointCoord.xy - vec2(0.5) );
					if( dist > 0.45 )
						discard;
				#endif
			#endif
			#ifdef USE_COLOR
				color *= v_color;
			#endif
			gl_FragColor = color;
		}	`}(commonjsGlobal),function(e){var t=e.LiteGraph,n=e.LGraphTexture;if(typeof GL<"u"){let r=function(){this.addInput("Texture","Texture"),this.addInput("Aberration","number"),this.addInput("Distortion","number"),this.addInput("Blur","number"),this.addOutput("Texture","Texture"),this.properties={aberration:1,distortion:1,blur:1,precision:n.DEFAULT},r._shader||(r._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,r.pixel_shader),r._texture=new GL.Texture(3,1,{format:gl.RGB,wrap:gl.CLAMP_TO_EDGE,magFilter:gl.LINEAR,minFilter:gl.LINEAR,pixel_data:[255,0,0,0,255,0,0,0,255]}))},s=function(){this.addInput("Texture","Texture"),this.addInput("Blurred","Texture"),this.addInput("Mask","Texture"),this.addInput("Threshold","number"),this.addOutput("Texture","Texture"),this.properties={shape:"",size:10,alpha:1,threshold:1,high_precision:!1}},o=function(){this.addInput("Texture","Texture"),this.addInput("value1","number"),this.addInput("value2","number"),this.addOutput("Texture","Texture"),this.properties={fx:"halftone",value1:1,value2:1,precision:n.DEFAULT}},h=function(){this.addInput("Tex.","Texture"),this.addInput("intensity","number"),this.addOutput("Texture","Texture"),this.properties={intensity:1,invert:!1,precision:n.DEFAULT},h._shader||(h._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,h.pixel_shader))};r.title="Lens",r.desc="Camera Lens distortion",r.widgets_info={precision:{widget:"combo",values:n.MODE_VALUES}},r.prototype.onExecute=function(){var u=this.getInputData(0);if(this.properties.precision===n.PASS_THROUGH){this.setOutputData(0,u);return}if(u){this._tex=n.getTargetTexture(u,this._tex,this.properties.precision);var f=this.properties.aberration;this.isInputConnected(1)&&(f=this.getInputData(1),this.properties.aberration=f);var c=this.properties.distortion;this.isInputConnected(2)&&(c=this.getInputData(2),this.properties.distortion=c);var _=this.properties.blur;this.isInputConnected(3)&&(_=this.getInputData(3),this.properties.blur=_),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var O=Mesh.getScreenQuad(),d=r._shader;this._tex.drawTo(function(){u.bind(0),d.uniforms({u_texture:0,u_aberration:f,u_distortion:c,u_blur:_}).draw(O)}),this.setOutputData(0,this._tex)}},r.pixel_shader=`precision highp float;
			precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform vec2 u_camera_planes;
			uniform float u_aberration;
			uniform float u_distortion;
			uniform float u_blur;
			
			void main() {
				vec2 coord = v_coord;
				float dist = distance(vec2(0.5), coord);
				vec2 dist_coord = coord - vec2(0.5);
				float percent = 1.0 + ((0.5 - dist) / 0.5) * u_distortion;
				dist_coord *= percent;
				coord = dist_coord + vec2(0.5);
				vec4 color = texture2D(u_texture,coord, u_blur * dist);
				color.r = texture2D(u_texture,vec2(0.5) + dist_coord * (1.0+0.01*u_aberration), u_blur * dist ).r;
				color.b = texture2D(u_texture,vec2(0.5) + dist_coord * (1.0-0.01*u_aberration), u_blur * dist ).b;
				gl_FragColor = color;
			}
			`,t.registerNodeType("fx/lens",r),e.LGraphFXLens=r,s.title="Bokeh",s.desc="applies an Bokeh effect",s.widgets_info={shape:{widget:"texture"}},s.prototype.onExecute=function(){var u=this.getInputData(0),f=this.getInputData(1),c=this.getInputData(2);if(!u||!c||!this.properties.shape){this.setOutputData(0,u);return}f||(f=u);var _=n.getTexture(this.properties.shape);if(_){var O=this.properties.threshold;this.isInputConnected(3)&&(O=this.getInputData(3),this.properties.threshold=O);var d=gl.UNSIGNED_BYTE;this.properties.high_precision&&(d=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.FLOAT),(!this._temp_texture||this._temp_texture.type!=d||this._temp_texture.width!=u.width||this._temp_texture.height!=u.height)&&(this._temp_texture=new GL.Texture(u.width,u.height,{type:d,format:gl.RGBA,filter:gl.LINEAR})),this.properties.size;var b=s._first_shader;b||(b=s._first_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,s._first_pixel_shader));var S=s._second_shader;S||(S=s._second_shader=new GL.Shader(s._second_vertex_shader,s._second_pixel_shader));var G=this._points_mesh;(!G||G._width!=u.width||G._height!=u.height||G._spacing!=2)&&(G=this.createPointsMesh(u.width,u.height,2));var z=Mesh.getScreenQuad(),$=this.properties.size;this.properties.min_light;var A=this.properties.alpha;gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),this._temp_texture.drawTo(function(){u.bind(0),f.bind(1),c.bind(2),b.uniforms({u_texture:0,u_texture_blur:1,u_mask:2,u_texsize:[u.width,u.height]}).draw(z)}),this._temp_texture.drawTo(function(){gl.enable(gl.BLEND),gl.blendFunc(gl.ONE,gl.ONE),u.bind(0),_.bind(3),S.uniforms({u_texture:0,u_mask:2,u_shape:3,u_alpha:A,u_threshold:O,u_pointSize:$,u_itexsize:[1/u.width,1/u.height]}).draw(G,gl.POINTS)}),this.setOutputData(0,this._temp_texture)}},s.prototype.createPointsMesh=function(u,f,c){for(var _=Math.round(u/c),O=Math.round(f/c),d=new Float32Array(_*O*2),b=-1,S=2/u*c,G=2/f*c,z=0;z<O;++z){for(var $=-1,A=0;A<_;++A){var l=z*_*2+A*2;d[l]=$,d[l+1]=b,$+=S}b+=G}return this._points_mesh=GL.Mesh.load({vertices2D:d}),this._points_mesh._width=u,this._points_mesh._height=f,this._points_mesh._spacing=c,this._points_mesh},s._first_pixel_shader=`precision highp float;
			precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform sampler2D u_texture_blur;
			uniform sampler2D u_mask;
			
			void main() {
				vec4 color = texture2D(u_texture, v_coord);
				vec4 blurred_color = texture2D(u_texture_blur, v_coord);
				float mask = texture2D(u_mask, v_coord).x;
			   gl_FragColor = mix(color, blurred_color, mask);
			}
			`,s._second_vertex_shader=`precision highp float;
			attribute vec2 a_vertex2D;
			varying vec4 v_color;
			uniform sampler2D u_texture;
			uniform sampler2D u_mask;
			uniform vec2 u_itexsize;
			uniform float u_pointSize;
			uniform float u_threshold;
			void main() {
				vec2 coord = a_vertex2D * 0.5 + 0.5;
				v_color = texture2D( u_texture, coord );
				v_color += texture2D( u_texture, coord + vec2(u_itexsize.x, 0.0) );
				v_color += texture2D( u_texture, coord + vec2(0.0, u_itexsize.y));
				v_color += texture2D( u_texture, coord + u_itexsize);
				v_color *= 0.25;
				float mask = texture2D(u_mask, coord).x;
				float luminance = length(v_color) * mask;
				/*luminance /= (u_pointSize*u_pointSize)*0.01 */;
				luminance -= u_threshold;
				if(luminance < 0.0)
				{
					gl_Position.x = -100.0;
					return;
				}
				gl_PointSize = u_pointSize;
				gl_Position = vec4(a_vertex2D,0.0,1.0);
			}
			`,s._second_pixel_shader=`precision highp float;
			varying vec4 v_color;
			uniform sampler2D u_shape;
			uniform float u_alpha;
			
			void main() {
				vec4 color = texture2D( u_shape, gl_PointCoord );
				color *= v_color * u_alpha;
				gl_FragColor = color;
			}
`,t.registerNodeType("fx/bokeh",s),e.LGraphFXBokeh=s,o.title="FX",o.desc="applies an FX from a list",o.widgets_info={fx:{widget:"combo",values:["halftone","pixelate","lowpalette","noise","gamma"]},precision:{widget:"combo",values:n.MODE_VALUES}},o.shaders={},o.prototype.onExecute=function(){if(this.isOutputConnected(0)){var u=this.getInputData(0);if(this.properties.precision===n.PASS_THROUGH){this.setOutputData(0,u);return}if(u){this._tex=n.getTargetTexture(u,this._tex,this.properties.precision);var f=this.properties.value1;this.isInputConnected(1)&&(f=this.getInputData(1),this.properties.value1=f);var c=this.properties.value2;this.isInputConnected(2)&&(c=this.getInputData(2),this.properties.value2=c);var _=this.properties.fx,O=o.shaders[_];if(!O){var d=o["pixel_shader_"+_];if(!d)return;O=o.shaders[_]=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,d)}gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var b=Mesh.getScreenQuad(),S=e.LS?LS.Renderer._current_camera:null,G;S?G=[LS.Renderer._current_camera.near,LS.Renderer._current_camera.far]:G=[1,100];var z=null;_=="noise"&&(z=n.getNoiseTexture()),this._tex.drawTo(function(){u.bind(0),_=="noise"&&z.bind(1),O.uniforms({u_texture:0,u_noise:1,u_size:[u.width,u.height],u_rand:[Math.random(),Math.random()],u_value1:f,u_value2:c,u_camera_planes:G}).draw(b)}),this.setOutputData(0,this._tex)}}},o.pixel_shader_halftone=`precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform vec2 u_camera_planes;
			uniform vec2 u_size;
			uniform float u_value1;
			uniform float u_value2;
			
			float pattern() {
				float s = sin(u_value1 * 3.1415), c = cos(u_value1 * 3.1415);
				vec2 tex = v_coord * u_size.xy;
				vec2 point = vec2(
				   c * tex.x - s * tex.y ,
				   s * tex.x + c * tex.y 
				) * u_value2;
				return (sin(point.x) * sin(point.y)) * 4.0;
			}
			void main() {
				vec4 color = texture2D(u_texture, v_coord);
				float average = (color.r + color.g + color.b) / 3.0;
				gl_FragColor = vec4(vec3(average * 10.0 - 5.0 + pattern()), color.a);
			}
`,o.pixel_shader_pixelate=`precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform vec2 u_camera_planes;
			uniform vec2 u_size;
			uniform float u_value1;
			uniform float u_value2;
			
			void main() {
				vec2 coord = vec2( floor(v_coord.x * u_value1) / u_value1, floor(v_coord.y * u_value2) / u_value2 );
				vec4 color = texture2D(u_texture, coord);
				gl_FragColor = color;
			}
`,o.pixel_shader_lowpalette=`precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform vec2 u_camera_planes;
			uniform vec2 u_size;
			uniform float u_value1;
			uniform float u_value2;
			
			void main() {
				vec4 color = texture2D(u_texture, v_coord);
				gl_FragColor = floor(color * u_value1) / u_value1;
			}
`,o.pixel_shader_noise=`precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform sampler2D u_noise;
			uniform vec2 u_size;
			uniform float u_value1;
			uniform float u_value2;
			uniform vec2 u_rand;
			
			void main() {
				vec4 color = texture2D(u_texture, v_coord);
				vec3 noise = texture2D(u_noise, v_coord * vec2(u_size.x / 512.0, u_size.y / 512.0) + u_rand).xyz - vec3(0.5);
				gl_FragColor = vec4( color.xyz + noise * u_value1, color.a );
			}
`,o.pixel_shader_gamma=`precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform float u_value1;
			
			void main() {
				vec4 color = texture2D(u_texture, v_coord);
				float gamma = 1.0 / u_value1;
				gl_FragColor = vec4( pow( color.xyz, vec3(gamma) ), color.a );
			}
`,t.registerNodeType("fx/generic",o),e.LGraphFXGeneric=o,h.title="Vigneting",h.desc="Vigneting",h.widgets_info={precision:{widget:"combo",values:n.MODE_VALUES}},h.prototype.onExecute=function(){var u=this.getInputData(0);if(this.properties.precision===n.PASS_THROUGH){this.setOutputData(0,u);return}if(u){this._tex=n.getTargetTexture(u,this._tex,this.properties.precision);var f=this.properties.intensity;this.isInputConnected(1)&&(f=this.getInputData(1),this.properties.intensity=f),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var c=Mesh.getScreenQuad(),_=h._shader,O=this.properties.invert;this._tex.drawTo(function(){u.bind(0),_.uniforms({u_texture:0,u_intensity:f,u_isize:[1/u.width,1/u.height],u_invert:O?1:0}).draw(c)}),this.setOutputData(0,this._tex)}},h.pixel_shader=`precision highp float;
			precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform float u_intensity;
			uniform int u_invert;
			
			void main() {
				float luminance = 1.0 - length( v_coord - vec2(0.5) ) * 1.414;
				vec4 color = texture2D(u_texture, v_coord);
				if(u_invert == 1)
					luminance = 1.0 - luminance;
				luminance = mix(1.0, luminance, u_intensity);
			   gl_FragColor = vec4( luminance * color.xyz, color.a);
			}
			`,t.registerNodeType("fx/vigneting",h),e.LGraphFXVigneting=h}}(commonjsGlobal),function(e){var t=e.LiteGraph,n="#243";function r(A){this.channel=0,this.cmd=0,this.data=new Uint32Array(3),A&&this.setup(A)}t.MIDIEvent=r,r.prototype.fromJSON=function(A){this.setup(A.data)},r.prototype.setup=function(A){var l=A;A.constructor===Object&&(l=A.data),this.data.set(l);var I=l[0];this.status=I;var T=I&240;I>=240?this.cmd=I:this.cmd=T,this.cmd==r.NOTEON&&this.velocity==0&&(this.cmd=r.NOTEOFF),this.cmd_str=r.commands[this.cmd]||"",(T>=r.NOTEON||T<=r.NOTEOFF)&&(this.channel=I&15)},Object.defineProperty(r.prototype,"velocity",{get:function(){return this.cmd==r.NOTEON?this.data[2]:-1},set:function(A){this.data[2]=A},enumerable:!0}),r.notes=["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"],r.note_to_index={A:0,"A#":1,B:2,C:3,"C#":4,D:5,"D#":6,E:7,F:8,"F#":9,G:10,"G#":11},Object.defineProperty(r.prototype,"note",{get:function(){return this.cmd!=r.NOTEON?-1:r.toNoteString(this.data[1],!0)},set:function(A){throw"notes cannot be assigned this way, must modify the data[1]"},enumerable:!0}),Object.defineProperty(r.prototype,"octave",{get:function(){if(this.cmd!=r.NOTEON)return-1;var A=this.data[1]-24;return Math.floor(A/12+1)},set:function(A){throw"octave cannot be assigned this way, must modify the data[1]"},enumerable:!0}),r.prototype.getPitch=function(){return Math.pow(2,(this.data[1]-69)/12)*440},r.computePitch=function(A){return Math.pow(2,(A-69)/12)*440},r.prototype.getCC=function(){return this.data[1]},r.prototype.getCCValue=function(){return this.data[2]},r.prototype.getPitchBend=function(){return this.data[1]+(this.data[2]<<7)-8192},r.computePitchBend=function(A,l){return A+(l<<7)-8192},r.prototype.setCommandFromString=function(A){this.cmd=r.computeCommandFromString(A)},r.computeCommandFromString=function(A){if(!A)return 0;if(A&&A.constructor===Number)return A;switch(A=A.toUpperCase(),A){case"NOTE ON":case"NOTEON":return r.NOTEON;case"NOTE OFF":case"NOTEOFF":return r.NOTEON;case"KEY PRESSURE":case"KEYPRESSURE":return r.KEYPRESSURE;case"CONTROLLER CHANGE":case"CONTROLLERCHANGE":case"CC":return r.CONTROLLERCHANGE;case"PROGRAM CHANGE":case"PROGRAMCHANGE":case"PC":return r.PROGRAMCHANGE;case"CHANNEL PRESSURE":case"CHANNELPRESSURE":return r.CHANNELPRESSURE;case"PITCH BEND":case"PITCHBEND":return r.PITCHBEND;case"TIME TICK":case"TIMETICK":return r.TIMETICK;default:return Number(A)}},r.toNoteString=function(A,l){A=Math.round(A);var I=A-21,T=Math.floor((A-24)/12+1);return I=I%12,I<0&&(I=12+I),r.notes[I]+(l?"":T)},r.NoteStringToPitch=function(A){A=A.toUpperCase();var l=A[0],I=4;A[1]=="#"?(l+="#",A.length>2&&(I=Number(A[2]))):A.length>1&&(I=Number(A[1]));var T=r.note_to_index[l];return T==null?null:(I-1)*12+T+21},r.prototype.toString=function(){var A=""+this.channel+". ";switch(this.cmd){case r.NOTEON:A+="NOTEON "+r.toNoteString(this.data[1]);break;case r.NOTEOFF:A+="NOTEOFF "+r.toNoteString(this.data[1]);break;case r.CONTROLLERCHANGE:A+="CC "+this.data[1]+" "+this.data[2];break;case r.PROGRAMCHANGE:A+="PC "+this.data[1];break;case r.PITCHBEND:A+="PITCHBEND "+this.getPitchBend();break;case r.KEYPRESSURE:A+="KEYPRESS "+this.data[1];break}return A},r.prototype.toHexString=function(){for(var A="",l=0;l<this.data.length;l++)A+=this.data[l].toString(16)+" "},r.prototype.toJSON=function(){return{data:[this.data[0],this.data[1],this.data[2]],object_class:"MIDIEvent"}},r.NOTEOFF=128,r.NOTEON=144,r.KEYPRESSURE=160,r.CONTROLLERCHANGE=176,r.PROGRAMCHANGE=192,r.CHANNELPRESSURE=208,r.PITCHBEND=224,r.TIMETICK=248,r.commands={128:"note off",144:"note on",160:"key pressure",176:"controller change",192:"program change",208:"channel pressure",224:"pitch bend",240:"system",242:"Song pos",243:"Song select",246:"Tune request",248:"time tick",250:"Start Song",251:"Continue Song",252:"Stop Song",254:"Sensing",255:"Reset"},r.commands_short={128:"NOTEOFF",144:"NOTEOFF",160:"KEYP",176:"CC",192:"PC",208:"CP",224:"PB",240:"SYS",242:"POS",243:"SELECT",246:"TUNEREQ",248:"TT",250:"START",251:"CONTINUE",252:"STOP",254:"SENS",255:"RESET"},r.commands_reversed={};for(var s in r.commands)r.commands_reversed[r.commands[s]]=s;function o(A,l){if(!navigator.requestMIDIAccess){this.error="not suppoorted",l?l("Not supported"):console.error("MIDI NOT SUPPORTED, enable by chrome://flags");return}this.on_ready=A,this.state={note:[],cc:[]},this.input_ports=null,this.input_ports_info=[],this.output_ports=null,this.output_ports_info=[],navigator.requestMIDIAccess().then(this.onMIDISuccess.bind(this),this.onMIDIFailure.bind(this))}o.input=null,o.MIDIEvent=r,o.prototype.onMIDISuccess=function(A){console.log("MIDI ready!"),console.log(A),this.midi=A,this.updatePorts(),this.on_ready&&this.on_ready(this)},o.prototype.updatePorts=function(){var A=this.midi;this.input_ports=A.inputs,this.input_ports_info=[],this.output_ports=A.outputs,this.output_ports_info=[];for(var l=0,T=this.input_ports.values(),L=T.next();L&&L.done===!1;){var I=L.value;this.input_ports_info.push(I),console.log("Input port [type:'"+I.type+"'] id:'"+I.id+"' manufacturer:'"+I.manufacturer+"' name:'"+I.name+"' version:'"+I.version+"'"),l++,L=T.next()}this.num_input_ports=l,l=0;for(var T=this.output_ports.values(),L=T.next();L&&L.done===!1;){var I=L.value;this.output_ports_info.push(I),console.log("Output port [type:'"+I.type+"'] id:'"+I.id+"' manufacturer:'"+I.manufacturer+"' name:'"+I.name+"' version:'"+I.version+"'"),l++,L=T.next()}this.num_output_ports=l},o.prototype.onMIDIFailure=function(A){console.error("Failed to get MIDI access - "+A)},o.prototype.openInputPort=function(A,l){var I=this.input_ports.get("input-"+A);if(!I)return!1;o.input=this;var T=this;return I.onmidimessage=function(L){var C=new r(L.data);T.updateState(C),l&&l(L.data,C),o.on_message&&o.on_message(L.data,C)},console.log("port open: ",I),!0},o.parseMsg=function(A){},o.prototype.updateState=function(A){switch(A.cmd){case r.NOTEON:this.state.note[A.value1|0]=A.value2;break;case r.NOTEOFF:this.state.note[A.value1|0]=0;break;case r.CONTROLLERCHANGE:this.state.cc[A.getCC()]=A.getCCValue();break}},o.prototype.sendMIDI=function(A,l){if(l){var I=this.output_ports_info[A];I&&(o.output=this,l.constructor===r?I.send(l.data):I.send(l))}};function h(){this.addOutput("on_midi",t.EVENT),this.addOutput("out","midi"),this.properties={port:0},this._last_midi_event=null,this._current_midi_event=null,this.boxcolor="#AAA",this._last_time=0;var A=this;new o(function(l){A._midi=l,A._waiting&&A.onStart(),A._waiting=!1})}h.MIDIInterface=o,h.title="MIDI Input",h.desc="Reads MIDI from a input port",h.color=n,h.prototype.getPropertyInfo=function(A){if(this._midi&&A=="port"){for(var l={},I=0;I<this._midi.input_ports_info.length;++I){var T=this._midi.input_ports_info[I];l[I]=I+".- "+T.name+" version:"+T.version}return{type:"enum",values:l}}},h.prototype.onStart=function(){this._midi?this._midi.openInputPort(this.properties.port,this.onMIDIEvent.bind(this)):this._waiting=!0},h.prototype.onMIDIEvent=function(A,l){this._last_midi_event=l,this.boxcolor="#AFA",this._last_time=t.getTime(),this.trigger("on_midi",l),l.cmd==r.NOTEON?this.trigger("on_noteon",l):l.cmd==r.NOTEOFF?this.trigger("on_noteoff",l):l.cmd==r.CONTROLLERCHANGE?this.trigger("on_cc",l):l.cmd==r.PROGRAMCHANGE?this.trigger("on_pc",l):l.cmd==r.PITCHBEND&&this.trigger("on_pitchbend",l)},h.prototype.onDrawBackground=function(A){if(this.boxcolor="#AAA",!this.flags.collapsed&&this._last_midi_event){A.fillStyle="white";var l=t.getTime(),I=1-Math.max(0,(l-this._last_time)*.001);if(I>0){var T=A.globalAlpha;A.globalAlpha*=I,A.font="12px Tahoma",A.fillText(this._last_midi_event.toString(),2,this.size[1]*.5+3),A.globalAlpha=T}}},h.prototype.onExecute=function(){if(this.outputs)for(var A=this._last_midi_event,l=0;l<this.outputs.length;++l){var I=this.outputs[l],T=null;switch(I.name){case"midi":T=this._midi;break;case"last_midi":T=A;break;default:continue}this.setOutputData(l,T)}},h.prototype.onGetOutputs=function(){return[["last_midi","midi"],["on_midi",t.EVENT],["on_noteon",t.EVENT],["on_noteoff",t.EVENT],["on_cc",t.EVENT],["on_pc",t.EVENT],["on_pitchbend",t.EVENT]]},t.registerNodeType("midi/input",h);function u(){this.addInput("send",t.EVENT),this.properties={port:0};var A=this;new o(function(l){A._midi=l,A.widget.options.values=A.getMIDIOutputs()}),this.widget=this.addWidget("combo","Device",this.properties.port,{property:"port",values:this.getMIDIOutputs.bind(this)}),this.size=[340,60]}u.MIDIInterface=o,u.title="MIDI Output",u.desc="Sends MIDI to output channel",u.color=n,u.prototype.onGetPropertyInfo=function(A){if(this._midi&&A=="port"){var l=this.getMIDIOutputs();return{type:"enum",values:l}}},u.default_ports={0:"unknown"},u.prototype.getMIDIOutputs=function(){var A={};if(!this._midi)return u.default_ports;if(this._midi.output_ports_info)for(var l=0;l<this._midi.output_ports_info.length;++l){var I=this._midi.output_ports_info[l];if(I){var T=l+".- "+I.name+" version:"+I.version;A[l]=T}}return A},u.prototype.onAction=function(A,l){this._midi&&(A=="send"&&this._midi.sendMIDI(this.properties.port,l),this.trigger("midi",l))},u.prototype.onGetInputs=function(){return[["send",t.ACTION]]},u.prototype.onGetOutputs=function(){return[["on_midi",t.EVENT]]},t.registerNodeType("midi/output",u);function f(){this.addInput("on_midi",t.EVENT),this._str="",this.size=[200,40]}f.title="MIDI Show",f.desc="Shows MIDI in the graph",f.color=n,f.prototype.getTitle=function(){return this.flags.collapsed?this._str:this.title},f.prototype.onAction=function(A,l){l&&(l.constructor===r?this._str=l.toString():this._str="???")},f.prototype.onDrawForeground=function(A){!this._str||this.flags.collapsed||(A.font="30px Arial",A.fillText(this._str,10,this.size[1]*.8))},f.prototype.onGetInputs=function(){return[["in",t.ACTION]]},f.prototype.onGetOutputs=function(){return[["on_midi",t.EVENT]]},t.registerNodeType("midi/show",f);function c(){this.properties={channel:-1,cmd:-1,min_value:-1,max_value:-1};var A=this;this._learning=!1,this.addWidget("button","Learn","",function(){A._learning=!0,A.boxcolor="#FA3"}),this.addInput("in",t.EVENT),this.addOutput("on_midi",t.EVENT),this.boxcolor="#AAA"}c.title="MIDI Filter",c.desc="Filters MIDI messages",c.color=n,c["@cmd"]={type:"enum",title:"Command",values:r.commands_reversed},c.prototype.getTitle=function(){var A=null;return this.properties.cmd==-1?A="Nothing":A=r.commands_short[this.properties.cmd]||"Unknown",this.properties.min_value!=-1&&this.properties.max_value!=-1&&(A+=" "+(this.properties.min_value==this.properties.max_value?this.properties.max_value:this.properties.min_value+".."+this.properties.max_value)),"Filter: "+A},c.prototype.onPropertyChanged=function(A,l){if(A=="cmd"){var I=Number(l);isNaN(I)&&(I=r.commands[l]||0),this.properties.cmd=I}},c.prototype.onAction=function(A,l){if(!(!l||l.constructor!==r)){if(this._learning)this._learning=!1,this.boxcolor="#AAA",this.properties.channel=l.channel,this.properties.cmd=l.cmd,this.properties.min_value=this.properties.max_value=l.data[1];else if(this.properties.channel!=-1&&l.channel!=this.properties.channel||this.properties.cmd!=-1&&l.cmd!=this.properties.cmd||this.properties.min_value!=-1&&l.data[1]<this.properties.min_value||this.properties.max_value!=-1&&l.data[1]>this.properties.max_value)return;this.trigger("on_midi",l)}},t.registerNodeType("midi/filter",c);function _(){this.properties={channel:0,cmd:144,value1:1,value2:1},this.addInput("send",t.EVENT),this.addInput("assign",t.EVENT),this.addOutput("on_midi",t.EVENT),this.midi_event=new r,this.gate=!1}_.title="MIDIEvent",_.desc="Create a MIDI Event",_.color=n,_.prototype.onAction=function(A,I){if(A=="assign"){this.properties.channel=I.channel,this.properties.cmd=I.cmd,this.properties.value1=I.data[1],this.properties.value2=I.data[2],I.cmd==r.NOTEON?this.gate=!0:I.cmd==r.NOTEOFF&&(this.gate=!1);return}var I=this.midi_event;I.channel=this.properties.channel,this.properties.cmd&&this.properties.cmd.constructor===String?I.setCommandFromString(this.properties.cmd):I.cmd=this.properties.cmd,I.data[0]=I.cmd|I.channel,I.data[1]=Number(this.properties.value1),I.data[2]=Number(this.properties.value2),this.trigger("on_midi",I)},_.prototype.onExecute=function(){var A=this.properties;if(this.inputs)for(var l=0;l<this.inputs.length;++l){var I=this.inputs[l];if(I.link!=-1)switch(I.name){case"note":var T=this.getInputData(l);T!=null&&(T.constructor===String&&(T=r.NoteStringToPitch(T)),this.properties.value1=(T|0)%255);break;case"cmd":var T=this.getInputData(l);T!=null&&(this.properties.cmd=T);break;case"value1":var T=this.getInputData(l);T!=null&&(this.properties.value1=clamp(T|0,0,127));break;case"value2":var T=this.getInputData(l);T!=null&&(this.properties.value2=clamp(T|0,0,127));break}}if(this.outputs)for(var l=0;l<this.outputs.length;++l){var L=this.outputs[l],T=null;switch(L.name){case"midi":T=new r,T.setup([A.cmd,A.value1,A.value2]),T.channel=A.channel;break;case"command":T=A.cmd;break;case"cc":T=A.value1;break;case"cc_value":T=A.value2;break;case"note":T=A.cmd==r.NOTEON||A.cmd==r.NOTEOFF?A.value1:null;break;case"velocity":T=A.cmd==r.NOTEON?A.value2:null;break;case"pitch":T=A.cmd==r.NOTEON?r.computePitch(A.value1):null;break;case"pitchbend":T=A.cmd==r.PITCHBEND?r.computePitchBend(A.value1,A.value2):null;break;case"gate":T=this.gate;break;default:continue}T!==null&&this.setOutputData(l,T)}},_.prototype.onPropertyChanged=function(A,l){A=="cmd"&&(this.properties.cmd=r.computeCommandFromString(l))},_.prototype.onGetInputs=function(){return[["cmd","number"],["note","number"],["value1","number"],["value2","number"]]},_.prototype.onGetOutputs=function(){return[["midi","midi"],["on_midi",t.EVENT],["command","number"],["note","number"],["velocity","number"],["cc","number"],["cc_value","number"],["pitch","number"],["gate","bool"],["pitchbend","number"]]},t.registerNodeType("midi/event",_);function O(){this.properties={cc:1,value:0},this.addOutput("value","number")}O.title="MIDICC",O.desc="gets a Controller Change",O.color=n,O.prototype.onExecute=function(){this.properties,o.input&&(this.properties.value=o.input.state.cc[this.properties.cc]),this.setOutputData(0,this.properties.value)},t.registerNodeType("midi/cc",O);function d(){this.addInput("generate",t.ACTION),this.addInput("scale","string"),this.addInput("octave","number"),this.addOutput("note",t.EVENT),this.properties={notes:"A,A#,B,C,C#,D,D#,E,F,F#,G,G#",octave:2,duration:.5,mode:"sequence"},this.notes_pitches=d.processScale(this.properties.notes),this.sequence_index=0}d.title="MIDI Generator",d.desc="Generates a random MIDI note",d.color=n,d.processScale=function(A){for(var l=A.split(","),I=0;I<l.length;++I){var T=l[I];T.length==2&&T[1]!="#"||T.length>2?l[I]=-t.MIDIEvent.NoteStringToPitch(T):l[I]=r.note_to_index[T]||0}return l},d.prototype.onPropertyChanged=function(A,l){A=="notes"&&(this.notes_pitches=d.processScale(l))},d.prototype.onExecute=function(){var A=this.getInputData(2);A!=null&&(this.properties.octave=A);var l=this.getInputData(1);l&&(this.notes_pitches=d.processScale(l))},d.prototype.onAction=function(A,N){var I=0,T=this.notes_pitches.length,L=0;this.properties.mode=="sequence"?L=this.sequence_index=(this.sequence_index+1)%T:this.properties.mode=="random"&&(L=Math.floor(Math.random()*T));var C=this.notes_pitches[L];C>=0?I=C+(this.properties.octave-1)*12+33:I=-C;var N=new r;N.setup([r.NOTEON,I,10]);var R=this.properties.duration||1;this.trigger("note",N),setTimeout((function(){var Y=new r;Y.setup([r.NOTEOFF,I,0]),this.trigger("note",Y)}).bind(this),R*1e3)},t.registerNodeType("midi/generator",d);function b(){this.properties={amount:0},this.addInput("in",t.ACTION),this.addInput("amount","number"),this.addOutput("out",t.EVENT),this.midi_event=new r}b.title="MIDI Transpose",b.desc="Transpose a MIDI note",b.color=n,b.prototype.onAction=function(A,l){!l||l.constructor!==r||(l.data[0]==r.NOTEON||l.data[0]==r.NOTEOFF?(this.midi_event=new r,this.midi_event.setup(l.data),this.midi_event.data[1]=Math.round(this.midi_event.data[1]+this.properties.amount),this.trigger("out",this.midi_event)):this.trigger("out",l))},b.prototype.onExecute=function(){var A=this.getInputData(1);A!=null&&(this.properties.amount=A)},t.registerNodeType("midi/transpose",b);function S(){this.properties={scale:"A,A#,B,C,C#,D,D#,E,F,F#,G,G#"},this.addInput("note",t.ACTION),this.addInput("scale","string"),this.addOutput("out",t.EVENT),this.valid_notes=new Array(12),this.offset_notes=new Array(12),this.processScale(this.properties.scale)}S.title="MIDI Quantize Pitch",S.desc="Transpose a MIDI note tp fit an scale",S.color=n,S.prototype.onPropertyChanged=function(A,l){A=="scale"&&this.processScale(l)},S.prototype.processScale=function(A){this._current_scale=A,this.notes_pitches=d.processScale(A);for(var l=0;l<12;++l)this.valid_notes[l]=this.notes_pitches.indexOf(l)!=-1;for(var l=0;l<12;++l){if(this.valid_notes[l]){this.offset_notes[l]=0;continue}for(var I=1;I<12;++I){if(this.valid_notes[(l-I)%12]){this.offset_notes[l]=-I;break}if(this.valid_notes[(l+I)%12]){this.offset_notes[l]=I;break}}}},S.prototype.onAction=function(A,l){if(!(!l||l.constructor!==r))if(l.data[0]==r.NOTEON||l.data[0]==r.NOTEOFF){this.midi_event=new r,this.midi_event.setup(l.data);var I=l.note,T=r.note_to_index[I],L=this.offset_notes[T];this.midi_event.data[1]+=L,this.trigger("out",this.midi_event)}else this.trigger("out",l)},S.prototype.onExecute=function(){var A=this.getInputData(1);A!=null&&A!=this._current_scale&&this.processScale(A)},t.registerNodeType("midi/quantize",S);function G(){this.properties={url:"",autoplay:!0},this.addInput("play",t.ACTION),this.addInput("pause",t.ACTION),this.addOutput("note",t.EVENT),this._midi=null,this._current_time=0,this._playing=!1,typeof MidiParser>"u"&&(console.error("midi-parser.js not included, LGMidiPlay requires that library: https://raw.githubusercontent.com/colxi/midi-parser-js/master/src/main.js"),this.boxcolor="red")}G.title="MIDI fromFile",G.desc="Plays a MIDI file",G.color=n,G.prototype.onAction=function(A){A=="play"?this.play():A=="pause"&&(this._playing=!this._playing)},G.prototype.onPropertyChanged=function(A,l){A=="url"&&this.loadMIDIFile(l)},G.prototype.onExecute=function(){if(this._midi&&this._playing){this._current_time+=this.graph.elapsed_time;for(var A=this._current_time*100,l=0;l<this._midi.tracks;++l){var I=this._midi.track[l];I._last_pos||(I._last_pos=0,I._time=0);var T=I.event[I._last_pos];if(T&&I._time+T.deltaTime<=A&&(I._last_pos++,I._time+=T.deltaTime,T.data)){var L=T.type<<4+T.channel,C=new r;C.setup([L,T.data[0],T.data[1]]),this.trigger("note",C)}}}},G.prototype.play=function(){if(this._playing=!0,this._current_time=0,!!this._midi)for(var A=0;A<this._midi.tracks;++A){var l=this._midi.track[A];l._last_pos=0,l._time=0}},G.prototype.loadMIDIFile=function(A){var l=this;t.fetchFile(A,"arraybuffer",function(I){l.boxcolor="#AFA",l._midi=MidiParser.parse(new Uint8Array(I)),l.properties.autoplay&&l.play()},function(I){l.boxcolor="#FAA",l._midi=null})},G.prototype.onDropFile=function(A){this.properties.url="",this.loadMIDIFile(A)},t.registerNodeType("midi/fromFile",G);function z(){if(this.properties={volume:.5,duration:1},this.addInput("note",t.ACTION),this.addInput("volume","number"),this.addInput("duration","number"),this.addOutput("note",t.EVENT),typeof AudioSynth>"u")console.error("Audiosynth.js not included, LGMidiPlay requires that library"),this.boxcolor="red";else{var A=this.synth=new AudioSynth;this.instrument=A.createInstrument("piano")}}z.title="MIDI Play",z.desc="Plays a MIDI note",z.color=n,z.prototype.onAction=function(A,l){if(!(!l||l.constructor!==r)){if(this.instrument&&l.data[0]==r.NOTEON){var I=l.note;if(!I||I=="undefined"||I.constructor!==String)return;this.instrument.play(I,l.octave,this.properties.duration,this.properties.volume)}this.trigger("note",l)}},z.prototype.onExecute=function(){var A=this.getInputData(1);A!=null&&(this.properties.volume=A);var l=this.getInputData(2);l!=null&&(this.properties.duration=l)},t.registerNodeType("midi/play",z);function $(){this.properties={num_octaves:2,start_octave:2},this.addInput("note",t.ACTION),this.addInput("reset",t.ACTION),this.addOutput("note",t.EVENT),this.size=[400,100],this.keys=[],this._last_key=-1}$.title="MIDI Keys",$.desc="Keyboard to play notes",$.color=n,$.keys=[{x:0,w:1,h:1,t:0},{x:.75,w:.5,h:.6,t:1},{x:1,w:1,h:1,t:0},{x:1.75,w:.5,h:.6,t:1},{x:2,w:1,h:1,t:0},{x:2.75,w:.5,h:.6,t:1},{x:3,w:1,h:1,t:0},{x:4,w:1,h:1,t:0},{x:4.75,w:.5,h:.6,t:1},{x:5,w:1,h:1,t:0},{x:5.75,w:.5,h:.6,t:1},{x:6,w:1,h:1,t:0}],$.prototype.onDrawForeground=function(A){if(!this.flags.collapsed){var l=this.properties.num_octaves*12;this.keys.length=l;var I=this.size[0]/(this.properties.num_octaves*7),T=this.size[1];A.globalAlpha=1;for(var L=0;L<2;L++)for(var C=0;C<l;++C){var N=$.keys[C%12];if(N.t==L){var R=Math.floor(C/12),Y=R*7*I+N.x*I;L==0?A.fillStyle=this.keys[C]?"#CCC":"white":A.fillStyle=this.keys[C]?"#333":"black",A.fillRect(Y+1,0,I*N.w-2,T*N.h)}}}},$.prototype.getKeyIndex=function(A){this.properties.num_octaves*12;for(var l=this.size[0]/(this.properties.num_octaves*7),I=this.size[1],T=1;T>=0;T--)for(var L=0;L<this.keys.length;++L){var C=$.keys[L%12];if(C.t==T){var N=Math.floor(L/12),R=N*7*l+C.x*l,Y=l*C.w,ut=I*C.h;if(!(A[0]<R||A[0]>R+Y||A[1]>ut))return L}}return-1},$.prototype.onAction=function(A,l){if(A=="reset"){for(var I=0;I<this.keys.length;++I)this.keys[I]=!1;return}if(!(!l||l.constructor!==r)){var T=l,L=(this.properties.start_octave-1)*12+29,C=T.data[1]-L;C>=0&&C<this.keys.length&&(T.data[0]==r.NOTEON?this.keys[C]=!0:T.data[0]==r.NOTEOFF&&(this.keys[C]=!1)),this.trigger("note",T)}},$.prototype.onMouseDown=function(A,l){if(!(l[1]<0)){var I=this.getKeyIndex(l);this.keys[I]=!0,this._last_key=I;var T=(this.properties.start_octave-1)*12+29+I,L=new r;return L.setup([r.NOTEON,T,100]),this.trigger("note",L),!0}},$.prototype.onMouseMove=function(A,l){if(!(l[1]<0||this._last_key==-1)){this.setDirtyCanvas(!0);var I=this.getKeyIndex(l);if(this._last_key==I)return!0;this.keys[this._last_key]=!1;var T=(this.properties.start_octave-1)*12+29+this._last_key,L=new r;L.setup([r.NOTEOFF,T,100]),this.trigger("note",L),this.keys[I]=!0;var T=(this.properties.start_octave-1)*12+29+I,L=new r;return L.setup([r.NOTEON,T,100]),this.trigger("note",L),this._last_key=I,!0}},$.prototype.onMouseUp=function(A,l){if(!(l[1]<0)){var I=this.getKeyIndex(l);this.keys[I]=!1,this._last_key=-1;var T=(this.properties.start_octave-1)*12+29+I,L=new r;return L.setup([r.NOTEOFF,T,100]),this.trigger("note",L),!0}},t.registerNodeType("midi/keys",$)}(commonjsGlobal),function(e){var t=e.LiteGraph,n={};e.LGAudio=n,n.getAudioContext=function(){if(!this._audio_context){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,!window.AudioContext)return console.error("AudioContext not supported by browser"),null;this._audio_context=new AudioContext,this._audio_context.onmessage=function(l){console.log("msg",l)},this._audio_context.onended=function(l){console.log("ended",l)},this._audio_context.oncomplete=function(l){console.log("complete",l)}}return this._audio_context},n.connect=function(l,I){try{l.connect(I)}catch(T){console.warn("LGraphAudio:",T)}},n.disconnect=function(l,I){try{l.disconnect(I)}catch(T){console.warn("LGraphAudio:",T)}},n.changeAllAudiosConnections=function(l,I){if(l.inputs)for(var T=0;T<l.inputs.length;++T){var L=l.inputs[T],C=l.graph.links[L.link];if(C){var N=l.graph.getNodeById(C.origin_id),R=null;N.getAudioNodeInOutputSlot?R=N.getAudioNodeInOutputSlot(C.origin_slot):R=N.audionode;var Y=null;l.getAudioNodeInInputSlot?Y=l.getAudioNodeInInputSlot(T):Y=l.audionode,I?n.connect(R,Y):n.disconnect(R,Y)}}if(l.outputs)for(var T=0;T<l.outputs.length;++T)for(var ut=l.outputs[T],mt=0;mt<ut.links.length;++mt){var C=l.graph.links[ut.links[mt]];if(C){var R=null;l.getAudioNodeInOutputSlot?R=l.getAudioNodeInOutputSlot(T):R=l.audionode;var yt=l.graph.getNodeById(C.target_id),Y=null;yt.getAudioNodeInInputSlot?Y=yt.getAudioNodeInInputSlot(C.target_slot):Y=yt.audionode,I?n.connect(R,Y):n.disconnect(R,Y)}}},n.onConnectionsChange=function(l,I,T,L){if(l==t.OUTPUT){var C=null;if(L&&(C=this.graph.getNodeById(L.target_id)),!!C){var N=null;this.getAudioNodeInOutputSlot?N=this.getAudioNodeInOutputSlot(I):N=this.audionode;var R=null;C.getAudioNodeInInputSlot?R=C.getAudioNodeInInputSlot(L.target_slot):R=C.audionode,T?n.connect(N,R):n.disconnect(N,R)}}},n.createAudioNodeWrapper=function(l){var I=l.prototype.onPropertyChanged;l.prototype.onPropertyChanged=function(T,L){I&&I.call(this,T,L),this.audionode&&this.audionode[T]!==void 0&&(this.audionode[T].value!==void 0?this.audionode[T].value=L:this.audionode[T]=L)},l.prototype.onConnectionsChange=n.onConnectionsChange},n.cached_audios={},n.loadSound=function(l,I,T){if(n.cached_audios[l]&&l.indexOf("blob:")==-1){I&&I(n.cached_audios[l]);return}n.onProcessAudioURL&&(l=n.onProcessAudioURL(l));var L=new XMLHttpRequest;L.open("GET",l,!0),L.responseType="arraybuffer";var C=n.getAudioContext();L.onload=function(){console.log("AudioSource loaded"),C.decodeAudioData(L.response,function(R){console.log("AudioSource decoded"),n.cached_audios[l]=R,I&&I(R)},N)},L.send();function N(R){console.log("Audio loading sample error:",R),T&&T(R)}return L};function r(){this.properties={src:"",gain:.5,loop:!0,autoplay:!0,playbackRate:1},this._loading_audio=!1,this._audiobuffer=null,this._audionodes=[],this._last_sourcenode=null,this.addOutput("out","audio"),this.addInput("gain","number");var l=n.getAudioContext();this.audionode=l.createGain(),this.audionode.graphnode=this,this.audionode.gain.value=this.properties.gain,this.properties.src&&this.loadSound(this.properties.src)}r.desc="Plays an audio file",r["@src"]={widget:"resource"},r.supported_extensions=["wav","ogg","mp3"],r.prototype.onAdded=function(l){l.status===LGraph.STATUS_RUNNING&&this.onStart()},r.prototype.onStart=function(){this._audiobuffer&&this.properties.autoplay&&this.playBuffer(this._audiobuffer)},r.prototype.onStop=function(){this.stopAllSounds()},r.prototype.onPause=function(){this.pauseAllSounds()},r.prototype.onUnpause=function(){this.unpauseAllSounds()},r.prototype.onRemoved=function(){this.stopAllSounds(),this._dropped_url&&URL.revokeObjectURL(this._url)},r.prototype.stopAllSounds=function(){for(var l=0;l<this._audionodes.length;++l)this._audionodes[l].started&&(this._audionodes[l].started=!1,this._audionodes[l].stop());this._audionodes.length=0},r.prototype.pauseAllSounds=function(){n.getAudioContext().suspend()},r.prototype.unpauseAllSounds=function(){n.getAudioContext().resume()},r.prototype.onExecute=function(){if(this.inputs)for(var l=0;l<this.inputs.length;++l){var I=this.inputs[l];if(I.link!=null){var T=this.getInputData(l);if(T!==void 0){if(I.name=="gain")this.audionode.gain.value=T;else if(I.name=="src")this.setProperty("src",T);else if(I.name=="playbackRate"){this.properties.playbackRate=T;for(var L=0;L<this._audionodes.length;++L)this._audionodes[L].playbackRate.value=T}}}}if(this.outputs)for(var l=0;l<this.outputs.length;++l){var C=this.outputs[l];C.name=="buffer"&&this._audiobuffer&&this.setOutputData(l,this._audiobuffer)}},r.prototype.onAction=function(l){this._audiobuffer&&(l=="Play"?this.playBuffer(this._audiobuffer):l=="Stop"&&this.stopAllSounds())},r.prototype.onPropertyChanged=function(l,I){if(l=="src")this.loadSound(I);else if(l=="gain")this.audionode.gain.value=I;else if(l=="playbackRate")for(var T=0;T<this._audionodes.length;++T)this._audionodes[T].playbackRate.value=I},r.prototype.playBuffer=function(l){var I=this,T=n.getAudioContext(),L=T.createBufferSource();return this._last_sourcenode=L,L.graphnode=this,L.buffer=l,L.loop=this.properties.loop,L.playbackRate.value=this.properties.playbackRate,this._audionodes.push(L),L.connect(this.audionode),this._audionodes.push(L),this.trigger("start"),L.onended=function(){I.trigger("ended");var C=I._audionodes.indexOf(L);C!=-1&&I._audionodes.splice(C,1)},L.started||(L.started=!0,L.start()),L},r.prototype.loadSound=function(l){var I=this;if(this._request&&(this._request.abort(),this._request=null),this._audiobuffer=null,this._loading_audio=!1,!l)return;this._request=n.loadSound(l,T),this._loading_audio=!0,this.boxcolor="#AA4";function T(L){this.boxcolor=t.NODE_DEFAULT_BOXCOLOR,I._audiobuffer=L,I._loading_audio=!1,I.graph&&I.graph.status===LGraph.STATUS_RUNNING&&I.onStart()}},r.prototype.onConnectionsChange=n.onConnectionsChange,r.prototype.onGetInputs=function(){return[["playbackRate","number"],["src","string"],["Play",t.ACTION],["Stop",t.ACTION]]},r.prototype.onGetOutputs=function(){return[["buffer","audiobuffer"],["start",t.EVENT],["ended",t.EVENT]]},r.prototype.onDropFile=function(l){this._dropped_url&&URL.revokeObjectURL(this._dropped_url);var I=URL.createObjectURL(l);this.properties.src=I,this.loadSound(I),this._dropped_url=I},r.title="Source",r.desc="Plays audio",t.registerNodeType("audio/source",r);function s(){this.properties={gain:.5},this._audionodes=[],this._media_stream=null,this.addOutput("out","audio"),this.addInput("gain","number");var l=n.getAudioContext();this.audionode=l.createGain(),this.audionode.graphnode=this,this.audionode.gain.value=this.properties.gain}s.prototype.onAdded=function(l){l.status===LGraph.STATUS_RUNNING&&this.onStart()},s.prototype.onStart=function(){this._media_stream==null&&!this._waiting_confirmation&&this.openStream()},s.prototype.onStop=function(){this.audionode.gain.value=0},s.prototype.onPause=function(){this.audionode.gain.value=0},s.prototype.onUnpause=function(){this.audionode.gain.value=this.properties.gain},s.prototype.onRemoved=function(){if(this.audionode.gain.value=0,this.audiosource_node&&(this.audiosource_node.disconnect(this.audionode),this.audiosource_node=null),this._media_stream){var l=this._media_stream.getTracks();l.length&&l[0].stop()}},s.prototype.openStream=function(){if(!navigator.mediaDevices){console.log("getUserMedia() is not supported in your browser, use chrome and enable WebRTC from about://flags");return}this._waiting_confirmation=!0,navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(this.streamReady.bind(this)).catch(I);var l=this;function I(T){console.log("Media rejected",T),l._media_stream=!1,l.boxcolor="red"}},s.prototype.streamReady=function(l){this._media_stream=l,this.audiosource_node&&this.audiosource_node.disconnect(this.audionode);var I=n.getAudioContext();this.audiosource_node=I.createMediaStreamSource(l),this.audiosource_node.graphnode=this,this.audiosource_node.connect(this.audionode),this.boxcolor="white"},s.prototype.onExecute=function(){if(this._media_stream==null&&!this._waiting_confirmation&&this.openStream(),this.inputs)for(var l=0;l<this.inputs.length;++l){var I=this.inputs[l];if(I.link!=null){var T=this.getInputData(l);T!==void 0&&I.name=="gain"&&(this.audionode.gain.value=this.properties.gain=T)}}},s.prototype.onAction=function(l){l=="Play"?this.audionode.gain.value=this.properties.gain:l=="Stop"&&(this.audionode.gain.value=0)},s.prototype.onPropertyChanged=function(l,I){l=="gain"&&(this.audionode.gain.value=I)},s.prototype.onConnectionsChange=n.onConnectionsChange,s.prototype.onGetInputs=function(){return[["playbackRate","number"],["Play",t.ACTION],["Stop",t.ACTION]]},s.title="MediaSource",s.desc="Plays microphone",t.registerNodeType("audio/media_source",s);function o(){this.properties={fftSize:2048,minDecibels:-100,maxDecibels:-10,smoothingTimeConstant:.5};var l=n.getAudioContext();this.audionode=l.createAnalyser(),this.audionode.graphnode=this,this.audionode.fftSize=this.properties.fftSize,this.audionode.minDecibels=this.properties.minDecibels,this.audionode.maxDecibels=this.properties.maxDecibels,this.audionode.smoothingTimeConstant=this.properties.smoothingTimeConstant,this.addInput("in","audio"),this.addOutput("freqs","array"),this.addOutput("samples","array"),this._freq_bin=null,this._time_bin=null}o.prototype.onPropertyChanged=function(l,I){this.audionode[l]=I},o.prototype.onExecute=function(){if(this.isOutputConnected(0)){var l=this.audionode.frequencyBinCount;(!this._freq_bin||this._freq_bin.length!=l)&&(this._freq_bin=new Uint8Array(l)),this.audionode.getByteFrequencyData(this._freq_bin),this.setOutputData(0,this._freq_bin)}if(this.isOutputConnected(1)){var l=this.audionode.frequencyBinCount;(!this._time_bin||this._time_bin.length!=l)&&(this._time_bin=new Uint8Array(l)),this.audionode.getByteTimeDomainData(this._time_bin),this.setOutputData(1,this._time_bin)}for(var I=1;I<this.inputs.length;++I){var T=this.inputs[I];if(T.link!=null){var L=this.getInputData(I);L!==void 0&&(this.audionode[T.name].value=L)}}},o.prototype.onGetInputs=function(){return[["minDecibels","number"],["maxDecibels","number"],["smoothingTimeConstant","number"]]},o.prototype.onGetOutputs=function(){return[["freqs","array"],["samples","array"]]},o.title="Analyser",o.desc="Audio Analyser",t.registerNodeType("audio/analyser",o);function h(){this.properties={gain:1},this.audionode=n.getAudioContext().createGain(),this.addInput("in","audio"),this.addInput("gain","number"),this.addOutput("out","audio")}h.prototype.onExecute=function(){if(!(!this.inputs||!this.inputs.length))for(var l=1;l<this.inputs.length;++l){var I=this.inputs[l],T=this.getInputData(l);T!==void 0&&(this.audionode[I.name].value=T)}},n.createAudioNodeWrapper(h),h.title="Gain",h.desc="Audio gain",t.registerNodeType("audio/gain",h);function u(){this.properties={impulse_src:"",normalize:!0},this.audionode=n.getAudioContext().createConvolver(),this.addInput("in","audio"),this.addOutput("out","audio")}n.createAudioNodeWrapper(u),u.prototype.onRemove=function(){this._dropped_url&&URL.revokeObjectURL(this._dropped_url)},u.prototype.onPropertyChanged=function(l,I){l=="impulse_src"?this.loadImpulse(I):l=="normalize"&&(this.audionode.normalize=I)},u.prototype.onDropFile=function(l){this._dropped_url&&URL.revokeObjectURL(this._dropped_url),this._dropped_url=URL.createObjectURL(l),this.properties.impulse_src=this._dropped_url,this.loadImpulse(this._dropped_url)},u.prototype.loadImpulse=function(l){var I=this;if(this._request&&(this._request.abort(),this._request=null),this._impulse_buffer=null,this._loading_impulse=!1,!l)return;this._request=n.loadSound(l,T),this._loading_impulse=!0;function T(L){I._impulse_buffer=L,I.audionode.buffer=L,console.log("Impulse signal set"),I._loading_impulse=!1}},u.title="Convolver",u.desc="Convolves the signal (used for reverb)",t.registerNodeType("audio/convolver",u);function f(){this.properties={threshold:-50,knee:40,ratio:12,reduction:-20,attack:0,release:.25},this.audionode=n.getAudioContext().createDynamicsCompressor(),this.addInput("in","audio"),this.addOutput("out","audio")}n.createAudioNodeWrapper(f),f.prototype.onExecute=function(){if(!(!this.inputs||!this.inputs.length))for(var l=1;l<this.inputs.length;++l){var I=this.inputs[l];if(I.link!=null){var T=this.getInputData(l);T!==void 0&&(this.audionode[I.name].value=T)}}},f.prototype.onGetInputs=function(){return[["threshold","number"],["knee","number"],["ratio","number"],["reduction","number"],["attack","number"],["release","number"]]},f.title="DynamicsCompressor",f.desc="Dynamics Compressor",t.registerNodeType("audio/dynamicsCompressor",f);function c(){this.properties={},this.audionode=n.getAudioContext().createWaveShaper(),this.addInput("in","audio"),this.addInput("shape","waveshape"),this.addOutput("out","audio")}c.prototype.onExecute=function(){if(!(!this.inputs||!this.inputs.length)){var l=this.getInputData(1);l!==void 0&&(this.audionode.curve=l)}},c.prototype.setWaveShape=function(l){this.audionode.curve=l},n.createAudioNodeWrapper(c);function _(){this.properties={gain1:.5,gain2:.5},this.audionode=n.getAudioContext().createGain(),this.audionode1=n.getAudioContext().createGain(),this.audionode1.gain.value=this.properties.gain1,this.audionode2=n.getAudioContext().createGain(),this.audionode2.gain.value=this.properties.gain2,this.audionode1.connect(this.audionode),this.audionode2.connect(this.audionode),this.addInput("in1","audio"),this.addInput("in1 gain","number"),this.addInput("in2","audio"),this.addInput("in2 gain","number"),this.addOutput("out","audio")}_.prototype.getAudioNodeInInputSlot=function(l){if(l==0)return this.audionode1;if(l==2)return this.audionode2},_.prototype.onPropertyChanged=function(l,I){l=="gain1"?this.audionode1.gain.value=I:l=="gain2"&&(this.audionode2.gain.value=I)},_.prototype.onExecute=function(){if(!(!this.inputs||!this.inputs.length))for(var l=1;l<this.inputs.length;++l){var I=this.inputs[l];if(!(I.link==null||I.type=="audio")){var T=this.getInputData(l);T!==void 0&&(l==1?this.audionode1.gain.value=T:l==3&&(this.audionode2.gain.value=T))}}},n.createAudioNodeWrapper(_),_.title="Mixer",_.desc="Audio mixer",t.registerNodeType("audio/mixer",_);function O(){this.properties={A:.1,D:.1,S:.1,R:.1},this.audionode=n.getAudioContext().createGain(),this.audionode.gain.value=0,this.addInput("in","audio"),this.addInput("gate","boolean"),this.addOutput("out","audio"),this.gate=!1}O.prototype.onExecute=function(){var l=n.getAudioContext(),I=l.currentTime,T=this.audionode,L=T.gain,C=this.getInputData(1),N=this.getInputOrProperty("A"),R=this.getInputOrProperty("D"),Y=this.getInputOrProperty("S"),ut=this.getInputOrProperty("R");!this.gate&&C?(L.cancelScheduledValues(0),L.setValueAtTime(0,I),L.linearRampToValueAtTime(1,I+N),L.linearRampToValueAtTime(Y,I+N+R)):this.gate&&!C&&(L.cancelScheduledValues(0),L.setValueAtTime(L.value,I),L.linearRampToValueAtTime(0,I+ut)),this.gate=C},O.prototype.onGetInputs=function(){return[["A","number"],["D","number"],["S","number"],["R","number"]]},n.createAudioNodeWrapper(O),O.title="ADSR",O.desc="Audio envelope",t.registerNodeType("audio/adsr",O);function d(){this.properties={delayTime:.5},this.audionode=n.getAudioContext().createDelay(10),this.audionode.delayTime.value=this.properties.delayTime,this.addInput("in","audio"),this.addInput("time","number"),this.addOutput("out","audio")}n.createAudioNodeWrapper(d),d.prototype.onExecute=function(){var l=this.getInputData(1);l!==void 0&&(this.audionode.delayTime.value=l)},d.title="Delay",d.desc="Audio delay",t.registerNodeType("audio/delay",d);function b(){this.properties={frequency:350,detune:0,Q:1},this.addProperty("type","lowpass","enum",{values:["lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass"]}),this.audionode=n.getAudioContext().createBiquadFilter(),this.addInput("in","audio"),this.addOutput("out","audio")}b.prototype.onExecute=function(){if(!(!this.inputs||!this.inputs.length))for(var l=1;l<this.inputs.length;++l){var I=this.inputs[l];if(I.link!=null){var T=this.getInputData(l);T!==void 0&&(this.audionode[I.name].value=T)}}},b.prototype.onGetInputs=function(){return[["frequency","number"],["detune","number"],["Q","number"]]},n.createAudioNodeWrapper(b),b.title="BiquadFilter",b.desc="Audio filter",t.registerNodeType("audio/biquadfilter",b);function S(){this.properties={frequency:440,detune:0,type:"sine"},this.addProperty("type","sine","enum",{values:["sine","square","sawtooth","triangle","custom"]}),this.audionode=n.getAudioContext().createOscillator(),this.addOutput("out","audio")}S.prototype.onStart=function(){if(!this.audionode.started){this.audionode.started=!0;try{this.audionode.start()}catch{}}},S.prototype.onStop=function(){this.audionode.started&&(this.audionode.started=!1,this.audionode.stop())},S.prototype.onPause=function(){this.onStop()},S.prototype.onUnpause=function(){this.onStart()},S.prototype.onExecute=function(){if(!(!this.inputs||!this.inputs.length))for(var l=0;l<this.inputs.length;++l){var I=this.inputs[l];if(I.link!=null){var T=this.getInputData(l);T!==void 0&&(this.audionode[I.name].value=T)}}},S.prototype.onGetInputs=function(){return[["frequency","number"],["detune","number"],["type","string"]]},n.createAudioNodeWrapper(S),S.title="Oscillator",S.desc="Oscillator",t.registerNodeType("audio/oscillator",S);function G(){this.properties={continuous:!0,mark:-1},this.addInput("data","array"),this.addInput("mark","number"),this.size=[300,200],this._last_buffer=null}G.prototype.onExecute=function(){this._last_buffer=this.getInputData(0);var l=this.getInputData(1);l!==void 0&&(this.properties.mark=l),this.setDirtyCanvas(!0,!1)},G.prototype.onDrawForeground=function(l){if(this._last_buffer){var I=this._last_buffer,T=I.length/this.size[0],L=this.size[1];l.fillStyle="black",l.fillRect(0,0,this.size[0],this.size[1]),l.strokeStyle="white",l.beginPath();var C=0;if(this.properties.continuous){l.moveTo(C,L);for(var N=0;N<I.length;N+=T)l.lineTo(C,L-I[N|0]/255*L),C++}else for(var N=0;N<I.length;N+=T)l.moveTo(C+.5,L),l.lineTo(C+.5,L-I[N|0]/255*L),C++;if(l.stroke(),this.properties.mark>=0){var R=n.getAudioContext().sampleRate,Y=R/I.length,C=2*(this.properties.mark/Y)/T;C>=this.size[0]&&(C=this.size[0]-1),l.strokeStyle="red",l.beginPath(),l.moveTo(C,L),l.lineTo(C,0),l.stroke()}}},G.title="Visualization",G.desc="Audio Visualization",t.registerNodeType("audio/visualization",G);function z(){this.properties={band:440,amplitude:1},this.addInput("freqs","array"),this.addOutput("signal","number")}z.prototype.onExecute=function(){if(this._freqs=this.getInputData(0),!!this._freqs){var l=this.properties.band,C=this.getInputData(1);C!==void 0&&(l=C);var I=n.getAudioContext().sampleRate,T=I/this._freqs.length,L=2*(l/T),C=0;if(L<0&&(C=this._freqs[0]),L>=this._freqs.length)C=this._freqs[this._freqs.length-1];else{var N=L|0,R=this._freqs[N],Y=this._freqs[N+1],ut=L-N;C=R*(1-ut)+Y*ut}this.setOutputData(0,C/255*this.properties.amplitude)}},z.prototype.onGetInputs=function(){return[["band","number"]]},z.title="Signal",z.desc="extract the signal of some frequency",t.registerNodeType("audio/signal",z);function $(){if(!$.default_code){var l=$.default_function.toString(),I=l.indexOf("{")+1,T=l.lastIndexOf("}");$.default_code=l.substr(I,T-I)}this.properties={code:$.default_code};var L=n.getAudioContext();L.createScriptProcessor?this.audionode=L.createScriptProcessor(4096,1,1):(console.warn("ScriptProcessorNode deprecated"),this.audionode=L.createGain()),this.processCode(),$._bypass_function||($._bypass_function=this.audionode.onaudioprocess),this.addInput("in","audio"),this.addOutput("out","audio")}$.prototype.onAdded=function(l){l.status==LGraph.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback)},$["@code"]={widget:"code",type:"code"},$.prototype.onStart=function(){this.audionode.onaudioprocess=this._callback},$.prototype.onStop=function(){this.audionode.onaudioprocess=$._bypass_function},$.prototype.onPause=function(){this.audionode.onaudioprocess=$._bypass_function},$.prototype.onUnpause=function(){this.audionode.onaudioprocess=this._callback},$.prototype.onExecute=function(){},$.prototype.onRemoved=function(){this.audionode.onaudioprocess=$._bypass_function},$.prototype.processCode=function(){try{var l=new Function("properties",this.properties.code);this._script=new l(this.properties),this._old_code=this.properties.code,this._callback=this._script.onaudioprocess}catch(I){console.error("Error in onaudioprocess code",I),this._callback=$._bypass_function,this.audionode.onaudioprocess=this._callback}},$.prototype.onPropertyChanged=function(l,I){l=="code"&&(this.properties.code=I,this.processCode(),this.graph&&this.graph.status==LGraph.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback))},$.default_function=function(){this.onaudioprocess=function(l){for(var I=l.inputBuffer,T=l.outputBuffer,L=0;L<T.numberOfChannels;L++)for(var C=I.getChannelData(L),N=T.getChannelData(L),R=0;R<I.length;R++)N[R]=C[R]}},n.createAudioNodeWrapper($),$.title="Script",$.desc="apply script to signal",t.registerNodeType("audio/script",$);function A(){this.audionode=n.getAudioContext().destination,this.addInput("in","audio")}A.title="Destination",A.desc="Audio output",t.registerNodeType("audio/destination",A)}(commonjsGlobal),function(e){var t=e.LiteGraph;function n(){this.size=[60,20],this.addInput("send",t.ACTION),this.addOutput("received",t.EVENT),this.addInput("in",0),this.addOutput("out",0),this.properties={url:"",room:"lgraph",only_send_changes:!0},this._ws=null,this._last_sent_data=[],this._last_received_data=[]}n.title="WebSocket",n.desc="Send data through a websocket",n.prototype.onPropertyChanged=function(o,h){o=="url"&&this.connectSocket()},n.prototype.onExecute=function(){if(!this._ws&&this.properties.url&&this.connectSocket(),!(!this._ws||this._ws.readyState!=WebSocket.OPEN)){for(var o=this.properties.room,h=this.properties.only_send_changes,u=1;u<this.inputs.length;++u){var f=this.getInputData(u);if(f!=null){var c;try{c=JSON.stringify({type:0,room:o,channel:u,data:f})}catch{continue}h&&this._last_sent_data[u]==c||(this._last_sent_data[u]=c,this._ws.send(c))}}for(var u=1;u<this.outputs.length;++u)this.setOutputData(u,this._last_received_data[u]);this.boxcolor=="#AFA"&&(this.boxcolor="#6C6")}},n.prototype.connectSocket=function(){var o=this,h=this.properties.url;h.substr(0,2)!="ws"&&(h="ws://"+h),this._ws=new WebSocket(h),this._ws.onopen=function(){console.log("ready"),o.boxcolor="#6C6"},this._ws.onmessage=function(u){o.boxcolor="#AFA";var f=JSON.parse(u.data);if(!(f.room&&f.room!=o.properties.room))if(f.type==1)if(f.data.object_class&&t[f.data.object_class]){var c=null;try{c=new t[f.data.object_class](f.data),o.triggerSlot(0,c)}catch{return}}else o.triggerSlot(0,f.data);else o._last_received_data[f.channel||0]=f.data},this._ws.onerror=function(u){console.log("couldnt connect to websocket"),o.boxcolor="#E88"},this._ws.onclose=function(u){console.log("connection closed"),o.boxcolor="#000"}},n.prototype.send=function(o){!this._ws||this._ws.readyState!=WebSocket.OPEN||this._ws.send(JSON.stringify({type:1,msg:o}))},n.prototype.onAction=function(o,h){!this._ws||this._ws.readyState!=WebSocket.OPEN||this._ws.send({type:1,room:this.properties.room,action:o,data:h})},n.prototype.onGetInputs=function(){return[["in",0]]},n.prototype.onGetOutputs=function(){return[["out",0]]},t.registerNodeType("network/websocket",n);function r(){this.room_widget=this.addWidget("text","Room","lgraph",this.setRoom.bind(this)),this.addWidget("button","Reconnect",null,this.connectSocket.bind(this)),this.addInput("send",t.ACTION),this.addOutput("received",t.EVENT),this.addInput("in",0),this.addOutput("out",0),this.properties={url:"tamats.com:55000",room:"lgraph",only_send_changes:!0},this._server=null,this.connectSocket(),this._last_sent_data=[],this._last_received_data=[],typeof SillyClient>"u"&&console.warn("remember to add SillyClient.js to your project: https://tamats.com/projects/sillyserver/src/sillyclient.js")}r.title="SillyClient",r.desc="Connects to SillyServer to broadcast messages",r.prototype.onPropertyChanged=function(o,h){o=="room"&&(this.room_widget.value=h),this.connectSocket()},r.prototype.setRoom=function(o){this.properties.room=o,this.room_widget.value=o,this.connectSocket()},r.prototype.onDrawForeground=function(){for(var o=1;o<this.inputs.length;++o){var h=this.inputs[o];h.label="in_"+o}for(var o=1;o<this.outputs.length;++o){var h=this.outputs[o];h.label="out_"+o}},r.prototype.onExecute=function(){if(!(!this._server||!this._server.is_connected)){for(var o=this.properties.only_send_changes,h=1;h<this.inputs.length;++h){var u=this.getInputData(h),f=this._last_sent_data[h];if(u!=null){if(o){var c=!0;if(u&&u.length&&f&&f.length==u.length&&u.constructor!==String){for(var _=0;_<u.length;++_)if(f[_]!=u[_]){c=!1;break}}else this._last_sent_data[h]!=u&&(c=!1);if(c)continue}if(this._server.sendMessage({type:0,channel:h,data:u}),u.length&&u.constructor!==String)if(this._last_sent_data[h]){this._last_sent_data[h].length=u.length;for(var _=0;_<u.length;++_)this._last_sent_data[h][_]=u[_]}else u.constructor===Array?this._last_sent_data[h]=u.concat():this._last_sent_data[h]=new u.constructor(u);else this._last_sent_data[h]=u}}for(var h=1;h<this.outputs.length;++h)this.setOutputData(h,this._last_received_data[h]);this.boxcolor=="#AFA"&&(this.boxcolor="#6C6")}},r.prototype.connectSocket=function(){var o=this;if(typeof SillyClient>"u"){this._error||console.error("SillyClient node cannot be used, you must include SillyServer.js"),this._error=!0;return}if(this._server=new SillyClient,this._server.on_ready=function(){console.log("ready"),o.boxcolor="#6C6"},this._server.on_message=function(h,u){var f=null;try{f=JSON.parse(u)}catch{return}if(f.type==1)if(f.data.object_class&&t[f.data.object_class]){var c=null;try{c=new t[f.data.object_class](f.data),o.triggerSlot(0,c)}catch{return}}else o.triggerSlot(0,f.data);else o._last_received_data[f.channel||0]=f.data;o.boxcolor="#AFA"},this._server.on_error=function(h){console.log("couldnt connect to websocket"),o.boxcolor="#E88"},this._server.on_close=function(h){console.log("connection closed"),o.boxcolor="#000"},this.properties.url&&this.properties.room){try{this._server.connect(this.properties.url,this.properties.room)}catch(h){console.error("SillyServer error: "+h),this._server=null;return}this._final_url=this.properties.url+"/"+this.properties.room}},r.prototype.send=function(o){!this._server||!this._server.is_connected||this._server.sendMessage({type:1,data:o})},r.prototype.onAction=function(o,h){!this._server||!this._server.is_connected||this._server.sendMessage({type:1,action:o,data:h})},r.prototype.onGetInputs=function(){return[["in",0]]},r.prototype.onGetOutputs=function(){return[["out",0]]},t.registerNodeType("network/sillyclient",r);function s(){this.addInput("request",t.ACTION),this.addInput("url","string"),this.addProperty("url",""),this.addOutput("ready",t.EVENT),this.addOutput("data","string"),this.addWidget("button","Fetch",null,this.fetch.bind(this)),this._data=null,this._fetching=null}s.title="HTTP Request",s.desc="Fetch data through HTTP",s.prototype.fetch=function(){var o=this.properties.url;if(o){this.boxcolor="#FF0";var h=this;this._fetching=fetch(o).then(u=>{if(!u.ok)this.boxcolor="#F00",h.trigger("error");else return this.boxcolor="#0F0",u.text()}).then(u=>{h._data=u,h._fetching=null,h.trigger("ready")})}},s.prototype.onAction=function(o){o=="request"&&this.fetch()},s.prototype.onExecute=function(){this.setOutputData(1,this._data)},s.prototype.onGetOutputs=function(){return[["error",t.EVENT]]},t.registerNodeType("network/httprequest",s)}(commonjsGlobal)})(litegraph);class BaseNode extends litegraph.LGraphNode{addSlider(t,n,r,s,o){return this.addWidget("slider",t,n,h=>{this.isInputConnected(this.findInputSlot(o))||(this.properties[o]=h)},{min:r,max:s})}addNumParam(t,n,r,s,o){this.addProperty(t,r,"parameter"),this.addSlider(n,r,s,o,t),this.addInput(t,"parameter")}addSigParam(t){this.addProperty(t,"solid(0,0,0)","string"),this.addInput(t,"string")}getParam(t){return this.getInputOrProperty(t)}}class RotateNode extends BaseNode{constructor(){super();pe(this,"name","Rotate");pe(this,"title","Rotate");pe(this,"data","");this.addSigParam("signal"),this.addNumParam("angle","angle",10,0,360),this.addOutput("signal","string")}onExecute(){this.setOutputData(0,`${this.getParam("signal")}.rotate(${this.getParam("angle")})`)}}class ScaleNode extends BaseNode{constructor(){super();pe(this,"name","Scale");pe(this,"title","Scale");pe(this,"data","");this.addSigParam("signal"),this.addNumParam("amount","amount",.1,0,2),this.addOutput("signal","string")}onExecute(){this.setOutputData(0,`${this.getParam("signal")}.scale(${this.getParam("amount")})`)}}class KaleidoscopeNode extends BaseNode{constructor(){super();pe(this,"name","Kaleidoscope");pe(this,"title","Kaleidoscope");pe(this,"data","");this.addSigParam("signal"),this.addNumParam("sides","sides",4,2,8),this.addOutput("signal","string")}onExecute(){this.setOutputData(0,`${this.getParam("signal")}.kaleid(${this.getParam("sides")})`)}}class OutputNode extends BaseNode{constructor(){super();pe(this,"name","Output");pe(this,"title","Output");pe(this,"data","");pe(this,"signal",this.addProperty("signal","solid(0,0,0)","string"));this.addInput("signal","string")}onExecute(){this.data=`${this.getInputOrProperty("signal")}.out()`}onAdded(){var r;let n=this.graph.findNodesByClass(OutputNode);console.log(n),n.length>1&&((r=this.graph)==null||r.remove(this))}}class NumberInputNode extends BaseNode{constructor(){super();pe(this,"title","Number");pe(this,"name","Number");pe(this,"value",1);this.addOutput("number","parameter"),this.addWidget("number","Number",1,n=>{this.value=n})}onExecute(){this.setOutputData(0,this.value)}}class NoiseNode extends BaseNode{constructor(){super();pe(this,"title","Noise");pe(this,"name","Noise");pe(this,"scale",this.addProperty("scale",10,"parameter"));pe(this,"offset",this.addProperty("offset",.1,"parameter"));pe(this,"scaleSlider",this.addSlider("Scale",10,1,100,"scale"));pe(this,"offsetSlider",this.addSlider("Offset",.1,0,1,"offset"));this.addInput("scale","parameter"),this.addInput("offset","parameter"),this.addOutput("signal","string")}onExecute(){this.setOutputData(0,`noise(${this.getInputOrProperty("scale")},${this.getInputOrProperty("offset")})`)}}class OscillatorNode extends BaseNode{constructor(){super();pe(this,"title","Oscillator");pe(this,"name","Oscillator");pe(this,"frequency",this.addProperty("frequency",60,"parameter"));pe(this,"freqslider",this.addSlider("Frequency",60,1,200,"frequency"));this.addOutput("signal","string"),this.addInput("frequency","parameter")}onExecute(){this.setOutputData(0,`osc(${this.getInputOrProperty("frequency")})`)}}class ShapeNode extends BaseNode{constructor(){super();pe(this,"title","Shape");pe(this,"name","Shape");pe(this,"sides",this.addProperty("sides",3,"parameter"));pe(this,"radius",this.addProperty("radius",.01,"parameter"));pe(this,"smoothing",this.addProperty("smoothing",.01,"parameter"));pe(this,"sidesslider",this.addSlider("Sides",this.properties.sides,1,40,"sides"));pe(this,"radiusslider",this.addSlider("Radius",this.properties.radius,.01,1,"radius"));pe(this,"smoothingslides",this.addSlider("Smoothing",this.properties.smoothing,.01,1,"smoothing"));this.addOutput("signal","string"),this.addInput("sides","parameter"),this.addInput("radius","parameter"),this.addInput("smoothing","parameter")}onExecute(){let n=`shape(${this.getInputOrProperty("sides")},${this.getInputOrProperty("radius")},${this.getInputOrProperty("smoothing")})`;this.setOutputData(0,n)}}class BlendNode extends BaseNode{constructor(){super();pe(this,"name","Blend");pe(this,"title","Blend");pe(this,"signal1",this.addProperty("signal1","solid(0,0,0)","string"));pe(this,"signal2",this.addProperty("signal2","solid(0,0,0)","string"));pe(this,"amount",this.addProperty("amount",1,"parameter"));pe(this,"amountSlider",this.addSlider("amount",0,0,1,"amount"));this.addInput("signal1","string"),this.addInput("signal2","string"),this.addInput("amount","parameter"),this.addOutput("signal","string")}onExecute(){this.setOutputData(0,`${this.getInputOrProperty("signal2")}.blend(hydra.synth.${this.getInputOrProperty("signal1")},${this.getInputOrProperty("amount")})`)}}class ColorNode extends BaseNode{constructor(){super();pe(this,"name","Color");pe(this,"title","Color");pe(this,"r",this.addProperty("r",1,"parameter"));pe(this,"g",this.addProperty("g",1,"parameter"));pe(this,"b",this.addProperty("b",1,"parameter"));pe(this,"sig",this.addProperty("signal","solid(0,0,0)","string"));pe(this,"rSlider",this.addSlider("Red",1,0,5,"r"));pe(this,"gSlider",this.addSlider("Green",1,0,5,"g"));pe(this,"bSlider",this.addSlider("Blue",1,0,5,"b"));this.addInput("signal","string"),this.addInput("r","parameter"),this.addInput("g","parameter"),this.addInput("b","parameter"),this.addOutput("signal","string")}onExecute(){this.setOutputData(0,`${this.getInputOrProperty("signal")}.color(${this.getInputOrProperty("r")},${this.getInputOrProperty("g")},${this.getInputOrProperty("b")})`)}}class ModulateNode extends BaseNode{constructor(){super();pe(this,"name","Modulate");pe(this,"title","Modulate");this.addNumParam("amount","amount",.1,0,1),this.addSigParam("signal"),this.addSigParam("modulator"),this.addOutput("signal","string")}onExecute(){this.setOutputData(0,`${this.getParam("signal")}.modulate(hydra.synth.${this.getParam("modulator")},${this.getParam("amount")})`)}}let nodeList={"special/output":OutputNode,"sources/oscillator":OscillatorNode,"sources/shape":ShapeNode,"sources/noise":NoiseNode,"inputs/number":NumberInputNode,"blends/blend":BlendNode,"effects/color":ColorNode,"effects/modulate":ModulateNode,"geometry/rotate":RotateNode,"geometry/scale":ScaleNode,"geometry/kaliedoscope":KaleidoscopeNode},cnv=document.getElementById("programCanvas"),programDiv=document.getElementById("programDiv").getBoundingClientRect();cnv.height=programDiv.height;cnv.width=programDiv.width;const hydra=new HydraRenderer({detectAudio:!1,canvas:cnv,makeGlobal:!1});let nodecnv=document.getElementById("nodecanvas"),rect=nodecnv.parentNode.getBoundingClientRect();nodecnv.width=rect.width;nodecnv.height=rect.height;var graph=new litegraph.LGraph,canvas=new litegraph.LGraphCanvas("#nodecanvas",graph);canvas.processContextMenu=function(e,t){console.log(this.getCanvasMenuOptions()),new litegraph.LiteGraph.ContextMenu([this.getCanvasMenuOptions()[0]],{event:t})};litegraph.LiteGraph.clearRegisteredTypes();Object.keys(nodeList).forEach(e=>{litegraph.LiteGraph.registerNodeType(e,nodeList[e])});hydra.synth.solid(0,0,0).out();function updateHydra(){graph.runStep();let outs=graph.findNodesByClass(OutputNode);if(outs.length>0){let script=outs[0].data;console.log("hydra.synth."+script),eval("hydra.synth."+script)}window.requestAnimationFrame(updateHydra)}window.requestAnimationFrame(updateHydra);
